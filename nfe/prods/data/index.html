<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dados da NFe</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Roboto', sans-serif;
            line-height: 1.6;
            margin: 0;
            padding: 20px;
            background-color: #f4f4f4;
            color: #333;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        h1, h2, h3 {
            color: #2c3e50;
        }
        h1 {
            text-align: center;
            margin-bottom: 30px;
        }
        #nfeData, #produtos, #emitente, #destinatario, #impostos, #transporte, #infoPagamento, #infoGerais, #infoAdicionais {
            margin-bottom: 30px;
        }
        table {
            border-collapse: collapse;
            width: 100%;
            margin-top: 20px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: left;
        }
        th {
            background-color: #3498db;
            color: white;
        }
        tr:nth-child(even) {
            background-color: #f2f2f2;
        }
        .input-group {
            display: flex;
            margin-bottom: 20px;
        }
        #chaveInput {
            flex-grow: 1;
            padding: 10px;
            font-size: 16px;
            border: 1px solid #ddd;
            border-radius: 4px 0 0 4px;
        }
        button {
            padding: 10px 20px;
            font-size: 16px;
            background-color: #2ecc71;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
            margin-right: 5px;
        }
        button:hover {
            background-color: #27ae60;
        }
        .actions-group {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
        }
        .info-group {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
        }
        .info-item {
            flex: 1;
            min-width: 200px;
        }
        .loading {
            text-align: center;
            display: none;
        }
        #notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 10px 20px;
            border-radius: 4px;
            color: white;
            display: none;
        }
        .success {
            background-color: #2ecc71;
        }
        .error {
            background-color: #e74c3c;
        }
        .separator {
            border-top: 1px solid #ddd;
            margin: 20px 0;
        }
        .chave-formatted {
            font-family: monospace;
            background-color: #f8f9fa;
            padding: 5px 10px;
            border-radius: 4px;
            border: 1px solid #ddd;
            word-break: break-all;
        }
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Dados da NFe</h1>
        <div class="input-group">
            <input type="text" id="chaveInput" placeholder="Digite a chave da NFe">
            <button onclick="fetchNFeData()">Buscar Dados</button>
        </div>
        
        <div class="actions-group">
            <button id="downloadPDFBtn" onclick="postRequestPDF()" class="hidden">Baixar PDF</button>
            <button id="downloadXMLBtn" onclick="postRequestXML()" class="hidden">Baixar XML</button>
            <button id="sendTelegramBtn" onclick="sendTelegramMessage()" class="hidden">Enviar para o Telegram</button>
        </div>
        
        <div class="loading" id="loading">Carregando...</div>
        
        <div id="nfeData"></div>
        
        <h2>Emitente</h2>
        <div id="emitente"></div>
        
        <h2>Destinatário</h2>
        <div id="destinatario"></div>
        
        <h2>Impostos</h2>
        <div id="impostos"></div>
        
        <h2>Produtos</h2>
        <div id="produtos"></div>
        
        <h2>Transporte</h2>
        <div id="transporte"></div>
        
        <h2>Informações de Pagamento</h2>
        <div id="infoPagamento"></div>
        
        <h2>Informações Gerais</h2>
        <div id="infoGerais"></div>
        
        <h2>Informações Adicionais</h2>
        <div id="infoAdicionais"></div>
    </div>
    <div id="notification"></div>

    <script>
        const TELEGRAM_TOKEN = 'seu_token_telegram';
        const TELEGRAM_CHAT_ID = 'seu_chat_id';
        let nfeDataGlobal, xmlDataGlobal;

        async function fetchNFeData() {
            const chave = document.getElementById('chaveInput').value.replace(/\D/g, '');
            if (!chave) {
                showNotification('Por favor, digite a chave da NFe.', 'error');
                return;
            }

            showLoading(true);

            try {
                const nfeData = await fetchData(`https://ws.meudanfe.com/api/v1/get/nfe/data/MEUDANFE/${chave}`);
                const xmlData = await fetchData(`https://ws.meudanfe.com/api/v1/get/nfe/xml/${chave}`);

                nfeDataGlobal = nfeData;
                xmlDataGlobal = xmlData;

                displayNFeData(nfeData);
                displayEmitente(xmlData);
                displayDestinatario(xmlData);
                displayImpostos(xmlData);
                displayProdutos(xmlData);
                displayTransporte(xmlData);
                displayPaymentInfo(xmlData);
                displayGeneralInfo(xmlData);
                displayAdditionalInfo(xmlData);

                // Mostrar botões após carregamento bem-sucedido
                document.getElementById('downloadPDFBtn').classList.remove('hidden');
                document.getElementById('downloadXMLBtn').classList.remove('hidden');
                document.getElementById('sendTelegramBtn').classList.remove('hidden');
                
                showNotification('Dados obtidos com sucesso!', 'success');
            } catch (error) {
                console.error('Erro ao buscar dados:', error);
                showNotification('Ocorreu um erro ao buscar os dados da NFe.', 'error');
            } finally {
                showLoading(false);
            }
        }

        async function fetchData(url) {
            const chave = document.getElementById('chaveInput').value.replace(/\D/g, '');
            const response = await fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'text/plain;charset=UTF-8',
                    'Accept': '*/*',
                    'Accept-Language': 'pt-BR,pt;q=0.9,en-US;q=0.8,en;q=0.7',
                    'Accept-Encoding': 'gzip, deflate, br, zstd',
                    'Origin': 'https://meudanfe.com.br',
                    'Referer': 'https://meudanfe.com.br/',
                    'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/127.0.0.0 Safari/537.36',
                    'sec-ch-ua': '"Not)A;Brand";v="99", "Google Chrome";v="127", "Chromium";v="127"',
                    'sec-ch-ua-platform': '"Windows"',
                    'sec-ch-ua-mobile': '?0',
                    'sec-fetch-site': 'cross-site',
                    'sec-fetch-mode': 'cors',
                    'sec-fetch-dest': 'empty',
                    'Priority': 'u=1, i'
                },
                body: chave
            });
            if (!response.ok) {
                throw new Error('Falha na requisição');
            }
            return url.includes('/xml/') ? response.text() : response.json();
        }

        function getElementText(element, tagName) {
            const tag = element.getElementsByTagName(tagName)[0];
            return tag ? tag.textContent : '';
        }

        function getElementAttr(element, tagName, attrName) {
            const tag = element.getElementsByTagName(tagName)[0];
            return tag && tag.getAttribute(attrName) ? tag.getAttribute(attrName) : '';
        }

        function displayNFeData(data) {
            const nfeDataDiv = document.getElementById('nfeData');
            nfeDataDiv.innerHTML = `
                <h2>Informações Gerais</h2>
                <div class="info-group">
                    <div class="info-item">
                        <p><strong>Chave de Acesso:</strong> <span class="chave-formatted">${formatChaveAcesso(data.chaveAcesso)}</span></p>
                        <p><strong>Número:</strong> ${data.numero}</p>
                        <p><strong>Série:</strong> ${data.serie}</p>
                        <p><strong>Data de Emissão:</strong> ${data.dataEmissao}</p>
                    </div>
                    <div class="info-item">
                        <p><strong>Valor Total:</strong> R$ ${data.valorTotal}</p>
                        <p><strong>Natureza da Operação:</strong> ${data.natOperacao}</p>
                        <p><strong>Tipo de Operação:</strong> ${data.tipoOperacao}</p>
                        <p><strong>Versão XML:</strong> ${data.versaoXml}</p>
                    </div>
                </div>
            `;
        }

        function displayEmitente(xmlData) {
            const parser = new DOMParser();
            const xmlDoc = parser.parseFromString(xmlData, "text/xml");
            const emitente = xmlDoc.getElementsByTagName("emit")[0];
            
            if (!emitente) return;
            
            const enderEmit = emitente.getElementsByTagName("enderEmit")[0];
            
            const emitenteDiv = document.getElementById('emitente');
            emitenteDiv.innerHTML = `
                <div class="info-group">
                    <div class="info-item">
                        <p><strong>Nome:</strong> ${getElementText(emitente, "xNome")}</p>
                        <p><strong>Nome Fantasia:</strong> ${getElementText(emitente, "xFant")}</p>
                        <p><strong>CNPJ:</strong> ${getElementText(emitente, "CNPJ")}</p>
                        <p><strong>Inscrição Estadual:</strong> ${getElementText(emitente, "IE")}</p>
                        <p><strong>Inscrição Municipal:</strong> ${getElementText(emitente, "IM")}</p>
                        <p><strong>Telefone:</strong> ${getElementText(emitente, "fone")}</p>
                        <p><strong>Regime Tributário:</strong> ${getElementText(emitente, "CRT")}</p>
                    </div>
                    <div class="info-item">
                        <h3>Endereço</h3>
                        <p><strong>Logradouro:</strong> ${enderEmit ? getElementText(enderEmit, "xLgr") : ''}</p>
                        <p><strong>Número:</strong> ${enderEmit ? getElementText(enderEmit, "nro") : ''}</p>
                        <p><strong>Complemento:</strong> ${enderEmit ? getElementText(enderEmit, "xCpl") : ''}</p>
                        <p><strong>Bairro:</strong> ${enderEmit ? getElementText(enderEmit, "xBairro") : ''}</p>
                        <p><strong>Município:</strong> ${enderEmit ? getElementText(enderEmit, "xMun") : ''}</p>
                        <p><strong>CEP:</strong> ${enderEmit ? getElementText(enderEmit, "CEP") : ''}</p>
                        <p><strong>UF:</strong> ${enderEmit ? getElementText(enderEmit, "UF") : ''}</p>
                        <p><strong>País:</strong> ${enderEmit ? getElementText(enderEmit, "xPais") : ''}</p>
                    </div>
                </div>
            `;
        }

        function displayDestinatario(xmlData) {
            const parser = new DOMParser();
            const xmlDoc = parser.parseFromString(xmlData, "text/xml");
            const destinatario = xmlDoc.getElementsByTagName("dest")[0];
            
            if (!destinatario) return;
            
            const enderDest = destinatario.getElementsByTagName("enderDest")[0];
            
            const destinatarioDiv = document.getElementById('destinatario');
            destinatarioDiv.innerHTML = `
                <div class="info-group">
                    <div class="info-item">
                        <p><strong>Nome:</strong> ${getElementText(destinatario, "xNome")}</p>
                        <p><strong>CNPJ:</strong> ${getElementText(destinatario, "CNPJ")}</p>
                        <p><strong>CPF:</strong> ${getElementText(destinatario, "CPF")}</p>
                        <p><strong>Inscrição Estadual:</strong> ${getElementText(destinatario, "IE")}</p>
                        <p><strong>Email:</strong> ${getElementText(destinatario, "email")}</p>
                        <p><strong>Telefone:</strong> ${getElementText(destinatario, "fone")}</p>
                        <p><strong>Indicador IE:</strong> ${getElementText(destinatario, "indIEDest")}</p>
                    </div>
                    <div class="info-item">
                        <h3>Endereço</h3>
                        <p><strong>Logradouro:</strong> ${enderDest ? getElementText(enderDest, "xLgr") : ''}</p>
                        <p><strong>Número:</strong> ${enderDest ? getElementText(enderDest, "nro") : ''}</p>
                        <p><strong>Complemento:</strong> ${enderDest ? getElementText(enderDest, "xCpl") : ''}</p>
                        <p><strong>Bairro:</strong> ${enderDest ? getElementText(enderDest, "xBairro") : ''}</p>
                        <p><strong>Município:</strong> ${enderDest ? getElementText(enderDest, "xMun") : ''}</p>
                        <p><strong>CEP:</strong> ${enderDest ? getElementText(enderDest, "CEP") : ''}</p>
                        <p><strong>UF:</strong> ${enderDest ? getElementText(enderDest, "UF") : ''}</p>
                        <p><strong>País:</strong> ${enderDest ? getElementText(enderDest, "xPais") : ''}</p>
                    </div>
                </div>
            `;
        }

        function displayImpostos(xmlData) {
            const parser = new DOMParser();
            const xmlDoc = parser.parseFromString(xmlData, "text/xml");
            const impostos = xmlDoc.getElementsByTagName("ICMSTot")[0];
            
            if (!impostos) return;
            
            const impostosDiv = document.getElementById('impostos');
            impostosDiv.innerHTML = `
                <div class="info-group">
                    <div class="info-item">
                        <p><strong>Base de Cálculo do ICMS:</strong> R$ ${getElementText(impostos, "vBC")}</p>
                        <p><strong>Valor do ICMS:</strong> R$ ${getElementText(impostos, "vICMS")}</p>
                        <p><strong>Base de Cálculo do ICMS ST:</strong> R$ ${getElementText(impostos, "vBCST")}</p>
                        <p><strong>Valor do ICMS ST:</strong> R$ ${getElementText(impostos, "vST")}</p>
                        <p><strong>Valor dos Produtos:</strong> R$ ${getElementText(impostos, "vProd")}</p>
                        <p><strong>Valor do Frete:</strong> R$ ${getElementText(impostos, "vFrete")}</p>
                        <p><strong>Valor do FCP:</strong> R$ ${getElementText(impostos, "vFCP")}</p>
                        <p><strong>Valor do FCP ST:</strong> R$ ${getElementText(impostos, "vFCPST")}</p>
                    </div>
                    <div class="info-item">
                        <p><strong>Valor do Seguro:</strong> R$ ${getElementText(impostos, "vSeg")}</p>
                        <p><strong>Valor do Desconto:</strong> R$ ${getElementText(impostos, "vDesc")}</p>
                        <p><strong>Valor do II:</strong> R$ ${getElementText(impostos, "vII")}</p>
                        <p><strong>Valor do IPI:</strong> R$ ${getElementText(impostos, "vIPI")}</p>
                        <p><strong>Valor do PIS:</strong> R$ ${getElementText(impostos, "vPIS")}</p>
                        <p><strong>Valor da COFINS:</strong> R$ ${getElementText(impostos, "vCOFINS")}</p>
                        <p><strong>Valor Aproximado dos Tributos:</strong> R$ ${getElementText(impostos, "vTotTrib")}</p>
                        <p><strong>Valor Total da Nota:</strong> R$ ${getElementText(impostos, "vNF")}</p>
                    </div>
                </div>
            `;
        }

        function displayProdutos(xmlData) {
            const parser = new DOMParser();
            const xmlDoc = parser.parseFromString(xmlData, "text/xml");
            const produtos = xmlDoc.getElementsByTagName("det");

            if (!produtos.length) return;

            let tableHtml = `
                <table>
                    <tr>
                        <th>Item</th>
                        <th>Código</th>
                        <th>EAN</th>
                        <th>Descrição</th>
                        <th>NCM</th>
                        <th>CFOP</th>
                        <th>Unidade</th>
                        <th>Quantidade</th>
                        <th>Valor Unitário</th>
                        <th>Valor Total</th>
                        <th>ICMS</th>
                        <th>PIS</th>
                        <th>COFINS</th>
                    </tr>
            `;

            for (let i = 0; i < produtos.length; i++) {
                const item = produtos[i];
                const nItem = getElementText(item, "nItem");
                const prod = item.getElementsByTagName("prod")[0];
                const imposto = item.getElementsByTagName("imposto")[0];
                
                let icmsValor = '';
                let icmsAliq = '';
                if (imposto) {
                    const icms = imposto.getElementsByTagName("ICMS")[0];
                    if (icms) {
                        const icmsNode = icms.firstElementChild;
                        if (icmsNode) {
                            icmsValor = getElementText(icmsNode, "vICMS");
                            icmsAliq = getElementText(icmsNode, "pICMS");
                        }
                    }
                }

                let pisValor = '';
                if (imposto) {
                    const pis = imposto.getElementsByTagName("PIS")[0];
                    if (pis) {
                        const pisNode = pis.firstElementChild;
                        if (pisNode) {
                            pisValor = getElementText(pisNode, "vPIS");
                        }
                    }
                }

                let cofinsValor = '';
                if (imposto) {
                    const cofins = imposto.getElementsByTagName("COFINS")[0];
                    if (cofins) {
                        const cofinsNode = cofins.firstElementChild;
                        if (cofinsNode) {
                            cofinsValor = getElementText(cofinsNode, "vCOFINS");
                        }
                    }
                }

                const cProd = getElementText(prod, "cProd");
                const cEAN = getElementText(prod, "cEAN");
                const xProd = getElementText(prod, "xProd");
                const NCM = getElementText(prod, "NCM");
                const CFOP = getElementText(prod, "CFOP");
                const uCom = getElementText(prod, "uCom");
                const qCom = getElementText(prod, "qCom");
                const vUnCom = getElementText(prod, "vUnCom");
                const vProd = getElementText(prod, "vProd");

                tableHtml += `
                    <tr>
                        <td>${nItem}</td>
                        <td>${cProd}</td>
                        <td>${cEAN}</td>
                        <td>${xProd}</td>
                        <td>${NCM}</td>
                        <td>${CFOP}</td>
                        <td>${uCom}</td>
                        <td>${qCom}</td>
                        <td>R$ ${vUnCom}</td>
                        <td>R$ ${vProd}</td>
                        <td>${icmsValor ? 'R$ ' + icmsValor + ' (' + icmsAliq + '%)' : ''}</td>
                        <td>${pisValor ? 'R$ ' + pisValor : ''}</td>
                        <td>${cofinsValor ? 'R$ ' + cofinsValor : ''}</td>
                    </tr>
                `;
            }

            tableHtml += '</table>';
            document.getElementById('produtos').innerHTML = tableHtml;
        }

        function displayTransporte(xmlData) {
            const parser = new DOMParser();
            const xmlDoc = parser.parseFromString(xmlData, "text/xml");
            const transporte = xmlDoc.getElementsByTagName("transp")[0];
            
            if (!transporte) return;
            
            const transportadora = transporte.getElementsByTagName("transporta")[0];
            const veicTransp = transporte.getElementsByTagName("veicTransp")[0];
            const volumes = transporte.getElementsByTagName("vol");
            
            let volumesHtml = '';
            if (volumes && volumes.length > 0) {
                volumesHtml = '<h3>Volumes</h3>';
                for (let i = 0; i < volumes.length; i++) {
                    const vol = volumes[i];
                    volumesHtml += `
                        <p><strong>Quantidade:</strong> ${getElementText(vol, "qVol")}</p>
                        <p><strong>Espécie:</strong> ${getElementText(vol, "esp")}</p>
                        <p><strong>Marca:</strong> ${getElementText(vol, "marca")}</p>
                        <p><strong>Numeração:</strong> ${getElementText(vol, "nVol")}</p>
                        <p><strong>Peso Bruto:</strong> ${getElementText(vol, "pesoB")}</p>
                        <p><strong>Peso Líquido:</strong> ${getElementText(vol, "pesoL")}</p>
                    `;
                }
            }
            
            const modFreteValue = getElementText(transporte, "modFrete");
            let modFreteDesc = '';
            switch(modFreteValue) {
                case '0': modFreteDesc = '0 - Por conta do Remetente'; break;
                case '1': modFreteDesc = '1 - Por conta do Destinatário'; break;
                case '2': modFreteDesc = '2 - Por conta de Terceiros'; break;
                case '3': modFreteDesc = '3 - Próprio por conta do Remetente'; break;
                case '4': modFreteDesc = '4 - Próprio por conta do Destinatário'; break;
                case '9': modFreteDesc = '9 - Sem Frete'; break;
                default: modFreteDesc = modFreteValue;
            }
            
            const transporteDiv = document.getElementById('transporte');
            transporteDiv.innerHTML = `
                <div class="info-group">
                    <div class="info-item">
                        <p><strong>Modalidade do Frete:</strong> ${modFreteDesc}</p>
                        ${volumesHtml}
                    </div>
                    <div class="info-item">
                        <h3>Transportadora</h3>
                        <p><strong>Nome:</strong> ${transportadora ? getElementText(transportadora, "xNome") : ''}</p>
                        <p><strong>CNPJ:</strong> ${transportadora ? getElementText(transportadora, "CNPJ") : ''}</p>
                        <p><strong>Inscrição Estadual:</strong> ${transportadora ? getElementText(transportadora, "IE") : ''}</p>
                        <p><strong>Endereço:</strong> ${transportadora ? getElementText(transportadora, "xEnder") : ''}</p>
                        <p><strong>Município:</strong> ${transportadora ? getElementText(transportadora, "xMun") : ''}</p>
                        <p><strong>UF:</strong> ${transportadora ? getElementText(transportadora, "UF") : ''}</p>
                    </div>
                    ${veicTransp ? `
                    <div class="info-item">
                        <h3>Veículo</h3>
                        <p><strong>Placa:</strong> ${getElementText(veicTransp, "placa")}</p>
                        <p><strong>UF:</strong> ${getElementText(veicTransp, "UF")}</p>
                        <p><strong>RNTC:</strong> ${getElementText(veicTransp, "RNTC")}</p>
                    </div>
                    ` : ''}
                </div>
            `;
        }

        function displayPaymentInfo(xmlData) {
            const parser = new DOMParser();
            const xmlDoc = parser.parseFromString(xmlData, "text/xml");
            
            // Informações de cobrança
            const cobrancaElement = xmlDoc.getElementsByTagName("cobr")[0];
            const faturaElement = cobrancaElement ? cobrancaElement.getElementsByTagName("fat")[0] : null;
            const duplicatas = cobrancaElement ? cobrancaElement.getElementsByTagName("dup") : [];
            
            // Informações de pagamento
            const pagamento = xmlDoc.getElementsByTagName("pag")[0];
            const detPag = pagamento ? pagamento.getElementsByTagName("detPag") : [];
            
            let duplicatasHtml = '';
            if (duplicatas.length > 0) {
                duplicatasHtml = `
                    <h3>Duplicatas</h3>
                    <table>
                        <tr>
                            <th>Número</th>
                            <th>Vencimento</th>
                            <th>Valor</th>
                        </tr>
                `;
                
                for (let i = 0; i < duplicatas.length; i++) {
                    const dup = duplicatas[i];
                    duplicatasHtml += `
                        <tr>
                            <td>${getElementText(dup, "nDup")}</td>
                            <td>${formatDate(getElementText(dup, "dVenc"))}</td>
                            <td>R$ ${getElementText(dup, "vDup")}</td>
                        </tr>
                    `;
                }
                
                duplicatasHtml += '</table>';
            }
            
            let pagamentosHtml = '';
            if (detPag.length > 0) {
                pagamentosHtml = `
                    <h3>Formas de Pagamento</h3>
                    <table>
                        <tr>
                            <th>Forma</th>
                            <th>Valor</th>
                            <th>Indicador</th>
                        </tr>
                `;
                
                for (let i = 0; i < detPag.length; i++) {
                    const pag = detPag[i];
                    const tPagValue = getElementText(pag, "tPag");
                    
                    let formaPagamentoDesc = '';
                    switch(tPagValue) {
                        case '01': formaPagamentoDesc = '01 - Dinheiro'; break;
                        case '02': formaPagamentoDesc = '02 - Cheque'; break;
                        case '03': formaPagamentoDesc = '03 - Cartão de Crédito'; break;
                        case '04': formaPagamentoDesc = '04 - Cartão de Débito'; break;
                        case '05': formaPagamentoDesc = '05 - Crédito Loja'; break;
                        case '10': formaPagamentoDesc = '10 - Vale Alimentação'; break;
                        case '11': formaPagamentoDesc = '11 - Vale Refeição'; break;
                        case '12': formaPagamentoDesc = '12 - Vale Presente'; break;
                        case '13': formaPagamentoDesc = '13 - Vale Combustível'; break;
                        case '14': formaPagamentoDesc = '14 - Duplicata Mercantil'; break;
                        case '15': formaPagamentoDesc = '15 - Boleto Bancário'; break;
                        case '16': formaPagamentoDesc = '16 - Depósito Bancário'; break;
                        case '17': formaPagamentoDesc = '17 - PIX'; break;
                        case '18': formaPagamentoDesc = '18 - Transferência bancária'; break;
                        case '19': formaPagamentoDesc = '19 - Programa de fidelidade'; break;
                        case '90': formaPagamentoDesc = '90 - Sem Pagamento'; break;
                        case '99': formaPagamentoDesc = '99 - Outros'; break;
                        default: formaPagamentoDesc = tPagValue;
                    }
                    
                    const indPagValue = getElementText(pag, "indPag");
                    let indPagDesc = '';
                    switch(indPagValue) {
                        case '0': indPagDesc = '0 - Pagamento à Vista'; break;
                        case '1': indPagDesc = '1 - Pagamento à Prazo'; break;
                        case '2': indPagDesc = '2 - Outros'; break;
                        default: indPagDesc = indPagValue;
                    }
                    
                    pagamentosHtml += `
                        <tr>
                            <td>${formaPagamentoDesc}</td>
                            <td>R$ ${getElementText(pag, "vPag")}</td>
                            <td>${indPagDesc}</td>
                        </tr>
                    `;
                }
                
                pagamentosHtml += '</table>';
            }
            
            const infoPagamentoDiv = document.getElementById('infoPagamento');
            
            if (faturaElement || duplicatas.length > 0 || detPag.length > 0) {
                infoPagamentoDiv.innerHTML = `
                    <div class="info-group">
                        ${faturaElement ? `
                        <div class="info-item">
                            <h3>Fatura</h3>
                            <p><strong>Número:</strong> ${getElementText(faturaElement, "nFat")}</p>
                            <p><strong>Valor Original:</strong> R$ ${getElementText(faturaElement, "vOrig")}</p>
                            <p><strong>Valor do Desconto:</strong> R$ ${getElementText(faturaElement, "vDesc")}</p>
                            <p><strong>Valor Líquido:</strong> R$ ${getElementText(faturaElement, "vLiq")}</p>
                        </div>
                        ` : ''}
                        ${duplicatasHtml ? `<div class="info-item">${duplicatasHtml}</div>` : ''}
                        ${pagamentosHtml ? `<div class="info-item">${pagamentosHtml}</div>` : ''}
                    </div>
                `;
            } else {
                infoPagamentoDiv.innerHTML = '<p>Sem informações de pagamento disponíveis.</p>';
            }
        }

        function displayGeneralInfo(xmlData) {
            const parser = new DOMParser();
            const xmlDoc = parser.parseFromString(xmlData, "text/xml");
            
            // Informações da NF-e
            const infNFe = xmlDoc.getElementsByTagName("infNFe")[0];
            const ide = xmlDoc.getElementsByTagName("ide")[0];
            const protNFe = xmlDoc.getElementsByTagName("protNFe")[0];
            const infProt = protNFe ? protNFe.getElementsByTagName("infProt")[0] : null;
            
            const infoGeraisDiv = document.getElementById('infoGerais');
            
            if (ide) {
                const tpNFValue = getElementText(ide, "tpNF");
                let tpNFDesc = '';
                switch(tpNFValue) {
                    case '0': tpNFDesc = '0 - Entrada'; break;
                    case '1': tpNFDesc = '1 - Saída'; break;
                    default: tpNFDesc = tpNFValue;
                }
                
                const finNFeValue = getElementText(ide, "finNFe");
                let finNFeDesc = '';
                switch(finNFeValue) {
                    case '1': finNFeDesc = '1 - Normal'; break;
                    case '2': finNFeDesc = '2 - Complementar'; break;
                    case '3': finNFeDesc = '3 - Ajuste'; break;
                    case '4': finNFeDesc = '4 - Devolução de Mercadoria'; break;
                    default: finNFeDesc = finNFeValue;
                }
                
                const tpAmbValue = getElementText(ide, "tpAmb");
                let tpAmbDesc = '';
                switch(tpAmbValue) {
                    case '1': tpAmbDesc = '1 - Produção'; break;
                    case '2': tpAmbDesc = '2 - Homologação'; break;
                    default: tpAmbDesc = tpAmbValue;
                }
                
                infoGeraisDiv.innerHTML = `
                    <div class="info-group">
                        <div class="info-item">
                            <p><strong>Versão:</strong> ${infNFe ? infNFe.getAttribute("versao") : ''}</p>
                            <p><strong>Tipo:</strong> ${tpNFDesc}</p>
                            <p><strong>Modelo:</strong> ${getElementText(ide, "mod")}</p>
                            <p><strong>Série:</strong> ${getElementText(ide, "serie")}</p>
                            <p><strong>Número:</strong> ${getElementText(ide, "nNF")}</p>
                            <p><strong>Data de Emissão:</strong> ${formatDate(getElementText(ide, "dhEmi"))}</p>
                            <p><strong>Natureza da Operação:</strong> ${getElementText(ide, "natOp")}</p>
                        </div>
                        <div class="info-item">
                            <p><strong>Finalidade:</strong> ${finNFeDesc}</p>
                            <p><strong>Ambiente:</strong> ${tpAmbDesc}</p>
                            <p><strong>Tipo de Emissão:</strong> ${getElementText(ide, "tpEmis")}</p>
                            <p><strong>Tipo de Impressão:</strong> ${getElementText(ide, "tpImp")}</p>
                            <p><strong>Indicador Presença:</strong> ${getElementText(ide, "indPres")}</p>
                            <p><strong>Processo de Emissão:</strong> ${getElementText(ide, "procEmi")}</p>
                            <p><strong>Versão do Processo:</strong> ${getElementText(ide, "verProc")}</p>
                        </div>
                        ${infProt ? `
                        <div class="info-item">
                            <h3>Protocolo de Autorização</h3>
                            <p><strong>Número:</strong> ${getElementText(infProt, "nProt")}</p>
                            <p><strong>Data/Hora:</strong> ${formatDate(getElementText(infProt, "dhRecbto"))}</p>
                            <p><strong>Status:</strong> ${getElementText(infProt, "cStat")} - ${getElementText(infProt, "xMotivo")}</p>
                            <p><strong>Digest Value:</strong> ${getElementText(infProt, "digVal")}</p>
                        </div>
                        ` : ''}
                    </div>
                `;
            } else {
                infoGeraisDiv.innerHTML = '<p>Sem informações gerais disponíveis.</p>';
            }
        }

        function displayAdditionalInfo(xmlData) {
            const parser = new DOMParser();
            const xmlDoc = parser.parseFromString(xmlData, "text/xml");
            
            // Informações adicionais
            const infAdic = xmlDoc.getElementsByTagName("infAdic")[0];
            
            const infoAdicionaisDiv = document.getElementById('infoAdicionais');
            
            if (infAdic) {
                infoAdicionaisDiv.innerHTML = `
                    <div class="info-group">
                        <div class="info-item">
                            <p><strong>Informações Complementares:</strong> ${getElementText(infAdic, "infCpl")}</p>
                            <p><strong>Informações para Fisco:</strong> ${getElementText(infAdic, "infAdFisco")}</p>
                        </div>
                    </div>
                `;
            } else {
                infoAdicionaisDiv.innerHTML = '<p>Sem informações adicionais disponíveis.</p>';
            }
        }

        async function sendTelegramMessage() {
            if (!nfeDataGlobal || !xmlDataGlobal) {
                showNotification('Dados da NFe não disponíveis. Por favor, busque os dados primeiro.', 'error');
                return;
            }

            const parser = new DOMParser();
            const xmlDoc = parser.parseFromString(xmlDataGlobal, "text/xml");
            const produtos = xmlDoc.getElementsByTagName("det");
            let produtosText = '';
            for (let i = 0; i < produtos.length; i++) {
                const prod = produtos[i].getElementsByTagName("prod")[0];
                const cProd = getElementText(prod, "cProd");
                const xProd = getElementText(prod, "xProd");
                const qCom = getElementText(prod, "qCom");
                produtosText += `${cProd} - ${xProd} - ${qCom}\n`;
            }

            const message = `
Nome/Razão Social Emitente: ${nfeDataGlobal.emiNome}
Data Ent./Saida: ${nfeDataGlobal.dataEntSaida}
PRODUTOS:
CODIGO  //  NOME  //  QUANTIDADE

${produtosText}`;

            const payload = {
                chat_id: TELEGRAM_CHAT_ID,
                text: message
            };

            const options = {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(payload)
            };

            try {
                const response = await fetch(`https://api.telegram.org/bot${TELEGRAM_TOKEN}/sendMessage`, options);
                if (!response.ok) {
                    throw new Error('Erro ao enviar mensagem para o Telegram.');
                }
                showNotification('Mensagem enviada para o Telegram com sucesso!', 'success');
            } catch (error) {
                console.error("Error sending message to Telegram: ", error);
                showNotification('Ocorreu um erro ao enviar a mensagem para o Telegram.', 'error');
            }
        }

        // Função para baixar o PDF da NFe
        async function postRequestPDF() {
            const chave = document.getElementById('chaveInput').value.replace(/\D/g, '');
            // Verifica se a chave foi digitada
            if (!chave) {
                showNotification('Digite a chave antes de prosseguir.', 'error');
                return;
            }

            showLoading(true);

            try {
                // Primeira requisição para a API de busca de dados
                const buscanfe = await fetch(`https://ws.meudanfe.com/api/v1/get/nfe/data/APIAPP/${chave}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json',
                        'Accept-Charset': 'utf-8, *;q=0.8',
                        'Accept-Language': 'pt-BR,pt;q=0.9,en-US;q=0.8,en;q=0.7',
                        'Host': 'ws.meudanfe.com',
                        'Referer': 'https://meudanfe.com.br/',
                        'User-Agent': 'Embarcadero URI Client/1.0, Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/114.0.0.0 Safari/537.36',
                        'sec-ch-ua': '"Not.A/Brand";v="8", "Chromium";v="114", "Google Chrome";v="114"',
                        'sec-ch-ua-platform': 'Windows',
                        'sec-ch-ua-mobile': '?0',
                        'origin': 'https://meudanfe.com.br',
                        'sec-fetch-site': 'cross-site',
                        'sec-fetch-mode': 'cors',
                        'sec-fetch-dest': 'empty',
                        'Content-Length': '44'
                    },
                    body: JSON.stringify(chave)
                });
                const resultBuscanfe = await buscanfe.json();
                
                if (!resultBuscanfe || resultBuscanfe.error) {
                    throw new Error('Erro ao buscar dados da API.');
                }

                // Segunda requisição para a API de obtenção do PDF
                const response = await fetch(`https://ws.meudanfe.com/api/v1/get/nfe/danfepdf/${chave}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json, text/plain; q=0.9, text/html;q=0.8,',
                        'Accept-Charset': 'utf-8, *;q=0.8',
                        'Accept-Language': 'pt-BR,pt;q=0.9,en-US;q=0.8,en;q=0.7',
                        'Host': 'ws.meudanfe.com',
                        'Referer': 'https://meudanfe.com.br/',
                        'User-Agent': 'Embarcadero URI Client/1.0, Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/114.0.0.0 Safari/537.36',
                        'sec-ch-ua': '"Not.A/Brand";v="8", "Chromium";v="114", "Google Chrome";v="114"',
                        'sec-ch-ua-platform': 'Windows',
                        'sec-ch-ua-mobile': '?0',
                        'origin': 'https://meudanfe.com.br',
                        'sec-fetch-site': 'cross-site',
                        'sec-fetch-mode': 'cors',
                        'sec-fetch-dest': 'empty',
                        'Content-Length': '44'
                    },
                    body: JSON.stringify(chave)
                });
                
                const result = await response.json();
                downloadPDF(result, `${chave}.pdf`);
                showNotification('PDF baixado com sucesso!', 'success');
            } catch (error) {
                console.error(error);
                showNotification('Ocorreu um erro ao baixar o PDF. Verifique se a chave e os dados da API estão corretos.', 'error');
            } finally {
                showLoading(false);
            }
        }

        function downloadPDF(base64PDF, fileName) {
            // Decodifica o dado Base64 para uma sequência binária
            const binaryData = atob(base64PDF);
            // Converte a sequência binária em um array de bytes
            const bytes = new Uint8Array(binaryData.length);
            for (let i = 0; i < binaryData.length; i++) {
                bytes[i] = binaryData.charCodeAt(i);
            }
            // Cria um objeto Blob a partir do array de bytes
            const blob = new Blob([bytes], { type: 'application/pdf' });
            // Cria um URL temporário para o objeto Blob
            const url = URL.createObjectURL(blob);
            // Cria um link e simula um clique para iniciar o download do PDF
            const a = document.createElement('a');
            a.href = url;
            a.download = fileName; // Defina o nome do arquivo PDF a ser baixado
            a.click();
            // Libera o URL temporário
            URL.revokeObjectURL(url);
        }

        // Função para baixar o XML
        async function postRequestXML() {
            const chave = document.getElementById('chaveInput').value.replace(/\D/g, '');
            // Verifica se a chave foi digitada
            if (!chave) {
                showNotification('Digite a chave antes de prosseguir.', 'error');
                return;
            }

            showLoading(true);

            try {
                // Primeira requisição para a API de busca de dados
                const buscanfe = await fetch(`https://ws.meudanfe.com/api/v1/get/nfe/data/APIAPP/${chave}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json, text/plain; q=0.9, text/html;q=0.8,',
                        'Accept-Charset': 'utf-8, *;q=0.8',
                        'Accept-Language': 'pt-BR,pt;q=0.9,en-US;q=0.8,en;q=0.7',
                        'Host': 'ws.meudanfe.com',
                        'Referer': 'https://meudanfe.com.br/',
                        'User-Agent': 'Embarcadero URI Client/1.0, Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/114.0.0.0 Safari/537.36',
                        'sec-ch-ua': '"Not.A/Brand";v="8", "Chromium";v="114", "Google Chrome";v="114"',
                        'sec-ch-ua-platform': 'Windows',
                        'sec-ch-ua-mobile': '?0',
                        'origin': 'https://meudanfe.com.br',
                        'sec-fetch-site': 'cross-site',
                        'sec-fetch-mode': 'cors',
                        'sec-fetch-dest': 'empty',
                        'Content-Length': '44'
                    },
                    body: JSON.stringify(chave)
                });
                const resultBuscanfe = await buscanfe.json();
                
                if (!resultBuscanfe || resultBuscanfe.error) {
                    throw new Error('Erro ao buscar dados da API.');
                }
                
                await fetchXMLData(chave);
                showNotification('XML baixado com sucesso!', 'success');
            } catch (error) {
                console.error(error);
                showNotification('Ocorreu um erro ao baixar o XML. Verifique se a chave e os dados da API estão corretos.', 'error');
            } finally {
                showLoading(false);
            }
        }
        
        async function fetchXMLData(chave) {
            try {
                // Requisição para a API de obtenção do XML
                const responseXML = await fetch(`https://ws.meudanfe.com/api/v1/get/nfe/xml/${chave}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'text/plain;charset=UTF-8',
                        'Accept': '*/*',
                        'Accept-Charset': 'utf-8, *;q=0.8',
                        'Accept-Language': 'pt-BR,pt;q=0.9,en-US;q=0.8,en;q=0.7',
                        'Host': 'ws.meudanfe.com',
                        'Referer': 'https://meudanfe.com.br/',
                        'User-Agent': 'Embarcadero URI Client/1.0, Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/114.0.0.0 Safari/537.36',
                        'sec-ch-ua': '"Not.A/Brand";v="8", "Chromium";v="114", "Google Chrome";v="114"',
                        'sec-ch-ua-platform': 'Windows',
                        'sec-ch-ua-mobile': '?0',
                        'origin': 'https://meudanfe.com.br',
                        'sec-fetch-site': 'cross-site',
                        'sec-fetch-mode': 'cors',
                        'sec-fetch-dest': 'empty',
                        'Content-Length': '44'
                    },
                    body: chave
                });
                if (!responseXML.ok) {
                    throw new Error('Erro ao obter o XML da API.');
                }
                const xmlData = await responseXML.text();
                downloadXML(xmlData, `${chave}.xml`); // Baixar o XML com o nome do arquivo como "[chave].xml"
                return xmlData;
            } catch (error) {
                console.error(error);
                throw error;
            }
        }
        
        function downloadXML(xmlData, fileName) {
            // Cria um objeto Blob a partir do XML
            const blob = new Blob([xmlData], { type: 'application/xml' });
            // Cria um URL temporário para o objeto Blob
            const url = URL.createObjectURL(blob);
            // Cria um link e simula um clique para iniciar o download do XML
            const a = document.createElement('a');
            a.href = url;
            a.download = fileName;
            a.click();
            // Libera o URL temporário
            URL.revokeObjectURL(url);
        }

        function showLoading(show) {
            document.getElementById('loading').style.display = show ? 'block' : 'none';
        }

        function showNotification(message, type) {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = type;
            notification.style.display = 'block';
            setTimeout(() => {
                notification.style.display = 'none';
            }, 5000);
        }

        function formatDate(dateStr) {
            if (!dateStr) return '';
            
            try {
                // Tenta extrair a data no formato ISO
                const date = new Date(dateStr);
                if (isNaN(date.getTime())) {
                    // Se não for uma data válida, retorna a string original
                    return dateStr;
                }
                
                // Formata a data
                return date.toLocaleString('pt-BR', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                });
            } catch (e) {
                return dateStr;
            }
        }

        // Função para formatar a chave de acesso
        function formatChaveAcesso(chave) {
            if (!chave || typeof chave !== 'string') {
                return '';
            }

            // Remove caracteres não numéricos
            chave = chave.replace(/\D/g, '');
            
            if (chave.length !== 44) {
                return chave;
            }

            // Extrai cada parte da chave de acesso usando substring
            const parte1 = chave.substring(0, 2);      // UF
            const parte2 = chave.substring(2, 6);      // AAMM
            const parte3 = chave.substring(6, 20);     // CNPJ
            const parte4 = chave.substring(20, 22);    // Modelo
            const parte5 = chave.substring(22, 25);    // Série
            const parte6 = chave.substring(25, 34);    // Número
            const parte7 = chave.substring(34, 43);    // Código
            const parte8 = chave.substring(43, 44);    // DV

            // Junta as partes formatadas com hífens
            return `${parte1}-${parte2}-${parte3}-${parte4}-${parte5}-${parte6}-${parte7}-${parte8}`;
        }

        document.getElementById('chaveInput').addEventListener('keypress', function(event) {
            if (event.key === 'Enter') {
                fetchNFeData();
            }
        });

        document.getElementById('chaveInput').addEventListener('input', function() {
            this.value = this.value.replace(/\D/g, '');
        });

        // Inicialização: verificar se há chave de acesso na URL
        window.addEventListener('DOMContentLoaded', () => {
            const urlParams = new URLSearchParams(window.location.search);
            const chave = urlParams.get('chave');
            if (chave) {
                document.getElementById('chaveInput').value = chave.replace(/\D/g, '');
                fetchNFeData();
            }
        });
    </script>
</body>
</html>
