<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculadora de Metas Avan√ßada v6</title> <style>
        :root {
            --font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
            
            /* Tema Claro (Padr√£o) */
            --bg-color: #f8f9fa;
            --card-bg-color: #ffffff;
            --text-color: #212529;
            --heading-color: #0056b3;
            --primary-accent-color: #007bff;
            --secondary-text-color: #6c757d;
            --border-color: #dee2e6;
            --input-bg-color: #fff;
            --input-border-color: #ced4da;
            --button-bg-color: #007bff;
            --button-text-color: #fff;
            --button-hover-bg-color: #0056b3;
            --button-secondary-bg-color: #6c757d;
            --button-secondary-hover-bg-color: #5a6268;
            --button-danger-bg-color: #dc3545;
            --button-danger-hover-bg-color: #c82333;
            --list-bg-color: #fdfdfd;
            --toast-bg-color: #333;
            --toast-text-color: #fff;
        }

        body.dark-theme {
            --bg-color: #1a1a1a;
            --card-bg-color: #2c2c2c;
            --text-color: #e0e0e0;
            --heading-color: #60a5fa;
            --primary-accent-color: #3b82f6;
            --secondary-text-color: #a0a0a0;
            --border-color: #444444;
            --input-bg-color: #3a3a3a;
            --input-border-color: #555555;
            --button-bg-color: #3b82f6;
            --button-text-color: #fff;
            --button-hover-bg-color: #2563eb;
            --button-secondary-bg-color: #5a6268;
            --button-secondary-hover-bg-color: #495057;
            --button-danger-bg-color: #e06c75;
            --button-danger-hover-bg-color: #d9534f;
            --list-bg-color: #333333;
            --toast-bg-color: #f8f9fa;
            --toast-text-color: #212529;
        }

        body {
            font-family: var(--font-family);
            line-height: 1.6;
            margin: 0;
            padding: 20px;
            background-color: var(--bg-color);
            color: var(--text-color);
            transition: background-color 0.3s, color 0.3s;
        }
        .container {
            max-width: 1200px;
            margin: auto;
            background: transparent;
            padding: 0;
        }
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding: 0 10px;
        }
        h1 {
            color: var(--heading-color);
            text-align: left;
            margin-bottom: 0;
            font-size: 1.8em;
        }
        .header-actions button {
            background: var(--card-bg-color);
            color: var(--primary-accent-color);
            border: 1px solid var(--border-color);
            padding: 8px 12px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 1.2em;
            margin-left: 10px;
            transition: background-color 0.3s, color 0.3s, transform 0.2s;
        }
        .header-actions button:hover {
            transform: scale(1.1);
        }
        .secao {
            background-color: var(--card-bg-color);
            border: 1px solid var(--border-color);
            padding: 20px;
            margin-bottom: 25px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            transition: background-color 0.3s, border-color 0.3s;
        }
        .secao h3, .secao h4 {
            margin-top: 0;
            color: var(--heading-color);
            border-bottom: 2px solid var(--primary-accent-color);
            padding-bottom: 8px;
            margin-bottom: 15px;
        }
        .secao h4 {
            font-size: 1.1em;
            border-bottom-width: 1px;
            margin-top: 20px;
        }
        label {
            display: block;
            margin-bottom: 6px;
            font-weight: 600;
            color: var(--secondary-text-color);
        }
        input[type="date"],
        input[type="number"],
        input[type="text"] {
            width: calc(100% - 24px);
            padding: 10px;
            margin-bottom: 12px;
            border: 1px solid var(--input-border-color);
            background-color: var(--input-bg-color);
            color: var(--text-color);
            border-radius: 5px;
            box-sizing: border-box;
            transition: border-color 0.3s, background-color 0.3s;
        }
        input[type="date"]:focus,
        input[type="number"]:focus,
        input[type="text"]:focus {
            outline: none;
            border-color: var(--primary-accent-color);
            box-shadow: 0 0 0 2px color-mix(in srgb, var(--primary-accent-color) 25%, transparent);
        }
        input[type="checkbox"] {
            margin-right: 8px;
            vertical-align: middle;
            width: 16px;
            height: 16px;
        }
        .campo-checkbox label {
            display: inline-block;
            font-weight: normal;
            color: var(--text-color);
        }
        .resultados p, .detalhe-semanal p, .resumo-performance p { 
            margin: 8px 0;
            font-size: 1em;
        }
        .resultados strong, .detalhe-semanal strong, .resumo-performance strong { 
            color: var(--primary-accent-color);
            font-weight: 600;
        }
        .lista-dias, .detalhe-semanal ul {
            list-style-type: none;
            padding-left: 0;
            max-height: 180px;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            padding: 12px;
            background-color: var(--list-bg-color);
            border-radius: 5px;
            margin-top: 8px;
        }
        .lista-dias li, .detalhe-semanal li {
            padding: 5px 2px;
            font-size: 0.95em;
        }
        .detalhe-semanal .semana-item {
            margin-bottom:12px;
            padding-bottom:8px;
            border-bottom: 1px dashed var(--border-color);
        }
        .detalhe-semanal .semana-item:last-child {
            border-bottom: none;
        }
        .detalhe-semanal .semana-item ul li {
            margin-left: 18px;
            font-size: 0.9em;
        }
        .info-dia-semana, .info-periodo-performance { 
            font-style: italic;
            color: var(--secondary-text-color);
            margin-bottom: 15px;
            font-size: 0.9em;
        }
        .grid-metas {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 25px;
        }
        .acoes-botoes button {
            background-color: var(--button-secondary-bg-color);
            color: var(--button-text-color);
            border: none;
            padding: 10px 15px;
            margin-right: 10px;
            margin-top:5px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.95em;
            transition: background-color 0.2s;
        }
        .acoes-botoes button:hover {
            background-color: var(--button-secondary-hover-bg-color);
        }
        .acoes-botoes button#btnEnviarWhatsApp {
            background-color: #25D366;
        }
        .acoes-botoes button#btnEnviarWhatsApp:hover {
            background-color: #1DAE52;
        }
        #toast-notification {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: var(--toast-bg-color);
            color: var(--toast-text-color);
            padding: 12px 20px;
            border-radius: 5px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
        }
        #toast-notification.show {
            opacity: 1;
            visibility: visible;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Calculadora de Metas</h1>
            <div class="header-actions">
                <button id="btnLimparDados" title="Limpar dados salvos">üóëÔ∏è</button>
                <button id="themeToggleBtn" aria-label="Alternar tema">‚òÄÔ∏è</button>
            </div>
        </header>

        <div class="secao">
            <h3>1. Data de In√≠cio e Dias de Faturamento</h3>
            <label for="dataInicio">Data de In√≠cio do C√°lculo (Metas Futuras):</label>
            <input type="date" id="dataInicio">
            <p id="infoDiaSemanaSelecionado" class="info-dia-semana"></p>
            <h4>Dias de Faturamento Restantes no M√™s (Seg-Qui)</h4>
            <p>Total de dias: <strong id="totalDiasFaturamento">0</strong></p>
            <label>Lista dos dias de faturamento (para metas futuras):</label>
            <ul id="listaDiasFaturamento" class="lista-dias"></ul>
        </div>
        
        <div class="secao acoes-botoes">
            <h3>Resumo e A√ß√µes</h3>
            <button id="btnCopiarResumo">üìã Copiar Resumo</button>
            <button id="btnEnviarWhatsApp">üì± Enviar por WhatsApp</button>
        </div>

        <div class="grid-metas">
             <div class="secao">
                <h3>Faturamento</h3>
                <label for="metaFaturamento">Meta de Faturamento (R$):</label>
                <input type="text" id="metaFaturamento" placeholder="Ex: 50.000,00" inputmode="decimal">
                <label for="faturamentoRealizado">Faturamento Realizado (R$):</label>
                <input type="text" id="faturamentoRealizado" placeholder="Ex: 15.000,00" inputmode="decimal">
                <div class="campo-checkbox">
                    <input type="checkbox" id="contarHojeFaturamento">
                    <label for="contarHojeFaturamento">Considerar dia atual no c√°lculo da meta di√°ria futura</label>
                </div>
                <div class="resultados">
                    <p>Falta para Meta: <strong id="saldoMetaFaturamento">R$ 0,00</strong></p>
                    <p>Venda Di√°ria Exigida (dias restantes): <strong id="vendaDiariaExigida">R$ 0,00</strong></p>
                </div>
                <h4>Detalhamento Semanal - Faturamento (dias restantes):</h4>
                <div id="detalheSemanalFaturamento" class="detalhe-semanal"></div>
            </div>
            <div class="secao">
                <h3>Positiva√ß√£o</h3>
                <label for="metaPositivacao">Meta de Positiva√ß√£o (unid.):</label>
                <input type="number" id="metaPositivacao" placeholder="Ex: 100">
                <label for="positivacaoRealizada">Positiva√ß√£o Realizada (unid.):</label>
                <input type="number" id="positivacaoRealizada" placeholder="Ex: 30">
                <div class="campo-checkbox">
                    <input type="checkbox" id="contarHojePositivacao">
                    <label for="contarHojePositivacao">Considerar dia atual no c√°lculo da meta di√°ria futura</label>
                </div>
                <div class="resultados">
                    <p>Falta para Meta: <strong id="saldoMetaPositivacao">0 unid.</strong></p>
                    <p>Positiva√ß√£o Di√°ria Exigida (dias restantes): <strong id="positivacaoDiariaExigida">0 unid.</strong></p>
                </div>
                <h4>Detalhamento Semanal - Positiva√ß√£o (dias restantes):</h4>
                <div id="detalheSemanalPositivacao" class="detalhe-semanal"></div>
            </div>
            <div class="secao">
                <h3>Kg</h3>
                <label for="metaKg">Meta Kg:</label>
                <input type="number" id="metaKg" step="0.001" placeholder="Ex: 1500.500">
                <label for="kgRealizado">Kg Realizado:</label>
                <input type="number" id="kgRealizado" step="0.001" placeholder="Ex: 350.250">
                <div class="campo-checkbox">
                    <input type="checkbox" id="contarHojeKg">
                    <label for="contarHojeKg">Considerar dia atual no c√°lculo da meta di√°ria futura</label>
                </div>
                <div class="resultados">
                    <p>Falta para Meta: <strong id="saldoMetaKg">0,000 Kg</strong></p>
                    <p>Kg Di√°rio Exigido (dias restantes): <strong id="kgDiarioExigido">0,000 Kg</strong></p>
                </div>
                <h4>Detalhamento Semanal - Kg (dias restantes):</h4>
                <div id="detalheSemanalKg" class="detalhe-semanal"></div>
            </div>
        </div>

        <div class="secao resumo-performance">
            <h3>Resumo da Performance Di√°ria (At√© a Data de In√≠cio do C√°lculo)</h3>
            <p id="infoPeriodoPerformance" class="info-periodo-performance"></p>
            <p>M√©dia Di√°ria de Faturamento Realizado: <strong id="resumoMediaFat">N/A</strong></p>
            <div id="detalheSemanalPerformanceFat" class="detalhe-semanal"></div> <hr style="border-top: 1px dashed var(--border-color); margin: 15px 0;">
            <p>M√©dia Di√°ria de Positiva√ß√£o Realizada: <strong id="resumoMediaPos">N/A</strong></p>
            <div id="detalheSemanalPerformancePos" class="detalhe-semanal"></div> <hr style="border-top: 1px dashed var(--border-color); margin: 15px 0;">
            <p>M√©dia Di√°ria de Kg Realizado: <strong id="resumoMediaKg">N/A</strong></p>
            <div id="detalheSemanalPerformanceKg" class="detalhe-semanal"></div>   </div>
    </div>
    <div id="toast-notification"></div>

    <script>
        // --- CONFIGURA√á√ïES E ELEMENTOS DO DOM ---
        const elBody = document.body;
        const elThemeToggleBtn = document.getElementById('themeToggleBtn');
        const elBtnLimparDados = document.getElementById('btnLimparDados');
        const elDataInicio = document.getElementById('dataInicio');
        const elInfoDiaSemanaSelecionado = document.getElementById('infoDiaSemanaSelecionado');
        const elTotalDiasFaturamento = document.getElementById('totalDiasFaturamento');
        const elListaDiasFaturamento = document.getElementById('listaDiasFaturamento');
        const elBtnCopiarResumo = document.getElementById('btnCopiarResumo');
        const elBtnEnviarWhatsApp = document.getElementById('btnEnviarWhatsApp');
        const elToastNotification = document.getElementById('toast-notification');
        const elMetaFaturamento = document.getElementById('metaFaturamento');
        const elFaturamentoRealizado = document.getElementById('faturamentoRealizado');
        const elContarHojeFaturamento = document.getElementById('contarHojeFaturamento');
        const elSaldoMetaFaturamento = document.getElementById('saldoMetaFaturamento');
        const elVendaDiariaExigida = document.getElementById('vendaDiariaExigida');
        const elDetalheSemanalFaturamento = document.getElementById('detalheSemanalFaturamento');
        const elMetaPositivacao = document.getElementById('metaPositivacao');
        const elPositivacaoRealizada = document.getElementById('positivacaoRealizada');
        const elContarHojePositivacao = document.getElementById('contarHojePositivacao');
        const elSaldoMetaPositivacao = document.getElementById('saldoMetaPositivacao');
        const elPositivacaoDiariaExigida = document.getElementById('positivacaoDiariaExigida');
        const elDetalheSemanalPositivacao = document.getElementById('detalheSemanalPositivacao');
        const elMetaKg = document.getElementById('metaKg');
        const elKgRealizado = document.getElementById('kgRealizado');
        const elContarHojeKg = document.getElementById('contarHojeKg');
        const elSaldoMetaKg = document.getElementById('saldoMetaKg');
        const elKgDiarioExigido = document.getElementById('kgDiarioExigido');
        const elDetalheSemanalKg = document.getElementById('detalheSemanalKg');
        const elResumoMediaFat = document.getElementById('resumoMediaFat');
        const elResumoMediaPos = document.getElementById('resumoMediaPos');
        const elResumoMediaKg = document.getElementById('resumoMediaKg');
        const elInfoPeriodoPerformance = document.getElementById('infoPeriodoPerformance');
        // Novos elementos para detalhamento semanal da performance
        const elDetalheSemanalPerformanceFat = document.getElementById('detalheSemanalPerformanceFat');
        const elDetalheSemanalPerformancePos = document.getElementById('detalheSemanalPerformancePos');
        const elDetalheSemanalPerformanceKg = document.getElementById('detalheSemanalPerformanceKg');


        const DIAS_SEMANA = ["Dom", "Seg", "Ter", "Qua", "Qui", "Sex", "S√°b"];
        const DIAS_SEMANA_COMPLETO = ["Domingo", "Segunda-feira", "Ter√ßa-feira", "Quarta-feira", "Quinta-feira", "Sexta-feira", "S√°bado"];
        let DATA_ATUAL_SISTEMA_CALC = new Date();
        DATA_ATUAL_SISTEMA_CALC.setHours(0,0,0,0); 
        const STORAGE_KEY_DADOS = 'calculadoraMetasDados_v3'; // v3 para nova estrutura
        const STORAGE_KEY_TEMA = 'calculadoraMetasTema_v1';

        // --- FUN√á√ïES DE TEMA, DADOS, AUXILIARES (Mantidas como na v5) ---
        function aplicarTema(tema) { elBody.classList.toggle('dark-theme', tema === 'dark'); elThemeToggleBtn.textContent = tema === 'dark' ? '‚òÄÔ∏è' : 'üåô'; }
        function alternarTema() { const novoTema = elBody.classList.contains('dark-theme') ? 'light' : 'dark'; aplicarTema(novoTema); localStorage.setItem(STORAGE_KEY_TEMA, novoTema); }
        function carregarTemaSalvo() { const temaSalvo = localStorage.getItem(STORAGE_KEY_TEMA); const prefSistemaEscuro = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches; if (temaSalvo) aplicarTema(temaSalvo); else if (prefSistemaEscuro) aplicarTema('dark'); else aplicarTema('light'); }
        function salvarDados() { const dados = { dataInicio: elDataInicio.value, metaFaturamento: elMetaFaturamento.value, faturamentoRealizado: elFaturamentoRealizado.value, contarHojeFaturamento: elContarHojeFaturamento.checked, metaPositivacao: elMetaPositivacao.value, positivacaoRealizada: elPositivacaoRealizada.value, contarHojePositivacao: elContarHojePositivacao.checked, metaKg: elMetaKg.value, kgRealizado: elKgRealizado.value, contarHojeKg: elContarHojeKg.checked, }; localStorage.setItem(STORAGE_KEY_DADOS, JSON.stringify(dados)); }
        function carregarDadosSalvos() { const dadosSalvos = localStorage.getItem(STORAGE_KEY_DADOS); const hojeFormatado = getDataFormatadaParaInput(DATA_ATUAL_SISTEMA_CALC); if (dadosSalvos) { const dados = JSON.parse(dadosSalvos); elDataInicio.value = dados.dataInicio || hojeFormatado; elMetaFaturamento.value = dados.metaFaturamento || ''; elFaturamentoRealizado.value = dados.faturamentoRealizado || ''; elContarHojeFaturamento.checked = dados.contarHojeFaturamento !== undefined ? dados.contarHojeFaturamento : true; elMetaPositivacao.value = dados.metaPositivacao || ''; elPositivacaoRealizada.value = dados.positivacaoRealizada || ''; elContarHojePositivacao.checked = dados.contarHojePositivacao !== undefined ? dados.contarHojePositivacao : true; elMetaKg.value = dados.metaKg || ''; elKgRealizado.value = dados.kgRealizado || ''; elContarHojeKg.checked = dados.contarHojeKg !== undefined ? dados.contarHojeKg : true;} else { elDataInicio.value = hojeFormatado; elContarHojeFaturamento.checked = true; elContarHojePositivacao.checked = true; elContarHojeKg.checked = true;}}
        function limparDadosSalvos() { if (confirm("Tem certeza que deseja apagar todos os dados salvos e redefinir a calculadora?")) { localStorage.removeItem(STORAGE_KEY_DADOS); const camposTexto = [elMetaFaturamento, elFaturamentoRealizado, elMetaPositivacao, elPositivacaoRealizada, elMetaKg, elKgRealizado]; camposTexto.forEach(campo => campo.value = ''); const checkboxes = [elContarHojeFaturamento, elContarHojePositivacao, elContarHojeKg]; checkboxes.forEach(cb => cb.checked = true); elDataInicio.value = getDataFormatadaParaInput(DATA_ATUAL_SISTEMA_CALC); atualizarTudo(); mostrarToast("Dados limpos e calculadora redefinida!"); } }
        function getDataFormatadaParaInput(dataObj) { return `${dataObj.getFullYear()}-${String(dataObj.getMonth() + 1).padStart(2, '0')}-${String(dataObj.getDate()).padStart(2, '0')}`; }
        function formatarData(data) { if (!data || !(data instanceof Date) || isNaN(data.getTime())) return 'N/A'; return `${String(data.getDate()).padStart(2, '0')}/${String(data.getMonth() + 1).padStart(2, '0')}/${data.getFullYear()}`; }
        function formatarValorMonetarioDisplay(valor) { return (isNaN(valor) ? 0 : valor).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }); }
        function formatarValorNumerico(valor, casasDec = 2, unidade = '') { let valFmt = (isNaN(valor) ? 0 : valor).toLocaleString('pt-BR', { minimumFractionDigits: casasDec, maximumFractionDigits: casasDec }); return unidade ? `${valFmt} ${unidade}` : valFmt; }
        function autoFormatarMoedaInput(event) { const input = event.target; let valor = input.value.replace(/\D/g, ''); if (valor === "") { input.value = ""; return; } valor = (parseFloat(valor) / 100); if (isNaN(valor)) { input.value = ""; return; } valor = valor.toFixed(2); let [pI, pD] = valor.split('.'); pI = pI.replace(/\B(?=(\d{3})+(?!\d))/g, "."); const valorFinal = pI + "," + pD; if(input.value !== valorFinal) input.value = valorFinal; }
        function limparValorMoeda(valFmt) { return parseFloat(String(valFmt).replace(/\./g, '').replace(',', '.')) || 0; }
        function getNomeDiaSemana(data, completo = false) { if (!data || !(data instanceof Date) || isNaN(data.getTime())) return ''; return completo ? DIAS_SEMANA_COMPLETO[data.getDay()] : DIAS_SEMANA[data.getDay()]; }
        function saoMesmaData(d1, d2) { return d1.getFullYear()===d2.getFullYear() && d1.getMonth()===d2.getMonth() && d1.getDate()===d2.getDate(); }
        function mostrarToast(msg) { elToastNotification.textContent = msg; elToastNotification.classList.add('show'); setTimeout(()=>elToastNotification.classList.remove('show'),3000); }

        let cacheDiasFaturamentoRestantes = { dias: [], contagem: 0 };
        function calcularDiasFaturamentoRestantes(dataInicioStr) { /* ... (Mantida como na v5) ... */ 
            const dataInicio = new Date(dataInicioStr + 'T00:00:00');
            if (isNaN(dataInicio.getTime())) return { dias: [], contagem: 0, htmlList: '' };
            elInfoDiaSemanaSelecionado.textContent = `Data selecionada: ${formatarData(dataInicio)} (${getNomeDiaSemana(dataInicio, true)})`;
            const diasFaturamento = []; const mesAtual = dataInicio.getMonth(); const anoAtual = dataInicio.getFullYear();
            let dataCorrente = new Date(dataInicio);
            while (dataCorrente.getMonth() === mesAtual && dataCorrente.getFullYear() === anoAtual) {
                if (dataCorrente.getDay() >= 1 && dataCorrente.getDay() <= 4) { diasFaturamento.push(new Date(dataCorrente));}
                dataCorrente.setDate(dataCorrente.getDate() + 1);
            }
            cacheDiasFaturamentoRestantes = { dias: diasFaturamento, contagem: diasFaturamento.length };
            const htmlList = diasFaturamento.map(dia => `<li>${formatarData(dia)} (${getNomeDiaSemana(dia, true)})</li>`).join('');
            return { ...cacheDiasFaturamentoRestantes, htmlList };
        }

        // MODIFICADA para retornar a lista de dias passados
        function calcularPerformanceDiariaAteData(dataFimCalculoStr) {
            const dataFim = new Date(dataFimCalculoStr + 'T00:00:00');
            if (isNaN(dataFim.getTime())) return { diasPassados: 0, primeiraData: null, ultimaData: null, listaDias: [] };

            const primeiroDiaDoMes = new Date(dataFim.getFullYear(), dataFim.getMonth(), 1);
            let diasFatPassados = 0;
            let dataCorr = new Date(primeiroDiaDoMes);
            let pDataFat = null, uDataFat = null;
            const listaDiasUteisPassados = [];

            while (dataCorr <= dataFim) {
                if (dataCorr.getDay() >= 1 && dataCorr.getDay() <= 4) { // Seg a Qui
                    diasFatPassados++;
                    if (!pDataFat) pDataFat = new Date(dataCorr);
                    uDataFat = new Date(dataCorr);
                    listaDiasUteisPassados.push(new Date(dataCorr)); // Adiciona √† lista
                }
                dataCorr.setDate(dataCorr.getDate() + 1);
            }
            return { diasPassados: diasFatPassados, primeiraData: pDataFat, ultimaData: uDataFat, listaDias: listaDiasUteisPassados };
        }
        
        let resultadosCalculoCache = {}; 
        function calcularValoresMeta(metaTotalStr, realizadoStr, diasFaturamentoLista, contarHoje, dataEntradaStr, tipoMeta = "dinheiro") { /* ... (Mantida como na v5) ... */ 
            let meta = tipoMeta === "dinheiro" ? limparValorMoeda(metaTotalStr) : parseFloat(metaTotalStr) || 0;
            let realizadoValor = tipoMeta === "dinheiro" ? limparValorMoeda(realizadoStr) : parseFloat(realizadoStr) || 0;
            const saldo = meta - realizadoValor; let diasParaDenominador = diasFaturamentoLista.length;
            const dataEntradaObj = new Date(dataEntradaStr + 'T00:00:00');
            let diaAtualConsideradoParaMeta = true; 
            if (saoMesmaData(dataEntradaObj, DATA_ATUAL_SISTEMA_CALC)) { 
                if (DATA_ATUAL_SISTEMA_CALC.getDay() >= 1 && DATA_ATUAL_SISTEMA_CALC.getDay() <= 4) { 
                    if (!contarHoje) { 
                        if (diasParaDenominador > 0 && diasFaturamentoLista.length > 0 && saoMesmaData(diasFaturamentoLista[0], DATA_ATUAL_SISTEMA_CALC)) {
                            diasParaDenominador--;
                        } diaAtualConsideradoParaMeta = false;
                    }
                } else { diaAtualConsideradoParaMeta = false; }
            } else if (dataEntradaObj < DATA_ATUAL_SISTEMA_CALC) { diaAtualConsideradoParaMeta = false; }
            const metaDiaria = (diasParaDenominador > 0 && saldo > 0) ? saldo / diasParaDenominador : 0;
            return { saldo, metaDiaria, diaAtualConsideradoCalculo: diaAtualConsideradoParaMeta };
        }
        
        // MODIFICADA para seguir o novo formato de exibi√ß√£o
        function gerarHtmlDetalheSemanal(listaDiasFaturamento, metaDiaria, tipoMeta = "dinheiro") {
            // A l√≥gica de limitar o fim da semana ao fim do m√™s j√° est√° na v5
            // O ajuste aqui √© no formato do texto principal do <li>
            if (metaDiaria <= 0 && (resultadosCalculoCache[tipoMeta]?.saldo || 0) <=0) { 
                return "<p>Meta atingida ou n√£o h√° valores pendentes.</p>";
            }
            if (!listaDiasFaturamento || listaDiasFaturamento.length === 0) {
                return "<p>Nenhum dia de faturamento futuro para exibir.</p>";
            }
            let ultimoDiaDoMesReferencia = null;
            const dataInicioObj = new Date(elDataInicio.value + 'T00:00:00'); // Usar a data de in√≠cio do c√°lculo para o m√™s
            if (!isNaN(dataInicioObj.getTime())) {
                 ultimoDiaDoMesReferencia = new Date(dataInicioObj.getFullYear(), dataInicioObj.getMonth() + 1, 0);
            }

            const semanas = {}; 
            listaDiasFaturamento.forEach(data => {
                const dataCopia = new Date(data), diaDaSemana = dataCopia.getDay();
                let inicioSemana = new Date(dataCopia); inicioSemana.setDate(dataCopia.getDate()-(diaDaSemana===0?6:diaDaSemana-1)); inicioSemana.setHours(0,0,0,0);
                const chaveSemana = formatarData(inicioSemana);
                if (!semanas[chaveSemana]) { 
                    let fimSemanaOriginal = new Date(inicioSemana); fimSemanaOriginal.setDate(inicioSemana.getDate()+6);
                    let fimSemanaExibicao = (ultimoDiaDoMesReferencia && fimSemanaOriginal > ultimoDiaDoMesReferencia) ? ultimoDiaDoMesReferencia : fimSemanaOriginal;
                    semanas[chaveSemana]={inicio: inicioSemana, fim: fimSemanaExibicao, dias:[],totalSemana:0};
                }
                semanas[chaveSemana].dias.push(data); semanas[chaveSemana].totalSemana += metaDiaria;
            });
            let html = "<ul>"; let contadorSemana = 1; let algumItemExibido = false;
            const chavesSemanasOrdenadas = Object.keys(semanas).sort((a,b)=>new Date(a.split('/').reverse().join('-')) - new Date(b.split('/').reverse().join('-')));
            for (const chaveSemana of chavesSemanasOrdenadas) {
                const semana = semanas[chaveSemana]; if(semana.totalSemana <= 0 && metaDiaria <=0 && resultadosCalculoCache[tipoMeta]?.saldo <=0 )continue; algumItemExibido=true;
                
                let valorTotalSemanaFormatado = "";
                if(tipoMeta==="dinheiro"){ valorTotalSemanaFormatado = formatarValorMonetarioDisplay(semana.totalSemana); }
                else if(tipoMeta==="unidade"){ valorTotalSemanaFormatado = formatarValorNumerico(semana.totalSemana,0,"unid."); }
                else if(tipoMeta==="kg"){ valorTotalSemanaFormatado = formatarValorNumerico(semana.totalSemana,3,"Kg"); }

                // NOVO FORMATO DE EXIBI√á√ÉO:
                html += `<li class="semana-item"><strong>Semana ${contadorSemana}: ${valorTotalSemanaFormatado} (${formatarData(semana.inicio)} a ${formatarData(semana.fim)})</strong><ul>`;
                
                semana.dias.sort((a,b)=>a-b).forEach(dia=>{html+=`<li>${formatarData(dia)} (${getNomeDiaSemana(dia, true)})</li>`;});
                html+="</ul></li>";contadorSemana++;
            } html+="</ul>";
            if(!algumItemExibido)return"<p>N√£o h√° detalhamento semanal para os dias restantes (verifique metas e dias).</p>";
            return html;
        }

        // NOVA FUN√á√ÉO para detalhamento semanal da performance
        function gerarHtmlDetalheSemanalPerformance(listaDiasPassados, mediaDiariaRealizada, tipoMeta = "dinheiro") {
            if (mediaDiariaRealizada <= 0 && listaDiasPassados.length === 0) {
                return "<p>Nenhuma performance para detalhar.</p>";
            }
             if (listaDiasPassados.length === 0) {
                return "<p>Nenhum dia de faturamento passado para detalhar.</p>";
            }

            let ultimoDiaDoMesReferencia = null;
            const dataInicioObj = new Date(elDataInicio.value + 'T00:00:00'); // Usar a data de in√≠cio do c√°lculo para o m√™s
             if (!isNaN(dataInicioObj.getTime())) {
                 ultimoDiaDoMesReferencia = new Date(dataInicioObj.getFullYear(), dataInicioObj.getMonth() + 1, 0);
            }

            const semanas = {};
            listaDiasPassados.forEach(data => {
                const dataCopia = new Date(data), diaDaSemana = dataCopia.getDay();
                let inicioSemana = new Date(dataCopia); inicioSemana.setDate(dataCopia.getDate()-(diaDaSemana===0?6:diaDaSemana-1)); inicioSemana.setHours(0,0,0,0);
                const chaveSemana = formatarData(inicioSemana);
                if (!semanas[chaveSemana]) {
                    let fimSemanaOriginal = new Date(inicioSemana); fimSemanaOriginal.setDate(inicioSemana.getDate()+6);
                    let fimSemanaExibicao = (ultimoDiaDoMesReferencia && fimSemanaOriginal > ultimoDiaDoMesReferencia) ? ultimoDiaDoMesReferencia : fimSemanaOriginal;
                    semanas[chaveSemana]={inicio: inicioSemana, fim: fimSemanaExibicao, dias:[], realizadoSemana:0};
                }
                semanas[chaveSemana].dias.push(data);
                semanas[chaveSemana].realizadoSemana += mediaDiariaRealizada; // Somando a m√©dia di√°ria para cada dia da semana
            });

            let html = "<ul>"; let contadorSemana = 1; let algumItemExibido = false;
            const chavesSemanasOrdenadas = Object.keys(semanas).sort((a,b)=>new Date(a.split('/').reverse().join('-')) - new Date(b.split('/').reverse().join('-')));
            
            for (const chaveSemana of chavesSemanasOrdenadas) {
                const semana = semanas[chaveSemana];
                if (semana.dias.length === 0) continue; // Pula semanas sem dias de faturamento passados
                algumItemExibido = true;
                
                let valorRealizadoSemanaFormatado = "";
                if(tipoMeta==="dinheiro"){ valorRealizadoSemanaFormatado = formatarValorMonetarioDisplay(semana.realizadoSemana); }
                else if(tipoMeta==="unidade"){ valorRealizadoSemanaFormatado = formatarValorNumerico(semana.realizadoSemana,0,"unid."); }
                else if(tipoMeta==="kg"){ valorRealizadoSemanaFormatado = formatarValorNumerico(semana.realizadoSemana,3,"Kg"); }

                html += `<li class="semana-item"><strong>Semana ${contadorSemana}: ${valorRealizadoSemanaFormatado} (${formatarData(semana.inicio)} a ${formatarData(semana.fim)})</strong><ul>`;
                semana.dias.sort((a,b)=>a-b).forEach(dia=>{html+=`<li>${formatarData(dia)} (${getNomeDiaSemana(dia, true)})</li>`;});
                html+="</ul></li>";contadorSemana++;
            }
            html += "</ul>";
            if(!algumItemExibido) return "<p>N√£o h√° detalhamento semanal da performance passada.</p>";
            return html;
        }


        function gerarTextoResumo() { /* ... (Mantida como na v5, com as corre√ß√µes de omiss√£o e formata√ß√£o) ... */ 
            const dataInicioCalcObj = new Date(elDataInicio.value + 'T00:00:00');
            const dataInicioCalcFormatada = formatarData(dataInicioCalcObj);
            let resumo = `*üéØ RESUMO DE METAS - Calculado a partir de: ${dataInicioCalcFormatada}*\n`;
            resumo += `====================================\n`;
            let algumaSecaoAdicionada = false;
            const infoDiasFatRestantes = cacheDiasFaturamentoRestantes;
            const ultimoDiaDoMesReferencia = new Date(dataInicioCalcObj.getFullYear(), dataInicioCalcObj.getMonth() + 1, 0);

            function getResumoSecao(nomeDisplay, nomeInterno, idMetaEl, idRealizadoEl, idSaldoEl, idDiariaEl, tipoMeta, unidadeMeta, casasDecDiaria) {
                const metaVal = tipoMeta === 'dinheiro' ? limparValorMoeda(idMetaEl.value) : parseFloat(idMetaEl.value) || 0;
                const realizadoVal = tipoMeta === 'dinheiro' ? limparValorMoeda(idRealizadoEl.value) : parseFloat(idRealizadoEl.value) || 0;
                if (metaVal === 0 && realizadoVal === 0) { return ""; }
                algumaSecaoAdicionada = true;
                const calculos = resultadosCalculoCache[nomeInterno];
                if (!calculos) return ""; 
                let txt = `\nüìä *${nomeDisplay.toUpperCase()}:*\n`;
                txt += `  Meta: ${tipoMeta === 'dinheiro' ? formatarValorMonetarioDisplay(metaVal) : formatarValorNumerico(metaVal, tipoMeta === 'kg' ? 3 : 0, unidadeMeta)}\n`;
                txt += `  Feito: ${tipoMeta === 'dinheiro' ? formatarValorMonetarioDisplay(realizadoVal) : formatarValorNumerico(realizadoVal, tipoMeta === 'kg' ? 3 : 0, unidadeMeta)}\n`;
                txt += `  Falta: ${idSaldoEl.textContent}\n`;
                const metaDiariaTexto = idDiariaEl.textContent;
                txt += `  Necessidade Di√°ria (Restante): ${metaDiariaTexto}\n`;
                txt += `  Semanas (Meta Di√°ria para dias restantes):\n`;
                if (calculos.metaDiaria > 0 && infoDiasFatRestantes.dias.length > 0) {
                    const semanas = {};
                    infoDiasFatRestantes.dias.forEach(data => {
                        const dataCopia = new Date(data), diaDaSemana = dataCopia.getDay();
                        let inicioSemana = new Date(dataCopia); inicioSemana.setDate(dataCopia.getDate()-(diaDaSemana===0?6:diaDaSemana-1)); inicioSemana.setHours(0,0,0,0);
                        const chaveSemana = formatarData(inicioSemana);
                        if (!semanas[chaveSemana]) {
                            let fimSemanaOriginal = new Date(inicioSemana); fimSemanaOriginal.setDate(inicioSemana.getDate()+6);
                            let fimSemanaExibicao = (fimSemanaOriginal > ultimoDiaDoMesReferencia) ? ultimoDiaDoMesReferencia : fimSemanaOriginal;
                            semanas[chaveSemana] = { inicio: inicioSemana, fim: fimSemanaExibicao };
                        }
                    });
                    const chavesSemanasOrdenadas = Object.keys(semanas).sort((a,b)=>new Date(a.split('/').reverse().join('-')) - new Date(b.split('/').reverse().join('-')));
                    let contadorSemanaResumo = 1;
                    chavesSemanasOrdenadas.forEach(chaveSemana => {
                        const semana = semanas[chaveSemana];
                        txt += `    - Semana ${contadorSemanaResumo} (${formatarData(semana.inicio)} a ${formatarData(semana.fim)}): ${metaDiariaTexto}/dia\n`;
                        contadorSemanaResumo++;
                    });
                } else { txt += `    - Meta atingida ou n√£o h√° valores/dias pendentes para os dias restantes.\n`; }
                txt += `  Dia Atual (${formatarData(DATA_ATUAL_SISTEMA_CALC)}) Considerado na Meta Di√°ria Futura: ${calculos.diaAtualConsideradoCalculo ? 'Sim' : 'N√£o'}\n`;
                return txt;
            }
            resumo += getResumoSecao('Faturamento', 'faturamento', elMetaFaturamento, elFaturamentoRealizado, elSaldoMetaFaturamento, elVendaDiariaExigida, 'dinheiro', 'R$', 2);
            resumo += getResumoSecao('Positivacao', 'positivacao', elMetaPositivacao, elPositivacaoRealizada, elSaldoMetaPositivacao, elPositivacaoDiariaExigida, 'unidade', 'unid.', 0);
            resumo += getResumoSecao('Kg', 'kg', elMetaKg, elKgRealizado, elSaldoMetaKg, elKgDiarioExigido, 'kg', 'Kg', 3);
            if (!algumaSecaoAdicionada) { return "Nenhuma meta preenchida para gerar o resumo."; }
            resumo += `\n------------------------------------\n`;
            resumo += `*CONFIGURA√á√ïES DO C√ÅLCULO (METAS FUTURAS):*\n`;
            resumo += `  Dias de Faturamento Restantes (Seg-Qui): ${infoDiasFatRestantes.contagem} dias.\n`;
            if (infoDiasFatRestantes.dias.length > 0) {
                 resumo += `  Per√≠odo dos dias restantes: ${formatarData(infoDiasFatRestantes.dias[0])} a ${formatarData(infoDiasFatRestantes.dias[infoDiasFatRestantes.dias.length-1])}\n`;
                 const listaDiasFormatada = infoDiasFatRestantes.dias.map(d => `${formatarData(d)} (${getNomeDiaSemana(d)})`).join(', ');
                 resumo += `  Lista de Dias Restantes: ${listaDiasFormatada}\n`;
            }
            return resumo;
        }

        elBtnCopiarResumo.addEventListener('click', () => { const texto = gerarTextoResumo(); if (texto === "Nenhuma meta preenchida para gerar o resumo.") { mostrarToast(texto); return; } navigator.clipboard.writeText(texto).then(() => mostrarToast("Resumo copiado!")).catch(err => mostrarToast("Erro ao copiar.")); });
        elBtnEnviarWhatsApp.addEventListener('click', () => { const texto = gerarTextoResumo(); if (texto === "Nenhuma meta preenchida para gerar o resumo.") { mostrarToast(texto); return; } window.open(`https://wa.me/?text=${encodeURIComponent(texto)}`, '_blank'); });

        function atualizarTudo() {
            DATA_ATUAL_SISTEMA_CALC = new Date(); 
            DATA_ATUAL_SISTEMA_CALC.setHours(0,0,0,0);
            const dataInicioSelecionada = elDataInicio.value; 
            if (!dataInicioSelecionada) return;

            const infoDiasFatRestantes = calcularDiasFaturamentoRestantes(dataInicioSelecionada);
            elTotalDiasFaturamento.textContent = infoDiasFatRestantes.contagem;
            elListaDiasFaturamento.innerHTML = infoDiasFatRestantes.htmlList;

            const calcFat = calcularValoresMeta(elMetaFaturamento.value, elFaturamentoRealizado.value, infoDiasFatRestantes.dias, elContarHojeFaturamento.checked, dataInicioSelecionada, "dinheiro");
            resultadosCalculoCache.faturamento = calcFat;
            elSaldoMetaFaturamento.textContent = formatarValorMonetarioDisplay(calcFat.saldo);
            elVendaDiariaExigida.textContent = formatarValorMonetarioDisplay(calcFat.metaDiaria);
            elDetalheSemanalFaturamento.innerHTML = gerarHtmlDetalheSemanal(infoDiasFatRestantes.dias, calcFat.metaDiaria, "dinheiro");

            const calcPos = calcularValoresMeta(elMetaPositivacao.value, elPositivacaoRealizada.value, infoDiasFatRestantes.dias, elContarHojePositivacao.checked, dataInicioSelecionada, "unidade");
            resultadosCalculoCache.positivacao = calcPos;
            elSaldoMetaPositivacao.textContent = formatarValorNumerico(calcPos.saldo, 0, "unid.");
            elPositivacaoDiariaExigida.textContent = formatarValorNumerico(calcPos.metaDiaria, 0, "unid.");
            elDetalheSemanalPositivacao.innerHTML = gerarHtmlDetalheSemanal(infoDiasFatRestantes.dias, calcPos.metaDiaria, "unidade");

            const calcKg = calcularValoresMeta(elMetaKg.value, elKgRealizado.value, infoDiasFatRestantes.dias, elContarHojeKg.checked, dataInicioSelecionada, "kg");
            resultadosCalculoCache.kg = calcKg;
            elSaldoMetaKg.textContent = formatarValorNumerico(calcKg.saldo, 3, "Kg");
            elKgDiarioExigido.textContent = formatarValorNumerico(calcKg.metaDiaria, 3, "Kg");
            elDetalheSemanalKg.innerHTML = gerarHtmlDetalheSemanal(infoDiasFatRestantes.dias, calcKg.metaDiaria, "kg");
            
            // Calcular e exibir performance di√°ria AT√â a data de in√≠cio
            const performanceAteData = calcularPerformanceDiariaAteData(dataInicioSelecionada);
            const diasPerformados = performanceAteData.diasPassados;
            const faturadoTotalRealizado = limparValorMoeda(elFaturamentoRealizado.value);
            const positivadoTotalRealizado = parseFloat(elPositivacaoRealizada.value) || 0;
            const kgTotalRealizado = parseFloat(elKgRealizado.value) || 0;

            if (diasPerformados > 0) {
                const mediaDiariaFat = faturadoTotalRealizado / diasPerformados;
                const mediaDiariaPos = positivadoTotalRealizado / diasPerformados;
                const mediaDiariaKg = kgTotalRealizado / diasPerformados;

                elResumoMediaFat.textContent = formatarValorMonetarioDisplay(mediaDiariaFat);
                elResumoMediaPos.textContent = formatarValorNumerico(mediaDiariaPos, 0, "unid.");
                elResumoMediaKg.textContent = formatarValorNumerico(mediaDiariaKg, 3, "Kg");
                
                elDetalheSemanalPerformanceFat.innerHTML = gerarHtmlDetalheSemanalPerformance(performanceAteData.listaDias, mediaDiariaFat, "dinheiro");
                elDetalheSemanalPerformancePos.innerHTML = gerarHtmlDetalheSemanalPerformance(performanceAteData.listaDias, mediaDiariaPos, "unidade");
                elDetalheSemanalPerformanceKg.innerHTML = gerarHtmlDetalheSemanalPerformance(performanceAteData.listaDias, mediaDiariaKg, "kg");

                if (performanceAteData.primeiraData && performanceAteData.ultimaData) {
                    elInfoPeriodoPerformance.textContent = `Considerando ${diasPerformados} dias de faturamento de ${formatarData(performanceAteData.primeiraData)} a ${formatarData(performanceAteData.ultimaData)}.`;
                } else {
                     const dataRef = performanceAteData.ultimaData || performanceAteData.primeiraData || new Date(dataInicioSelecionada + 'T00:00:00');
                     elInfoPeriodoPerformance.textContent = `Considerando ${diasPerformados} dia(s) de faturamento at√© ${formatarData(dataRef)}.`;
                }
            } else {
                elResumoMediaFat.textContent = "N/A"; elResumoMediaPos.textContent = "N/A"; elResumoMediaKg.textContent = "N/A";
                elDetalheSemanalPerformanceFat.innerHTML = "<p>Nenhum dia de faturamento no per√≠odo.</p>";
                elDetalheSemanalPerformancePos.innerHTML = "<p>Nenhum dia de faturamento no per√≠odo.</p>";
                elDetalheSemanalPerformanceKg.innerHTML = "<p>Nenhum dia de faturamento no per√≠odo.</p>";
                elInfoPeriodoPerformance.textContent = "Nenhum dia de faturamento no per√≠odo at√© a data selecionada para calcular a m√©dia.";
            }
            salvarDados();
        }

        elThemeToggleBtn.addEventListener('click', alternarTema);
        elBtnLimparDados.addEventListener('click', limparDadosSalvos);
        elDataInicio.addEventListener('change', atualizarTudo);
        [elMetaFaturamento, elFaturamentoRealizado].forEach(el => { el.addEventListener('input', autoFormatarMoedaInput); el.addEventListener('input', atualizarTudo); });
        [elContarHojeFaturamento, elContarHojePositivacao, elContarHojeKg].forEach(el => el.addEventListener('change', atualizarTudo));
        [elMetaPositivacao, elPositivacaoRealizada, elMetaKg, elKgRealizado].forEach(el => el.addEventListener('input', atualizarTudo));
        
        carregarTemaSalvo();
        carregarDadosSalvos(); 
        atualizarTudo(); 
    </script>
</body>
</html>
