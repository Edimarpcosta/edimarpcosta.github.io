<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculadora de Metas Avan√ßada v2</title>
    <style>
        :root {
            --font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
            
            /* Tema Claro (Padr√£o) */
            --bg-color: #f8f9fa;
            --card-bg-color: #ffffff;
            --text-color: #212529;
            --heading-color: #0056b3;
            --primary-accent-color: #007bff;
            --secondary-text-color: #6c757d;
            --border-color: #dee2e6;
            --input-bg-color: #fff;
            --input-border-color: #ced4da;
            --button-bg-color: #007bff;
            --button-text-color: #fff;
            --button-hover-bg-color: #0056b3;
            --button-secondary-bg-color: #6c757d;
            --button-secondary-hover-bg-color: #5a6268;
            --button-danger-bg-color: #dc3545;
            --button-danger-hover-bg-color: #c82333;
            --list-bg-color: #fdfdfd;
            --toast-bg-color: #333;
            --toast-text-color: #fff;
        }

        body.dark-theme {
            --bg-color: #1a1a1a;
            --card-bg-color: #2c2c2c;
            --text-color: #e0e0e0;
            --heading-color: #60a5fa;
            --primary-accent-color: #3b82f6;
            --secondary-text-color: #a0a0a0;
            --border-color: #444444;
            --input-bg-color: #3a3a3a;
            --input-border-color: #555555;
            --button-bg-color: #3b82f6;
            --button-text-color: #fff;
            --button-hover-bg-color: #2563eb;
            --button-secondary-bg-color: #5a6268;
            --button-secondary-hover-bg-color: #495057;
            --button-danger-bg-color: #e06c75;
            --button-danger-hover-bg-color: #d9534f;
            --list-bg-color: #333333;
            --toast-bg-color: #f8f9fa;
            --toast-text-color: #212529;
        }

        body {
            font-family: var(--font-family);
            line-height: 1.6;
            margin: 0;
            padding: 20px;
            background-color: var(--bg-color);
            color: var(--text-color);
            transition: background-color 0.3s, color 0.3s;
        }
        .container {
            max-width: 1200px;
            margin: auto;
            background: transparent;
            padding: 0;
        }
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding: 0 10px;
        }
        h1 {
            color: var(--heading-color);
            text-align: left;
            margin-bottom: 0;
            font-size: 1.8em;
        }
        .header-actions button {
            background: var(--card-bg-color);
            color: var(--primary-accent-color);
            border: 1px solid var(--border-color);
            padding: 8px 12px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 1.2em;
            margin-left: 10px;
            transition: background-color 0.3s, color 0.3s, transform 0.2s;
        }
        .header-actions button:hover {
            transform: scale(1.1);
        }
        .secao {
            background-color: var(--card-bg-color);
            border: 1px solid var(--border-color);
            padding: 20px;
            margin-bottom: 25px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            transition: background-color 0.3s, border-color 0.3s;
        }
        .secao h3, .secao h4 {
            margin-top: 0;
            color: var(--heading-color);
            border-bottom: 2px solid var(--primary-accent-color);
            padding-bottom: 8px;
            margin-bottom: 15px;
        }
        .secao h4 {
            font-size: 1.1em;
            border-bottom-width: 1px;
            margin-top: 20px;
        }
        label {
            display: block;
            margin-bottom: 6px;
            font-weight: 600;
            color: var(--secondary-text-color);
        }
        input[type="date"],
        input[type="number"],
        input[type="text"] {
            width: calc(100% - 24px);
            padding: 10px;
            margin-bottom: 12px;
            border: 1px solid var(--input-border-color);
            background-color: var(--input-bg-color);
            color: var(--text-color);
            border-radius: 5px;
            box-sizing: border-box;
            transition: border-color 0.3s, background-color 0.3s;
        }
        input[type="date"]:focus,
        input[type="number"]:focus,
        input[type="text"]:focus {
            outline: none;
            border-color: var(--primary-accent-color);
            box-shadow: 0 0 0 2px color-mix(in srgb, var(--primary-accent-color) 25%, transparent);
        }
        input[type="checkbox"] {
            margin-right: 8px;
            vertical-align: middle;
            width: 16px;
            height: 16px;
        }
        .campo-checkbox label {
            display: inline-block;
            font-weight: normal;
            color: var(--text-color);
        }
        .resultados p, .detalhe-semanal p {
            margin: 8px 0;
            font-size: 1em;
        }
        .resultados strong, .detalhe-semanal strong {
            color: var(--primary-accent-color);
            font-weight: 600;
        }
        .lista-dias, .detalhe-semanal ul {
            list-style-type: none;
            padding-left: 0;
            max-height: 180px;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            padding: 12px;
            background-color: var(--list-bg-color);
            border-radius: 5px;
            margin-top: 8px;
        }
        .lista-dias li, .detalhe-semanal li {
            padding: 5px 2px;
            font-size: 0.95em;
        }
        .detalhe-semanal .semana-item {
            margin-bottom:12px;
            padding-bottom:8px;
            border-bottom: 1px dashed var(--border-color);
        }
        .detalhe-semanal .semana-item:last-child {
            border-bottom: none;
        }
        .detalhe-semanal .semana-item ul li {
            margin-left: 18px;
            font-size: 0.9em;
        }
        .info-dia-semana {
            font-style: italic;
            color: var(--secondary-text-color);
            margin-bottom: 15px;
            font-size: 0.9em;
        }
        .grid-metas {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 25px;
        }
        .acoes-botoes button {
            background-color: var(--button-secondary-bg-color);
            color: var(--button-text-color);
            border: none;
            padding: 10px 15px;
            margin-right: 10px;
            margin-top:5px; /* Para n√£o colar se quebrar linha */
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.95em;
            transition: background-color 0.2s;
        }
        .acoes-botoes button:hover {
            background-color: var(--button-secondary-hover-bg-color);
        }
        .acoes-botoes button#btnEnviarWhatsApp {
            background-color: #25D366; /* Cor do WhatsApp */
        }
        .acoes-botoes button#btnEnviarWhatsApp:hover {
            background-color: #1DAE52;
        }
        .acoes-botoes button#btnLimparDados {
            background-color: var(--button-danger-bg-color);
        }
        .acoes-botoes button#btnLimparDados:hover {
            background-color: var(--button-danger-hover-bg-color);
        }
        #toast-notification {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: var(--toast-bg-color);
            color: var(--toast-text-color);
            padding: 12px 20px;
            border-radius: 5px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
        }
        #toast-notification.show {
            opacity: 1;
            visibility: visible;
        }

    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Calculadora de Metas</h1>
            <div class="header-actions">
                <button id="btnLimparDados" title="Limpar dados salvos">üóëÔ∏è</button>
                <button id="themeToggleBtn" aria-label="Alternar tema">‚òÄÔ∏è</button>
            </div>
        </header>

        <div class="secao">
            <h3>1. Data de In√≠cio e Dias de Faturamento</h3>
            <label for="dataInicio">Data de In√≠cio do C√°lculo:</label>
            <input type="date" id="dataInicio">
            <p id="infoDiaSemanaSelecionado" class="info-dia-semana"></p>

            <h4>Dias de Faturamento Restantes no M√™s (Seg-Qui)</h4>
            <p>Total de dias: <strong id="totalDiasFaturamento">0</strong></p>
            <label>Lista dos dias de faturamento:</label>
            <ul id="listaDiasFaturamento" class="lista-dias"></ul>
        </div>
        
        <div class="secao acoes-botoes">
            <h3>Resumo e A√ß√µes</h3>
            <button id="btnCopiarResumo">üìã Copiar Resumo</button>
            <button id="btnEnviarWhatsApp">üì± Enviar por WhatsApp</button>
        </div>

        <div class="grid-metas">
            <div class="secao">
                <h3>Faturamento</h3>
                <label for="metaFaturamento">Meta de Faturamento (R$):</label>
                <input type="text" id="metaFaturamento" placeholder="Ex: 50.000,00" inputmode="decimal">
                <label for="faturamentoRealizado">Faturamento Realizado (R$):</label>
                <input type="text" id="faturamentoRealizado" placeholder="Ex: 15.000,00" inputmode="decimal">
                <div class="campo-checkbox">
                    <input type="checkbox" id="contarHojeFaturamento">
                    <label for="contarHojeFaturamento">Considerar dia atual no c√°lculo da meta di√°ria</label>
                </div>
                <div class="resultados">
                    <p>Falta para Meta: <strong id="saldoMetaFaturamento">R$ 0,00</strong></p>
                    <p>Venda Di√°ria Exigida: <strong id="vendaDiariaExigida">R$ 0,00</strong></p>
                </div>
                <h4>Detalhamento Semanal - Faturamento:</h4>
                <div id="detalheSemanalFaturamento" class="detalhe-semanal"></div>
            </div>

            <div class="secao">
                <h3>Positiva√ß√£o</h3>
                <label for="metaPositivacao">Meta de Positiva√ß√£o (unid.):</label>
                <input type="number" id="metaPositivacao" placeholder="Ex: 100">
                <label for="positivacaoRealizada">Positiva√ß√£o Realizada (unid.):</label>
                <input type="number" id="positivacaoRealizada" placeholder="Ex: 30">
                <div class="campo-checkbox">
                    <input type="checkbox" id="contarHojePositivacao">
                    <label for="contarHojePositivacao">Considerar dia atual no c√°lculo da meta di√°ria</label>
                </div>
                <div class="resultados">
                    <p>Falta para Meta: <strong id="saldoMetaPositivacao">0 unid.</strong></p>
                    <p>Positiva√ß√£o Di√°ria Exigida: <strong id="positivacaoDiariaExigida">0 unid.</strong></p>
                </div>
                <h4>Detalhamento Semanal - Positiva√ß√£o:</h4>
                <div id="detalheSemanalPositivacao" class="detalhe-semanal"></div>
            </div>

            <div class="secao">
                <h3>Kg</h3>
                <label for="metaKg">Meta Kg:</label>
                <input type="number" id="metaKg" step="0.001" placeholder="Ex: 1500.500">
                <label for="kgRealizado">Kg Realizado:</label>
                <input type="number" id="kgRealizado" step="0.001" placeholder="Ex: 350.250">
                <div class="campo-checkbox">
                    <input type="checkbox" id="contarHojeKg">
                    <label for="contarHojeKg">Considerar dia atual no c√°lculo da meta di√°ria</label>
                </div>
                <div class="resultados">
                    <p>Falta para Meta: <strong id="saldoMetaKg">0,000 Kg</strong></p>
                    <p>Kg Di√°rio Exigido: <strong id="kgDiarioExigido">0,000 Kg</strong></p>
                </div>
                <h4>Detalhamento Semanal - Kg:</h4>
                <div id="detalheSemanalKg" class="detalhe-semanal"></div>
            </div>
        </div>
    </div>
    <div id="toast-notification"></div>

    <script>
        // --- CONFIGURA√á√ïES E ELEMENTOS DO DOM ---
        const elBody = document.body;
        const elThemeToggleBtn = document.getElementById('themeToggleBtn');
        const elBtnLimparDados = document.getElementById('btnLimparDados');
        const elDataInicio = document.getElementById('dataInicio');
        const elInfoDiaSemanaSelecionado = document.getElementById('infoDiaSemanaSelecionado');
        const elTotalDiasFaturamento = document.getElementById('totalDiasFaturamento');
        const elListaDiasFaturamento = document.getElementById('listaDiasFaturamento');

        const elBtnCopiarResumo = document.getElementById('btnCopiarResumo');
        const elBtnEnviarWhatsApp = document.getElementById('btnEnviarWhatsApp');
        const elToastNotification = document.getElementById('toast-notification');

        // Meta Faturamento
        const elMetaFaturamento = document.getElementById('metaFaturamento');
        const elFaturamentoRealizado = document.getElementById('faturamentoRealizado');
        const elContarHojeFaturamento = document.getElementById('contarHojeFaturamento');
        const elSaldoMetaFaturamento = document.getElementById('saldoMetaFaturamento');
        const elVendaDiariaExigida = document.getElementById('vendaDiariaExigida');
        const elDetalheSemanalFaturamento = document.getElementById('detalheSemanalFaturamento');

        // Meta Positiva√ß√£o
        const elMetaPositivacao = document.getElementById('metaPositivacao');
        const elPositivacaoRealizada = document.getElementById('positivacaoRealizada');
        const elContarHojePositivacao = document.getElementById('contarHojePositivacao');
        const elSaldoMetaPositivacao = document.getElementById('saldoMetaPositivacao');
        const elPositivacaoDiariaExigida = document.getElementById('positivacaoDiariaExigida');
        const elDetalheSemanalPositivacao = document.getElementById('detalheSemanalPositivacao');

        // Meta Kg
        const elMetaKg = document.getElementById('metaKg');
        const elKgRealizado = document.getElementById('kgRealizado');
        const elContarHojeKg = document.getElementById('contarHojeKg');
        const elSaldoMetaKg = document.getElementById('saldoMetaKg');
        const elKgDiarioExigido = document.getElementById('kgDiarioExigido');
        const elDetalheSemanalKg = document.getElementById('detalheSemanalKg');

        const DIAS_SEMANA = ["Domingo", "Segunda-feira", "Ter√ßa-feira", "Quarta-feira", "Quinta-feira", "Sexta-feira", "S√°bado"];
        let DATA_ATUAL_SISTEMA_CALC = new Date(); // Data atual real
        DATA_ATUAL_SISTEMA_CALC.setHours(0,0,0,0); // Normalizar para in√≠cio do dia

        const STORAGE_KEY_DADOS = 'calculadoraMetasDados_v1';
        const STORAGE_KEY_TEMA = 'calculadoraMetasTema_v1';

        // --- FUN√á√ïES DE TEMA ---
        function aplicarTema(tema) {
            if (tema === 'dark') {
                elBody.classList.add('dark-theme');
                elThemeToggleBtn.textContent = '‚òÄÔ∏è';
            } else {
                elBody.classList.remove('dark-theme');
                elThemeToggleBtn.textContent = 'üåô';
            }
        }
        function alternarTema() {
            const novoTema = elBody.classList.contains('dark-theme') ? 'light' : 'dark';
            aplicarTema(novoTema);
            localStorage.setItem(STORAGE_KEY_TEMA, novoTema);
        }
        function carregarTemaSalvo() {
            const temaSalvo = localStorage.getItem(STORAGE_KEY_TEMA);
            const prefSistemaEscuro = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
            if (temaSalvo) aplicarTema(temaSalvo);
            else if (prefSistemaEscuro) aplicarTema('dark');
            else aplicarTema('light');
        }

        // --- FUN√á√ïES DE DADOS (LocalStorage) ---
        function salvarDados() {
            const dados = {
                dataInicio: elDataInicio.value,
                metaFaturamento: elMetaFaturamento.value,
                faturamentoRealizado: elFaturamentoRealizado.value,
                contarHojeFaturamento: elContarHojeFaturamento.checked,
                metaPositivacao: elMetaPositivacao.value,
                positivacaoRealizada: elPositivacaoRealizada.value,
                contarHojePositivacao: elContarHojePositivacao.checked,
                metaKg: elMetaKg.value,
                kgRealizado: elKgRealizado.value,
                contarHojeKg: elContarHojeKg.checked,
            };
            localStorage.setItem(STORAGE_KEY_DADOS, JSON.stringify(dados));
        }

        function carregarDadosSalvos() {
            const dadosSalvos = localStorage.getItem(STORAGE_KEY_DADOS);
            if (dadosSalvos) {
                const dados = JSON.parse(dadosSalvos);
                elDataInicio.value = dados.dataInicio || getDataFormatadaParaInput(DATA_ATUAL_SISTEMA_CALC);
                elMetaFaturamento.value = dados.metaFaturamento || '';
                elFaturamentoRealizado.value = dados.faturamentoRealizado || '';
                elContarHojeFaturamento.checked = dados.contarHojeFaturamento !== undefined ? dados.contarHojeFaturamento : true;
                elMetaPositivacao.value = dados.metaPositivacao || '';
                elPositivacaoRealizada.value = dados.positivacaoRealizada || '';
                elContarHojePositivacao.checked = dados.contarHojePositivacao !== undefined ? dados.contarHojePositivacao : true;
                elMetaKg.value = dados.metaKg || '';
                elKgRealizado.value = dados.kgRealizado || '';
                elContarHojeKg.checked = dados.contarHojeKg !== undefined ? dados.contarHojeKg : true;
            } else {
                // Padr√µes se n√£o houver dados salvos
                elDataInicio.value = getDataFormatadaParaInput(DATA_ATUAL_SISTEMA_CALC);
                elContarHojeFaturamento.checked = true;
                elContarHojePositivacao.checked = true;
                elContarHojeKg.checked = true;
            }
        }

        function limparDadosSalvos() {
            if (confirm("Tem certeza que deseja apagar todos os dados salvos e redefinir a calculadora?")) {
                localStorage.removeItem(STORAGE_KEY_DADOS);
                // Redefinir campos para o padr√£o
                elMetaFaturamento.value = '';
                elFaturamentoRealizado.value = '';
                elMetaPositivacao.value = '';
                elPositivacaoRealizada.value = '';
                elMetaKg.value = '';
                elKgRealizado.value = '';
                elDataInicio.value = getDataFormatadaParaInput(DATA_ATUAL_SISTEMA_CALC);
                elContarHojeFaturamento.checked = true;
                elContarHojePositivacao.checked = true;
                elContarHojeKg.checked = true;
                atualizarTudo();
                mostrarToast("Dados limpos e calculadora redefinida!");
            }
        }
        
        function getDataFormatadaParaInput(dataObj) {
            const ano = dataObj.getFullYear();
            const mes = String(dataObj.getMonth() + 1).padStart(2, '0');
            const dia = String(dataObj.getDate()).padStart(2, '0');
            return `${ano}-${mes}-${dia}`;
        }

        // --- FUN√á√ïES AUXILIARES DE FORMATA√á√ÉO E UTILIDADES ---
        function formatarData(data) {
            if (!data || !(data instanceof Date)) return '';
            return `${String(data.getDate()).padStart(2, '0')}/${String(data.getMonth() + 1).padStart(2, '0')}/${data.getFullYear()}`;
        }
        function formatarValorMonetarioDisplay(valor) {
            return (isNaN(valor) ? 0 : valor).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
        }
        function formatarValorNumerico(valor, casasDecimais = 2, unidade = '') {
            let valorFormatado = (isNaN(valor) ? 0 : valor).toLocaleString('pt-BR', { minimumFractionDigits: casasDecimais, maximumFractionDigits: casasDecimais });
            return unidade ? `${valorFormatado} ${unidade}` : valorFormatado;
        }
        function autoFormatarMoedaInput(event) {
            const input = event.target;
            let valor = input.value.replace(/\D/g, ''); 
            if (valor === "") { input.value = ""; return; }
            valor = (parseFloat(valor) / 100);
            if (isNaN(valor)) { input.value = ""; return; }
            valor = valor.toFixed(2); 
            let [pI, pD] = valor.split('.');
            pI = pI.replace(/\B(?=(\d{3})+(?!\d))/g, ".");
            const valorFinal = pI + "," + pD;
            if(input.value !== valorFinal) input.value = valorFinal;
        }
        function limparValorMoeda(valorFormatado) {
            if (!valorFormatado || typeof valorFormatado !== 'string') return 0;
            return parseFloat(valorFormatado.replace(/\./g, '').replace(',', '.')) || 0;
        }
        function getNomeDiaSemana(data) { return DIAS_SEMANA[data.getDay()]; }
        function saoMesmaData(d1, d2) { return d1.getFullYear() === d2.getFullYear() && d1.getMonth() === d2.getMonth() && d1.getDate() === d2.getDate(); }

        function mostrarToast(mensagem) {
            elToastNotification.textContent = mensagem;
            elToastNotification.classList.add('show');
            setTimeout(() => {
                elToastNotification.classList.remove('show');
            }, 3000);
        }

        // --- FUN√á√ïES DE C√ÅLCULO PRINCIPAIS ---
        let cacheDiasFaturamento = { dias: [], contagem: 0 }; // Cache para evitar recalcular dias desnecessariamente

        function calcularDiasFaturamentoRestantes(dataInicioStr) {
            const dataInicio = new Date(dataInicioStr + 'T00:00:00');
            if (isNaN(dataInicio.getTime())) return { dias: [], contagem: 0, htmlList: '' };
            elInfoDiaSemanaSelecionado.textContent = `Data selecionada: ${formatarData(dataInicio)} (${getNomeDiaSemana(dataInicio)})`;
            
            const diasFaturamento = [];
            const mesAtual = dataInicio.getMonth();
            const anoAtual = dataInicio.getFullYear();
            let dataCorrente = new Date(dataInicio);

            while (dataCorrente.getMonth() === mesAtual && dataCorrente.getFullYear() === anoAtual) {
                if (dataCorrente.getDay() >= 1 && dataCorrente.getDay() <= 4) { // Seg a Qui
                    diasFaturamento.push(new Date(dataCorrente));
                }
                dataCorrente.setDate(dataCorrente.getDate() + 1);
            }
            cacheDiasFaturamento = { dias: diasFaturamento, contagem: diasFaturamento.length };
            const htmlList = diasFaturamento.map(dia => `<li>${formatarData(dia)} (${getNomeDiaSemana(dia)})</li>`).join('');
            return { ...cacheDiasFaturamento, htmlList };
        }

        function calcularValoresMeta(metaTotalStr, realizadoStr, diasFaturamentoLista, contarHoje, dataEntradaStr, tipoMeta = "dinheiro") {
            let meta = tipoMeta === "dinheiro" ? limparValorMoeda(metaTotalStr) : parseFloat(metaTotalStr) || 0;
            let realizadoValor = tipoMeta === "dinheiro" ? limparValorMoeda(realizadoStr) : parseFloat(realizadoStr) || 0;
            
            const saldo = meta - realizadoValor;
            let diasParaDenominador = diasFaturamentoLista.length;
            const dataEntradaObj = new Date(dataEntradaStr + 'T00:00:00');
            let diaAtualConsideradoParaMeta = true; // Assumimos que sim por padr√£o ou se n√£o for hoje

            if (saoMesmaData(dataEntradaObj, DATA_ATUAL_SISTEMA_CALC)) { // Se a data de c√°lculo √© HOJE
                if (DATA_ATUAL_SISTEMA_CALC.getDay() >= 1 && DATA_ATUAL_SISTEMA_CALC.getDay() <= 4) { // E HOJE √© dia de faturamento
                    if (!contarHoje) { // E o usu√°rio N√ÉO quer contar com hoje
                        if (diasParaDenominador > 0 && diasFaturamentoLista.length > 0 && saoMesmaData(diasFaturamentoLista[0], DATA_ATUAL_SISTEMA_CALC)) {
                            diasParaDenominador--;
                        }
                        diaAtualConsideradoParaMeta = false;
                    }
                } else { // Se HOJE N√ÉO √© dia de faturamento
                    diaAtualConsideradoParaMeta = false; // N√£o foi considerado porque n√£o √© dia √∫til
                }
            } else if (dataEntradaObj < DATA_ATUAL_SISTEMA_CALC) { // Se data de c√°lculo √© passada
                 diaAtualConsideradoParaMeta = false; // N√£o se aplica
            }
            // Se dataEntradaObj > DATA_ATUAL_SISTEMA_CALC, diaAtualConsideradoParaMeta = true (n√£o afeta o "hoje")

            const metaDiaria = (diasParaDenominador > 0 && saldo > 0) ? saldo / diasParaDenominador : 0;
            return { saldo, metaDiaria, diaAtualConsideradoCalculo: diaAtualConsideradoParaMeta };
        }
        
        let resultadosCalculoCache = {}; // Cache para guardar os resultados dos c√°lculos

        function gerarHtmlDetalheSemanal(listaDiasFaturamento, metaDiaria, tipoMeta = "dinheiro") {
             if (metaDiaria <= 0 && (resultadosCalculoCache[tipoMeta]?.saldo || 0) <=0) { 
                return "<p>Meta atingida ou n√£o h√° valores pendentes.</p>";
            }
            if (!listaDiasFaturamento || listaDiasFaturamento.length === 0) {
                return "<p>Nenhum dia de faturamento para exibir.</p>";
            }

            const semanas = {}; 
            listaDiasFaturamento.forEach(data => {
                const dataCopia = new Date(data), diaDaSemana = dataCopia.getDay();
                let inicioSemana = new Date(dataCopia);
                inicioSemana.setDate(dataCopia.getDate() - (diaDaSemana === 0 ? 6 : diaDaSemana - 1));
                inicioSemana.setHours(0,0,0,0);
                const chaveSemana = formatarData(inicioSemana);
                if (!semanas[chaveSemana]) {
                    let fimSemana = new Date(inicioSemana); fimSemana.setDate(inicioSemana.getDate() + 6);
                    semanas[chaveSemana] = { inicio, fim: fimSemana, dias: [], totalSemana: 0 };
                }
                semanas[chaveSemana].dias.push(data);
                semanas[chaveSemana].totalSemana += metaDiaria;
            });

            let html = "<ul>"; let contadorSemana = 1; let algumItemExibido = false;
            const chavesSemanasOrdenadas = Object.keys(semanas).sort((a,b) => new Date(a.split('/').reverse().join('-')) - new Date(b.split('/').reverse().join('-')));

            for (const chaveSemana of chavesSemanasOrdenadas) {
                const semana = semanas[chaveSemana];
                if (semana.totalSemana <= 0 && metaDiaria <=0) continue;
                algumItemExibido = true;
                const tituloSemana = `Semana ${contadorSemana} (${formatarData(semana.inicio)} a ${formatarData(semana.fim)})`;
                let vFmtSem = "", vFmtDia = "";
                if (tipoMeta === "dinheiro") { vFmtSem = formatarValorMonetarioDisplay(semana.totalSemana); vFmtDia = formatarValorMonetarioDisplay(metaDiaria); }
                else if (tipoMeta === "unidade") { vFmtSem = formatarValorNumerico(semana.totalSemana, 0, "unid."); vFmtDia = formatarValorNumerico(metaDiaria, 0, "unid."); }
                else if (tipoMeta === "kg") { vFmtSem = formatarValorNumerico(semana.totalSemana, 3, "Kg"); vFmtDia = formatarValorNumerico(metaDiaria, 3, "Kg"); }
                
                html += `<li class="semana-item"><strong>${tituloSemana}: Total ${vFmtSem}</strong> (Di√°ria: ${vFmtDia})<ul>`;
                semana.dias.sort((a,b) => a - b).forEach(dia => {
                    html += `<li>${formatarData(dia)} (${getNomeDiaSemana(dia)})</li>`;
                });
                html += "</ul></li>";
                contadorSemana++;
            }
            html += "</ul>";
            if (!algumItemExibido) return "<p>N√£o h√° detalhamento semanal (verifique metas e dias).</p>";
            return html;
        }

        // --- RESUMO E A√á√ïES ---
        function gerarTextoResumo() {
            const dataInicioCalc = formatarData(new Date(elDataInicio.value + 'T00:00:00'));
            let resumo = `*RESUMO DE METAS - Calculado a partir de: ${dataInicioCalc}*\n`;
            resumo += `------------------------------------\n`;

            const infoDiasFat = cacheDiasFaturamento;
            const listaDiasFormatada = infoDiasFat.dias.map(d => formatarData(d)).join(', ') || "Nenhum";

            function getResumoSecao(nomeSecao, calculos, tipoMeta, unidadeMeta, casasDecMetaDiaria = 2) {
                let txt = `\nüìä *${nomeSecao.toUpperCase()}:*\n`;
                txt += `Meta: ${tipoMeta === 'dinheiro' ? formatarValorMonetarioDisplay(limparValorMoeda(document.getElementById(`meta${nomeSecao}`).value)) : formatarValorNumerico(parseFloat(document.getElementById(`meta${nomeSecao}`).value) || 0, tipoMeta === 'kg' ? 3 : 0, unidadeMeta)}\n`;
                txt += `Feito: ${tipoMeta === 'dinheiro' ? formatarValorMonetarioDisplay(limparValorMoeda(document.getElementById(`${nomeSecao.toLowerCase()}Realizado`).value)) : formatarValorNumerico(parseFloat(document.getElementById(`${nomeSecao.toLowerCase()}Realizado`).value) || 0, tipoMeta === 'kg' ? 3 : 0, unidadeMeta)}\n`;
                txt += `Falta: ${tipoMeta === 'dinheiro' ? elSaldoMetaFaturamento.textContent : (tipoMeta === 'unidade' ? elSaldoMetaPositivacao.textContent : elSaldoMetaKg.textContent)}\n`;
                const metaDiariaTexto = tipoMeta === 'dinheiro' ? elVendaDiariaExigida.textContent : (tipoMeta === 'unidade' ? elPositivacaoDiariaExigida.textContent : elKgDiarioExigido.textContent);
                txt += `Necessidade Di√°ria: ${metaDiariaTexto}\n`;
                
                txt += `Resumo Semanal (Meta Di√°ria):\n`;
                const detalheSemanalEl = document.getElementById(`detalheSemanal${nomeSecao}`);
                const semanasLi = detalheSemanalEl.querySelectorAll('.semana-item > strong');
                if (semanasLi.length > 0) {
                    semanasLi.forEach(semanaStrong => {
                         // Extrai "Semana X (DD/MM/YYYY a DD/MM/YYYY): Total VALOR (Di√°ria: VALOR_DIARIO)"
                        const textoCompleto = semanaStrong.textContent;
                        const match = textoCompleto.match(/(Semana \d+ \([^)]+\)): Total [^(]+\(Di√°ria: ([^)]+)\)/);
                        if (match && match[1] && match[2]) {
                             txt += `- ${match[1]}: ${match[2]}/dia\n`;
                        } else {
                            // Fallback se o regex falhar, tenta pegar o b√°sico
                            const tituloSemana = textoCompleto.split(':')[0];
                            txt += `- ${tituloSemana}: ${metaDiariaTexto}/dia\n`;
                        }
                    });
                } else if (calculos.metaDiaria > 0){
                    txt += `- Nenhuma semana completa com faturamento restante ou meta di√°ria n√£o aplic√°vel.\n`;
                } else {
                     txt += `- Meta atingida ou n√£o h√° valores pendentes.\n`;
                }
                
                txt += `Dias de Faturamento (Seg-Qui): ${infoDiasFat.contagem} dias (${listaDiasFormatada})\n`;
                txt += `Dia Atual (${formatarData(DATA_ATUAL_SISTEMA_CALC)}) Considerado na Meta Di√°ria: ${calculos.diaAtualConsideradoCalculo ? 'Sim' : 'N√£o'}\n`;
                resumo += txt;
                return txt;
            }
            
            getResumoSecao('Faturamento', resultadosCalculoCache.faturamento, 'dinheiro', 'R$');
            getResumoSecao('Positivacao', resultadosCalculoCache.positivacao, 'unidade', 'unid.', 0);
            getResumoSecao('Kg', resultadosCalculoCache.kg, 'kg', 'Kg', 3);
            
            return resumo;
        }

        elBtnCopiarResumo.addEventListener('click', () => {
            const texto = gerarTextoResumo();
            navigator.clipboard.writeText(texto)
                .then(() => mostrarToast("Resumo copiado para a √°rea de transfer√™ncia!"))
                .catch(err => {
                    console.error("Erro ao copiar resumo: ", err);
                    mostrarToast("Erro ao copiar. Verifique permiss√µes ou console.");
                });
        });

        elBtnEnviarWhatsApp.addEventListener('click', () => {
            const texto = gerarTextoResumo();
            const textoCodificado = encodeURIComponent(texto);
            window.open(`https://wa.me/?text=${textoCodificado}`, '_blank');
        });


        // --- FUN√á√ÉO PRINCIPAL DE ATUALIZA√á√ÉO ---
        function atualizarTudo() {
            DATA_ATUAL_SISTEMA_CALC = new Date(); // Atualiza a data atual do sistema a cada c√°lculo
            DATA_ATUAL_SISTEMA_CALC.setHours(0,0,0,0);

            const dataInicioSelecionada = elDataInicio.value;
            if (!dataInicioSelecionada) return;

            const infoDiasFaturamento = calcularDiasFaturamentoRestantes(dataInicioSelecionada);
            elTotalDiasFaturamento.textContent = infoDiasFaturamento.contagem;
            elListaDiasFaturamento.innerHTML = infoDiasFaturamento.htmlList;

            // Faturamento
            const calculoFaturamento = calcularValoresMeta(elMetaFaturamento.value, elFaturamentoRealizado.value, infoDiasFaturamento.dias, elContarHojeFaturamento.checked, dataInicioSelecionada, "dinheiro");
            resultadosCalculoCache.faturamento = calculoFaturamento; // Salva no cache
            elSaldoMetaFaturamento.textContent = formatarValorMonetarioDisplay(calculoFaturamento.saldo);
            elVendaDiariaExigida.textContent = formatarValorMonetarioDisplay(calculoFaturamento.metaDiaria);
            elDetalheSemanalFaturamento.innerHTML = gerarHtmlDetalheSemanal(infoDiasFaturamento.dias, calculoFaturamento.metaDiaria, "dinheiro");

            // Positiva√ß√£o
            const calculoPositivacao = calcularValoresMeta(elMetaPositivacao.value, elPositivacaoRealizada.value, infoDiasFaturamento.dias, elContarHojePositivacao.checked, dataInicioSelecionada, "unidade");
            resultadosCalculoCache.positivacao = calculoPositivacao;
            elSaldoMetaPositivacao.textContent = formatarValorNumerico(calculoPositivacao.saldo, 0, "unid.");
            elPositivacaoDiariaExigida.textContent = formatarValorNumerico(calculoPositivacao.metaDiaria, 0, "unid.");
            elDetalheSemanalPositivacao.innerHTML = gerarHtmlDetalheSemanal(infoDiasFaturamento.dias, calculoPositivacao.metaDiaria, "unidade");

            // Kg
            const calculoKg = calcularValoresMeta(elMetaKg.value, elKgRealizado.value, infoDiasFaturamento.dias, elContarHojeKg.checked, dataInicioSelecionada, "kg");
            resultadosCalculoCache.kg = calculoKg;
            elSaldoMetaKg.textContent = formatarValorNumerico(calculoKg.saldo, 3, "Kg");
            elKgDiarioExigido.textContent = formatarValorNumerico(calculoKg.metaDiaria, 3, "Kg");
            elDetalheSemanalKg.innerHTML = gerarHtmlDetalheSemanal(infoDiasFaturamento.dias, calculoKg.metaDiaria, "kg");
            
            salvarDados(); // Salva todos os dados ap√≥s cada atualiza√ß√£o
        }

        // --- EVENT LISTENERS ---
        elThemeToggleBtn.addEventListener('click', alternarTema);
        elBtnLimparDados.addEventListener('click', limparDadosSalvos);
        elDataInicio.addEventListener('change', atualizarTudo);

        [elMetaFaturamento, elFaturamentoRealizado].forEach(el => {
            el.addEventListener('input', autoFormatarMoedaInput);
            el.addEventListener('input', atualizarTudo); 
        });
        
        [elContarHojeFaturamento, elContarHojePositivacao, elContarHojeKg].forEach(el => {
            el.addEventListener('change', atualizarTudo);
        });
        
        [elMetaPositivacao, elPositivacaoRealizada, elMetaKg, elKgRealizado].forEach(el => {
            el.addEventListener('input', atualizarTudo);
        });

        // --- INICIALIZA√á√ÉO ---
        carregarTemaSalvo();
        carregarDadosSalvos(); // Carrega antes de atualizar para usar os valores salvos
        atualizarTudo(); 
    </script>
</body>
</html>
