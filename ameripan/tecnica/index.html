<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Carrinho de Receitas Ameripan</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        :root {
            --primary-color: #0054a6;
            --primary-dark: #003c7a;
            --secondary-color: #f4f7fa;
            --text-color: #333;
            --light-text-color: #667;
            --card-bg: #ffffff;
            --shadow: 0 6px 15px rgba(0, 0, 0, 0.07);
            --border-radius: 12px;
            --success-color: #27ae60;
            --danger-color: #c0392b;
            --info-color: #2980b9;
            --warning-color: #f39c12;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        html { scroll-behavior: smooth; }
        body {
            font-family: 'Poppins', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--secondary-color);
            color: var(--text-color);
            line-height: 1.6;
        }

        header {
            background-color: var(--primary-color);
            color: white;
            padding: 1rem 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            position: sticky;
            top: 0;
            z-index: 1000;
        }
        header h1 { font-size: 1.4rem; font-weight: 600; }
        
        .main-container {
            display: grid;
            grid-template-columns: 1fr;
            padding: 1.5rem;
            gap: 1.5rem;
        }
        @media (min-width: 992px) {
            .main-container { grid-template-columns: 1.5fr 1fr; align-items: flex-start; }
            .section-cart { position: sticky; top: calc(70px + 1.5rem); }
        }

        .section {
            background-color: var(--card-bg);
            border-radius: var(--border-radius);
            padding: 1.5rem;
            box-shadow: var(--shadow);
            transition: all 0.3s ease;
        }

        .section-title {
            font-size: 1.3rem;
            font-weight: 600;
            margin-bottom: 1.5rem;
            padding-bottom: 0.75rem;
            border-bottom: 2px solid var(--secondary-color);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .input-group { position: relative; }
        .input-icon { position: absolute; left: 15px; top: 50%; transform: translateY(-50%); color: var(--light-text-color); }
        .search-input, .filter-select, .text-input {
            width: 100%;
            padding: 0.8rem;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
            font-family: 'Poppins', sans-serif;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .search-input { padding-left: 40px; }
        .search-input:focus, .filter-select:focus, .text-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(0, 84, 166, 0.1);
        }

        #product-catalog {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            gap: 1.25rem;
            max-height: 65vh;
            overflow-y: auto;
            padding: 0.5rem;
        }
        #product-catalog::-webkit-scrollbar { width: 8px; }
        #product-catalog::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 10px; }
        #product-catalog::-webkit-scrollbar-thumb { background: #ccc; border-radius: 10px; }
        #product-catalog::-webkit-scrollbar-thumb:hover { background: #aaa; }

        .product-card {
            background-color: #fff;
            border-radius: var(--border-radius);
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .product-card:hover { transform: translateY(-5px); box-shadow: 0 8px 15px rgba(0,0,0,0.1); }
        .product-card img { width: 100%; height: 120px; object-fit: cover; background-color: #eee; border-bottom: 1px solid #eee; }
        .product-info { padding: 0.75rem; flex-grow: 1; display: flex; flex-direction: column; }
        .product-name { font-size: 0.9rem; font-weight: 500; flex-grow: 1; margin-bottom: 0.25rem; }
        .product-sku, .product-ramo { font-size: 0.75rem; color: var(--light-text-color); }
        .add-to-cart-btn {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 0.7rem;
            width: 100%;
            cursor: pointer;
            font-size: 1.5rem;
            font-weight: bold;
            transition: background-color 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .add-to-cart-btn:hover { background-color: var(--primary-dark); }

        .control-group { margin-bottom: 1.5rem; border-bottom: 2px solid var(--secondary-color); padding-bottom: 1.5rem; }
        .control-group:last-of-type { border-bottom: none; }
        #recipe-cart-list { list-style: none; margin-bottom: 1rem; max-height: 250px; overflow-y: auto; }
        .cart-item { display: flex; justify-content: space-between; align-items: center; padding: 0.75rem 0.25rem; border-bottom: 1px dashed #ddd; }
        .cart-item:last-child { border-bottom: none; }
        .remove-item-btn { background: var(--danger-color); color: white; border: none; border-radius: 50%; width: 28px; height: 28px; font-weight: bold; cursor: pointer; transition: background-color 0.2s; }
        .remove-item-btn:hover { background: #a8332a; }

        .action-buttons { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 0.75rem; }
        .btn { padding: 0.8rem; border: none; border-radius: 8px; font-size: 0.9rem; font-weight: 600; cursor: pointer; transition: all 0.2s ease; display: flex; align-items: center; justify-content: center; gap: 0.5rem; }
        .btn:disabled { background-color: #bdc3c7; cursor: not-allowed; }
        .btn svg { width: 18px; height: 18px; }
        .btn-save { background-color: var(--success-color); color: white; }
        .btn-copy { background-color: var(--info-color); color: white; }
        .btn-load { background-color: var(--info-color); color: white; }
        .btn-delete { background-color: var(--danger-color); color: white; }
        .btn-clear { background-color: #7f8c8d; color: white; }
        .btn-consolidate { background-color: #8e44ad; color: white; }

        .recipe-source-tabs { display: flex; border-bottom: 2px solid #eee; margin-bottom: 1rem; }
        .recipe-source-tabs button { flex: 1; padding: 0.75rem; border: none; background: transparent; font-size: 1rem; font-weight: 500; cursor: pointer; color: var(--light-text-color); border-bottom: 3px solid transparent; }
        .recipe-source-tabs button.active { color: var(--primary-color); border-bottom-color: var(--primary-color); }

        #whatsapp-output { background-color: #e8f5e9; border-left: 4px solid var(--success-color); padding: 1rem; margin-top: 1.5rem; border-radius: 8px; white-space: pre-wrap; word-wrap: break-word; font-family: monospace; font-size: 0.9rem; }
        #loader { text-align: center; padding: 2rem; font-size: 1.2rem; font-weight: 500; }

        .toast { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background-color: rgba(0,0,0,0.75); color: white; padding: 12px 20px; border-radius: 25px; z-index: 9999; opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0.3s, transform 0.3s; }
        .toast.show { opacity: 1; visibility: visible; transform: translate(-50%, -10px); }

        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 2000; display: none; align-items: center; justify-content: center; }
        .modal-overlay.show { display: flex; }
        .modal-container { background: white; padding: 2rem; border-radius: var(--border-radius); box-shadow: 0 10px 30px rgba(0,0,0,0.2); width: 90%; max-width: 600px; max-height: 90vh; display: flex; flex-direction: column; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; }
        .modal-title { font-size: 1.5rem; font-weight: 600; }
        .modal-close-btn { background: none; border: none; font-size: 2rem; cursor: pointer; color: #aaa; }
        .modal-body { flex-grow: 1; overflow-y: auto; margin-bottom: 1.5rem; }
        #consolidate-recipe-list { list-style: none; }
        .consolidate-item { padding: 0.75rem 0.5rem; border-bottom: 1px solid #eee; display: flex; align-items: center; gap: 1rem; }
        .consolidate-item input[type="checkbox"] { width: 20px; height: 20px; }
        .consolidate-item label { font-size: 1.1rem; }
        .list-header { font-weight: 600; color: var(--primary-color); margin-top: 1rem; padding: 0.5rem; background-color: var(--secondary-color); border-radius: 6px; }
    </style>
</head>
<body>

    <header><h1>Receitas Ameripan</h1></header>

    <main class="main-container">
        <section class="section section-catalog">
            <h2 class="section-title">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><line x1="3" y1="9" x2="21" y2="9"></line><line x1="9" y1="21" x2="9" y2="9"></line></svg>
                Catálogo de Produtos
            </h2>
            <div class="filter-controls">
                <div class="input-group">
                    <span class="input-icon"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg></span>
                    <input type="text" id="search-input" class="search-input" placeholder="Buscar por nome ou SKU (use , para E)">
                </div>
                <select id="ramo-filter" class="filter-select"><option value="">Todos os Ramos</option></select>
            </div>
            <div id="loader">Carregando produtos...</div>
            <div id="product-catalog"></div>
        </section>

        <section class="section section-cart">
             <div class="control-group">
                <h3 class="section-title">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"></path></svg>
                    Receitas Salvas
                </h3>
                <div class="recipe-source-tabs">
                    <button id="tab-local" class="active" data-source="local">Locais</button>
                    <button id="tab-sheet" data-source="sheet">Planilha</button>
                </div>
                <div class="input-group" style="margin-bottom: 1rem;">
                     <span class="input-icon"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg></span>
                    <input type="text" id="recipe-search-input" class="search-input" placeholder="Buscar receita ou ingrediente...">
                </div>
                <select id="saved-recipes-select" class="filter-select" style="padding-left: 15px; margin-bottom: 1rem;"></select>
                <div class="action-buttons">
                    <button id="load-recipe-btn" class="btn btn-load">Carregar</button>
                    <button id="delete-recipe-btn" class="btn btn-delete">Excluir</button>
                </div>
                <button id="open-consolidate-modal-btn" class="btn btn-consolidate" style="width: 100%; margin-top: 0.75rem;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"></path></svg>
                    Consolidar Receitas
                </button>
            </div>

            <div class="control-group">
                <h3 class="section-title">
                     <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
                    Dados da Técnica
                </h3>
                <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                    <input type="text" id="tech-name" class="text-input" placeholder="Seu Nome">
                    <input type="text" id="tech-contact" class="text-input" placeholder="Seu Contato (Telefone/Email)">
                </div>
            </div>

            <h2 class="section-title">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4z"></path><line x1="3" y1="6" x2="21" y2="6"></line><path d="M16 10a4 4 0 0 1-8 0"></path></svg>
                Montar Receita
            </h2>
            <div class="recipe-controls" style="display: flex; flex-direction: column; gap: 1rem; margin-bottom: 1rem;">
                <input type="text" id="recipe-name" class="text-input" placeholder="Nome da Receita (ex: Sorvete Napolitano)">
                <textarea id="recipe-notes" class="text-input" rows="3" placeholder="Observações (opcional)"></textarea>
            </div>
            <ul id="recipe-cart-list"></ul>
            <div class="action-buttons" style="margin-bottom: 1.5rem;">
                <button id="save-recipe-btn" class="btn btn-save">Salvar</button>
                <button id="copy-whatsapp-btn" class="btn btn-copy">Copiar</button>
                <button id="clear-recipe-btn" class="btn btn-clear">Limpar</button>
            </div>
            <div id="whatsapp-output">Sua receita aparecerá formatada aqui...</div>
        </section>
    </main>

    <div id="consolidate-modal" class="modal-overlay">
        <div class="modal-container">
            <div class="modal-header">
                <h2 class="modal-title">Consolidar Receitas</h2>
                <button id="close-consolidate-modal-btn" class="modal-close-btn">&times;</button>
            </div>
            <div class="modal-body">
                <div class="input-group">
                    <span class="input-icon"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg></span>
                    <input type="text" id="consolidate-search" class="search-input" placeholder="Buscar receita ou ingrediente..." style="margin-bottom: 1rem;">
                </div>
                <input type="text" id="consolidate-title" class="text-input" placeholder="Título do Documento (ex: Receitas da Semana)" style="margin-bottom: 1rem;">
                <ul id="consolidate-recipe-list"></ul>
            </div>
            <div class="action-buttons">
                <button id="consolidate-copy-btn" class="btn btn-copy">Copiar Selecionadas</button>
                <button id="consolidate-pdf-btn" class="btn btn-pdf">Gerar PDF Consolidado</button>
            </div>
        </div>
    </div>

    <div id="toast" class="toast"></div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const { jsPDF } = window.jspdf;
            
            const API_KEY = 'AIzaSyChiZPUY-G3oyZN2NGY_vlgRXUzry9Pkeo';
            const SPREADSHEET_ID = '1cN_1GBR29BN77eRZAkzvikt96i_kX9AZ04cTc6XRM8Q';
            const PRODUCTS_SHEET = 'prod-img';
            const RECIPES_SHEET = 'receitas';
            const API_URL_PRODUCTS = `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/${PRODUCTS_SHEET}?key=${API_KEY}`;
            const API_URL_RECIPES = `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/${RECIPES_SHEET}!A2:R?key=${API_KEY}`;
            const LOGO_URL = 'https://edimarpcosta.github.io/ameripan/retirada/logo.webp';

            let allProducts = [], currentRecipe = { name: '', items: [], notes: '' }, savedRecipes = [], sheetRecipes = [], logoBase64 = null;
            let activeRecipeSource = 'local';
            
            const $ = (selector) => document.querySelector(selector);
            const $$ = (selector) => document.querySelectorAll(selector);

            const normalizeText = (text = '') => text.toString().toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");

            const showToast = (message) => {
                $('#toast').textContent = message;
                $('#toast').classList.add('show');
                setTimeout(() => $('#toast').classList.remove('show'), 3000);
            };

            const getBase64Image = (url) => new Promise((resolve, reject) => {
                const img = new Image();
                img.crossOrigin = 'Anonymous';
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    canvas.width = img.width; canvas.height = img.height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0);
                    resolve(canvas.toDataURL('image/png'));
                };
                img.onerror = reject;
                img.src = url;
            });

            async function initializeData() {
                try {
                    await fetchProducts();
                    await fetchSheetRecipes();
                    $('#loader').style.display = 'none';
                } catch (error) {
                     console.error("Falha ao inicializar dados:", error);
                    $('#loader').textContent = 'Erro ao carregar dados.';
                }
            }

            async function fetchProducts() {
                const response = await fetch(API_URL_PRODUCTS);
                if (!response.ok) throw new Error(`Erro na API de Produtos: ${response.statusText}`);
                const data = await response.json();
                const [headers, ...rows] = data.values;
                allProducts = rows.map(row => Object.fromEntries(headers.map((h, i) => [h.toLowerCase(), row[i] || '']))).filter(p => p.sku && p.produto);
                populateRamoFilter();
                renderCatalog();
            }

            async function fetchSheetRecipes() {
                const response = await fetch(API_URL_RECIPES);
                if (!response.ok) { console.warn(`Aba "receitas" não encontrada ou vazia.`); return; }
                const data = await response.json();
                if (!data.values) return;

                sheetRecipes = data.values.map((row, index) => {
                    const name = row[0];
                    if (!name) return null;
                    const items = row.slice(1).map(ingredient => {
                        if (!ingredient) return null;
                        const skuMatch = ingredient.match(/\d+/);
                        if (!skuMatch) return null;
                        return allProducts.find(p => p.sku === skuMatch[0]);
                    }).filter(Boolean);
                    return { id: `sheet-${index}`, name, items, notes: '' };
                }).filter(Boolean);
                renderSavedRecipes();
            }

            function populateRamoFilter() {
                const ramos = [...new Set(allProducts.map(p => p.ramo).filter(Boolean))].sort();
                ramos.forEach(ramo => $('#ramo-filter').appendChild(Object.assign(document.createElement('option'), { value: ramo, textContent: ramo })));
            }

            function renderCatalog() {
                const searchTerms = normalizeText($('#search-input').value).split(',').map(t => t.trim()).filter(Boolean);
                const selectedRamo = $('#ramo-filter').value;
                const filteredProducts = allProducts.filter(p => {
                    const normalizedProduct = normalizeText(p.produto);
                    const matchesSearch = searchTerms.length === 0 || searchTerms.every(term => normalizedProduct.includes(term));
                    const matchesRamo = !selectedRamo || p.ramo === selectedRamo;
                    return matchesSearch && matchesRamo;
                });
                $('#product-catalog').innerHTML = filteredProducts.length === 0 ? '<p>Nenhum produto encontrado.</p>' : '';
                filteredProducts.forEach(product => {
                    const card = document.createElement('div');
                    card.className = 'product-card';
                    card.innerHTML = `<img src="${product.img}" alt="${product.produto}" onerror="this.style.display='none'"><div class="product-info"><p class="product-name">${product.produto}</p><div><span class="product-sku">SKU: ${product.sku}</span><br><span class="product-ramo">${product.ramo || 'Sem Ramo'}</span></div></div><button class="add-to-cart-btn" data-sku="${product.sku}">+</button>`;
                    $('#product-catalog').appendChild(card);
                });
            }

            function addToRecipe(sku) {
                const product = allProducts.find(p => p.sku === sku);
                if (product) {
                    currentRecipe.items.push(product);
                    renderCart();
                    showToast(`${product.produto} adicionado.`);
                }
            }

            function removeFromRecipe(index) {
                const removedItem = currentRecipe.items.splice(index, 1);
                renderCart();
                showToast(`${removedItem[0].produto} removido.`);
            }

            function clearCurrentRecipe() {
                if (confirm('Limpar a receita atual? Alterações não salvas serão perdidas.')) {
                    currentRecipe = { name: '', items: [], notes: '' };
                    $('#recipe-name').value = '';
                    $('#recipe-notes').value = '';
                    renderCart();
                    showToast('Receita limpa.');
                }
            }

            function renderCart() {
                $('#recipe-cart-list').innerHTML = currentRecipe.items.length === 0 ? '<li>Adicione produtos do catálogo.</li>' : '';
                currentRecipe.items.forEach((item, index) => {
                    const li = document.createElement('li');
                    li.className = 'cart-item';
                    li.innerHTML = `<div class="cart-item-info">${item.produto}<div class="product-sku">SKU: ${item.sku}</div></div><button class="remove-item-btn" data-index="${index}">-</button>`;
                    $('#recipe-cart-list').appendChild(li);
                });
                updateWhatsappPreview();
            }

            function updateWhatsappPreview() {
                const recipeName = $('#recipe-name').value.trim() || "Nova Receita";
                let text = `🍨 *${recipeName}*\n`;
                text += currentRecipe.items.length > 0 ? currentRecipe.items.map(item => `${item.sku} - ${item.produto}`).join('\n-----------------------------------\n') : "Nenhum ingrediente adicionado.";
                const notes = $('#recipe-notes').value.trim();
                if (notes) text += `\n\n*Observações:*\n${notes}`;
                text += '\n\nAmeripan - Ingredientes';
                $('#whatsapp-output').textContent = text;
            }

            function saveCurrentRecipe() {
                const recipeName = $('#recipe-name').value.trim();
                if (!recipeName) { showToast('Dê um nome para a receita.'); return; }
                if (currentRecipe.items.length === 0) { showToast('Adicione ingredientes para salvar.'); return; }

                const existingIndex = savedRecipes.findIndex(r => r.name.toLowerCase() === recipeName.toLowerCase());
                if (existingIndex > -1) {
                    if (!confirm(`Receita "${recipeName}" já existe. Deseja sobrescrevê-la?`)) return;
                    savedRecipes[existingIndex] = { ...savedRecipes[existingIndex], items: currentRecipe.items, notes: $('#recipe-notes').value.trim() };
                } else {
                    savedRecipes.push({ id: Date.now().toString(), name: recipeName, items: currentRecipe.items, notes: $('#recipe-notes').value.trim() });
                }
                localStorage.setItem('ameripan_recipes', JSON.stringify(savedRecipes));
                showToast(`Receita "${recipeName}" salva!`);
                renderSavedRecipes();
            }

            function loadRecipesFromStorage() {
                savedRecipes = JSON.parse(localStorage.getItem('ameripan_recipes') || '[]');
            }

            function renderSavedRecipes() {
                const source = activeRecipeSource;
                const searchTerm = normalizeText($('#recipe-search-input').value);
                const recipeList = source === 'local' ? savedRecipes : sheetRecipes;
                
                const filtered = recipeList.filter(r => {
                    const normalizedName = normalizeText(r.name);
                    const normalizedIngredients = r.items.map(i => normalizeText(i.produto)).join(' ');
                    return normalizedName.includes(searchTerm) || normalizedIngredients.includes(searchTerm);
                });

                $('#saved-recipes-select').innerHTML = '<option value="">Selecione uma receita...</option>';
                filtered.forEach(recipe => {
                    const option = document.createElement('option');
                    option.value = recipe.id;
                    option.textContent = recipe.name;
                    option.dataset.source = source;
                    $('#saved-recipes-select').appendChild(option);
                });
                $('#delete-recipe-btn').style.display = source === 'local' ? 'flex' : 'none';
            }
            
            function loadRecipe(id, source) {
                const recipeList = source === 'local' ? savedRecipes : sheetRecipes;
                const recipeToLoad = recipeList.find(r => r.id === id);
                if (recipeToLoad) {
                    $('#recipe-name').value = recipeToLoad.name;
                    $('#recipe-notes').value = recipeToLoad.notes;
                    currentRecipe = JSON.parse(JSON.stringify(recipeToLoad));
                    renderCart();
                    showToast(`Receita "${recipeToLoad.name}" carregada.`);
                }
            }

            function deleteRecipe(id) {
                const recipeName = savedRecipes.find(r => r.id === id)?.name || '';
                if (confirm(`Excluir a receita "${recipeName}"?`)) {
                    savedRecipes = savedRecipes.filter(r => r.id !== id);
                    localStorage.setItem('ameripan_recipes', JSON.stringify(savedRecipes));
                    renderSavedRecipes();
                    showToast(`Receita "${recipeName}" excluída.`);
                }
            }
            
            function copyToClipboard(text) {
                navigator.clipboard.writeText(text).then(() => showToast('Copiado!'), () => showToast('Erro ao copiar.'));
            }

            function saveTechInfo() {
                localStorage.setItem('ameripan_tech_info', JSON.stringify({ name: $('#tech-name').value, contact: $('#tech-contact').value }));
            }

            function loadTechInfo() {
                const techInfo = JSON.parse(localStorage.getItem('ameripan_tech_info') || '{}');
                $('#tech-name').value = techInfo.name || '';
                $('#tech-contact').value = techInfo.contact || '';
            }

            function toggleModal(show) {
                $('#consolidate-modal').classList.toggle('show', show);
            }

            function renderConsolidateList(searchTerm = '') {
                const list = $('#consolidate-recipe-list');
                list.innerHTML = '';
                const normalizedSearch = normalizeText(searchTerm);

                const renderList = (recipes, title, source) => {
                    const filtered = recipes.filter(r => normalizeText(r.name).includes(normalizedSearch) || r.items.some(i => normalizeText(i.produto).includes(normalizedSearch)));
                    if (filtered.length === 0) return;

                    list.insertAdjacentHTML('beforeend', `<li class="list-header">${title}</li>`);
                    filtered.forEach(recipe => {
                        const li = document.createElement('li');
                        li.className = 'consolidate-item';
                        li.innerHTML = `<input type="checkbox" id="recipe-${recipe.id}" data-id="${recipe.id}" data-source="${source}"><label for="recipe-${recipe.id}">${recipe.name}</label>`;
                        list.appendChild(li);
                    });
                };
                renderList(savedRecipes, 'Receitas Locais', 'local');
                renderList(sheetRecipes, 'Receitas da Planilha', 'sheet');
            }

            function openConsolidateModal() {
                renderConsolidateList();
                $('#consolidate-title').value = '';
                toggleModal(true);
            }

            function getSelectedConsolidateRecipes() {
                const selected = [...$$('#consolidate-recipe-list input:checked')];
                return selected.map(cb => {
                    const list = cb.dataset.source === 'local' ? savedRecipes : sheetRecipes;
                    return list.find(r => r.id === cb.dataset.id);
                });
            }

            function consolidateCopy() {
                const selectedRecipes = getSelectedConsolidateRecipes();
                if (selectedRecipes.length === 0) { showToast('Selecione ao menos uma receita.'); return; }
                let fullText = selectedRecipes.map(recipe => {
                    let text = `🍨 *${recipe.name}*\n`;
                    text += recipe.items.map(item => `${item.sku} - ${item.produto}`).join('\n-----------------------------------\n');
                    if (recipe.notes) text += `\n\n*Observações:*\n${recipe.notes}`;
                    return text;
                }).join('\n\n===================================\n\n');
                copyToClipboard(fullText);
                toggleModal(false);
            }

            async function consolidatePdf() {
                const selectedRecipes = getSelectedConsolidateRecipes();
                const docTitle = $('#consolidate-title').value.trim() || 'Receitas Consolidadas';
                if (selectedRecipes.length === 0) { showToast('Selecione ao menos uma receita.'); return; }

                showToast('Gerando PDF...');
                const doc = new jsPDF();
                const techName = $('#tech-name').value.trim(), techContact = $('#tech-contact').value.trim();
                let pageNumber = 1, pageHeight = doc.internal.pageSize.height;

                const addHeader = () => {
                    if (logoBase64) doc.addImage(logoBase64, 'PNG', 15, 8, 40, 10);
                    doc.setDrawColor(0, 84, 166); doc.setLineWidth(0.5); doc.line(15, 22, 195, 22);
                };
                const addFooter = () => {
                    doc.setFontSize(9); doc.setTextColor(150);
                    doc.text(`${techName} | ${techContact}`, 15, pageHeight - 10);
                    doc.text(`Página ${pageNumber}`, 195, pageHeight - 10, { align: 'right' });
                };
                
                addHeader(); addFooter();
                let y = 40;
                doc.setFont('helvetica', 'bold'); doc.setFontSize(20); doc.setTextColor(51, 51, 51);
                doc.text(docTitle, 105, y, { align: 'center' });
                y += 20;

                for (const recipe of selectedRecipes) {
                    const neededHeight = 10 + (recipe.items.length * 7) + (recipe.notes ? 15 : 0);
                    if (y + neededHeight > pageHeight - 20) {
                        doc.addPage(); pageNumber++; y = 30; addHeader(); addFooter();
                    }
                    doc.setFont('helvetica', 'bold'); doc.setFontSize(14); doc.setTextColor(0, 84, 166);
                    doc.text(recipe.name, 15, y); y += 10;
                    doc.setFont('helvetica', 'normal'); doc.setFontSize(11); doc.setTextColor(51, 51, 51);
                    recipe.items.forEach(item => {
                        if (y > pageHeight - 20) { doc.addPage(); pageNumber++; y = 30; addHeader(); addFooter(); }
                        doc.text(`${item.sku} - ${item.produto}`, 20, y); y += 7;
                    });
                    if (recipe.notes) {
                         if (y > pageHeight - 30) { doc.addPage(); pageNumber++; y = 30; addHeader(); addFooter(); }
                        doc.setFont('helvetica', 'bolditalic'); doc.setFontSize(10); doc.text('Observações:', 20, y); y += 5;
                        doc.setFont('helvetica', 'normal');
                        const splitNotes = doc.splitTextToSize(recipe.notes, 170);
                        doc.text(splitNotes, 20, y); y += (splitNotes.length * 5);
                    }
                    y += 10;
                }
                doc.save(`${docTitle.replace(/ /g, '_')}.pdf`);
                toggleModal(false);
            }

            // --- Event Listeners ---
            $('#search-input').addEventListener('input', renderCatalog);
            $('#ramo-filter').addEventListener('change', renderCatalog);
            $('#recipe-name').addEventListener('input', updateWhatsappPreview);
            $('#recipe-notes').addEventListener('input', updateWhatsappPreview);
            $('#save-recipe-btn').addEventListener('click', saveCurrentRecipe);
            $('#copy-whatsapp-btn').addEventListener('click', () => copyToClipboard($('#whatsapp-output').textContent));
            $('#clear-recipe-btn').addEventListener('click', clearCurrentRecipe);
            $('#load-recipe-btn').addEventListener('click', () => {
                const selected = $('#saved-recipes-select').selectedOptions[0];
                if (selected && selected.value) loadRecipe(selected.value, selected.dataset.source);
                else showToast('Selecione uma receita.');
            });
            $('#delete-recipe-btn').addEventListener('click', () => $('#saved-recipes-select').value ? deleteRecipe($('#saved-recipes-select').value) : showToast('Selecione uma receita.'));
            $('#tech-name').addEventListener('input', saveTechInfo);
            $('#tech-contact').addEventListener('input', saveTechInfo);
            $('#open-consolidate-modal-btn').addEventListener('click', openConsolidateModal);
            $('#close-consolidate-modal-btn').addEventListener('click', () => toggleModal(false));
            $('#consolidate-modal').addEventListener('click', (e) => e.target === $('#consolidate-modal') && toggleModal(false));
            $('#consolidate-copy-btn').addEventListener('click', consolidateCopy);
            $('#consolidate-pdf-btn').addEventListener('click', consolidatePdf);
            $('#consolidate-search').addEventListener('input', (e) => renderConsolidateList(e.target.value));
            $('#recipe-search-input').addEventListener('input', renderSavedRecipes);
            $$('.recipe-source-tabs button').forEach(tab => tab.addEventListener('click', (e) => {
                $$('.recipe-source-tabs button').forEach(t => t.classList.remove('active'));
                e.target.classList.add('active');
                activeRecipeSource = e.target.dataset.source;
                renderSavedRecipes();
            }));

            $('#product-catalog').addEventListener('click', e => e.target.closest('.add-to-cart-btn') && addToRecipe(e.target.closest('.add-to-cart-btn').dataset.sku));
            $('#recipe-cart-list').addEventListener('click', e => e.target.closest('.remove-item-btn') && removeFromRecipe(parseInt(e.target.closest('.remove-item-btn').dataset.index, 10)));

            // --- Inicialização ---
            getBase64Image(LOGO_URL).then(data => logoBase64 = data).catch(console.error);
            loadRecipesFromStorage();
            loadTechInfo();
            initializeData();
            renderCart();
        });
    </script>
</body>
</html>
