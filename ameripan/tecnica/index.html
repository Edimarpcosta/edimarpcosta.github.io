<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ameripan Recipe Studio</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        :root {
            --primary-color: #0054a6;
            --primary-dark: #003c7a;
            --secondary-color: #f4f7fa;
            --text-color: #333;
            --light-text-color: #667;
            --card-bg: #ffffff;
            --shadow: 0 6px 15px rgba(0, 0, 0, 0.07);
            --border-radius: 12px;
            --success-color: #27ae60;
            --danger-color: #c0392b;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        html { scroll-behavior: smooth; }
        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--secondary-color);
            color: var(--text-color);
            line-height: 1.6;
            padding-bottom: 80px; /* Space for bottom nav */
        }

        /* --- Header --- */
        .header {
            background-color: var(--primary-color);
            color: white;
            padding: 1rem 1.5rem;
            text-align: center;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            position: sticky;
            top: 0;
            z-index: 1000;
        }
        .header h1 { font-size: 1.4rem; font-weight: 600; }

        /* --- Main Content & Views --- */
        .main-content { padding: 1.5rem; }
        .view { display: none; }
        .view.active { display: block; animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .section-title {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        /* --- Search & Filter --- */
        .search-box {
            position: sticky;
            top: 70px; /* Header height */
            background: var(--secondary-color);
            padding: 0.5rem 0 1.5rem 0;
            z-index: 900;
        }
        .input-group { position: relative; }
        .input-icon { position: absolute; left: 15px; top: 50%; transform: translateY(-50%); color: var(--light-text-color); }
        .search-input, .filter-select, .text-input {
            width: 100%;
            padding: 0.9rem;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
            font-family: 'Poppins', sans-serif;
        }
        .search-input { padding-left: 45px; }
        .search-input:focus, .filter-select:focus, .text-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(0, 84, 166, 0.1);
        }

        /* --- Product Catalog --- */
        #product-catalog-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 1.25rem;
        }
        .product-card {
            background-color: var(--card-bg);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            transition: transform 0.2s ease;
        }
        .product-card:hover { transform: translateY(-5px); }
        .product-card img { width: 100%; height: 120px; object-fit: cover; background-color: #eee; }
        .product-info { padding: 0.75rem; flex-grow: 1; }
        .product-name { font-size: 0.9rem; font-weight: 500; }
        .product-sku { font-size: 0.75rem; color: var(--light-text-color); }
        .add-to-cart-btn {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 0.7rem;
            width: 100%;
            cursor: pointer;
            font-size: 1.5rem;
            font-weight: bold;
        }
        .add-to-cart-btn:hover { background-color: var(--primary-dark); }

        /* --- Builder (Cart) View --- */
        .builder-card { background: var(--card-bg); border-radius: var(--border-radius); padding: 1.5rem; margin-bottom: 1.5rem; box-shadow: var(--shadow); }
        #builder-list { list-style: none; }
        .builder-item { display: flex; justify-content: space-between; align-items: center; padding: 0.75rem 0; border-bottom: 1px dashed #ddd; }
        .remove-item-btn { background: var(--danger-color); color: white; border: none; border-radius: 50%; width: 30px; height: 30px; font-weight: bold; cursor: pointer; }

        /* --- Recipes View --- */
        .recipe-source-tabs { display: flex; border-bottom: none; margin-bottom: 0; }
        .recipe-source-tabs button { flex-grow: 0; padding: 0.75rem; border: none; background: transparent; font-size: 1rem; font-weight: 500; cursor: pointer; color: var(--light-text-color); border-bottom: 3px solid transparent; }
        .recipe-source-tabs button.active { color: var(--primary-color); border-bottom-color: var(--primary-color); }
        #recipe-list-container { display: grid; gap: 1rem; }
        .recipe-card { background: var(--card-bg); border-radius: var(--border-radius); padding: 1rem; box-shadow: var(--shadow); }
        .recipe-card-header { display: flex; justify-content: space-between; align-items: flex-start; }
        .recipe-card-name { font-weight: 600; font-size: 1.1rem; }
        .recipe-card-ingredients { font-size: 0.8rem; color: var(--light-text-color); margin: 0.5rem 0; }
        .recipe-card-actions { display: flex; gap: 0.5rem; }

        /* --- Bottom Navigation --- */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--card-bg);
            display: flex;
            justify-content: space-around;
            box-shadow: 0 -4px 15px rgba(0,0,0,0.1);
            z-index: 1000;
        }
        .nav-btn {
            background: none;
            border: none;
            flex: 1;
            padding: 0.75rem 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 4px;
            color: var(--light-text-color);
            cursor: pointer;
            font-size: 0.75rem;
            position: relative;
        }
        .nav-btn svg { width: 24px; height: 24px; }
        .nav-btn.active { color: var(--primary-color); }
        .builder-badge {
            position: absolute;
            top: 5px;
            right: 25%;
            background: var(--danger-color);
            color: white;
            font-size: 0.7rem;
            font-weight: 600;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            transform: scale(0);
            transition: transform 0.2s ease;
        }
        .builder-badge.show { transform: scale(1); }

        /* --- General Components --- */
        .btn { padding: 0.9rem; border: none; border-radius: 8px; font-size: 1rem; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 0.5rem; }
        .btn-primary { background-color: var(--primary-color); color: white; }
        .btn-success { background-color: var(--success-color); color: white; }
        .btn-danger { background-color: var(--danger-color); color: white; }
        .btn-secondary { background: #ecf0f1; color: #34495e; }
        .action-buttons { display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; margin-top: 1rem; }
        .builder-actions { display: grid; grid-template-columns: repeat(auto-fit, minmax(130px, 1fr)); gap: 0.75rem; margin-top: 1rem; }

        /* --- Skeleton Loader --- */
        .skeleton { animation: skeleton-loading 1s linear infinite alternate; }
        @keyframes skeleton-loading { from { background-color: #eee; } to { background-color: #e0e0e0; } }
        .skeleton-card { background: white; border-radius: var(--border-radius); box-shadow: var(--shadow); }
        .skeleton-img { height: 120px; border-radius: 12px 12px 0 0; }
        .skeleton-text { height: 20px; margin: 10px; border-radius: 4px; }
        .skeleton-text-sm { height: 15px; width: 70%; margin: 10px; border-radius: 4px; }

        /* --- Modal --- */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 2000; display: none; align-items: center; justify-content: center; }
        .modal-overlay.show { display: flex; }
        .modal-container { background: white; padding: 2rem; border-radius: var(--border-radius); width: 90%; max-width: 600px; max-height: 90vh; display: flex; flex-direction: column; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; }
        .modal-title { font-size: 1.5rem; font-weight: 600; }
        .modal-close-btn { background: none; border: none; font-size: 2rem; cursor: pointer; color: #aaa; }
        .modal-body { flex-grow: 1; overflow-y: auto; margin-bottom: 1.5rem; }
        #consolidate-recipe-list { list-style: none; }
        .consolidate-item { padding: 0.75rem 0.5rem; border-bottom: 1px solid #eee; display: flex; align-items: center; gap: 1rem; }
        .consolidate-item input[type="checkbox"] { width: 20px; height: 20px; }
        .list-header { font-weight: 600; color: var(--primary-color); margin-top: 1rem; padding: 0.5rem; background-color: var(--secondary-color); border-radius: 6px; }
    </style>
</head>
<body>

    <header class="header">
        <h1 id="header-title">Catálogo</h1>
    </header>

    <main class="main-content">
        <!-- View: Catálogo de Produtos -->
        <section id="view-catalog" class="view active">
            <div class="search-box">
                <div class="input-group" style="margin-bottom: 1rem;">
                    <span class="input-icon"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg></span>
                    <input type="text" id="product-search-input" class="search-input" placeholder="Buscar por nome ou SKU (use , para E)">
                </div>
                <select id="ramo-filter" class="filter-select"><option value="">Todos os Ramos</option></select>
            </div>
            <div id="product-catalog-grid">
                <!-- Skeletons will be inserted here -->
            </div>
        </section>

        <!-- View: Montador de Receita -->
        <section id="view-builder" class="view">
            <div class="builder-card">
                <h2 class="section-title">Montar Receita</h2>
                <div style="display: flex; flex-direction: column; gap: 1rem;">
                    <input type="text" id="client-name" class="text-input" placeholder="Nome do Cliente (opcional)">
                    <input type="text" id="recipe-name" class="text-input" placeholder="Nome da Receita">
                    <textarea id="recipe-notes" class="text-input" rows="3" placeholder="Observações (opcional)"></textarea>
                </div>
            </div>
            <div class="builder-card">
                <h3 style="font-weight: 600; margin-bottom: 1rem;">Ingredientes</h3>
                <ul id="builder-list"><li>Nenhum item adicionado.</li></ul>
            </div>
             <div class="builder-actions">
                <button id="save-recipe-btn" class="btn btn-success">Salvar</button>
                <button id="copy-current-recipe-btn" class="btn btn-primary">Copiar</button>
                <button id="export-current-pdf-btn" class="btn btn-secondary">Compartilhar PDF</button>
                <button id="clear-recipe-btn" class="btn btn-danger">Limpar</button>
            </div>
        </section>

        <!-- View: Receitas Salvas -->
        <section id="view-recipes" class="view">
            <div class="search-box">
                <div style="display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #eee;">
                    <div class="recipe-source-tabs">
                        <button id="tab-local" class="active" data-source="local">Locais</button>
                        <button id="tab-sheet" data-source="sheet">Planilha</button>
                    </div>
                    <a id="edit-sheet-link" href="#" target="_blank" title="Editar planilha de receitas" style="display: none; color: var(--primary-color); padding: 0.5rem;">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path></svg>
                    </a>
                </div>
                <div class="input-group" style="margin-top: 1rem;">
                    <span class="input-icon"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg></span>
                    <input type="text" id="recipe-search-input" class="search-input" placeholder="Buscar receita ou ingrediente...">
                </div>
            </div>
            <div id="recipe-list-container" style="margin-top: 1rem;"></div>
            <button id="open-consolidate-modal-btn" class="btn btn-primary" style="width: 100%; margin-top: 1.5rem;">Consolidar Receitas</button>
        </section>

        <!-- View: Perfil -->
        <section id="view-profile" class="view">
            <div class="builder-card">
                <h2 class="section-title">Perfil da Técnica</h2>
                <div style="display: flex; flex-direction: column; gap: 1rem;">
                    <input type="text" id="tech-name" class="text-input" placeholder="Seu Nome">
                    <input type="text" id="tech-contact" class="text-input" placeholder="Seu Contato (Telefone/Email)">
                </div>
                 <p style="font-size: 0.8rem; color: var(--light-text-color); margin-top: 1rem;">Suas informações são salvas automaticamente neste navegador.</p>
            </div>
        </section>
    </main>

    <nav class="bottom-nav">
        <button class="nav-btn active" data-view="catalog">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><line x1="3" y1="9" x2="21" y2="9"></line><line x1="9" y1="21" x2="9" y2="9"></line></svg>
            <span>Catálogo</span>
        </button>
        <button class="nav-btn" data-view="builder">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4z"></path><line x1="3" y1="6" x2="21" y2="6"></line><path d="M16 10a4 4 0 0 1-8 0"></path></svg>
            <span>Montador</span>
            <span id="builder-badge" class="builder-badge">0</span>
        </button>
        <button class="nav-btn" data-view="recipes">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"></path></svg>
            <span>Receitas</span>
        </button>
        <button class="nav-btn" data-view="profile">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
            <span>Perfil</span>
        </button>
    </nav>

    <div id="consolidate-modal" class="modal-overlay">
        <div class="modal-container">
            <div class="modal-header">
                <h2 class="modal-title">Consolidar Receitas</h2>
                <button class="modal-close-btn">&times;</button>
            </div>
            <div class="modal-body">
                <div class="input-group">
                   <input type="text" id="consolidate-search" class="search-input" placeholder="Buscar receita..." style="margin-bottom: 1rem;">
                </div>
                <input type="text" id="consolidate-client-name" class="text-input" placeholder="Nome do Cliente (Opcional)" style="margin-bottom: 1rem;">
                <ul id="consolidate-recipe-list"></ul>
            </div>
            <div class="action-buttons">
                <button id="consolidate-copy-btn" class="btn btn-secondary">Copiar Texto</button>
                <button id="consolidate-pdf-btn" class="btn btn-primary">Compartilhar PDF</button>
            </div>
        </div>
    </div>
    <div id="toast" class="toast"></div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const { jsPDF } = window.jspdf;
            
            // --- State Management ---
            const state = {
                products: [],
                localRecipes: [],
                sheetRecipes: [],
                currentRecipe: { name: '', items: [], notes: '' },
                techInfo: { name: '', contact: '' },
                activeView: 'catalog',
                activeRecipeSource: 'local',
                logoBase64: null,
            };

            // --- Constants & API ---
            const API_KEY = 'AIzaSyChiZPUY-G3oyZN2NGY_vlgRXUzry9Pkeo';
            const SPREADSHEET_ID = '1cN_1GBR29BN77eRZAkzvikt96i_kX9AZ04cTc6XRM8Q';
            const API_URL_PRODUCTS = `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/prod-img?key=${API_KEY}`;
            const API_URL_RECIPES = `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/receitas!A2:R?key=${API_KEY}`;
            const LOGO_URL = 'https://edimarpcosta.github.io/ameripan/retirada/logo.webp';
            const SHEET_EDIT_URL = `https://docs.google.com/spreadsheets/d/${SPREADSHEET_ID}/edit`;

            // --- DOM Selectors ---
            const $ = (selector) => document.querySelector(selector);
            const $$ = (selector) => document.querySelectorAll(selector);

            // --- Utility Functions ---
            const normalizeText = (text = '') => text.toString().toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
            const showToast = (message) => {
                $('#toast').textContent = message;
                $('#toast').classList.add('show');
                setTimeout(() => $('#toast').classList.remove('show'), 3000);
            };
            const getBase64Image = (url) => new Promise((resolve, reject) => {
                const img = new Image();
                img.crossOrigin = 'Anonymous';
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    canvas.width = img.width; canvas.height = img.height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0);
                    resolve(canvas.toDataURL('image/png'));
                };
                img.onerror = reject;
                img.src = url;
            });

            // --- View & UI Rendering ---
            function switchView(viewId) {
                state.activeView = viewId;
                $$('.view').forEach(v => v.classList.remove('active'));
                $(`#view-${viewId}`).classList.add('active');
                $$('.nav-btn').forEach(b => b.classList.toggle('active', b.dataset.view === viewId));
                $('#header-title').textContent = $$(`.nav-btn[data-view=${viewId}] span`)[0].textContent;
            }

            function renderSkeletons(count) {
                const grid = $('#product-catalog-grid');
                grid.innerHTML = '';
                for (let i = 0; i < count; i++) {
                    grid.innerHTML += `
                        <div class="skeleton-card">
                            <div class="skeleton skeleton-img"></div>
                            <div class="skeleton skeleton-text"></div>
                            <div class="skeleton skeleton-text-sm"></div>
                        </div>`;
                }
            }

            function renderCatalog() {
                const grid = $('#product-catalog-grid');
                const searchTerms = normalizeText($('#product-search-input').value).split(',').map(t => t.trim()).filter(Boolean);
                const selectedRamo = $('#ramo-filter').value;
                const filtered = state.products.filter(p => {
                    const normalizedProductText = normalizeText(p.produto + ' ' + p.sku);
                    const matchesSearch = searchTerms.length === 0 || searchTerms.every(term => normalizedProductText.includes(term));
                    const matchesRamo = !selectedRamo || p.ramo === selectedRamo;
                    return matchesSearch && matchesRamo;
                });
                
                grid.innerHTML = filtered.length === 0 ? '<p>Nenhum produto encontrado.</p>' : '';
                filtered.forEach(p => {
                    const card = document.createElement('div');
                    card.className = 'product-card';
                    card.innerHTML = `<img src="${p.img}" alt="${p.produto}" onerror="this.src='https://placehold.co/300x240/eee/ccc?text=Sem+Imagem'"><div class="product-info"><p class="product-name">${p.produto}</p><span class="product-sku">SKU: ${p.sku}</span></div><button class="add-to-cart-btn" data-sku="${p.sku}">+</button>`;
                    grid.appendChild(card);
                });
            }

            function renderBuilder() {
                const list = $('#builder-list');
                $('#recipe-name').value = state.currentRecipe.name;
                $('#recipe-notes').value = state.currentRecipe.notes;
                
                list.innerHTML = state.currentRecipe.items.length === 0 ? '<li>Nenhum item adicionado.</li>' : '';
                state.currentRecipe.items.forEach((item, index) => {
                    const li = document.createElement('li');
                    li.className = 'builder-item';
                    li.innerHTML = `<span>${item.produto}</span><button class="remove-item-btn" data-index="${index}">-</button>`;
                    list.appendChild(li);
                });

                const badge = $('#builder-badge');
                const count = state.currentRecipe.items.length;
                badge.textContent = count;
                badge.classList.toggle('show', count > 0);
            }

            function renderRecipeList() {
                const container = $('#recipe-list-container');
                const source = state.activeRecipeSource;
                const searchTerm = normalizeText($('#recipe-search-input').value);
                const recipeList = source === 'local' ? state.localRecipes : state.sheetRecipes;

                const filtered = recipeList.filter(r => normalizeText(r.name).includes(searchTerm) || r.items.some(i => normalizeText(i.produto).includes(searchTerm)));
                
                container.innerHTML = filtered.length === 0 ? `<p>Nenhuma receita encontrada.</p>` : '';
                filtered.forEach(recipe => {
                    const card = document.createElement('div');
                    card.className = 'recipe-card';
                    const ingredientsPreview = recipe.items.slice(0, 3).map(i => i.produto).join(', ') + (recipe.items.length > 3 ? '...' : '');
                    card.innerHTML = `
                        <div class="recipe-card-header">
                            <span class="recipe-card-name">${recipe.name}</span>
                            <div class="recipe-card-actions">
                                <button class="btn btn-primary btn-sm load-recipe-btn" data-id="${recipe.id}" data-source="${source}">Carregar</button>
                                ${source === 'local' ? `<button class="btn btn-danger btn-sm delete-recipe-btn" data-id="${recipe.id}">Excluir</button>` : ''}
                            </div>
                        </div>
                        <p class="recipe-card-ingredients">${ingredientsPreview}</p>`;
                    container.appendChild(card);
                });
            }

            // --- Data Fetching & Handling ---
            async function initializeApp() {
                renderSkeletons(12);
                loadFromLocalStorage();
                renderBuilder();
                $('#edit-sheet-link').href = SHEET_EDIT_URL;
                try {
                    await getBase64Image(LOGO_URL).then(data => state.logoBase64 = data);
                    await fetchProducts();
                    await fetchSheetRecipes();
                } catch (error) {
                    console.error("Initialization failed:", error);
                    showToast("Erro ao carregar dados.");
                }
            }

            async function fetchProducts() {
                const response = await fetch(API_URL_PRODUCTS);
                if (!response.ok) throw new Error(`API Error: ${response.statusText}`);
                const data = await response.json();
                const [headers, ...rows] = data.values;
                state.products = rows.map(row => Object.fromEntries(headers.map((h, i) => [h.toLowerCase(), row[i] || '']))).filter(p => p.sku && p.produto);
                const ramos = [...new Set(state.products.map(p => p.ramo).filter(Boolean))].sort();
                ramos.forEach(ramo => $('#ramo-filter').appendChild(Object.assign(document.createElement('option'), { value: ramo, textContent: ramo })));
                renderCatalog();
            }

            async function fetchSheetRecipes() {
                try {
                    const response = await fetch(API_URL_RECIPES);
                    if (!response.ok) return;
                    const data = await response.json();
                    if (!data.values) return;
                    state.sheetRecipes = data.values.map((row, index) => {
                        const name = row[0];
                        if (!name) return null;
                        const items = row.slice(1).map(ing => {
                            if (!ing) return null;
                            const sku = (ing.match(/\d+/) || [])[0];
                            return state.products.find(p => p.sku === sku);
                        }).filter(Boolean);
                        return { id: `sheet-${index}`, name, items, notes: '' };
                    }).filter(Boolean);
                    renderRecipeList();
                } catch (e) {
                    console.warn("Could not fetch sheet recipes.");
                }
            }

            // --- Local Storage ---
            function loadFromLocalStorage() {
                state.localRecipes = JSON.parse(localStorage.getItem('ameripan_recipes') || '[]');
                const techInfo = JSON.parse(localStorage.getItem('ameripan_tech_info') || '{}');
                state.techInfo = { name: techInfo.name || '', contact: techInfo.contact || '' };
                $('#tech-name').value = state.techInfo.name;
                $('#tech-contact').value = state.techInfo.contact;
            }
            function saveLocalRecipes() {
                localStorage.setItem('ameripan_recipes', JSON.stringify(state.localRecipes));
            }
            function saveTechInfo() {
                state.techInfo = { name: $('#tech-name').value, contact: $('#tech-contact').value };
                localStorage.setItem('ameripan_tech_info', JSON.stringify(state.techInfo));
            }

            // --- Actions ---
            function addToRecipe(sku) {
                const product = state.products.find(p => p.sku === sku);
                if(product) {
                    state.currentRecipe.items.push(product);
                    renderBuilder();
                    showToast(`${product.produto} adicionado.`);
                }
            }

            function removeFromRecipe(index) {
                const removed = state.currentRecipe.items.splice(index, 1);
                renderBuilder();
                showToast(`${removed[0].produto} removido.`);
            }

            function saveCurrentRecipe() {
                const name = $('#recipe-name').value.trim();
                if (!name) { showToast('Dê um nome para a receita.'); return; }
                if (state.currentRecipe.items.length === 0) { showToast('Adicione ingredientes.'); return; }

                state.currentRecipe.name = name;
                state.currentRecipe.notes = $('#recipe-notes').value.trim();
                
                const existingIndex = state.localRecipes.findIndex(r => r.name.toLowerCase() === name.toLowerCase());
                if (existingIndex > -1) {
                    if (!confirm(`Receita "${name}" já existe. Sobrescrever?`)) return;
                    state.localRecipes[existingIndex] = { ...state.currentRecipe, id: state.localRecipes[existingIndex].id };
                } else {
                    state.localRecipes.push({ ...state.currentRecipe, id: Date.now().toString() });
                }
                saveLocalRecipes();
                showToast(`Receita "${name}" salva!`);
                renderRecipeList();
            }

            function clearCurrentRecipe() {
                if(confirm('Limpar a receita atual?')) {
                    state.currentRecipe = { name: '', items: [], notes: '' };
                    $('#client-name').value = '';
                    renderBuilder();
                }
            }
            
            function loadRecipe(id, source) {
                const list = source === 'local' ? state.localRecipes : state.sheetRecipes;
                const recipe = list.find(r => r.id === id);
                if(recipe) {
                    state.currentRecipe = JSON.parse(JSON.stringify(recipe));
                    $('#client-name').value = ''; // Clear client name when loading
                    renderBuilder();
                    switchView('builder');
                    showToast(`Receita "${recipe.name}" carregada.`);
                }
            }

            function deleteRecipe(id) {
                const recipe = state.localRecipes.find(r => r.id === id);
                if(recipe && confirm(`Excluir a receita "${recipe.name}"?`)) {
                    state.localRecipes = state.localRecipes.filter(r => r.id !== id);
                    saveLocalRecipes();
                    renderRecipeList();
                    showToast('Receita excluída.');
                }
            }
            
            function formatRecipeForText(recipe) {
                const recipeName = recipe.name || "Nova Receita";
                let text = `🍨 *${recipeName}*\n`;
                text += recipe.items.length > 0 ? recipe.items.map(item => `${item.sku} - ${item.produto}`).join('\n-----------------------------------\n') : "Nenhum ingrediente adicionado.";
                if (recipe.notes) text += `\n\n*Observações:*\n${recipe.notes}`;
                return text;
            }

            function copyToClipboard(text) {
                navigator.clipboard.writeText(text).then(() => showToast('Copiado!'), () => showToast('Erro ao copiar.'));
            }

            async function generateAndSharePdf(recipes, docTitle, clientName) {
                if (recipes.length === 0 || (recipes.length === 1 && recipes[0].items.length === 0)) {
                    showToast('Adicione ingredientes para gerar o PDF.');
                    return;
                }
                showToast('Gerando PDF...');
                const doc = new jsPDF();
                let pageNumber = 1, pageHeight = doc.internal.pageSize.height;

                const addHeader = () => {
                    if (state.logoBase64) doc.addImage(state.logoBase64, 'PNG', 15, 8, 40, 10);
                    doc.setDrawColor(0, 84, 166); doc.setLineWidth(0.5); doc.line(15, 22, 195, 22);
                };
                const addFooter = () => {
                    doc.setFontSize(9); doc.setTextColor(150);
                    const contactText = `${state.techInfo.name} | ${state.techInfo.contact}`;
                    doc.text(contactText, 15, pageHeight - 10);
                    doc.text(`Página ${pageNumber}`, 195, pageHeight - 10, { align: 'right' });

                    const phone = state.techInfo.contact.replace(/\D/g, '');
                    if (phone) {
                        const whatsappLink = `https://wa.me/55${phone}`;
                        const textWidth = doc.getTextWidth(contactText);
                        doc.link(15, pageHeight - 14, textWidth, 5, { url: whatsappLink });
                    }
                };
                
                addHeader(); addFooter();
                let y = 40;
                doc.setFont('helvetica', 'bold'); doc.setFontSize(20); doc.setTextColor(51, 51, 51);
                doc.text(docTitle, 105, y, { align: 'center' });
                y += 10;
                
                if (clientName) {
                    doc.setFont('helvetica', 'normal');
                    doc.setFontSize(12);
                    doc.setTextColor(102, 102, 102);
                    doc.text(`Preparado para: ${clientName}`, 105, y, { align: 'center' });
                    y += 10;
                }

                for (const recipe of recipes) {
                    const neededHeight = 10 + (recipe.items.length * 7) + (recipe.notes ? 15 : 0);
                    if (y + neededHeight > pageHeight - 20) {
                        doc.addPage(); pageNumber++; y = 30; addHeader(); addFooter();
                    }
                    doc.setFont('helvetica', 'bold'); doc.setFontSize(14); doc.setTextColor(0, 84, 166);
                    doc.text(recipe.name, 15, y); y += 10;
                    doc.setFont('helvetica', 'normal'); doc.setFontSize(11); doc.setTextColor(51, 51, 51);
                    recipe.items.forEach(item => {
                        if (y > pageHeight - 20) { doc.addPage(); pageNumber++; y = 30; addHeader(); addFooter(); }
                        doc.text(`${item.sku} - ${item.produto}`, 20, y); y += 7;
                    });
                    if (recipe.notes) {
                        if (y > pageHeight - 30) { doc.addPage(); pageNumber++; y = 30; addHeader(); addFooter(); }
                        doc.setFont('helvetica', 'bolditalic'); doc.setFontSize(10); doc.text('Observações:', 20, y); y += 5;
                        doc.setFont('helvetica', 'normal');
                        const splitNotes = doc.splitTextToSize(recipe.notes, 170);
                        doc.text(splitNotes, 20, y); y += (splitNotes.length * 5);
                    }
                    y += 10;
                }
                
                // --- Sharing Logic ---
                let fileName = docTitle.replace(/ /g, '_').replace(/"/g, '');
                
                const pdfBlob = doc.output('blob');
                const pdfFile = new File([pdfBlob], `${fileName}.pdf`, { type: 'application/pdf' });
                
                if (navigator.canShare && navigator.canShare({ files: [pdfFile] })) {
                    try {
                        await navigator.share({
                            files: [pdfFile],
                            title: docTitle,
                            text: `Confira as receitas da Ameripan: ${docTitle}`,
                        });
                        showToast('PDF compartilhado!');
                    } catch (error) {
                        if (error.name !== 'AbortError') {
                            showToast('Erro ao compartilhar.');
                        }
                    }
                } else {
                    doc.save(`${fileName}.pdf`);
                    showToast('PDF baixado. Compartilhamento não suportado.');
                }
            }


            // --- Event Listeners ---
            $$('.nav-btn').forEach(btn => btn.addEventListener('click', () => switchView(btn.dataset.view)));
            $('#product-search-input').addEventListener('input', renderCatalog);
            $('#ramo-filter').addEventListener('change', renderCatalog);
            $('#product-catalog-grid').addEventListener('click', e => {
                const btn = e.target.closest('.add-to-cart-btn');
                if (btn) addToRecipe(btn.dataset.sku);
            });
            $('#builder-list').addEventListener('click', e => {
                const btn = e.target.closest('.remove-item-btn');
                if (btn) removeFromRecipe(parseInt(btn.dataset.index, 10));
            });
            $('#save-recipe-btn').addEventListener('click', saveCurrentRecipe);
            $('#clear-recipe-btn').addEventListener('click', clearCurrentRecipe);
            $('#copy-current-recipe-btn').addEventListener('click', () => {
                const clientName = $('#client-name').value.trim();
                let fullText = "Ameripan - Ingredientes\n";
                if (clientName) fullText += `Cliente: ${clientName}\n`;
                fullText += "---\n";
                fullText += formatRecipeForText(state.currentRecipe);
                copyToClipboard(fullText);
            });
            $('#export-current-pdf-btn').addEventListener('click', () => {
                const recipeName = $('#recipe-name').value.trim() || 'Receita Atual';
                const clientName = $('#client-name').value.trim();
                let docTitle = clientName ? `Ingredientes - Receita "${clientName}"` : recipeName;
                generateAndSharePdf([state.currentRecipe], docTitle, clientName);
            });

            $('#tech-name').addEventListener('input', saveTechInfo);
            $('#tech-contact').addEventListener('input', saveTechInfo);
            $$('.recipe-source-tabs button').forEach(tab => tab.addEventListener('click', e => {
                $$('.recipe-source-tabs button').forEach(t => t.classList.remove('active'));
                e.target.classList.add('active');
                state.activeRecipeSource = e.target.dataset.source;
                $('#edit-sheet-link').style.display = state.activeRecipeSource === 'sheet' ? 'block' : 'none';
                renderRecipeList();
            }));
            $('#recipe-search-input').addEventListener('input', renderRecipeList);
            $('#recipe-list-container').addEventListener('click', e => {
                const loadBtn = e.target.closest('.load-recipe-btn');
                if(loadBtn) loadRecipe(loadBtn.dataset.id, loadBtn.dataset.source);
                const deleteBtn = e.target.closest('.delete-recipe-btn');
                if(deleteBtn) deleteRecipe(deleteBtn.dataset.id);
            });
            
            // Consolidate Modal
            $('#open-consolidate-modal-btn').addEventListener('click', () => {
                $('#consolidate-client-name').value = ''; // Clear fields on open
                renderConsolidateList();
                $('#consolidate-modal').classList.add('show');
            });
            $('.modal-close-btn').addEventListener('click', () => $('#consolidate-modal').classList.remove('show'));
            $('#consolidate-modal').addEventListener('click', (e) => {
                if (e.target.classList.contains('modal-overlay')) {
                    $('#consolidate-modal').classList.remove('show');
                }
            });
            $('#consolidate-search').addEventListener('input', e => renderConsolidateList(e.target.value));
            
            $('#consolidate-copy-btn').addEventListener('click', () => {
                const selected = getSelectedConsolidateRecipes();
                if (selected.length === 0) {
                    showToast('Selecione ao menos uma receita.');
                    return;
                }
                const clientName = $('#consolidate-client-name').value.trim();
                let fullText = "Ameripan - Ingredientes\n";
                if (clientName) fullText += `Cliente: ${clientName}\n`;
                fullText += "---\n";
                fullText += selected.map(recipe => formatRecipeForText(recipe)).join('\n===================================\n');
                copyToClipboard(fullText);
                $('#consolidate-modal').classList.remove('show');
            });
            $('#consolidate-pdf-btn').addEventListener('click', () => {
                const selected = getSelectedConsolidateRecipes();
                const clientName = $('#consolidate-client-name').value.trim();
                let docTitle = clientName ? `Ingredientes - Receita "${clientName}"` : 'Receitas Consolidadas';
                
                if(selected.length > 0) {
                    generateAndSharePdf(selected, docTitle, clientName);
                    $('#consolidate-modal').classList.remove('show');
                } else {
                    showToast('Selecione ao menos uma receita.');
                }
            });

            function getSelectedConsolidateRecipes() {
                 return [...$$('#consolidate-recipe-list input:checked')].map(cb => {
                    const list = cb.dataset.source === 'local' ? state.localRecipes : state.sheetRecipes;
                    return list.find(r => r.id === cb.dataset.id);
                });
            }

            function renderConsolidateList(searchTerm = '') {
                const list = $('#consolidate-recipe-list');
                list.innerHTML = '';
                const normalizedSearch = normalizeText(searchTerm);
                const renderList = (recipes, title, source) => {
                    const filtered = recipes.filter(r => normalizeText(r.name).includes(normalizedSearch) || r.items.some(i => normalizeText(i.produto).includes(normalizedSearch)));
                    if (filtered.length === 0) return;
                    list.insertAdjacentHTML('beforeend', `<li class="list-header">${title}</li>`);
                    filtered.forEach(recipe => {
                        list.insertAdjacentHTML('beforeend', `<li class="consolidate-item"><input type="checkbox" id="modal-recipe-${recipe.id}" data-id="${recipe.id}" data-source="${source}"><label for="modal-recipe-${recipe.id}">${recipe.name}</label></li>`);
                    });
                };
                renderList(state.localRecipes, 'Receitas Locais', 'local');
                renderList(state.sheetRecipes, 'Receitas da Planilha', 'sheet');
            }


            // --- App Initialization ---
            initializeApp();
        });
    </script>
</body>
</html>
