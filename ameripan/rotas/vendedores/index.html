<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ameripan Rotas</title>
  
  <script src="https://unpkg.com/@phosphor-icons/web"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
  
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@unocss/reset/tailwind.min.css">
  <script src="https://cdn.jsdelivr.net/npm/@unocss/runtime"></script>

  <style>
    body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
    .hidden { display: none !important; }
    
    /* Botões Coloridos Fixos */
    .btn-amber { background-color: #f59e0b !important; color: white !important; }
    .btn-blue { background-color: #2563eb !important; color: white !important; }
    .btn-green { background-color: #16a34a !important; color: white !important; }

    /* Checkbox e Radios Personalizados */
    .btn-check:checked + label { background-color: #2563eb; color: white; border-color: #2563eb; }
    .btn-check-sec:checked + label { background-color: #059669; color: white; border-color: #059669; }
    .btn-check-week:checked + label { background-color: #7c3aed; color: white; border-color: #7c3aed; } /* Roxo para semanas */

    .input-editable { background-color: #ffffff; border: 1px solid #e5e7eb; border-radius: 0.25rem; padding: 0.25rem 0.5rem; }
    
    [un-cloak] { display: none; }
  </style>
</head>
<body class="pb-24" un-cloak>

  <div id="loadingBar" class="bg-yellow-100 text-yellow-800 text-xs font-bold text-center p-1 border-b border-yellow-200">
    Carregando sistema...
  </div>

  <div class="bg-blue-800 text-white p-3 shadow-md sticky top-0 z-40">
    <h1 class="text-base font-bold flex items-center gap-2"><i class="ph ph-path text-xl"></i> Ameripan Rotas</h1>
    <div class="flex justify-between items-end"><p class="text-[10px] text-blue-200">Sistema v5 (A-O)</p><span id="contadorTopo" class="bg-orange-500 text-white text-[10px] font-bold px-2 py-0.5 rounded-full hidden">0</span></div>
  </div>

  <div class="max-w-md mx-auto p-3">
    <form id="rotaForm" onsubmit="return false;">
      
      <div class="bg-white p-3 rounded shadow-sm mb-3 border-l-4 border-blue-500">
        <div class="flex gap-2 relative mb-1">
          <div class="relative w-20">
            <input type="number" id="codVendedor" class="w-full p-1.5 border rounded text-sm bg-gray-50 focus:ring-1 focus:ring-blue-500 outline-none" placeholder="Cód" oninput="buscarVendedorLocal()">
          </div>
          <input type="text" id="nomeVendedor" class="flex-1 p-1.5 border rounded text-sm bg-white text-gray-700 font-medium outline-none" placeholder="Nome Vendedor" readonly>
        </div>
        <div class="flex items-center gap-2 bg-blue-50 p-1.5 rounded border border-blue-100">
           <span class="text-[10px] text-blue-600 font-bold uppercase">Equipe:</span>
           <input type="text" id="equipeVendedor" class="bg-transparent text-xs font-semibold text-blue-800 w-full outline-none" placeholder="..." readonly>
        </div>
        <div id="msgVendedor" class="text-[10px] mt-1 min-h-[1rem]"></div>
      </div>

      <div class="bg-white p-3 rounded shadow-sm mb-3 border-l-4 border-orange-500">
        <div class="flex gap-2 relative">
          <input type="number" id="codCliente" class="w-full p-2 border rounded bg-white focus:ring-1 focus:ring-orange-500 outline-none pl-8 text-base font-bold" placeholder="Cód Cliente..." oninput="buscarClienteLocal()">
          <i class="ph ph-magnifying-glass absolute left-2.5 top-3 text-gray-400 text-lg"></i>
          <button type="button" onclick="limparCliente()" class="bg-gray-200 text-gray-600 px-3 rounded hover:bg-gray-300"><i class="ph ph-eraser"></i></button>
        </div>
        <div id="msgCliente" class="text-[10px] mt-1 h-4 font-bold text-blue-600"></div>
        
        <div class="mt-2 grid grid-cols-1 gap-1 bg-orange-50 p-2 rounded border border-orange-100">
          <div><span class="text-[10px] text-gray-500 uppercase font-bold">Razão Social</span><input type="text" id="razaoSocial" class="input-editable w-full font-bold text-gray-800 text-xs" placeholder="..."></div>
          <div><span class="text-[10px] text-gray-500 uppercase font-bold">Fantasia</span><input type="text" id="nomeFantasia" class="input-editable w-full text-gray-600 text-[10px]" placeholder="..."></div>
          <div><span class="text-[10px] text-gray-500 uppercase font-bold">Cidade</span><input type="text" id="cidade" class="input-editable w-full text-gray-600 text-[10px]" placeholder="..."></div>
        </div>
      </div>

      <div class="bg-white p-3 rounded shadow-sm mb-3">
        
        <div class="mb-3">
            <div class="flex justify-between items-center mb-1">
                <label class="text-xs font-bold text-gray-700 uppercase">Ordem Rota</label>
                <input type="number" id="ordemManual" class="w-12 p-0.5 border rounded text-center text-xs font-bold text-blue-600" placeholder="#" oninput="sincronizarOrdem(this.value)">
            </div>
            <div class="grid grid-cols-10 gap-1">
                <script>for(let i=1; i<=20; i++) document.write(`<input type="radio" name="ordemVisita" id="ordem_${i}" value="${i}" class="hidden btn-check" onclick="document.getElementById('ordemManual').value=this.value; salvarEstadoFormulario();"><label for="ordem_${i}" class="cursor-pointer text-center text-[10px] py-1 rounded border border-gray-200 text-gray-600 font-bold hover:bg-blue-50">${i}</label>`);</script>
            </div>
        </div>

        <hr class="border-gray-100 my-3">

        <div class="mb-3">
            <label class="block text-xs font-bold text-gray-700 uppercase mb-1">Frequência</label>
            <div class="flex gap-1">
                <div class="flex-1">
                    <input type="checkbox" id="sem_todas" value="Toda Semana" class="hidden btn-check-week" onchange="toggleSemana('todas')">
                    <label for="sem_todas" class="block cursor-pointer text-center text-[10px] py-1.5 rounded border border-gray-200 font-bold">TODA SEMANA</label>
                </div>
                <script>
                    const semanas = [
                        {id:'s1', l:'S1', d:'(1-7)'}, {id:'s2', l:'S2', d:'(8-14)'}, 
                        {id:'s3', l:'S3', d:'(15-21)'}, {id:'s4', l:'S4', d:'(22-30)'}
                    ];
                    semanas.forEach(s => {
                        document.write(`
                        <div class="flex-1">
                            <input type="checkbox" name="semanaEspecifica" id="sem_${s.id}" value="${s.l}" class="hidden btn-check-week" onchange="toggleSemana('${s.id}')">
                            <label for="sem_${s.id}" class="block cursor-pointer text-center text-[10px] py-1.5 rounded border border-gray-200 font-bold" title="Dia ${s.d}">${s.l}</label>
                        </div>`);
                    });
                </script>
            </div>
        </div>

        <hr class="border-gray-100 my-3">

        <div class="grid grid-cols-2 gap-3">
            <div>
                <label class="block text-xs font-bold text-gray-700 uppercase mb-1">Dia Visita (Princ.)</label>
                <div class="grid grid-cols-3 gap-1">
                    <script> ['SEG','TER','QUA','QUI','SEX','SAB'].forEach(d => document.write(`<input type="radio" name="diaPrincipal" id="dia_${d}" value="${d}" class="hidden btn-check" onclick="salvarEstadoFormulario()"><label for="dia_${d}" class="cursor-pointer text-center text-[10px] py-1 rounded border border-gray-200 font-semibold">${d}</label>`)); </script>
                </div>
            </div>
            <div>
                <label class="block text-xs font-bold text-gray-400 uppercase mb-1">Outros Dias</label>
                <div class="grid grid-cols-3 gap-1">
                    <script> ['SEG','TER','QUA','QUI','SEX','SAB'].forEach(d => document.write(`<input type="checkbox" name="diasSecundarios" id="sec_${d}" value="${d}" class="hidden btn-check-sec" onclick="salvarEstadoFormulario()"><label for="sec_${d}" class="cursor-pointer text-center text-[10px] py-1 rounded border border-gray-200 text-gray-400 font-semibold">${d}</label>`)); </script>
                </div>
            </div>
        </div>
      </div>

      <div class="bg-white p-3 rounded shadow-sm mb-4">
        <div class="grid grid-cols-1 gap-2">
          <div class="flex gap-2">
             <div class="flex-1"><label class="text-[10px] font-bold text-gray-700 uppercase">Comprador</label><input type="text" id="comprador" class="w-full p-1.5 border rounded bg-gray-50 outline-none text-sm" oninput="salvarEstadoFormulario()"></div>
             <div class="w-1/3"><label class="text-[10px] font-bold text-gray-700 uppercase">WhatsApp</label><input type="tel" id="whatsapp" class="w-full p-1.5 border rounded bg-gray-50 outline-none text-sm" placeholder="(00)..." maxlength="15" oninput="salvarEstadoFormulario()"></div>
          </div>
          <div><label class="text-[10px] font-bold text-gray-700 uppercase">Observações</label><textarea id="obs" rows="1" class="w-full p-1.5 border rounded bg-gray-50 outline-none text-xs" oninput="salvarEstadoFormulario()"></textarea></div>
        </div>
      </div>

      <div class="grid grid-cols-2 gap-2 mb-6">
        <button type="button" onclick="incluirNaLista()" class="btn-amber font-bold py-3 rounded shadow flex flex-col items-center justify-center text-sm"><i class="ph ph-plus-circle text-xl"></i> INCLUIR</button>
        <button type="button" onclick="salvarDireto()" class="btn-blue font-bold py-3 rounded shadow flex flex-col items-center justify-center text-sm"><i class="ph ph-floppy-disk text-xl"></i> GRAVAR ESTE</button>
      </div>
    </form>

    <div id="areaLista" class="bg-white rounded shadow-sm border border-gray-200 mb-20 hidden">
      <div class="bg-gray-100 p-2 border-b border-gray-200 flex justify-between items-center"><h3 class="font-bold text-xs text-gray-700">LISTA DE GRAVAÇÃO (MEMÓRIA)</h3><span id="contadorLista" class="bg-blue-600 text-white text-[10px] px-1.5 py-0.5 rounded-full">0</span></div>
      <div id="listaClientesContainer" class="divide-y divide-gray-100"></div>
    </div>
  </div>

  <div id="barraSalvar" class="fixed bottom-0 left-0 w-full bg-white border-t p-3 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.1)] hidden z-50">
    <div class="max-w-md mx-auto">
      <button onclick="salvarLote()" class="w-full btn-green font-bold py-3 rounded shadow-lg flex justify-center items-center gap-2 text-base"><i class="ph ph-paper-plane-right text-xl"></i> ENVIAR TUDO (<span id="btnCount">0</span>)</button>
    </div>
  </div>

  <div id="overlay" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4"><div class="bg-white rounded-lg p-6 w-full max-w-sm text-center shadow-xl"><div id="modalContent"></div></div></div>

  <script>
    // ============================================================
    // CONFIGURAÇÕES
    // ============================================================
    const GAS_API_URL = 'https://script.google.com/macros/s/AKfycbyoOQUbcC4nKdR3qeh2u1q0Wn4eQUD3eJUrby2DG5Nx7xQh1jmH6FSTphqxslWPvktCfQ/exec'; 
    const SPREADSHEET_ID = '1JXdW-RDSrG4or8WzvLBV_PbopVvug9B9og7fSMGOWj0';
    const API_KEY = 'AIzaSyChiZPUY-G3oyZN2NGY_vlgRXUzry9Pkeo';
    const ABA_VENDEDORES = 'VENDEDORES'; const RANGE_VENDEDORES = 'A2:C';
    const ABA_CLIENTES = 'CLIENTES'; const RANGE_CLIENTES = 'A2:C';

    let dbVendedores = []; let dbClientes = []; let listaDeRotas = [];

    window.onload = async function() {
        const s = localStorage.getItem('rotasTemp'); 
        if(s) { listaDeRotas = JSON.parse(s); renderizarLista(); }
        restaurarEstadoFormulario();
        await carregarBasesDeDados();
        restaurarVendedor();
    };

    function toggleSemana(tipo) {
        const chkTodas = document.getElementById('sem_todas');
        const chkEspecificas = document.querySelectorAll('input[name="semanaEspecifica"]');
        if (tipo === 'todas') {
            if (chkTodas.checked) chkEspecificas.forEach(c => c.checked = false);
        } else {
            let algumaMarcada = false;
            chkEspecificas.forEach(c => { if(c.checked) algumaMarcada = true; });
            if (algumaMarcada) chkTodas.checked = false;
        }
        salvarEstadoFormulario();
    }

    function salvarEstadoFormulario() {
        const estado = {
            ordemManual: document.getElementById('ordemManual').value,
            comprador: document.getElementById('comprador').value,
            whatsapp: document.getElementById('whatsapp').value,
            obs: document.getElementById('obs').value,
            semanaTodas: document.getElementById('sem_todas').checked,
            semanasEsp: Array.from(document.querySelectorAll('input[name="semanaEspecifica"]:checked')).map(c => c.id),
            diaPrincipal: document.querySelector('input[name="diaPrincipal"]:checked')?.value || null,
            diasSec: Array.from(document.querySelectorAll('input[name="diasSecundarios"]:checked')).map(c => c.id)
        };
        localStorage.setItem('formEstadoTemp', JSON.stringify(estado));
    }

    function restaurarEstadoFormulario() {
        const salvo = localStorage.getItem('formEstadoTemp');
        if (!salvo) return;
        const estado = JSON.parse(salvo);
        if(estado.ordemManual) { document.getElementById('ordemManual').value = estado.ordemManual; sincronizarOrdem(estado.ordemManual); }
        document.getElementById('comprador').value = estado.comprador || '';
        document.getElementById('whatsapp').value = estado.whatsapp || '';
        document.getElementById('obs').value = estado.obs || '';
        if (estado.semanaTodas) document.getElementById('sem_todas').checked = true;
        if (estado.semanasEsp) estado.semanasEsp.forEach(id => { let el = document.getElementById(id); if(el) el.checked = true; });
        if (estado.diaPrincipal) { const r = document.querySelector(`input[name="diaPrincipal"][value="${estado.diaPrincipal}"]`); if(r) r.checked = true; }
        if (estado.diasSec) estado.diasSec.forEach(id => { let el = document.getElementById(id); if(el) el.checked = true; });
    }

    async function carregarBasesDeDados() {
        const loadingBar = document.getElementById('loadingBar');
        try {
            loadingBar.innerText = "Atualizando tabelas...";
            const [resVendedores, resClientes] = await Promise.all([
                fetch(`https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/${ABA_VENDEDORES}!${RANGE_VENDEDORES}?key=${API_KEY}`),
                fetch(`https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/${ABA_CLIENTES}!${RANGE_CLIENTES}?key=${API_KEY}`)
            ]);
            const jVend = await resVendedores.json(); const jCli = await resClientes.json();
            if (jVend.values) dbVendedores = jVend.values.map(r => ({ codigo: String(r[0]).trim(), nome: r[1], equipe: r[2] }));
            if (jCli.values) dbClientes = jCli.values.map(r => ({ codigo: String(r[0]).trim(), cidade: r[1], razao: r[2], fantasia: r[2] }));
            loadingBar.className = "bg-green-100 text-green-800 text-xs font-bold text-center p-1 border-b border-green-200";
            loadingBar.innerText = `Pronto!`; setTimeout(() => { loadingBar.style.display = 'none'; }, 1500);
        } catch (e) { loadingBar.className = "bg-red-100 text-red-800 text-xs font-bold text-center p-1"; loadingBar.innerText = "Erro Conexão"; }
    }

    function restaurarVendedor() {
        const cod = localStorage.getItem('vendedorCodigo');
        if (cod) { document.getElementById('codVendedor').value = cod; buscarVendedorLocal(); }
    }
    function buscarVendedorLocal() {
        const cod = document.getElementById('codVendedor').value.toString().trim();
        const msg = document.getElementById('msgVendedor');
        if (!cod) { msg.innerHTML = ''; document.getElementById('nomeVendedor').value=''; localStorage.removeItem('vendedorCodigo'); return; }
        const f = dbVendedores.find(v => v.codigo === cod);
        if (f) { document.getElementById('nomeVendedor').value = f.nome; document.getElementById('equipeVendedor').value = f.equipe; msg.innerHTML = '<span class="text-green-600 font-bold">✓ OK</span>'; localStorage.setItem('vendedorCodigo', cod); } 
        else { document.getElementById('nomeVendedor').value = ''; msg.innerHTML = '<span class="text-red-500 text-[10px]">Não achou</span>'; }
    }
    function buscarClienteLocal() {
        const cod = document.getElementById('codCliente').value.toString().trim();
        const msg = document.getElementById('msgCliente');
        if (!cod) { msg.innerHTML = ''; return; }
        const f = dbClientes.find(c => c.codigo === cod);
        if (f) { document.getElementById('nomeFantasia').value = f.fantasia; document.getElementById('razaoSocial').value = f.razao; document.getElementById('cidade').value = f.cidade; msg.innerHTML = '<span class="text-green-600 font-bold">✓ OK</span>'; } 
        else { msg.innerHTML = '<span class="text-red-500 font-bold">Novo?</span>'; }
    }

    function obterDadosDoFormulario() {
      const codV = document.getElementById('codVendedor').value;
      const nomeV = document.getElementById('nomeVendedor').value;
      const equipeV = document.getElementById('equipeVendedor').value;
      const codC = document.getElementById('codCliente').value;
      const nomeC = document.getElementById('nomeFantasia').value;
      
      if(!nomeV || !nomeC) { alert("Preencha Vendedor e Cliente."); return null; }
      
      let ordem = document.getElementById('ordemManual').value;
      if(!ordem) { const r = document.querySelector('input[name="ordemVisita"]:checked'); if(r) ordem = r.value; }
      if(!ordem) { alert("Preencha Ordem."); return null; }

      const diaP = document.querySelector('input[name="diaPrincipal"]:checked');
      if(!diaP) { alert("Selecione Dia Principal."); return null; }

      let frequencia = "Indefinida";
      if (document.getElementById('sem_todas').checked) {
          frequencia = "Toda Semana";
      } else {
          const sems = [];
          document.querySelectorAll('input[name="semanaEspecifica"]:checked').forEach(c => sems.push(c.value));
          if (sems.length > 0) frequencia = sems;
          else { alert("Selecione a Frequência."); return null; }
      }

      const diasS = [];
      document.querySelectorAll('input[name="diasSecundarios"]:checked').forEach(c => diasS.push(c.value));

      return {
        id: Date.now(),
        codVendedor: codV || 'MANUAL', nomeVendedor: nomeV, equipeVendedor: equipeV,
        codCliente: codC || 'MANUAL', nomeFantasia: nomeC,
        razaoSocial: document.getElementById('razaoSocial').value, cidade: document.getElementById('cidade').value,
        ordemVisita: ordem, semanas: frequencia,
        diaPrincipal: diaP.value, diasSecundarios: diasS,
        comprador: document.getElementById('comprador').value, whatsapp: document.getElementById('whatsapp').value, obs: document.getElementById('obs').value
      };
    }

    async function chamarBackendScript(payload) {
      try {
        const r = await fetch(GAS_API_URL, { method: 'POST', headers: { 'Content-Type': 'text/plain;charset=utf-8' }, body: JSON.stringify(payload) });
        return await r.json();
      } catch (error) { return { erro: "Falha conexão." }; }
    }

    async function salvarLote() {
      if(listaDeRotas.length === 0) return;
      mostrarModal('loading', 'Enviando...');
      const res = await chamarBackendScript({ acao: 'SALVAR_LOTE', lista: listaDeRotas });
      if(res.sucesso) { listaDeRotas=[]; salvarLocal(); renderizarLista(); mostrarModal('sucesso', res.mensagem); } 
      else mostrarModal('erro', res.erro);
    }

    async function salvarDireto() {
      const btn = document.querySelector("button[onclick='salvarDireto()']"); if(btn.disabled) return;
      const item = obterDadosDoFormulario(); if(!item) return;
      btn.disabled = true; mostrarModal('loading', 'Salvando...');
      try {
          const res = await chamarBackendScript({ acao: 'SALVAR_LOTE', lista: [item] });
          if(res.sucesso) { limparFormulario(); mostrarModal('sucesso', res.mensagem); } else mostrarModal('erro', res.erro);
      } finally { btn.disabled = false; }
    }

    function incluirNaLista() { const i = obterDadosDoFormulario(); if(i) { listaDeRotas.push(i); salvarLocal(); renderizarLista(); limparFormulario(); } }
    
    function renderizarLista() {
       const c = document.getElementById('listaClientesContainer'); c.innerHTML = '';
       const area = document.getElementById('areaLista'); const btn = document.getElementById('barraSalvar');
       if(listaDeRotas.length===0) { area.classList.add('hidden'); btn.classList.add('hidden'); return; }
       area.classList.remove('hidden'); btn.classList.remove('hidden');
       document.getElementById('contadorLista').innerText = listaDeRotas.length;
       document.getElementById('btnCount').innerText = listaDeRotas.length;
       listaDeRotas.slice().reverse().forEach(item => {
         const freqDisplay = Array.isArray(item.semanas) ? item.semanas.join(',') : item.semanas;
         c.innerHTML += `<div class="p-2 hover:bg-gray-50 transition-colors border-b border-gray-100"><div class="flex justify-between items-start"><div><p class="font-bold text-xs text-gray-800">${item.nomeFantasia}</p><p class="text-[10px] text-gray-500">${item.cidade} • Ord: ${item.ordemVisita} • ${freqDisplay}</p></div><button onclick="excluirItem(${item.id})" class="text-red-400 hover:text-red-600"><i class="ph ph-trash text-lg"></i></button></div></div>`;
       });
    }
    
    function excluirItem(id) { if(confirm('Remover?')) { listaDeRotas = listaDeRotas.filter(i => i.id !== id); salvarLocal(); renderizarLista(); } }
    function salvarLocal() { localStorage.setItem('rotasTemp', JSON.stringify(listaDeRotas)); }
    
    function limparFormulario() {
      document.getElementById('codCliente').value=''; document.getElementById('nomeFantasia').value=''; document.getElementById('razaoSocial').value=''; document.getElementById('cidade').value='';
      localStorage.removeItem('formEstadoTemp'); 
      document.getElementById('comprador').value=''; document.getElementById('whatsapp').value=''; document.getElementById('obs').value=''; document.getElementById('ordemManual').value='';
      document.querySelectorAll('input[type="radio"], input[type="checkbox"]').forEach(e => e.checked = false);
      document.getElementById('msgCliente').innerHTML = ''; document.getElementById('codCliente').focus();
    }
    function limparCliente() { limparFormulario(); }
    function sincronizarOrdem(v) { const r = document.querySelector(`input[name="ordemVisita"][value="${v}"]`); if(r) { r.checked=true; salvarEstadoFormulario(); } }
    function mostrarModal(tipo, msg) {
      const o = document.getElementById('overlay'); const c = document.getElementById('modalContent'); o.classList.remove('hidden');
      if(tipo==='loading') c.innerHTML = `<div class="loader"></div><h3 class="font-bold mt-2 text-sm text-gray-700">${msg}</h3>`;
      else c.innerHTML = `<h3 class="font-bold text-base mb-2 text-gray-800">${tipo==='sucesso'?'Sucesso!':'Erro'}</h3><p class="mb-3 text-xs text-gray-600">${msg}</p><button onclick="document.getElementById('overlay').classList.add('hidden')" class="bg-gray-200 px-4 py-1.5 rounded text-sm font-bold">Fechar</button>`;
    }
    document.getElementById('whatsapp').addEventListener('input', function (e) { let x = e.target.value.replace(/\D/g, '').match(/(\d{0,2})(\d{0,5})(\d{0,4})/); e.target.value = !x[2] ? x[1] : '(' + x[1] + ') ' + x[2] + (x[3] ? '-' + x[3] : ''); });
  </script>
</body>
</html>
