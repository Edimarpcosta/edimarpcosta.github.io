<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ameripan Rotas Mensal</title>
  
  <script src="https://unpkg.com/@phosphor-icons/web"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
  
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@unocss/reset/tailwind.min.css">
  <script src="https://cdn.jsdelivr.net/npm/@unocss/runtime"></script>

  <style>
    body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
    .hidden { display: none !important; }
    
    /* Cores Botões */
    .btn-amber { background-color: #f59e0b !important; color: white !important; }
    .btn-blue { background-color: #2563eb !important; color: white !important; }
    .btn-green { background-color: #16a34a !important; color: white !important; }

    /* Inputs */
    .btn-check:checked + label { background-color: #2563eb; color: white; border-color: #2563eb; }
    .btn-check-sec:checked + label { background-color: #059669; color: white; border-color: #059669; }
    .btn-check-week:checked + label { background-color: #7c3aed; color: white; border-color: #7c3aed; }

    .input-editable { background-color: #ffffff; border: 1px solid #e5e7eb; border-radius: 0.25rem; padding: 0.25rem 0.5rem; }
    
    /* Indicador de Campo Obrigatório (Adicionado via JS) */
    .required-mark::after { content: " *"; color: #ef4444; font-weight: bold; }

    [un-cloak] { display: none; }
  </style>
</head>
<body class="pb-24" un-cloak>

  <div id="loadingBar" class="bg-yellow-100 text-yellow-800 text-xs font-bold text-center p-1 border-b border-yellow-200">
    Carregando regras e dados...
  </div>

  <div class="bg-blue-800 text-white p-3 shadow-md sticky top-0 z-40">
    <h1 class="text-base font-bold flex items-center gap-2"><i class="ph ph-path text-xl"></i> Ameripan Rotas</h1>
    <div class="flex justify-between items-end"><p class="text-[10px] text-blue-200">Visitas para os Mêses</p><span id="contadorTopo" class="bg-orange-500 text-white text-[10px] font-bold px-2 py-0.5 rounded-full hidden">0</span></div>
  </div>

  <div class="max-w-md mx-auto p-3">
    <form id="rotaForm" onsubmit="return false;">
      
      <div class="bg-white p-3 rounded shadow-sm mb-3 border-l-4 border-blue-500">
        <div class="flex justify-between mb-1"><label class="text-xs font-bold text-gray-700" id="lbl_cod_vend">Vendedor</label></div>
        <div class="flex gap-2 relative mb-1">
          <div class="relative w-20">
            <input type="number" id="codVendedor" class="w-full p-1.5 border rounded text-sm bg-gray-50 focus:ring-1 focus:ring-blue-500 outline-none" placeholder="Cód" oninput="buscarVendedorLocal()">
          </div>
          <input type="text" id="nomeVendedor" class="flex-1 p-1.5 border rounded text-sm bg-white text-gray-700 font-medium outline-none" placeholder="Nome" readonly>
        </div>
        <div class="flex items-center gap-2 bg-blue-50 p-1.5 rounded border border-blue-100">
           <span class="text-[10px] text-blue-600 font-bold uppercase">Equipe:</span>
           <input type="text" id="equipeVendedor" class="bg-transparent text-xs font-semibold text-blue-800 w-full outline-none" placeholder="..." readonly>
        </div>
        <div id="msgVendedor" class="text-[10px] mt-1 min-h-[1rem]"></div>
      </div>

      <div class="bg-white p-3 rounded shadow-sm mb-3 border-l-4 border-orange-500">
        <label class="block text-xs font-bold text-gray-700 mb-1" id="lbl_cod_cliente">Cliente</label>
        <div class="flex gap-2 relative">
          <input type="number" id="codCliente" class="w-full p-2 border rounded bg-white focus:ring-1 focus:ring-orange-500 outline-none pl-8 text-base font-bold" placeholder="Cód Cliente..." oninput="buscarClienteLocal()">
          <i class="ph ph-magnifying-glass absolute left-2.5 top-3 text-gray-400 text-lg"></i>
          <button type="button" onclick="limparCliente()" class="bg-gray-200 text-gray-600 px-3 rounded hover:bg-gray-300"><i class="ph ph-eraser"></i></button>
        </div>
        <div id="msgCliente" class="text-[10px] mt-1 h-4 font-bold text-blue-600"></div>
        
        <div class="mt-2 grid grid-cols-1 gap-1 bg-orange-50 p-2 rounded border border-orange-100">
          <div><span class="text-[10px] text-gray-500 uppercase font-bold" id="lbl_razao">Razão Social</span><input type="text" id="razaoSocial" class="input-editable w-full font-bold text-gray-800 text-xs" placeholder="..."></div>
          <div><span class="text-[10px] text-gray-500 uppercase font-bold" id="lbl_fantasia">Fantasia</span><input type="text" id="nomeFantasia" class="input-editable w-full text-gray-600 text-[10px]" placeholder="..."></div>
          <div><span class="text-[10px] text-gray-500 uppercase font-bold" id="lbl_cidade">Cidade</span><input type="text" id="cidade" class="input-editable w-full text-gray-600 text-[10px]" placeholder="..."></div>
        </div>
      </div>

      <div class="bg-white p-3 rounded shadow-sm mb-3">
        
        <div class="mb-3">
            <div class="flex justify-between items-center mb-1">
                <label class="text-xs font-bold text-gray-700 uppercase" id="lbl_ordem">Ordem Rota</label>
                <input type="number" id="ordemManual" class="w-12 p-0.5 border rounded text-center text-xs font-bold text-blue-600" placeholder="#" oninput="sincronizarOrdem(this.value)">
            </div>
            <div class="grid grid-cols-10 gap-1">
                <script>for(let i=1; i<=20; i++) document.write(`<input type="radio" name="ordemVisita" id="ordem_${i}" value="${i}" class="hidden btn-check" onclick="document.getElementById('ordemManual').value=this.value; salvarEstadoFormulario();"><label for="ordem_${i}" class="cursor-pointer text-center text-[10px] py-1 rounded border border-gray-200 text-gray-600 font-bold hover:bg-blue-50">${i}</label>`);</script>
            </div>
        </div>

        <hr class="border-gray-100 my-3">

        <div class="mb-3">
            <label class="block text-xs font-bold text-gray-700 uppercase mb-1" id="lbl_frequencia">Frequência</label>
            <div class="flex gap-1">
                <div class="flex-1">
                    <input type="checkbox" id="sem_todas" value="Toda Semana" class="hidden btn-check-week" onchange="toggleSemana('todas')">
                    <label for="sem_todas" class="block cursor-pointer text-center text-[10px] py-1.5 rounded border border-gray-200 font-bold">TODA SEMANA</label>
                </div>
                <script>
                    const semanas = [{id:'s1', l:'S1'}, {id:'s2', l:'S2'}, {id:'s3', l:'S3'}, {id:'s4', l:'S4'}];
                    semanas.forEach(s => {
                        document.write(`<div class="flex-1"><input type="checkbox" name="semanaEspecifica" id="sem_${s.id}" value="${s.l}" class="hidden btn-check-week" onchange="toggleSemana('${s.id}')"><label for="sem_${s.id}" class="block cursor-pointer text-center text-[10px] py-1.5 rounded border border-gray-200 font-bold">${s.l}</label></div>`);
                    });
                </script>
            </div>
        </div>

        <hr class="border-gray-100 my-3">

        <div class="grid grid-cols-2 gap-3">
            <div>
                <label class="block text-xs font-bold text-gray-700 uppercase mb-1" id="lbl_dia_visita">Dia Visita (Princ.)</label>
                <div class="grid grid-cols-3 gap-1">
                    <script> ['SEG','TER','QUA','QUI','SEX','SAB'].forEach(d => document.write(`<input type="radio" name="diaPrincipal" id="dia_${d}" value="${d}" class="hidden btn-check" onclick="salvarEstadoFormulario()"><label for="dia_${d}" class="cursor-pointer text-center text-[10px] py-1 rounded border border-gray-200 font-semibold">${d}</label>`)); </script>
                </div>
            </div>
            <div>
                <label class="block text-xs font-bold text-gray-400 uppercase mb-1" id="lbl_outros_dias">Outros Dias</label>
                <div class="grid grid-cols-3 gap-1">
                    <script> ['SEG','TER','QUA','QUI','SEX','SAB'].forEach(d => document.write(`<input type="checkbox" name="diasSecundarios" id="sec_${d}" value="${d}" class="hidden btn-check-sec" onclick="salvarEstadoFormulario()"><label for="sec_${d}" class="cursor-pointer text-center text-[10px] py-1 rounded border border-gray-200 text-gray-400 font-semibold">${d}</label>`)); </script>
                </div>
            </div>
        </div>
      </div>

      <div class="bg-white p-3 rounded shadow-sm mb-4">
        <div class="grid grid-cols-1 gap-2">
          <div class="flex gap-2">
             <div class="flex-1"><label class="text-[10px] font-bold text-gray-700 uppercase" id="lbl_comprador">Comprador</label><input type="text" id="comprador" class="w-full p-1.5 border rounded bg-gray-50 outline-none text-sm" oninput="salvarEstadoFormulario()"></div>
             <div class="w-1/3"><label class="text-[10px] font-bold text-gray-700 uppercase" id="lbl_whatsapp">WhatsApp</label><input type="tel" id="whatsapp" class="w-full p-1.5 border rounded bg-gray-50 outline-none text-sm" placeholder="(00)..." maxlength="15" oninput="salvarEstadoFormulario()"></div>
          </div>
          <div><label class="text-[10px] font-bold text-gray-700 uppercase" id="lbl_obs">Observações</label><textarea id="obs" rows="1" class="w-full p-1.5 border rounded bg-gray-50 outline-none text-xs" oninput="salvarEstadoFormulario()"></textarea></div>
        </div>
      </div>

      <div class="grid grid-cols-2 gap-2 mb-6">
        <button type="button" onclick="incluirNaLista()" class="btn-amber font-bold py-3 rounded shadow flex flex-col items-center justify-center text-sm"><i class="ph ph-plus-circle text-xl"></i> INCLUIR</button>
        <button type="button" onclick="salvarDireto()" class="btn-blue font-bold py-3 rounded shadow flex flex-col items-center justify-center text-sm"><i class="ph ph-floppy-disk text-xl"></i> GRAVAR ESTE</button>
      </div>
    </form>

    <div id="areaLista" class="bg-white rounded shadow-sm border border-gray-200 mb-20 hidden">
      <div class="bg-gray-100 p-2 border-b border-gray-200 flex justify-between items-center"><h3 class="font-bold text-xs text-gray-700">LISTA DE GRAVAÇÃO (MEMÓRIA)</h3><span id="contadorLista" class="bg-blue-600 text-white text-[10px] px-1.5 py-0.5 rounded-full">0</span></div>
      <div id="listaClientesContainer" class="divide-y divide-gray-100"></div>
    </div>
  </div>

  <div id="barraSalvar" class="fixed bottom-0 left-0 w-full bg-white border-t p-3 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.1)] hidden z-50">
    <div class="max-w-md mx-auto">
      <button onclick="salvarLote()" class="w-full btn-green font-bold py-3 rounded shadow-lg flex justify-center items-center gap-2 text-base"><i class="ph ph-paper-plane-right text-xl"></i> ENVIAR TUDO (<span id="btnCount">0</span>)</button>
    </div>
  </div>

  <div id="overlay" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4"><div class="bg-white rounded-lg p-6 w-full max-w-sm text-center shadow-xl"><div id="modalContent"></div></div></div>

  <script>
    // ============================================================
    // 1. CONFIGURAÇÕES E MAPEAMENTO
    // ============================================================
    const GAS_API_URL = 'https://script.google.com/macros/s/AKfycbyoOQUbcC4nKdR3qeh2u1q0Wn4eQUD3eJUrby2DG5Nx7xQh1jmH6FSTphqxslWPvktCfQ/exec'; 
    const SPREADSHEET_ID = '1JXdW-RDSrG4or8WzvLBV_PbopVvug9B9og7fSMGOWj0';
    const API_KEY = 'AIzaSyChiZPUY-G3oyZN2NGY_vlgRXUzry9Pkeo';
    
    const ABA_VENDEDORES = 'VENDEDORES'; const RANGE_VENDEDORES = 'A2:C';
    const ABA_CLIENTES = 'CLIENTES'; const RANGE_CLIENTES = 'A2:C';
    const ABA_EXIGIDO = 'EXIGIDO'; const RANGE_EXIGIDO = 'A2:B'; // Nova aba de regras

    // Mapa: Nome na Planilha "EXIGIDO" -> ID/Lógica no HTML
    const mapaCampos = {
        'COD VEND': { id: 'codVendedor', label: 'lbl_cod_vend', tipo: 'input' },
        'COD CLIENTE': { id: 'codCliente', label: 'lbl_cod_cliente', tipo: 'input' },
        'RAZAO SOCIAL': { id: 'razaoSocial', label: 'lbl_razao', tipo: 'input' },
        'FANTASIA': { id: 'nomeFantasia', label: 'lbl_fantasia', tipo: 'input' },
        'CIDADE': { id: 'cidade', label: 'lbl_cidade', tipo: 'input' },
        'ORDEM ROTA': { id: 'ordemManual', label: 'lbl_ordem', tipo: 'ordem' }, // Logica especial
        'FREQUENCIA': { label: 'lbl_frequencia', tipo: 'frequencia' }, // Logica especial
        'DIA VISITA': { label: 'lbl_dia_visita', tipo: 'dia' }, // Logica especial
        'OUTROS DIAS VISITA': { label: 'lbl_outros_dias', tipo: 'outros_dias' },
        'NOME COMPRADOR': { id: 'comprador', label: 'lbl_comprador', tipo: 'input' },
        'WHATSAPP': { id: 'whatsapp', label: 'lbl_whatsapp', tipo: 'input' },
        'OBSERVAÇÕES': { id: 'obs', label: 'lbl_obs', tipo: 'input' }
    };

    let dbVendedores = []; let dbClientes = []; let listaDeRotas = []; let regrasObrigatoriedade = {};

    // ============================================================
    // 2. INICIALIZAÇÃO
    // ============================================================
    window.onload = async function() {
        const s = localStorage.getItem('rotasTemp'); 
        if(s) { listaDeRotas = JSON.parse(s); renderizarLista(); }
        restaurarEstadoFormulario();
        await carregarBasesDeDados(); // Carrega dados E regras
        restaurarVendedor();
    };

    async function carregarBasesDeDados() {
        const loadingBar = document.getElementById('loadingBar');
        try {
            loadingBar.innerText = "Baixando regras e dados...";
            // Baixa as 3 tabelas em paralelo
            const [resV, resC, resR] = await Promise.all([
                fetch(`https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/${ABA_VENDEDORES}!${RANGE_VENDEDORES}?key=${API_KEY}`),
                fetch(`https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/${ABA_CLIENTES}!${RANGE_CLIENTES}?key=${API_KEY}`),
                fetch(`https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/${ABA_EXIGIDO}!${RANGE_EXIGIDO}?key=${API_KEY}`)
            ]);

            const jV = await resV.json(); const jC = await resC.json(); const jR = await resR.json();

            // Processa Vendedores e Clientes
            if (jV.values) dbVendedores = jV.values.map(r => ({ codigo: String(r[0]).trim(), nome: r[1], equipe: r[2] }));
            if (jC.values) dbClientes = jC.values.map(r => ({ codigo: String(r[0]).trim(), cidade: r[1], razao: r[2], fantasia: r[2] }));

            // PROCESSA REGRAS DE OBRIGATORIEDADE
            regrasObrigatoriedade = {}; // Reseta
            if (jR.values) {
                jR.values.forEach(row => {
                    const nomeCampo = String(row[0]).trim().toUpperCase(); // Coluna A: Nome
                    const flag = String(row[1] || '').trim(); // Coluna B: X ou letra
                    if (flag.length > 0) {
                        // Se tem qualquer coisa na coluna B, é obrigatório
                        regrasObrigatoriedade[nomeCampo] = true;
                    }
                });
            }
            aplicarAsteriscosVisuais();

            loadingBar.className = "bg-green-100 text-green-800 text-xs font-bold text-center p-1 border-b border-green-200";
            loadingBar.innerText = `Sistema Pronto! Regras Carregadas.`; 
            setTimeout(() => { loadingBar.style.display = 'none'; }, 1500);

        } catch (e) { 
            console.error(e);
            loadingBar.className = "bg-red-100 text-red-800 text-xs font-bold text-center p-1"; 
            loadingBar.innerText = "Erro ao carregar. Verifique conexão."; 
        }
    }

    function aplicarAsteriscosVisuais() {
        // Remove marcas anteriores
        document.querySelectorAll('.required-mark').forEach(e => e.classList.remove('required-mark'));
        
        // Aplica novas marcas baseado nas regras carregadas
        for (const [nomePlanilha, config] of Object.entries(mapaCampos)) {
            if (regrasObrigatoriedade[nomePlanilha]) {
                const label = document.getElementById(config.label);
                if (label) label.classList.add('required-mark');
            }
        }
    }

    // ============================================================
    // 3. VALIDAÇÃO DINÂMICA (A LÓGICA PEDIDA)
    // ============================================================
    function validarCamposDinamicos() {
        let erros = [];

        for (const [nomePlanilha, isRequired] of Object.entries(regrasObrigatoriedade)) {
            if (!isRequired) continue; // Se não tá marcado com X na planilha, pula

            const config = mapaCampos[nomePlanilha];
            if (!config) continue; // Se não mapeamos no HTML, pula

            // Validação por Tipo
            if (config.tipo === 'input') {
                const el = document.getElementById(config.id);
                if (!el || !el.value.trim()) erros.push(nomePlanilha);
            
            } else if (config.tipo === 'ordem') {
                // Verifica input manual OU radio button
                const manual = document.getElementById('ordemManual').value;
                const radio = document.querySelector('input[name="ordemVisita"]:checked');
                if (!manual && !radio) erros.push(nomePlanilha);

            } else if (config.tipo === 'frequencia') {
                const toda = document.getElementById('sem_todas').checked;
                const part = document.querySelector('input[name="semanaEspecifica"]:checked');
                if (!toda && !part) erros.push(nomePlanilha);

            } else if (config.tipo === 'dia') {
                if (!document.querySelector('input[name="diaPrincipal"]:checked')) erros.push(nomePlanilha);
            
            } else if (config.tipo === 'outros_dias') {
                // Geralmente não é obrigatório, mas se for marcado na planilha:
                if (!document.querySelector('input[name="diasSecundarios"]:checked')) erros.push(nomePlanilha);
            }
        }

        if (erros.length > 0) {
            alert("Os seguintes campos são obrigatórios (marcados na planilha):\n\n- " + erros.join("\n- "));
            return false;
        }
        return true;
    }

    // ============================================================
    // 4. FUNÇÕES DE ENVIO (UPDATED COM VALIDAÇÃO)
    // ============================================================
    function obterDadosDoFormulario() {
      // CHAMA A VALIDAÇÃO DINÂMICA AQUI
      if (!validarCamposDinamicos()) return null;

      // (Resto da função igual, pois a validação já passou)
      const codV = document.getElementById('codVendedor').value;
      const nomeV = document.getElementById('nomeVendedor').value;
      const equipeV = document.getElementById('equipeVendedor').value;
      const codC = document.getElementById('codCliente').value;
      const nomeC = document.getElementById('nomeFantasia').value;
      
      // Backup de segurança minimo (sempre deve ter vend/cliente)
      if(!nomeV || !nomeC) { alert("Erro crítico: Identifique o cliente e vendedor."); return null; }
      
      let ordem = document.getElementById('ordemManual').value;
      if(!ordem) { const r = document.querySelector('input[name="ordemVisita"]:checked'); if(r) ordem = r.value; }

      const diaP = document.querySelector('input[name="diaPrincipal"]:checked');
      const diaVal = diaP ? diaP.value : ''; // Pode ser vazio se não for obrigatório

      let frequencia = "";
      if (document.getElementById('sem_todas').checked) {
          frequencia = "Toda Semana";
      } else {
          const sems = [];
          document.querySelectorAll('input[name="semanaEspecifica"]:checked').forEach(c => sems.push(c.value));
          if (sems.length > 0) frequencia = sems;
      }

      const diasS = [];
      document.querySelectorAll('input[name="diasSecundarios"]:checked').forEach(c => diasS.push(c.value));

      return {
        id: Date.now(),
        codVendedor: codV || 'MANUAL', nomeVendedor: nomeV, equipeVendedor: equipeV,
        codCliente: codC || 'MANUAL', nomeFantasia: nomeC,
        razaoSocial: document.getElementById('razaoSocial').value, cidade: document.getElementById('cidade').value,
        ordemVisita: ordem, semanas: frequencia,
        diaPrincipal: diaVal, diasSecundarios: diasS,
        comprador: document.getElementById('comprador').value, whatsapp: document.getElementById('whatsapp').value, obs: document.getElementById('obs').value
      };
    }

    // ============================================================
    // RESTO DAS FUNÇÕES (Mantidas para funcionamento)
    // ============================================================
    function toggleSemana(tipo) {
        const chkTodas = document.getElementById('sem_todas');
        const chkEspecificas = document.querySelectorAll('input[name="semanaEspecifica"]');
        if (tipo === 'todas') { if (chkTodas.checked) chkEspecificas.forEach(c => c.checked = false); } 
        else { let alguma = false; chkEspecificas.forEach(c => { if(c.checked) alguma = true; }); if (alguma) chkTodas.checked = false; }
        salvarEstadoFormulario();
    }
    function salvarEstadoFormulario() {
        const estado = {
            ordemManual: document.getElementById('ordemManual').value,
            comprador: document.getElementById('comprador').value, whatsapp: document.getElementById('whatsapp').value, obs: document.getElementById('obs').value,
            semanaTodas: document.getElementById('sem_todas').checked,
            semanasEsp: Array.from(document.querySelectorAll('input[name="semanaEspecifica"]:checked')).map(c => c.id),
            diaPrincipal: document.querySelector('input[name="diaPrincipal"]:checked')?.value || null,
            diasSec: Array.from(document.querySelectorAll('input[name="diasSecundarios"]:checked')).map(c => c.id)
        };
        localStorage.setItem('formEstadoTemp', JSON.stringify(estado));
    }
    function restaurarEstadoFormulario() {
        const s = localStorage.getItem('formEstadoTemp'); if (!s) return; const e = JSON.parse(s);
        if(e.ordemManual) { document.getElementById('ordemManual').value = e.ordemManual; sincronizarOrdem(e.ordemManual); }
        document.getElementById('comprador').value = e.comprador||''; document.getElementById('whatsapp').value = e.whatsapp||''; document.getElementById('obs').value = e.obs||'';
        if (e.semanaTodas) document.getElementById('sem_todas').checked = true;
        if (e.semanasEsp) e.semanasEsp.forEach(id => { let el=document.getElementById(id); if(el) el.checked=true; });
        if (e.diaPrincipal) { const r = document.querySelector(`input[name="diaPrincipal"][value="${e.diaPrincipal}"]`); if(r) r.checked = true; }
        if (e.diasSec) e.diasSec.forEach(id => { let el=document.getElementById(id); if(el) el.checked=true; });
    }
    function sincronizarOrdem(v) { 
        const r = document.querySelector(`input[name="ordemVisita"][value="${v}"]`); 
        if(r) r.checked = true; else document.querySelectorAll('input[name="ordemVisita"]').forEach(el => el.checked = false);
        salvarEstadoFormulario(); 
    }
    function restaurarVendedor() { const cod = localStorage.getItem('vendedorCodigo'); if (cod) { document.getElementById('codVendedor').value = cod; buscarVendedorLocal(); } }
    function buscarVendedorLocal() {
        const cod = document.getElementById('codVendedor').value.toString().trim(); const msg = document.getElementById('msgVendedor');
        if (!cod) { msg.innerHTML = ''; document.getElementById('nomeVendedor').value=''; localStorage.removeItem('vendedorCodigo'); return; }
        const f = dbVendedores.find(v => v.codigo === cod);
        if (f) { document.getElementById('nomeVendedor').value = f.nome; document.getElementById('equipeVendedor').value = f.equipe; msg.innerHTML = '<span class="text-green-600 font-bold">✓ OK</span>'; localStorage.setItem('vendedorCodigo', cod); } 
        else { document.getElementById('nomeVendedor').value = ''; msg.innerHTML = '<span class="text-red-500 text-[10px]">Não achou</span>'; }
    }
    function buscarClienteLocal() {
        const cod = document.getElementById('codCliente').value.toString().trim(); const msg = document.getElementById('msgCliente');
        if (!cod) { msg.innerHTML = ''; return; }
        const f = dbClientes.find(c => c.codigo === cod);
        if (f) { document.getElementById('nomeFantasia').value = f.fantasia; document.getElementById('razaoSocial').value = f.razao; document.getElementById('cidade').value = f.cidade; msg.innerHTML = '<span class="text-green-600 font-bold">✓ OK</span>'; } 
        else { msg.innerHTML = '<span class="text-red-500 font-bold">Novo?</span>'; }
    }
    async function chamarBackendScript(payload) {
      try { const r = await fetch(GAS_API_URL, { method: 'POST', headers: { 'Content-Type': 'text/plain;charset=utf-8' }, body: JSON.stringify(payload) }); return await r.json(); } 
      catch (error) { return { erro: "Falha conexão." }; }
    }
    async function salvarLote() {
      if(listaDeRotas.length === 0) return;
      mostrarModal('loading', 'Enviando...');
      const res = await chamarBackendScript({ acao: 'SALVAR_LOTE', lista: listaDeRotas });
      if(res.sucesso) { listaDeRotas=[]; salvarLocal(); renderizarLista(); mostrarModal('sucesso', res.mensagem); } else mostrarModal('erro', res.erro);
    }
    async function salvarDireto() {
      const btn = document.querySelector("button[onclick='salvarDireto()']"); if(btn.disabled) return;
      const item = obterDadosDoFormulario(); if(!item) return; // Validação já ocorre aqui dentro
      btn.disabled = true; mostrarModal('loading', 'Salvando...');
      try { const res = await chamarBackendScript({ acao: 'SALVAR_LOTE', lista: [item] }); if(res.sucesso) { limparFormulario(); mostrarModal('sucesso', res.mensagem); } else mostrarModal('erro', res.erro); } finally { btn.disabled = false; }
    }
    function incluirNaLista() { const item = obterDadosDoFormulario(); if(item) { listaDeRotas.push(item); salvarLocal(); renderizarLista(); limparFormulario(); } }
    function renderizarLista() {
       const c = document.getElementById('listaClientesContainer'); c.innerHTML = '';
       const area = document.getElementById('areaLista'); const btn = document.getElementById('barraSalvar');
       if(listaDeRotas.length===0) { area.classList.add('hidden'); btn.classList.add('hidden'); return; }
       area.classList.remove('hidden'); btn.classList.remove('hidden');
       document.getElementById('contadorLista').innerText = listaDeRotas.length;
       document.getElementById('btnCount').innerText = listaDeRotas.length;
       listaDeRotas.slice().reverse().forEach(item => {
         const freqDisplay = Array.isArray(item.semanas) ? item.semanas.join(',') : item.semanas;
         c.innerHTML += `<div class="p-2 hover:bg-gray-50 transition-colors border-b border-gray-100"><div class="flex justify-between items-start"><div><p class="font-bold text-xs text-gray-800">${item.nomeFantasia}</p><p class="text-[10px] text-gray-500">${item.cidade} • Ord: ${item.ordemVisita} • ${freqDisplay}</p></div><button onclick="excluirItem(${item.id})" class="text-red-400 hover:text-red-600"><i class="ph ph-trash text-lg"></i></button></div></div>`;
       });
    }
    function excluirItem(id) { if(confirm('Remover?')) { listaDeRotas = listaDeRotas.filter(i => i.id !== id); salvarLocal(); renderizarLista(); } }
    function salvarLocal() { localStorage.setItem('rotasTemp', JSON.stringify(listaDeRotas)); }
    function limparFormulario() {
      document.getElementById('codCliente').value=''; document.getElementById('nomeFantasia').value=''; document.getElementById('razaoSocial').value=''; document.getElementById('cidade').value='';
      localStorage.removeItem('formEstadoTemp'); 
      document.getElementById('comprador').value=''; document.getElementById('whatsapp').value=''; document.getElementById('obs').value=''; document.getElementById('ordemManual').value='';
      document.querySelectorAll('input[type="radio"], input[type="checkbox"]').forEach(e => e.checked = false);
      document.getElementById('msgCliente').innerHTML = ''; document.getElementById('codCliente').focus();
    }
    function limparCliente() { limparFormulario(); }
    function mostrarModal(tipo, msg) {
      const o = document.getElementById('overlay'); const c = document.getElementById('modalContent'); o.classList.remove('hidden');
      if(tipo==='loading') c.innerHTML = `<div class="loader"></div><h3 class="font-bold mt-2 text-sm text-gray-700">${msg}</h3>`;
      else c.innerHTML = `<h3 class="font-bold text-base mb-2 text-gray-800">${tipo==='sucesso'?'Sucesso!':'Erro'}</h3><p class="mb-3 text-xs text-gray-600">${msg}</p><button onclick="document.getElementById('overlay').classList.add('hidden')" class="bg-gray-200 px-4 py-1.5 rounded text-sm font-bold">Fechar</button>`;
    }
    document.getElementById('whatsapp').addEventListener('input', function (e) { let x = e.target.value.replace(/\D/g, '').match(/(\d{0,2})(\d{0,5})(\d{0,4})/); e.target.value = !x[2] ? x[1] : '(' + x[1] + ') ' + x[2] + (x[3] ? '-' + x[3] : ''); });
  </script>
</body>
</html>
