<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />

    <title>Ficha de Retirada de Mercadoria - Ameripan (Compacta)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

    <style>
        /* [Seu CSS Básico - Sem alterações] */
        body { font-family: Arial, sans-serif; margin: 20px; background-color: #f4f4f4; color: #333; font-size: 14px; }
        .container { background-color: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 0 15px rgba(0,0,0,0.1); max-width: 1000px; margin: auto; }
        h1, h2 { color: #005A9C; text-align: center; margin-bottom: 20px; }
        .form-section { margin-bottom: 25px; padding-bottom: 15px; border-bottom: 1px solid #eee; }
        .form-section:last-child { border-bottom: none; }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 15px 20px; }
        .form-grid-address { display: grid; grid-template-columns: 1fr; gap: 15px 20px; }
        @media (min-width: 600px) {
            .form-grid-address { grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); }
            .cep-container { grid-column: 1 / span 1; display: flex; align-items: flex-end; gap: 5px; }
            #cepCliente { flex-grow: 1; }
            .btn-cep { padding: 10px; height: 40px; line-height: 20px; flex-shrink: 0; }
            #ruaCliente { grid-column: 1 / -1; }
            #numeroCliente { grid-column: 1 / span 1; }
            #bairroCliente { grid-column: auto / span 1; }
            #cidadeCliente { grid-column: auto / span 1; }
            #ufCliente { grid-column: auto / span 1; max-width: 100px; }
        }
        .form-grid-halved { display: grid; grid-template-columns: 1fr 1fr; gap: 15px 20px; }
        .form-grid-full { grid-column: 1 / -1; }
        label { display: block; margin-bottom: 5px; font-weight: bold; color: #555; }
        input[type="text"], input[type="date"], input[type="number"], input[type="tel"], textarea, select { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; font-size: 14px; }
        .error-input { border-color: #dc3545 !important; box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25); }
        textarea { min-height: 70px; resize: vertical; }
        .table-products-container { overflow-x: auto; -webkit-overflow-scrolling: touch; margin-top: 10px; position: relative; }
        .table-loading-overlay { position: absolute; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(255, 255, 255, 0.8); display: flex; align-items: center; justify-content: center; z-index: 10; font-style: italic; color: #555; }
        .table-products { width: 100%; min-width: 800px; border-collapse: collapse; table-layout: fixed; word-wrap: break-word; }
        .table-products th, .table-products td { border: 1px solid #ddd; padding: 8px; text-align: left; font-size: 13px; vertical-align: top; }
        .table-products th { background-color: #f0f0f0; color: #333; font-weight: bold; white-space: nowrap; }
        /* Definição de colunas */
        .table-products th:nth-child(1), .table-products td:nth-child(1) { width: 12%; } /* Cód. */
        .table-products th:nth-child(2), .table-products td:nth-child(2) { width: 8%;  } /* Qtde */
        .table-products th:nth-child(3), .table-products td:nth-child(3) { width: 35%; } /* Descrição */
        .table-products th:nth-child(4), .table-products td:nth-child(4) { width: 15%; } /* Valor */
        .table-products th:nth-child(5), .table-products td:nth-child(5) { width: 15%; } /* Pedido */
        .table-products th:nth-child(6), .table-products td:nth-child(6) { width: 15%; } /* Data Fat. */
        .table-products th:nth-child(7), .table-products td:nth-child(7) { width: 10%; text-align: center;} /* Ação */
        
        .table-products td input[type="text"], .table-products td input[type="number"], .table-products td input[type="date"] { width: 100%; padding: 6px; font-size: 13px; box-sizing: border-box; }
        .table-products td:nth-child(2) input[type="number"].input-qtde { text-align: center; min-width: 45px; }
        .table-products td:nth-child(4) input[type="text"].input-valor-prod-fat { text-align: right; }
        .status-message { text-align: center; padding: 10px; margin-top: 5px; border-radius: 4px; font-size: 0.9em; }
        .status-loading { background-color: #e9ecef; color: #495057; }
        .status-error { background-color: #f8d7da; color: #721c24; }
        .status-success { background-color: #d4edda; color: #155724; display: none; }
        .btn { padding: 10px 18px; border: none; border-radius: 5px; cursor: pointer; font-size: 15px; font-weight: bold; transition: background-color 0.3s ease; margin-top: 5px; }
        .btn-add { background-color: #28a745; color: white; } .btn-add:hover { background-color: #218838; }
        .btn-remove { background-color: #dc3545; color: white; padding: 6px 10px; font-size: 12px; } .btn-remove:hover { background-color: #c82333; }
        .btn-cep { background-color: #007bff; color:white; border:none; padding: 0 10px; height: 40px; border-radius: 0 4px 4px 0; cursor:pointer;} .btn-cep:hover { background-color: #0056b3; }
        .btn-generate { display: none !important; }
        .button-container { display: flex; justify-content: center; gap: 15px; margin-top: 30px; flex-wrap: wrap; }
        .btn-download, .btn-share { flex: 1 1 200px; max-width: 250px; margin-top: 0; box-sizing: border-box; }
        .btn-download { background-color: #005A9C; color: white; }
        .btn-download:hover { background-color: #004a80; }
        .btn-share { background-color: #25D366; color: white; display: none; }
        .btn-share:hover { background-color: #1EAE50; }
        .total-display { text-align: right; font-size: 1.2em; font-weight: bold; margin-top: 15px; color: #005A9C; }
        .radio-group { margin-bottom: 10px; }
        .radio-group label { font-weight: normal; margin-right: 15px; display: inline-block; }
        .radio-group input[type="radio"] { margin-right: 5px; vertical-align: middle; }
        #outrosEspecificarDiv { display: none; margin-top: 10px; }
        .footer-section-html { text-align: center; margin-top: 30px; padding-top: 20px; border-top: 1px solid #eee; color: #6c757d; font-size: 0.875rem; }
        .footer-section-html p { margin-bottom: 0.25rem; }

        /* --- NOVO: CSS DA LÓGICA DE BUSCA (Dropdown) --- */
        .search-results-container {
            position: absolute; z-index: 1000;
            background-color: #fff; border: 1px solid #ccc;
            border-radius: 5px; box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            max-height: 250px; overflow-y: auto;
        }
        .search-results-container div {
            padding: 10px; cursor: pointer; font-size: 13px;
        }
        .search-results-container div:hover { background-color: #f0f2f5; }
        .search-results-container div strong { color: #005A9C; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Ficha de Retirada de Mercadoria (Paisagem)</h1>

        <div class="form-section">
            <h2>Identificação Geral</h2>
            <div class="form-grid-halved">
                <div><label for="codCliente">Cód. Cliente:</label><input type="text" id="codCliente" placeholder="Ex: 5040" required></div>
                <div><label for="dataRequisicao">Data da Requisição:</label><input type="date" id="dataRequisicao" required></div>
                <div><label for="nomeCliente">Nome Cliente:</label><input type="text" id="nomeCliente" placeholder="Nome completo do cliente" required></div>
                <div><label for="foneCliente">Fone:</label><input type="tel" id="foneCliente" placeholder="(XX) XXXXX-XXXX"></div>
            </div>
            <h3 style="margin-top:20px; margin-bottom:10px; color: #333; font-size: 1.1em;">Endereço de Retirada</h3>
            <div id="address-status" class="status-message" style="display:none;"></div>
            <div class="form-grid-address">
                <div class="cep-container">
                    <div style="flex-grow:1;">
                        <label for="cepCliente">CEP:</label>
                        <input type="tel" id="cepCliente" placeholder="XXXXX-XXX" maxlength="9">
                    </div>
                    <button type="button" class="btn btn-cep" id="btnBuscarCep" title="Buscar CEP"><i class="fas fa-search"></i></button>
                </div>
                <div id="ruaClienteDiv"><label for="ruaCliente">Rua:</label><input type="text" id="ruaCliente" placeholder="Nome da Rua" required></div>
                <div id="numeroClienteDiv"><label for="numeroCliente">Número:</label><input type="text" id="numeroCliente" placeholder="Nº" required></div>
                <div id="bairroClienteDiv"><label for="bairroCliente">Bairro:</label><input type="text" id="bairroCliente" placeholder="Nome do Bairro" required></div>
                <div id="cidadeClienteDiv"><label for="cidadeCliente">Cidade:</label><input type="text" id="cidadeCliente" placeholder="Nome da Cidade" required></div>
                <div id="ufClienteDiv"><label for="ufCliente">UF:</label><input type="text" id="ufCliente" placeholder="SP" maxlength="2" value="SP" required></div>
            </div>
        </div>

        <div class="form-section">
            <h2>Responsáveis e Operação</h2>
             <div class="form-grid">
                <div><label for="supervisorNome">Supervisor:</label><input type="text" id="supervisorNome" placeholder="Nome do Supervisor" required></div>
                <div><label for="vendedorNome">Vendedor:</label><input type="text" id="vendedorNome" placeholder="Nome do Vendedor" required></div>
                <div>
                    <label for="motoristaNome">Motorista:</label>
                    <input type="text" id="motoristaNome" list="motoristas-lista" placeholder="Nome do Motorista (se houver)">
                    <datalist id="motoristas-lista">
                        <option value="MOTORISTA INTERNO"></option>
                        <option value="CLIENTE RETIRA"></option>
                        <option value="Alan"></option>
                        <option value="Cleiton"></option>
                        <option value="Donizete"></option>
                        <option value="Everton"></option>
                        <option value="Luan"></option>
                    </datalist>
                </div>
            </div>
            <div class="form-grid-full radio-group">
                 <label>Operação:</label>
                <input type="radio" id="opRetirada" name="tipoOperacao" value="retirada" checked><label for="opRetirada">RETIRADA</label>
                <input type="radio" id="opOutros" name="tipoOperacao" value="outros"><label for="opOutros">OUTROS</label>
            </div>
            <div id="outrosEspecificarDiv" class="form-grid-full">
                <label for="outrosEspecificar">Especificar "Outros":</label>
                <input type="text" id="outrosEspecificar" placeholder="Descreva o tipo de operação 'Outros'">
            </div>
        </div>

        <div class="form-section">
            <h2>Produtos para Retirada</h2>
            <div style="margin-bottom: 10px; display: flex; align-items: center; padding: 5px; background-color: #f8f9fa; border-radius: 4px;">
                <input type="checkbox" id="syncPedidoData" style="width: auto; margin-right: 8px; height: 16px; width: 16px;" checked>
                <label for="syncPedidoData" style="margin-bottom: 0; font-weight: normal; cursor: pointer;">Todos produtos do mesmo pedido e data</label>
            </div>
            <div class="table-products-container">
                <div class="table-loading-overlay" id="tableLoadingOverlay" style="display: none;">Carregando lista de produtos...</div>
                <table class="table-products" id="tabelaProdutos">
                    <thead>
                        <tr>
                            <th>Cód. Produto</th>
                            <th>Qtde</th>
                            <th>Descrição do Produto</th>
                            <th>Valor Prod. Fat (Unit.)</th>
                            <th>Pedido(s) de Venda</th>
                            <th>Data Fat.</th>
                            <th>Ação</th>
                        </tr>
                    </thead>
                    <tbody>
                        </tbody>
                </table>
            </div>
            
            <div class="search-results-container" id="searchResults" style="display: none;"></div>
            
            <div id="product-load-status" class="status-message" style="display:none;"></div>
            <button type="button" class="btn btn-add" onclick="adicionarProdutoLinha()">Adicionar Produto</button>
            <div class="total-display" id="valorTotalHtml">VALOR TOTAL: R$ 0,00</div>
        </div>

        <div class="form-section">
            <h2>Detalhes Adicionais</h2>
            <div class="form-grid-full"><label for="motivoRetirada">Motivo da Retirada:</label><textarea id="motivoRetirada" placeholder="Descreva o motivo detalhado da retirada/troca" required></textarea></div>
        </div>

        <button type="button" class="btn btn-generate" onclick="alert('Este botão foi substituído')">Gerar PDF da Ficha</button>

        <div class="button-container">
            <button type="button" class="btn btn-download" onclick="handleDownloadPdf()">Baixar PDF</button>
            <button type="button" class="btn btn-share" id="btnSharePdf" onclick="handleSharePdf()">
                Compartilhar <i class="fab fa-whatsapp"></i>
            </button>
        </div>

        <div class="footer-section-html">
            <p>AMERIPAN PRODUTOS PARA PANIFICACAO LTDA.</p>
            <p>CNPJ: 65.029.035/0001-07</p>
            <p>Rua Purus, 652 - Jardim São Roque - Americana/SP - CEP: 13469-130</p>
        </div>
    </div>

    <script>
        // =======================================================================
        // PARTE 1: CONFIGURAÇÕES E INICIALIZAÇÃO
        // =======================================================================

        // --- Configurações Google Sheets ---
        const SPREADSHEET_ID = '1cN_1GBR29BN77eRZAkzvikt96i_kX9AZ04cTc6XRM8Q';
        const API_KEY = 'AIzaSyChiZPUY-G3oyZN2NGY_vlgRXUzry9Pkeo'; // ⚠️ CUIDADO: Chave de API pública. Restrinja no Google Cloud.
        const PRODUCTS_SHEET_NAME = 'produtos';
        const PRODUCTS_RANGE = 'A2:B';

        // --- MELHORIA (BUSCA): Variáveis de Lista de Produtos ---
        let productList = new Map();        // Para busca rápida por SKU (Cód -> Nome)
        let productListArray = [];      // Para busca por nome (Nome -> Cód)
        let activeSearchInput = null;     // Para saber qual input de nome ativou a busca

        const SUPERVISOR_STORAGE_KEY = 'fichaRetiradaSupervisor_Session';
        const VENDEDOR_STORAGE_KEY = 'fichaRetiradaVendedor_Session';

        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('dataRequisicao').value = getTodayDateString();
            carregarResponsaveis();
            setupEnterKeyNavigation();

            // Listeners do formulário
            document.getElementById('supervisorNome').addEventListener('blur', salvarResponsaveis);
            document.getElementById('vendedorNome').addEventListener('blur', salvarResponsaveis);
            document.getElementById('foneCliente').addEventListener('blur', (e) => formatarTelefone(e.target));
            document.getElementById('cepCliente').addEventListener('blur', (e) => formatarCEP(e.target));
            document.getElementById('cepCliente').addEventListener('keypress', (e) => { if (e.key === 'Enter') { e.preventDefault(); buscarEnderecoPorCEP(); } });
            document.getElementById('btnBuscarCep').addEventListener('click', buscarEnderecoPorCEP);
            document.getElementById('opRetirada').addEventListener('change', toggleOutrosEspecificar);
            document.getElementById('opOutros').addEventListener('change', toggleOutrosEspecificar);
            toggleOutrosEspecificar();

            // Carrega produtos e adiciona a primeira linha
            loadProductsFromSheet().then(() => {
                adicionarProdutoLinha('', '1', '', '', '', getTodayDateString());
                if (productList.size === 0 && document.getElementById('product-load-status').style.display !== 'block') {
                    const productLoadStatus = document.getElementById('product-load-status');
                    productLoadStatus.textContent = 'Lista de produtos não carregada ou vazia.';
                    productLoadStatus.className = 'status-message status-error';
                    productLoadStatus.style.display = 'block';
                }
            });

            // Lógica para mostrar o botão de compartilhar
            const shareButton = document.getElementById('btnSharePdf');
            if (navigator.share && navigator.canShare) {
                shareButton.style.display = 'block';
            }
            
            // --- MELHORIA (BUSCA): Fechar dropdown ao clicar fora ---
            document.addEventListener('click', (e) => {
                // Se o clique NÃO for no input de descrição E NÃO for dentro do dropdown
                if (!e.target.classList.contains('input-desc-produto') && !e.target.closest('#searchResults')) {
                    document.getElementById('searchResults').style.display = 'none';
                }
            });
        });

        // =======================================================================
        // PARTE 2: CARREGAMENTO E BUSCA DE PRODUTOS
        // =======================================================================

        async function loadProductsFromSheet() {
            const tableLoadingOverlay = document.getElementById('tableLoadingOverlay');
            const productLoadStatus = document.getElementById('product-load-status');
            if (tableLoadingOverlay) tableLoadingOverlay.style.display = 'flex';
            if (productLoadStatus) {
                productLoadStatus.textContent = 'Carregando lista de produtos...';
                productLoadStatus.className = 'status-message status-loading';
                productLoadStatus.style.display = 'block';
            }
            
            const url = `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/${PRODUCTS_SHEET_NAME}!${PRODUCTS_RANGE}?key=${API_KEY}&_=${new Date().getTime()}`;
            
            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error(`Erro HTTP ${response.status}: ${response.statusText}`);
                const data = await response.json();
                
                // Limpa ambas as listas
                productList.clear();
                productListArray = []; // ou productListArray.length = 0;

                if (data.values && data.values.length > 0) {
                    data.values.forEach(row => {
                        if (row[0] && row[1]) {
                            const sku = String(row[0]).trim();
                            const name = String(row[1]).trim();
                            // Popula o Map (para busca SKU -> Nome)
                            productList.set(sku, name);
                            // Popula o Array (para busca Nome -> SKU)
                            productListArray.push({ sku, name });
                        }
                    });
                    if (productLoadStatus) {
                         productLoadStatus.textContent = `${productList.size} produtos carregados!`;
                         productLoadStatus.className = 'status-message status-success';
                         setTimeout(() => { productLoadStatus.style.display = 'none';}, 3000);
                    }
                } else {
                     if (productLoadStatus) {
                        productLoadStatus.textContent = 'Nenhum produto encontrado na planilha ou planilha vazia.';
                        productLoadStatus.className = 'status-message status-error';
                     }
                }
            } catch (error) {
                console.error('Erro ao carregar produtos:', error);
                if (productLoadStatus) {
                    productLoadStatus.textContent = `Erro ao carregar produtos: ${error.message}. Verifique API Key/Permissões.`;
                    productLoadStatus.className = 'status-message status-error';
                }
            } finally {
                if (tableLoadingOverlay) tableLoadingOverlay.style.display = 'none';
            }
        }

        /**
         * NOVO (BUSCA): Chamado ao digitar no campo de descrição
         */
        function handleNameInput(event) {
            const input = event.target;
            const query = input.value.trim().toUpperCase();
            activeSearchInput = input; // Guarda qual input está ativo

            if (query.length < 2) {
                document.getElementById('searchResults').style.display = 'none';
                return;
            }

            const results = searchProducts(query);
            displaySearchResults(results, input);
        }

        /**
         * NOVO (BUSCA): A lógica de filtro com '*' (vinda do outro código)
         * Usa productListArray
         */
        function searchProducts(query) {
            const terms = query.split('*').filter(t => t); // Divide por '*'
            const results = productListArray.filter(product => {
                const productName = product.name.toUpperCase();
                // .every() garante que TODOS os termos (ex: 'BISC' E 'BRIGA') existam
                return terms.every(term => productName.includes(term));
            });
            return results.slice(0, 10); // Limita a 10 resultados
        }

        /**
         * NOVO (BUSCA): Mostra o dropdown de resultados
         */
        function displaySearchResults(results, inputElement) {
            const resultsContainer = document.getElementById('searchResults');
            resultsContainer.innerHTML = '';

            if (results.length === 0) {
                resultsContainer.style.display = 'none';
                return;
            }

            results.forEach(product => {
                const item = document.createElement('div');
                item.innerHTML = `<strong>${product.sku}</strong> - ${product.name}`;
                item.onclick = () => selectProduct(product); // Define a ação de clique
                resultsContainer.appendChild(item);
            });

            // Posiciona o dropdown abaixo do input correto
            const rect = inputElement.getBoundingClientRect();
            resultsContainer.style.left = `${rect.left + window.scrollX}px`;
            resultsContainer.style.top = `${rect.bottom + window.scrollY}px`;
            resultsContainer.style.width = `${rect.width}px`;
            resultsContainer.style.display = 'block';
        }

        /**
         * NOVO (BUSCA): Chamado ao clicar em um item do dropdown
         */
        function selectProduct(product) {
            if (!activeSearchInput) return;

            // Encontra a linha (tr) do input que estávamos usando
            const row = activeSearchInput.closest('tr');
            row.querySelector('.input-cod-produto').value = product.sku;
            row.querySelector('.input-desc-produto').value = product.name;

            document.getElementById('searchResults').style.display = 'none';
            activeSearchInput = null;
            
            // --- MELHORIA (FOCO): Pular para Valor se Qtde já estiver preenchida ---
            const qtdeInput = row.querySelector('.input-qtde');
            if (qtdeInput && qtdeInput.value.trim() !== '') {
                const valorInput = row.querySelector('.input-valor-prod-fat');
                if (valorInput) {
                    valorInput.focus();
                    valorInput.select();
                }
            }
            // --- FIM DA MELHORIA ---
        }

        // =======================================================================
        // PARTE 3: LÓGICA DA TABELA DE PRODUTOS
        // =======================================================================

        function adicionarProdutoLinha(cod = '', qtde = '1', desc = '', valorStrInicial = '', pedido = '', dataFat = '') {
            const tabelaCorpo = document.getElementById('tabelaProdutos').getElementsByTagName('tbody')[0];

            // Lógica de sincronização de pedido/data
            const syncChecked = document.getElementById('syncPedidoData').checked;
            if (syncChecked && tabelaCorpo.rows.length > 0) {
                const firstRow = tabelaCorpo.rows[0];
                const masterPedidoInput = firstRow.cells[4].getElementsByTagName('input')[0];
                const masterDataInput = firstRow.cells[5].getElementsByTagName('input')[0];
                pedido = masterPedidoInput.value;
                dataFat = masterDataInput.value;
            }

            const novaLinha = tabelaCorpo.insertRow();
            const campos = [
                { type: 'text', value: cod, placeholder: 'Cód.', class: 'input-cod-produto' },
                { type: 'number', value: qtde, placeholder: 'Qt.', step: '1', min: '0', class: 'input-qtde' },
                { type: 'text', value: desc, placeholder: 'Digite o nome (ex: bis*briga*)', class: 'input-desc-produto' },
                { type: 'text', value: valorStrInicial, placeholder: 'Preço Unit.', class: 'input-valor-prod-fat' },
                { type: 'text', value: pedido, placeholder: 'Nº Pedido(s)' },
                { type: 'date', value: dataFat }
            ];

            campos.forEach((campoInfo) => {
                const novaCelula = novaLinha.insertCell();
                const input = document.createElement('input');
                input.type = campoInfo.type;
                input.placeholder = campoInfo.placeholder || '';
                if (campoInfo.step) input.step = campoInfo.step;
                if (campoInfo.min) input.min = campoInfo.min;
                if (campoInfo.class) input.className = campoInfo.class;

                if (input.classList.contains('input-valor-prod-fat')) {
                    input.value = campoInfo.value ? formatarNumeroParaInput(parseValorUsuario(campoInfo.value)) : '';
                    input.addEventListener('focus', handleValorFocus);
                    input.addEventListener('input', handleValorInput);
                    input.addEventListener('blur', (e) => formatarInputValorMonetario(e.target));
                } else { input.value = campoInfo.value; }

                // --- PONTO DE INJEÇÃO DAS MELHORIAS (LISTENERS) ---
                
                // MELHORIA (FOCO): Adiciona listener de blur na Qtde
                if (input.classList.contains('input-qtde')) {
                    input.addEventListener('input', calcularValorTotalHtml);
                    input.addEventListener('blur', handleQtdeBlur); // ADICIONADO
                }
                
                // Listener original (Busca por SKU)
                if (input.classList.contains('input-cod-produto')) {
                    input.addEventListener('blur', buscarNomeProduto);
                }
                
                // MELHORIA (BUSCA): Adiciona listeners na Descrição
                if (input.classList.contains('input-desc-produto')) {
                    input.addEventListener('input', handleNameInput);
                    input.addEventListener('focus', handleNameInput);
                }
                // --- FIM DA INJEÇÃO ---

                novaCelula.appendChild(input);
            });

            const celulaAcao = novaLinha.insertCell();
            const btnRemover = document.createElement('button');
            btnRemover.type = 'button'; btnRemover.innerHTML = 'Remover'; btnRemover.className = 'btn btn-remove';
            btnRemover.onclick = function() { removerProdutoLinha(this); };
            celulaAcao.appendChild(btnRemover);
            if(qtde || valorStrInicial) calcularValorTotalHtml();
        }

        /**
         * MELHORIA (FOCO): Chamado ao sair do campo de Qtde
         */
        function handleQtdeBlur(event) {
            const qtdeInput = event.target;
            const linha = qtdeInput.closest('tr');
            if (!linha) return;

            const codInput = linha.querySelector('.input-cod-produto');
            
            // Se o código E a qtde estiverem preenchidos, pule para o valor
            if (codInput && codInput.value.trim() !== '' && qtdeInput.value.trim() !== '') {
                const valorInput = linha.querySelector('.input-valor-prod-fat');
                if (valorInput) {
                    valorInput.focus();
                    valorInput.select();
                }
            }
        }
        
        /**
         * ATUALIZADO (BUSCA + FOCO): Busca nome por SKU e pula para valor
         */
        function buscarNomeProduto(event) {
            const codInput = event.target;
            const linha = codInput.closest('tr');
            if (!linha) return;
            const descInput = linha.querySelector('.input-desc-produto');
            const codigoProduto = codInput.value.trim();

            if (codigoProduto && productList.has(codigoProduto)) {
                if (descInput) descInput.value = productList.get(codigoProduto);
                
                // --- MELHORIA (FOCO): Pular para Valor se Qtde já estiver preenchida ---
                const qtdeInput = linha.querySelector('.input-qtde');
                if (qtdeInput && qtdeInput.value.trim() !== '') {
                    const valorInput = linha.querySelector('.input-valor-prod-fat');
                    if (valorInput) {
                        valorInput.focus();
                        valorInput.select(); // Seleciona o texto para fácil edição
                    }
                }
                // --- FIM DA MELHORIA ---
            }
        }

        function removerProdutoLinha(botao) { 
            const linha = botao.parentNode.parentNode; 
            linha.parentNode.removeChild(linha); 
            calcularValorTotalHtml(); 
        }

        // =======================================================================
        // PARTE 4: FUNÇÕES DE VALIDAÇÃO E GERAÇÃO DE PDF
        // =======================================================================
        
        /**
         * NOVO (ALERTA DE DATA): Verifica se alguma data é 'hoje'
         */
        function confirmarDatasFaturamento() {
            const todayStr = getTodayDateString();
            const linhasProdutos = document.getElementById('tabelaProdutos').getElementsByTagName('tbody')[0].rows;
            let foundTodayDate = false;

            for (let i = 0; i < linhasProdutos.length; i++) {
                const linha = linhasProdutos[i];
                const dataFatInput = linha.cells[5].getElementsByTagName('input')[0];
                if (dataFatInput.value === todayStr) {
                    foundTodayDate = true;
                    break;
                }
            }

            if (foundTodayDate) {
                // Pergunta ao usuário se ele confirma
                return confirm("⚠️ ALERTA DE DATA ⚠️\n\nUma ou mais datas de faturamento são de HOJE.\n\nVocê já alterou a data para a correta (ex: data da NF original)?\n\n- Clique 'OK' para continuar e gerar o PDF.\n- Clique 'Cancelar' para voltar e corrigir as datas.");
            }
            
            return true; // Nenhuma data de hoje, continua normal
        }

        /**
         * ATUALIZADO (ALERTA DE DATA): Chama a confirmação de data
         */
        async function handleDownloadPdf() {
            if (!validarFormulario()) {
                return;
            }
            // --- INÍCIO DA MELHORIA: Checagem de Data ---
            if (!confirmarDatasFaturamento()) {
                return; // Usuário cancelou
            }
            // --- FIM DA MELHORIA ---
            const { doc, fileName } = await criarDocumentoPdf();
            doc.save(fileName);
        }

        /**
         * ATUALIZADO (ALERTA DE DATA): Chama a confirmação de data
         */
        async function handleSharePdf() {
            if (!validarFormulario()) {
                return;
            }
            // --- INÍCIO DA MELHORIA: Checagem de Data ---
            if (!confirmarDatasFaturamento()) {
                return; // Usuário cancelou
            }
            // --- FIM DA MELHORIA ---
            
            const { doc, fileName, nomeCliente, codCliente } = await criarDocumentoPdf();
            const pdfBlob = doc.output('blob');
            const pdfFile = new File([pdfBlob], fileName, { type: 'application/pdf' });
            
            const shareData = {
                title: 'Ficha de Retirada',
                text: `Segue a Ficha de Retirada para o cliente ${nomeCliente} (Cód: ${codCliente}).`,
                files: [pdfFile]
            };

            try {
                await navigator.share(shareData);
                console.log('Arquivo compartilhado com sucesso!');
            } catch (err) {
                if (err.name !== 'AbortError') {
                    console.error('Erro ao compartilhar:', err);
                    alert('Erro ao compartilhar o arquivo. Tente baixar o PDF e anexar manualmente.');
                } else {
                    console.log('Compartilhamento cancelado pelo usuário.');
                }
            }
        }

        // =======================================================================
        // PARTE 5: FUNÇÕES UTILITÁRIAS (Sem alterações significativas)
        // =======================================================================
        
        function getTodayDateString() {
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }
        
        function setupEnterKeyNavigation() {
            const container = document.querySelector('.container');
            if (!container) return;
            container.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    if (e.target.id === 'cepCliente') { return; }
                    e.preventDefault();
                    const focusableSelector = 'input:not([readonly]), select, textarea, button.btn:not(.btn-remove)';
                    const focusableElements = Array.from(
                        container.querySelectorAll(focusableSelector)
                    ).filter(el => el.offsetParent !== null && !el.disabled);
                    const currentIndex = focusableElements.indexOf(document.activeElement);
                    if (currentIndex > -1 && (currentIndex + 1) < focusableElements.length) {
                        const nextElement = focusableElements[currentIndex + 1];
                        nextElement.focus();
                        if (nextElement.select && typeof nextElement.select === 'function') {
                            nextElement.select();
                        }
                    }
                }
            });
        }
        
        function salvarResponsaveis() {
            sessionStorage.setItem(SUPERVISOR_STORAGE_KEY, document.getElementById('supervisorNome').value.trim());
            sessionStorage.setItem(VENDEDOR_STORAGE_KEY, document.getElementById('vendedorNome').value.trim());
        }
        
        function carregarResponsaveis() {
            document.getElementById('supervisorNome').value = sessionStorage.getItem(SUPERVISOR_STORAGE_KEY) || '';
            document.getElementById('vendedorNome').value = sessionStorage.getItem(VENDEDOR_STORAGE_KEY) || '';
        }
        
        function toggleOutrosEspecificar() {
            const outrosRadio = document.getElementById('opOutros');
            const outrosEspecificarDiv = document.getElementById('outrosEspecificarDiv');
            const outrosEspecificarInput = document.getElementById('outrosEspecificar');
            if (outrosRadio.checked) {
                outrosEspecificarDiv.style.display = 'block';
                outrosEspecificarInput.setAttribute('required', 'required');
            } else {
                outrosEspecificarDiv.style.display = 'none';
                outrosEspecificarInput.value = '';
                outrosEspecificarInput.removeAttribute('required');
            }
        }
        
        function handleValorFocus(event) { if (event.target.value === '0,00') event.target.value = ''; }
        
        function handleValorInput(event) {
            const input = event.target; let valor = input.value;
            valor = valor.replace(/[^0-9,.]/g, ''); valor = valor.replace(/\.(?=.*\.)/g, ''); valor = valor.replace(/,(?=.*,)/g, '');
            input.value = valor; calcularValorTotalHtml();
        }
        
        function formatarInputValorMonetario(inputElement) {
            const valorNumerico = parseValorUsuario(inputElement.value || '0');
            inputElement.value = formatarNumeroParaInput(valorNumerico);
            calcularValorTotalHtml();
        }
        
        function parseValorUsuario(valorStr) {
            if (!valorStr || typeof valorStr !== 'string') return 0;
            let valorLimpo = valorStr.replace(/\./g, ''); valorLimpo = valorLimpo.replace(',', '.');
            valorLimpo = valorLimpo.replace(/[^\d.]/g, '');
            const numero = parseFloat(valorLimpo); return isNaN(numero) ? 0 : numero;
        }
        
        function formatarNumeroParaInput(numero) {
            if (typeof numero !== 'number' || isNaN(numero)) return '0,00';
            return numero.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }
        
        function formatarMoedaParaExibicao(valorNumerico) { return valorNumerico.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }); }
        
        function getDataFormatadaInput(dateInputId) { const dateValue = document.getElementById(dateInputId).value; if (!dateValue) return ''; const [year, month, day] = dateValue.split('-'); return `${day}/${month}/${year}`; }
        
        function getDataFormatadaInputFromValue(dateValue) { if (!dateValue) return ''; const [year, month, day] = dateValue.split('-'); return `${day}/${month}/${year}`; }
        
        function calcularValorTotalHtml() {
            let totalGeral = 0; const linhasProdutos = document.getElementById('tabelaProdutos').getElementsByTagName('tbody')[0].rows;
            for (let i = 0; i < linhasProdutos.length; i++) {
                const linha = linhasProdutos[i];
                const inputQtde = linha.cells[1].getElementsByTagName('input')[0];
                const inputValorProdFat = linha.cells[3].getElementsByTagName('input')[0];
                const qtde = parseInt(inputQtde.value) || 0;
                const valorProdFat = parseValorUsuario(inputValorProdFat.value);
                totalGeral += qtde * valorProdFat;
            }
            document.getElementById('valorTotalHtml').textContent = `VALOR TOTAL: ${formatarMoedaParaExibicao(totalGeral)}`;
        }
        
        function formatarNumeroParaPdf(valorNumerico) { return valorNumerico.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 }); }
        
        function formatarTelefone(inputElement) {
            let valor = inputElement.value.replace(/\D/g, "");
            if (valor.startsWith('55') && (valor.length === 12 || valor.length === 13)) { valor = valor.substring(2); }
            const len = valor.length;
            if (len === 11) { inputElement.value = `(${valor.substring(0, 2)}) ${valor.substring(2, 3)} ${valor.substring(3, 7)}-${valor.substring(7, 11)}`; }
            else if (len === 10) { inputElement.value = `(${valor.substring(0, 2)}) ${valor.substring(2, 6)}-${valor.substring(6, 10)}`; }
            else if (len > 0) { inputElement.value = valor; }
            else { inputElement.value = ""; }
        }
        
        function formatarCEP(inputElement) {
            let valor = inputElement.value.replace(/\D/g, "");
            const len = valor.length;
            if (len === 8) { inputElement.value = `${valor.substring(0, 5)}-${valor.substring(5)}`; }
            else if (len > 0) { inputElement.value = valor; }
            else { inputElement.value = ""; }
        }
        
        async function buscarEnderecoPorCEP() {
            const cepInput = document.getElementById('cepCliente');
            const addressStatus = document.getElementById('address-status');
            let cep = cepInput.value.replace(/\D/g, "");
            if (cep.length !== 8) {
                if (cep.length > 8) cep = cep.substring(0, 8);
                if (cep.length === 8) { formatarCEP(cepInput); }
                else {
                    addressStatus.textContent = 'CEP inválido. Deve conter 8 dígitos.';
                    addressStatus.className = 'status-message status-error';
                    addressStatus.style.display = 'block';
                    return;
                }
            }
            addressStatus.textContent = 'Buscando CEP...';
            addressStatus.className = 'status-message status-loading';
            addressStatus.style.display = 'block';
            try {
                const response = await fetch(`https://brasilapi.com.br/api/cep/v2/${cep}`);
                if (!response.ok) {
                    if (response.status === 404) throw new Error('CEP não encontrado.');
                    throw new Error(`Erro ao buscar CEP: ${response.statusText}`);
                }
                const data = await response.json();
                document.getElementById('ruaCliente').value = data.street || '';
                document.getElementById('bairroCliente').value = data.neighborhood || '';
                document.getElementById('cidadeCliente').value = data.city || '';
                document.getElementById('ufCliente').value = data.state || 'SP';
                document.getElementById('numeroCliente').focus();
                addressStatus.textContent = 'Endereço carregado!';
                addressStatus.className = 'status-message status-success';
                setTimeout(() => { addressStatus.style.display = 'none'; }, 2000);
            } catch (error) {
                console.error("Erro na busca por CEP:", error);
                addressStatus.textContent = `Erro: ${error.message}`;
                addressStatus.className = 'status-message status-error';
            }
        }
        
        function validarFormulario() {
            const erros = [];
            document.querySelectorAll('.error-input').forEach(el => el.classList.remove('error-input'));
            const camposObrigatorios = [
                { id: 'codCliente', nome: 'Cód. Cliente' }, { id: 'dataRequisicao', nome: 'Data da Requisição' },
                { id: 'nomeCliente', nome: 'Nome Cliente' }, { id: 'ruaCliente', nome: 'Rua' },
                { id: 'numeroCliente', nome: 'Número' }, { id: 'bairroCliente', nome: 'Bairro' },
                { id: 'cidadeCliente', nome: 'Cidade' }, { id: 'ufCliente', nome: 'UF' },
                { id: 'supervisorNome', nome: 'Supervisor' }, { id: 'vendedorNome', nome: 'Vendedor' },
                { id: 'motivoRetirada', nome: 'Motivo da Retirada' }
            ];
            camposObrigatorios.forEach(campo => {
                const elemento = document.getElementById(campo.id);
                if (!elemento.value.trim()) {
                    erros.push(`O campo "${campo.nome}" é obrigatório.`);
                    elemento.classList.add('error-input');
                }
            });
            const outrosEspecificarInput = document.getElementById('outrosEspecificar');
            if (document.getElementById('opOutros').checked && !outrosEspecificarInput.value.trim()) {
                 erros.push('O campo "Especificar Outros" é obrigatório quando a operação "OUTROS" é selecionada.');
                 outrosEspecificarInput.classList.add('error-input');
            }
            const linhasProdutos = document.getElementById('tabelaProdutos').getElementsByTagName('tbody')[0].rows;
            if (linhasProdutos.length === 0) {
                erros.push('É necessário adicionar pelo menos um produto à lista.');
            } else {
                let linhaProdutoValidaEncontrada = false;
                for (let i = 0; i < linhasProdutos.length; i++) {
                    const linha = linhasProdutos[i];
                    const inputs = linha.getElementsByTagName('input');
                    const todosVazios = Array.from(inputs).every(input => !input.value.trim());
                    if (todosVazios) continue;
                    const camposLinha = [
                        { input: inputs[0], nome: 'Cód. Produto' }, { input: inputs[1], nome: 'Qtde' },
                        { input: inputs[2], nome: 'Descrição' }, { input: inputs[3], nome: 'Valor' },
                        { input: inputs[4], nome: 'Pedido(s)' }, { input: inputs[5], nome: 'Data Fat.' },
                    ];
                    let linhaIncompleta = false;
                    camposLinha.forEach(campo => {
                        if (!campo.input.value.trim()) {
                            linhaIncompleta = true;
                            campo.input.classList.add('error-input');
                        }
                    });
                    if (linhaIncompleta) {
                        erros.push(`A linha de produto ${i + 1} está incompleta. Por favor, preencha todos os campos da linha.`);
                    } else {
                        linhaProdutoValidaEncontrada = true;
                    }
                }
                if (!linhaProdutoValidaEncontrada) {
                     erros.push('Nenhuma linha de produto foi preenchida corretamente.');
                }
            }
            if (erros.length > 0) {
                alert('Por favor, corrija os seguintes erros:\n\n- ' + erros.join('\n- '));
                return false;
            }
            return true;
        }
        
        // =======================================================================
        // PARTE 6: CRIAÇÃO DO PDF (Layout Intacto, sem alterações)
        // =======================================================================
        
        async function criarDocumentoPdf() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('l', 'mm', 'a4'); 
            // Coleta de dados
            const codCliente = document.getElementById('codCliente').value;
            const dataRequisicao = getDataFormatadaInput('dataRequisicao');
            const nomeCliente = document.getElementById('nomeCliente').value;
            const foneCliente = document.getElementById('foneCliente').value;
            const cepPdfInput = document.getElementById('cepCliente').value.trim();
            const ruaPdf = document.getElementById('ruaCliente').value.trim();
            const numeroPdf = document.getElementById('numeroCliente').value.trim();
            const bairroPdf = document.getElementById('bairroCliente').value.trim();
            const cidadePdf = document.getElementById('cidadeCliente').value.trim();
            const ufPdf = document.getElementById('ufCliente').value.trim();
            let enderecoCompletoPdf = "";
            if (ruaPdf) enderecoCompletoPdf += ruaPdf;
            if (numeroPdf) enderecoCompletoPdf += (enderecoCompletoPdf ? ", " : "") + numeroPdf;
            if (bairroPdf) enderecoCompletoPdf += (enderecoCompletoPdf ? " - " : "") + bairroPdf;
            if (cidadePdf) enderecoCompletoPdf += (enderecoCompletoPdf ? " - " : "") + cidadePdf;
            if (ufPdf) enderecoCompletoPdf += (cidadePdf ? "/" : (enderecoCompletoPdf ? " - " : "")) + ufPdf;
            if (cepPdfInput) {
                enderecoCompletoPdf += (enderecoCompletoPdf ? " (CEP: " : "CEP: ") + cepPdfInput + (enderecoCompletoPdf ? ")" : "");
            }
            enderecoCompletoPdf = enderecoCompletoPdf.trim();
            const supervisorNome = document.getElementById('supervisorNome').value;
            const vendedorNome = document.getElementById('vendedorNome').value;
            const motoristaNome = document.getElementById('motoristaNome').value;
            let tipoOperacaoTexto = '';
            const outrosEspecificarInput = document.getElementById('outrosEspecificar');
            if (document.getElementById('opRetirada').checked) {
                tipoOperacaoTexto = 'RETIRADA (x)  OUTROS ( )';
            } else if (document.getElementById('opOutros').checked) {
                tipoOperacaoTexto = 'RETIRADA ( )  OUTROS (x)';
                if (outrosEspecificarInput.value.trim()) {
                    tipoOperacaoTexto += `: ${outrosEspecificarInput.value.trim()}`;
                }
            }
            const motivoRetirada = document.getElementById('motivoRetirada').value;
            const produtosData = [];
            let valorTotalCalculadoNum = 0; 
            const linhasProdutos = document.getElementById('tabelaProdutos').getElementsByTagName('tbody')[0].rows;
            for (let i = 0; i < linhasProdutos.length; i++) {
                const linha = linhasProdutos[i]; 
                const inputs = linha.getElementsByTagName('input'); 
                const todosVazios = Array.from(inputs).every(input => !input.value.trim()); 
                if (todosVazios) continue;
                const qtdeProd = parseInt(linha.cells[1].getElementsByTagName('input')[0].value) || 0;
                const valorUnitProdStr = linha.cells[3].getElementsByTagName('input')[0].value; 
                const valorUnitProdNum = parseValorUsuario(valorUnitProdStr); 
                produtosData.push({
                    cod: linha.cells[0].getElementsByTagName('input')[0].value,
                    qtde: qtdeProd.toString(),
                    desc: linha.cells[2].getElementsByTagName('input')[0].value, 
                    valorUnitDisplayPdf: "R$ " + formatarNumeroParaPdf(valorUnitProdNum), 
                    pedido: linha.cells[4].getElementsByTagName('input')[0].value,
                    dataFat: linha.cells[5].getElementsByTagName('input')[0].value ? getDataFormatadaInputFromValue(linha.cells[5].getElementsByTagName('input')[0].value) : ''
                });
                valorTotalCalculadoNum += qtdeProd * valorUnitProdNum;
            }
            // Configurações de página
            const pageHeight = doc.internal.pageSize.getHeight(); 
            const pageWidth = doc.internal.pageSize.getWidth(); 
            const margin = 10;
            const contentWidth = pageWidth - (margin * 2); 
            let currentY = margin;
            const lineSpacingSmall = 3.5;
            const sectionSpacingSmall = 4;
            const defaultFontSize = 8;
            const labelFontSize = 8;
            const titleFontSize = 12;
            const companyFontSize = 9;
            const tableBodyFontSize = 7;
            const tableHeadFontSize = 7;
            const tableCellPadding = 1;
            // Cabeçalho e Bloco de Responsáveis
            doc.setFont("helvetica", "normal");
            doc.setFontSize(companyFontSize);
            doc.text("AMERIPAN PRODUTOS PARA PANIFICACAO LTDA.", pageWidth / 2, currentY, { align: 'center' });
            currentY += 5;
            doc.setFont("helvetica", "bold");
            doc.setFontSize(titleFontSize);
            doc.text("RETIRADA DE MERCADORIA", pageWidth / 2, currentY, { align: 'center' });
            currentY += 7;
            const responsaveisInfoYstart = margin + 2;
            let responsaveisCurrentY = responsaveisInfoYstart;
            const responsaveisStartX = pageWidth - margin - 75;
            const responsaveisLabelWidth = 22;
            const responsaveisValueX = responsaveisStartX + responsaveisLabelWidth;
            doc.setFont("helvetica", "bold");
            doc.setFontSize(labelFontSize -1);
            doc.text("SUPERVISOR:", responsaveisStartX, responsaveisCurrentY);
            doc.setFont("helvetica", "normal");
            doc.text(supervisorNome, responsaveisValueX, responsaveisCurrentY);
            responsaveisCurrentY += lineSpacingSmall;
            doc.setFont("helvetica", "bold");
            doc.text("VENDEDOR:", responsaveisStartX, responsaveisCurrentY);
            doc.setFont("helvetica", "normal");
            doc.text(vendedorNome, responsaveisValueX, responsaveisCurrentY);
            responsaveisCurrentY += lineSpacingSmall; 
            doc.setFont("helvetica", "bold");
            doc.text("MOTORISTA:", responsaveisStartX, responsaveisCurrentY);
            doc.setFont("helvetica", "normal");
            doc.text(motoristaNome, responsaveisValueX, responsaveisCurrentY);
            currentY = Math.max(currentY, responsaveisCurrentY + sectionSpacingSmall); 
            // Bloco de Cliente/Endereço
            doc.setFont("helvetica", "bold");
            doc.setFontSize(labelFontSize);
            let clienteInfoY = currentY;
            const clienteCol1LabelX = margin;
            const clienteCol1ValueX = margin + 25;
            const clienteCol2LabelX = margin + (contentWidth / 2) - 35;
            const clienteCol2ValueX = clienteCol2LabelX + 35;
            doc.text("CÓD.CLIENTE:", clienteCol1LabelX, clienteInfoY);
            doc.setFont("helvetica", "normal"); doc.setFontSize(defaultFontSize);
            doc.text(codCliente, clienteCol1ValueX, clienteInfoY);
            doc.setFont("helvetica", "bold"); doc.setFontSize(labelFontSize);
            doc.text("DATA DA REQUISIÇÃO:", clienteCol2LabelX, clienteInfoY);
            doc.setFont("helvetica", "normal"); doc.setFontSize(defaultFontSize);
            doc.text(dataRequisicao, clienteCol2ValueX, clienteInfoY);
            clienteInfoY += lineSpacingSmall + 1;
            doc.setFont("helvetica", "bold"); doc.setFontSize(labelFontSize);
            doc.text("NOME CLIENTE:", clienteCol1LabelX, clienteInfoY);
            doc.setFont("helvetica", "normal"); doc.setFontSize(defaultFontSize);
            doc.text(doc.splitTextToSize(nomeCliente, clienteCol2LabelX - clienteCol1ValueX - 2), clienteCol1ValueX, clienteInfoY); 
            doc.setFont("helvetica", "bold"); doc.setFontSize(labelFontSize);
            doc.text("FONE:", clienteCol2LabelX, clienteInfoY); 
            doc.setFont("helvetica", "normal"); doc.setFontSize(defaultFontSize);
            doc.text(foneCliente, clienteCol2ValueX, clienteInfoY);
            clienteInfoY += lineSpacingSmall + 1;
            doc.setFont("helvetica", "bold"); doc.setFontSize(labelFontSize);
            doc.text("ENDEREÇO:", clienteCol1LabelX, clienteInfoY);
            doc.setFont("helvetica", "normal"); doc.setFontSize(defaultFontSize -1);
            const splitEndereco = doc.splitTextToSize(enderecoCompletoPdf, contentWidth - (clienteCol1ValueX - margin)); 
            doc.text(splitEndereco, clienteCol1ValueX, clienteInfoY);
            currentY = clienteInfoY + (splitEndereco.length * (lineSpacingSmall - 0.5)) + sectionSpacingSmall;
            // Tabela de Produtos (Preto e Branco)
            const head = [['CÓD.PRODUTO', 'QTDE', 'DESCRIÇÃO DO PRODUTO', 'VALOR PROD. FAT', 'PEDIDO(S) DE VENDA', 'DATA FAT.']];
            const body = produtosData.map(p => [ p.cod, p.qtde, p.desc, p.valorUnitDisplayPdf, p.pedido, p.dataFat ]);
            doc.autoTable({
                head: head, body: body, startY: currentY, theme: 'grid',
                styles: { fontSize: tableBodyFontSize, cellPadding: tableCellPadding, lineColor: [0, 0, 0], lineWidth: 0.1 },
                headStyles: { fillColor: [255, 255, 255], textColor: [0,0,0], fontStyle: 'bold', fontSize: tableHeadFontSize, cellPadding: tableCellPadding, halign: 'center', lineColor: [0, 0, 0] },
                columnStyles: { 
                    0: { cellWidth: 30, halign: 'center' }, 1: { cellWidth: 15, halign: 'center' }, 
                    2: { cellWidth: 97 }, 3: { cellWidth: 35, halign: 'right' },
                    4: { cellWidth: 40, halign: 'center' }, 5: { cellWidth: 30, halign: 'center' } 
                },
                margin: { left: margin, right: margin }
            });
            currentY = doc.lastAutoTable.finalY + sectionSpacingSmall;
            // Bloco Total e Motivo
            doc.setFont("helvetica", "bold"); doc.setFontSize(labelFontSize + 1);
            const rotuloTotalTexto = "VALOR TOTAL:";
            const valorTotalFormatadoPdf = "R$ " + formatarNumeroParaPdf(valorTotalCalculadoNum); 
            const larguraRotuloTotal = doc.getStringUnitWidth(rotuloTotalTexto) * doc.getFontSize() / doc.internal.scaleFactor;
            const larguraValorTotal = doc.getStringUnitWidth(valorTotalFormatadoPdf) * doc.getFontSize() / doc.internal.scaleFactor;
            const xPosRotuloTotal = pageWidth - margin - larguraValorTotal - larguraRotuloTotal - 2;
            const xPosValorTotal = pageWidth - margin - larguraValorTotal; 
            doc.text(rotuloTotalTexto, xPosRotuloTotal, currentY);
            doc.setFont("helvetica", "normal"); doc.text(valorTotalFormatadoPdf, xPosValorTotal, currentY);
            currentY += lineSpacingSmall + 2;
            doc.setFont("helvetica", "normal"); doc.setFontSize(labelFontSize);
            const splitTipoOperacao = doc.splitTextToSize(tipoOperacaoTexto, contentWidth); 
            doc.text(splitTipoOperacao, margin, currentY);
            currentY += (splitTipoOperacao.length * (lineSpacingSmall-0.5)) + sectionSpacingSmall;
            doc.setFont("helvetica", "bold"); doc.setFontSize(labelFontSize);
            doc.text("MOTIVO DA RETIRADA:", margin, currentY); currentY += lineSpacingSmall;
            doc.setFont("helvetica", "normal"); doc.setFontSize(defaultFontSize -1);
            const splitMotivo = doc.splitTextToSize(motivoRetirada, contentWidth);
            doc.text(splitMotivo, margin, currentY);
            currentY += (splitMotivo.length * (lineSpacingSmall -0.5)) + sectionSpacingSmall;
            doc.setFont("helvetica", "bold"); doc.setFontSize(labelFontSize);
            doc.text("CONDIÇÕES DE TROCA:", margin, currentY); currentY += lineSpacingSmall;
            doc.setFont("helvetica", "normal"); doc.setFontSize(defaultFontSize - 1);
            doc.text("É OBRIGATORIO O ENVIO DE FOTOS DOS PRODUTOS JUNTAMENTE COM A REQUISIÇÃO", margin, currentY); currentY += (lineSpacingSmall -1);
            doc.text("PRODUTO ESTAR LACRADO E COM CONDIÇÕES DE USO, CASO CONTRARIO NÃO SERÁ FEITA A RETIRADA.", margin, currentY);
            currentY += sectionSpacingSmall + 2; 
            // Posição dinâmica do rodapé e assinaturas
            currentY += 15; 
            const signatureLineY = currentY;
            const companyFooterY_Base = signatureLineY + 10;
            doc.setFontSize(labelFontSize -1);
            const signatureWidth = 70;
            const centerOffset1 = (contentWidth / 2) / 2; 
            const centerOffset2 = (contentWidth / 2) + (contentWidth / 2) / 2; 
            const supAssinX1 = margin + centerOffset1 - (signatureWidth / 2);
            doc.line(supAssinX1, signatureLineY, supAssinX1 + signatureWidth, signatureLineY);
            doc.text("SUPERVISOR", supAssinX1 + signatureWidth / 2, signatureLineY + 3, { align: 'center' });
            const vendAssinX1 = margin + centerOffset2 - (signatureWidth / 2);
            doc.line(vendAssinX1, signatureLineY, vendAssinX1 + signatureWidth, signatureLineY); 
            doc.text("VENDEDOR", vendAssinX1 + signatureWidth / 2, signatureLineY + 3, { align: 'center' });
            doc.setFontSize(defaultFontSize - 2);
            doc.setTextColor(0); 
            doc.text("AMERIPAN PRODUTOS PARA PANIFICACAO LTDA.", pageWidth / 2, companyFooterY_Base - 6, { align: 'center' });
            doc.text("CNPJ: 65.029.035/0001-07", pageWidth / 2, companyFooterY_Base - 3, { align: 'center' });
            doc.text("Rua Purus, 652 - Jardim São Roque - Americana/SP - CEP: 13469-130", pageWidth / 2, companyFooterY_Base, { align: 'center' });
            doc.setTextColor(0);
            const fileName = `Ficha_Retirada_PAISAGEM_${codCliente || 'CODCLIENTE'}_${new Date().toISOString().slice(0,10)}.pdf`;
            // Retorna o documento e os dados necessários
            return { doc, fileName, nomeCliente, codCliente };
        }

    </script>
</body>
</html>
