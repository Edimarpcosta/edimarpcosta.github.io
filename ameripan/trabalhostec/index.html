<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Execu√ß√£o de Trabalhos T√©cnicos</title>
    <style>
        :root {
            --primary-color: #003366; /* Azul Escuro Corporativo */
            --accent-color: #cc0000;  /* Vermelho Ameripan (Destaque) */
            --bg-color: #f4f6f8;
            --input-bg: #ffffff;
            --text-color: #333;
        }

        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
        
        body {
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            margin: 0;
            padding: 0;
            color: var(--text-color);
            padding-bottom: 40px;
        }

        /* Header Estilizado */
        header {
            background: linear-gradient(135deg, var(--primary-color) 0%, #004080 100%);
            color: white;
            padding: 20px 15px;
            text-align: center;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            border-bottom: 4px solid var(--accent-color);
        }
        header h1 { margin: 0; font-size: 1.2rem; text-transform: uppercase; letter-spacing: 1px; }
        header p { margin: 5px 0 0; font-size: 0.8rem; opacity: 0.8; }

        .container {
            max-width: 600px;
            margin: -20px auto 0;
            padding: 0 15px;
            position: relative;
            z-index: 10;
        }

        /* Cart√µes de Conte√∫do */
        .card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            margin-bottom: 20px;
        }

        .card-title {
            color: var(--primary-color);
            border-left: 4px solid var(--accent-color);
            padding-left: 10px;
            margin-top: 0;
            margin-bottom: 15px;
            font-size: 1.1rem;
            font-weight: 700;
        }

        /* Inputs Modernos */
        .form-group { margin-bottom: 15px; position: relative; }
        label { display: block; margin-bottom: 6px; font-weight: 600; color: #555; font-size: 0.9rem; }
        
        input, select, textarea {
            width: 100%;
            padding: 14px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 16px; /* Tamanho bom para mobile */
            background-color: var(--input-bg);
            transition: border-color 0.3s, box-shadow 0.3s;
        }

        input:focus, select:focus, textarea:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(0, 51, 102, 0.1);
        }

        textarea { resize: vertical; min-height: 80px; }

        /* Estilo para Readonly (Campos travados) */
        input[readonly] { background-color: #e9ecef; color: #666; cursor: not-allowed; }

        /* Bot√µes de Sele√ß√£o (Sim/N√£o) */
        .toggle-group { display: flex; gap: 10px; }
        .toggle-btn {
            flex: 1;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background: white;
            text-align: center;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
        }
        .toggle-btn.selected {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        /* Inputs de Arquivo Customizados */
        .file-input-wrapper {
            position: relative;
            background: #f8f9fa;
            border: 2px dashed #ccc;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            margin-bottom: 10px;
            transition: 0.3s;
        }
        .file-input-wrapper:active { background: #eef; border-color: var(--primary-color); }
        .file-label-icon { font-size: 24px; display: block; margin-bottom: 5px; }
        input[type="file"] {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; opacity: 0; cursor: pointer;
        }

        /* Bot√£o Salvar */
        .btn-submit {
            width: 100%;
            background-color: #28a745; /* Verde Sucesso */
            color: white;
            padding: 16px;
            font-size: 1.1rem;
            font-weight: bold;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);
            transition: transform 0.2s;
            text-transform: uppercase;
        }
        .btn-submit:active { transform: scale(0.98); }

        /* OVERLAY DE LOADING (Bloqueio de Tela) */
        #loadingOverlay {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255, 255, 255, 0.95);
            z-index: 9999;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
        }
        .spinner {
            width: 50px; height: 50px;
            border: 5px solid #eee;
            border-top: 5px solid var(--accent-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        .loading-text { color: var(--primary-color); font-weight: bold; font-size: 1.2rem; }
        .loading-subtext { color: #666; margin-top: 10px; font-size: 0.9rem; }
        
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    </style>
</head>
<body>

    <header>
        <h1>Ameripan Distribuidora</h1>
        <p>Execu√ß√£o de Trabalhos T√©cnicos</p>
    </header>

    <div class="container">
        <form id="visitaForm">
            
            <div class="card">
                <h3 class="card-title">üë§ Identifica√ß√£o</h3>
                
                <div class="form-group">
                    <label>Vendedor Respons√°vel</label>
                    <input list="vendedores-list" name="vendedor" id="inputVendedor" placeholder="Selecione ou Digite seu nome..." required>
                    <datalist id="vendedores-list">
                        <option value="EMANUEL RUFINO DA SILVA">
                        <option value="JORDANO SALOMAO VELICO">
                        <option value="EDIMAR PINHEIRO COSTA">
                        <option value="MARCELO SANTANA NOVAES">
                        <option value="GABRIELA BARBOSA">
                        <option value="VINICIUS HENRIQUE RODRIGUES DE OLIVEIRA">
                        <option value="MAURICIO EXEL FERREIRA">
                        <option value="SERGIO CARRERA LUCCHESI">
                    </datalist>
                </div>

                <div class="form-group">
                    <label>T√©cnica Respons√°vel</label>
                    <input list="tecnicas-list" name="tecnica" id="inputTecnica" value="THAIS GOMES DA SILVA" placeholder="Selecione ou Digite..." required>
                    <datalist id="tecnicas-list">
                        <option value="THAIS GOMES DA SILVA">
                        <option value="VERA LUCIA">
                        <option value="WAGNER PIRES DO NASCIMENTO">
                        <option value="THIAGO JOS√â DE MORAIS">
                        <option value="EMERSON LARANJEIRA PEREIRA">
                        <option value="SUSI KELLY CREMONESI LEITE">
                    </datalist>
                </div>

                <div class="form-group">
                    <label>Data da Visita</label>
                    <input type="date" id="dataVisita" name="dataVisita" required>
                </div>
            </div>

            <div class="card">
                <h3 class="card-title">üè¢ Dados do Cliente</h3>
                <div class="form-group">
                    <label>C√≥digo do Cliente</label>
                    <input type="number" name="codCliente" required placeholder="Ex: 47162">
                </div>
                <div class="form-group">
                    <label>Nome Fantasia</label>
                    <input type="text" name="nomeFantasia" required placeholder="Ex: Sorveteria Paviotti">
                </div>
                <div class="form-group">
                    <label>Telefone / WhatsApp</label>
                    <input type="tel" name="telefone" placeholder="(19) 99999-9999">
                </div>
                <div class="form-group">
                    <label>Participantes (Nome - Cargo)</label>
                    <textarea name="pessoas" rows="2" placeholder="Ex: Jo√£o - Dono"></textarea>
                </div>
            </div>

            <div class="card">
                <h3 class="card-title">üìã Relat√≥rio</h3>
                
                <div class="form-group">
                    <label>Motivo da Visita</label>
                    <input list="motivos-list" name="motivo" placeholder="Selecione ou Digite..." required>
                    <datalist id="motivos-list">
                        <option value="INTRODU√á√ÉO DE PRODUTO">
                        <option value="VISITA T√âCNICA">
                        <option value="VENDA / REPOSI√á√ÉO">
                        <option value="COBRAN√áA">
                        <option value="CORTESIA / RELACIONAMENTO">
                        <option value="PROSPEC√á√ÉO">
                    </datalist>
                </div>

                <div class="form-group">
                    <label>Produtos Utilizados</label>
                    <textarea name="produtos" rows="3"></textarea>
                </div>

                <div class="form-group">
                    <label>Oportunidades</label>
                    <textarea name="oportunidades" rows="2"></textarea>
                </div>

                <div class="form-group">
                    <label>Feedback do Trabalho</label>
                    <textarea name="feedback" rows="3" required placeholder="Descreva o resultado..."></textarea>
                </div>

                <div class="form-group">
                    <label>Fez Pedido?</label>
                    <div class="toggle-group">
                        <div class="toggle-btn selected" id="btnNao" onclick="setPedido('NAO')">N√£o</div>
                        <div class="toggle-btn" id="btnSim" onclick="setPedido('SIM')">Sim</div>
                    </div>
                    <input type="hidden" name="fezPedido" id="inputFezPedido" value="NAO">
                </div>
                
                <div id="campoCodPedido" style="display: none; margin-top: 15px;">
                    <label>C√≥digo do Pedido / Obs</label>
                    <input type="text" id="inputCodPedido" name="codPedido" placeholder="Digite o c√≥digo...">
                </div>
            </div>

            <div class="card">
                <h3 class="card-title">üì∏ Registro Visual</h3>
                
                <div class="file-input-wrapper">
                    <span class="file-label-icon">üì∑</span>
                    <span id="labelFotos">Toque para adicionar Fotos</span>
                    <input type="file" id="inputFotos" multiple accept="image/*" onchange="atualizarLabel('Fotos')">
                </div>

                <div class="file-input-wrapper">
                    <span class="file-label-icon">üé•</span>
                    <span id="labelVideos">Toque para adicionar V√≠deos</span>
                    <input type="file" id="inputVideos" multiple accept="video/*" onchange="atualizarLabel('Videos')">
                </div>
            </div>

            <button type="button" class="btn-submit" onclick="enviarFormulario()">üíæ GRAVAR DADOS</button>
            <br><br>
        </form>
    </div>

    <div id="loadingOverlay">
        <div class="spinner"></div>
        <div class="loading-text">ENVIANDO DADOS...</div>
        <div class="loading-subtext">‚ö†Ô∏è Por favor, <b>N√ÉO</b> saia desta p√°gina.</div>
        <div class="loading-subtext">Aguarde a confirma√ß√£o.</div>
    </div>

    <script>
        // *** INSIRA SUA URL DO APPS SCRIPT AQUI ***
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyGx9K186KXJ75L-mLz1xaEt8VRvv3a48bNPmBaAnVz3pja7wnPNmr7DObrOdWfbnHU/exec";

        // Inicializa√ß√£o
        window.onload = function() {
            const hoje = new Date().toISOString().split('T')[0];
            document.getElementById('dataVisita').value = hoje;

            // Recupera √∫ltimo vendedor e t√©cnica salvos
            const vendedorSalvo = localStorage.getItem('vendedor_ameripan');
            if (vendedorSalvo) document.getElementById('inputVendedor').value = vendedorSalvo;

            const tecnicaSalva = localStorage.getItem('tecnica_ameripan');
            if (tecnicaSalva) document.getElementById('inputTecnica').value = tecnicaSalva;
            else document.getElementById('inputTecnica').value = "THAIS GOMES DA SILVA";
        };

        // UI: Toggle Pedido
        function setPedido(valor) {
            document.getElementById('inputFezPedido').value = valor;
            const divPedido = document.getElementById('campoCodPedido');
            const btnSim = document.getElementById('btnSim');
            const btnNao = document.getElementById('btnNao');

            if (valor === 'SIM') {
                btnSim.classList.add('selected');
                btnNao.classList.remove('selected');
                divPedido.style.display = 'block';
                document.getElementById('inputCodPedido').focus();
            } else {
                btnSim.classList.remove('selected');
                btnNao.classList.add('selected');
                divPedido.style.display = 'none';
                document.getElementById('inputCodPedido').value = "";
            }
        }

        // UI: Feedback visual de arquivos selecionados
        function atualizarLabel(tipo) {
            const input = document.getElementById('input' + tipo);
            const label = document.getElementById('label' + tipo);
            const qtd = input.files.length;
            if(qtd > 0) {
                label.innerText = `${qtd} arquivo(s) selecionado(s)`;
                label.style.fontWeight = "bold";
                label.style.color = "#003366";
            } else {
                label.innerText = `Toque para adicionar ${tipo}`;
                label.style.fontWeight = "normal";
                label.style.color = "#333";
            }
        }

        async function enviarFormulario() {
            const form = document.getElementById('visitaForm');
            const overlay = document.getElementById('loadingOverlay');

            // Valida√ß√£o B√°sica
            if(!form.codCliente.value || !form.nomeFantasia.value || !form.vendedor.value || !form.tecnica.value) {
                alert("‚ö†Ô∏è Por favor, preencha: Vendedor, T√©cnica, C√≥d. Cliente e Nome Fantasia.");
                return;
            }

            // Salva prefer√™ncias
            localStorage.setItem('vendedor_ameripan', form.vendedor.value);
            localStorage.setItem('tecnica_ameripan', form.tecnica.value);

            // ATIVAR BLOQUEIO DE TELA
            overlay.style.display = 'flex';
            
            // Desabilitar Inputs via JS para garantir
            const elementos = form.elements;
            for (let i = 0; i < elementos.length; i++) {
                elementos[i].disabled = true;
            }

            try {
                // Processamento de M√≠dia
                const inputFotos = document.getElementById('inputFotos');
                const inputVideos = document.getElementById('inputVideos');
                
                let todosArquivos = [
                    ...Array.from(inputFotos.files), 
                    ...Array.from(inputVideos.files)
                ];

                let listaArquivosProcessados = [];
                if (todosArquivos.length > 0) {
                    listaArquivosProcessados = await Promise.all(todosArquivos.map(lerArquivo));
                }

                // Info Pedido
                const infoPedido = form.fezPedido.value === "SIM" ? 
                                ("SIM - C√≥d: " + document.getElementById('inputCodPedido').value) : 
                                "N√ÉO";

                const payload = {
                    vendedor: form.vendedor.value,
                    tecnica: form.tecnica.value, // Novo Campo
                    codCliente: form.codCliente.value,
                    nomeFantasia: form.nomeFantasia.value,
                    telefone: form.telefone.value,
                    pessoas: form.pessoas.value,
                    motivo: form.motivo.value,
                    produtos: form.produtos.value,
                    oportunidades: form.oportunidades.value,
                    feedback: form.feedback.value,
                    dataVisita: form.dataVisita.value,
                    infoPedido: infoPedido,
                    arquivos: listaArquivosProcessados
                };

                await fetch(SCRIPT_URL, {
                    method: "POST",
                    mode: "no-cors",
                    headers: { "Content-Type": "text/plain;charset=utf-8" },
                    body: JSON.stringify(payload)
                });

                // SUCESSO
                alert("‚úÖ DADOS ENVIADOS COM SUCESSO!");
                
                // Resetar UI
                const vendedorSalvo = form.vendedor.value;
                const tecnicaSalva = form.tecnica.value;
                form.reset();
                form.vendedor.value = vendedorSalvo;
                form.tecnica.value = tecnicaSalva;
                
                // Limpar Inputs de Arquivo visualmente
                inputFotos.value = ""; inputVideos.value = "";
                atualizarLabel('Fotos'); atualizarLabel('Videos');
                
                // Reseta Data e Bot√µes
                document.getElementById('dataVisita').value = new Date().toISOString().split('T')[0];
                setPedido('NAO');

            } catch (erro) {
                console.error(erro);
                alert("‚ùå Erro ao enviar: " + erro + "\nVerifique sua conex√£o e tente novamente.");
            } finally {
                // DESBLOQUEAR TELA
                overlay.style.display = 'none';
                for (let i = 0; i < elementos.length; i++) {
                    elementos[i].disabled = false;
                }
            }
        }

        function lerArquivo(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve({
                    nome: file.name,
                    mimeType: file.type,
                    conteudo: reader.result.split(',')[1]
                });
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }
    </script>
</body>
</html>
