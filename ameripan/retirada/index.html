<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>Autorização de Retirada - Ameripan</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&family=Poppins:wght@300;400;500;600&display=swap');
        
        :root {
            --primary-color: #0066aa;
            --secondary-color: #e67817;
            --accent-color: #0088cc;
            --light-bg: #f8f9fa;
            --dark-bg: #2c3e50;
            --text-color: #333;
            --light-text: #6c757d;
            --border-color: #dee2e6;
            --success-color: #28a745;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        /* Fix para evitar zoom em inputs no iOS */
        input, textarea, select {
            font-size: 16px;
        }
        
        body {
            font-family: 'Arial', sans-serif;
            max-width: 100%;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
            line-height: 1.6;
            touch-action: manipulation;
        }
        
        .container {
            background-color: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
            max-width: 800px;
            margin: 0 auto;
        }
        
        .brand-header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .logo-container {
            margin-bottom: 15px;
        }
        
        .logo {
            max-width: 200px;
            height: auto;
        }
        
        .brand-slogan {
            font-family: 'Montserrat', sans-serif;
            font-style: italic;
            color: var(--secondary-color);
            font-size: 1.2em;
            font-weight: 500;
            margin-bottom: 15px;
        }
        
        h1 {
            text-align: center;
            margin-bottom: 30px;
            font-size: 1.5rem;
            color: var(--primary-color);
            padding: 15px 0;
            border-top: 1px solid var(--border-color);
            border-bottom: 1px solid var(--border-color);
            font-family: 'Montserrat', sans-serif;
        }
        
        .form-content {
            font-size: 16px;
            line-height: 1.8;
            margin-bottom: 30px;
        }
        
        .field {
            border-bottom: 1px solid #333;
            display: inline-block;
            min-width: 150px;
            padding: 0 5px;
            position: relative;
        }
        
        .field-input {
            border: none;
            outline: none;
            width: 100%;
            background: transparent;
            font-family: 'Arial', sans-serif;
            padding: 2px 0;
        }
        
        .spacer {
            margin-bottom: 20px;
        }
        
        .footer-row {
            display: flex;
            justify-content: space-between;
            margin-top: 50px;
        }
        
        .date-field {
            display: inline-block;
            width: 80px;
            text-align: center;
            border-bottom: 1px solid #333;
        }
        
        .date-field input {
            width: 100%;
            text-align: center;
            border: none;
            outline: none;
            background: transparent;
            font-family: 'Arial', sans-serif;
        }
        
        .signature-section {
            margin-top: 30px;
            text-align: center;
        }
        
        .signature-pad-container {
            border: 1px solid #ccc;
            margin: 0 auto;
            width: 100%;
            max-width: 500px;
            height: 150px;
            position: relative;
            background-color: #fff;
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            touch-action: none;
            -webkit-tap-highlight-color: transparent;
        }
        
        #signature-pad {
            width: 100%;
            height: 100%;
            touch-action: none;
            cursor: crosshair;
        }
        
        .signature-line {
            width: 100%;
            max-width: 500px;
            margin: 10px auto;
            border-top: 1px solid #333;
            padding-top: 5px;
            font-size: 14px;
            color: #555;
            text-align: center;
        }
        
        .signature-message {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #aaa;
            font-size: 1rem;
            text-align: center;
            pointer-events: none;
            user-select: none;
            opacity: 0.7;
        }
        
        .controls {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            justify-content: center;
        }
        
        .button {
            padding: 10px 15px;
            background-color: #0066aa;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
        }
        
        .button:hover {
            background-color: #0055aa;
        }
        
        .button.clear-button {
            background-color: #f44336;
        }
        
        .button.export-button {
            background-color: #28a745;
            margin-top: 20px;
        }
        
        /* Modal de assinatura */
        .signature-modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.6);
            z-index: 1000;
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
        }
        
        .signature-modal {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 90%;
            max-width: 600px;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            padding: 20px;
            z-index: 1001;
        }
        
        .signature-modal-title {
            text-align: center;
            font-size: 1.2rem;
            margin-bottom: 15px;
            color: var(--primary-color);
            font-weight: bold;
        }
        
        .signature-modal-canvas-container {
            border: 1px solid #ccc;
            width: 100%;
            height: 300px;
            background-color: #fff;
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            touch-action: none;
            -webkit-tap-highlight-color: transparent;
            margin-bottom: 20px;
            position: relative;
        }
        
        #signature-modal-canvas {
            width: 100%;
            height: 100%;
            touch-action: none;
        }
        
        .signature-modal-message {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #aaa;
            font-size: 1.2rem;
            text-align: center;
            pointer-events: none;
            user-select: none;
            opacity: 0.7;
        }
        
        .signature-modal-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
        }
        
        .modal-btn {
            padding: 12px 20px;
            border-radius: 5px;
            border: none;
            color: white;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 120px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.15);
        }
        
        .modal-btn:active {
            transform: translateY(1px);
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }
        
        .modal-btn-confirm {
            background-color: #28a745;
        }
        
        .modal-btn-clear {
            background-color: #f44336;
        }
        
        .modal-btn-cancel {
            background-color: #6c757d;
        }
        
        .modal-btn-icon {
            margin-right: 8px;
            font-size: 18px;
        }
        
        /* Suporte para orientação paisagem */
        @media (orientation: landscape) {
            .signature-modal {
                width: 80%;
                max-width: 800px;
                display: flex;
                flex-direction: column;
                max-height: 90vh;
            }
            
            .signature-modal-canvas-container {
                height: 250px;
                flex-grow: 1;
                margin-bottom: 15px;
            }
        }
        
        /* Classe para elementos que não devem aparecer no PDF */
        .no-print {
            /* Classe vazia, será manipulada via JavaScript antes da impressão */
        }
        
        @media print {
            .no-print {
                display: none !important;
            }
        }
        
        /* Mensagem de sucesso com overlay */
        .success-message {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.9);
            z-index: 2000;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }
        
        .success-content {
            background-color: #28a745;
            color: white;
            padding: 30px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            max-width: 80%;
        }
        
        .success-icon {
            font-size: 60px;
            margin-bottom: 20px;
        }
        
        #output-pdf {
            display: none;
            width: 100%;
            height: 500px;
            margin-top: 20px;
            border: 1px solid #ccc;
        }
        
        .company-info {
            text-align: center;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid var(--border-color);
            color: var(--light-text);
            font-size: 0.9em;
        }
        
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            
            .container {
                padding: 20px;
            }
            
            .footer-row {
                flex-direction: column;
                gap: 20px;
            }
            
            .button {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container" id="print-content">
        <div class="brand-header">
            <div class="logo-container">
                <img src="https://raw.githubusercontent.com/Edimarpcosta/edimarpcosta.github.io/refs/heads/main/ameripan/retirada/logo.webp" alt="Ameripan Logo" class="logo" crossorigin="anonymous">
            </div>
            <p class="brand-slogan">Ameripan, mais sabor ao seu negócio!</p>
        </div>
        
        <h1>🔹 AUTORIZAÇÃO DE RETIRADA DE MERCADORIA NA AMERIPAN 🔹</h1>
        
        <div class="form-content">
            Eu, <span class="field"><input type="text" class="field-input" id="nome"></span>, portador do CPF <span class="field"><input type="text" class="field-input" id="cpf"></span>, <br>
            proprietario da empresa <span class="field"><input type="text" class="field-input" id="empresa"></span>, autorizo o Sr(a) <br>
            <span class="field"><input type="text" class="field-input" id="autorizado"></span> a retirar o(s) pedido(s) <br>
            <span class="field"><input type="text" class="field-input" id="pedidos"></span>, no valor total de R$ <span class="field"><input type="text" class="field-input" id="valor"></span> no Depósito da <br>
            empresa Ameripan na rua Purus nº 652 Bairro jd São Roque.
        </div>
        
        <div class="footer-row">
            <div>
                <span class="field"><input type="text" class="field-input" id="cidade"></span>, 
                <span class="date-field"><input type="text" id="dia" maxlength="2" placeholder="Dia"></span> de 
                <span class="date-field"><input type="text" id="mes" placeholder="Mês"></span> de 
                <span class="date-field"><input type="text" id="ano" maxlength="4" placeholder="Ano"></span>
                <div style="margin-top: 5px; font-size: 14px;">Cidade Data</div>
            </div>
        </div>
        
        <div class="signature-section">
            <div class="signature-pad-container" id="signature-container">
                <canvas id="signature-pad"></canvas>
                <div class="signature-message" id="signature-message">Assine aqui</div>
            </div>
            <div class="signature-line">
                Assinatura do proprietario da empresa
            </div>
            
            <div class="controls no-print">
                <button class="button clear-button" id="clear-signature">Limpar</button>
                <button class="button" id="expand-signature">Expandir</button>
            </div>
        </div>
        
        <div class="company-info">
            <p>CNPJ: 65.029.035/0001-07</p>
            <p>Rua Purus nº 652, Bairro Jd. São Roque, Americana, SP</p>
        </div>
    </div>
    
    <div style="text-align: center; margin-top: 20px;" class="no-print">
        <button class="button export-button" id="export-pdf">
            Gerar PDF
        </button>
    </div>
    
    <iframe id="output-pdf" class="no-print"></iframe>
    
    <!-- Modal para assinatura expandida (popup) -->
    <div class="signature-modal-overlay no-print" id="signature-modal-overlay">
        <div class="signature-modal">
            <div class="signature-modal-title">Assinatura</div>
            <div class="signature-modal-canvas-container">
                <canvas id="signature-modal-canvas"></canvas>
                <div class="signature-modal-message" id="signature-modal-message">Assine aqui</div>
            </div>
            <div class="signature-modal-buttons">
                <button class="modal-btn modal-btn-confirm" id="modal-confirm">
                    <span class="modal-btn-icon">✓</span> Confirmar
                </button>
                <button class="modal-btn modal-btn-clear" id="modal-clear">
                    <span class="modal-btn-icon">✗</span> Limpar
                </button>
                <button class="modal-btn modal-btn-cancel" id="modal-cancel">
                    <span class="modal-btn-icon">←</span> Voltar
                </button>
            </div>
        </div>
    </div>
    
    <div class="success-message no-print" id="success-message">
        <div class="success-content">
            <div class="success-icon">✓</div>
            <h2>PDF Gerado com Sucesso!</h2>
            <p>O download foi iniciado automaticamente.</p>
        </div>
    </div>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // ------------------------------------------------------------------------
            // INICIALIZAÇÃO DE ELEMENTOS E VARIÁVEIS
            // ------------------------------------------------------------------------
            // Elementos do DOM principal
            const canvas = document.getElementById('signature-pad');
            const signatureMessage = document.getElementById('signature-message');
            const clearButton = document.getElementById('clear-signature');
            const expandButton = document.getElementById('expand-signature');
            const signatureContainer = document.getElementById('signature-container');
            const exportButton = document.getElementById('export-pdf');
            const successMessage = document.getElementById('success-message');
            
            // Elementos do modal de assinatura
            const modalOverlay = document.getElementById('signature-modal-overlay');
            const modalCanvas = document.getElementById('signature-modal-canvas');
            const modalMessage = document.getElementById('signature-modal-message');
            const modalConfirmBtn = document.getElementById('modal-confirm');
            const modalClearBtn = document.getElementById('modal-clear');
            const modalCancelBtn = document.getElementById('modal-cancel');
            
            // Contextos de desenho e variáveis de estado
            const ctx = canvas.getContext('2d');
            const modalCtx = modalCanvas.getContext('2d');
            let isDrawing = false;
            let lastX = 0;
            let lastY = 0;
            let hasSignature = false;
            let hasModalSignature = false;
            
            // ------------------------------------------------------------------------
            // PREVENÇÃO DE COMPORTAMENTOS INDESEJADOS EM TOUCH
            // ------------------------------------------------------------------------
            document.addEventListener('touchmove', function(e) {
                if (e.target.id !== 'signature-pad' && e.target.id !== 'signature-modal-canvas') {
                    e.preventDefault();
                }
            }, { passive: false });
            
            // Evitar zoom duplo toque
            document.addEventListener('dblclick', function(e) {
                e.preventDefault();
            });
            
            // Impedir comportamentos de pinça/zoom nas áreas de assinatura
            const preventGestures = (element) => {
                if (element) {
                    element.addEventListener('gesturestart', function(e) {
                        e.preventDefault();
                    }, { passive: false });
                    
                    element.addEventListener('gesturechange', function(e) {
                        e.preventDefault();
                    }, { passive: false });
                    
                    element.addEventListener('gestureend', function(e) {
                        e.preventDefault();
                    }, { passive: false });
                }
            };
            
            preventGestures(canvas);
            preventGestures(modalCanvas);
            
            // ------------------------------------------------------------------------
            // FUNÇÕES PARA CANVAS PRINCIPAL
            // ------------------------------------------------------------------------
            // Ajustar o tamanho do canvas com base no container
            function resizeCanvas() {
                // Obter as dimensões reais do container
                const containerWidth = canvas.parentElement.clientWidth;
                const containerHeight = canvas.parentElement.clientHeight;
                
                // Definir o estilo de width/height para garantir precisão
                canvas.style.width = containerWidth + 'px';
                canvas.style.height = containerHeight + 'px';
                
                // Usar devicePixelRatio para melhorar a nitidez
                const dpr = window.devicePixelRatio || 1;
                
                // Definir as dimensões reais do canvas
                canvas.width = containerWidth * dpr;
                canvas.height = containerHeight * dpr;
                
                // Escalar o contexto para corresponder ao devicePixelRatio
                ctx.scale(dpr, dpr);
                
                // Configurar o estilo do canvas - CANETA AZUL
                ctx.lineWidth = 2.5;
                ctx.lineCap = 'round';
                ctx.lineJoin = 'round';
                ctx.strokeStyle = '#0066cc'; // Cor azul de caneta esferográfica
            }
            
            // Converter coordenadas precisas
            function getCanvasCoordinates(element, clientX, clientY) {
                const rect = element.getBoundingClientRect();
                
                // A razão entre o tamanho do canvas no DOM e seu tamanho real
                const scaleX = element.width / rect.width;
                const scaleY = element.height / rect.height;
                
                // Aplicar escala do devicePixelRatio para corrigir imprecisões
                const dpr = window.devicePixelRatio || 1;
                
                // Calcular as coordenadas precisas
                return {
                    x: (clientX - rect.left) * (scaleX / dpr),
                    y: (clientY - rect.top) * (scaleY / dpr)
                };
            }
            
            // Iniciar o desenho no canvas principal
            function startDrawing(e) {
                e.preventDefault();
                
                let clientX, clientY;
                
                // Obter coordenadas do cliente para dispositivos touch e mouse
                if (e.type === 'touchstart') {
                    clientX = e.touches[0].clientX;
                    clientY = e.touches[0].clientY;
                } else {
                    clientX = e.clientX;
                    clientY = e.clientY;
                }
                
                // Converter para coordenadas precisas do canvas
                const coords = getCanvasCoordinates(canvas, clientX, clientY);
                lastX = coords.x;
                lastY = coords.y;
                
                isDrawing = true;
                hasSignature = true;
                signatureMessage.style.display = 'none';
                
                // Iniciar o caminho no ponto de contato
                ctx.beginPath();
                ctx.moveTo(lastX, lastY);
                ctx.lineTo(lastX, lastY);
                ctx.stroke();
            }
            
            // Desenhar no canvas principal
            function draw(e) {
                if (!isDrawing) return;
                e.preventDefault();
                
                let clientX, clientY;
                
                // Obter coordenadas do cliente para dispositivos touch e mouse
                if (e.type === 'touchmove') {
                    clientX = e.touches[0].clientX;
                    clientY = e.touches[0].clientY;
                } else {
                    clientX = e.clientX;
                    clientY = e.clientY;
                }
                
                // Converter para coordenadas precisas do canvas
                const coords = getCanvasCoordinates(canvas, clientX, clientY);
                const currentX = coords.x;
                const currentY = coords.y;
                
                // Desenhar a linha com suavização para movimentos rápidos
                ctx.beginPath();
                ctx.moveTo(lastX, lastY);
                
                // Usar coordenadas intermediárias para suavizar a linha
                const dx = currentX - lastX;
                const dy = currentY - lastY;
                const distance = Math.sqrt(dx * dx + dy * dy);
                
                if (distance > 5) {
                    // Para movimentos rápidos, criar pontos intermediários
                    const steps = Math.floor(distance / 2);
                    for (let i = 1; i < steps; i++) {
                        const t = i / steps;
                        const x = lastX + dx * t;
                        const y = lastY + dy * t;
                        ctx.lineTo(x, y);
                    }
                }
                
                ctx.lineTo(currentX, currentY);
                ctx.stroke();
                
                lastX = currentX;
                lastY = currentY;
            }
            
            // Parar o desenho
            function stopDrawing() {
                isDrawing = false;
            }
            
            // Limpar a assinatura no canvas principal
            function clearSignature() {
                // Limpar todo o canvas considerando o devicePixelRatio
                const dpr = window.devicePixelRatio || 1;
                ctx.save();
                ctx.setTransform(1, 0, 0, 1, 0, 0);
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.restore();
                
                signatureMessage.style.display = 'block';
                signatureMessage.textContent = 'Assine aqui';
                signatureMessage.style.color = '#aaa';
                signatureContainer.style.borderColor = '#ccc';
                hasSignature = false;
                
                // Redimensionar para garantir consistência
                resizeCanvas();
            }
            
            // ------------------------------------------------------------------------
            // FUNÇÕES PARA MODAL DE ASSINATURA
            // ------------------------------------------------------------------------
            // Ajustar o tamanho do canvas do modal
            function resizeModalCanvas() {
                // Obter as dimensões reais do container do modal
                const containerWidth = modalCanvas.parentElement.clientWidth;
                const containerHeight = modalCanvas.parentElement.clientHeight;
                
                // Definir o estilo de width/height para garantir precisão
                modalCanvas.style.width = containerWidth + 'px';
                modalCanvas.style.height = containerHeight + 'px';
                
                // Usar devicePixelRatio para melhorar a nitidez
                const dpr = window.devicePixelRatio || 1;
                
                // Definir as dimensões reais do canvas
                modalCanvas.width = containerWidth * dpr;
                modalCanvas.height = containerHeight * dpr;
                
                // Escalar o contexto para corresponder ao devicePixelRatio
                modalCtx.scale(dpr, dpr);
                
                // Configurar o estilo do canvas - CANETA AZUL
                modalCtx.lineWidth = 2.5;
                modalCtx.lineCap = 'round';
                modalCtx.lineJoin = 'round';
                modalCtx.strokeStyle = '#0066cc'; // Cor azul de caneta esferográfica
            }
            
            // Iniciar o desenho no modal
            function startModalDrawing(e) {
                e.preventDefault();
                
                let clientX, clientY;
                
                // Obter coordenadas do cliente para dispositivos touch e mouse
                if (e.type === 'touchstart') {
                    clientX = e.touches[0].clientX;
                    clientY = e.touches[0].clientY;
                } else {
                    clientX = e.clientX;
                    clientY = e.clientY;
                }
                
                // Converter para coordenadas precisas do canvas
                const coords = getCanvasCoordinates(modalCanvas, clientX, clientY);
                lastX = coords.x;
                lastY = coords.y;
                
                isDrawing = true;
                hasModalSignature = true;
                modalMessage.style.display = 'none';
                
                // Iniciar o caminho no ponto de contato
                modalCtx.beginPath();
                modalCtx.moveTo(lastX, lastY);
                modalCtx.lineTo(lastX, lastY);
                modalCtx.stroke();
            }
            
            // Desenhar no modal
            function drawModal(e) {
                if (!isDrawing) return;
                e.preventDefault();
                
                let clientX, clientY;
                
                // Obter coordenadas do cliente para dispositivos touch e mouse
                if (e.type === 'touchmove') {
                    clientX = e.touches[0].clientX;
                    clientY = e.touches[0].clientY;
                } else {
                    clientX = e.clientX;
                    clientY = e.clientY;
                }
                
                // Converter para coordenadas precisas do canvas
                const coords = getCanvasCoordinates(modalCanvas, clientX, clientY);
                const currentX = coords.x;
                const currentY = coords.y;
                
                // Desenhar a linha com suavização para movimentos rápidos
                modalCtx.beginPath();
                modalCtx.moveTo(lastX, lastY);
                
                // Usar coordenadas intermediárias para suavizar a linha
                const dx = currentX - lastX;
                const dy = currentY - lastY;
                const distance = Math.sqrt(dx * dx + dy * dy);
                
                if (distance > 5) {
                    // Para movimentos rápidos, criar pontos intermediários
                    const steps = Math.floor(distance / 2);
                    for (let i = 1; i < steps; i++) {
                        const t = i / steps;
                        const x = lastX + dx * t;
                        const y = lastY + dy * t;
                        modalCtx.lineTo(x, y);
                    }
                }
                
                modalCtx.lineTo(currentX, currentY);
                modalCtx.stroke();
                
                lastX = currentX;
                lastY = currentY;
            }
            
            // Limpar a assinatura no modal
            function clearModalSignature() {
                // Limpar todo o canvas considerando o devicePixelRatio
                const dpr = window.devicePixelRatio || 1;
                modalCtx.save();
                modalCtx.setTransform(1, 0, 0, 1, 0, 0);
                modalCtx.clearRect(0, 0, modalCanvas.width, modalCanvas.height);
                modalCtx.restore();
                
                modalMessage.style.display = 'block';
                modalMessage.textContent = 'Assine aqui';
                modalMessage.style.color = '#aaa';
                hasModalSignature = false;
                
                // Redimensionar para garantir consistência
                resizeModalCanvas();
            }
            
            // Abrir o modal de assinatura
            function openSignatureModal() {
                // Se já existe uma assinatura no canvas principal, transferir para o modal
                if (hasSignature) {
                    const mainSignatureData = canvas.toDataURL();
                    clearModalSignature();
                    
                    const img = new Image();
                    img.onload = function() {
                        const dpr = window.devicePixelRatio || 1;
                        const targetWidth = modalCanvas.width / dpr;
                        const targetHeight = modalCanvas.height / dpr;
                        
                        modalCtx.drawImage(img, 0, 0, targetWidth, targetHeight);
                        hasModalSignature = true;
                        modalMessage.style.display = 'none';
                    };
                    img.src = mainSignatureData;
                } else {
                    clearModalSignature();
                }
                
                // Exibir o modal
                modalOverlay.style.display = 'block';
                
                // Atualizar o tamanho do canvas do modal
                setTimeout(resizeModalCanvas, 10);
                
                // Adicionar eventos de desenho ao canvas do modal
                modalCanvas.addEventListener('mousedown', startModalDrawing);
                modalCanvas.addEventListener('mousemove', drawModal);
                modalCanvas.addEventListener('mouseup', stopDrawing);
                modalCanvas.addEventListener('mouseout', stopDrawing);
                
                modalCanvas.addEventListener('touchstart', startModalDrawing, { passive: false });
                modalCanvas.addEventListener('touchmove', drawModal, { passive: false });
                modalCanvas.addEventListener('touchend', stopDrawing);
                modalCanvas.addEventListener('touchcancel', stopDrawing);
            }
            
            // Fechar o modal de assinatura
            function closeSignatureModal(saveSignature) {
                // Se deve salvar a assinatura, transferir do modal para o canvas principal
                if (saveSignature && hasModalSignature) {
                    const modalSignatureData = modalCanvas.toDataURL();
                    clearSignature();
                    
                    const img = new Image();
                    img.onload = function() {
                        const dpr = window.devicePixelRatio || 1;
                        const targetWidth = canvas.width / dpr;
                        const targetHeight = canvas.height / dpr;
                        
                        ctx.drawImage(img, 0, 0, targetWidth, targetHeight);
                        hasSignature = true;
                        signatureMessage.style.display = 'none';
                    };
                    img.src = modalSignatureData;
                }
                
                // Esconder o modal
                modalOverlay.style.display = 'none';
                
                // Remover eventos de desenho do canvas do modal
                modalCanvas.removeEventListener('mousedown', startModalDrawing);
                modalCanvas.removeEventListener('mousemove', drawModal);
                modalCanvas.removeEventListener('mouseup', stopDrawing);
                modalCanvas.removeEventListener('mouseout', stopDrawing);
                
                modalCanvas.removeEventListener('touchstart', startModalDrawing);
                modalCanvas.removeEventListener('touchmove', drawModal);
                modalCanvas.removeEventListener('touchend', stopDrawing);
                modalCanvas.removeEventListener('touchcancel', stopDrawing);
            }
            
            // ------------------------------------------------------------------------
            // FORMATAÇÃO DE CAMPOS
            // ------------------------------------------------------------------------
            // Formatação de CPF
            const cpfInput = document.getElementById('cpf');
            if (cpfInput) {
                cpfInput.addEventListener('input', function(e) {
                    let value = e.target.value.replace(/\D/g, '');
                    if (value.length > 11) value = value.slice(0, 11);
                    
                    if (value.length > 9) {
                        value = value.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/, '$1.$2.$3-$4');
                    } else if (value.length > 6) {
                        value = value.replace(/(\d{3})(\d{3})(\d{3})/, '$1.$2.$3');
                    } else if (value.length > 3) {
                        value = value.replace(/(\d{3})(\d{3})/, '$1.$2');
                    }
                    
                    e.target.value = value;
                });
            }
            
            // Formatação de valor monetário
            const valorInput = document.getElementById('valor');
            if (valorInput) {
                valorInput.addEventListener('input', function(e) {
                    let value = e.target.value.replace(/\D/g, '');
                    
                    if (value === '') {
                        e.target.value = '';
                        return;
                    }
                    
                    // Converter para formato de moeda
                    value = (parseInt(value) / 100).toFixed(2).replace('.', ',');
                    e.target.value = value;
                });
            }
            
            // Formatação de dia (somente números e limite 2 dígitos)
            const diaInput = document.getElementById('dia');
            if (diaInput) {
                diaInput.addEventListener('input', function(e) {
                    let value = e.target.value.replace(/\D/g, '');
                    if (value.length > 0 && parseInt(value) > 31) {
                        value = '31';
                    }
                    e.target.value = value;
                });
            }
            
            // Formatação de ano (somente números e limite 4 dígitos)
            const anoInput = document.getElementById('ano');
            if (anoInput) {
                anoInput.addEventListener('input', function(e) {
                    let value = e.target.value.replace(/\D/g, '');
                    e.target.value = value;
                });
            }
            
            // ------------------------------------------------------------------------
            // INICIALIZAÇÃO E CONFIGURAÇÃO DA DATA PADRÃO
            // ------------------------------------------------------------------------
            function inicializarDataPadrao() {
                const hoje = new Date();
                const dia = hoje.getDate().toString().padStart(2, '0');
                const meses = [
                    'janeiro', 'fevereiro', 'março', 'abril', 'maio', 'junho',
                    'julho', 'agosto', 'setembro', 'outubro', 'novembro', 'dezembro'
                ];
                const mes = meses[hoje.getMonth()];
                const ano = hoje.getFullYear();
                
                // Preencher campos com valores sugeridos, mas deixando editáveis
                document.getElementById('dia').value = dia;
                document.getElementById('mes').value = mes;
                document.getElementById('ano').value = ano;
            }
            
            // ------------------------------------------------------------------------
            // EXPORTAR PARA PDF
            // ------------------------------------------------------------------------
            function exportarPDF() {
                // Verificar se campos obrigatórios estão preenchidos
                const requiredFields = ['nome', 'cpf', 'empresa', 'autorizado', 'pedidos', 'valor', 'cidade', 'dia', 'mes', 'ano'];
                let allFilled = true;
                
                requiredFields.forEach(function(field) {
                    const input = document.getElementById(field);
                    if (input && !input.value.trim()) {
                        allFilled = false;
                        if (field === 'dia' || field === 'mes' || field === 'ano') {
                            input.parentElement.style.borderBottom = '1px solid red';
                        } else {
                            input.parentElement.style.borderBottom = '1px solid red';
                        }
                    } else if (input) {
                        if (field === 'dia' || field === 'mes' || field === 'ano') {
                            input.parentElement.style.borderBottom = '1px solid #333';
                        } else {
                            input.parentElement.style.borderBottom = '1px solid #333';
                        }
                    }
                });
                
                // Verificar se há assinatura
                if (!hasSignature) {
                    allFilled = false;
                    signatureContainer.style.border = '1px solid red';
                    signatureMessage.style.color = 'red';
                    signatureMessage.style.display = 'block';
                    signatureMessage.textContent = 'Assinatura obrigatória';
                } else {
                    signatureContainer.style.border = '1px solid #ccc';
                }
                
                if (!allFilled) {
                    alert('Por favor, preencha todos os campos obrigatórios e assine o documento.');
                    return;
                }
                
                // Mostrar indicação de carregamento
                exportButton.disabled = true;
                exportButton.textContent = 'Gerando PDF...';
                
                // Processar o PDF com atraso para permitir atualização da UI
                setTimeout(function() {
                    // Ocultar temporariamente elementos que não devem aparecer no PDF
                    const noPrintElements = document.querySelectorAll('.no-print');
                    noPrintElements.forEach(element => {
                        element.style.display = 'none';
                    });
                    
                    // Criar o PDF otimizado
                    const { jsPDF } = window.jspdf;
                    const printContent = document.getElementById('print-content');
                    
                    html2canvas(printContent, {
                        scale: 1.2, // Fator de escala reduzido
                        useCORS: true,
                        allowTaint: true,
                        logging: false,
                        scrollY: -window.scrollY,
                        backgroundColor: '#fff',
                        imageTimeout: 0
                    }).then(canvas => {
                        // Compressão da imagem para JPEG com qualidade média-alta
                        const imgData = canvas.toDataURL('image/jpeg', 0.8);
                        
                        // Dimensões de uma folha A4 em mm (210x297)
                        const pageWidth = 210;
                        const pageHeight = 297;
                        
                        // Criar PDF com compressão ativada
                        const doc = new jsPDF({
                            orientation: 'portrait',
                            unit: 'mm',
                            format: 'a4',
                            compress: true
                        });
                        
                        // Calcular dimensões mantendo proporção
                        const margin = 10;
                        const contentWidth = pageWidth - (margin * 2);
                        const contentHeight = canvas.height * contentWidth / canvas.width;
                        
                        if (contentHeight > (pageHeight - (margin * 2))) {
                            // Se exceder, ajustar altura
                            const adjustedHeight = pageHeight - (margin * 2);
                            const adjustedWidth = canvas.width * adjustedHeight / canvas.height;
                            const xOffset = (pageWidth - adjustedWidth) / 2;
                            
                            doc.addImage(imgData, 'JPEG', xOffset, margin, adjustedWidth, adjustedHeight, null, 'FAST');
                        } else {
                            // Se não exceder, centralizar
                            const xOffset = (pageWidth - contentWidth) / 2;
                            doc.addImage(imgData, 'JPEG', xOffset, margin, contentWidth, contentHeight, null, 'FAST');
                        }
                        
                        // Fazer o download do PDF
                        const fileName = 'Autorização_Retirada_Ameripan_' + new Date().getTime() + '.pdf';
                        doc.save(fileName);
                        
                        // Restaurar elementos
                        noPrintElements.forEach(element => {
                            element.style.display = '';
                        });
                        
                        // Restaurar botão e mostrar mensagem de sucesso
                        exportButton.disabled = false;
                        exportButton.textContent = 'Gerar PDF';
                        
                        successMessage.style.display = 'flex';
                        setTimeout(function() {
                            successMessage.style.display = 'none';
                        }, 3000);
                    }).catch(error => {
                        console.error('Erro ao gerar PDF:', error);
                        alert('Ocorreu um erro ao gerar o PDF. Por favor, tente novamente.');
                        
                        // Restaurar elementos em caso de erro
                        noPrintElements.forEach(element => {
                            element.style.display = '';
                        });
                        
                        exportButton.disabled = false;
                        exportButton.textContent = 'Gerar PDF';
                    });
                }, 100);
            }
            
            // ------------------------------------------------------------------------
            // EVENTOS E INICIALIZAÇÃO
            // ------------------------------------------------------------------------
            // Inicializar o canvas e configurações
            window.addEventListener('load', function() {
                resizeCanvas();
                resizeModalCanvas();
                inicializarDataPadrao();
                
                // Verificar se deve abrir o modal em orientação paisagem
                checkOrientation();
            });
            
            // Verificar orientação e ajustar layout do modal
            function checkOrientation() {
                if (window.matchMedia("(orientation: landscape)").matches) {
                    document.querySelector('.signature-modal').classList.add('landscape');
                } else {
                    document.querySelector('.signature-modal').classList.remove('landscape');
                }
            }
            
            // Atualizar orientação quando a tela girar
            window.addEventListener('orientationchange', function() {
                setTimeout(function() {
                    checkOrientation();
                    resizeModalCanvas();
                }, 300);
            });
            
            // Redimensionar quando a janela mudar de tamanho
            window.addEventListener('resize', function() {
                resizeCanvas();
                if (modalOverlay.style.display === 'block') {
                    resizeModalCanvas();
                }
            });
            
            // Eventos de mouse para desenho no canvas principal
            canvas.addEventListener('mousedown', startDrawing);
            canvas.addEventListener('mousemove', draw);
            canvas.addEventListener('mouseup', stopDrawing);
            canvas.addEventListener('mouseout', stopDrawing);
            
            // Eventos de touch para desenho no canvas principal
            canvas.addEventListener('touchstart', startDrawing, { passive: false });
            canvas.addEventListener('touchmove', draw, { passive: false });
            canvas.addEventListener('touchend', stopDrawing);
            canvas.addEventListener('touchcancel', stopDrawing);
            
            // Eventos de botões do canvas principal
            clearButton.addEventListener('click', clearSignature);
            expandButton.addEventListener('click', openSignatureModal);
            
            // Eventos de botões do modal
            modalConfirmBtn.addEventListener('click', function() {
                if (hasModalSignature) {
                    closeSignatureModal(true);
                } else {
                    alert('Por favor, faça sua assinatura antes de confirmar.');
                }
            });
            
            modalClearBtn.addEventListener('click', clearModalSignature);
            modalCancelBtn.addEventListener('click', function() {
                closeSignatureModal(false);
            });
            
            // Evento para fechar o modal ao clicar fora
            modalOverlay.addEventListener('click', function(e) {
                if (e.target === modalOverlay) {
                    closeSignatureModal(false);
                }
            });
            
            // Botão de exportar PDF
            if (exportButton) {
                exportButton.addEventListener('click', exportarPDF);
            }
        });
    </script>
</body>
</html>
