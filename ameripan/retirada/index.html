<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>Autorização de Retirada - Ameripan (v10.1 Fixed Start)</title> <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <style>
        /* --- Estilos CSS (Mantidos da v10) --- */
        @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&family=Poppins:wght@400;500;600&display=swap');

        :root {
            --primary-color: #005A9C; --secondary-color: #F58220; --accent-color: #007BFF;
            --light-bg: #F8F9FA; --dark-bg: #343A40; --text-color: #212529; --light-text: #6C757D;
            --border-color: #DEE2E6; --success-color: #28A745; --error-color: #DC3545;
            --white-color: #FFFFFF; --input-border-color: #CED4DA;
            --print-color: #6f42c1; --share-color: #17a2b8; --generate-color: var(--success-color);
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        html { font-size: 16px; }
        body { font-family: 'Poppins', 'Arial', sans-serif; max-width: 100%; margin: 0 auto; padding: 1.25rem; background-color: var(--light-bg); line-height: 1.6; color: var(--text-color); -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; touch-action: manipulation; }
        .container { background-color: var(--white-color); padding: 2rem; border-radius: 8px; box-shadow: 0 6px 18px rgba(0, 0, 0, 0.1); max-width: 800px; margin: 1rem auto; }
        .brand-header { text-align: center; margin-bottom: 2rem; padding-bottom: 1rem; border-bottom: 1px solid var(--border-color); }
        .logo-container { margin-bottom: 1rem; }
        .logo { max-width: 180px; height: auto; display: block; margin: 0 auto; }
        .brand-slogan { font-family: 'Montserrat', sans-serif; font-style: italic; color: var(--secondary-color); font-size: 1.1rem; font-weight: 500; margin-top: 0.5rem; }
        h1 { text-align: center; margin-bottom: 2rem; font-size: 1.4rem; color: var(--primary-color); font-family: 'Montserrat', sans-serif; font-weight: 600; }
        .form-content { font-size: 1rem; line-height: 1.8; margin-bottom: 2rem; }
        .field { display: inline-block; border-bottom: 2px solid var(--input-border-color); min-width: 150px; padding: 0 5px 2px 5px; position: relative; margin: 0 3px; transition: border-color 0.2s ease-in-out; }
        .field:focus-within { border-bottom-color: var(--primary-color); }
        .field.invalid, .date-field.invalid { border-bottom-color: var(--error-color); }
        .error-message { color: var(--error-color); font-size: 0.75rem; margin-left: 5px; display: none; position: absolute; bottom: -18px; left: 0; white-space: nowrap; }
        .field.invalid .error-message { display: inline; }
        .field-input { border: none; outline: none; width: 100%; background: transparent; font-family: 'Poppins', 'Arial', sans-serif; padding: 2px 0; font-weight: 500; font-size: 1rem; color: var(--text-color); }
        .field-input::placeholder { color: #a9a9a9; opacity: 1; font-weight: 400; font-style: italic; }
        .field-input:-ms-input-placeholder { color: #a9a9a9; font-weight: 400; font-style: italic; }
        .field-input::-ms-input-placeholder { color: #a9a9a9; font-weight: 400; font-style: italic; }
        .footer-section { margin-top: 2.5rem; padding-top: 1.5rem; border-top: 1px solid var(--border-color); }
        .date-location-row { display: flex; justify-content: space-between; align-items: flex-end; flex-wrap: wrap; gap: 1rem; margin-bottom: 2.5rem; }
        .location-block, .date-block { flex-basis: calc(50% - 0.5rem); min-width: 200px; }
        .date-block { text-align: right; }
        .date-label, .location-label { display: block; font-size: 0.875rem; color: var(--light-text); margin-bottom: 0.25rem; font-weight: 500; }
        .date-field { display: inline-block; width: auto; min-width: 40px; text-align: center; border-bottom: 2px solid var(--input-border-color); padding: 0 3px 2px 3px; margin: 0 2px; transition: border-color 0.2s ease-in-out; }
        .date-field:focus-within { border-bottom-color: var(--primary-color); }
        .date-field input { width: 100%; text-align: center; border: none; outline: none; background: transparent; font-family: 'Poppins', 'Arial', sans-serif; font-weight: 500; font-size: 1rem; }
        #mes { min-width: 100px; }
        .signature-area { display: flex; justify-content: center; margin-bottom: 2rem; padding: 0 5px; }
        .signature-section { width: 100%; text-align: center; }
        .signature-pad-container { border: 1px solid var(--input-border-color); margin: 0 auto 0.5rem auto; width: 100%; height: 180px; position: relative; background-color: #fdfdfd; box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.05); border-radius: 4px; overflow: hidden; touch-action: none; -webkit-tap-highlight-color: transparent; cursor: crosshair; }
        .signature-pad-container.invalid { border-color: var(--error-color); }
        .signature-pad-container.invalid .signature-message { color: var(--error-color); }
        #signature-pad { width: 100%; height: 100%; display: block; }
        .signature-line { width: 100%; margin: 0 auto 0.25rem auto; border-top: 1px solid var(--text-color); padding-top: 0.25rem; }
        .signature-name-display { font-size: 0.875rem; color: var(--text-color); font-weight: 500; text-align: center; min-height: 1.2em; text-transform: uppercase; margin-bottom: 0.25rem; }
        .signature-labels-container { font-size: 0.8rem; color: var(--light-text); text-align: center; line-height: 1.4; margin-bottom: 1rem; }
        .signature-labels-container p { margin: 0; }
        .signature-message { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: #aaa; font-size: 0.9rem; text-align: center; pointer-events: none; user-select: none; opacity: 0.8; padding: 0 10px; }
        .controls { display: flex; gap: 0.75rem; margin-top: 0.75rem; justify-content: center; flex-wrap: wrap; }
        .button { padding: 0.75rem 1.25rem; background-color: var(--accent-color); color: var(--white-color); border: none; border-radius: 5px; cursor: pointer; font-size: 0.9rem; font-weight: 600; font-family: 'Montserrat', sans-serif; transition: background-color 0.2s ease, box-shadow 0.2s ease, transform 0.1s ease, opacity 0.2s ease; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); display: inline-flex; align-items: center; justify-content: center; gap: 0.6rem; text-transform: uppercase; letter-spacing: 0.5px; min-width: 130px; }
        .button:hover:not(:disabled) { background-color: #0056b3; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15); }
        .button:active:not(:disabled) { transform: translateY(1px); box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1); }
        .button:disabled { background-color: #adb5bd; cursor: not-allowed; box-shadow: none; opacity: 0.65; }
        .button.clear-button { background-color: #ffc107; color: var(--text-color); padding: 0.65rem 1rem; font-size: 0.875rem; min-width: auto;}
        .button.clear-button:hover:not(:disabled) { background-color: #e0a800; }
        .button.expand-button { background-color: var(--light-text); padding: 0.65rem 1rem; font-size: 0.875rem; min-width: auto;}
        .button.expand-button:hover:not(:disabled) { background-color: #5a6268; }
        .button.generate-share-button { background-color: var(--share-color); min-width: 180px; }
        .button.generate-share-button:hover:not(:disabled) { background-color: #138496; }

        .main-actions-container { text-align: center; margin-top: 2.5rem; padding-top: 1.5rem; border-top: 1px solid var(--border-color); display: flex; justify-content: center; gap: 1rem; flex-wrap: wrap; }

        .signature-modal-overlay { display: none; /* Garantido pelo CSS */ position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0, 0, 0, 0.7); z-index: 1000; backdrop-filter: blur(4px); -webkit-backdrop-filter: blur(4px); align-items: center; justify-content: center; padding: 0.5rem; }
        .signature-modal { width: 98%; max-width: 800px; background-color: var(--white-color); border-radius: 8px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2); padding: 1rem; z-index: 1001; display: flex; flex-direction: column; max-height: 95vh; }
        .signature-modal-title { text-align: center; font-size: 1.1rem; margin-bottom: 0.75rem; color: var(--primary-color); font-weight: 600; font-family: 'Montserrat', sans-serif; flex-shrink: 0; }
        .signature-modal-canvas-container { border: 1px solid var(--border-color); width: 100%; flex-shrink: 1; flex-grow: 1; background-color: #fdfdfd; box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.05); overflow: hidden; touch-action: none; -webkit-tap-highlight-color: transparent; margin-bottom: 1rem; position: relative; border-radius: 4px; cursor: crosshair; min-height: 250px; }
        #signature-modal-canvas { width: 100%; height: 100%; display: block; }
        .signature-modal-message { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: #aaa; font-size: 1.1rem; text-align: center; pointer-events: none; user-select: none; opacity: 0.8; }
        .signature-modal-buttons { display: flex; justify-content: center; gap: 1rem; flex-wrap: wrap; margin-top: auto; flex-shrink: 0; }
        .modal-btn { padding: 0.75rem 1.25rem; border-radius: 5px; border: none; color: var(--white-color); font-size: 0.9rem; font-weight: 600; cursor: pointer; display: inline-flex; align-items: center; justify-content: center; min-width: 120px; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.15); transition: background-color 0.2s ease, transform 0.1s ease, box-shadow 0.2s ease; font-family: 'Montserrat', sans-serif; text-transform: uppercase; letter-spacing: 0.5px; }
        .modal-btn:active { transform: translateY(1px); box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1); }
        .modal-btn-confirm { background-color: var(--success-color); }
        .modal-btn-confirm:hover { background-color: #218838; }
        .modal-btn-clear { background-color: var(--error-color); }
        .modal-btn-clear:hover { background-color: #c82333; }
        .modal-btn-cancel { background-color: var(--light-text); }
        .modal-btn-cancel:hover { background-color: #5a6268; }
        .modal-btn-icon { margin-right: 0.5rem; font-size: 1.1em; }

        .toast-message { display: none; position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background-color: var(--success-color); color: white; padding: 10px 20px; border-radius: 5px; z-index: 3000; font-size: 0.9rem; box-shadow: 0 3px 10px rgba(0,0,0,0.2); }
        .company-info { text-align: center; margin-top: 1rem; padding-top: 1.5rem; border-top: 1px solid var(--border-color); color: var(--light-text); font-size: 0.875rem; }
        .company-info p { margin-bottom: 0.25rem; }
        .no-print { display: revert; }
        .pdf-generation-active .no-print,
        .print-iframe-container { display: none !important; position: absolute; top: -9999px; left: -9999px; width: 0; height: 0; overflow: hidden; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .spinner { animation: spin 1s linear infinite; }
    </style>
</head>
<body>
    <div class="container" id="form-container">
        <div class="brand-header">
             <div class="logo-container">
                 <img src="https://raw.githubusercontent.com/Edimarpcosta/edimarpcosta.github.io/refs/heads/main/ameripan/retirada/logo.webp" alt="Ameripan Logo" class="logo" id="company-logo" crossorigin="anonymous">
             </div>
             <p class="brand-slogan">Ameripan, mais sabor ao seu negócio!</p>
         </div>
         <h1>AUTORIZAÇÃO DE RETIRADA DE MERCADORIA</h1>
         <div class="form-content">
             Eu, <span class="field"><input type="text" class="field-input" id="nome" placeholder="Nome proprietário/sócio" required><span class="error-message"></span></span>,
             portador do CPF <span class="field"><input type="text" class="field-input" id="cpf" inputmode="numeric" placeholder="___.___.___-__" required><span class="error-message" id="cpf-error-message"></span></span>,
             proprietário(a) da empresa <span class="field"><input type="text" class="field-input" id="empresa" placeholder="Nome da empresa" required><span class="error-message"></span></span>,
             autorizo o(a) Sr(a). <span class="field"><input type="text" class="field-input" id="autorizado" placeholder="Nome autorizado" required><span class="error-message"></span></span>
             a retirar o(s) pedido(s) nº <span class="field"><input type="text" class="field-input" id="pedidos" placeholder="Números dos pedidos" required><span class="error-message"></span></span>,
             no valor total de R$ <span class="field"><input type="text" class="field-input" id="valor" inputmode="decimal" placeholder="0,00" required><span class="error-message"></span></span>
             no Depósito da empresa Ameripan, localizado na Rua Purus, nº 652, Bairro Jd. São Roque.
         </div>
         <div class="date-location-row">
              <div class="location-block">
                  <label class="location-label" for="cidade">Local:</label>
                  <span class="field" style="min-width: 200px;"><input type="text" class="field-input" id="cidade" required placeholder="Sua cidade"><span class="error-message"></span></span>
              </div>
              <div class="date-block">
                  <label class="date-label">Data:</label>
                  <span class="date-field"><input type="text" id="dia" maxlength="2" placeholder="DD" inputmode="numeric" required><span class="error-message"></span></span> de
                  <span class="date-field" id="mes-field"><input type="text" id="mes" placeholder="Mês por extenso" required><span class="error-message"></span></span> de
                  <span class="date-field"><input type="text" id="ano" maxlength="4" placeholder="AAAA" inputmode="numeric" required><span class="error-message"></span></span>
              </div>
         </div>
         <div class="signature-area">
             <div class="signature-section">
                 <div class="signature-pad-container" id="signature-container">
                     <canvas id="signature-pad"></canvas>
                     <div class="signature-message" id="signature-message">Assine aqui (Proprietário/Sócio)</div>
                 </div>
                  <div class="signature-line"></div>
                  <div class="signature-name-display" id="owner-name-display"></div>
                  <div class="signature-labels-container">
                      <p>(Assinatura Proprietário/Sócio)</p>
                      <p id="authorized-signature-label" style="display: none;">(Assinatura Responsável pela Retirada)</p>
                  </div>
                  <div class="controls no-print">
                     <button class="button clear-button" id="clear-signature" title="Limpar Assinatura">
                         <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-eraser-fill" viewBox="0 0 16 16"><path d="M8.086 2.207a2 2 0 0 1 2.828 0l3.879 3.879a2 2 0 0 1 0 2.828l-5.5 5.5A2 2 0 0 1 7.879 15H5.12a2 2 0 0 1-1.414-.586l-2.5-2.5a2 2 0 0 1 0-2.828zm.66 11.34L3.453 8.254 1.914 9.793a1 1 0 0 0 0 1.414l2.5 2.5a1 1 0 0 0 .707.293H7.88a1 1 0 0 0 .707-.293z"/></svg>
                         Limpar
                     </button>
                     <button class="button expand-button" id="expand-signature" title="Expandir Assinatura">
                          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-arrows-fullscreen" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M5.828 10.172a.5.5 0 0 0-.707 0l-4.096 4.096V11.5a.5.5 0 0 0-1 0v3.975a.5.5 0 0 0 .5.5H4.5a.5.5 0 0 0 0-1H1.732l4.096-4.096a.5.5 0 0 0 0-.707m4.344 0a.5.5 0 0 1 .707 0l4.096 4.096V11.5a.5.5 0 1 1 1 0v3.975a.5.5 0 0 1-.5.5H11.5a.5.5 0 0 1 0-1h2.768l-4.096-4.096a.5.5 0 0 1 0-.707m0-4.344a.5.5 0 0 0 .707 0l4.096-4.096V4.5a.5.5 0 1 0 1 0V.525a.5.5 0 0 0-.5-.5H11.5a.5.5 0 0 0 0 1h2.768l-4.096 4.096a.5.5 0 0 0 0 .707m-4.344 0a.5.5 0 0 1-.707 0L1.025 1.732V4.5a.5.5 0 0 1-1 0V.525a.5.5 0 0 1 .5-.5H4.5a.5.5 0 0 1 0 1H1.732l4.096 4.096a.5.5 0 0 1 0 .707"/></svg>
                         Expandir
                     </button>
                 </div>
             </div>
          </div>
         <div class="main-actions-container no-print">
              <button class="button generate-share-button" id="generate-share-pdf-main">
                  <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" class="bi bi-send-check-fill" viewBox="0 0 16 16">
                    <path d="M15.964.686a.5.5 0 0 0-.65-.65L.767 5.855H.766l-.452.18a.5.5 0 0 0-.082.887l.41.26.001.002 4.995 3.178 1.59 2.498C8 14 8 13 8 12.5a4.5 4.5 0 0 1 5.026-4.47zm-1.833 1.89L6.637 10.07l-.215-.338a.5.5 0 0 0-.154-.154l-.338-.215 7.494-7.494 1.178-.471z"/>
                    <path d="M16 12.5a3.5 3.5 0 1 1-7 0 3.5 3.5 0 0 1 7 0m-1.993-1.679a.5.5 0 0 0-.686.172l-1.17 1.95-.547-.547a.5.5 0 0 0-.708.708l.774.773a.75.75 0 0 0 1.174-.144l1.335-2.226a.5.5 0 0 0-.172-.686"/>
                  </svg>
                 Gerar / Enviar PDF
             </button>
         </div>
         <div class="footer-section">
             <div class="company-info">
                 <p>AMERIPAN COMERCIO DE PRODUTOS ALIMENTICIOS LTDA</p>
                 <p>CNPJ: 65.029.035/0001-07</p>
                 <p>Rua Purus, 652 - Jardim São Roque - Americana/SP - CEP: 13469-130</p>
             </div>
         </div>
    </div><div class="signature-modal-overlay no-print" id="signature-modal-overlay">
        <div class="signature-modal" role="dialog" aria-modal="true" aria-labelledby="signature-modal-title">
            <h2 class="signature-modal-title" id="signature-modal-title">Assinatura Digital</h2>
            <div class="signature-modal-canvas-container">
                <canvas id="signature-modal-canvas"></canvas>
                <div class="signature-modal-message" id="signature-modal-message">Assine aqui</div>
            </div>
            <div class="signature-modal-buttons">
                 <button class="modal-btn modal-btn-confirm" id="modal-confirm"><span class="modal-btn-icon">✓</span> Confirmar</button>
                 <button class="modal-btn modal-btn-clear" id="modal-clear"><span class="modal-btn-icon">✗</span> Limpar</button>
                 <button class="modal-btn modal-btn-cancel" id="modal-cancel"><span class="modal-btn-icon">←</span> Voltar</button>
            </div>
        </div>
    </div>

    <div class="toast-message" id="toast-message"></div>

    <div id="print-iframe-container" class="print-iframe-container"></div>

    <script>
        'use strict';

        document.addEventListener('DOMContentLoaded', function() {
            console.log("DOM carregado. Iniciando script v10.1 (Fixed Start).");

            // --- Elementos DOM ---
            const canvas = document.getElementById('signature-pad');
            const signatureMessage = document.getElementById('signature-message');
            const clearButton = document.getElementById('clear-signature');
            const expandButton = document.getElementById('expand-signature');
            const signatureContainer = document.getElementById('signature-container');
            const generateSharePdfButtonMain = document.getElementById('generate-share-pdf-main'); // Botão único
            const modalOverlay = document.getElementById('signature-modal-overlay');
            const modalCanvas = document.getElementById('signature-modal-canvas');
            const modalMessage = document.getElementById('signature-modal-message');
            const modalConfirmBtn = document.getElementById('modal-confirm');
            const modalClearBtn = document.getElementById('modal-clear');
            const modalCancelBtn = document.getElementById('modal-cancel');
            const toastMessageElement = document.getElementById('toast-message');
            const printIframeContainer = document.getElementById('print-iframe-container');
            const cpfInput = document.getElementById('cpf');
            const valorInput = document.getElementById('valor');
            const diaInput = document.getElementById('dia');
            const mesInput = document.getElementById('mes');
            const anoInput = document.getElementById('ano');
            const nomeInput = document.getElementById('nome');
            const empresaInput = document.getElementById('empresa');
            const autorizadoInput = document.getElementById('autorizado');
            const pedidosInput = document.getElementById('pedidos');
            const cidadeInput = document.getElementById('cidade');
            const formContainer = document.getElementById('form-container');
            const ownerNameDisplay = document.getElementById('owner-name-display');
            const authorizedSignatureLabel = document.getElementById('authorized-signature-label');
            const companyLogo = document.getElementById('company-logo');

            // --- Estados Globais ---
            const ctx = canvas ? canvas.getContext('2d') : null;
            const modalCtx = modalCanvas ? modalCanvas.getContext('2d') : null;
            let isDrawing = false;
            let points = [];
            let hasSignature = false;
            let hasModalSignature = false;
            let tempSignatureDataUrl = null;
            let tempMainSignatureDataUrl = null;
            let generatedPdfBlob = null;
            let generatedPdfFilename = '';
            let isProcessing = false;

            // --- Constantes ---
            const SIGNATURE_LINE_COLOR = '#005A9C';
            const SIGNATURE_LINE_WIDTH = 2.5;

            // ========================================================================
            // FUNÇÕES DE DESENHO NO CANVAS (Mantidas)
            // ========================================================================
            function setupCanvasContext(context, canvasElement) { if(!context) return; const dpr = window.devicePixelRatio || 1; context.resetTransform(); context.scale(dpr, dpr); context.lineWidth = SIGNATURE_LINE_WIDTH; context.lineCap = 'round'; context.lineJoin = 'round'; context.strokeStyle = SIGNATURE_LINE_COLOR; context.imageSmoothingEnabled = true; context.imageSmoothingQuality = 'high'; }
            function resizeCanvas(canvasElement, context, isModal = false) { if(!context || !canvasElement) return; const container = canvasElement.parentElement; if (!container) return; const saveDataUrl = isModal ? tempSignatureDataUrl : tempMainSignatureDataUrl; const currentHasSignature = isModal ? hasModalSignature : hasSignature; const messageElement = isModal ? modalMessage : signatureMessage; const containerWidth = container.clientWidth; const containerHeight = isModal ? Math.max(container.clientHeight, 250) : container.clientHeight; canvasElement.style.width = `${containerWidth}px`; canvasElement.style.height = `${containerHeight}px`; const dpr = window.devicePixelRatio || 1; canvasElement.width = Math.floor(containerWidth * dpr); canvasElement.height = Math.floor(containerHeight * dpr); setupCanvasContext(context, canvasElement); if (saveDataUrl) { const img = new Image(); img.onload = () => { context.drawImage(img, 0, 0, canvasElement.width / dpr, canvasElement.height / dpr); }; img.src = saveDataUrl; if (messageElement) messageElement.style.display = 'none'; if (isModal) tempSignatureDataUrl = null; else tempMainSignatureDataUrl = null; } else if (!currentHasSignature && messageElement) { messageElement.style.display = 'block'; } }
            function getCanvasCoordinates(element, clientX, clientY) { const rect = element.getBoundingClientRect(); return { x: clientX - rect.left, y: clientY - rect.top }; }
            function startDrawing(e, currentCanvas, currentCtx, isModal) { if(!currentCtx || isProcessing) return; e.preventDefault(); isDrawing = true; points = []; let clientX, clientY; if (e.type.startsWith('touch')) { clientX = e.touches[0].clientX; clientY = e.touches[0].clientY; } else { clientX = e.clientX; clientY = e.clientY; } const coords = getCanvasCoordinates(currentCanvas, clientX, clientY); points.push({ x: coords.x, y: coords.y }); const messageElement = isModal ? modalMessage : signatureMessage; if (messageElement) messageElement.style.display = 'none'; if (isModal) { hasModalSignature = true; } else { hasSignature = true; generatedPdfBlob = null; generatedPdfFilename = ''; if(signatureContainer) signatureContainer.classList.remove('invalid'); if (authorizedSignatureLabel) authorizedSignatureLabel.style.display = 'block'; } currentCtx.beginPath(); currentCtx.arc(coords.x, coords.y, SIGNATURE_LINE_WIDTH / 2, 0, Math.PI * 2); currentCtx.fillStyle = SIGNATURE_LINE_COLOR; currentCtx.fill(); currentCtx.closePath(); }
            function draw(e, currentCanvas, currentCtx) { if (!isDrawing || !currentCtx || isProcessing) return; e.preventDefault(); let clientX, clientY; if (e.type.startsWith('touch')) { if (e.touches.length > 0) { clientX = e.touches[0].clientX; clientY = e.touches[0].clientY; } else { return; } } else { clientX = e.clientX; clientY = e.clientY; } const coords = getCanvasCoordinates(currentCanvas, clientX, clientY); points.push({ x: coords.x, y: coords.y }); if (points.length < 3) { if (points.length === 2) { currentCtx.beginPath(); currentCtx.moveTo(points[0].x, points[0].y); currentCtx.lineTo(points[1].x, points[1].y); currentCtx.stroke(); currentCtx.closePath(); } return; } const lastPoint = points[points.length - 1]; const secondLastPoint = points[points.length - 2]; const thirdLastPoint = points[points.length - 3]; const mid1 = { x: (thirdLastPoint.x + secondLastPoint.x) / 2, y: (thirdLastPoint.y + secondLastPoint.y) / 2 }; const mid2 = { x: (secondLastPoint.x + lastPoint.x) / 2, y: (secondLastPoint.y + lastPoint.y) / 2 }; currentCtx.beginPath(); currentCtx.moveTo(mid1.x, mid1.y); currentCtx.quadraticCurveTo(secondLastPoint.x, secondLastPoint.y, mid2.x, mid2.y); currentCtx.stroke(); currentCtx.closePath(); }
            function stopDrawing(e, currentCtx) { if (!isDrawing || !currentCtx || isProcessing) return; isDrawing = false; if (points.length >= 2) { const lastPoint = points[points.length - 1]; const secondLastPoint = points[points.length - 2]; const midPoint = { x: (secondLastPoint.x + lastPoint.x) / 2, y: (secondLastPoint.y + lastPoint.y) / 2 }; if (points.length >= 3) { const thirdLastPoint = points[points.length - 3]; const prevMidPoint = { x: (thirdLastPoint.x + secondLastPoint.x) / 2, y: (thirdLastPoint.y + secondLastPoint.y) / 2 }; currentCtx.beginPath(); currentCtx.moveTo(prevMidPoint.x, prevMidPoint.y); currentCtx.quadraticCurveTo(secondLastPoint.x, secondLastPoint.y, midPoint.x, midPoint.y); currentCtx.stroke(); currentCtx.closePath(); } } points = []; }
            function clearCanvas(canvasElement, context, messageElement, isModal) { if(!context || ! canvasElement) return; const dpr = window.devicePixelRatio || 1; context.save(); context.resetTransform(); context.clearRect(0, 0, canvasElement.width, canvasElement.height); context.restore(); setupCanvasContext(context, canvasElement); if (messageElement) messageElement.style.display = 'block'; if (isModal) { hasModalSignature = false; } else { hasSignature = false; generatedPdfBlob = null; generatedPdfFilename = ''; if(signatureContainer) signatureContainer.classList.remove('invalid'); if (authorizedSignatureLabel) authorizedSignatureLabel.style.display = 'none'; } }

            // ========================================================================
            // FUNÇÕES DO MODAL DE ASSINATURA (Mantidas)
            // ========================================================================
            function openSignatureModal() { if(!canvas || !modalCanvas || !modalCtx || isProcessing) return; if (hasSignature) { tempMainSignatureDataUrl = canvas.toDataURL(); } else { tempMainSignatureDataUrl = null; } clearCanvas(modalCanvas, modalCtx, modalMessage, true); if (tempMainSignatureDataUrl) { const img = new Image(); img.onload = () => { const dpr = window.devicePixelRatio || 1; modalCtx.drawImage(img, 0, 0, modalCanvas.width / dpr, modalCanvas.height / dpr); hasModalSignature = true; if(modalMessage) modalMessage.style.display = 'none'; }; img.src = tempMainSignatureDataUrl; } if(modalOverlay) modalOverlay.style.display = 'flex'; setTimeout(() => resizeCanvas(modalCanvas, modalCtx, true), 50); addModalListeners(); }
            function closeSignatureModal(saveSignature) { if(!canvas || !ctx || !modalCanvas) return; removeModalListeners(); if (saveSignature && hasModalSignature) { const modalSignatureData = modalCanvas.toDataURL(); clearCanvas(canvas, ctx, signatureMessage, false); const img = new Image(); img.onload = () => { const dpr = window.devicePixelRatio || 1; ctx.drawImage(img, 0, 0, canvas.width / dpr, canvas.height / dpr); hasSignature = true; generatedPdfBlob = null; generatedPdfFilename = ''; if(signatureMessage) signatureMessage.style.display = 'none'; if(signatureContainer) signatureContainer.classList.remove('invalid'); updateOwnerNameDisplay(); if (authorizedSignatureLabel) authorizedSignatureLabel.style.display = 'block'; }; img.src = modalSignatureData; } else if (!saveSignature && !hasSignature) { clearCanvas(canvas, ctx, signatureMessage, false); updateOwnerNameDisplay(); if (authorizedSignatureLabel) authorizedSignatureLabel.style.display = 'none'; } else if (!saveSignature && hasSignature) { if(tempMainSignatureDataUrl) { clearCanvas(canvas, ctx, signatureMessage, false); const img = new Image(); img.onload = () => { const dpr = window.devicePixelRatio || 1; ctx.drawImage(img, 0, 0, canvas.width / dpr, canvas.height / dpr); }; img.src = tempMainSignatureDataUrl; hasSignature = true; if(signatureMessage) signatureMessage.style.display = 'none'; if (authorizedSignatureLabel) authorizedSignatureLabel.style.display = 'block'; } else { clearCanvas(canvas, ctx, signatureMessage, false); if (authorizedSignatureLabel) authorizedSignatureLabel.style.display = 'none'; } updateOwnerNameDisplay(); } if(modalOverlay) modalOverlay.style.display = 'none'; }
            const modalMouseDown = (e) => startDrawing(e, modalCanvas, modalCtx, true); const modalMouseMove = (e) => draw(e, modalCanvas, modalCtx); const modalMouseUp = (e) => stopDrawing(e, modalCtx); const modalMouseOut = (e) => { if(isDrawing) stopDrawing(e, modalCtx); }; const modalTouchStart = (e) => startDrawing(e, modalCanvas, modalCtx, true); const modalTouchMove = (e) => draw(e, modalCanvas, modalCtx); const modalTouchEnd = (e) => stopDrawing(e, modalCtx); const modalTouchCancel = (e) => stopDrawing(e, modalCtx);
            function addModalListeners() { if(!modalCanvas) return; modalCanvas.addEventListener('mousedown', modalMouseDown); modalCanvas.addEventListener('mousemove', modalMouseMove); modalCanvas.addEventListener('mouseup', modalMouseUp); modalCanvas.addEventListener('mouseout', modalMouseOut); modalCanvas.addEventListener('touchstart', modalTouchStart, { passive: false }); modalCanvas.addEventListener('touchmove', modalTouchMove, { passive: false }); modalCanvas.addEventListener('touchend', modalTouchEnd); modalCanvas.addEventListener('touchcancel', modalTouchCancel); }
            function removeModalListeners() { if(!modalCanvas) return; modalCanvas.removeEventListener('mousedown', modalMouseDown); modalCanvas.removeEventListener('mousemove', modalMouseMove); modalCanvas.removeEventListener('mouseup', modalMouseUp); modalCanvas.removeEventListener('mouseout', modalMouseOut); modalCanvas.removeEventListener('touchstart', modalTouchStart); modalCanvas.removeEventListener('touchmove', modalTouchMove); modalCanvas.removeEventListener('touchend', modalTouchEnd); modalCanvas.removeEventListener('touchcancel', modalTouchCancel); }

            // ========================================================================
            // VALIDAÇÃO E FORMATAÇÃO DE FORMULÁRIO (Mantidas)
            // ========================================================================
            function isValidCPF(cpf) { if (typeof cpf !== 'string') return false; cpf = cpf.replace(/[^\d]+/g, ''); if (cpf.length !== 11 || /^(.)\1+$/.test(cpf)) return false; let sum = 0; let remainder; for (let i = 1; i <= 9; i++) sum += parseInt(cpf.substring(i - 1, i)) * (11 - i); remainder = (sum * 10) % 11; if ((remainder === 10) || (remainder === 11)) remainder = 0; if (remainder !== parseInt(cpf.substring(9, 10))) return false; sum = 0; for (let i = 1; i <= 10; i++) sum += parseInt(cpf.substring(i - 1, i)) * (12 - i); remainder = (sum * 10) % 11; if ((remainder === 10) || (remainder === 11)) remainder = 0; if (remainder !== parseInt(cpf.substring(10, 11))) return false; return true; }
            function formatCPF(inputElement) { if (!inputElement) return; let value = inputElement.value.replace(/\D/g, '').slice(0, 11); value = value.replace(/(\d{3})(\d)/, '$1.$2'); value = value.replace(/(\d{3})(\d)/, '$1.$2'); value = value.replace(/(\d{3})(\d{1,2})$/, '$1-$2'); inputElement.value = value; }
            function formatCurrency(inputElement) { if (!inputElement) return; let value = inputElement.value.replace(/\D/g, ''); if (value === '') { inputElement.value = ''; return; } let numberValue = parseInt(value) / 100; inputElement.value = numberValue.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 }); }
            function validateField(inputElement) { if (!inputElement) return false; const parentField = inputElement.closest('.field, .date-field'); const errorMsgElement = parentField ? parentField.querySelector('.error-message') : null; let isValid = true; let errorMessageText = ''; const trimmedValue = inputElement.value.trim(); if (inputElement.required && !trimmedValue) { isValid = false; errorMessageText = 'Obrigatório'; } else if (trimmedValue || inputElement.required) { if (inputElement.id === 'cpf' && !isValidCPF(inputElement.value)) { isValid = false; errorMessageText = 'CPF inválido'; } else if (inputElement.id === 'ano') { const year = parseInt(trimmedValue); const currentYear = new Date().getFullYear(); if (isNaN(year) || year < currentYear - 10 || year > currentYear + 5) { isValid = false; errorMessageText = 'Ano inválido'; } } else if (inputElement.id === 'dia') { const day = parseInt(trimmedValue); if (isNaN(day) || day < 1 || day > 31) { isValid = false; errorMessageText = 'Dia inválido'; } } else if (inputElement.id === 'mes') { const monthValue = trimmedValue.toLowerCase(); const validMonths = ['janeiro', 'fevereiro', 'março', 'abril', 'maio', 'junho', 'julho', 'agosto', 'setembro', 'outubro', 'novembro', 'dezembro']; if (!validMonths.includes(monthValue)) { isValid = false; errorMessageText = 'Mês inválido'; } } } if (parentField) { if (!isValid) { parentField.classList.add('invalid'); if (errorMsgElement) { errorMsgElement.textContent = errorMessageText; errorMsgElement.style.display = 'inline'; } } else { parentField.classList.remove('invalid'); if (errorMsgElement) { errorMsgElement.style.display = 'none'; } } } return isValid; }
            function validateForm() { console.log("Validando formulário..."); let isFormValid = true; let firstInvalidElement = null; const fieldsToValidate = formContainer ? formContainer.querySelectorAll('input[required], select[required], textarea[required]') : []; fieldsToValidate.forEach(input => { if (!validateField(input)) { isFormValid = false; if (!firstInvalidElement) firstInvalidElement = input; } }); console.log("Validando assinatura..."); if (!hasSignature) { console.log("Assinatura ausente."); isFormValid = false; if(signatureContainer) signatureContainer.classList.add('invalid'); if(signatureMessage) { signatureMessage.textContent = 'Assinatura obrigatória'; signatureMessage.style.display = 'block'; } if (!firstInvalidElement) firstInvalidElement = signatureContainer; } else { if(signatureContainer) signatureContainer.classList.remove('invalid'); if(signatureMessage && hasSignature) signatureMessage.style.display = 'none'; } if (!isFormValid) { console.log("Formulário inválido."); if (firstInvalidElement) { try { firstInvalidElement.focus(); } catch(e) { console.warn("Não foi possível focar."); } } alert('Por favor, corrija os campos destacados e forneça a assinatura.'); } else { console.log("Formulário válido."); } return isFormValid; }
            function clearErrorOnInput(event) { const input = event.target; const parentField = input.closest('.field, .date-field'); if (parentField && parentField.classList.contains('invalid')) { parentField.classList.remove('invalid'); const errorMsgElement = parentField.querySelector('.error-message'); if (errorMsgElement) errorMsgElement.style.display = 'none'; } generatedPdfBlob = null; generatedPdfFilename = ''; }

            // ========================================================================
            // FUNÇÕES DE INICIALIZAÇÃO E UTILITÁRIOS (Mantidas)
            // ========================================================================
            function initializeDefaultDate() { try { const today = new Date(); const day = today.getDate().toString().padStart(2, '0'); const months = ['janeiro', 'fevereiro', 'março', 'abril', 'maio', 'junho', 'julho', 'agosto', 'setembro', 'outubro', 'novembro', 'dezembro']; const month = months[today.getMonth()]; const year = today.getFullYear(); if (diaInput) diaInput.value = day; if (mesInput) mesInput.value = month; if (anoInput) anoInput.value = year; if (cidadeInput && !cidadeInput.value) { cidadeInput.value = "Americana"; } console.log("Data e cidade padrão inicializadas."); } catch (error) { console.error("Erro ao inicializar data/cidade:", error); } }
            function updateOwnerNameDisplay() { if (ownerNameDisplay && nomeInput) { ownerNameDisplay.textContent = nomeInput.value.trim().toUpperCase(); } }
            function getImageDataUrlWithWhiteBackground(url) { return new Promise(async (resolve, reject) => { const img = new Image(); img.crossOrigin = "Anonymous"; img.onload = () => { const tempCanvas = document.createElement('canvas'); tempCanvas.width = img.naturalWidth; tempCanvas.height = img.naturalHeight; const tempCtx = tempCanvas.getContext('2d'); tempCtx.fillStyle = '#FFFFFF'; tempCtx.fillRect(0, 0, tempCanvas.width, tempCanvas.height); tempCtx.drawImage(img, 0, 0); try { resolve(tempCanvas.toDataURL('image/jpeg', 0.9)); } catch(e) { console.error("Canvas toDataURL (JPEG) failed:", e); try { resolve(tempCanvas.toDataURL('image/png')); } catch(e2) { reject("Não foi possível converter o logo."); } } }; img.onerror = (err) => { console.error(`Erro ao carregar a imagem do logo de ${url}`, err); reject(`Erro ao carregar a imagem do logo de ${url}`); }; try { const response = await fetch(url, { mode: 'cors' }); if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`); const blob = await response.blob(); img.src = URL.createObjectURL(blob); } catch (fetchError) { console.warn("Fetch CORS falhou para o logo, tentando carregamento direto:", fetchError); img.src = url; } }); }
            function showToast(message, duration = 3000) { if (!toastMessageElement) return; toastMessageElement.textContent = message; toastMessageElement.style.display = 'block'; setTimeout(() => { toastMessageElement.style.display = 'none'; }, duration); }

            // ========================================================================
            // FUNÇÃO HELPER PARA TEXTO FORMATADO (Importada da v6)
            // ========================================================================
            const addFormattedText = (pdf, segments, x, y, maxWidth, lineSpacing = 6) => {
                 let currentX = x;
                 let currentLineY = y; // Usar variável local para Y dentro da função
                 pdf.setFontSize(11); // Tamanho base

                 segments.forEach(segment => {
                     pdf.setFont('helvetica', segment.style || 'normal');
                     const text = segment.text + (segment.spaceAfter ? ' ' : '');
                     const textWidth = pdf.getStringUnitWidth(text) * pdf.getFontSize() / pdf.internal.scaleFactor;

                     // Quebra de linha ANTES de adicionar se não couber
                     if (currentX + textWidth > x + maxWidth && currentX > x) {
                         currentLineY += lineSpacing;
                         currentX = x;
                     }

                     // Verifica se a palavra em si é maior que a largura (caso raro)
                     if (textWidth > maxWidth) {
                         console.warn("Segmento de texto maior que a largura da linha:", text);
                         const splitText = pdf.splitTextToSize(text, maxWidth);
                         pdf.text(splitText, currentX, currentLineY);
                         currentLineY += lineSpacing * (splitText.length -1) ; // Ajusta Y pelas linhas adicionadas
                         // Reseta X para a próxima palavra começar no início (ou calcula onde parou)
                         // Esta parte pode precisar de mais lógica se uma palavra quebrada não terminar no fim da linha
                         currentX = x;
                     } else {
                         pdf.text(text, currentX, currentLineY);
                         currentX += textWidth;
                     }
                 });
                 pdf.setFont('helvetica', 'normal'); // Reset
                 return currentLineY; // Retorna a última posição Y usada
            };

            // ========================================================================
            // FUNÇÃO CENTRAL DE GERAÇÃO DE PDF (Lógica v6 integrada na estrutura v9)
            // ========================================================================
            async function generateAndStorePdf(callingButton) {
                 console.log("Iniciando geração e armazenamento do PDF (lógica v6)...");
                 const originalButtonHtml = callingButton ? callingButton.innerHTML : '';
                 const buttonsToDisable = [generateSharePdfButtonMain];

                 isProcessing = true;
                 buttonsToDisable.forEach(btn => { if(btn) btn.disabled = true; });
                 if (callingButton) {
                     callingButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-arrow-repeat spinner" viewBox="0 0 16 16"><path d="M11.534 7h3.932a.25.25 0 0 1 .192.41l-1.966 2.36a.25.25 0 0 1-.384 0l-1.966-2.36a.25.25 0 0 1 .192-.41m-11 2h3.932a.25.25 0 0 0 .192-.41L2.692 6.23a.25.25 0 0 0-.384 0L.342 8.59A.25.25 0 0 0 .534 9"/><path fill-rule="evenodd" d="M8 3c-1.552 0-2.94.707-3.857 1.818a.5.5 0 1 1-.771-.636A6.5 6.5 0 1 1 2.343 6H.5a.5.5 0 0 1 0-1h3.975a.5.5 0 0 1 .5.5v3.975a.5.5 0 0 1-1 0V6.45a5.5 5.5 0 1 0 .75-3.357A.5.5 0 1 1 8 3"/></svg> Gerando...`;
                 }
                 document.body.classList.add('pdf-generation-active');

                 try {
                    const { jsPDF } = window.jspdf;
                    const autoTable = window.jspdf?.plugin?.autotable;
                    if (typeof jsPDF !== 'function') throw new Error("Biblioteca jsPDF não carregada.");
                    if (typeof autoTable !== 'function') console.warn("Plugin AutoTable não carregado.");

                    const pdf = new jsPDF({ orientation: 'portrait', unit: 'mm', format: 'a4', putOnlyUsedFonts:true, compress: true });

                    const pageW = pdf.internal.pageSize.getWidth();
                    const pageH = pdf.internal.pageSize.getHeight();
                    const margin = 15; const contentW = pageW - (margin * 2);
                    let currentY = margin;
                    const lineSpacing = 6; const sectionSpacing = 10; const fieldLineOffset = 1;
                    const labelSpacing = 4; const signatureBlockSpacing = 15;

                    // --- 1. Logo ---
                    if (companyLogo && companyLogo.complete && companyLogo.naturalWidth > 0) { /* ... (lógica v6 mantida) ... */
                         try {
                             const logoDataUrl = await getImageDataUrlWithWhiteBackground(companyLogo.src);
                             const imgProps = pdf.getImageProperties(logoDataUrl);
                             const logoMaxW = 50; const logoRatio = imgProps.width / imgProps.height;
                             const logoW = Math.min(logoMaxW, contentW * 0.3); const logoH = logoW / logoRatio;
                             const logoX = (pageW - logoW) / 2;
                             pdf.addImage(logoDataUrl, 'JPEG', logoX, currentY, logoW, logoH);
                             currentY += logoH + 5;
                         } catch (imgError) { console.error("Erro logo (v6):", imgError); currentY += 10; }
                    } else { currentY += 10; }

                    // --- 2. Slogan ---
                    const slogan = document.querySelector('.brand-slogan')?.textContent || '';
                    pdf.setFontSize(11); pdf.setFont('helvetica', 'italic'); pdf.setTextColor(100);
                    pdf.text(slogan, pageW / 2, currentY, { align: 'center' });
                    currentY += sectionSpacing; pdf.setFont('helvetica', 'normal'); pdf.setTextColor(0);

                    // --- 3. Title ---
                    const title = document.querySelector('h1')?.textContent || 'AUTORIZAÇÃO DE RETIRADA';
                    pdf.setFontSize(14); pdf.setFont('helvetica', 'bold');
                    pdf.text(title, pageW / 2, currentY, { align: 'center' });
                    currentY += sectionSpacing + 5; pdf.setFont('helvetica', 'normal');

                    // --- 4. Main Content Text ---
                    pdf.setFontSize(11);
                    const nome = nomeInput.value.trim(); const cpf = cpfInput.value.trim();
                    const empresa = empresaInput.value.trim(); const autorizado = autorizadoInput.value.trim();
                    const pedidos = pedidosInput.value.trim(); const valor = valorInput.value.trim();
                    // Usar addFormattedText e ajustar Y corretamente
                    currentY = addFormattedText(pdf, [{ text: 'Eu,', style: 'normal', spaceAfter: true }, { text: nome, style: 'bold', spaceAfter: true }, { text: ', portador do CPF', style: 'normal', spaceAfter: true }, { text: cpf, style: 'bold', spaceAfter: true }, { text: ',', style: 'normal', spaceAfter: false }], margin, currentY, contentW, lineSpacing);
                    currentY = addFormattedText(pdf, [{ text: 'proprietário(a) da empresa', style: 'normal', spaceAfter: true }, { text: empresa, style: 'bold', spaceAfter: true }, { text: ', autorizo o(a) Sr(a).', style: 'normal', spaceAfter: true }, { text: autorizado, style: 'bold', spaceAfter: false }], margin, currentY + lineSpacing, contentW, lineSpacing);
                    currentY = addFormattedText(pdf, [{ text: 'a retirar o(s) pedido(s) nº', style: 'normal', spaceAfter: true }, { text: pedidos, style: 'bold', spaceAfter: true }, { text: ', no valor total de R$', style: 'normal', spaceAfter: true }, { text: valor, style: 'bold', spaceAfter: false }], margin, currentY + lineSpacing, contentW, lineSpacing);
                    pdf.setFont('helvetica', 'normal'); const line4Text = 'no Depósito da empresa Ameripan, localizado na Rua Purus, nº 652, Bairro Jd. São Roque.';
                    const splitLine4 = pdf.splitTextToSize(line4Text, contentW);
                    pdf.text(splitLine4, margin, currentY + lineSpacing);
                    currentY += (lineSpacing * splitLine4.length) + sectionSpacing; // Ajusta Y final

                    // --- 5. Date and Location ---
                    const cidade = cidadeInput.value.trim(); const dia = diaInput.value.trim();
                    const mes = mesInput.value.trim(); const ano = anoInput.value.trim();
                    currentY = addFormattedText(pdf, [{ text: cidade, style: 'bold', spaceAfter: true }, { text: ',', style: 'normal', spaceAfter: true }, { text: dia, style: 'bold', spaceAfter: true }, { text: 'de', style: 'normal', spaceAfter: true }, { text: mes, style: 'bold', spaceAfter: true }, { text: 'de', style: 'normal', spaceAfter: true }, { text: ano, style: 'bold', spaceAfter: true }, { text: '.', style: 'normal', spaceAfter: false }], margin, currentY, contentW, lineSpacing);
                    currentY += sectionSpacing + 10;

                    // --- 6. Owner's Signature Area ---
                    const ownerSignatureY = currentY; const signatureWidth = contentW * 0.7;
                    const signatureX = (pageW - signatureWidth) / 2;
                    if (hasSignature) {
                        const signatureDataUrl = canvas.toDataURL('image/png'); const sigProps = pdf.getImageProperties(signatureDataUrl);
                        const sigRatio = sigProps.width / sigProps.height; const sigMaxH = 35;
                        let sigH = Math.min(sigMaxH, signatureWidth / sigRatio); let sigW = sigH * sigRatio;
                        if (sigW > signatureWidth) { sigW = signatureWidth; sigH = sigW / sigRatio; }
                        const sigY = ownerSignatureY; const sigImgX = signatureX + (signatureWidth - sigW) / 2;
                        pdf.addImage(signatureDataUrl, 'PNG', sigImgX, sigY, sigW, sigH); currentY = sigY + sigH + fieldLineOffset;
                    } else { currentY = ownerSignatureY + 30 + fieldLineOffset; /* Placeholder Y */ }
                    pdf.setLineWidth(0.3); pdf.line(signatureX, currentY, signatureX + signatureWidth, currentY); currentY += labelSpacing;
                    pdf.setFontSize(9); pdf.setFont('helvetica', 'bold'); pdf.text(nome.toUpperCase(), signatureX + signatureWidth / 2, currentY, { align: 'center' }); currentY += labelSpacing;
                    pdf.setFont('helvetica', 'normal'); pdf.setFontSize(8); pdf.setTextColor(100); pdf.text("(Assinatura Proprietário/Sócio)", signatureX + signatureWidth / 2, currentY, { align: 'center' }); pdf.setTextColor(0);

                    // --- 7. Authorized Person's Signature Area ---
                    currentY += signatureBlockSpacing; const authorizedSignatureY = currentY;
                    pdf.setLineWidth(0.3); pdf.line(signatureX, authorizedSignatureY, signatureX + signatureWidth, authorizedSignatureY); currentY = authorizedSignatureY + labelSpacing;
                    pdf.setFontSize(9); pdf.setFont('helvetica', 'bold'); pdf.text(autorizado.toUpperCase(), signatureX + signatureWidth / 2, currentY, { align: 'center' }); currentY += labelSpacing;
                    pdf.setFont('helvetica', 'normal'); pdf.setFontSize(8); pdf.setTextColor(100); pdf.text("(Assinatura Responsável pela Retirada)", signatureX + signatureWidth / 2, currentY, { align: 'center' }); pdf.setTextColor(0);
                    currentY += sectionSpacing;

                    // --- 8. Footer ---
                     const footerY = pageH - margin - 15; if (currentY > footerY - 10) { pdf.addPage(); currentY = margin; } else { currentY = footerY; }
                    pdf.setFontSize(8); pdf.setTextColor(100); const companyInfoLines = document.querySelectorAll('.company-info p');
                    let footerLineY = currentY; companyInfoLines.forEach(p => { pdf.text(p.textContent.trim(), pageW / 2, footerLineY, { align: 'center' }); footerLineY += 3.5; }); pdf.setTextColor(0);

                    // --- Gerar Nome Arquivo ---
                    const safePedido = pedidos.replace(/[^a-zA-Z0-9,-]/g, '_') || 'N_A';
                    const safeProprietario = nome.replace(/[^a-zA-Z0-9]/g, '_') || 'Proprietario';
                    const dataHoje = new Date(); const diaFormatado = dataHoje.getDate().toString().padStart(2, '0');
                    const mesFormatado = (dataHoje.getMonth() + 1).toString().padStart(2, '0'); const anoFormatado = dataHoje.getFullYear();
                    const dataFormatada = `${diaFormatado}-${mesFormatado}-${anoFormatado}`;
                    const filename = `Autorizacao_Retirada_pedido${safePedido}_proprietario${safeProprietario}_${dataFormatada}.pdf`;

                    // --- Armazenar Blob e Nome ---
                    generatedPdfBlob = pdf.output('blob');
                    generatedPdfFilename = filename;
                    console.log("PDF gerado e armazenado (v6 lógica).");
                    return true;

                } catch (error) { /* ... (bloco catch mantido) ... */
                     console.error("Erro durante a geração do PDF (lógica v6):", error);
                     alert(`Ocorreu um erro ao gerar o PDF: ${error.message}. Verifique o console.`);
                     generatedPdfBlob = null; generatedPdfFilename = ''; return false;
                } finally { /* ... (bloco finally mantido) ... */
                     if (callingButton) callingButton.innerHTML = originalButtonHtml;
                      setTimeout(() => {
                          buttonsToDisable.forEach(btn => { if(btn) btn.disabled = false; });
                          isProcessing = false;
                           document.body.classList.remove('pdf-generation-active');
                           console.log("Processamento finalizado (v6 gen), botões reabilitados.");
                      }, 500);
                }
            }

            // ========================================================================
            // FUNÇÕES DE IMPRESSÃO E COMPARTILHAMENTO (Enviar mantida, Imprimir removida)
            // ========================================================================
            async function enviarPDF() { if (!generatedPdfBlob || !generatedPdfFilename) { console.error("Tentativa de envio sem PDF gerado."); alert("Erro interno: PDF não encontrado para envio."); return; } console.log("Iniciando compartilhamento do PDF..."); const pdfFile = new File([generatedPdfBlob], generatedPdfFilename, { type: 'application/pdf' }); const shareData = { files: [pdfFile], title: 'Autorização de Retirada', text: `Segue a autorização de retirada ${generatedPdfFilename}`, }; if (navigator.share && navigator.canShare && navigator.canShare({ files: [pdfFile] })) { try { await navigator.share(shareData); console.log('PDF compartilhado!'); } catch (error) { if (error.name !== 'AbortError') { console.error('Erro ao compartilhar:', error); alert(`Erro: ${error.message}`); } else { console.log('Compartilhamento cancelado.'); } } } else { console.warn('Web Share API (arquivos) não suportada. Iniciando download.'); alert('Compartilhamento não suportado. Download será iniciado.'); try { const link = document.createElement('a'); link.href = URL.createObjectURL(generatedPdfBlob); link.download = generatedPdfFilename; document.body.appendChild(link); link.click(); document.body.removeChild(link); URL.revokeObjectURL(link.href); } catch(downloadError) { console.error("Erro download:", downloadError); alert("Erro ao baixar PDF."); } } }

            // ========================================================================
            // FUNÇÃO PRINCIPAL DE CONTROLE DE AÇÕES (Adaptada para botão único 'share')
            // ========================================================================
            async function handlePdfAction(actionType, clickedButton) { if (isProcessing) { console.log("Processamento em andamento."); return; } console.log(`Ação: ${actionType}`); isProcessing = true; if (!validateForm()) { isProcessing = false; return; } let pdfReady = false; if (generatedPdfBlob && generatedPdfFilename) { pdfReady = true; } else { pdfReady = await generateAndStorePdf(clickedButton); } if (pdfReady) { if (actionType === 'share') { console.log("Executando envio..."); isProcessing = false; await enviarPDF(); } else { console.warn(`Ação inesperada: ${actionType}`); isProcessing = false; } } else { isProcessing = false; } }

            // ========================================================================
            // LISTENERS DE EVENTOS (Adaptados)
            // ========================================================================
             function handleResizeOrOrientationChange() { tempSignatureDataUrl = null; tempMainSignatureDataUrl = null; if (modalOverlay && modalOverlay.style.display === 'flex' && hasModalSignature && modalCanvas) { tempSignatureDataUrl = modalCanvas.toDataURL(); } if (hasSignature && canvas) { tempMainSignatureDataUrl = canvas.toDataURL(); } if (canvas && ctx) resizeCanvas(canvas, ctx, false); if (modalOverlay && modalOverlay.style.display === 'flex' && modalCanvas && modalCtx) { resizeCanvas(modalCanvas, modalCtx, true); } }

            // --- Configuração Inicial ---
            console.log("Configurando estado inicial e listeners (v10.1)...");
            // *** CORREÇÃO INICIALIZAÇÃO: Garantir que modal começa escondido ***
            if (modalOverlay) {
                modalOverlay.style.display = 'none';
                console.log("Modal de assinatura garantidamente oculto na inicialização via JS.");
            } else {
                 console.warn("Elemento modalOverlay não encontrado na inicialização.");
            }
            // --- Restante da inicialização ---
            if (canvas && ctx) resizeCanvas(canvas, ctx, false); else console.error("Canvas principal não encontrado!");
            initializeDefaultDate();
            updateOwnerNameDisplay();
            if (authorizedSignatureLabel) authorizedSignatureLabel.style.display = 'none';

            // --- Listeners dos Campos (Mantidos) ---
            if (cpfInput) { cpfInput.addEventListener('input', () => { formatCPF(cpfInput); clearErrorOnInput({ target: cpfInput }); }); cpfInput.addEventListener('blur', () => validateField(cpfInput)); } else { console.warn("Elemento cpfInput não encontrado.")};
            if (valorInput) { valorInput.addEventListener('input', () => { formatCurrency(valorInput); clearErrorOnInput({ target: valorInput }); }); valorInput.addEventListener('blur', () => validateField(valorInput)); } else { console.warn("Elemento valorInput não encontrado.")};
            ['nome', 'empresa', 'autorizado', 'pedidos', 'cidade', 'dia', 'mes', 'ano'].forEach(id => { const input = document.getElementById(id); if (input) { input.addEventListener('input', clearErrorOnInput); input.addEventListener('blur', () => validateField(input)); } else { console.warn(`Elemento ${id} não encontrado.`)} });
            if (nomeInput) nomeInput.addEventListener('input', () => { updateOwnerNameDisplay(); clearErrorOnInput({ target: nomeInput }); }); else { console.warn("Elemento nomeInput não encontrado.")};

            // --- Listeners do Canvas Principal (Mantidos) ---
            if (canvas && ctx) { canvas.addEventListener('mousedown', (e) => startDrawing(e, canvas, ctx, false)); canvas.addEventListener('mousemove', (e) => draw(e, canvas, ctx)); canvas.addEventListener('mouseup', (e) => stopDrawing(e, ctx)); canvas.addEventListener('mouseout', (e) => { if(isDrawing) stopDrawing(e, ctx); }); canvas.addEventListener('touchstart', (e) => startDrawing(e, canvas, ctx, false), { passive: false }); canvas.addEventListener('touchmove', (e) => draw(e, canvas, ctx), { passive: false }); canvas.addEventListener('touchend', (e) => stopDrawing(e, ctx)); canvas.addEventListener('touchcancel', (e) => stopDrawing(e, ctx)); } else { console.error("Canvas principal ou contexto não encontrado!")};

            // --- Listeners dos Controles da Assinatura (Mantidos) ---
            if (clearButton) clearButton.addEventListener('click', () => { if(!isProcessing) { clearCanvas(canvas, ctx, signatureMessage, false); updateOwnerNameDisplay();} else { console.log("Aguarde.")}}); else { console.warn("Botão Limpar não encontrado.")};
            if (expandButton) expandButton.addEventListener('click', openSignatureModal); else { console.warn("Botão Expandir não encontrado.")};

            // --- Listener do Botão ÚNICO Principal ---
            if (generateSharePdfButtonMain) {
                 generateSharePdfButtonMain.addEventListener('click', (e) => handlePdfAction('share', e.currentTarget));
            } else { console.error("Botão Gerar/Enviar Principal não encontrado!"); }

            // --- Listeners do Modal (Mantidos) ---
            if (modalConfirmBtn) modalConfirmBtn.addEventListener('click', () => { if (hasModalSignature) closeSignatureModal(true); else alert('Assine antes de confirmar.'); }); else { console.warn("Botão Confirmar Modal não encontrado.")};
            if (modalClearBtn) modalClearBtn.addEventListener('click', () => clearCanvas(modalCanvas, modalCtx, modalMessage, true)); else { console.warn("Botão Limpar Modal não encontrado.")};
            if (modalCancelBtn) modalCancelBtn.addEventListener('click', () => closeSignatureModal(false)); else { console.warn("Botão Cancelar Modal não encontrado.")};
            if (modalOverlay) modalOverlay.addEventListener('click', (e) => { if (e.target === modalOverlay) closeSignatureModal(false); }); else { console.warn("Overlay do Modal não encontrado.")};

            // --- Listeners de Resize/Orientation (Mantidos) ---
            let resizeTimeout; window.addEventListener('resize', () => { clearTimeout(resizeTimeout); resizeTimeout = setTimeout(handleResizeOrOrientationChange, 150); }); window.addEventListener('orientationchange', () => { clearTimeout(resizeTimeout); resizeTimeout = setTimeout(handleResizeOrOrientationChange, 150); });

            console.log("Todos os listeners configurados (v10.1).");

        }); // Fim DOMContentLoaded
    </script>
</body>
</html>
