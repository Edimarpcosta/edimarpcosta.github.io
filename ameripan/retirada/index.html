	<!DOCTYPE html>
	<html lang="pt-BR">
	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
		<meta name="mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<title>Autorização de Retirada - Ameripan</title>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
		<style>
			@import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&family=Poppins:wght@300;400;500;600&display=swap');

			:root {
				--primary-color: #0066aa;
				--secondary-color: #e67817;
				--accent-color: #0088cc;
				--light-bg: #f8f9fa;
				--dark-bg: #2c3e50;
				--text-color: #333;
				--light-text: #6c757d;
				--border-color: #dee2e6;
				--success-color: #28a745;
				--error-color: #dc3545; /* MELHORIA: Cor para erros */
			}

			* {
				box-sizing: border-box;
				margin: 0;
				padding: 0;
			}

			/* Fix para evitar zoom em inputs no iOS */
			input, textarea, select {
				font-size: 16px;
			}

			body {
				font-family: 'Arial', sans-serif;
				max-width: 100%;
				margin: 0 auto;
				padding: 20px;
				background-color: #f5f5f5;
				line-height: 1.6;
				touch-action: manipulation;
			}

			.container {
				background-color: white;
				padding: 30px;
				border-radius: 8px;
				box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
				max-width: 800px;
				margin: 0 auto;
			}

			.brand-header {
				text-align: center;
				margin-bottom: 30px;
			}

			.logo-container {
				margin-bottom: 15px;
			}

			.logo {
				max-width: 200px;
				height: auto;
			}

			.brand-slogan {
				font-family: 'Montserrat', sans-serif;
				font-style: italic;
				color: var(--secondary-color);
				font-size: 1.2em;
				font-weight: 500;
				margin-bottom: 15px;
			}

			h1 {
				text-align: center;
				margin-bottom: 30px;
				font-size: 1.5rem;
				color: var(--primary-color);
				padding: 15px 0;
				border-top: 1px solid var(--border-color);
				border-bottom: 1px solid var(--border-color);
				font-family: 'Montserrat', sans-serif;
			}

			.form-content {
				font-size: 16px;
				line-height: 1.8;
				margin-bottom: 30px;
			}

			/* MELHORIA SUGESTÃO: A estrutura ideal seria usar <label for="id_input"> e aplicar estilo à label ou ao input.
			   A estrutura atual com span pode ter implicações de acessibilidade. */
			.field {
				border-bottom: 1px solid #333;
				display: inline-block;
				min-width: 150px;
				padding: 0 5px;
				position: relative;
				margin: 0 3px; /* Pequeno ajuste de margem */
			}
			/* MELHORIA: Estilo para campo inválido */
			.field.invalid, .date-field.invalid {
				 border-bottom-color: var(--error-color);
			}

			/* MELHORIA: Estilo para mensagem de erro inline (opcional) */
			.error-message {
				color: var(--error-color);
				font-size: 12px;
				margin-left: 5px;
				display: none; /* Escondido por padrão */
			}
			.field.invalid + .error-message {
				 display: inline; /* Mostra se o campo for inválido */
			}


			.field-input {
				border: none;
				outline: none;
				width: 100%;
				background: transparent;
				font-family: 'Arial', sans-serif;
				padding: 2px 0;
				font-weight: bold;
				font-size: 17px;
			}

			.spacer {
				margin-bottom: 20px;
			}

			.footer-row {
				display: flex;
				justify-content: space-between;
				margin-top: 50px;
				flex-wrap: wrap; /* Para melhor ajuste em telas menores */
				gap: 15px; /* Espaçamento entre itens da linha */
			}

			.date-field {
				display: inline-block;
				width: auto; /* Ajuste para caber o placeholder */
				min-width: 50px; /* Largura mínima */
				text-align: center;
				border-bottom: 1px solid #333;
				padding: 0 3px; /* Padding horizontal */
				margin: 0 3px; /* Margem horizontal */
			}

			.date-field input {
				width: 100%;
				text-align: center;
				border: none;
				outline: none;
				background: transparent;
				font-family: 'Arial', sans-serif;
				font-weight: bold;
			}
			/* Estilo específico para o mês que é maior */
			 #mes {
				min-width: 100px;
			 }


			.signature-section {
				margin-top: 30px;
				text-align: center;
			}

			.signature-pad-container {
				border: 1px solid #ccc;
				margin: 0 auto 10px auto; /* Adicionado margin-bottom */
				width: 100%;
				max-width: 500px;
				height: 150px;
				position: relative;
				background-color: #fff;
				box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.1);
				overflow: hidden;
				touch-action: none;
				-webkit-tap-highlight-color: transparent;
			}
			/* MELHORIA: Estilo para indicar assinatura inválida/faltando */
			.signature-pad-container.invalid {
				 border-color: var(--error-color);
			}
			.signature-pad-container.invalid .signature-message {
				 color: var(--error-color);
			}


			#signature-pad {
				width: 100%;
				height: 100%;
				touch-action: none;
				cursor: crosshair;
			}

			.signature-line {
				width: 100%;
				max-width: 500px;
				margin: 0 auto 10px auto; /* Ajustado margin */
				border-top: 1px solid #333;
				padding-top: 5px;
				font-size: 14px;
				color: #555;
				text-align: center;
			}

			.signature-message {
				position: absolute;
				top: 50%;
				left: 50%;
				transform: translate(-50%, -50%);
				color: #aaa;
				font-size: 1rem;
				text-align: center;
				pointer-events: none;
				user-select: none;
				opacity: 0.7;
			}

			.controls {
				display: flex;
				gap: 10px;
				margin-top: 15px;
				justify-content: center;
				flex-wrap: wrap; /* Quebra linha se necessário */
			}

			.button {
				padding: 10px 15px;
				background-color: var(--primary-color); /* Usando variável */
				color: white;
				border: none;
				border-radius: 4px;
				cursor: pointer;
				font-size: 14px;
				font-weight: bold;
				transition: background-color 0.2s ease; /* MELHORIA: Transição suave */
			}

			.button:hover:not(:disabled) { /* MELHORIA: Efeito hover apenas se não desabilitado */
				background-color: #0055aa;
			}
			 .button:disabled { /* MELHORIA: Estilo para botão desabilitado */
				 background-color: #ccc;
				 cursor: not-allowed;
			 }

			.button.clear-button {
				background-color: #f44336;
			}
			 .button.clear-button:hover:not(:disabled) {
				 background-color: #d32f2f;
			 }

			.button.expand-button { /* MELHORIA SUGESTÃO: Renomear botão? Ex: "Assinar Tela Cheia" */
			   /* Estilo padrão já aplicado */
			}

			.button.export-button {
				background-color: var(--success-color); /* Usando variável */
				margin-top: 20px;
			}
			.button.export-button:hover:not(:disabled) {
				 background-color: #218838;
			 }


			/* Modal de assinatura */
			.signature-modal-overlay {
				display: none;
				position: fixed;
				top: 0;
				left: 0;
				right: 0;
				bottom: 0;
				background-color: rgba(0, 0, 0, 0.6);
				z-index: 1000;
				backdrop-filter: blur(5px);
				-webkit-backdrop-filter: blur(5px);
			}

			.signature-modal {
				position: absolute;
				top: 50%;
				left: 50%;
				transform: translate(-50%, -50%);
				width: 90%;
				max-width: 600px;
				background-color: white;
				border-radius: 10px;
				box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
				padding: 20px;
				z-index: 1001;
				 display: flex; /* MELHORIA: Usar flex para melhor controle interno */
				 flex-direction: column;
			}

			.signature-modal-title {
				text-align: center;
				font-size: 1.2rem;
				margin-bottom: 15px;
				color: var(--primary-color);
				font-weight: bold;
			}

			.signature-modal-canvas-container {
				border: 1px solid #ccc;
				width: 100%;
				height: 250px; /* Altura base */
				 flex-grow: 1; /* MELHORIA: Permitir crescer */
				background-color: #fff;
				box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.1);
				overflow: hidden;
				touch-action: none;
				-webkit-tap-highlight-color: transparent;
				margin-bottom: 20px;
				position: relative;
			}

			#signature-modal-canvas {
				width: 100%;
				height: 100%;
				touch-action: none;
			}

			.signature-modal-message {
				position: absolute;
				top: 50%;
				left: 50%;
				transform: translate(-50%, -50%);
				color: #aaa;
				font-size: 1.2rem;
				text-align: center;
				pointer-events: none;
				user-select: none;
				opacity: 0.7;
			}

			.signature-modal-buttons {
				display: flex;
				justify-content: center;
				gap: 15px;
				flex-wrap: wrap; /* Quebra linha se necessário */
			}

			.modal-btn {
				padding: 12px 20px;
				border-radius: 5px;
				border: none;
				color: white;
				font-size: 16px;
				font-weight: bold;
				cursor: pointer;
				display: flex;
				align-items: center;
				justify-content: center;
				min-width: 120px;
				box-shadow: 0 2px 5px rgba(0, 0, 0, 0.15);
				transition: background-color 0.2s ease, transform 0.1s ease; /* MELHORIA: Transições */
			}

			.modal-btn:active {
				transform: translateY(1px);
				box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
			}

			.modal-btn-confirm { background-color: var(--success-color); }
			.modal-btn-confirm:hover { background-color: #218838; }
			.modal-btn-clear { background-color: var(--error-color); } /* Usando variável */
			.modal-btn-clear:hover { background-color: #c82333; }
			.modal-btn-cancel { background-color: var(--light-text); } /* Usando variável */
			 .modal-btn-cancel:hover { background-color: #5a6268; }


			.modal-btn-icon {
				margin-right: 8px;
				font-size: 18px;
			}

			/* Suporte para orientação paisagem */
			@media (orientation: landscape) and (max-height: 500px) { /* MELHORIA: Aplicar apenas se a altura for pequena */
				 .signature-modal {
					 width: 90%;
					 max-width: 95%; /* Permitir mais largura */
					 max-height: 90vh; /* Limitar altura */
				 }
				.signature-modal-canvas-container {
					 height: 180px; /* Reduzir altura em paisagem baixa */
				}
				.signature-modal-title {
					font-size: 1rem; /* Reduzir titulo */
					margin-bottom: 10px;
				}
				.modal-btn {
					padding: 8px 15px; /* Reduzir botões */
					font-size: 14px;
					min-width: 100px;
				}
			}

			/* Classe para elementos que não devem aparecer no PDF */
			.no-print {
				/* Classe vazia, será manipulada via JavaScript antes da impressão */
			}

			@media print {
				body { /* MELHORIA: Resetar padding no print */
					padding: 0;
					margin: 0;
				}
				.container { /* MELHORIA: Remover sombra e borda no print */
					 box-shadow: none;
					 border-radius: 0;
					 padding: 0; /* Ajustar padding conforme necessário para margens do PDF */
					 max-width: 100%; /* Usar largura total */
				}
				.no-print {
					display: none !important;
				}
				/* MELHORIA: Garantir que os campos de input apareçam bem no print */
				.field, .date-field {
					border-bottom: 1px solid #333 !important; /* Garante a linha */
				}
				 .field-input {
					 font-weight: normal; /* Pode ficar negrito demais no print */
				 }
			}

			/* Mensagem de sucesso com overlay */
			.success-message {
				display: none;
				position: fixed;
				top: 0;
				left: 0;
				width: 100%;
				height: 100%;
				background-color: rgba(255, 255, 255, 0.9);
				z-index: 2000;
				justify-content: center;
				align-items: center;
				flex-direction: column;
			}

			.success-content {
				background-color: var(--success-color); /* Usando variável */
				color: white;
				padding: 30px;
				border-radius: 10px;
				text-align: center;
				box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
				max-width: 80%;
			}

			.success-icon {
				font-size: 60px;
				margin-bottom: 20px;
			}

			/* MELHORIA: Removido iframe de output, o download é direto */
			/* #output-pdf { display: none; ... } */

			.company-info {
				text-align: center;
				margin-top: 30px;
				padding-top: 20px;
				border-top: 1px solid var(--border-color);
				color: var(--light-text);
				font-size: 0.9em;
			}

			@media (max-width: 768px) {
				body {
					padding: 10px;
				}

				.container {
					padding: 20px;
				}
			}
			 @media (max-width: 480px) {
				  h1 { font-size: 1.3rem; }
				 .form-content { font-size: 15px; line-height: 1.7; }
				 .field { min-width: 120px; }
				 .footer-row { flex-direction: column; align-items: center; gap: 20px; } /* Centraliza data */
				 .button { width: calc(50% - 5px); } /* Dois botões por linha */
				 .button.export-button { width: 100%; }
				 .signature-modal-buttons { gap: 10px; }
				 .modal-btn { min-width: 100px; padding: 10px 15px; font-size: 14px;}
			 }

			 /* MELHORIA: Garantir que o contraste seja adequado (WCAG AA) - Revisar cores se necessário */
			 /* Ex: var(--light-text) em fundo branco pode precisar de ajuste */

		</style>
	</head>
	<body>
		<div class="container" id="print-content">
			<div class="brand-header">
				<div class="logo-container">
					<img src="https://raw.githubusercontent.com/Edimarpcosta/edimarpcosta.github.io/refs/heads/main/ameripan/retirada/logo.webp" alt="Ameripan Logo" class="logo" crossorigin="anonymous">
				</div>
				<p class="brand-slogan">Ameripan, mais sabor ao seu negócio!</p>
			</div>

			<h1>🔹 AUTORIZAÇÃO DE RETIRADA DE MERCADORIA NA AMERIPAN 🔹</h1>

			<div class="form-content">
				Eu, <span class="field"><input type="text" class="field-input" id="nome" placeholder="nome proprietario/sócio" required></span>, portador do CPF <span class="field"><input type="text" class="field-input" id="cpf" inputmode="numeric" placeholder="CPF" required></span><span class="error-message" id="cpf-error-message"></span>, <br>
				proprietario da empresa <span class="field"><input type="text" class="field-input" id="empresa" placeholder="Nome empresa" required></span>, autorizo o Sr(a) <br>
				<span class="field"><input type="text" class="field-input" id="autorizado" placeholder="nome autorizado" required></span> a retirar o(s) pedido(s) <br>
				<span class="field"><input type="text" class="field-input" id="pedidos" placeholder="num. pedido(s)" required></span>, no valor total de R$ <span class="field"><input type="text" class="field-input" id="valor" inputmode="decimal"placeholder="valor pedido(s)" required></span> no Depósito da <br>
				empresa Ameripan na rua Purus nº 652 Bairro jd São Roque.
			</div>

			<div class="footer-row">
				<div> <span class="field"><input type="text" class="field-input" id="cidade" required></span>,
					<span class="date-field"><input type="text" id="dia" maxlength="2" placeholder="DD" inputmode="numeric" required></span> de
					 <span class="date-field"><input type="text" id="mes" placeholder="Mês por extenso" required></span> de
					<span class="date-field"><input type="text" id="ano" maxlength="4" placeholder="AAAA" inputmode="numeric" required></span>
					<div style="margin-top: 5px; font-size: 14px; color: var(--light-text); text-align:center;">Cidade e Data</div>
				</div>
			</div>

			<div class="signature-section">
				<div class="signature-pad-container" id="signature-container">
					<canvas id="signature-pad"></canvas>
					<div class="signature-message" id="signature-message">Assine aqui</div>
				</div>
				<div class="signature-line">
					Assinatura do proprietário da empresa
				</div>

				<div class="controls no-print">
					<button class="button clear-button" id="clear-signature">Limpar</button>
					 <button class="button expand-button" id="expand-signature">Expandir</button>
				</div>
			</div>

			<div class="company-info">
				<p>CNPJ: 65.029.035/0001-07</p>
				<p>Rua Purus nº 652, Bairro Jd. São Roque, Americana, SP</p>
			</div>
		</div>

		<div style="text-align: center; margin-top: 20px;" class="no-print">
			<button class="button export-button" id="export-pdf">
				Gerar PDF
			</button>
		</div>

		<div class="signature-modal-overlay no-print" id="signature-modal-overlay">
			<div class="signature-modal" role="dialog" aria-modal="true" aria-labelledby="signature-modal-title">
				<div class="signature-modal-title" id="signature-modal-title">Assinatura</div>
				<div class="signature-modal-canvas-container">
					<canvas id="signature-modal-canvas"></canvas>
					<div class="signature-modal-message" id="signature-modal-message">Assine aqui</div>
				</div>
				<div class="signature-modal-buttons">
					<button class="modal-btn modal-btn-confirm" id="modal-confirm">
						<span class="modal-btn-icon">✓</span> Confirmar
					</button>
					<button class="modal-btn modal-btn-clear" id="modal-clear">
						<span class="modal-btn-icon">✗</span> Limpar
					</button>
					<button class="modal-btn modal-btn-cancel" id="modal-cancel">
						<span class="modal-btn-icon">←</span> Voltar
					</button>
				</div>
			</div>
		</div>

		<div class="success-message no-print" id="success-message">
			<div class="success-content">
				<div class="success-icon">✓</div>
				<h2>PDF Gerado com Sucesso!</h2>
				<p>O download deve iniciar automaticamente.</p>
				<button class="modal-btn modal-btn-cancel" style="margin-top: 15px;" onclick="document.getElementById('success-message').style.display='none';">Fechar</button>
			</div>
		</div>

		<script>
			// MELHORIA: Usar 'strict mode' para pegar erros comuns
			'use strict';

			document.addEventListener('DOMContentLoaded', function() {
				// ------------------------------------------------------------------------
				// INICIALIZAÇÃO DE ELEMENTOS E VARIÁVEIS
				// ------------------------------------------------------------------------
				// MELHORIA: Usar const para elementos que não mudam
				const canvas = document.getElementById('signature-pad');
				const signatureMessage = document.getElementById('signature-message');
				const clearButton = document.getElementById('clear-signature');
				const expandButton = document.getElementById('expand-signature');
				const signatureContainer = document.getElementById('signature-container');
				const exportButton = document.getElementById('export-pdf');
				const successMessage = document.getElementById('success-message');

				const modalOverlay = document.getElementById('signature-modal-overlay');
				const modalCanvas = document.getElementById('signature-modal-canvas');
				const modalMessage = document.getElementById('signature-modal-message');
				const modalConfirmBtn = document.getElementById('modal-confirm');
				const modalClearBtn = document.getElementById('modal-clear');
				const modalCancelBtn = document.getElementById('modal-cancel');

				const cpfInput = document.getElementById('cpf');
				const valorInput = document.getElementById('valor');
				const diaInput = document.getElementById('dia');
				const anoInput = document.getElementById('ano');
				 const printContent = document.getElementById('print-content'); // Para PDF

				// Contextos de desenho e variáveis de estado
				const ctx = canvas.getContext('2d');
				const modalCtx = modalCanvas.getContext('2d');
				let isDrawing = false;
				let lastX = 0;
				let lastY = 0;
				let hasSignature = false;
				let hasModalSignature = false;

				// *** INÍCIO: Variável para correção de rotação ***
				let tempSignatureDataUrl = null;
				// *** FIM: Variável para correção de rotação ***

				// ------------------------------------------------------------------------
				// PREVENÇÃO DE COMPORTAMENTOS INDESEJADOS EM TOUCH
				// ------------------------------------------------------------------------
				const preventDefaultOnSignaturePads = function(e) {
					e.preventDefault();
				};

				if (canvas) {
					canvas.addEventListener('touchmove', preventDefaultOnSignaturePads, { passive: false });
				}
				if (modalCanvas) {
					modalCanvas.addEventListener('touchmove', preventDefaultOnSignaturePads, { passive: false });
				}

				document.addEventListener('dblclick', function(e) { e.preventDefault(); });

				const preventGestures = (element) => {
					if (element) {
						element.addEventListener('gesturestart', function(e) { e.preventDefault(); }, { passive: false });
						element.addEventListener('gesturechange', function(e) { e.preventDefault(); }, { passive: false });
						element.addEventListener('gestureend', function(e) { e.preventDefault(); }, { passive: false });
					}
				};
				preventGestures(canvas);
				preventGestures(modalCanvas);

				// ------------------------------------------------------------------------
				// FUNÇÕES DE DESENHO (Canvas Principal e Modal)
				// ------------------------------------------------------------------------
				function setupCanvasContext(context, canvasElement) {
					const dpr = window.devicePixelRatio || 1;
					context.scale(dpr, dpr);
					context.lineWidth = 2.5;
					context.lineCap = 'round';
					context.lineJoin = 'round';
					context.strokeStyle = '#0066cc'; // Azul
					 // MELHORIA: Suavização pode ser melhorada com quadraticCurveTo ou bezierCurveTo
				}

				function resizeCanvas(canvasElement, context) {
					const container = canvasElement.parentElement;
					 if (!container) return; // Segurança

					const containerWidth = container.clientWidth;
					const containerHeight = container.clientHeight;

					canvasElement.style.width = containerWidth + 'px';
					canvasElement.style.height = containerHeight + 'px';

					const dpr = window.devicePixelRatio || 1;
					canvasElement.width = containerWidth * dpr;
					canvasElement.height = containerHeight * dpr;

					 context.setTransform(1, 0, 0, 1, 0, 0); // Reset transform before scaling
					setupCanvasContext(context, canvasElement); // Reapply scale and styles
				}

				 // *** INÍCIO: Função resizeModalCanvas MODIFICADA para restaurar assinatura ***
				 function resizeModalCanvas() {
					 const container = modalCanvas.parentElement;
					 if (!container) return;

					 const containerWidth = container.clientWidth;
					 const containerHeight = container.clientHeight;

					 modalCanvas.style.width = containerWidth + 'px';
					 modalCanvas.style.height = containerHeight + 'px';

					 const dpr = window.devicePixelRatio || 1;
					 modalCanvas.width = containerWidth * dpr;
					 modalCanvas.height = containerHeight * dpr;

					 modalCtx.setTransform(1, 0, 0, 1, 0, 0); // Reset transform
					 setupCanvasContext(modalCtx, modalCanvas); // Reapply scale and styles

					 // Redesenha a assinatura salva temporariamente, se houver
					 if (tempSignatureDataUrl) {
						 const img = new Image();
						 img.onload = function() {
							 // Desenha a imagem salva, ajustando para o dpr
							 modalCtx.drawImage(img, 0, 0, modalCanvas.width / dpr, modalCanvas.height / dpr);
						 };
						 img.src = tempSignatureDataUrl;
						 tempSignatureDataUrl = null; // Limpa a variável temporária
						 modalMessage.style.display = 'none'; // Garante que a mensagem suma
						 hasModalSignature = true; // Garante que o estado seja consistente
					 } else if (!hasModalSignature) {
						  // Se não tinha assinatura e não há temp data, garante que a msg apareça
						  modalMessage.style.display = 'block';
					 }
				}
				 // *** FIM: Função resizeModalCanvas MODIFICADA ***


				function getCanvasCoordinates(element, clientX, clientY) {
					const rect = element.getBoundingClientRect();
					const scaleX = element.width / (rect.width * (window.devicePixelRatio || 1));
					const scaleY = element.height / (rect.height * (window.devicePixelRatio || 1));

					return {
						x: (clientX - rect.left) * scaleX,
						y: (clientY - rect.top) * scaleY
					};
				}

				function startDrawing(e, currentCanvas, currentCtx, isModal) {
					e.preventDefault();
					let clientX, clientY;
					if (e.type.startsWith('touch')) {
						clientX = e.touches[0].clientX;
						clientY = e.touches[0].clientY;
					} else {
						clientX = e.clientX;
						clientY = e.clientY;
					}

					const coords = getCanvasCoordinates(currentCanvas, clientX, clientY);
					lastX = coords.x;
					lastY = coords.y;

					isDrawing = true;
					if (isModal) {
						hasModalSignature = true;
						modalMessage.style.display = 'none';
					} else {
						hasSignature = true;
						signatureMessage.style.display = 'none';
						 signatureContainer.classList.remove('invalid'); // MELHORIA: Remove erro ao começar a desenhar
					}

					currentCtx.beginPath();
					currentCtx.moveTo(lastX, lastY);
					 currentCtx.lineTo(lastX, lastY); // Draw a dot on click/tap
					 currentCtx.stroke();
				}

				function draw(e, currentCanvas, currentCtx) {
					if (!isDrawing) return;
					e.preventDefault();
					let clientX, clientY;
					if (e.type.startsWith('touch')) {
						clientX = e.touches[0].clientX;
						clientY = e.touches[0].clientY;
					} else {
						clientX = e.clientX;
						clientY = e.clientY;
					}

					const coords = getCanvasCoordinates(currentCanvas, clientX, clientY);
					const currentX = coords.x;
					const currentY = coords.y;

					currentCtx.beginPath(); // Start new path segment for smoother joins potentially
					currentCtx.moveTo(lastX, lastY);
					// MELHORIA SUGESTÃO: Usar quadraticCurveTo para suavizar
					// const cpX = (lastX + currentX) / 2;
					// const cpY = (lastY + currentY) / 2;
					// currentCtx.quadraticCurveTo(lastX, lastY, cpX, cpY);
					currentCtx.lineTo(currentX, currentY);
					currentCtx.stroke();

					lastX = currentX;
					lastY = currentY;
				}

				function stopDrawing() {
					if (isDrawing) {
						 isDrawing = false;
						 // Opcional: pode otimizar a assinatura aqui (simplificar pontos)
					 }
				}

				function clearCanvas(canvasElement, context, messageElement, isModal) {
					const dpr = window.devicePixelRatio || 1;
					 context.save();
					 context.setTransform(dpr, 0, 0, dpr, 0, 0); // Use dpr directly
					 context.clearRect(0, 0, canvasElement.width / dpr, canvasElement.height / dpr);
					 context.restore();

					if (messageElement) messageElement.style.display = 'block';
					if (isModal) {
						hasModalSignature = false;
					} else {
						hasSignature = false;
						// Não resetar estilo de erro aqui, deixar a validação geral cuidar disso
					}
					 // Não é necessário redimensionar aqui, apenas limpar
				}

				// ------------------------------------------------------------------------
				// FUNÇÕES DO MODAL DE ASSINATURA
				// ------------------------------------------------------------------------
				function openSignatureModal() {
					clearCanvas(modalCanvas, modalCtx, modalMessage, true); // Limpa o modal ao abrir

					if (hasSignature) { // Transfere assinatura existente, se houver
						const mainSignatureData = canvas.toDataURL();
						const img = new Image();
						img.onload = function() {
							const dpr = window.devicePixelRatio || 1;
							 modalCtx.drawImage(img, 0, 0, modalCanvas.width / dpr, modalCanvas.height / dpr);
							hasModalSignature = true;
							modalMessage.style.display = 'none';
						};
						img.src = mainSignatureData;
					}

					modalOverlay.style.display = 'flex'; // Usar flex para centralizar
					setTimeout(() => resizeModalCanvas(), 10); // Redimensiona após exibir

					// Adiciona listeners específicos do modal
					modalCanvas.addEventListener('mousedown', (e) => startDrawing(e, modalCanvas, modalCtx, true));
					modalCanvas.addEventListener('mousemove', (e) => draw(e, modalCanvas, modalCtx));
					modalCanvas.addEventListener('mouseup', stopDrawing);
					modalCanvas.addEventListener('mouseout', stopDrawing);
					modalCanvas.addEventListener('touchstart', (e) => startDrawing(e, modalCanvas, modalCtx, true), { passive: false });
					modalCanvas.addEventListener('touchmove', (e) => draw(e, modalCanvas, modalCtx), { passive: false });
					modalCanvas.addEventListener('touchend', stopDrawing);
					modalCanvas.addEventListener('touchcancel', stopDrawing);
				}

				function closeSignatureModal(saveSignature) {
					if (saveSignature && hasModalSignature) {
						clearCanvas(canvas, ctx, signatureMessage, false); // Limpa o principal
						const modalSignatureData = modalCanvas.toDataURL();
						const img = new Image();
						img.onload = function() {
							const dpr = window.devicePixelRatio || 1;
							ctx.drawImage(img, 0, 0, canvas.width / dpr, canvas.height / dpr);
							hasSignature = true;
							signatureMessage.style.display = 'none';
							 signatureContainer.classList.remove('invalid'); // Remove erro ao confirmar
						};
						img.src = modalSignatureData;
					} else if (!hasSignature) { // Se cancelou e não tinha assinatura antes, limpa
						 clearCanvas(canvas, ctx, signatureMessage, false);
					 }


					modalOverlay.style.display = 'none';

					// Remove listeners específicos do modal
					modalCanvas.removeEventListener('mousedown', (e) => startDrawing(e, modalCanvas, modalCtx, true));
					 // ... (remover todos os listeners adicionados em openSignatureModal)
					 // NOTE: Para simplificar, podemos não remover se não houver problema de performance/memória visível.
					 // A forma correta seria guardar referências das funções de callback para removê-las.
				}

				// ------------------------------------------------------------------------
				// FUNÇÃO DE VALIDAÇÃO DE CPF (IMPLEMENTADA)
				// ------------------------------------------------------------------------
				function isValidCPF(cpf) {
					if (typeof cpf !== 'string') return false;
					cpf = cpf.replace(/[^\d]+/g, ''); // Remove caracteres não numéricos

					if (cpf.length !== 11 || !!cpf.match(/(\d)\1{10}/)) {
						return false;
					}

					const cpfDigits = cpf.split('').map(el => +el);

					const calculateVerifierDigit = (digits) => {
						let sum = 0;
						let multiplier = digits.length + 1;
						for (const digit of digits) {
							sum += digit * multiplier;
							multiplier--;
						}
						const remainder = (sum * 10) % 11;
						return remainder === 10 || remainder === 11 ? 0 : remainder; // Ajuste para resto 11 também ser 0
					};

					const firstVerifier = calculateVerifierDigit(cpfDigits.slice(0, 9));
					if (firstVerifier !== cpfDigits[9]) return false;

					const secondVerifier = calculateVerifierDigit(cpfDigits.slice(0, 10));
					if (secondVerifier !== cpfDigits[10]) return false;

					return true; // CPF válido
				}

				// ------------------------------------------------------------------------
				// FORMATAÇÃO E VALIDAÇÃO DE INPUTS
				// ------------------------------------------------------------------------
				 // Função auxiliar para limpar estilo de erro
				 function clearError(inputElement) {
					const fieldSpan = inputElement.parentElement; // Assume que input está dentro do span.field ou span.date-field
					 if (fieldSpan) {
						 fieldSpan.classList.remove('invalid');
					 }
					 // Opcional: Esconder mensagem de erro específica
					 const errorMsgElement = document.getElementById(inputElement.id + '-error-message');
					 if (errorMsgElement) {
						 errorMsgElement.style.display = 'none';
					 }
				 }


				if (cpfInput) {
					cpfInput.addEventListener('input', function(e) {
						clearError(e.target); // Limpa erro ao digitar
						let value = e.target.value.replace(/\D/g, '');
						if (value.length > 11) value = value.slice(0, 11);
						value = value.replace(/(\d{3})(\d)/, '$1.$2');
						value = value.replace(/(\d{3})(\d)/, '$1.$2');
						value = value.replace(/(\d{3})(\d{1,2})$/, '$1-$2');
						e.target.value = value;
					});

					// Validação no Blur (IMPLEMENTADA)
					cpfInput.addEventListener('blur', function(e) {
						const cpfValue = e.target.value;
						const fieldSpan = e.target.parentElement;
						const errorMsgElement = document.getElementById('cpf-error-message');

						if (cpfValue && !isValidCPF(cpfValue)) {
							fieldSpan?.classList.add('invalid'); // Usa optional chaining
							if (errorMsgElement) {
								errorMsgElement.textContent = 'CPF inválido';
								errorMsgElement.style.display = 'inline';
							}
						} else {
							clearError(e.target); // Limpa se válido ou vazio
						}
					});
				}

				if (valorInput) {
					valorInput.addEventListener('input', function(e) {
						clearError(e.target); // Limpa erro ao digitar
						let value = e.target.value.replace(/\D/g, '');
						if (value === '') { e.target.value = ''; return; }

						// Converte para número, formata e volta pra string
						value = (parseInt(value) / 100);
						// MELHORIA: Usar Intl.NumberFormat para formatação robusta de moeda
						e.target.value = value.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });

						// Fallback manual (menos robusto que Intl)
						// value = value.toFixed(2).replace('.', ',');
						// value = value.replace(/(\d)(?=(\d{3})+(?!\d))/g, '$1.');
						// e.target.value = value;
					});
				}

				if (diaInput) {
					 diaInput.addEventListener('input', function(e) {
						 clearError(e.target); // Limpa erro ao digitar
						 let value = e.target.value.replace(/\D/g, '');
						 if (value.length > 0) {
							 const diaNum = parseInt(value);
							 if (diaNum > 31) value = '31';
							 if (diaNum < 1) value = ''; // Não permite 0
						 }
						  if (value.length > 2) value = value.slice(0, 2); // Limita a 2 dígitos
						 e.target.value = value;
					 });
				 }
				// MELHORIA: Adicionar listener para limpar erro nos outros campos também
				 document.getElementById('nome')?.addEventListener('input', (e) => clearError(e.target));
				 document.getElementById('empresa')?.addEventListener('input', (e) => clearError(e.target));
				 document.getElementById('autorizado')?.addEventListener('input', (e) => clearError(e.target));
				 document.getElementById('pedidos')?.addEventListener('input', (e) => clearError(e.target));
				 document.getElementById('cidade')?.addEventListener('input', (e) => clearError(e.target));
				 document.getElementById('mes')?.addEventListener('input', (e) => clearError(e.target));


				if (anoInput) {
					anoInput.addEventListener('input', function(e) {
						clearError(e.target); // Limpa erro ao digitar
						let value = e.target.value.replace(/\D/g, '');
						if (value.length > 4) value = value.slice(0, 4);
						e.target.value = value;
					});
					 // MELHORIA: Validar ano minimamente no blur? (ex: > 2000 e < 2100)
					 anoInput.addEventListener('blur', function(e) {
						const year = parseInt(e.target.value);
						const currentYear = new Date().getFullYear();
						if (e.target.value && (isNaN(year) || year < currentYear - 5 || year > currentYear + 5)) { // Ex: +/- 5 anos
							 e.target.parentElement?.classList.add('invalid');
						} else {
							 clearError(e.target);
						}
					 });
				}

				// ------------------------------------------------------------------------
				// INICIALIZAÇÃO DA DATA PADRÃO
				// ------------------------------------------------------------------------
				function inicializarDataPadrao() {
					const hoje = new Date();
					const dia = hoje.getDate().toString().padStart(2, '0');
					const meses = [
						'janeiro', 'fevereiro', 'março', 'abril', 'maio', 'junho',
						'julho', 'agosto', 'setembro', 'outubro', 'novembro', 'dezembro'
					];
					const mes = meses[hoje.getMonth()];
					const ano = hoje.getFullYear();

					if (diaInput) diaInput.value = dia;
					document.getElementById('mes').value = mes; // Mês por extenso
					if (anoInput) anoInput.value = ano;
					 if (document.getElementById('cidade')) document.getElementById('cidade').value = "Americana"; // Default city?
				}

				// ------------------------------------------------------------------------
				// FIX TECLADO SOBREPONDO INPUTS (Opcional, pode causar scroll indesejado)
				// ------------------------------------------------------------------------
				function setupKeyboardVisibilityFix() {
					 const allInputs = document.querySelectorAll('input[type="text"], textarea');
					 allInputs.forEach(input => {
						 input.addEventListener('focus', function() {
							 // Atraso para teclado aparecer
							 setTimeout(() => {
								  const inputRect = this.getBoundingClientRect();
								  // Verifica se a parte inferior do input está fora da janela visível
								  if (inputRect.bottom > window.innerHeight - 50) { // 50px de margem
									 this.scrollIntoView({ behavior: 'smooth', block: 'center' }); // Rola para centralizar
								  }
							 }, 300);
						 });
					 });
				 }

				// ------------------------------------------------------------------------
				// EXPORTAR PARA PDF (MODIFICADO COM VALIDAÇÃO CPF)
				// ------------------------------------------------------------------------
				async function exportarPDF() { // MELHORIA: Usar async/await com html2canvas
					// Limpar erros antigos
					 document.querySelectorAll('.field.invalid, .date-field.invalid, .signature-pad-container.invalid').forEach(el => el.classList.remove('invalid'));
					 document.querySelectorAll('.error-message').forEach(el => el.style.display = 'none');

					const requiredFieldsIds = ['nome', 'cpf', 'empresa', 'autorizado', 'pedidos', 'valor', 'cidade', 'dia', 'mes', 'ano'];
					let isFormValid = true;
					let firstInvalidElement = null;
					 let validationMessage = 'Por favor, preencha corretamente os campos destacados.';

					requiredFieldsIds.forEach(fieldId => {
						const input = document.getElementById(fieldId);
						let isFieldValid = true;
						let specificError = '';

						if (!input || !input.value.trim()) {
							isFieldValid = false;
							 specificError = 'Campo obrigatório.';
						} else if (fieldId === 'cpf' && !isValidCPF(input.value)) {
							isFieldValid = false;
							specificError = 'CPF inválido.';
							 validationMessage = 'Por favor, verifique os campos destacados. O CPF informado parece ser inválido.';
						} else if (fieldId === 'ano') {
							const year = parseInt(input.value);
							 const currentYear = new Date().getFullYear();
							 if (isNaN(year) || year < currentYear - 10 || year > currentYear + 10) { // Validando ano +/- 10
								 isFieldValid = false;
								 specificError = 'Ano inválido.';
							 }
						 } else if (fieldId === 'dia') {
							 const day = parseInt(input.value);
							 if (isNaN(day) || day < 1 || day > 31) {
								  isFieldValid = false;
								  specificError = 'Dia inválido.';
							  }
						  }
						// MELHORIA: Adicionar validação para mês (ex: verificar se está na lista de meses)

						if (!isFieldValid) {
							isFormValid = false;
							const fieldElement = input.parentElement; // Assume input dentro de span.field/date-field
							if (fieldElement) {
								fieldElement.classList.add('invalid');
								 if (!firstInvalidElement) firstInvalidElement = input; // Guarda o primeiro campo inválido para focar

								 // Opcional: Mostrar mensagem de erro inline
								 const errorMsgElement = document.getElementById(fieldId + '-error-message');
								 if (errorMsgElement && specificError) {
									 errorMsgElement.textContent = specificError;
									 errorMsgElement.style.display = 'inline';
								 } else if (fieldElement.nextElementSibling?.classList.contains('error-message') && specificError) {
									 // Fallback se não tiver ID específico
									 fieldElement.nextElementSibling.textContent = specificError;
									 fieldElement.nextElementSibling.style.display = 'inline';
								 }
							}
						}
					});

					if (!hasSignature) {
						isFormValid = false;
						signatureContainer.classList.add('invalid');
						signatureMessage.textContent = 'Assinatura obrigatória';
						signatureMessage.style.display = 'block';
						 if (!firstInvalidElement) firstInvalidElement = signatureContainer;
						validationMessage = 'Por favor, preencha os campos destacados e forneça a assinatura.';
					}

					if (!isFormValid) {
						alert(validationMessage);
						firstInvalidElement?.focus(); // Tenta focar no primeiro campo inválido
						return;
					}

					exportButton.disabled = true;
					exportButton.textContent = 'Gerando PDF...';

					// Ocultar elementos não imprimíveis
					const noPrintElements = document.querySelectorAll('.no-print');
					noPrintElements.forEach(element => element.style.display = 'none');

					 // Pequeno atraso para garantir que estilos foram aplicados antes do html2canvas
					 await new Promise(resolve => setTimeout(resolve, 50));

					try {
						const canvasOutput = await html2canvas(printContent, {
							scale: 1.5, // Aumentar um pouco a escala para melhor qualidade
							useCORS: true,
							allowTaint: true,
							logging: false,
							scrollX: 0, // Garantir que não haja scroll horizontal
							scrollY: -window.scrollY, // Compensar scroll da página
							backgroundColor: '#ffffff', // Fundo branco explícito
							 // windowWidth: printContent.scrollWidth, // Usar largura real do conteúdo
							 // windowHeight: printContent.scrollHeight // Usar altura real do conteúdo
						});

						const imgData = canvasOutput.toDataURL('image/jpeg', 0.85); // Qualidade JPEG um pouco maior
						const { jsPDF } = window.jspdf;

						const pdf = new jsPDF({
							orientation: 'portrait',
							unit: 'mm',
							format: 'a4',
							putOnlyUsedFonts: true, // Otimização
							 compress: true // Já estava habilitado
						});

						const pdfWidth = pdf.internal.pageSize.getWidth();
						const pdfHeight = pdf.internal.pageSize.getHeight();
						const margin = 15; // Margem um pouco maior
						const contentWidth = pdfWidth - (margin * 2);
						const contentHeight = canvasOutput.height * contentWidth / canvasOutput.width;
						let finalHeight = contentHeight;
						 let finalWidth = contentWidth;
						 let positionY = margin;


						 // Se o conteúdo for maior que a página, redimensiona para caber
						if (contentHeight > pdfHeight - (margin * 2)) {
							finalHeight = pdfHeight - (margin * 2);
							finalWidth = canvasOutput.width * finalHeight / canvasOutput.height; // Recalcula largura proporcional
						}

						// Centraliza horizontalmente
						 const positionX = (pdfWidth - finalWidth) / 2;

						pdf.addImage(imgData, 'JPEG', positionX, positionY, finalWidth, finalHeight, undefined, 'FAST');

						const nomeArquivo = `Autorizacao_Retirada_${document.getElementById('empresa')?.value || 'Cliente'}_${new Date().toLocaleDateString('sv')}.pdf`; // Data yyyy-mm-dd
						pdf.save(nomeArquivo);

						successMessage.style.display = 'flex';
						setTimeout(() => { successMessage.style.display = 'none'; }, 4000); // Aumenta tempo da msg

					} catch (error) {
						console.error('Erro ao gerar PDF:', error);
						alert('Ocorreu um erro ao gerar o PDF. Verifique o console para detalhes.');
					} finally {
						// Restaurar elementos e botão
						noPrintElements.forEach(element => element.style.display = ''); // Restaura display original
						exportButton.disabled = false;
						exportButton.textContent = 'Gerar PDF';
					}
				}


				// ------------------------------------------------------------------------
				// EVENTOS E INICIALIZAÇÃO GERAL
				// ------------------------------------------------------------------------
				 // Função unificada para resize/orientation change (MODIFICADA)
				 function handleResizeOrOrientationChange() {
					 // Salva assinatura do modal ANTES de redimensionar
					 if (modalOverlay.style.display === 'flex' && hasModalSignature) {
						 tempSignatureDataUrl = modalCanvas.toDataURL();
					 } else {
						 tempSignatureDataUrl = null;
					 }

					 resizeCanvas(canvas, ctx); // Redimensiona principal
					 if (modalOverlay.style.display === 'flex') {
						 resizeModalCanvas(); // Redimensiona modal (que vai restaurar)
					 }
					 checkOrientation(); // Ajusta CSS se necessário
				 }

				 function checkOrientation() {
					 // Não é mais necessário adicionar/remover classe 'landscape' se o CSS já lida com @media (orientation: landscape)
					 // const modal = document.querySelector('.signature-modal');
					 // if (window.matchMedia("(orientation: landscape)").matches) {
					 //     modal?.classList.add('landscape');
					 // } else {
					 //      modal?.classList.remove('landscape');
					 // }
				 }

				 // Event Listeners
				window.addEventListener('load', () => {
					resizeCanvas(canvas, ctx);
					resizeModalCanvas(); // Inicializa o tamanho do modal também
					inicializarDataPadrao();
					 // setupKeyboardVisibilityFix(); // Descomentar se necessário, mas pode ser intrusivo
					checkOrientation();
				});

				window.addEventListener('orientationchange', () => {
					 setTimeout(handleResizeOrOrientationChange, 150); // Timeout para garantir dimensões corretas
				 });
				window.addEventListener('resize', () => {
					 setTimeout(handleResizeOrOrientationChange, 150);
				 });

				// Listeners Canvas Principal
				canvas.addEventListener('mousedown', (e) => startDrawing(e, canvas, ctx, false));
				canvas.addEventListener('mousemove', (e) => draw(e, canvas, ctx));
				canvas.addEventListener('mouseup', stopDrawing);
				canvas.addEventListener('mouseout', stopDrawing);
				canvas.addEventListener('touchstart', (e) => startDrawing(e, canvas, ctx, false), { passive: false });
				canvas.addEventListener('touchmove', (e) => draw(e, canvas, ctx), { passive: false });
				canvas.addEventListener('touchend', stopDrawing);
				canvas.addEventListener('touchcancel', stopDrawing);

				// Listeners Botões Principais
				clearButton.addEventListener('click', () => clearCanvas(canvas, ctx, signatureMessage, false));
				expandButton.addEventListener('click', openSignatureModal);
				exportButton.addEventListener('click', exportarPDF);

				// Listeners Botões Modal
				modalConfirmBtn.addEventListener('click', () => {
					if (hasModalSignature) {
						closeSignatureModal(true); // Salva assinatura
					} else {
						alert('Por favor, faça sua assinatura antes de confirmar.');
					}
				});
				modalClearBtn.addEventListener('click', () => clearCanvas(modalCanvas, modalCtx, modalMessage, true));
				modalCancelBtn.addEventListener('click', () => closeSignatureModal(false)); // Não salva

				// Fechar Modal Clicando Fora
				modalOverlay.addEventListener('click', (e) => {
					if (e.target === modalOverlay) {
						closeSignatureModal(false); // Não salva
					}
				});

				 // MELHORIA SUGESTÃO: Poderia haver mais refatoração aqui, separando lógica
				 // de UI, validação e desenho em módulos ou classes distintas para melhor manutenção.

			}); // Fim DOMContentLoaded
		</script>
	</body>
	</html>
