<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>Autorização de Retirada - Ameripan (v6)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <style>
        /* --- Estilos CSS (sem alterações da v5) --- */
        @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&family=Poppins:wght@400;500;600&display=swap');

        :root {
            --primary-color: #005A9C; /* Azul Ameripan mais forte */
            --secondary-color: #F58220; /* Laranja Ameripan */
            --accent-color: #007BFF; /* Azul mais vibrante para botões/links */
            --light-bg: #F8F9FA;
            --dark-bg: #343A40;
            --text-color: #212529;
            --light-text: #6C757D;
            --border-color: #DEE2E6;
            --success-color: #28A745;
            --error-color: #DC3545;
            --white-color: #FFFFFF;
            --input-border-color: #CED4DA;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        html {
            font-size: 16px;
        }

        body {
            font-family: 'Poppins', 'Arial', sans-serif;
            max-width: 100%;
            margin: 0 auto;
            padding: 1.25rem; /* 20px */
            background-color: var(--light-bg);
            line-height: 1.6;
            color: var(--text-color);
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            touch-action: manipulation;
        }

        .container {
            background-color: var(--white-color);
            padding: 2rem; /* 32px */
            border-radius: 8px;
            box-shadow: 0 6px 18px rgba(0, 0, 0, 0.1);
            max-width: 800px;
            margin: 1rem auto;
        }

        .brand-header {
            text-align: center;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border-color);
        }
        .logo-container {
            margin-bottom: 1rem;
        }
        .logo {
            max-width: 180px;
            height: auto;
            display: block;
            margin: 0 auto;
        }
        .brand-slogan {
            font-family: 'Montserrat', sans-serif;
            font-style: italic;
            color: var(--secondary-color);
            font-size: 1.1rem;
            font-weight: 500;
            margin-top: 0.5rem;
        }

        h1 {
            text-align: center;
            margin-bottom: 2rem;
            font-size: 1.4rem;
            color: var(--primary-color);
            font-family: 'Montserrat', sans-serif;
            font-weight: 600;
        }

        .form-content {
            font-size: 1rem;
            line-height: 1.8;
            margin-bottom: 2rem;
        }

        .field {
            display: inline-block;
            border-bottom: 2px solid var(--input-border-color);
            min-width: 150px;
            padding: 0 5px 2px 5px;
            position: relative;
            margin: 0 3px;
            transition: border-color 0.2s ease-in-out;
        }
        .field:focus-within {
             border-bottom-color: var(--primary-color);
        }
        .field.invalid, .date-field.invalid {
            border-bottom-color: var(--error-color);
        }

        .error-message {
            color: var(--error-color);
            font-size: 0.75rem;
            margin-left: 5px;
            display: none;
            position: absolute;
            bottom: -18px;
            left: 0;
            white-space: nowrap;
        }
        .field.invalid .error-message {
             display: inline;
        }

        .field-input {
            border: none;
            outline: none;
            width: 100%;
            background: transparent;
            font-family: 'Poppins', 'Arial', sans-serif;
            padding: 2px 0;
            font-weight: 500; /* Input fields appear boldish */
            font-size: 1rem;
            color: var(--text-color);
        }
        .field-input::placeholder {
            color: #a9a9a9;
            opacity: 1;
            font-weight: 400;
            font-style: italic;
        }
        .field-input:-ms-input-placeholder { color: #a9a9a9; font-weight: 400; font-style: italic; }
        .field-input::-ms-input-placeholder { color: #a9a9a9; font-weight: 400; font-style: italic; }

        .footer-section {
            margin-top: 2.5rem;
            padding-top: 1.5rem;
            border-top: 1px solid var(--border-color);
        }

        .date-location-row {
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            flex-wrap: wrap;
            gap: 1rem;
            margin-bottom: 2.5rem;
        }

        .location-block, .date-block {
            flex-basis: calc(50% - 0.5rem);
            min-width: 200px;
        }

        .date-block { text-align: right; }

        .date-label, .location-label {
            display: block;
            font-size: 0.875rem;
            color: var(--light-text);
            margin-bottom: 0.25rem;
            font-weight: 500;
        }

        .date-field {
            display: inline-block;
            width: auto;
            min-width: 40px;
            text-align: center;
            border-bottom: 2px solid var(--input-border-color);
            padding: 0 3px 2px 3px;
            margin: 0 2px;
            transition: border-color 0.2s ease-in-out;
        }
         .date-field:focus-within {
             border-bottom-color: var(--primary-color);
         }
        .date-field input {
            width: 100%;
            text-align: center;
            border: none;
            outline: none;
            background: transparent;
            font-family: 'Poppins', 'Arial', sans-serif;
            font-weight: 500; /* Input fields appear boldish */
            font-size: 1rem;
        }
        #mes { min-width: 100px; }

        /* Signature Section Layout */
        .signature-area {
            display: flex;
            justify-content: center;
            margin-bottom: 2rem;
            padding: 0 5px;
        }

        .signature-section {
            width: 100%;
            text-align: center;
        }

        .signature-pad-container {
            border: 1px solid var(--input-border-color);
            margin: 0 auto 0.5rem auto;
            width: 100%;
            height: 180px;
            position: relative;
            background-color: #fdfdfd;
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.05);
            border-radius: 4px;
            overflow: hidden;
            touch-action: none;
            -webkit-tap-highlight-color: transparent;
            cursor: crosshair;
        }
        .signature-pad-container.invalid { border-color: var(--error-color); }
        .signature-pad-container.invalid .signature-message { color: var(--error-color); }

        #signature-pad { width: 100%; height: 100%; display: block; }

        .signature-line {
            width: 100%;
            margin: 0 auto 0.25rem auto;
            border-top: 1px solid var(--text-color);
            padding-top: 0.25rem;
        }

        .signature-name-display {
            font-size: 0.875rem;
            color: var(--text-color);
            font-weight: 500;
            text-align: center;
            min-height: 1.2em;
            text-transform: uppercase;
             margin-bottom: 0.25rem;
        }

        .signature-labels-container {
             font-size: 0.8rem;
             color: var(--light-text);
             text-align: center;
             line-height: 1.4;
             margin-bottom: 1rem;
        }
        .signature-labels-container p {
            margin: 0;
        }

        .signature-message {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            color: #aaa;
            font-size: 0.9rem;
            text-align: center;
            pointer-events: none;
            user-select: none;
            opacity: 0.8;
            padding: 0 10px;
        }

        .controls { display: flex; gap: 0.75rem; margin-top: 0.75rem; justify-content: center; flex-wrap: wrap; }

        /* Buttons */
        .button {
            padding: 0.65rem 1rem; background-color: var(--accent-color); color: var(--white-color); border: none;
            border-radius: 5px; cursor: pointer; font-size: 0.875rem; font-weight: 600; font-family: 'Montserrat', sans-serif;
            transition: background-color 0.2s ease, box-shadow 0.2s ease, transform 0.1s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); display: inline-flex; align-items: center; justify-content: center;
            gap: 0.5rem; text-transform: uppercase; letter-spacing: 0.5px;
        }
        .button:hover:not(:disabled) { background-color: #0056b3; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15); }
        .button:active:not(:disabled) { transform: translateY(1px); box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1); }
        .button:disabled { background-color: #adb5bd; cursor: not-allowed; box-shadow: none; }
        .button.clear-button { background-color: #ffc107; color: var(--text-color); }
        .button.clear-button:hover:not(:disabled) { background-color: #e0a800; }
        .button.expand-button { background-color: var(--light-text); }
        .button.expand-button:hover:not(:disabled) { background-color: #5a6268; }
        .button.export-button {
            background-color: var(--success-color); margin-top: 1.5rem; padding: 0.8rem 1.5rem; font-size: 1rem;
            width: 100%; max-width: 300px; display: block; margin-left: auto; margin-right: auto;
        }
        .button.export-button:hover:not(:disabled) { background-color: #218838; }

        /* Modal Assinatura */
        .signature-modal-overlay {
            display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background-color: rgba(0, 0, 0, 0.7); z-index: 1000; backdrop-filter: blur(4px); -webkit-backdrop-filter: blur(4px);
            align-items: center; justify-content: center; padding: 0.5rem;
        }
        .signature-modal {
            width: 98%; max-width: 800px; background-color: var(--white-color); border-radius: 8px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2); padding: 1rem; z-index: 1001;
            display: flex; flex-direction: column; max-height: 95vh;
        }
        .signature-modal-title {
            text-align: center; font-size: 1.1rem; margin-bottom: 0.75rem; color: var(--primary-color);
            font-weight: 600; font-family: 'Montserrat', sans-serif; flex-shrink: 0;
        }
        .signature-modal-canvas-container {
            border: 1px solid var(--border-color); width: 100%; flex-shrink: 1; flex-grow: 1;
            background-color: #fdfdfd; box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.05); overflow: hidden;
            touch-action: none; -webkit-tap-highlight-color: transparent; margin-bottom: 1rem; position: relative;
            border-radius: 4px; cursor: crosshair; min-height: 250px;
        }
        #signature-modal-canvas { width: 100%; height: 100%; display: block; }
        .signature-modal-message {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: #aaa;
            font-size: 1.1rem; text-align: center; pointer-events: none; user-select: none; opacity: 0.8;
        }
        .signature-modal-buttons {
            display: flex; justify-content: center; gap: 1rem; flex-wrap: wrap; margin-top: auto; flex-shrink: 0;
        }
        .modal-btn {
            padding: 0.75rem 1.25rem; border-radius: 5px; border: none; color: var(--white-color); font-size: 0.9rem;
            font-weight: 600; cursor: pointer; display: inline-flex; align-items: center; justify-content: center;
            min-width: 120px; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.15);
            transition: background-color 0.2s ease, transform 0.1s ease, box-shadow 0.2s ease;
            font-family: 'Montserrat', sans-serif; text-transform: uppercase; letter-spacing: 0.5px;
        }
        .modal-btn:active { transform: translateY(1px); box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1); }
        .modal-btn-confirm { background-color: var(--success-color); }
        .modal-btn-confirm:hover { background-color: #218838; }
        .modal-btn-clear { background-color: var(--error-color); }
        .modal-btn-clear:hover { background-color: #c82333; }
        .modal-btn-cancel { background-color: var(--light-text); }
        .modal-btn-cancel:hover { background-color: #5a6268; }
        .modal-btn-icon { margin-right: 0.5rem; font-size: 1.1em; }

        /* Success Message */
        .success-message {
            display: none; /* Initially hidden */
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(255, 255, 255, 0.95); z-index: 2000; justify-content: center;
            align-items: center; flex-direction: column; text-align: center; padding: 1rem;
        }
        .success-content {
            background-color: var(--success-color); color: var(--white-color); padding: 2.5rem; border-radius: 10px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2); max-width: 90%; width: 400px;
        }
        .success-icon { font-size: 4rem; margin-bottom: 1.5rem; }
        .success-content h2 { font-family: 'Montserrat', sans-serif; margin-bottom: 0.5rem; font-size: 1.5rem; }
        .success-content p { margin-bottom: 1.5rem; font-size: 1rem; }

        /* Company Info Footer */
        .company-info {
            text-align: center; margin-top: 2.5rem; padding-top: 1.5rem; border-top: 1px solid var(--border-color);
            color: var(--light-text); font-size: 0.875rem;
        }
        .company-info p { margin-bottom: 0.25rem; }

        /* Print Styles */
        .no-print { display: revert; }
        .pdf-generation-active .no-print { display: none !important; }

        /* Responsive Adjustments */
        @media (max-width: 768px) {
            body { padding: 0.75rem; }
            .container { padding: 1.5rem; }
            h1 { font-size: 1.25rem; }
            .form-content { font-size: 0.95rem; }
            .field { min-width: 130px; }
            .date-location-row { flex-direction: column; align-items: flex-start; gap: 1.5rem; }
            .location-block, .date-block { flex-basis: 100%; text-align: left; }
        }
        @media (max-width: 480px) {
            html { font-size: 15px; }
            .container { padding: 1rem; }
            h1 { font-size: 1.15rem; }
            .field { min-width: 100px; }
            .button { width: calc(50% - 0.5rem); font-size: 0.8rem; padding: 0.6rem 0.8rem; }
            .button.export-button { width: 100%; max-width: none; font-size: 0.9rem; }
            .signature-modal-buttons { gap: 0.75rem; }
            .modal-btn { min-width: 100px; padding: 0.6rem 1rem; font-size: 0.85rem; }
            .signature-modal-canvas-container { min-height: 200px; }
        }
         @media (orientation: landscape) and (max-height: 500px) {
             .signature-modal { max-height: 90vh; padding: 0.75rem; }
             .signature-modal-canvas-container { min-height: 150px; margin-bottom: 0.75rem; }
             .signature-modal-title { font-size: 1rem; margin-bottom: 0.5rem; }
             .modal-btn { padding: 0.5rem 0.9rem; font-size: 0.8rem; min-width: 90px; }
             .signature-modal-buttons { gap: 0.5rem; }
         }

         /* Spinning animation */
         @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
         .spinner { animation: spin 1s linear infinite; }

    </style>
</head>
<body>
    <div class="container" id="form-container">
        <div class="brand-header">
            <div class="logo-container">
                <img src="https://raw.githubusercontent.com/Edimarpcosta/edimarpcosta.github.io/refs/heads/main/ameripan/retirada/logo.webp" alt="Ameripan Logo" class="logo" id="company-logo" crossorigin="anonymous">
            </div>
            <p class="brand-slogan">Ameripan, mais sabor ao seu negócio!</p>
        </div>
        <h1>AUTORIZAÇÃO DE RETIRADA DE MERCADORIA</h1>

        <div class="form-content">
            Eu, <span class="field"><input type="text" class="field-input" id="nome" placeholder="Nome proprietário/sócio" required><span class="error-message"></span></span>,
            portador do CPF <span class="field"><input type="text" class="field-input" id="cpf" inputmode="numeric" placeholder="___.___.___-__" required><span class="error-message" id="cpf-error-message"></span></span>,
            proprietário(a) da empresa <span class="field"><input type="text" class="field-input" id="empresa" placeholder="Nome da empresa" required><span class="error-message"></span></span>,
            autorizo o(a) Sr(a). <span class="field"><input type="text" class="field-input" id="autorizado" placeholder="Nome autorizado" required><span class="error-message"></span></span>
            a retirar o(s) pedido(s) nº <span class="field"><input type="text" class="field-input" id="pedidos" placeholder="Números dos pedidos" required><span class="error-message"></span></span>,
            no valor total de R$ <span class="field"><input type="text" class="field-input" id="valor" inputmode="decimal" placeholder="0,00" required><span class="error-message"></span></span>
            no Depósito da empresa Ameripan, localizado na Rua Purus, nº 652, Bairro Jd. São Roque.
        </div>

        <div class="date-location-row">
             <div class="location-block">
                 <label class="location-label" for="cidade">Local:</label>
                 <span class="field" style="min-width: 200px;"><input type="text" class="field-input" id="cidade" required placeholder="Sua cidade"><span class="error-message"></span></span>
             </div>
             <div class="date-block">
                 <label class="date-label">Data:</label>
                 <span class="date-field"><input type="text" id="dia" maxlength="2" placeholder="DD" inputmode="numeric" required><span class="error-message"></span></span> de
                 <span class="date-field" id="mes-field"><input type="text" id="mes" placeholder="Mês por extenso" required><span class="error-message"></span></span> de
                 <span class="date-field"><input type="text" id="ano" maxlength="4" placeholder="AAAA" inputmode="numeric" required><span class="error-message"></span></span>
             </div>
        </div>

        <div class="signature-area">
            <div class="signature-section">
                <div class="signature-pad-container" id="signature-container">
                    <canvas id="signature-pad"></canvas>
                    <div class="signature-message" id="signature-message">Assine aqui (Proprietário/Sócio)</div>
                </div>
                 <div class="signature-line"></div>
                 <div class="signature-name-display" id="owner-name-display"></div>
                 <div class="signature-labels-container">
                     <p>(Assinatura Proprietário/Sócio)</p>
                     <p id="authorized-signature-label" style="display: none;">(Assinatura Responsável pela Retirada)</p>
                 </div>
                 <div class="controls no-print">
                    <button class="button clear-button" id="clear-signature" title="Limpar Assinatura">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-eraser-fill" viewBox="0 0 16 16"><path d="M8.086 2.207a2 2 0 0 1 2.828 0l3.879 3.879a2 2 0 0 1 0 2.828l-5.5 5.5A2 2 0 0 1 7.879 15H5.12a2 2 0 0 1-1.414-.586l-2.5-2.5a2 2 0 0 1 0-2.828zm.66 11.34L3.453 8.254 1.914 9.793a1 1 0 0 0 0 1.414l2.5 2.5a1 1 0 0 0 .707.293H7.88a1 1 0 0 0 .707-.293z"/></svg>
                        Limpar
                    </button>
                    <button class="button expand-button" id="expand-signature" title="Expandir Assinatura">
                         <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-arrows-fullscreen" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M5.828 10.172a.5.5 0 0 0-.707 0l-4.096 4.096V11.5a.5.5 0 0 0-1 0v3.975a.5.5 0 0 0 .5.5H4.5a.5.5 0 0 0 0-1H1.732l4.096-4.096a.5.5 0 0 0 0-.707m4.344 0a.5.5 0 0 1 .707 0l4.096 4.096V11.5a.5.5 0 1 1 1 0v3.975a.5.5 0 0 1-.5.5H11.5a.5.5 0 0 1 0-1h2.768l-4.096-4.096a.5.5 0 0 1 0-.707m0-4.344a.5.5 0 0 0 .707 0l4.096-4.096V4.5a.5.5 0 1 0 1 0V.525a.5.5 0 0 0-.5-.5H11.5a.5.5 0 0 0 0 1h2.768l-4.096 4.096a.5.5 0 0 0 0 .707m-4.344 0a.5.5 0 0 1-.707 0L1.025 1.732V4.5a.5.5 0 0 1-1 0V.525a.5.5 0 0 1 .5-.5H4.5a.5.5 0 0 1 0 1H1.732l4.096 4.096a.5.5 0 0 1 0 .707"/></svg>
                        Expandir
                    </button>
                </div>
            </div>
            </div>

        <div class="footer-section">
            <div class="company-info">
                <p>AMERIPAN COMERCIO DE PRODUTOS ALIMENTICIOS LTDA</p>
                <p>CNPJ: 65.029.035/0001-07</p>
                <p>Rua Purus, 652 - Jardim São Roque - Americana/SP - CEP: 13469-130</p>
            </div>
        </div>
    </div>

    <div style="text-align: center; margin-top: 1.5rem;" class="no-print">
        <button class="button export-button" id="export-pdf">
             <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" class="bi bi-file-earmark-pdf-fill" viewBox="0 0 16 16">
                <path d="M5.523 12.424q.21-.124.459-.238a8 8 0 0 1-.45.606c-.28.337-.498.516-.635.572l-.035.012a.3.3 0 0 1-.026-.044c-.03-.05-.054-.114-.08-.193.026-.043.05-.088.075-.134.036-.067.07-.146.104-.234.05-.132.104-.27.16-.408.066-.16.132-.318.2-.477a5 5 0 0 1 .455-.68.5.5 0 0 0 .085-.488c-.08-.17-.148-.305-.196-.396a.7.7 0 0 1 .058-.82q.08-.08.144-.134c.048-.04.09-.07.122-.088a.8.8 0 0 1 .258-.087c.032-.003.058-.005.077-.005.023 0 .06.003.11.003.069 0 .106.005.122.008.04.008.074.026.09.044.018.017.026.03.026.036a.5.5 0 0 1-.034.475q-.05.08-.104.147c-.052.062-.108.135-.168.227-.06.09-.116.19-.164.303a.8.8 0 0 0 .034.886c.074.11.158.247.25.397.084.136.176.29.275.454a4.2 4.2 0 0 0 .405.614c.02.028.04.052.06.07a1 1 0 0 0 .117.258c.097.164.187.318.271.463.08.14.15.27.21.388.06.117.11.228.15.336a.8.8 0 0 0 .13.388q.078.153.088.271a.7.7 0 0 0-.04.345c-.008.065-.02.11-.034.134a.5.5 0 0 1-.058.199c-.01.015-.024.028-.044.038a.3.3 0 0 1-.056.023c-.03.007-.07.01-.12.01-.068 0-.12-.003-.15-.007a.7.7 0 0 1-.29-.065c-.102-.05-.23-.145-.392-.287a8 8 0 0 1-.566-.534c-.05-.08-.1-.155-.145-.225a.5.5 0 0 1 .034-.518m-1.635-2.057a.6.6 0 0 1-.03-.116c.003-.022.007-.046.012-.07.005-.024.01-.048.015-.073a.4.4 0 0 0 0-.11c-.003-.05-.01-.102-.02-.153a.5.5 0 0 0-.04-.153c-.02-.04-.04-.074-.066-.1a.5.5 0 0 0-.048-.078.4.4 0 0 0-.07-.06c-.03-.017-.06-.03-.096-.037a.3.3 0 0 0-.114-.007h-.022c-.04 0-.07.002-.09.005a.4.4 0 0 0-.085.021.5.5 0 0 0-.078.037.4.4 0 0 0-.068.048.5.5 0 0 0-.06.077.5.5 0 0 0-.047.096c-.015.036-.027.078-.035.127a.5.5 0 0 0-.015.127c-.003.047-.003.09 0 .122a.4.4 0 0 0 .012.104.4.4 0 0 0 .028.092c.016.03.036.056.06.075a.4.4 0 0 0 .075.06.5.5 0 0 0 .094.04c.036.01.07.014.1.014.048 0 .087-.004.118-.01a.5.5 0 0 0 .106-.037c.032-.017.06-.037.082-.06a.5.5 0 0 0 .062-.077.5.5 0 0 0 .048-.097m.188-1.085c.018-.026.03-.05.036-.07a.4.4 0 0 0 0-.07c-.004-.028-.008-.057-.012-.086a.5.5 0 0 0-.012-.09.4.4 0 0 0-.02-.076c-.01-.025-.025-.047-.04-.067a.4.4 0 0 0-.05-.05.4.4 0 0 0-.067-.04.4.4 0 0 0-.076-.025.4.4 0 0 0-.086-.012.4.4 0 0 0-.09 0c-.03.004-.057.008-.08.012a.4.4 0 0 0-.07.025c-.025.01-.047.025-.067.04a.4.4 0 0 0-.05.05c-.017.024-.03.05-.04.076a.5.5 0 0 0-.02.09c-.004.03-.008.06-.012.086a.4.4 0 0 0 0 .07c.004.028.008.056.012.084a.4.4 0 0 0 .012.09.4.4 0 0 0 .02.076c.01.025.025.047.04.067a.4.4 0 0 0 .05.05c.024.017.05.03.076.04a.4.4 0 0 0 .086.012.4.4 0 0 0 .09 0c.03-.004.057-.008.08-.012a.4.4 0 0 0 .07-.025c.025-.01.047-.025.067-.04a.4.4 0 0 0 .05-.05c.017-.024.03-.05.04-.076zm.03-1.177a.8.8 0 0 1-.134-.08c-.02-.013-.036-.025-.05-.035a.4.4 0 0 0-.05-.03c-.02-.01-.036-.017-.05-.02a.3.3 0 0 0-.048-.008.3.3 0 0 0-.05 0 .3.3 0 0 0-.048.008c-.015.003-.03.01-.05.02a.4.4 0 0 0-.05.03.4.4 0 0 0-.05.035c-.015.01-.03.022-.05.035a.8.8 0 0 1-.134.08c-.03.017-.056.03-.076.037a.3.3 0 0 1-.108.02h-.034a.3.3 0 0 1-.108-.02c-.02-.007-.046-.02-.076-.037a.8.8 0 0 1-.134-.08c-.02-.013-.036-.025-.05-.035a.4.4 0 0 0-.05-.03c-.02-.01-.036-.017-.05-.02a.3.3 0 0 0-.048-.008.3.3 0 0 0-.05 0 .3.3 0 0 0-.048.008c-.015.003-.03.01-.05.02a.4.4 0 0 0-.05.03.4.4 0 0 0-.05.035c-.015.01-.03.022-.05.035a.8.8 0 0 1-.134.08c-.03.017-.056.03-.076.037a.3.3 0 0 1-.108.02h-.034a.3.3 0 0 1-.108-.02c-.02-.007-.046-.02-.076-.037a.8.8 0 0 1-.134-.08c-.02-.013-.036-.025-.05-.035a.4.4 0 0 0-.05-.03c-.02-.01-.036-.017-.05-.02a.3.3 0 0 0-.048-.008.3.3 0 0 0-.05 0 .3.3 0 0 0-.048.008 1 1 0 0 0-.05.02a.4.4 0 0 0-.05.03.4.4 0 0 0-.05.035c-.015.01-.03.022-.05.035a.8.8 0 0 1-.134.08c-.03.017-.056.03-.076.037a.3.3 0 0 1-.108.02h-.034a.3.3 0 0 1-.108-.02c-.02-.007-.046-.02-.076-.037a.8.8 0 0 1-.134-.08c-.02-.013-.036-.025-.05-.035a.4.4 0 0 0-.05-.03c-.02-.01-.036-.017-.05-.02a.3.3 0 0 0-.048-.008.3.3 0 0 0-.05 0 .3.3 0 0 0-.048.008c-.014.003-.03.01-.05.02a.4.4 0 0 0-.05.03.4.4 0 0 0-.05.035c-.015.01-.03.022-.05.035a.8.8 0 0 1-.134.08c-.03.017-.056.03-.076.037a.3.3 0 0 1-.108.02h-.034a.3.3 0 0 1-.108-.02c-.02-.007-.046-.02-.076-.037Z"/>
                <path d="M4.603 14.087a.8.8 0 0 1-1.206 0l-1.5-1.5a.8.8 0 0 1 0-1.207l6.5-6.5a.8.8 0 0 1 1.207 0l1.5 1.5a.8.8 0 0 1 0 1.207l-6.5 6.5zm-1.06-1.06L6.5 6.087l.94.94-6 6z"/>
                <path fill-rule="evenodd" d="M14 2.5a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-1 0V3h-.5a.5.5 0 0 1-.5-.5V2H2v1h-.5A.5.5 0 0 1 1 3.5v1a.5.5 0 0 1-1 0V2a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2v1.5a.5.5 0 0 1-1 0V3h-.5a.5.5 0 0 1-.5.5z"/>
             </svg>
            Gerar PDF
        </button>
    </div>

    <div class="signature-modal-overlay no-print" id="signature-modal-overlay">
        <div class="signature-modal" role="dialog" aria-modal="true" aria-labelledby="signature-modal-title">
            <h2 class="signature-modal-title" id="signature-modal-title">Assinatura Digital</h2>
            <div class="signature-modal-canvas-container">
                <canvas id="signature-modal-canvas"></canvas>
                <div class="signature-modal-message" id="signature-modal-message">Assine aqui</div>
            </div>
            <div class="signature-modal-buttons">
                 <button class="modal-btn modal-btn-confirm" id="modal-confirm">
                     <span class="modal-btn-icon">✓</span> Confirmar
                 </button>
                 <button class="modal-btn modal-btn-clear" id="modal-clear">
                     <span class="modal-btn-icon">✗</span> Limpar
                 </button>
                 <button class="modal-btn modal-btn-cancel" id="modal-cancel">
                     <span class="modal-btn-icon">←</span> Voltar
                 </button>
            </div>
        </div>
    </div>

    <div class="success-message no-print" id="success-message">
        <div class="success-content">
            <div class="success-icon">✓</div>
            <h2>PDF Gerado com Sucesso!</h2>
            <p>O download deve iniciar automaticamente.</p>
            <button class="modal-btn modal-btn-cancel" style="margin-top: 15px;" id="close-success-btn">Fechar</button>
        </div>
    </div>

    <script>
        'use strict';

        document.addEventListener('DOMContentLoaded', function() {
            // --- DOM Elements ---
            const canvas = document.getElementById('signature-pad');
            const signatureMessage = document.getElementById('signature-message');
            const clearButton = document.getElementById('clear-signature');
            const expandButton = document.getElementById('expand-signature');
            const signatureContainer = document.getElementById('signature-container');
            const exportButton = document.getElementById('export-pdf');
            const successMessage = document.getElementById('success-message');
            const modalOverlay = document.getElementById('signature-modal-overlay');
            const modalCanvas = document.getElementById('signature-modal-canvas');
            const modalMessage = document.getElementById('signature-modal-message');
            const modalConfirmBtn = document.getElementById('modal-confirm');
            const modalClearBtn = document.getElementById('modal-clear');
            const modalCancelBtn = document.getElementById('modal-cancel');
            const closeSuccessBtn = document.getElementById('close-success-btn');
            const cpfInput = document.getElementById('cpf');
            const valorInput = document.getElementById('valor');
            const diaInput = document.getElementById('dia');
            const mesInput = document.getElementById('mes');
            const anoInput = document.getElementById('ano');
            const nomeInput = document.getElementById('nome');
            const empresaInput = document.getElementById('empresa');
            const autorizadoInput = document.getElementById('autorizado');
            const pedidosInput = document.getElementById('pedidos');
            const cidadeInput = document.getElementById('cidade');
            const formContainer = document.getElementById('form-container');
            const ownerNameDisplay = document.getElementById('owner-name-display');
            const authorizedSignatureLabel = document.getElementById('authorized-signature-label');
            const companyLogo = document.getElementById('company-logo');

            // --- Canvas Contexts and State ---
            const ctx = canvas.getContext('2d');
            const modalCtx = modalCanvas.getContext('2d');
            let isDrawing = false;
            let points = [];
            let hasSignature = false;
            let hasModalSignature = false;
            let tempSignatureDataUrl = null;
            let tempMainSignatureDataUrl = null;

            // --- Constants ---
            const SIGNATURE_LINE_COLOR = '#005A9C';
            const SIGNATURE_LINE_WIDTH = 2.5;

            // ========================================================================
            // CANVAS DRAWING FUNCTIONS (Smoothing logic unchanged)
            // ========================================================================
            function setupCanvasContext(context, canvasElement) {
                const dpr = window.devicePixelRatio || 1;
                context.resetTransform(); context.scale(dpr, dpr);
                context.lineWidth = SIGNATURE_LINE_WIDTH; context.lineCap = 'round';
                context.lineJoin = 'round'; context.strokeStyle = SIGNATURE_LINE_COLOR;
                context.imageSmoothingEnabled = true; context.imageSmoothingQuality = 'high';
            }

            function resizeCanvas(canvasElement, context, isModal = false) {
                const container = canvasElement.parentElement; if (!container) return;
                const saveDataUrl = isModal ? tempSignatureDataUrl : tempMainSignatureDataUrl;
                const currentHasSignature = isModal ? hasModalSignature : hasSignature;
                const messageElement = isModal ? modalMessage : signatureMessage;
                const containerWidth = container.clientWidth;
                const containerHeight = isModal ? Math.max(container.clientHeight, 250) : container.clientHeight;
                canvasElement.style.width = `${containerWidth}px`; canvasElement.style.height = `${containerHeight}px`;
                const dpr = window.devicePixelRatio || 1;
                canvasElement.width = Math.floor(containerWidth * dpr); canvasElement.height = Math.floor(containerHeight * dpr);
                setupCanvasContext(context, canvasElement);
                if (saveDataUrl) {
                    const img = new Image();
                    img.onload = () => { context.drawImage(img, 0, 0, canvasElement.width / dpr, canvasElement.height / dpr); };
                    img.src = saveDataUrl;
                    if (messageElement) messageElement.style.display = 'none';
                    if (isModal) tempSignatureDataUrl = null; else tempMainSignatureDataUrl = null;
                } else if (!currentHasSignature && messageElement) { messageElement.style.display = 'block'; }
            }

            function getCanvasCoordinates(element, clientX, clientY) {
                const rect = element.getBoundingClientRect();
                return { x: clientX - rect.left, y: clientY - rect.top };
            }

            function startDrawing(e, currentCanvas, currentCtx, isModal) {
                e.preventDefault(); isDrawing = true; points = [];
                let clientX, clientY;
                if (e.type.startsWith('touch')) { clientX = e.touches[0].clientX; clientY = e.touches[0].clientY; }
                else { clientX = e.clientX; clientY = e.clientY; }
                const coords = getCanvasCoordinates(currentCanvas, clientX, clientY);
                points.push({ x: coords.x, y: coords.y });
                const messageElement = isModal ? modalMessage : signatureMessage;
                if (messageElement) messageElement.style.display = 'none';
                if (isModal) { hasModalSignature = true; }
                else {
                    hasSignature = true; signatureContainer.classList.remove('invalid');
                    if (authorizedSignatureLabel) authorizedSignatureLabel.style.display = 'block'; // Show 2nd label
                }
                currentCtx.beginPath(); currentCtx.arc(coords.x, coords.y, SIGNATURE_LINE_WIDTH / 2, 0, Math.PI * 2);
                currentCtx.fillStyle = SIGNATURE_LINE_COLOR; currentCtx.fill(); currentCtx.closePath();
            }

            function draw(e, currentCanvas, currentCtx) {
                if (!isDrawing) return; e.preventDefault();
                let clientX, clientY;
                if (e.type.startsWith('touch')) {
                    if (e.touches.length > 0) { clientX = e.touches[0].clientX; clientY = e.touches[0].clientY; }
                    else { return; }
                } else { clientX = e.clientX; clientY = e.clientY; }
                const coords = getCanvasCoordinates(currentCanvas, clientX, clientY);
                points.push({ x: coords.x, y: coords.y });
                if (points.length < 3) {
                    if (points.length === 2) {
                         currentCtx.beginPath(); currentCtx.moveTo(points[0].x, points[0].y);
                         currentCtx.lineTo(points[1].x, points[1].y); currentCtx.stroke(); currentCtx.closePath();
                    } return;
                }
                const lastPoint = points[points.length - 1]; const secondLastPoint = points[points.length - 2];
                const thirdLastPoint = points[points.length - 3];
                const mid1 = { x: (thirdLastPoint.x + secondLastPoint.x) / 2, y: (thirdLastPoint.y + secondLastPoint.y) / 2 };
                const mid2 = { x: (secondLastPoint.x + lastPoint.x) / 2, y: (secondLastPoint.y + lastPoint.y) / 2 };
                currentCtx.beginPath(); currentCtx.moveTo(mid1.x, mid1.y);
                currentCtx.quadraticCurveTo(secondLastPoint.x, secondLastPoint.y, mid2.x, mid2.y);
                currentCtx.stroke(); currentCtx.closePath();
            }

            function stopDrawing(e, currentCtx) {
                 if (!isDrawing) return; isDrawing = false;
                 if (points.length >= 2) {
                     const lastPoint = points[points.length - 1]; const secondLastPoint = points[points.length - 2];
                     const midPoint = { x: (secondLastPoint.x + lastPoint.x) / 2, y: (secondLastPoint.y + lastPoint.y) / 2 };
                     if (points.length >= 3) {
                         const thirdLastPoint = points[points.length - 3];
                         const prevMidPoint = { x: (thirdLastPoint.x + secondLastPoint.x) / 2, y: (thirdLastPoint.y + secondLastPoint.y) / 2 };
                         currentCtx.beginPath(); currentCtx.moveTo(prevMidPoint.x, prevMidPoint.y);
                         currentCtx.quadraticCurveTo(secondLastPoint.x, secondLastPoint.y, midPoint.x, midPoint.y);
                         currentCtx.stroke(); currentCtx.closePath();
                     }
                 } points = [];
            }

            function clearCanvas(canvasElement, context, messageElement, isModal) {
                const dpr = window.devicePixelRatio || 1; context.save(); context.resetTransform();
                context.clearRect(0, 0, canvasElement.width, canvasElement.height); context.restore();
                setupCanvasContext(context, canvasElement);
                if (messageElement) messageElement.style.display = 'block';
                if (isModal) { hasModalSignature = false; }
                else {
                    hasSignature = false; signatureContainer.classList.remove('invalid');
                    if (authorizedSignatureLabel) authorizedSignatureLabel.style.display = 'none'; // Hide 2nd label
                }
            }

            // ========================================================================
            // SIGNATURE MODAL FUNCTIONS (Unchanged)
            // ========================================================================
            function openSignatureModal() {
                 if (hasSignature) { tempMainSignatureDataUrl = canvas.toDataURL(); }
                 else { tempMainSignatureDataUrl = null; }
                 clearCanvas(modalCanvas, modalCtx, modalMessage, true);
                 if (tempMainSignatureDataUrl) {
                     const img = new Image();
                     img.onload = () => {
                         const dpr = window.devicePixelRatio || 1;
                         modalCtx.drawImage(img, 0, 0, modalCanvas.width / dpr, modalCanvas.height / dpr);
                         hasModalSignature = true; modalMessage.style.display = 'none';
                     };
                     img.src = tempMainSignatureDataUrl;
                 }
                 modalOverlay.style.display = 'flex';
                 setTimeout(() => resizeCanvas(modalCanvas, modalCtx, true), 50);
                 addModalListeners();
             }
            function closeSignatureModal(saveSignature) {
                 removeModalListeners();
                 if (saveSignature && hasModalSignature) {
                     const modalSignatureData = modalCanvas.toDataURL();
                     clearCanvas(canvas, ctx, signatureMessage, false);
                     const img = new Image();
                     img.onload = () => {
                         const dpr = window.devicePixelRatio || 1;
                         ctx.drawImage(img, 0, 0, canvas.width / dpr, canvas.height / dpr);
                         hasSignature = true; signatureMessage.style.display = 'none';
                         signatureContainer.classList.remove('invalid'); updateOwnerNameDisplay();
                         if (authorizedSignatureLabel) authorizedSignatureLabel.style.display = 'block';
                     };
                     img.src = modalSignatureData;
                 } else if (!saveSignature && !hasSignature) {
                      clearCanvas(canvas, ctx, signatureMessage, false); updateOwnerNameDisplay();
                       if (authorizedSignatureLabel) authorizedSignatureLabel.style.display = 'none';
                 } else if (!saveSignature && hasSignature) {
                      if(tempMainSignatureDataUrl) {
                          const img = new Image();
                          img.onload = () => {
                             const dpr = window.devicePixelRatio || 1;
                             ctx.drawImage(img, 0, 0, canvas.width / dpr, canvas.height / dpr);
                          };
                          img.src = tempMainSignatureDataUrl;
                          hasSignature = true; signatureMessage.style.display = 'none';
                          updateOwnerNameDisplay();
                          if (authorizedSignatureLabel) authorizedSignatureLabel.style.display = 'block';
                      } else {
                          clearCanvas(canvas, ctx, signatureMessage, false); updateOwnerNameDisplay();
                          if (authorizedSignatureLabel) authorizedSignatureLabel.style.display = 'none';
                      }
                 }
                 modalOverlay.style.display = 'none';
             }
            const modalMouseDown = (e) => startDrawing(e, modalCanvas, modalCtx, true);
            const modalMouseMove = (e) => draw(e, modalCanvas, modalCtx);
            const modalMouseUp = (e) => stopDrawing(e, modalCtx);
            const modalMouseOut = (e) => { if(isDrawing) stopDrawing(e, modalCtx); }; // Pass context and check isDrawing
            const modalTouchStart = (e) => startDrawing(e, modalCanvas, modalCtx, true);
            const modalTouchMove = (e) => draw(e, modalCanvas, modalCtx);
            const modalTouchEnd = (e) => stopDrawing(e, modalCtx);
            const modalTouchCancel = (e) => stopDrawing(e, modalCtx);
            function addModalListeners() {
                 modalCanvas.addEventListener('mousedown', modalMouseDown);
                 modalCanvas.addEventListener('mousemove', modalMouseMove);
                 modalCanvas.addEventListener('mouseup', modalMouseUp);
                 modalCanvas.addEventListener('mouseout', modalMouseOut); // Use modified mouseout
                 modalCanvas.addEventListener('touchstart', modalTouchStart, { passive: false });
                 modalCanvas.addEventListener('touchmove', modalTouchMove, { passive: false });
                 modalCanvas.addEventListener('touchend', modalTouchEnd);
                 modalCanvas.addEventListener('touchcancel', modalTouchCancel);
             }
            function removeModalListeners() {
                 modalCanvas.removeEventListener('mousedown', modalMouseDown);
                 modalCanvas.removeEventListener('mousemove', modalMouseMove);
                 modalCanvas.removeEventListener('mouseup', modalMouseUp);
                 modalCanvas.removeEventListener('mouseout', modalMouseOut);
                 modalCanvas.removeEventListener('touchstart', modalTouchStart);
                 modalCanvas.removeEventListener('touchmove', modalTouchMove);
                 modalCanvas.removeEventListener('touchend', modalTouchEnd);
                 modalCanvas.removeEventListener('touchcancel', modalTouchCancel);
             }

            // ========================================================================
            // FORM VALIDATION AND FORMATTING (Unchanged)
            // ========================================================================
            function isValidCPF(cpf) {
                if (typeof cpf !== 'string') return false;
                cpf = cpf.replace(/[^\d]+/g, '');
                if (cpf.length !== 11 || /^(.)\1+$/.test(cpf)) return false;
                let sum = 0; let remainder;
                for (let i = 1; i <= 9; i++) sum += parseInt(cpf.substring(i - 1, i)) * (11 - i);
                remainder = (sum * 10) % 11;
                if ((remainder === 10) || (remainder === 11)) remainder = 0;
                if (remainder !== parseInt(cpf.substring(9, 10))) return false;
                sum = 0;
                for (let i = 1; i <= 10; i++) sum += parseInt(cpf.substring(i - 1, i)) * (12 - i);
                remainder = (sum * 10) % 11;
                if ((remainder === 10) || (remainder === 11)) remainder = 0;
                if (remainder !== parseInt(cpf.substring(10, 11))) return false;
                return true;
            }

            function formatCPF(inputElement) {
                let value = inputElement.value.replace(/\D/g, '').slice(0, 11);
                value = value.replace(/(\d{3})(\d)/, '$1.$2');
                value = value.replace(/(\d{3})(\d)/, '$1.$2');
                value = value.replace(/(\d{3})(\d{1,2})$/, '$1-$2');
                inputElement.value = value;
            }

            function formatCurrency(inputElement) {
                 let value = inputElement.value.replace(/\D/g, '');
                 if (value === '') { inputElement.value = ''; return; }
                 let numberValue = parseInt(value) / 100;
                 inputElement.value = numberValue.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            }

            function validateField(inputElement) {
                const parentField = inputElement.closest('.field, .date-field');
                const errorMsgElement = parentField ? parentField.querySelector('.error-message') : null;
                let isValid = true; let errorMessageText = '';
                // Trim value before checking if required
                const trimmedValue = inputElement.value.trim();

                if (inputElement.required && !trimmedValue) {
                    isValid = false; errorMessageText = 'Obrigatório';
                }
                // Only validate format if the field is not empty OR if it's required (even if empty)
                else if (trimmedValue || inputElement.required) {
                    if (inputElement.id === 'cpf' && !isValidCPF(inputElement.value)) { // Use original value for CPF check
                        isValid = false; errorMessageText = 'CPF inválido';
                    } else if (inputElement.id === 'ano') {
                        const year = parseInt(trimmedValue); const currentYear = new Date().getFullYear();
                        if (isNaN(year) || year < currentYear - 10 || year > currentYear + 5) {
                            isValid = false; errorMessageText = 'Ano inválido';
                        }
                    } else if (inputElement.id === 'dia') {
                        const day = parseInt(trimmedValue);
                        if (isNaN(day) || day < 1 || day > 31) {
                            isValid = false; errorMessageText = 'Dia inválido';
                        }
                    } else if (inputElement.id === 'mes') {
                         const monthValue = trimmedValue.toLowerCase();
                         const validMonths = ['janeiro', 'fevereiro', 'março', 'abril', 'maio', 'junho', 'julho', 'agosto', 'setembro', 'outubro', 'novembro', 'dezembro'];
                         if (!validMonths.includes(monthValue)) {
                                isValid = false; errorMessageText = 'Mês inválido';
                         }
                     }
                     // Add other specific validations here if needed
                }

                if (parentField) {
                    if (!isValid) {
                        parentField.classList.add('invalid');
                        if (errorMsgElement) { errorMsgElement.textContent = errorMessageText; errorMsgElement.style.display = 'inline'; }
                    } else {
                        parentField.classList.remove('invalid');
                         if (errorMsgElement) { errorMsgElement.style.display = 'none'; }
                    }
                }
                return isValid;
            }

            function validateForm() {
                console.log("Iniciando validação do formulário..."); // Log inicio
                let isFormValid = true; let firstInvalidElement = null;
                const fieldsToValidate = formContainer.querySelectorAll('input[required], select[required], textarea[required]');

                fieldsToValidate.forEach(input => {
                    console.log(`Validando campo: ${input.id}`); // Log campo
                    if (!validateField(input)) {
                        console.log(`Campo ${input.id} inválido.`); // Log erro campo
                        isFormValid = false;
                        if (!firstInvalidElement) firstInvalidElement = input;
                    }
                });

                 console.log("Validando assinatura..."); // Log assinatura
                 if (!hasSignature) {
                     console.log("Assinatura ausente."); // Log erro assinatura
                     isFormValid = false;
                     signatureContainer.classList.add('invalid');
                     signatureMessage.textContent = 'Assinatura obrigatória';
                     signatureMessage.style.display = 'block';
                     if (!firstInvalidElement) firstInvalidElement = signatureContainer;
                 } else {
                     signatureContainer.classList.remove('invalid');
                     if(hasSignature) signatureMessage.style.display = 'none';
                 }

                if (!isFormValid) {
                    console.log("Formulário inválido."); // Log final invalido
                    if (firstInvalidElement) {
                         console.log(`Focando no primeiro elemento inválido: ${firstInvalidElement.id || 'signature container'}`);
                         firstInvalidElement.focus();
                    }
                    alert('Por favor, corrija os campos destacados e forneça a assinatura.');
                } else {
                    console.log("Formulário válido."); // Log final valido
                }
                return isFormValid;
            }

            function clearErrorOnInput(event) {
                 const parentField = event.target.closest('.field, .date-field');
                 if (parentField && parentField.classList.contains('invalid')) { // Only clear if invalid
                     parentField.classList.remove('invalid');
                     const errorMsgElement = parentField.querySelector('.error-message');
                     if (errorMsgElement) errorMsgElement.style.display = 'none';
                     console.log(`Erro limpo para: ${event.target.id}`); // Log clear
                 }
            }

            // ========================================================================
            // INITIALIZATION & UTILITIES
            // ========================================================================

            function initializeDefaultDate() {
                try {
                    const today = new Date();
                    const day = today.getDate().toString().padStart(2, '0');
                    const months = ['janeiro', 'fevereiro', 'março', 'abril', 'maio', 'junho', 'julho', 'agosto', 'setembro', 'outubro', 'novembro', 'dezembro'];
                    const month = months[today.getMonth()];
                    const year = today.getFullYear();

                    if (diaInput) diaInput.value = day;
                    if (mesInput) mesInput.value = month;
                    if (anoInput) anoInput.value = year;
                    if (cidadeInput && !cidadeInput.value) { // Only set default if empty
                         cidadeInput.value = "Americana";
                     }
                     console.log("Data e cidade padrão inicializadas.");
                 } catch (error) {
                     console.error("Erro ao inicializar data/cidade:", error);
                 }
            }

             function updateOwnerNameDisplay() {
                 if (ownerNameDisplay && nomeInput) {
                     ownerNameDisplay.textContent = nomeInput.value.trim().toUpperCase();
                 }
             }

            // ========================================================================
            // PDF GENERATION (Unchanged from v5)
            // ========================================================================
            async function exportarPDF() {
                console.log("Tentando exportar PDF..."); // Log inicio PDF
                // Validate form FIRST
                if (!validateForm()) {
                    console.log("Exportação PDF cancelada devido a formulário inválido."); // Log cancelamento
                    exportButton.disabled = false; // Re-enable button if validation fails
                    exportButton.innerHTML = `... (restore original button SVG and text) ...`; // Restore button text
                    return; // Stop execution if form is invalid
                }

                console.log("Formulário válido, iniciando geração do PDF."); // Log continua
                exportButton.disabled = true;
                exportButton.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-arrow-repeat spinner" viewBox="0 0 16 16">
                      <path d="M11.534 7h3.932a.25.25 0 0 1 .192.41l-1.966 2.36a.25.25 0 0 1-.384 0l-1.966-2.36a.25.25 0 0 1 .192-.41m-11 2h3.932a.25.25 0 0 0 .192-.41L2.692 6.23a.25.25 0 0 0-.384 0L.342 8.59A.25.25 0 0 0 .534 9"/>
                      <path fill-rule="evenodd" d="M8 3c-1.552 0-2.94.707-3.857 1.818a.5.5 0 1 1-.771-.636A6.5 6.5 0 1 1 2.343 6H.5a.5.5 0 0 1 0-1h2.207A7 7 0 0 0 8 2zM2.466 11.818a.5.5 0 0 1 .771.636A6.5 6.5 0 1 1 13.657 10h1.843a.5.5 0 0 1 0 1h-2.207A7 7 0 0 0 8 14z"/>
                    </svg>
                    Gerando...`;

                 document.body.classList.add('pdf-generation-active');
                 await new Promise(resolve => setTimeout(resolve, 50)); // Allow UI update

                try {
                    const { jsPDF } = window.jspdf;
                    const pdf = new jsPDF({ orientation: 'portrait', unit: 'mm', format: 'a4', putOnlyUsedFonts:true, compress: true });

                    const pageW = pdf.internal.pageSize.getWidth();
                    const pageH = pdf.internal.pageSize.getHeight();
                    const margin = 15;
                    const contentW = pageW - (margin * 2);
                    let currentY = margin;
                    const lineSpacing = 6;
                    const sectionSpacing = 10;
                    const fieldLineOffset = 1;
                    const labelSpacing = 4;
                    const signatureBlockSpacing = 15;

                    const addFormattedText = (segments, x, y, maxWidth) => {
                        let currentX = x;
                        pdf.setFontSize(11); // Ensure correct font size for measurement
                        segments.forEach(segment => {
                            pdf.setFont('helvetica', segment.style || 'normal');
                            const text = segment.text + (segment.spaceAfter ? ' ' : '');
                            const textWidth = pdf.getStringUnitWidth(text) * pdf.getFontSize() / pdf.internal.scaleFactor;
                            // Basic word wrap (split by space)
                            if (currentX + textWidth > x + maxWidth) {
                                // If it's the first segment on the line, split it anyway
                                if (currentX === x) {
                                    const splitText = pdf.splitTextToSize(text, maxWidth);
                                    pdf.text(splitText, currentX, y);
                                    // This basic split doesn't handle moving subsequent segments correctly.
                                    // A more robust solution would calculate remaining space and split words.
                                    console.warn("Complex line break needed for bold text, output may be imperfect.");
                                    currentX = x; // Reset X for next line (basic)
                                    y += lineSpacing * splitText.length;
                                } else {
                                     // Move to next line
                                     y += lineSpacing;
                                     currentX = x;
                                     pdf.text(text, currentX, y);
                                     currentX += textWidth;
                                }
                            } else {
                                pdf.text(text, currentX, y);
                                currentX += textWidth;
                            }
                        });
                         pdf.setFont('helvetica', 'normal'); // Reset to normal
                         return y + lineSpacing; // Return the Y position for the next line
                    };

                    // --- 1. Logo ---
                    console.log("Adicionando logo...");
                    const logoImg = document.getElementById('company-logo');
                    if (logoImg && logoImg.complete && logoImg.naturalWidth > 0) {
                         try {
                             const logoDataUrl = await getImageDataUrlWithWhiteBackground(logoImg.src);
                             const imgProps = pdf.getImageProperties(logoDataUrl);
                             const logoMaxW = 50; const logoRatio = imgProps.width / imgProps.height;
                             const logoW = Math.min(logoMaxW, contentW * 0.3); const logoH = logoW / logoRatio;
                             const logoX = (pageW - logoW) / 2;
                             pdf.addImage(logoDataUrl, 'JPEG', logoX, currentY, logoW, logoH);
                             currentY += logoH + 5;
                             console.log("Logo adicionado.");
                         } catch (imgError) {
                             console.error("Erro ao carregar ou adicionar logo:", imgError);
                             pdf.setFontSize(10); pdf.setTextColor(150);
                             pdf.text('[Erro ao carregar logo]', pageW / 2, currentY + 5, { align: 'center' });
                             pdf.setTextColor(0); currentY += 10;
                         }
                    } else { console.warn("Logo não encontrada ou não carregada."); currentY += 10; }

                    // --- 2. Slogan ---
                    console.log("Adicionando slogan...");
                    const slogan = document.querySelector('.brand-slogan')?.textContent || '';
                    pdf.setFontSize(11); pdf.setFont('helvetica', 'italic'); pdf.setTextColor(100);
                    pdf.text(slogan, pageW / 2, currentY, { align: 'center' });
                    currentY += sectionSpacing; pdf.setFont('helvetica', 'normal'); pdf.setTextColor(0);

                    // --- 3. Title ---
                    console.log("Adicionando título...");
                    const title = document.querySelector('h1')?.textContent || 'AUTORIZAÇÃO DE RETIRADA';
                    pdf.setFontSize(14); pdf.setFont('helvetica', 'bold');
                    pdf.text(title, pageW / 2, currentY, { align: 'center' });
                    currentY += sectionSpacing + 5; pdf.setFont('helvetica', 'normal');

                    // --- 4. Main Content Text (with Bolding) ---
                    console.log("Adicionando conteúdo principal...");
                    pdf.setFontSize(11);
                    const nome = nomeInput.value.trim(); const cpf = cpfInput.value.trim();
                    const empresa = empresaInput.value.trim(); const autorizado = autorizadoInput.value.trim();
                    const pedidos = pedidosInput.value.trim(); const valor = valorInput.value.trim();
                    currentY = addFormattedText([{ text: 'Eu,', style: 'normal', spaceAfter: true }, { text: nome, style: 'bold', spaceAfter: true }, { text: ', portador do CPF', style: 'normal', spaceAfter: true }, { text: cpf, style: 'bold', spaceAfter: true }, { text: ',', style: 'normal', spaceAfter: false }], margin, currentY, contentW);
                    currentY = addFormattedText([{ text: 'proprietário(a) da empresa', style: 'normal', spaceAfter: true }, { text: empresa, style: 'bold', spaceAfter: true }, { text: ', autorizo o(a) Sr(a).', style: 'normal', spaceAfter: true }, { text: autorizado, style: 'bold', spaceAfter: false }], margin, currentY, contentW);
                    currentY = addFormattedText([{ text: 'a retirar o(s) pedido(s) nº', style: 'normal', spaceAfter: true }, { text: pedidos, style: 'bold', spaceAfter: true }, { text: ', no valor total de R$', style: 'normal', spaceAfter: true }, { text: valor, style: 'bold', spaceAfter: false }], margin, currentY, contentW);
                    pdf.setFont('helvetica', 'normal'); const line4Text = 'no Depósito da empresa Ameripan, localizado na Rua Purus, nº 652, Bairro Jd. São Roque.';
                    const splitLine4 = pdf.splitTextToSize(line4Text, contentW); pdf.text(splitLine4, margin, currentY);
                    currentY += lineSpacing * splitLine4.length; currentY += sectionSpacing - lineSpacing;

                    // --- 5. Date and Location ---
                    console.log("Adicionando data e local...");
                    const cidade = cidadeInput.value.trim(); const dia = diaInput.value.trim();
                    const mes = mesInput.value.trim(); const ano = anoInput.value.trim();
                    currentY = addFormattedText([{ text: cidade, style: 'bold', spaceAfter: true }, { text: ',', style: 'normal', spaceAfter: true }, { text: dia, style: 'bold', spaceAfter: true }, { text: 'de', style: 'normal', spaceAfter: true }, { text: mes, style: 'bold', spaceAfter: true }, { text: 'de', style: 'normal', spaceAfter: true }, { text: ano, style: 'bold', spaceAfter: true }, { text: '.', style: 'normal', spaceAfter: false }], margin, currentY, contentW);
                    currentY += sectionSpacing + 10;

                    // --- 6. Owner's Signature Area ---
                    console.log("Adicionando assinatura do proprietário...");
                    const ownerSignatureY = currentY; const signatureWidth = contentW * 0.7;
                    const signatureX = (pageW - signatureWidth) / 2;
                    if (hasSignature) {
                        const signatureDataUrl = canvas.toDataURL('image/png'); const sigProps = pdf.getImageProperties(signatureDataUrl);
                        const sigRatio = sigProps.width / sigProps.height; const sigMaxH = 35;
                        let sigH = Math.min(sigMaxH, signatureWidth / sigRatio); let sigW = sigH * sigRatio;
                         if (sigW > signatureWidth) { sigW = signatureWidth; sigH = sigW / sigRatio; }
                        const sigY = ownerSignatureY; const sigImgX = signatureX + (signatureWidth - sigW) / 2;
                        pdf.addImage(signatureDataUrl, 'PNG', sigImgX, sigY, sigW, sigH); currentY = sigY + sigH + fieldLineOffset;
                        console.log("Imagem da assinatura adicionada.");
                    } else {
                        console.log("Sem assinatura digital para adicionar.");
                        pdf.setFontSize(9); pdf.setTextColor(150); pdf.text("[Sem Assinatura Digital]", signatureX + signatureWidth / 2, ownerSignatureY + 15, { align: 'center' });
                        pdf.setTextColor(0); currentY = ownerSignatureY + 30 + fieldLineOffset;
                    }
                    pdf.setLineWidth(0.3); pdf.line(signatureX, currentY, signatureX + signatureWidth, currentY); currentY += labelSpacing;
                    pdf.setFontSize(9); pdf.setFont('helvetica', 'bold'); pdf.text(nome.toUpperCase(), signatureX + signatureWidth / 2, currentY, { align: 'center' });
                    currentY += labelSpacing; pdf.setFont('helvetica', 'normal');
                    pdf.setFontSize(8); pdf.setTextColor(100); pdf.text("(Assinatura Proprietário/Sócio)", signatureX + signatureWidth / 2, currentY, { align: 'center' }); pdf.setTextColor(0);

                    // --- 7. Authorized Person's Signature Area (Placeholder) ---
                    console.log("Adicionando área de assinatura do autorizado...");
                    currentY += signatureBlockSpacing; const authorizedSignatureY = currentY;
                    pdf.setLineWidth(0.3); pdf.line(signatureX, authorizedSignatureY, signatureX + signatureWidth, authorizedSignatureY);
                    currentY = authorizedSignatureY + labelSpacing;
                    pdf.setFontSize(9); pdf.setFont('helvetica', 'bold'); pdf.text(autorizado.toUpperCase(), signatureX + signatureWidth / 2, currentY, { align: 'center' });
                    currentY += labelSpacing; pdf.setFont('helvetica', 'normal');
                    pdf.setFontSize(8); pdf.setTextColor(100); pdf.text("(Assinatura Responsável pela Retirada)", signatureX + signatureWidth / 2, currentY, { align: 'center' }); pdf.setTextColor(0);
                    currentY += sectionSpacing;

                    // --- 8. Footer Company Info ---
                    console.log("Adicionando rodapé...");
                     const footerY = pageH - margin - 15; if (currentY > footerY) { pdf.addPage(); currentY = margin; console.log("Nova página adicionada para o rodapé.");}
                    pdf.setFontSize(8); pdf.setTextColor(100); const companyInfoLines = document.querySelectorAll('.company-info p');
                    let footerLineY = footerY; companyInfoLines.forEach(p => { pdf.text(p.textContent.trim(), pageW / 2, footerLineY, { align: 'center' }); footerLineY += 3.5; }); pdf.setTextColor(0);

                    // --- Generate Filename ---
                    const safePedido = pedidos.replace(/[^a-zA-Z0-9,-]/g, '_') || 'N_A'; const safeProprietario = nome.replace(/[^a-zA-Z0-9]/g, '_') || 'Proprietario';
                    const dataHoje = new Date(); const diaFormatado = dataHoje.getDate().toString().padStart(2, '0'); const mesFormatado = (dataHoje.getMonth() + 1).toString().padStart(2, '0'); const anoFormatado = dataHoje.getFullYear();
                    const dataFormatada = `${diaFormatado}-${mesFormatado}-${anoFormatado}`;
                    const filename = `Autorizacao_Retirada_pedido${safePedido}_proprietario${safeProprietario}_${dataFormatada}.pdf`;
                    console.log(`Nome do arquivo PDF: ${filename}`);

                    // --- Save PDF ---
                    console.log("Salvando PDF...");
                    pdf.save(filename);
                    console.log("PDF salvo.");
                    successMessage.style.display = 'flex';
                    console.log("Mensagem de sucesso exibida.");

                } catch (error) {
                    console.error('Erro ao gerar PDF:', error);
                    alert('Ocorreu um erro ao gerar o PDF. Verifique o console para detalhes.');
                } finally {
                    console.log("Finalizando exportação, reabilitando botão.");
                    exportButton.disabled = false;
                    // Restore original button text and icon
                    exportButton.innerHTML = `
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" class="bi bi-file-earmark-pdf-fill" viewBox="0 0 16 16">
                           <path d="M5.523 12.424q.21-.124.459-.238a8 8 0 0 1-.45.606c-.28.337-.498.516-.635.572l-.035.012a.3.3 0 0 1-.026-.044c-.03-.05-.054-.114-.08-.193.026-.043.05-.088.075-.134.036-.067.07-.146.104-.234.05-.132.104-.27.16-.408.066-.16.132-.318.2-.477a5 5 0 0 1 .455-.68.5.5 0 0 0 .085-.488c-.08-.17-.148-.305-.196-.396a.7.7 0 0 1 .058-.82q.08-.08.144-.134c.048-.04.09-.07.122-.088a.8.8 0 0 1 .258-.087c.032-.003.058-.005.077-.005.023 0 .06.003.11.003.069 0 .106.005.122.008.04.008.074.026.09.044.018.017.026.03.026.036a.5.5 0 0 1-.034.475q-.05.08-.104.147c-.052.062-.108.135-.168.227-.06.09-.116.19-.164.303a.8.8 0 0 0 .034.886c.074.11.158.247.25.397.084.136.176.29.275.454a4.2 4.2 0 0 0 .405.614c.02.028.04.052.06.07a1 1 0 0 0 .117.258c.097.164.187.318.271.463.08.14.15.27.21.388.06.117.11.228.15.336a.8.8 0 0 0 .13.388q.078.153.088.271a.7.7 0 0 0-.04.345c-.008.065-.02.11-.034.134a.5.5 0 0 1-.058.199c-.01.015-.024.028-.044.038a.3.3 0 0 1-.056.023c-.03.007-.07.01-.12.01-.068 0-.12-.003-.15-.007a.7.7 0 0 1-.29-.065c-.102-.05-.23-.145-.392-.287a8 8 0 0 1-.566-.534c-.05-.08-.1-.155-.145-.225a.5.5 0 0 1 .034-.518m-1.635-2.057a.6.6 0 0 1-.03-.116c.003-.022.007-.046.012-.07.005-.024.01-.048.015-.073a.4.4 0 0 0 0-.11c-.003-.05-.01-.102-.02-.153a.5.5 0 0 0-.04-.153c-.02-.04-.04-.074-.066-.1a.5.5 0 0 0-.048-.078.4.4 0 0 0-.07-.06c-.03-.017-.06-.03-.096-.037a.3.3 0 0 0-.114-.007h-.022c-.04 0-.07.002-.09.005a.4.4 0 0 0-.085.021.5.5 0 0 0-.078.037.4.4 0 0 0-.068.048.5.5 0 0 0-.06.077.5.5 0 0 0-.047.096c-.015.036-.027.078-.035.127a.5.5 0 0 0-.015.127c-.003.047-.003.09 0 .122a.4.4 0 0 0 .012.104.4.4 0 0 0 .028.092c.016.03.036.056.06.075a.4.4 0 0 0 .075.06.5.5 0 0 0 .094.04c.036.01.07.014.1.014.048 0 .087-.004.118-.01a.5.5 0 0 0 .106-.037c.032-.017.06-.037.082-.06a.5.5 0 0 0 .062-.077.5.5 0 0 0 .048-.097m.188-1.085c.018-.026.03-.05.036-.07a.4.4 0 0 0 0-.07c-.004-.028-.008-.057-.012-.086a.5.5 0 0 0-.012-.09.4.4 0 0 0-.02-.076c-.01-.025-.025-.047-.04-.067a.4.4 0 0 0-.05-.05.4.4 0 0 0-.067-.04.4.4 0 0 0-.076-.025.4.4 0 0 0-.086-.012.4.4 0 0 0-.09 0c-.03.004-.057.008-.08.012a.4.4 0 0 0-.07.025c-.025.01-.047.025-.067.04a.4.4 0 0 0-.05.05c-.017.024-.03.05-.04.076a.5.5 0 0 0-.02.09c-.004.03-.008.06-.012.086a.4.4 0 0 0 0 .07c.004.028.008.056.012.084a.4.4 0 0 0 .012.09.4.4 0 0 0 .02.076c.01.025.025.047.04.067a.4.4 0 0 0 .05.05c.024.017.05.03.076.04a.4.4 0 0 0 .086.012.4.4 0 0 0 .09 0c.03-.004.057-.008.08-.012a.4.4 0 0 0 .07-.025c.025-.01.047-.025.067-.04a.4.4 0 0 0 .05-.05c.017-.024.03-.05.04-.076zm.03-1.177a.8.8 0 0 1-.134-.08c-.02-.013-.036-.025-.05-.035a.4.4 0 0 0-.05-.03c-.02-.01-.036-.017-.05-.02a.3.3 0 0 0-.048-.008.3.3 0 0 0-.05 0 .3.3 0 0 0-.048.008c-.015.003-.03.01-.05.02a.4.4 0 0 0-.05.03.4.4 0 0 0-.05.035c-.015.01-.03.022-.05.035a.8.8 0 0 1-.134.08c-.03.017-.056.03-.076.037a.3.3 0 0 1-.108.02h-.034a.3.3 0 0 1-.108-.02c-.02-.007-.046-.02-.076-.037a.8.8 0 0 1-.134-.08c-.02-.013-.036-.025-.05-.035a.4.4 0 0 0-.05-.03c-.02-.01-.036-.017-.05-.02a.3.3 0 0 0-.048-.008.3.3 0 0 0-.05 0 .3.3 0 0 0-.048.008c-.015.003-.03.01-.05.02a.4.4 0 0 0-.05.03.4.4 0 0 0-.05.035c-.015.01-.03.022-.05.035a.8.8 0 0 1-.134.08c-.03.017-.056.03-.076.037a.3.3 0 0 1-.108.02h-.034a.3.3 0 0 1-.108-.02c-.02-.007-.046-.02-.076-.037a.8.8 0 0 1-.134-.08c-.02-.013-.036-.025-.05-.035a.4.4 0 0 0-.05-.03c-.02-.01-.036-.017-.05-.02a.3.3 0 0 0-.048-.008.3.3 0 0 0-.05 0 .3.3 0 0 0-.048.008 1 1 0 0 0-.05.02a.4.4 0 0 0-.05.03.4.4 0 0 0-.05.035c-.015.01-.03.022-.05.035a.8.8 0 0 1-.134.08c-.03.017-.056.03-.076.037a.3.3 0 0 1-.108.02h-.034a.3.3 0 0 1-.108-.02c-.02-.007-.046-.02-.076-.037a.8.8 0 0 1-.134-.08c-.02-.013-.036-.025-.05-.035a.4.4 0 0 0-.05-.03c-.02-.01-.036-.017-.05-.02a.3.3 0 0 0-.048-.008.3.3 0 0 0-.05 0 .3.3 0 0 0-.048.008c-.014.003-.03.01-.05.02a.4.4 0 0 0-.05.03.4.4 0 0 0-.05.035c-.015.01-.03.022-.05.035a.8.8 0 0 1-.134.08c-.03.017-.056.03-.076.037a.3.3 0 0 1-.108.02h-.034a.3.3 0 0 1-.108-.02c-.02-.007-.046-.02-.076-.037Z"/>
                           <path d="M4.603 14.087a.8.8 0 0 1-1.206 0l-1.5-1.5a.8.8 0 0 1 0-1.207l6.5-6.5a.8.8 0 0 1 1.207 0l1.5 1.5a.8.8 0 0 1 0 1.207l-6.5 6.5zm-1.06-1.06L6.5 6.087l.94.94-6 6z"/>
                           <path fill-rule="evenodd" d="M14 2.5a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-1 0V3h-.5a.5.5 0 0 1-.5-.5V2H2v1h-.5A.5.5 0 0 1 1 3.5v1a.5.5 0 0 1-1 0V2a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2v1.5a.5.5 0 0 1-1 0V3h-.5a.5.5 0 0 1-.5.5z"/>
                        </svg>
                        Gerar PDF`;
                     document.body.classList.remove('pdf-generation-active');
                }
            }

            // Helper to get image data URL with a forced white background (output as JPEG)
            function getImageDataUrlWithWhiteBackground(url) {
                return new Promise(async (resolve, reject) => {
                    const img = new Image(); img.crossOrigin = "Anonymous";
                    img.onload = () => {
                        const tempCanvas = document.createElement('canvas'); tempCanvas.width = img.naturalWidth; tempCanvas.height = img.naturalHeight;
                        const tempCtx = tempCanvas.getContext('2d'); tempCtx.fillStyle = '#FFFFFF'; tempCtx.fillRect(0, 0, tempCanvas.width, tempCanvas.height);
                        tempCtx.drawImage(img, 0, 0);
                        try { resolve(tempCanvas.toDataURL('image/jpeg', 0.9)); }
                        catch(e) { console.error("Canvas toDataURL (JPEG) failed:", e); reject("Não foi possível converter o logo para JPEG."); }
                    };
                    img.onerror = (err) => { console.error(`Erro ao carregar a imagem do logo de ${url}`, err); reject(`Erro ao carregar a imagem do logo de ${url}`); };
                    try {
                         const response = await fetch(url, { mode: 'cors' }); if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                         const blob = await response.blob(); img.src = URL.createObjectURL(blob);
                     } catch (fetchError) { console.warn("Fetch failed, attempting direct load:", fetchError); img.src = url; }
                });
            }

            // ========================================================================
            // EVENT LISTENERS (Initialization Corrected)
            // ========================================================================

            function handleResizeOrOrientationChange() {
                 tempSignatureDataUrl = null; tempMainSignatureDataUrl = null;
                 if (modalOverlay.style.display === 'flex' && hasModalSignature) { tempSignatureDataUrl = modalCanvas.toDataURL(); }
                 if (hasSignature) { tempMainSignatureDataUrl = canvas.toDataURL(); }
                 resizeCanvas(canvas, ctx, false);
                 if (modalOverlay.style.display === 'flex') { resizeCanvas(modalCanvas, modalCtx, true); }
             }

            // --- Window Load Listener (Corrected) ---
            window.addEventListener('load', () => {
                console.log("Página carregada, iniciando configurações...");
                // Ensure modals are hidden on initial load
                if(successMessage) {
                    successMessage.style.display = 'none';
                    console.log("Mensagem de sucesso oculta na inicialização.");
                } else {
                    console.warn("Elemento successMessage não encontrado.");
                }
                if(modalOverlay) {
                     modalOverlay.style.display = 'none';
                     console.log("Modal de assinatura oculto na inicialização.");
                } else {
                     console.warn("Elemento modalOverlay não encontrado.");
                }

                // Initial setup
                try {
                    resizeCanvas(canvas, ctx, false);
                    initializeDefaultDate(); // Sets date and city
                    updateOwnerNameDisplay();
                    // Hide the second label initially
                    if (authorizedSignatureLabel) {
                        authorizedSignatureLabel.style.display = 'none';
                    } else {
                         console.warn("Elemento authorizedSignatureLabel não encontrado.");
                    }
                    console.log("Configurações iniciais concluídas.");
                } catch(error) {
                    console.error("Erro durante a inicialização no load:", error);
                }

                 // Setup input listeners AFTER ensuring elements exist
                 if (cpfInput) {
                     cpfInput.addEventListener('input', () => { formatCPF(cpfInput); clearErrorOnInput({ target: cpfInput }); });
                     cpfInput.addEventListener('blur', () => validateField(cpfInput));
                 } else { console.warn("Elemento cpfInput não encontrado."); }

                 if (valorInput) {
                     valorInput.addEventListener('input', () => { formatCurrency(valorInput); clearErrorOnInput({ target: valorInput }); });
                     valorInput.addEventListener('blur', () => validateField(valorInput));
                 } else { console.warn("Elemento valorInput não encontrado."); }

                 ['nome', 'empresa', 'autorizado', 'pedidos', 'cidade', 'dia', 'mes', 'ano'].forEach(id => {
                     const input = document.getElementById(id);
                     if (input) {
                         input.addEventListener('input', clearErrorOnInput);
                         input.addEventListener('blur', () => validateField(input));
                     } else {
                          console.warn(`Elemento com ID '${id}' não encontrado.`);
                     }
                 });
                 if (nomeInput) {
                     nomeInput.addEventListener('input', updateOwnerNameDisplay);
                 } else { console.warn("Elemento nomeInput não encontrado."); }

                 // Canvas listeners
                 if (canvas) {
                     canvas.addEventListener('mousedown', (e) => startDrawing(e, canvas, ctx, false));
                     canvas.addEventListener('mousemove', (e) => draw(e, canvas, ctx));
                     canvas.addEventListener('mouseup', (e) => stopDrawing(e, ctx));
                     canvas.addEventListener('mouseout', (e) => { if(isDrawing) stopDrawing(e, ctx); });
                     canvas.addEventListener('touchstart', (e) => startDrawing(e, canvas, ctx, false), { passive: false });
                     canvas.addEventListener('touchmove', (e) => draw(e, canvas, ctx), { passive: false });
                     canvas.addEventListener('touchend', (e) => stopDrawing(e, ctx));
                     canvas.addEventListener('touchcancel', (e) => stopDrawing(e, ctx));
                 } else { console.error("Elemento canvas (signature-pad) não encontrado!"); }

                 // Button listeners
                 if (clearButton) {
                     clearButton.addEventListener('click', () => { clearCanvas(canvas, ctx, signatureMessage, false); updateOwnerNameDisplay(); });
                 } else { console.warn("Elemento clearButton não encontrado."); }

                 if (expandButton) {
                     expandButton.addEventListener('click', openSignatureModal);
                 } else { console.warn("Elemento expandButton não encontrado."); }

                 if (exportButton) {
                     exportButton.addEventListener('click', exportarPDF);
                 } else { console.error("Elemento exportButton não encontrado!"); }

                 if (closeSuccessBtn) {
                     closeSuccessBtn.addEventListener('click', () => { if(successMessage) successMessage.style.display = 'none'; });
                 } else { console.warn("Elemento closeSuccessBtn não encontrado."); }

                 // Modal Button listeners
                 if (modalConfirmBtn) {
                     modalConfirmBtn.addEventListener('click', () => { if (hasModalSignature) closeSignatureModal(true); else alert('Por favor, assine no espaço antes de confirmar.'); });
                 } else { console.warn("Elemento modalConfirmBtn não encontrado."); }

                 if (modalClearBtn) {
                     modalClearBtn.addEventListener('click', () => clearCanvas(modalCanvas, modalCtx, modalMessage, true));
                 } else { console.warn("Elemento modalClearBtn não encontrado."); }

                 if (modalCancelBtn) {
                     modalCancelBtn.addEventListener('click', () => closeSignatureModal(false));
                 } else { console.warn("Elemento modalCancelBtn não encontrado."); }

                 if (modalOverlay) {
                     modalOverlay.addEventListener('click', (e) => { if (e.target === modalOverlay) closeSignatureModal(false); });
                 } else { console.warn("Elemento modalOverlay não encontrado."); }

                 // Resize/Orientation listeners
                 let resizeTimeout;
                 window.addEventListener('resize', () => { clearTimeout(resizeTimeout); resizeTimeout = setTimeout(handleResizeOrOrientationChange, 150); });
                 window.addEventListener('orientationchange', () => { clearTimeout(resizeTimeout); resizeTimeout = setTimeout(handleResizeOrOrientationChange, 150); });

                 console.log("Todos os listeners configurados.");
            });

        }); // End DOMContentLoaded
    </script>
</body>
</html>
