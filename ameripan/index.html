<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Sistema de Gerenciamento Ameripan">
    <title>Ameripan - Sistema de Gerenciamento</title>
    
    <!-- Preconnect para melhorar carregamento -->
    <link rel="preconnect" href="https://cdnjs.cloudflare.com">
    <link rel="preconnect" href="https://sheets.googleapis.com">
    
    <!-- FontAwesome com defer para não bloquear renderização -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" media="print" onload="this.media='all'">
    <noscript><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"></noscript>
    
    <style>
        /* Variáveis CSS: Organizadas por tipo para facilitar manutenção */
        :root {
            /* Cores primárias e secundárias */
            --primary: #2563eb;
            --primary-hover: #1d4ed8;
            --secondary: #0f172a;
            --accent: #10b981;
            --accent-hover: #059669;
            
            /* Palette de cores */
            --color-1: #6366f1;
            --color-2: #ec4899;
            --color-3: #f59e0b;
            --color-4: #8b5cf6;
            
            /* Cores de texto e fundo */
            --text: #1e293b;
            --light-bg: #f8fafc;
            --dark-bg: #0f172a;
            --dark-secondary: #1e293b;
            --border: #e2e8f0;
            --card-bg: #ffffff;
            
            /* Sombras */
            --shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.08);
            --card-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            
            /* Espaçamentos e tamanhos - usando rem para melhor responsividade */
            --spacing-xs: 0.25rem;
            --spacing-sm: 0.5rem;
            --spacing-md: 1rem;
            --spacing-lg: 1.5rem;
            --spacing-xl: 2rem;
            
            /* Tamanhos padrão para elementos da UI */
            --menu-icon-size: 2.2rem;
            --menu-item-height: 130px;
            --header-padding: 1.5rem;
            --container-width: 1200px;
            
            /* Tempos de transição */
            --transition-fast: 0.2s;
            --transition-normal: 0.3s;
            --transition-slow: 0.5s;
            
            /* Bordas arredondadas */
            --radius-sm: 4px;
            --radius-md: 8px;
            --radius-lg: 10px;
            --radius-xl: 12px;
            --radius-full: 9999px;
        }

        /* Reset e estilos base melhorados */
        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box; 
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif; 
            transition: background-color var(--transition-fast) ease, 
                      color var(--transition-fast) ease, 
                      border-color var(--transition-fast) ease, 
                      transform var(--transition-fast) ease; 
        }
        
        html {
            font-size: 16px;
            scroll-behavior: smooth;
        }
        
        body { 
            background-color: var(--light-bg); 
            color: var(--text); 
            line-height: 1.6; 
            overflow-x: hidden; 
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        /* Estilos do cabeçalho otimizados */
        header { 
            background: linear-gradient(135deg, var(--primary), var(--primary-hover)); 
            color: white; 
            padding: var(--header-padding); 
            text-align: center; 
            box-shadow: var(--shadow); 
            position: relative; 
            overflow: hidden; 
            margin-bottom: var(--spacing-xl); 
        }
        
        header::before { 
            content: ''; 
            position: absolute; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background-image: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M11 18c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm48 25c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm-43-7c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm63 31c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM34 90c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm56-76c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM12 86c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm28-65c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm23-11c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-6 60c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm29 22c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zM32 63c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm57-13c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-9-21c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM60 91c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM35 41c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM12 60c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2z' fill='%23ffffff' fill-opacity='0.05' fill-rule='evenodd'/%3E%3C/svg%3E"); 
            opacity: 0.6; 
        }
        
        h1 { 
            font-size: clamp(1.8rem, 5vw, 2.2rem); 
            margin-bottom: var(--spacing-sm); 
            position: relative; 
            z-index: 1; 
        }
        
        .logo { 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            margin-bottom: var(--spacing-md); 
            position: relative; 
            z-index: 1; 
        }
        
        .logo i { 
            font-size: min(2.5rem, 10vw); 
            margin-right: 10px; 
            color: white; 
        }
        
        .container { 
            width: 100%;
            max-width: var(--container-width); 
            margin: 0 auto; 
            padding: 0 var(--spacing-md); 
            flex: 1;
        }
        
        .content { 
            padding: var(--spacing-md) 0; 
            width: 100%; 
        }

        /* Menu aprimorado com melhor responsividade */
        .menu { 
            list-style: none; 
            padding: 0; 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); 
            gap: var(--spacing-lg); 
            max-width: 900px; 
            margin: var(--spacing-xl) auto; 
        }
        
        .menu-item { 
            position: relative; 
        }
        
        .menu-link { 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center; 
            padding: var(--spacing-lg) var(--spacing-md); 
            text-decoration: none; 
            border-radius: var(--radius-lg); 
            background-color: var(--primary); 
            color: white; 
            text-align: center; 
            min-height: var(--menu-item-height); 
            box-shadow: var(--card-shadow); 
            transition: all var(--transition-normal) ease; 
            cursor: pointer; 
            will-change: transform; /* Otimiza animações */
        }

        /* Cores de gradiente para itens do menu */
        .menu-item:nth-child(1) .menu-link { background: linear-gradient(135deg, var(--primary), var(--color-1)); }
        .menu-item:nth-child(2) .menu-link { background: linear-gradient(135deg, var(--accent), #14b8a6); }
        .menu-item:nth-child(3) .menu-link { background: linear-gradient(135deg, var(--color-3), #f97316); }
        .menu-item:nth-child(4) .menu-link { background: linear-gradient(135deg, var(--color-4), var(--color-1)); }
        .menu-item:nth-child(5) .menu-link { background: linear-gradient(135deg, var(--color-2), #db2777); }
        .menu-item:nth-child(6) .menu-link { background: linear-gradient(135deg, #3b82f6, #2563eb); }
        .menu-item:nth-child(7) .menu-link { background: linear-gradient(135deg, #ef4444, #dc2626); }
        .menu-item:nth-child(8) .menu-link { background: linear-gradient(135deg, #84cc16, #65a30d); }
        .menu-item:nth-child(9) .menu-link { background: linear-gradient(135deg, #0ea5e9, #0284c7); }
        .menu-item:nth-child(10) .menu-link { background: linear-gradient(135deg, #d946ef, #c026d3); }
        .menu-item:nth-child(n+11) .menu-link { background-color: var(--secondary); }

        .menu-link:hover, 
        .menu-link.active { 
            transform: translateY(-5px) scale(1.03); 
            box-shadow: 0 8px 20px -4px rgba(0, 0, 0, 0.2); 
        }
        
        .menu-link i { 
            font-size: var(--menu-icon-size); 
            margin-bottom: 10px; 
            color: rgba(255, 255, 255, 0.9); 
            pointer-events: none; 
        }
        
        .menu-text { 
            font-weight: 500; 
            font-size: 0.95rem; 
            line-height: 1.3; 
            pointer-events: none; 
        }

        /* Submenu aprimorado */
        .submenu { 
            list-style: none; 
            margin: 0; 
            padding: var(--spacing-sm); 
            max-height: 0; 
            overflow: hidden; 
            transition: all var(--transition-slow) ease-out; 
            position: absolute; 
            top: 100%; 
            left: 0; 
            right: 0; 
            background-color: var(--card-bg); 
            border-radius: 0 0 var(--radius-md) var(--radius-md); 
            box-shadow: 0 6px 12px -3px rgba(0,0,0,0.15); 
            z-index: 10; 
            border: 1px solid var(--border); 
            border-top: none; 
            opacity: 0; 
            visibility: hidden; 
            transform: translateY(-10px);
        }
        
        .submenu-active { 
            max-height: 500px; 
            opacity: 1; 
            visibility: visible; 
            transform: translateY(0);
            transition: all var(--transition-normal) ease-in;
        }
        
        .submenu-item { 
            padding: 0; 
        }
        
        .submenu-link { 
            display: flex; 
            align-items: center; 
            padding: calc(var(--spacing-md) * 0.6) var(--spacing-md); 
            color: var(--text); 
            text-decoration: none; 
            transition: all var(--transition-fast) ease; 
            font-size: 0.9rem; 
            border-radius: var(--radius-sm); 
            margin: 2px 0; 
            text-align: left; 
        }
        
        .submenu-link:hover { 
            color: var(--primary); 
            background-color: rgba(37, 99, 235, 0.08); 
            transform: translateX(4px); 
        }
        
        .submenu-link i { 
            font-size: 1em; 
            margin-right: 10px; 
            color: inherit; 
            opacity: 0.9; 
            width: 18px; 
            text-align: center; 
        }

        /* Welcome Card */
        .welcome-card { 
            background-color: var(--card-bg); 
            border-radius: var(--radius-xl); 
            box-shadow: var(--card-shadow); 
            padding: clamp(1.5rem, 5vw, 2.5rem); 
            text-align: center; 
            width: 100%; 
            max-width: 700px; 
            margin: var(--spacing-xl) auto; 
            position: relative; 
            overflow: hidden; 
        }
        
        .welcome-card::before { 
            content: ''; 
            position: absolute; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 6px; 
            background: linear-gradient(90deg, var(--primary), var(--accent)); 
        }
        
        .welcome-card h2 { 
            margin-bottom: var(--spacing-md); 
            color: var(--primary); 
            font-size: clamp(1.5rem, 4vw, 1.8rem);
        }
        
        .welcome-card p { 
            color: var(--text); 
            margin-bottom: var(--spacing-lg); 
            font-size: clamp(0.95rem, 3vw, 1rem);
        }

        /* Estilos responsivos aprimorados */
        @media (max-width: 1400px) {
            :root {
                --container-width: 1100px;
            }
        }
        
        @media (max-width: 1200px) {
            :root {
                --container-width: 95%;
            }
            
            .menu {
                grid-template-columns: repeat(auto-fit, minmax(130px, 1fr));
                gap: var(--spacing-md);
            }
        }
        
        @media (max-width: 768px) {
            header { 
                margin-bottom: var(--spacing-lg); 
                padding: var(--spacing-md);
            }
            
            .container { 
                padding: 0 var(--spacing-sm); 
            }
            
            .menu { 
                grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); 
                gap: var(--spacing-md); 
                margin: var(--spacing-lg) auto; 
            }
            
            .menu-link { 
                min-height: 110px; 
                padding: var(--spacing-md) var(--spacing-sm); 
            }
            
            .menu-link i { 
                font-size: 1.8rem; 
            }
            
            .menu-text { 
                font-size: 0.85rem; 
            }
            
            .welcome-card { 
                padding: var(--spacing-lg); 
                margin: var(--spacing-xl) auto; 
            }
            
            /* Melhoria para submenus em telas pequenas */
            .submenu {
                position: static;
                margin-top: var(--spacing-sm);
                border: 1px solid var(--border);
                border-radius: var(--radius-md);
            }
        }
        
        @media (max-width: 480px) {
            .menu { 
                grid-template-columns: repeat(2, 1fr); 
                gap: var(--spacing-sm); 
            }
            
            .menu-link { 
                min-height: 100px; 
            }
            
            .welcome-card {
                padding: var(--spacing-md);
            }
        }
        
        /* Melhoria para telas grandes */
        @media (min-width: 1600px) {
            :root {
                --container-width: 1400px;
                --menu-item-height: 150px;
            }
            
            .menu {
                grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
                max-width: 1200px;
            }
            
            body {
                font-size: 18px;
            }
        }

        /* Theme Toggle */
        .theme-toggle { 
            position: fixed; 
            bottom: 20px; 
            right: 20px; 
            background-color: var(--primary); 
            color: white; 
            width: 50px; 
            height: 50px; 
            border-radius: var(--radius-full); 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            cursor: pointer; 
            box-shadow: var(--shadow); 
            z-index: 1000; 
            transition: all var(--transition-normal) ease; 
        }
        
        .theme-toggle:hover { 
            transform: scale(1.1); 
        }
        
        /* Melhoria para tamanho do toggle em dispositivos móveis */
        @media (max-width: 480px) {
            .theme-toggle {
                width: 40px;
                height: 40px;
                bottom: 15px;
                right: 15px;
            }
        }

        /* Dark Theme */
        body.dark-theme { 
            --text: #e2e8f0; 
            --light-bg: var(--dark-bg); 
            --card-bg: var(--dark-secondary); 
            --border: #334155; 
        }
        
        .dark-theme .welcome-card, 
        .dark-theme .submenu { 
            background-color: var(--dark-secondary); 
            border-color: #334155; 
        }
        
        .dark-theme .welcome-card p, 
        .dark-theme .submenu-link { 
            color: #cbd5e1; 
        }
        
        .dark-theme .submenu-link:hover { 
            color: var(--primary); 
            background-color: rgba(37, 99, 235, 0.2); 
        }
        
        .dark-theme .menu-link:hover { 
            box-shadow: 0 8px 20px -4px rgba(0, 0, 0, 0.4); 
        }

        /* Loading Animation */
        .loader { 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background-color: var(--light-bg); 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            z-index: 9999; 
            transition: opacity var(--transition-normal) ease, visibility var(--transition-normal) ease; 
        }
        
        .dark-theme .loader { 
            background-color: var(--dark-bg); 
        }
        
        .loader.hidden { 
            opacity: 0; 
            visibility: hidden; 
        }
        
        .spinner { 
            width: 50px; 
            height: 50px; 
            border: 5px solid rgba(37, 99, 235, 0.2); 
            border-radius: 50%; 
            border-top-color: var(--primary); 
            animation: spin 1s linear infinite; 
        }
        
        @keyframes spin { 
            0% { transform: rotate(0deg); } 
            100% { transform: rotate(360deg); } 
        }

        /* Mensagens de status e erro */
        .menu-message { 
            color: var(--text); 
            text-align: center; 
            padding: var(--spacing-xl); 
            background-color: rgba(0, 0, 0, 0.02); 
            border-radius: var(--radius-md); 
            grid-column: 1 / -1; 
        }
        
        .menu-error { 
            color: #dc2626; 
            background-color: rgba(220, 38, 38, 0.1); 
            border: 1px solid rgba(220, 38, 38, 0.3); 
        }
        
        /* Botão de atualização */
        .refresh-button {
            background-color: var(--primary);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin: 0 auto;
            cursor: pointer;
            transition: background-color 0.2s ease, transform 0.2s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            font-weight: 500;
        }
        
        .refresh-button:hover {
            background-color: var(--primary-hover);
            transform: translateY(-2px);
        }
        
        .refresh-button:active {
            transform: translateY(0);
        }
        
        .refresh-button i {
            font-size: 0.9rem;
        }
        
        .refresh-button.loading i {
            animation: spin 1s linear infinite;
        }
        
        .dark-theme .refresh-button {
            background-color: var(--primary);
        }
        
        .refresh-status {
            font-size: 0.85rem;
            color: var(--primary);
            margin-top: 0.5rem;
            opacity: 0;
            transition: opacity 0.3s ease;
            text-align: center;
        }
        
        .refresh-status.visible {
            opacity: 1;
        }
        
        .dark-theme .menu-message { 
            color: #cbd5e1; 
            background-color: rgba(255, 255, 255, 0.05); 
        }
        
        .dark-theme .menu-error { 
            color: #f87171; 
            background-color: rgba(248, 113, 113, 0.1); 
            border-color: rgba(248, 113, 113, 0.3); 
        }
        
        /* Estilos para acessibilidade */
        @media (prefers-reduced-motion: reduce) {
            * {
                transition: none !important;
                animation: none !important;
            }
        }
        
        /* Estilos adicionais para melhorar a interatividade */
        .menu-link:focus-visible,
        .submenu-link:focus-visible,
        .theme-toggle:focus-visible {
            outline: 2px solid var(--primary);
            outline-offset: 2px;
        }
        
        /* Nova animação de entrada suave para os itens de menu */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .menu-item {
            animation: fadeIn 0.4s ease-out forwards;
            opacity: 0;
        }
        
        /* Atrasar a animação para cada item */
        .menu-item:nth-child(1) { animation-delay: 0.1s; }
        .menu-item:nth-child(2) { animation-delay: 0.15s; }
        .menu-item:nth-child(3) { animation-delay: 0.2s; }
        .menu-item:nth-child(4) { animation-delay: 0.25s; }
        .menu-item:nth-child(5) { animation-delay: 0.3s; }
        .menu-item:nth-child(6) { animation-delay: 0.35s; }
        .menu-item:nth-child(7) { animation-delay: 0.4s; }
        .menu-item:nth-child(8) { animation-delay: 0.45s; }
        .menu-item:nth-child(9) { animation-delay: 0.5s; }
        .menu-item:nth-child(10) { animation-delay: 0.55s; }
    </style>
</head>
<body>
    <div class="loader">
        <div class="spinner"></div>
    </div>

    <header>
        <div class="logo">
            <i class="fas fa-bread-slice"></i>
            <h1>Ameripan</h1>
        </div>
        <p>Sistema de Gerenciamento</p>
    </header>

    <div class="container">
        <main class="content">
            <ul class="menu" id="dynamic-menu">
                <p class="menu-message">Carregando menu...</p>
            </ul>
            <div class="welcome-card">
                <h2>Bem-vindo ao Sistema Ameripan</h2>
                <p>Selecione uma opção no menu acima para navegar pelas ferramentas e relatórios.</p>
                <button id="refreshMenu" class="refresh-button">
                    <i class="fas fa-sync-alt"></i> Atualizar Menu
                </button>
                <div id="refreshStatus" class="refresh-status"></div>
            </div>
        </main>
    </div>

    <div class="theme-toggle" id="themeToggle" tabindex="0" role="button" aria-label="Alternar tema claro/escuro">
        <i class="fas fa-moon"></i>
    </div>

    <script>
        // Constantes de configuração
        const CONFIG = {
            // ID da planilha Google Sheets
            spreadsheetId: "1x8_k27RWofNxNYDfWtC9skTEWPksk9dRHMhay6QCspU",
            // Chave de API do Google Sheets
            apiKey: "AIzaSyB_DqAfjDQHOGESUrUboqiVYv0qGa1WeJc",
            // Nome da ABA e COLUNAS a serem lidas
            range: "menu-amp!A:G",
            // Tempo de cache em minutos
            cacheTime: 30,
            // Delay mínimo para mostrar o loader (ms)
            minLoaderTime: 300,
            // Tempo de expiração do cache (ms)
            cacheExpiration: 30 * 60 * 1000, // 30 minutos
            // Nome da chave de cache no localStorage
            cacheKey: 'ameripan_menu_data',
            // Parâmetro URL para forçar atualização
            refreshParam: 'refresh'
        };
        
        // Inicialização da aplicação
        document.addEventListener('DOMContentLoaded', async function() {
            // Inicializa o tema (antes de qualquer renderização)
            initTheme();
            
            // Configura o botão de atualização do menu
            setupRefreshButton();
            
            // Verifica se deve forçar atualização pela URL
            const shouldForceRefresh = checkForceRefreshParam();
            
            // Inicia o timestamp para rastrear o tempo mínimo do loader
            const loaderStartTime = Date.now();
            
            try {
                // Tenta carregar dados do menu (do cache ou da API)
                await loadMenu(shouldForceRefresh);
                
                // Garante tempo mínimo do loader para evitar flash
                const loadTime = Date.now() - loaderStartTime;
                if (loadTime < CONFIG.minLoaderTime) {
                    await new Promise(resolve => setTimeout(resolve, CONFIG.minLoaderTime - loadTime));
                }
            } catch (error) {
                console.error("Erro durante inicialização:", error);
                displayMenuMessage(`Falha ao carregar o menu: ${error.message}`, true);
            } finally {
                // Esconde o loader após carregar dados
                hideLoader();
            }
        });
        
        // Funções principais
        
        /**
         * Inicializa o tema com base nas preferências do usuário
         */
        function initTheme() {
            const themeToggle = document.getElementById('themeToggle');
            const body = document.body;
            const savedTheme = localStorage.getItem('theme');
            const prefersDark = window.matchMedia && 
                               window.matchMedia('(prefers-color-scheme: dark)').matches;
            
            // Define o tema inicial
            if (savedTheme === 'dark' || (!savedTheme && prefersDark)) {
                body.classList.add('dark-theme');
                updateThemeIcon(true);
            }
            
            // Configura o botão de alternar tema
            if (themeToggle) {
                themeToggle.addEventListener('click', toggleTheme);
                // Adiciona suporte a teclado para acessibilidade
                themeToggle.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' || e.key === ' ') {
                        e.preventDefault();
                        toggleTheme();
                    }
                });
            }
            
            // Listener para mudança de preferência de tema do sistema
            window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', e => {
                if (!localStorage.getItem('theme')) {
                    setTheme(e.matches ? 'dark' : 'light');
                }
            });
        }
        
        /**
         * Alterna entre temas claro e escuro
         */
        function toggleTheme() {
            const isDark = document.body.classList.toggle('dark-theme');
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
            updateThemeIcon(isDark);
        }
        
        /**
         * Atualiza o ícone do botão de tema
         * @param {boolean} isDark - Se o tema atual é escuro
         */
        function updateThemeIcon(isDark) {
            const icon = document.querySelector('#themeToggle i');
            if (icon) {
                icon.className = isDark ? 'fas fa-sun' : 'fas fa-moon';
            }
        }
        
        /**
         * Esconde o loader com uma transição suave
         */
        function hideLoader() {
            const loader = document.querySelector('.loader');
            if (loader) {
                loader.classList.add('hidden');
                // Remove o loader do DOM após a transição
                setTimeout(() => {
                    loader.remove();
                }, 500);
            }
        }
        
        /**
         * Carrega o menu da planilha ou do cache
         * @param {boolean} forceRefresh - Se verdadeiro, ignora o cache e busca dados novos
         */
        async function loadMenu(forceRefresh = false) {
            try {
                // Se não for forçar atualização, verifica se há dados em cache válidos
                if (!forceRefresh) {
                    const cachedData = getCachedMenuData();
                    if (cachedData) {
                        buildMenu(cachedData);
                        setupMenuInteractions();
                        return;
                    }
                } else {
                    console.log("Forçando atualização, ignorando cache");
                }
                
                // Se não houver cache ou forçar atualização, carrega dados da API
                await fetchMenuData();
            } catch (error) {
                console.error("Erro ao carregar menu:", error);
                throw error;
            }
        }
        
        /**
         * Recupera dados do menu em cache, se disponíveis e válidos
         * @returns {Array|null} Dados do menu ou null se não houver cache válido
         */
        function getCachedMenuData() {
            try {
                const cached = localStorage.getItem(CONFIG.cacheKey);
                if (!cached) return null;
                
                const { timestamp, data } = JSON.parse(cached);
                const now = Date.now();
                
                // Verifica se o cache expirou
                if (now - timestamp > CONFIG.cacheExpiration) {
                    console.log("Cache expirado, buscando novos dados");
                    return null;
                }
                
                console.log("Usando dados em cache");
                return data;
            } catch (error) {
                console.warn("Erro ao ler cache:", error);
                return null;
            }
        }
        
        /**
         * Salva dados do menu no cache
         * @param {Array} data - Dados do menu
         */
        function cacheMenuData(data) {
            try {
                const cacheObject = {
                    timestamp: Date.now(),
                    data: data
                };
                localStorage.setItem(CONFIG.cacheKey, JSON.stringify(cacheObject));
            } catch (error) {
                console.warn("Erro ao salvar cache:", error);
            }
        }
        
        /**
         * Limpa o cache do menu forçando atualização
         */
        function clearMenuCache() {
            try {
                localStorage.removeItem(CONFIG.cacheKey);
                console.log("Cache do menu limpo com sucesso");
            } catch (error) {
                console.warn("Erro ao limpar cache:", error);
            }
        }
        
        /**
         * Verifica se existe parâmetro de URL para forçar atualização
         * @returns {boolean} Verdadeiro se deve forçar atualização
         */
        function checkForceRefreshParam() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.has(CONFIG.refreshParam);
        }
        
        /**
         * Configura o botão de atualização do menu
         */
        function setupRefreshButton() {
            const refreshButton = document.getElementById('refreshMenu');
            const statusEl = document.getElementById('refreshStatus');
            
            if (!refreshButton) return;
            
            refreshButton.addEventListener('click', async function() {
                try {
                    // Mostra feedback visual
                    refreshButton.classList.add('loading');
                    refreshButton.disabled = true;
                    
                    if (statusEl) {
                        statusEl.textContent = "Atualizando menu...";
                        statusEl.classList.add('visible');
                    }
                    
                    // Limpa o cache
                    clearMenuCache();
                    
                    // Busca novos dados (força atualização)
                    await loadMenu(true);
                    
                    // Feedback de sucesso
                    if (statusEl) {
                        statusEl.textContent = "Menu atualizado com sucesso!";
                        
                        // Limpa a mensagem após 3 segundos
                        setTimeout(() => {
                            statusEl.classList.remove('visible');
                            // Limpa o texto após a transição
                            setTimeout(() => {
                                statusEl.textContent = "";
                            }, 300);
                        }, 3000);
                    }
                } catch (error) {
                    console.error("Erro ao atualizar menu:", error);
                    if (statusEl) {
                        statusEl.textContent = `Erro: ${error.message}`;
                    }
                } finally {
                    // Restaura o botão
                    refreshButton.classList.remove('loading');
                    refreshButton.disabled = false;
                }
            });
        }
        
        /**
         * Busca dados do menu da planilha Google Sheets
         */
        async function fetchMenuData() {
            // Validação de configuração
            if (!CONFIG.apiKey || !CONFIG.spreadsheetId || CONFIG.apiKey.includes('COLOQUE_AQUI')) {
                const errorMsg = "Erro de Configuração: API Key ou ID da Planilha não configurados corretamente.";
                displayMenuMessage(errorMsg, true);
                throw new Error(errorMsg);
            }
            
            // Constrói URL da API
            const url = `https://sheets.googleapis.com/v4/spreadsheets/${CONFIG.spreadsheetId}/values/${CONFIG.range}?key=${CONFIG.apiKey}`;
            
            try {
                const response = await fetch(url);
                
                if (!response.ok) {
                    let errorMessage = `Erro ${response.status}: ${response.statusText}`;
                    
                    try {
                        const errorData = await response.json();
                        errorMessage = `Erro ${response.status}: ${errorData.error?.message || response.statusText}`;
                        
                        // Adiciona dicas específicas para erros comuns
                        if (response.status === 403) {
                            errorMessage += " (Verifique sua API Key e permissões da planilha)";
                        } else if (response.status === 404) {
                            errorMessage += ` (Planilha '${CONFIG.spreadsheetId}' não encontrada)`;
                        }
                    } catch (e) {
                        // Falha ao analisar resposta de erro
                        console.warn("Não foi possível analisar detalhes do erro:", e);
                    }
                    
                    displayMenuMessage(errorMessage, true);
                    throw new Error(errorMessage);
                }
                
                const data = await response.json();
                
                // Verifica se há dados
                if (!data.values || data.values.length <= 1) {
                    const errorMsg = `Nenhum dado encontrado na planilha para o range "${CONFIG.range}"`;
                    displayMenuMessage(errorMsg, true);
                    throw new Error(errorMsg);
                }
                
                // Constrói o menu com os dados
                buildMenu(data.values);
                // Configura interações
                setupMenuInteractions();
                // Salva no cache
                cacheMenuData(data.values);
                
            } catch (error) {
                console.error("Erro ao buscar dados da planilha:", error);
                displayMenuMessage(`Falha ao carregar o menu: ${error.message}`, true);
                throw error;
            }
        }
        
        /**
         * Constrói o menu a partir dos dados
         * @param {Array} rows - Linhas de dados da planilha
         */
        function buildMenu(rows) {
            const menu = document.getElementById('dynamic-menu');
            if (!menu) return;
            
            menu.innerHTML = ''; // Limpa "Carregando..." ou erro anterior
            
            // Pula linha de cabeçalho (índice 0)
            rows.slice(1).forEach((rowData, index) => {
                // Ignora linhas vazias
                if (!rowData || rowData.length === 0 || !rowData[0]?.trim()) {
                    return;
                }
                
                // Extrai dados das colunas
                const titulo = rowData[0]?.trim() || '';
                const link = rowData[1]?.trim() || '#';
                const iconClass = rowData[2]?.trim() || 'fas fa-folder';
                
                // Processa submenus
                const submenus = [];
                for (let i = 3; i < rowData.length; i += 2) {
                    const subTitulo = rowData[i]?.trim();
                    const subLink = rowData[i+1]?.trim();
                    
                    if (subTitulo && subLink) {
                        submenus.push({ title: subTitulo, link: subLink });
                    } else if (subTitulo || subLink) {
                        console.warn(`Submenu incompleto: "${subTitulo}", Link: "${subLink}"`);
                        break;
                    } else {
                        break;
                    }
                }
                
                // Cria estrutura do menu
                const menuItem = document.createElement('li');
                menuItem.className = 'menu-item';
                // Atraso progressivo para animação
                menuItem.style.animationDelay = `${0.05 + (index * 0.05)}s`;
                
                const menuLink = document.createElement('a');
                menuLink.className = 'menu-link';
                menuLink.href = (submenus.length > 0) ? '#' : link;
                menuLink.setAttribute('aria-label', titulo);
                
                // Configura links externos
                if (isExternalLink(link)) {
                    menuLink.target = '_blank';
                    menuLink.rel = 'noopener noreferrer';
                }
                
                // Cria ícone
                const iconElement = document.createElement('i');
                iconClass.split(' ').forEach(cls => {
                    if (cls) iconElement.classList.add(cls.trim());
                });
                
                // Cria texto
                const textElement = document.createElement('span');
                textElement.className = 'menu-text';
                textElement.textContent = titulo;
                
                // Monta estrutura
                menuLink.appendChild(iconElement);
                menuLink.appendChild(textElement);
                menuItem.appendChild(menuLink);
                
                // Adiciona submenu se existir
                if (submenus.length > 0) {
                    menuLink.classList.add('toggle-submenu');
                    menuLink.setAttribute('aria-expanded', 'false');
                    menuLink.setAttribute('aria-haspopup', 'true');
                    
                    const subMenuUl = document.createElement('ul');
                    subMenuUl.className = 'submenu';
                    subMenuUl.setAttribute('role', 'menu');
                    
                    submenus.forEach(sub => {
                        const subMenuItem = document.createElement('li');
                        subMenuItem.className = 'submenu-item';
                        subMenuItem.setAttribute('role', 'none');
                        
                        const subMenuLink = document.createElement('a');
                        subMenuLink.className = 'submenu-link';
                        subMenuLink.href = sub.link;
                        subMenuLink.setAttribute('role', 'menuitem');
                        
                        if (isExternalLink(sub.link)) {
                            subMenuLink.target = '_blank';
                            subMenuLink.rel = 'noopener noreferrer';
                        }
                        
                        const subIcon = document.createElement('i');
                        subIcon.className = 'fas fa-angle-right fa-fw';
                        
                        const subText = document.createElement('span');
                        subText.textContent = sub.title;
                        
                        subMenuLink.appendChild(subIcon);
                        subMenuLink.appendChild(subText);
                        subMenuItem.appendChild(subMenuLink);
                        subMenuUl.appendChild(subMenuItem);
                    });
                    
                    menuItem.appendChild(subMenuUl);
                }
                
                menu.appendChild(menuItem);
            });
            
            // Se nenhum item foi adicionado
            if (menu.children.length === 0) {
                displayMenuMessage("Nenhum item de menu encontrado na planilha.", false);
            }
        }
        
        /**
         * Configura todas as interações do menu
         */
        function setupMenuInteractions() {
            setupSubmenuToggle();
            setupActiveMenuLink();
            setupKeyboardNavigation();
        }
        
        /**
         * Configura toggles de submenu
         */
        function setupSubmenuToggle() {
            const menu = document.getElementById('dynamic-menu');
            if (!menu) return;
            
            // Delegação de eventos para submenus
            menu.addEventListener('click', function(e) {
                const toggleLink = e.target.closest('.toggle-submenu');
                if (!toggleLink) return;
                
                e.preventDefault();
                e.stopPropagation();
                
                const parentItem = toggleLink.closest('.menu-item');
                const submenu = parentItem?.querySelector('.submenu');
                
                if (submenu) {
                    const isActive = submenu.classList.contains('submenu-active');
                    
                    // Fecha outros submenus primeiro
                    document.querySelectorAll('.submenu.submenu-active').forEach(otherSubmenu => {
                        if (otherSubmenu !== submenu) {
                            const parentToggle = otherSubmenu.closest('.menu-item').querySelector('.toggle-submenu');
                            otherSubmenu.classList.remove('submenu-active');
                            otherSubmenu.style.maxHeight = null;
                            parentToggle.setAttribute('aria-expanded', 'false');
                        }
                    });
                    
                    // Alterna submenu atual
                    if (isActive) {
                        submenu.classList.remove('submenu-active');
                        submenu.style.maxHeight = null;
                        toggleLink.setAttribute('aria-expanded', 'false');
                    } else {
                        submenu.classList.add('submenu-active');
                        submenu.style.maxHeight = submenu.scrollHeight + "px";
                        toggleLink.setAttribute('aria-expanded', 'true');
                    }
                }
            });
            
            // Fecha submenu ao clicar fora
            document.addEventListener('click', function(e) {
                const openSubmenus = document.querySelectorAll('#dynamic-menu .submenu.submenu-active');
                openSubmenus.forEach(submenu => {
                    if (!submenu.closest('.menu-item').contains(e.target)) {
                        submenu.classList.remove('submenu-active');
                        submenu.style.maxHeight = null;
                        const parentToggle = submenu.closest('.menu-item').querySelector('.toggle-submenu');
                        parentToggle.setAttribute('aria-expanded', 'false');
                    }
                });
            });
            
            // Fecha submenu ao pressionar ESC
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    const openSubmenus = document.querySelectorAll('#dynamic-menu .submenu.submenu-active');
                    if (openSubmenus.length > 0) {
                        openSubmenus.forEach(submenu => {
                            submenu.classList.remove('submenu-active');
                            submenu.style.maxHeight = null;
                            const parentToggle = submenu.closest('.menu-item').querySelector('.toggle-submenu');
                            parentToggle.setAttribute('aria-expanded', 'false');
                        });
                        e.preventDefault();
                    }
                }
            });
        }
        
        /**
         * Configura navegação por teclado no menu
         */
        function setupKeyboardNavigation() {
            const menu = document.getElementById('dynamic-menu');
            if (!menu) return;
            
            // Navegação por teclado para o menu principal
            menu.addEventListener('keydown', function(e) {
                const currentItem = e.target.closest('.menu-item');
                if (!currentItem) return;
                
                const items = Array.from(menu.querySelectorAll('.menu-item'));
                const currentIndex = items.indexOf(currentItem);
                
                // Tratamento de setas no menu principal
                if (e.key === 'ArrowRight') {
                    const nextIndex = (currentIndex + 1) % items.length;
                    items[nextIndex].querySelector('a').focus();
                    e.preventDefault();
                } else if (e.key === 'ArrowLeft') {
                    const prevIndex = (currentIndex - 1 + items.length) % items.length;
                    items[prevIndex].querySelector('a').focus();
                    e.preventDefault();
                } else if (e.key === 'ArrowDown') {
                    const submenu = currentItem.querySelector('.submenu');
                    if (submenu && submenu.classList.contains('submenu-active')) {
                        const firstSubmenuItem = submenu.querySelector('.submenu-link');
                        if (firstSubmenuItem) {
                            firstSubmenuItem.focus();
                            e.preventDefault();
                        }
                    }
                }
            });
            
            // Navegação por teclado para submenus
            document.querySelectorAll('.submenu').forEach(submenu => {
                submenu.addEventListener('keydown', function(e) {
                    const currentLink = e.target.closest('.submenu-link');
                    if (!currentLink) return;
                    
                    const links = Array.from(submenu.querySelectorAll('.submenu-link'));
                    const currentIndex = links.indexOf(currentLink);
                    
                    if (e.key === 'ArrowDown') {
                        const nextIndex = (currentIndex + 1) % links.length;
                        links[nextIndex].focus();
                        e.preventDefault();
                    } else if (e.key === 'ArrowUp') {
                        const prevIndex = (currentIndex - 1 + links.length) % links.length;
                        links[prevIndex].focus();
                        e.preventDefault();
                    } else if (e.key === 'Escape') {
                        const parentToggle = submenu.closest('.menu-item').querySelector('.toggle-submenu');
                        parentToggle.focus();
                        submenu.classList.remove('submenu-active');
                        submenu.style.maxHeight = null;
                        parentToggle.setAttribute('aria-expanded', 'false');
                        e.preventDefault();
                    }
                });
            });
        }
        
        /**
         * Marca o link ativo com base na URL atual
         */
        function setupActiveMenuLink() {
            try {
                const currentPath = window.location.pathname;
                const currentFullUrl = window.location.href;
                let foundActive = false;
                
                // Verifica links do menu principal
                document.querySelectorAll('#dynamic-menu .menu-link:not(.toggle-submenu)').forEach(link => {
                    link.classList.remove('active');
                    
                    if (isLinkActive(link, currentFullUrl, currentPath)) {
                        link.classList.add('active');
                        foundActive = true;
                    }
                });
                
                // Verifica links de submenu
                document.querySelectorAll('#dynamic-menu .submenu-link').forEach(subLink => {
                    const parentToggle = subLink.closest('.menu-item').querySelector('.toggle-submenu');
                    
                    if (isLinkActive(subLink, currentFullUrl, currentPath)) {
                        // Marca submenu como ativo
                        parentToggle.classList.add('active');
                        // Expande o submenu
                        const submenu = subLink.closest('.submenu');
                        submenu.classList.add('submenu-active');
                        submenu.style.maxHeight = submenu.scrollHeight + "px";
                        parentToggle.setAttribute('aria-expanded', 'true');
                        foundActive = true;
                    }
                });
                
                // Marca a página inicial se nenhum link estiver ativo
                if (!foundActive && isHomePage(currentPath)) {
                    const homeLink = findHomeLink();
                    if (homeLink) {
                        homeLink.classList.add('active');
                    }
                }
                
            } catch(e) {
                console.warn("Erro ao definir link ativo:", e);
            }
        }
        
        /**
         * Verifica se um link está ativo
         */
        function isLinkActive(link, fullUrl, currentPath) {
            // Compara URL completa
            if (link.href === fullUrl) return true;
            
            try {
                // Compara apenas o pathname
                const linkUrl = new URL(link.href);
                if (linkUrl.pathname === currentPath) return true;
                
                // Para links relativos
                if (link.getAttribute('href') === currentPath) return true;
            } catch (e) {
                // Ignora erros de URL inválida
            }
            
            return false;
        }
        
        /**
         * Verifica se é a página inicial
         */
        function isHomePage(path) {
            return (
                path === '/' || 
                path.endsWith('/index.html') || 
                path.endsWith('/ameripan') || 
                path.endsWith('/ameripan/')
            );
        }
        
        /**
         * Encontra o link da página inicial
         */
        function findHomeLink() {
            return (
                document.querySelector('#dynamic-menu a[href="/"]') || 
                document.querySelector('#dynamic-menu a[href="./"]') || 
                document.querySelector('#dynamic-menu a[href="index.html"]') || 
                document.querySelector('#dynamic-menu a[href="/ameripan/"]') || 
                document.querySelector('#dynamic-menu a[href="/ameripan"]')
            );
        }
        
        /**
         * Verifica se um link é externo
         */
        function isExternalLink(url) {
            try {
                if (url.startsWith('http://') || url.startsWith('https://')) {
                    const linkUrl = new URL(url);
                    return linkUrl.hostname !== window.location.hostname;
                }
                return false;
            } catch (e) {
                return false;
            }
        }
        
        /**
         * Exibe mensagem na área do menu
         */
        function displayMenuMessage(message, isError = false) {
            const menu = document.getElementById('dynamic-menu');
            if (!menu) return;
            
            const messageElement = document.createElement('p');
            messageElement.className = 'menu-message';
            if (isError) {
                messageElement.classList.add('menu-error');
            }
            messageElement.textContent = message;
            
            menu.innerHTML = '';
            menu.appendChild(messageElement);
        }
    </script>

</body>
</html>
