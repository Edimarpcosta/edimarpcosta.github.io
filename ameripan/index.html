<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ameripan - Sistema de Gerenciamento</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Estilos CSS (mantidos da versão anterior com blocos centralizados) */
        :root {
            --primary: #2563eb;
            --primary-hover: #1d4ed8;
            --secondary: #0f172a;
            --accent: #10b981; /* Verde */
            --accent-hover: #059669;
            --color-1: #6366f1; /* Indigo */
            --color-2: #ec4899; /* Pink */
            --color-3: #f59e0b; /* Amber */
            --color-4: #8b5cf6; /* Violet */
            --text: #1e293b;
            --light-bg: #f8fafc;
            --dark-bg: #0f172a; /* Azul bem escuro */
            --dark-secondary: #1e293b; /* Azul escuro/cinza */
            --border: #e2e8f0;
            --card-bg: #ffffff;
            --shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.08);
            --card-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', system-ui, -apple-system, sans-serif; transition: background-color 0.2s ease, color 0.2s ease, border-color 0.2s ease, transform 0.2s ease; }
        body { background-color: var(--light-bg); color: var(--text); line-height: 1.6; overflow-x: hidden; }
        header { background: linear-gradient(135deg, var(--primary), var(--primary-hover)); color: white; padding: 1.5rem; text-align: center; box-shadow: var(--shadow); position: relative; overflow: hidden; margin-bottom: 2rem; }
        header::before { content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-image: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M11 18c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm48 25c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm-43-7c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm63 31c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM34 90c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm56-76c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM12 86c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm28-65c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm23-11c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-6 60c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm29 22c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zM32 63c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm57-13c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-9-21c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM60 91c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM35 41c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM12 60c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2z' fill='%23ffffff' fill-opacity='0.05' fill-rule='evenodd'/%3E%3C/svg%3E"); opacity: 0.6; }
        h1 { font-size: 2.2rem; margin-bottom: 0.5rem; position: relative; z-index: 1; }
        .logo { display: flex; align-items: center; justify-content: center; margin-bottom: 1rem; position: relative; z-index: 1; }
        .logo i { font-size: 2rem; margin-right: 10px; color: white; }
        .container { max-width: 1200px; margin: 0 auto; padding: 0 1rem; }
        .content { padding: 1rem 0; width: 100%; }

        /* --- Menu Block Styles (Centered) --- */
        .menu { list-style: none; padding: 0; display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 1.5rem; max-width: 900px; margin: 2rem auto; }
        .menu-item { position: relative; } /* Needed for absolute positioned submenu */
        .menu-link { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 1.5rem 1rem; text-decoration: none; border-radius: 10px; background-color: var(--primary); color: white; text-align: center; min-height: 130px; box-shadow: var(--card-shadow); transition: transform 0.2s ease, box-shadow 0.2s ease, background-color 0.2s ease; cursor: pointer; } /* Added cursor pointer */

        /* Cores - ATENÇÃO: nth-child pode não funcionar como esperado se os itens forem filtrados/reordenados dinamicamente. */
        /* Uma alternativa é colocar a cor na planilha e aplicar via style ou classe */
        .menu-item:nth-child(1) .menu-link { background: linear-gradient(135deg, var(--primary), var(--color-1)); }
        .menu-item:nth-child(2) .menu-link { background: linear-gradient(135deg, var(--accent), #14b8a6); }
        .menu-item:nth-child(3) .menu-link { background: linear-gradient(135deg, var(--color-3), #f97316); }
        .menu-item:nth-child(4) .menu-link { background: linear-gradient(135deg, var(--color-4), var(--color-1)); }
        .menu-item:nth-child(5) .menu-link { background: linear-gradient(135deg, var(--color-2), #db2777); }
        .menu-item:nth-child(6) .menu-link { background: linear-gradient(135deg, #3b82f6, #2563eb); }
        .menu-item:nth-child(7) .menu-link { background: linear-gradient(135deg, #ef4444, #dc2626); }
        .menu-item:nth-child(8) .menu-link { background: linear-gradient(135deg, #84cc16, #65a30d); }
        .menu-item:nth-child(9) .menu-link { background: linear-gradient(135deg, #0ea5e9, #0284c7); }
        .menu-item:nth-child(10) .menu-link { background: linear-gradient(135deg, #d946ef, #c026d3); }
        /* Fallback / Default color for items beyond 10 */
        .menu-item:nth-child(n+11) .menu-link { background-color: var(--secondary); }


        .menu-link:hover, .menu-link.active { transform: translateY(-5px) scale(1.03); box-shadow: 0 8px 20px -4px rgba(0, 0, 0, 0.2); }
        .menu-link i { font-size: 2.2rem; margin-bottom: 10px; color: rgba(255, 255, 255, 0.9); pointer-events: none; /* Prevent icon from intercepting clicks */ }
        .menu-text { font-weight: 500; font-size: 0.95rem; line-height: 1.3; pointer-events: none; /* Prevent text from intercepting clicks */ }

        /* --- Submenu Styles (Dropdown below block) --- */
        .submenu { list-style: none; margin: 0; padding: 0.5rem; max-height: 0; overflow: hidden; transition: max-height 0.4s ease-out, opacity 0.4s ease-out, visibility 0.4s ease-out; position: absolute; top: 100%; left: 0; right: 0; background-color: var(--card-bg); border-radius: 0 0 8px 8px; box-shadow: 0 6px 12px -3px rgba(0,0,0,0.15); z-index: 10; border: 1px solid var(--border); border-top: none; opacity: 0; visibility: hidden; }
        .submenu-active { max-height: 500px; opacity: 1; visibility: visible; transition: max-height 0.5s ease-in, opacity 0.3s ease-in, visibility 0.3s ease-in; }
        .submenu-item { padding: 0; }
        .submenu-link { display: flex; align-items: center; padding: 0.6rem 1rem; color: var(--text); text-decoration: none; transition: background-color 0.2s ease, color 0.2s ease, transform 0.2s ease; font-size: 0.9rem; border-radius: 4px; margin: 2px 0; text-align: left; }
        .submenu-link:hover { color: var(--primary); background-color: rgba(37, 99, 235, 0.08); transform: translateX(4px); }
        .submenu-link i { font-size: 1em; margin-right: 10px; color: var(--primary); opacity: 0.9; width: 18px; text-align: center; color: inherit; }
        .submenu-link:hover i { color: var(--primary); }

        /* Welcome Card */
        .welcome-card { background-color: var(--card-bg); border-radius: 12px; box-shadow: var(--card-shadow); padding: 2.5rem; text-align: center; width: 100%; max-width: 700px; margin: 3rem auto; position: relative; overflow: hidden; }
        .welcome-card::before { content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 6px; background: linear-gradient(90deg, var(--primary), var(--accent)); }
        .welcome-card h2 { margin-bottom: 1rem; color: var(--primary); }
        .welcome-card p { color: var(--text); margin-bottom: 1.5rem; }

        /* Mobile styles */
        @media (max-width: 768px) {
            header { margin-bottom: 1.5rem; }
            .container { padding: 0 0.8rem; }
            .menu { grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 1rem; margin: 1.5rem auto; max-width: 100%; }
            .menu-link { min-height: 110px; padding: 1rem 0.5rem; }
            .menu-link i { font-size: 1.8rem; }
            .menu-text { font-size: 0.85rem; }
            .welcome-card { padding: 1.5rem; margin: 2rem auto; }
        }
        @media (max-width: 480px) {
            .menu { grid-template-columns: repeat(2, 1fr); gap: 0.8rem; }
            .menu-link { min-height: 100px; }
        }

        /* Theme Toggle */
        .theme-toggle { position: fixed; bottom: 20px; right: 20px; background-color: var(--primary); color: white; width: 50px; height: 50px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; box-shadow: var(--shadow); z-index: 1000; transition: all 0.3s ease; }
        .theme-toggle:hover { transform: scale(1.1); }

        /* Dark Theme */
        body.dark-theme { --text: #e2e8f0; --light-bg: var(--dark-bg); --card-bg: var(--dark-secondary); --border: #334155; }
        .dark-theme .welcome-card, .dark-theme .submenu { background-color: var(--dark-secondary); border-color: #334155; }
        .dark-theme .welcome-card p, .dark-theme .submenu-link { color: #cbd5e1; }
        .dark-theme .submenu-link:hover { color: var(--primary); background-color: rgba(37, 99, 235, 0.2); }
        /* Dark theme menu link adjustments */
         .dark-theme .menu-item:nth-child(n) .menu-link { /* Mantem os gradientes por padrão, ajuste se necessário */ }
        .dark-theme .menu-link:hover { box-shadow: 0 8px 20px -4px rgba(0, 0, 0, 0.4); }

        /* Loading Animation */
        .loader { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: var(--light-bg); display: flex; align-items: center; justify-content: center; z-index: 9999; transition: opacity 0.5s ease, visibility 0.5s ease; }
        .dark-theme .loader { background-color: var(--dark-bg); }
        .loader.hidden { opacity: 0; visibility: hidden; }
        .spinner { width: 50px; height: 50px; border: 5px solid rgba(37, 99, 235, 0.2); border-radius: 50%; border-top-color: var(--primary); animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Estilo para mensagem de erro ou carregamento no menu */
        .menu-message { color: var(--text); text-align: center; padding: 2rem; background-color: rgba(0, 0, 0, 0.02); border-radius: 8px; grid-column: 1 / -1; /* Ocupa toda a largura da grid */ }
        .menu-error { color: #dc2626; background-color: rgba(220, 38, 38, 0.1); border: 1px solid rgba(220, 38, 38, 0.3); }
        .dark-theme .menu-message { color: #cbd5e1; background-color: rgba(255, 255, 255, 0.05); }
        .dark-theme .menu-error { color: #f87171; background-color: rgba(248, 113, 113, 0.1); border-color: rgba(248, 113, 113, 0.3); }

    </style>
</head>
<body>
    <div class="loader">
        <div class="spinner"></div>
    </div>

    <header>
        <div class="logo">
            <i class="fas fa-bread-slice"></i>
            <h1>Ameripan</h1>
        </div>
        <p>Sistema de Gerenciamento</p>
    </header>

    <div class="container">
        <main class="content">
            <ul class="menu" id="dynamic-menu">
                <p class="menu-message">Carregando menu...</p>
            </ul>
            <div class="welcome-card">
                <h2>Bem-vindo ao Sistema Ameripan</h2>
                <p>Selecione uma opção no menu acima para navegar pelas ferramentas e relatórios.</p>
            </div>

        </main>
    </div>

    <div class="theme-toggle" id="themeToggle">
        <i class="fas fa-moon"></i> </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Esconde o loader inicial
            hideLoader();
            // Busca dados e constrói o menu
            fetchMenuData();
            // Configura o botão de tema
            setupThemeToggle();
        });

        function hideLoader() {
            const loader = document.querySelector('.loader');
             setTimeout(() => {
                 if (loader) {
                     loader.classList.add('hidden');
                 }
             }, 300);
        }

        // --- Lógica para buscar dados da Planilha Google ---
        function fetchMenuData() {
            // --- !!! ATENÇÃO: Configure seus dados aqui !!! ---
            // Coloque o ID da sua planilha Google Sheets aqui
            const spreadsheetId = "1x8_k27RWofNxNYDfWtC9skTEWPksk9dRHMhay6QCspU"; // Ex: "1x8_k27RWofNxNYDfWtC9skTEWPksk9dRHMhay6QCspU"
            // Coloque sua Chave de API do Google Sheets aqui
            const apiKey = "AIzaSyB_DqAfjDQHOGESUrUboqiVYv0qGa1WeJc";       // Ex: "AIzaSyB_DqAfjDQHOGESUrUboqiVYv0qGa1WeJc"
            // *** AJUSTE AQUI: Nome da ABA e COLUNAS que você quer ler ***
            // Exemplo: Se sua aba se chama 'menu-amp' e você quer ler da coluna A até a G:
            const range = "menu-amp!A:G"; // <<<<<< MUDE AQUI CONFORME SUA PLANILHA
            // --- FIM DA CONFIGURAÇÃO ---

            // --- !!! AVISO DE SEGURANÇA !!! ---
            // Expor sua API Key no código do lado do cliente é um RISCO DE SEGURANÇA.
            // Qualquer pessoa pode encontrá-la e usá-la.
            // Considere usar Google Apps Script ou um backend para mais segurança.

            // --- Verificação de Configuração ---
            const placeholderSpreadsheetId = "COLOQUE_AQUI_O_ID_DA_SUA_PLANILHA";
            const placeholderApiKey = "COLOQUE_AQUI_SUA_CHAVE_DE_API";

            // Verifica se os valores AINDA SÃO os placeholders originais
            if (apiKey === placeholderApiKey || spreadsheetId === placeholderSpreadsheetId) {
                displayMenuMessage("Erro de Configuração: Substitua os placeholders 'COLOQUE_AQUI...' pelo ID da Planilha e Chave de API corretos no código fonte (arquivo .html).", true); // true indica erro
                console.error("ID da Planilha ou Chave de API não configurados corretamente no script. Verifique as variáveis 'spreadsheetId' e 'apiKey'.");
                return; // Interrompe a execução
            }
            // --- Fim da Verificação de Configuração ---


            const url = `https://sheets.googleapis.com/v4/spreadsheets/${spreadsheetId}/values/${range}?key=${apiKey}`;

            fetch(url)
                .then(response => {
                    if (!response.ok) {
                        // Tenta ler a mensagem de erro da API do Google, se disponível
                        return response.json().then(err => {
                            // Constrói uma mensagem de erro mais detalhada
                            let errorMsg = `Erro ${response.status}: ${err.error?.message || response.statusText}`;
                            if (response.status === 403) {
                                errorMsg += " (Verifique se a API Key está correta, se a API Google Sheets está ativada no Google Cloud e se a planilha está compartilhada corretamente - 'Qualquer pessoa com o link pode ver').";
                            } else if (response.status === 400) {
                                errorMsg += ` (Verifique o formato do 'range': "${range}". Ele está correto? Ex: 'NomeDaAba!A1:G').`;
                            } else if (response.status === 404) {
                                errorMsg += ` (Verifique se o ID da Planilha '${spreadsheetId}' está correto).`;
                            }
                            throw new Error(errorMsg);
                        }).catch((jsonError) => {
                             // Se não conseguir ler o JSON do erro, lança erro genérico
                             throw new Error(`Erro na API do Google Sheets: ${response.status} ${response.statusText}. Não foi possível obter detalhes do erro. Verifique a URL e as permissões: ${url}`);
                        });
                    }
                    return response.json();
                })
                .then(data => {
                    // Verifica se 'values' existe e tem mais que 1 linha (cabeçalho + dados)
                    if (!data.values || data.values.length <= 1) {
                        displayMenuMessage(`Nenhum dado encontrado na planilha para o range "${range}". Verifique se a aba e o range estão corretos e se há dados após a linha de cabeçalho.`, true); // true indica erro
                        console.warn(`Planilha vazia ou contém apenas cabeçalho para o range "${range}". Resposta da API:`, data);
                        return;
                    }
                    buildMenu(data.values); // Constrói o menu com os dados
                    setupSubmenuToggle();   // Adiciona listeners para submenus
                    setupActiveMenuLink();  // Tenta marcar link ativo
                })
                .catch(error => {
                    console.error("Erro final ao buscar ou processar dados da planilha:", error);
                    // Mostra a mensagem de erro detalhada
                    displayMenuMessage(`Falha ao carregar o menu: ${error.message}`, true); // true indica erro
                });
        }

        function buildMenu(rows) {
            const menu = document.getElementById('dynamic-menu');
            if (!menu) return;
            menu.innerHTML = ''; // Limpa "Carregando..." ou erro anterior

            // Pula linha de cabeçalho (index 0)
            rows.slice(1).forEach((rowData) => {
                // Ignora linhas completamente vazias ou sem título (coluna A)
                if (!rowData || rowData.length === 0 || !rowData[0]?.trim()) {
                    return;
                }

                // Extrai dados das colunas (com tratamento para undefined/null e trim())
                const titulo = rowData[0]?.trim() || '';
                const link = rowData[1]?.trim() || '#';
                const iconClass = rowData[2]?.trim() || 'fas fa-folder'; // Ícone padrão pasta
                const submenus = [];
                // Começa da coluna D (índice 3) para submenus, pegando de 2 em 2
                for (let i = 3; i < rowData.length; i += 2) {
                    const subTitulo = rowData[i]?.trim();
                    const subLink = rowData[i+1]?.trim();
                    // Só adiciona se tiver ambos: título e link do submenu
                    if (subTitulo && subLink) {
                        submenus.push({ title: subTitulo, link: subLink });
                    } else if (subTitulo || subLink) {
                        // Se tiver um mas não o outro, loga um aviso e ignora o par incompleto
                        console.warn(`Submenu incompleto na linha com título "${titulo}". Subtítulo: "${subTitulo}", Link: "${subLink}". Ignorando.`);
                         break; // Para de procurar submenus nesta linha se encontrar um par inválido
                    } else {
                        // Se ambos forem vazios, para de procurar submenus nesta linha
                        break;
                    }
                }

                const menuItem = document.createElement('li');
                menuItem.className = 'menu-item';

                const menuLink = document.createElement('a');
                menuLink.className = 'menu-link';
                 // Link principal só funciona se NÃO tiver submenus
                menuLink.href = (submenus.length > 0) ? '#' : link;

                // Define target='_blank' para links externos (que começam com http/https)
                if (link.startsWith('http://') || link.startsWith('https://')) {
                    try {
                        const linkUrl = new URL(link);
                        // Abre em nova aba se for domínio diferente
                        if (linkUrl.hostname !== window.location.hostname) {
                            menuLink.target = '_blank';
                            menuLink.rel = 'noopener noreferrer'; // Boa prática de segurança
                        }
                    } catch (e) { console.warn(`URL inválida encontrada: ${link}`, e); }
                }

                const iconElement = document.createElement('i');
                // Adiciona classes do ícone (permite múltiplas classes como 'fas fa-home fa-lg')
                iconClass.split(' ').forEach(cls => {
                    if (cls) iconElement.classList.add(cls.trim()); // Adiciona cada classe separadamente
                });

                const textElement = document.createElement('span');
                textElement.className = 'menu-text';
                textElement.textContent = titulo;

                menuLink.appendChild(iconElement);
                menuLink.appendChild(textElement);
                menuItem.appendChild(menuLink); // Adiciona link ao item

                // Adiciona Submenu se existir
                if (submenus.length > 0) {
                    menuLink.classList.add('toggle-submenu'); // Classe para o JS identificar

                    const subMenuUl = document.createElement('ul');
                    subMenuUl.className = 'submenu';

                    submenus.forEach(sub => {
                        const subMenuItem = document.createElement('li');
                        subMenuItem.className = 'submenu-item';

                        const subMenuLink = document.createElement('a');
                        subMenuLink.className = 'submenu-link';
                        subMenuLink.href = sub.link;

                        // Target blank para links externos no submenu
                        if (sub.link.startsWith('http://') || sub.link.startsWith('https://')) {
                             try {
                                const subLinkUrl = new URL(sub.link);
                                if (subLinkUrl.hostname !== window.location.hostname) {
                                    subMenuLink.target = '_blank';
                                    subMenuLink.rel = 'noopener noreferrer';
                                }
                             } catch(e) { console.warn(`URL de submenu inválida encontrada: ${sub.link}`, e); }
                        }

                        const subIcon = document.createElement('i');
                        subIcon.className = 'fas fa-angle-right fa-fw'; // Ícone padrão submenu com largura fixa

                        const subText = document.createElement('span');
                        subText.textContent = sub.title;

                        subMenuLink.appendChild(subIcon);
                        subMenuLink.appendChild(subText);
                        subMenuItem.appendChild(subMenuLink);
                        subMenuUl.appendChild(subMenuItem);
                    });
                    menuItem.appendChild(subMenuUl); // Adiciona UL do submenu ao item principal
                }

                menu.appendChild(menuItem); // Adiciona o item completo ao menu
            });
        }

        function setupSubmenuToggle() {
            const menu = document.getElementById('dynamic-menu');
            if (!menu) return;

            // Usa delegação de eventos no container do menu
            menu.addEventListener('click', function(e) {
                // Verifica se o clique foi no link que deve abrir/fechar submenu
                const toggleLink = e.target.closest('.toggle-submenu');
                if (toggleLink) {
                    e.preventDefault(); // Previne navegação do link pai '#'
                    e.stopPropagation(); // Impede que o clique feche o menu imediatamente

                    const parentItem = toggleLink.closest('.menu-item');
                    const submenu = parentItem ? parentItem.querySelector('.submenu') : null;

                    if (submenu) {
                        const isActive = submenu.classList.contains('submenu-active');

                        // Fecha outros submenus no mesmo nível primeiro
                        parentItem.parentElement.querySelectorAll('.submenu.submenu-active').forEach(otherSubmenu => {
                            if (otherSubmenu !== submenu) { // Não fecha o próprio submenu
                                otherSubmenu.classList.remove('submenu-active');
                                otherSubmenu.style.maxHeight = null;
                            }
                        });

                        // Abre/Fecha o submenu atual
                        if (isActive) {
                            submenu.classList.remove('submenu-active');
                            submenu.style.maxHeight = null; // Recolhe
                        } else {
                            submenu.classList.add('submenu-active');
                            submenu.style.maxHeight = submenu.scrollHeight + "px"; // Expande para altura do conteúdo
                        }
                    }
                }
            });

            // Listener global para fechar submenu se clicar fora dele
            document.addEventListener('click', function(e) {
                const openSubmenu = document.querySelector('#dynamic-menu .submenu.submenu-active');
                // Se existe submenu aberto E o clique NÃO foi dentro do item de menu que o contém
                if (openSubmenu && !openSubmenu.closest('.menu-item').contains(e.target)) {
                    openSubmenu.classList.remove('submenu-active');
                    openSubmenu.style.maxHeight = null; // Recolhe
                }
            });
        }

        function setupActiveMenuLink() {
            // Lógica para marcar item ativo (pode ser complexa dependendo das URLs)
            try {
                 const currentPath = window.location.pathname;
                 const currentFullPath = window.location.href;
                 let foundActive = false;

                 document.querySelectorAll('#dynamic-menu .menu-link').forEach(link => {
                     // Reseta todos para inativo primeiro
                     link.classList.remove('active');

                     // Ignora links que abrem submenus na comparação direta
                     if (link.classList.contains('toggle-submenu')) return;

                     // Compara o href completo (útil para links absolutos)
                     if (link.href === currentFullPath) {
                         link.classList.add('active');
                         foundActive = true;
                     }
                     // Compara apenas o pathname (útil para links relativos)
                     else if (link.pathname === currentPath) {
                         link.classList.add('active');
                         foundActive = true;
                     }
                 });

                 // Tenta marcar um item pai se um filho estiver ativo (opcional, mais complexo)
                 // ...

                 // Se nenhum link específico foi ativo, tenta marcar a 'Página Inicial' (heurística)
                 if (!foundActive && (currentPath === '/' || currentPath.endsWith('/index.html') || currentPath.endsWith('/ameripan') || currentPath.endsWith('/ameripan/'))) {
                      // Tenta encontrar um link que pareça ser a 'raiz' ou 'home'
                      const homeLink = document.querySelector('#dynamic-menu a[href$="/ameripan/"]') || document.querySelector('#dynamic-menu a[href$="/ameripan"]');
                      if (homeLink && !homeLink.classList.contains('toggle-submenu')) {
                           homeLink.classList.add('active');
                      }
                 }

            } catch(e) {
                console.error("Erro ao definir link ativo:", e);
            }
        }


        function setupThemeToggle() {
            const themeToggle = document.getElementById('themeToggle');
            const body = document.body;
            const icon = themeToggle ? themeToggle.querySelector('i') : null;
            if (!themeToggle || !icon) {
                console.warn("Botão de tema não encontrado.");
                return;
            }

            function setTheme(theme) {
                if (theme === 'dark') {
                    body.classList.add('dark-theme');
                    icon.className = 'fas fa-sun'; // Ícone Sol
                    localStorage.setItem('theme', 'dark');
                } else {
                    body.classList.remove('dark-theme');
                    icon.className = 'fas fa-moon'; // Ícone Lua
                    localStorage.setItem('theme', 'light');
                }
                // Atualiza fundo do loader para tema atual (se existir)
                const loaderBg = document.querySelector('.loader');
                 if (loaderBg) {
                    loaderBg.style.backgroundColor = getComputedStyle(body).getPropertyValue('--light-bg');
                 }
            }

            // Verifica tema salvo ou preferência do sistema
            const savedTheme = localStorage.getItem('theme');
            const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;

            // Define tema inicial
            if (savedTheme) { setTheme(savedTheme); }
            else if (prefersDark) { setTheme('dark'); }
            else { setTheme('light'); } // Default para light

            // Listener para clique no botão
            themeToggle.addEventListener('click', () => {
                setTheme(body.classList.contains('dark-theme') ? 'light' : 'dark');
            });

            // Listener para mudança de preferência do sistema (opcional)
            window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', e => {
                // Só muda se o usuário não tiver definido um tema manualmente
                if (!localStorage.getItem('theme')) {
                    setTheme(e.matches ? 'dark' : 'light');
                }
            });
        }

        // Função para exibir mensagens (erro ou carregando) na área do menu
        function displayMenuMessage(message, isError = false) {
            const menu = document.getElementById('dynamic-menu');
            if (menu) {
                const messageElement = document.createElement('p');
                messageElement.className = 'menu-message'; // Classe base
                if (isError) {
                    messageElement.classList.add('menu-error'); // Classe adicional para erro
                }
                messageElement.textContent = message;
                menu.innerHTML = ''; // Limpa conteúdo anterior
                menu.appendChild(messageElement);
            }
        }

    </script>

</body>
</html>
