<!DOCTYPE html>
<html lang="pt-BR" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Catálogo de Produtos - Ameripan</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            /* Variáveis para o modo claro (padrão) */
            --bg-primary: #f8f9fa;
            --bg-secondary: #ffffff;
            --primary-color: #3498db;
            --secondary-color: #2980b9;
            --text-color: #333333;
            --text-secondary: #777777;
            --border-color: #dddddd;
            --hover-color: rgba(0, 0, 0, 0.05);
            --card-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            --header-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            --modal-overlay: rgba(0, 0, 0, 0.8);
            --accent-color: #e67e22;
            --success-color: #27ae60;
            --error-color: #e74c3c;
        }

        [data-theme="dark"] {
            /* Variáveis para o modo escuro */
            --bg-primary: #1a1a1a;
            --bg-secondary: #2d2d2d;
            --primary-color: #2196f3;
            --secondary-color: #1976d2;
            --text-color: #f0f0f0;
            --text-secondary: #bbbbbb;
            --border-color: #444444;
            --hover-color: rgba(255, 255, 255, 0.05);
            --card-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            --header-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
            --modal-overlay: rgba(0, 0, 0, 0.9);
            --accent-color: #f39c12;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            transition: background-color 0.3s, color 0.3s;
        }

        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-color);
            line-height: 1.6;
        }

        .container { 
            max-width: 1400px;
            margin: auto;
            padding: 0 15px;
        }

        header {
            background-color: var(--primary-color);
            color: white;
            padding: 20px 0;
            margin-bottom: 20px;
            box-shadow: var(--header-shadow);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        h1 {
            text-align: center;
            font-size: 2.2rem;
            font-weight: 600;
            margin: 0;
        }

        .header-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 10px;
        }

        .theme-toggle {
            display: flex;
            align-items: center;
            cursor: pointer;
            padding: 5px 10px;
            border-radius: 20px;
            background-color: rgba(255, 255, 255, 0.2);
            transition: background-color 0.3s;
        }

        .theme-toggle:hover {
            background-color: rgba(255, 255, 255, 0.3);
        }

        .theme-toggle i {
            margin-right: 5px;
        }

        .mode-toggle {
            display: flex;
            align-items: center;
            cursor: pointer;
            padding: 5px 15px;
            border-radius: 20px;
            background-color: var(--accent-color);
            color: white;
            font-weight: 500;
            transition: background-color 0.3s;
        }

        .mode-toggle:hover {
            background-color: #d35400;
        }

        .mode-toggle i {
            margin-right: 8px;
        }

        .cart-indicator, .collection-indicator {
            display: flex;
            align-items: center;
            cursor: pointer;
            padding: 5px 10px;
            border-radius: 20px;
            background-color: rgba(255, 255, 255, 0.2);
            transition: background-color 0.3s;
        }

        .cart-indicator:hover, .collection-indicator:hover {
            background-color: rgba(255, 255, 255, 0.3);
        }

        .cart-count, .collection-count {
            margin-left: 5px;
            background-color: white;
            color: var(--primary-color);
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            font-weight: bold;
        }

        .vendor-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: var(--accent-color);
            color: white;
            padding: 12px 20px;
            margin-bottom: 20px;
            border-radius: 8px;
            box-shadow: var(--card-shadow);
        }

        .collection-actions {
            display: flex;
            gap: 10px;
        }

        .vendor-btn {
            padding: 8px 15px;
            border-radius: 4px;
            border: none;
            background-color: white;
            color: var(--accent-color);
            cursor: pointer;
            display: flex;
            align-items: center;
            font-weight: 500;
            transition: all 0.2s;
        }

        .vendor-btn i {
            margin-right: 5px;
        }

        .vendor-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }

        .vendor-btn.save {
            background-color: #2ecc71;
            color: white;
        }

        .vendor-btn.pdf {
            background-color: #e74c3c;
            color: white;
        }

        .vendor-btn.manage {
            background-color: #3498db;
            color: white;
        }

        .collection-info {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .collection-name {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .collection-name input {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            border-radius: 4px;
            padding: 5px 10px;
            color: white;
            width: 200px;
        }

        .collection-name input::placeholder {
            color: rgba(255, 255, 255, 0.7);
        }

        .selection-count {
            background-color: white;
            color: var(--accent-color);
            padding: 2px 10px;
            border-radius: 50px;
            font-weight: bold;
            font-size: 0.9rem;
        }

        .filters { 
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 25px;
            padding: 15px;
            background-color: var(--bg-secondary);
            border-radius: 8px;
            box-shadow: var(--card-shadow);
            align-items: center;
        }

        .filters-main {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            flex: 1;
            min-width: 200px;
        }

        .search-container {
            position: relative;
            flex: 1;
            min-width: 200px;
        }

        #search {
            width: 100%;
            padding: 10px 15px 10px 40px;
            border: 1px solid var(--border-color);
            border-radius: 50px;
            font-size: 1rem;
            background-color: var(--bg-secondary);
            color: var(--text-color);
        }

        .search-icon {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-secondary);
        }

        .select-container {
            position: relative;
            min-width: 150px;
        }

        select {
            padding: 10px 15px;
            border: 1px solid var(--border-color);
            border-radius: 50px;
            background-color: var(--bg-secondary);
            color: var(--text-color);
            font-size: 1rem;
            width: 100%;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            cursor: pointer;
        }

        .select-icon {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-secondary);
            pointer-events: none;
        }

        .filters-advanced {
            display: none;
            flex-wrap: wrap;
            gap: 15px;
            width: 100%;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid var(--border-color);
        }

        .filters-toggle {
            display: flex;
            align-items: center;
            padding: 8px 15px;
            border-radius: 50px;
            background-color: var(--primary-color);
            color: white;
            cursor: pointer;
            font-size: 0.9rem;
        }

        .filters-toggle i {
            margin-left: 5px;
            transition: transform 0.3s;
        }

        .filters-toggle.active i {
            transform: rotate(180deg);
        }

        .category-section { 
            margin-bottom: 40px;
            background-color: var(--bg-secondary);
            border-radius: 8px;
            padding: 20px;
            box-shadow: var(--card-shadow);
        }

        .category-title { 
            font-size: 1.5em;
            margin-bottom: 20px;
            border-bottom: 2px solid var(--primary-color);
            padding-bottom: 10px;
            color: var(--secondary-color);
            text-transform: capitalize;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .category-selection {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .select-all-cat {
            padding: 3px 10px;
            border-radius: 50px;
            border: 1px solid var(--primary-color);
            background-color: var(--bg-secondary);
            color: var(--primary-color);
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .select-all-cat:hover {
            background-color: var(--primary-color);
            color: white;
        }

        .products { 
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            gap: 20px;
        }

        .product { 
            display: flex;
            flex-direction: column;
            background-color: var(--bg-secondary);
            border-radius: 8px;
            overflow: hidden;
            transition: transform 0.3s, box-shadow 0.3s;
            box-shadow: var(--card-shadow);
            border: 1px solid var(--border-color);
            position: relative;
        }

        .product:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .product.selected {
            border: 2px solid var(--accent-color);
        }

        .product-img-container {
            height: 180px;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: var(--bg-secondary);
            position: relative;
        }

        .product img { 
            max-width: 90%;
            max-height: 90%;
            object-fit: contain;
            transition: transform 0.3s;
        }

        .product-actions {
            display: flex;
            position: absolute;
            top: 10px;
            right: 10px;
            gap: 5px;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .product:hover .product-actions {
            opacity: 1;
        }

        .product-action-btn {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background-color: rgba(0, 0, 0, 0.6);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .product-action-btn:hover {
            background-color: var(--primary-color);
        }

        .product-select {
            position: absolute;
            top: 10px;
            left: 10px;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background-color: var(--bg-secondary);
            border: 2px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            color: transparent;
        }

        .product.selected .product-select {
            background-color: var(--accent-color);
            border-color: var(--accent-color);
            color: white;
        }

        .product-img-container:hover img {
            transform: scale(1.05);
        }

        .product-info {
            padding: 15px;
            display: flex;
            flex-direction: column;
            flex-grow: 1;
        }

        .product-sku {
            display: inline-block;
            padding: 3px 8px;
            background-color: rgba(52, 152, 219, 0.1);
            color: var(--primary-color);
            border-radius: 50px;
            font-size: 0.8rem;
            font-weight: 500;
            margin-bottom: 8px;
            align-self: flex-start;
        }

        .product-name {
            font-size: 0.95rem;
            margin-bottom: 5px;
            line-height: 1.3;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            flex-grow: 1;
        }

        .product-category {
            font-size: 0.8rem;
            color: var(--text-secondary);
            text-transform: capitalize;
        }

        .product-package {
            font-size: 0.8rem;
            color: var(--primary-color);
            margin-top: 5px;
        }

        .product-price-input {
            width: 100%;
            margin-top: 10px;
            padding: 5px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background-color: var(--bg-secondary);
            color: var(--text-color);
            font-size: 0.9rem;
        }

        .product-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 15px;
            border-top: 1px solid var(--border-color);
            padding-top: 10px;
        }

        .quantity-control {
            display: flex;
            align-items: center;
        }

        .qty-btn {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            border: 1px solid var(--border-color);
            background-color: var(--bg-secondary);
            color: var(--text-color);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .qty-btn:hover {
            background-color: var(--primary-color);
            color: white;
        }

        .qty-input {
            width: 40px;
            text-align: center;
            border: none;
            background: transparent;
            color: var(--text-color);
            font-weight: bold;
        }

        .add-to-cart {
            padding: 6px 12px;
            border-radius: 50px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            cursor: pointer;
            transition: background-color 0.3s;
            font-size: 0.85rem;
        }

        .add-to-cart:hover {
            background-color: var(--secondary-color);
        }

        .add-to-cart.in-cart {
            background-color: #27ae60;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: var(--modal-overlay);
            justify-content: center;
            align-items: center;
            opacity: 0;
            transition: opacity 0.3s;
            overflow-y: auto;
        }

        .modal.active {
            opacity: 1;
        }

        .modal-content {
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            max-width: 90%;
            max-height: 90%;
            background-color: var(--bg-secondary);
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 5px 25px rgba(0, 0, 0, 0.2);
            margin: 20px;
            width: 800px;
        }

        .modal-header {
            width: 100%;
            padding: 15px 20px;
            background-color: var(--primary-color);
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 1.2rem;
            font-weight: 600;
        }

        .modal-close {
            font-size: 24px;
            cursor: pointer;
        }

        .modal-body {
            width: 100%;
            padding: 20px;
            overflow-y: auto;
            max-height: 70vh;
        }

        .image-modal-content {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .image-modal-img {
            max-width: 100%;
            max-height: 60vh;
            object-fit: contain;
            margin-bottom: 20px;
        }

        .image-modal-info {
            width: 100%;
            text-align: center;
        }

        .collection-form {
            width: 100%;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }

        .form-group input, .form-group textarea, .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background-color: var(--bg-secondary);
            color: var(--text-color);
        }

        .form-group textarea {
            min-height: 100px;
            resize: vertical;
        }

        .collection-settings {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid var(--border-color);
        }

        .settings-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 15px;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }

        .checkbox-group label {
            margin-left: 10px;
            margin-bottom: 0;
        }

        .collections-list {
            list-style: none;
        }

        .collection-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid var(--border-color);
            transition: background-color 0.2s;
        }

        .collection-item:hover {
            background-color: var(--hover-color);
        }

        .collection-item-info {
            flex: 1;
        }

        .collection-item-name {
            font-weight: 600;
            font-size: 1.1rem;
        }

        .collection-item-meta {
            display: flex;
            gap: 20px;
            margin-top: 5px;
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .collection-item-actions {
            display: flex;
            gap: 10px;
        }

        .collection-action-btn {
            padding: 5px 10px;
            border-radius: 4px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9rem;
        }

        .collection-action-btn.edit {
            background-color: var(--primary-color);
        }

        .collection-action-btn.pdf {
            background-color: #e74c3c;
        }

        .collection-action-btn.delete {
            background-color: #7f8c8d;
        }

        .collection-action-btn i {
            margin-right: 5px;
        }

        .cart-modal-content {
            width: 100%;
        }

        .cart-items {
            margin-bottom: 20px;
        }

        .cart-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid var(--border-color);
        }

        .cart-item-info {
            flex: 1;
        }

        .cart-item-name {
            font-weight: 600;
        }

        .cart-item-sku {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .cart-item-qty {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .cart-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .cart-action-btn {
            padding: 10px 20px;
            border-radius: 4px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            cursor: pointer;
            transition: background-color 0.3s;
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 5px;
        }

        .cart-action-btn.whatsapp {
            background-color: #25D366;
        }

        .cart-action-btn.clear {
            background-color: #e74c3c;
        }

        .cart-action-btn:hover {
            opacity: 0.9;
        }

        .modal-action-btns {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }

        .modal-btn {
            padding: 10px 20px;
            border-radius: 4px;
            border: none;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .modal-btn.cancel {
            background-color: #95a5a6;
            color: white;
        }

        .modal-btn.save {
            background-color: var(--accent-color);
            color: white;
        }

        .empty-cart-message, .empty-collections {
            text-align: center;
            padding: 50px 20px;
            color: var(--text-secondary);
        }

        .empty-collections i {
            font-size: 3rem;
            margin-bottom: 15px;
            opacity: 0.5;
        }

        .price-input-group {
            position: relative;
            margin-top: 10px;
        }

        .price-input-group .currency-symbol {
            position: absolute;
            left: 10px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-secondary);
        }

        .price-input-group input {
            padding-left: 25px;
        }

        .pdf-settings {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .preview-section {
            margin-top: 30px;
            border-top: 1px solid var(--border-color);
            padding-top: 20px;
        }

        .preview-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 15px;
        }

        .pdf-preview {
            width: 100%;
            max-width: 600px;
            margin: 0 auto;
            background-color: white;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            padding: 20px;
            border-radius: 4px;
        }

        .pdf-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #eee;
        }

        .pdf-logo {
            width: 150px;
            height: 50px;
            background-color: #eee;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        .pdf-title {
            font-size: 1.2rem;
            font-weight: bold;
        }

        .pdf-products {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .pdf-product {
            display: flex;
            background-color: #f9f9f9;
            border-radius: 4px;
            overflow: hidden;
        }

        .pdf-product-img {
            width: 80px;
            height: 80px;
            background-color: #eee;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .pdf-product-info {
            flex: 1;
            padding: 10px;
        }

        .pdf-product-sku {
            font-size: 0.8rem;
            color: #666;
        }

        .pdf-product-name {
            font-weight: 600;
            margin: 5px 0;
        }

        .pdf-price-field {
            margin-top: 5px;
            display: flex;
            align-items: center;
        }

        .pdf-price-label {
            width: 50px;
            font-size: 0.8rem;
        }

        .pdf-price-blank {
            flex: 1;
            height: 1px;
            background-color: #000;
            margin-left: 5px;
        }

        .pdf-price-value {
            font-weight: bold;
            color: var(--accent-color);
        }

        .pdf-footer {
            margin-top: 20px;
            padding-top: 10px;
            border-top: 1px solid #eee;
            font-size: 0.8rem;
            text-align: center;
            color: #999;
        }

        .loading-spinner {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: var(--primary-color);
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .no-products {
            text-align: center;
            padding: 50px;
            background-color: var(--bg-secondary);
            border-radius: 8px;
            box-shadow: var(--card-shadow);
            font-size: 1.2rem;
            color: var(--text-secondary);
        }

        footer {
            background-color: var(--primary-color);
            color: white;
            text-align: center;
            padding: 20px 0;
            margin-top: 50px;
        }

        .back-to-top {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background-color: var(--primary-color);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
            z-index: 100;
        }

        .back-to-top.visible {
            opacity: 1;
            visibility: visible;
        }

        .back-to-top:hover {
            background-color: var(--secondary-color);
        }

        .notifications {
            position: fixed;
            bottom: 20px;
            left: 20px;
            z-index: 1000;
        }

        .notification {
            padding: 15px 20px;
            color: white;
            border-radius: 4px;
            margin-bottom: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            transform: translateY(100px);
            opacity: 0;
            transition: transform 0.3s, opacity 0.3s;
        }

        .notification.success {
            background-color: var(--success-color);
        }

        .notification.error {
            background-color: var(--error-color);
        }

        .notification.show {
            transform: translateY(0);
            opacity: 1;
        }

        .notification i {
            margin-right: 10px;
        }

        /* Progress Bar para PDF */
        .progress-container {
            width: 100%;
            margin-top: 15px;
            margin-bottom: 15px;
            display: none;
        }

        .progress-bar {
            width: 100%;
            height: 10px;
            background-color: #f0f0f0;
            border-radius: 5px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background-color: var(--accent-color);
            width: 0%;
            transition: width 0.3s ease;
        }

        .progress-text {
            text-align: center;
            margin-top: 5px;
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        /* Responsividade */
        @media (max-width: 768px) {
            .vendor-controls {
                flex-direction: column;
                gap: 15px;
            }
            
            .collection-info {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
            
            .collection-actions {
                width: 100%;
                justify-content: space-between;
            }
            
            .filters, .filters-main {
                flex-direction: column;
                align-items: stretch;
            }
            
            .products {
                grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            }
            
            .product-img-container {
                height: 150px;
            }

            .product-actions {
                opacity: 1;
                position: absolute;
                top: 5px;
                right: 5px;
            }
            
            .pdf-products {
                grid-template-columns: 1fr;
            }
            
            .cart-item {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .cart-item-qty {
                margin-top: 10px;
            }
        }

        @media (max-width: 576px) {
            .header-controls {
                flex-direction: column;
                gap: 10px;
            }
            
            .products {
                grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
            }
            
            .product-img-container {
                height: 130px;
            }
            
            .collection-item {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .collection-item-actions {
                margin-top: 10px;
                width: 100%;
                justify-content: flex-end;
            }
            
            .cart-actions {
                flex-direction: column;
            }
            
            .pdf-settings {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <h1>Catálogo de Produtos</h1>
            <div class="header-controls">
                <div class="theme-toggle" onclick="toggleTheme()">
                    <i class="fas fa-moon"></i>
                    <span>Modo Escuro</span>
                </div>
                <div class="mode-toggle" onclick="toggleMode()">
                    <i class="fas fa-shopping-cart"></i>
                    <span>Modo Cliente</span>
                </div>
                <div class="cart-indicator" onclick="openCartModal()">
                    <i class="fas fa-shopping-cart"></i>
                    <span>Carrinho</span>
                    <div class="cart-count">0</div>
                </div>
                <div class="collection-indicator" onclick="openManageCollectionsModal()">
                    <i class="fas fa-folder"></i>
                    <span>Coleções</span>
                    <div class="collection-count">0</div>
                </div>
            </div>
        </div>
    </header>

    <div class="container">
        <!-- Controles do Vendedor - Visível apenas no modo vendedor -->
        <div class="vendor-controls" style="display: none;">
            <div class="collection-info">
                <div class="collection-name">
                    <i class="fas fa-tags"></i>
                    <input type="text" placeholder="Nome da Coleção" id="collection-name">
                </div>
                <div class="selection-count">0 produtos selecionados</div>
            </div>
            <div class="collection-actions">
                <button class="vendor-btn save" onclick="openSaveCollectionModal()">
                    <i class="fas fa-save"></i> Salvar Coleção
                </button>
                <button class="vendor-btn pdf" onclick="openPdfModal()">
                    <i class="fas fa-file-pdf"></i> Gerar PDF
                </button>
                <button class="vendor-btn manage" onclick="openManageCollectionsModal()">
                    <i class="fas fa-folder-open"></i> Gerenciar Coleções
                </button>
            </div>
        </div>

        <div class="filters">
            <div class="filters-main">
                <div class="search-container">
                    <i class="fas fa-search search-icon"></i>
                    <input type="text" id="search" placeholder="Buscar por nome ou SKU">
                </div>
                <div class="select-container">
                    <select id="category">
                        <option value="">Todas as Categorias</option>
                    </select>
                    <i class="fas fa-chevron-down select-icon"></i>
                </div>
                <div class="select-container">
                    <select id="sort">
                        <option value="">Ordenação Padrão</option>
                        <option value="asc">Nome: A-Z</option>
                        <option value="desc">Nome: Z-A</option>
                    </select>
                    <i class="fas fa-chevron-down select-icon"></i>
                </div>
                <div class="filters-toggle" onclick="toggleAdvancedFilters()">
                    Filtros Avançados <i class="fas fa-chevron-down"></i>
                </div>
            </div>
            <div class="filters-advanced" id="advanced-filters">
                <div class="select-container">
                    <select id="package-size">
                        <option value="">Todos os Tamanhos</option>
                        <option value="500g">500g</option>
                        <option value="1kg">1kg</option>
                        <option value="4kg">4kg</option>
                        <option value="10kg">10kg</option>
                        <option value="12kg">12kg</option>
                        <option value="20kg">20kg</option>
                        <option value="25kg">25kg</option>
                    </select>
                    <i class="fas fa-chevron-down select-icon"></i>
                </div>
            </div>
        </div>
        
        <div class="loading-spinner" id="initial-loader">
            <div class="spinner"></div>
        </div>
        
        <div id="product-list"></div>
    </div>

    <!-- Modal para Imagem Ampliada -->
    <div id="imageModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Visualização do Produto</div>
                <div class="modal-close" onclick="closeModal('imageModal')">&times;</div>
            </div>
            <div class="modal-body">
                <div class="image-modal-content">
                    <img class="image-modal-img" id="modalImg" src="" alt="Imagem Ampliada">
                    <div class="image-modal-info" id="modalProductInfo"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para Carrinho -->
    <div id="cartModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Carrinho de Produtos</div>
                <div class="modal-close" onclick="closeModal('cartModal')">&times;</div>
            </div>
            <div class="modal-body">
                <div class="cart-modal-content">
                    <div class="cart-items" id="cart-items">
                        <!-- Itens do carrinho serão adicionados aqui -->
                    </div>
                    <div class="cart-actions">
                        <button class="cart-action-btn whatsapp" onclick="sendToWhatsApp()">
                            <i class="fab fa-whatsapp"></i> Enviar para WhatsApp
                        </button>
                        <button class="cart-action-btn clear" onclick="clearCart()">
                            <i class="fas fa-trash"></i> Limpar Carrinho
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para Salvar Coleção -->
    <div id="saveCollectionModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Salvar Coleção</div>
                <div class="modal-close" onclick="closeModal('saveCollectionModal')">&times;</div>
            </div>
            <div class="modal-body">
                <div class="collection-form">
                    <div class="form-group">
                        <label for="save-collection-name">Nome da Coleção</label>
                        <input type="text" id="save-collection-name" placeholder="Ex: Produtos para Padaria XYZ">
                    </div>
                    <div class="form-group">
                        <label for="collection-description">Descrição (opcional)</label>
                        <textarea id="collection-description" placeholder="Adicione uma descrição para esta coleção..."></textarea>
                    </div>
                    <div class="collection-settings">
                        <h3 class="settings-title">Configurações da Coleção</h3>
                        <div class="checkbox-group">
                            <input type="checkbox" id="save-as-default" checked>
                            <label for="save-as-default">Manter estes produtos selecionados após salvar</label>
                        </div>
                        <div class="checkbox-group">
                            <input type="checkbox" id="include-prices" checked>
                            <label for="include-prices">Salvar preços dos produtos</label>
                        </div>
                    </div>
                    <div class="modal-action-btns">
                        <button class="modal-btn cancel" onclick="closeModal('saveCollectionModal')">Cancelar</button>
                        <button class="modal-btn save" onclick="saveCollection()">Salvar Coleção</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para Gerenciar Coleções -->
    <div id="manageCollectionsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Gerenciar Coleções</div>
                <div class="modal-close" onclick="closeModal('manageCollectionsModal')">&times;</div>
            </div>
            <div class="modal-body">
                <div id="collections-container">
                    <!-- O conteúdo das coleções será carregado aqui -->
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para gerar PDF -->
    <div id="pdfModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Gerar PDF da Coleção</div>
                <div class="modal-close" onclick="closeModal('pdfModal')">&times;</div>
            </div>
            <div class="modal-body">
                <div class="collection-form">
                    <div class="form-group">
                        <label for="pdf-collection-name">Título do PDF</label>
                        <input type="text" id="pdf-collection-name" placeholder="Ex: Catálogo para Cliente XYZ">
                    </div>
                    
                    <div class="pdf-settings">
                        <div class="form-group">
                            <label>Elementos a incluir:</label>
                            <div class="checkbox-group">
                                <input type="checkbox" id="include-sku" checked>
                                <label for="include-sku">Código do Produto (SKU)</label>
                            </div>
                            <div class="checkbox-group">
                                <input type="checkbox" id="include-category" checked>
                                <label for="include-category">Categoria</label>
                            </div>
                            <div class="checkbox-group">
                                <input type="checkbox" id="include-price" checked>
                                <label for="include-price">Preços definidos</label>
                            </div>
                            <div class="checkbox-group">
                                <input type="checkbox" id="include-price-field" checked>
                                <label for="include-price-field">Campo para preço manual</label>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label>Layout do PDF:</label>
                            <div class="checkbox-group">
                                <input type="checkbox" id="group-by-category" checked>
                                <label for="group-by-category">Agrupar por categoria</label>
                            </div>
                            <div class="checkbox-group">
                                <input type="checkbox" id="include-logo" checked>
                                <label for="include-logo">Incluir logo da empresa</label>
                            </div>
                            <div class="checkbox-group">
                                <input type="checkbox" id="include-images" checked>
                                <label for="include-images">Incluir imagens dos produtos</label>
                            </div>
                            <div class="checkbox-group">
                                <input type="checkbox" id="include-footer" checked>
                                <label for="include-footer">Incluir rodapé com informações de contato</label>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Barra de Progresso para PDF -->
                    <div class="progress-container" id="pdf-progress-container">
                        <div class="progress-bar">
                            <div class="progress-fill" id="pdf-progress-fill"></div>
                        </div>
                        <div class="progress-text" id="pdf-progress-text">Carregando imagens: 0%</div>
                    </div>
                    
                    <div class="preview-section">
                        <h3 class="preview-title">Pré-visualização</h3>
                        <div class="pdf-preview">
                            <div class="pdf-header">
                                <div class="pdf-logo">AMERIPAN</div>
                                <div class="pdf-title">Catálogo de Produtos</div>
                            </div>
                            <div class="pdf-products">
                                <div class="pdf-product">
                                    <div class="pdf-product-img">IMG</div>
                                    <div class="pdf-product-info">
                                        <div class="pdf-product-sku">SKU: ABC123</div>
                                        <div class="pdf-product-name">Chocolate Premium 1kg</div>
                                        <div class="pdf-price-field">
                                            <div class="pdf-price-label">Preço:</div>
                                            <div class="pdf-price-value">R$ 25,90</div>
                                        </div>
                                    </div>
                                </div>
                                <div class="pdf-product">
                                    <div class="pdf-product-img">IMG</div>
                                    <div class="pdf-product-info">
                                        <div class="pdf-product-sku">SKU: DEF456</div>
                                        <div class="pdf-product-name">Granulado Colorido 500g</div>
                                        <div class="pdf-price-field">
                                            <div class="pdf-price-label">Preço:</div>
                                            <div class="pdf-price-blank"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="pdf-footer">
                                www.ameripan.com.br | atendimento@ameripan.com.br | (19) 3406-4070
                            </div>
                        </div>
                    </div>
                    
                    <div class="modal-action-btns">
                        <button class="modal-btn cancel" onclick="closeModal('pdfModal')">Cancelar</button>
                        <button class="modal-btn save" id="generate-pdf-btn" onclick="generatePDF()">Gerar PDF</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="back-to-top" id="backToTop" onclick="scrollToTop()">
        <i class="fas fa-arrow-up"></i>
    </div>

    <div class="notifications" id="notifications">
        <!-- Notificações serão adicionadas aqui -->
    </div>

    <footer>
        <div class="container">
            <p>&copy; 2025 Catálogo de Produtos Ameripan</p>
        </div>
    </footer>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <script>
  // Variáveis globais
let productData = [];
let allProducts = [];
let visibleProducts = 20;
const incrementAmount = 15;
let isLoading = false;
let cart = JSON.parse(localStorage.getItem('cart')) || [];

// Coleções
let collections = JSON.parse(localStorage.getItem('collections')) || [];
let selectedProducts = JSON.parse(localStorage.getItem('selectedProducts')) || [];

// Configuração do modo vendedor/cliente
let inVendorMode = localStorage.getItem('vendorMode') === 'true' || false;

// Cache de imagens global para persistência entre sessões
let globalImageCache = new Map();

// Estado atual de processamento do PDF
let pdfGenerationState = {
    inProgress: false,
    processedItems: 0,
    totalItems: 0,
    sessionId: null,
    imageCache: null,
    retryCount: {}
};

// Nova variável para controle do filtro de coleção
let activeCollectionFilter = null;

// Mostrar loader inicial
document.getElementById('initial-loader').style.display = 'flex';

// Inicializar a página
document.addEventListener('DOMContentLoaded', () => {
    fetchCSV();
    updateCartCount();
    setupTheme();
    updateCollectionCount();
    updateSelectionCount();
    
    // Aplicar modo salvo (cliente ou vendedor)
    applyCurrentMode();
    
    // Tentar recuperar cache de imagens de uma sessão anterior
    const savedImageCache = localStorage.getItem('imageCache');
    if (savedImageCache) {
        try {
            const cacheData = JSON.parse(savedImageCache);
            // Reconstruir o Map a partir dos dados JSON
            globalImageCache = new Map(Object.entries(cacheData));
            console.log(`Cache de imagens recuperado com ${globalImageCache.size} itens`);
        } catch (e) {
            console.warn("Não foi possível recuperar o cache de imagens:", e);
            globalImageCache = new Map();
        }
    }
    
    // Adicionar estilos CSS necessários para o novo botão
    const styleElement = document.createElement('style');
    styleElement.textContent = `
        .collection-action-btn.view {
            background-color: #2ecc71;
        }
    `;
    document.head.appendChild(styleElement);
});

// Aplicar o modo atual (cliente ou vendedor)
function applyCurrentMode() {
    if (inVendorMode) {
        document.querySelector('.mode-toggle').innerHTML = '<i class="fas fa-shopping-cart"></i><span>Modo Cliente</span>';
        document.querySelector('.vendor-controls').style.display = 'flex';
    } else {
        document.querySelector('.mode-toggle').innerHTML = '<i class="fas fa-user"></i><span>Modo Vendedor</span>';
        document.querySelector('.vendor-controls').style.display = 'none';
    }
}

// Configurar tema (claro/escuro)
function setupTheme() {
    const savedTheme = localStorage.getItem('theme') || 'light';
    document.documentElement.setAttribute('data-theme', savedTheme);
    updateThemeToggle(savedTheme);
}

function toggleTheme() {
    const currentTheme = document.documentElement.getAttribute('data-theme');
    const newTheme = currentTheme === 'light' ? 'dark' : 'light';
    
    document.documentElement.setAttribute('data-theme', newTheme);
    localStorage.setItem('theme', newTheme);
    updateThemeToggle(newTheme);
}

function updateThemeToggle(theme) {
    const themeToggle = document.querySelector('.theme-toggle');
    
    if (theme === 'dark') {
        themeToggle.innerHTML = '<i class="fas fa-sun"></i><span>Modo Claro</span>';
    } else {
        themeToggle.innerHTML = '<i class="fas fa-moon"></i><span>Modo Escuro</span>';
    }
}

// Alternar entre modo cliente e vendedor
function toggleMode() {
    inVendorMode = !inVendorMode;
    
    // Salvar a configuração
    localStorage.setItem('vendorMode', inVendorMode);
    
    // Aplicar o modo selecionado
    applyCurrentMode();
    
    // Reexibir produtos para atualizar a interface
    displayProducts();
}

// Controle de filtros avançados
function toggleAdvancedFilters() {
    const filtersAdvanced = document.getElementById('advanced-filters');
    const toggleButton = document.querySelector('.filters-toggle');
    
    if (filtersAdvanced.style.display === 'flex') {
        filtersAdvanced.style.display = 'none';
        toggleButton.classList.remove('active');
    } else {
        filtersAdvanced.style.display = 'flex';
        toggleButton.classList.add('active');
    }
}

// Buscar dados do CSV
async function fetchCSV() {
    try {
        // Primeiro tentar com a URL completa
        const csvUrl = "https://edimarpcosta.github.io/ameripan/catalogo/produtos.csv";
        console.log("Tentando buscar CSV de:", csvUrl);
        
        const response = await fetch(csvUrl);
        
        if (!response.ok) {
            throw new Error(`Erro ao buscar CSV: ${response.status} ${response.statusText}`);
        }
        
        const csv = await response.text();
        parseCSV(csv);
    } catch (error) {
        console.error("Erro ao carregar o CSV remoto:", error);
        
        // Tentar carregar dados de exemplo se o arquivo remoto falhar
        try {
            console.log("Tentando carregar dados de exemplo");
            const exampleData = generateExampleData();
            parseExampleData(exampleData);
        } catch (fallbackError) {
            console.error("Erro ao gerar dados de exemplo:", fallbackError);
            document.getElementById('initial-loader').style.display = 'none';
            document.getElementById('product-list').innerHTML = `
                <div class="no-products">
                    <p>Erro ao carregar os produtos: ${error.message}</p>
                    <p>Verifique se o arquivo CSV está disponível ou carregue um arquivo manualmente.</p>
                    <input type="file" id="csv-file-input" accept=".csv" style="margin-top: 20px;" 
                           onchange="handleFileUpload(event)" />
                </div>
            `;
        }
    }
}

// Função para tratar upload de CSV
function handleFileUpload(event) {
    const file = event.target.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const csv = e.target.result;
                parseCSV(csv);
                showNotification('Arquivo CSV carregado com sucesso!', 'success');
            } catch (error) {
                console.error("Erro ao processar arquivo:", error);
                showNotification('Erro ao processar o arquivo CSV.', 'error');
            }
        };
        reader.onerror = function() {
            showNotification('Erro ao ler o arquivo.', 'error');
        };
        reader.readAsText(file);
    }
}

// Gerar dados de exemplo para quando o CSV não pode ser carregado
function generateExampleData() {
    const categories = ['confeitaria', 'chocolate', 'padaria', 'ingredientes', 'embalagens', 'acaiteria'];
    const products = [];
    
    // Gerar 30 produtos de exemplo
    for (let i = 1; i <= 30; i++) {
        const category = categories[Math.floor(Math.random() * categories.length)];
        const isChocolate = category === 'chocolate' || category === 'acaiteria';
        
        let name = '';
        let packageSize = '';
        
        if (isChocolate) {
            const types = ['Ao Leite', 'Meio Amargo', 'Branco', 'Premium', 'Granulado', 'Gotas'];
            const brands = ['Melken Harald', 'Mavalério', 'Genuine Cargill', 'Sicao', 'Top Blend Harald'];
            const type = types[Math.floor(Math.random() * types.length)];
            const brand = brands[Math.floor(Math.random() * brands.length)];
            const sizes = ['500g', '1kg', '4kg', '10kg'];
            const sizeIndex = Math.floor(Math.random() * sizes.length);
            packageSize = sizes[sizeIndex];
            
            // Padrão diferente para produtos de acaiteria
            if (category === 'acaiteria') {
                if (type === 'Gotas') {
                    name = `${type === 'Gotas' ? 'Chocolate' : 'Cobertura'} ${type} ${brand} ${Math.floor(Math.random() * 3) + 1}`;
                } else {
                    name = `${['Chocolate', 'Cobertura'][Math.floor(Math.random() * 2)]} ${type} ${brand} ${Math.floor(Math.random() * 3) + 1}`;
                }
            } else {
                name = `Chocolate ${type} ${packageSize}`;
            }
        } else if (category === 'confeitaria') {
            const items = ['Confeito', 'Pasta Americana', 'Corante', 'Essência', 'Glacê', 'Forminha'];
            const colors = ['Colorido', 'Rosa', 'Azul', 'Verde', 'Amarelo', 'Vermelho'];
            const item = items[Math.floor(Math.random() * items.length)];
            const color = Math.random() > 0.5 ? colors[Math.floor(Math.random() * colors.length)] : '';
            packageSize = Math.random() > 0.5 ? ['500g', '1kg'][Math.floor(Math.random() * 2)] : '';
            name = `${item} ${color} ${packageSize}`.trim();
        } else {
            const prefixes = ['Super', 'Premium', 'Master', 'Profissional', 'Especial'];
            const items = ['Farinha', 'Fermento', 'Açúcar', 'Caixa', 'Saco', 'Mistura', 'Aroma'];
            const prefix = Math.random() > 0.7 ? prefixes[Math.floor(Math.random() * prefixes.length)] : '';
            const item = items[Math.floor(Math.random() * items.length)];
            packageSize = Math.random() > 0.5 ? ['1kg', '5kg', '25kg'][Math.floor(Math.random() * 3)] : '';
            name = `${prefix} ${item} ${packageSize}`.trim();
        }
        
        // Criar código SKU único
        const sku = `${i.toString().padStart(4, '0')}`;
        
        // URL de imagem placeholder
        const img = `https://via.placeholder.com/300x300?text=${encodeURIComponent(name)}`;
        
        products.push({
            rowid: i.toString(),
            categoria: category,
            sku: sku,
            marca: name,
            img: img,
            packageSize: packageSize
        });
    }
    
    return products;
}

// Processar dados de exemplo
function parseExampleData(exampleData) {
    allProducts = exampleData;
    
    // Ordenar produtos por categoria e nome
    allProducts.sort((a, b) => {
        if (a.categoria !== b.categoria) {
            return a.categoria.localeCompare(b.categoria);
        }
        return a.marca.localeCompare(b.marca);
    });
    
    // Ocultar loader inicial
    document.getElementById('initial-loader').style.display = 'none';
    
    // Popular categorias e exibir produtos
    populateCategories();
    displayProducts();
    
    // Configurar observador para scroll infinito
    setupInfiniteScroll();
    
    // Mostrar notificação
    showNotification('Usando dados de exemplo. Você pode carregar um CSV manualmente.', 'success');
}

// Análise do CSV
function parseCSV(csv) {
    let lines = csv.split('\n');
    
    // Pular o cabeçalho
    if (lines.length > 0) {
        lines = lines.slice(1);
    }
    
    // Array temporário para detectar duplicatas
    const tempProducts = [];
    const processedSkus = new Set();
    
    lines.forEach(line => {
        // Separar corretamente os campos
        let fields = line.split(';');
        if (fields.length < 5) return;
        
        let [rowid, categoria, sku, marca, preco, img] = fields;
        
        // Limpar espaços em branco
        sku = sku ? sku.trim() : "";
        marca = marca ? marca.trim() : "";
        img = img ? img.trim() : "";
        categoria = categoria ? categoria.trim() : "";
        
        // Extrair informação de tamanho da embalagem (se existir)
        let packageSize = extractPackageSize(marca);
        
        // Verificar se já processamos este SKU
        if (sku && !processedSkus.has(sku)) {
            processedSkus.add(sku);
            tempProducts.push({ 
                rowid, 
                categoria, 
                sku, 
                marca, 
                img, 
                packageSize,
                price: '' // Campo para preço no modo vendedor
            });
        }
    });
    
    allProducts = tempProducts;
    
    // Ordenar produtos por categoria e nome
    allProducts.sort((a, b) => {
        if (a.categoria !== b.categoria) {
            return a.categoria.localeCompare(b.categoria);
        }
        return a.marca.localeCompare(b.marca);
    });
    
    // Ocultar loader inicial
    document.getElementById('initial-loader').style.display = 'none';
    
    // Popular categorias e exibir produtos
    populateCategories();
    displayProducts();
    
    // Configurar observador para scroll infinito
    setupInfiniteScroll();
}

// Extrai informação de tamanho da embalagem
function extractPackageSize(name) {
    const patterns = [
        /\b500g\b/i,
        /\b1\s*kg\b/i,
        /\b4\s*kg\b/i,
        /\b10\s*kg\b/i,
        /\b12\s*kg\b/i,
        /\b20\s*kg\b/i,
        /\b25\s*kg\b/i
    ];
    
    const sizes = ['500g', '1kg', '4kg', '10kg', '12kg', '20kg', '25kg'];
    
    for (let i = 0; i < patterns.length; i++) {
        if (patterns[i].test(name)) {
            return sizes[i];
        }
    }
    
    return null;
}

// Exibir produtos com filtros aplicados
function displayProducts(filter = "", category = "", sort = "", packageSize = "") {
    // Obter valores dos filtros dos campos de entrada se não forem fornecidos
    filter = filter || document.getElementById("search").value || "";
    category = category || document.getElementById("category").value || "";
    sort = sort || document.getElementById("sort").value || "";
    packageSize = packageSize || document.getElementById("package-size")?.value || "";
    
    // Filtrar produtos de acordo com critérios
    productData = allProducts.filter(p => {
        // Filtro por texto (nome ou SKU)
        const textMatch = !filter || 
            p.marca.toLowerCase().includes(filter.toLowerCase()) || 
            p.sku.toLowerCase().includes(filter.toLowerCase());
        
        // Filtro por categoria
        const categoryMatch = !category || p.categoria === category;
        
        // Filtro por tamanho da embalagem
        const packageMatch = !packageSize || 
            (p.packageSize && p.packageSize.toLowerCase() === packageSize.toLowerCase());
        
        // Filtro de coleção ativa
        const collectionMatch = !activeCollectionFilter || 
            activeCollectionFilter.skus.includes(p.sku);
        
        return textMatch && categoryMatch && packageMatch && collectionMatch;
    });
    
    // Aplicar ordenação
    if (sort) {
        productData.sort((a, b) => {
            if (sort === 'asc') {
                return a.marca.localeCompare(b.marca);
            } else if (sort === 'desc') {
                return b.marca.localeCompare(a.marca);
            }
            return 0;
        });
    } else {
        // Ordenação padrão: por categoria depois por nome
        productData.sort((a, b) => {
            if (a.categoria !== b.categoria) {
                return a.categoria.localeCompare(b.categoria);
            }
            return a.marca.localeCompare(b.marca);
        });
    }
    
    let productList = document.getElementById("product-list");
    productList.innerHTML = "";
    
    if (productData.length === 0) {
        productList.innerHTML = '<div class="no-products">Nenhum produto encontrado com os critérios de busca.</div>';
        return;
    }
    
    // Limitar ao número de produtos visíveis
    const visibleData = productData.slice(0, visibleProducts);
    
    // Agrupar por categoria
    let categories = [...new Set(visibleData.map(p => p.categoria))].sort();
    
    categories.forEach(cat => {
        let categorySection = document.createElement("div");
        categorySection.classList.add("category-section");
        
        // Adicionar título da categoria e botão para selecionar todos
        let categorySelectorHtml = '';
        if (inVendorMode) {
            categorySelectorHtml = `
                <div class="category-selection">
                    <button class="select-all-cat" onclick="toggleCategorySelection('${cat}')">Selecionar Todos</button>
                </div>
            `;
        }
        
        categorySection.innerHTML = `
            <h2 class="category-title">
                ${cat}
                ${categorySelectorHtml}
            </h2>
        `;
        
        let productContainer = document.createElement("div");
        productContainer.classList.add("products");
        
        visibleData
            .filter(p => p.categoria === cat)
            .forEach(p => {
                // Verificar se o produto está selecionado
                const isSelected = selectedProducts.some(item => item.sku === p.sku);
                
                // Verificar se o produto está no carrinho
                const inCart = cart.some(item => item.sku === p.sku);
                const cartItem = cart.find(item => item.sku === p.sku);
                const quantity = cartItem ? cartItem.quantity : 0;
                
                // Obter preço do produto (no modo vendedor)
                const selectedProduct = selectedProducts.find(item => item.sku === p.sku);
                const productPrice = selectedProduct ? selectedProduct.price || '' : '';
                
                let productDiv = document.createElement("div");
                productDiv.classList.add("product");
                if (isSelected) {
                    productDiv.classList.add("selected");
                }
                productDiv.setAttribute('data-rowid', p.rowid);
                productDiv.setAttribute('data-sku', p.sku);
                
                const imgHighRes = p.img ? p.img.replace('300x300', '2500x2500') : '';
                
                // Botão de seleção para modo vendedor
                let selectionButton = '';
                if (inVendorMode) {
                    selectionButton = `
                        <div class="product-select" onclick="toggleProductSelection('${p.sku}', '${p.marca.replace(/'/g, "\\'")}', '${p.categoria}', '${p.img}')">
                            ${isSelected ? '<i class="fas fa-check"></i>' : ''}
                        </div>
                    `;
                }
                
                // Conteúdo da imagem e informações básicas do produto
                let productContent = `
                    <div class="product-img-container">
                        <img src="${p.img}" alt="${p.marca}" 
                             onclick="openImageModal('${imgHighRes}', '${p.sku}', '${p.marca.replace(/'/g, "\\'")}')"
                             onerror="handleImageError(this, '${p.sku}')">
                        ${selectionButton}
                        <div class="product-actions">
                            <div class="product-action-btn" onclick="openImageModal('${imgHighRes}', '${p.sku}', '${p.marca.replace(/'/g, "\\'")}')">
                                <i class="fas fa-search-plus"></i>
                            </div>
                        </div>
                    </div>
                    <div class="product-info">
                        <span class="product-sku">${p.sku}</span>
                        <h3 class="product-name">${p.marca}</h3>
                        <span class="product-category">${p.categoria}</span>
                        ${p.packageSize ? `<span class="product-package">${p.packageSize}</span>` : ''}
                `;
                
                // Adicionar campo de preço no modo vendedor para produtos selecionados
                if (inVendorMode && isSelected) {
                    productContent += `
                        <div class="price-input-group">
                            <span class="currency-symbol">R$</span>
                            <input type="text" class="product-price-input" 
                                   placeholder="Insira o preço" 
                                   value="${productPrice}"
                                   onchange="updateProductPrice('${p.sku}', this.value)">
                        </div>
                    `;
                }
                
                // Controles de carrinho (apenas no modo cliente ou para ambos os modos)
                if (!inVendorMode || (inVendorMode && true)) { // Permitir carrinho no modo vendedor também
                    productContent += `
                        <div class="product-controls">
                            <div class="quantity-control">
                                <button class="qty-btn" onclick="decrementQuantity('${p.sku}')">-</button>
                                <input type="number" class="qty-input" id="qty-${p.sku}" value="${quantity}" min="0" max="999" readonly>
                                <button class="qty-btn" onclick="incrementQuantity('${p.sku}')">+</button>
                            </div>
                            <button class="add-to-cart ${inCart ? 'in-cart' : ''}" 
                                    id="cart-btn-${p.sku}" 
                                    onclick="toggleCart('${p.sku}', '${p.marca.replace(/'/g, "\\'")}', '${p.categoria}')">
                                ${inCart ? '<i class="fas fa-check"></i>' : '<i class="fas fa-cart-plus"></i>'}
                            </button>
                        </div>
                    `;
                }
                
                productContent += `</div>`; // Fechando product-info
                
                productDiv.innerHTML = productContent;
                productContainer.appendChild(productDiv);
            });
        
        categorySection.appendChild(productContainer);
        productList.appendChild(categorySection);
    });
    
    // Verificar se precisamos mostrar o loader para carregamento infinito
    addInfiniteScrollLoader();
}

// Popular seletor de categorias
function populateCategories() {
    let categories = [...new Set(allProducts.map(p => p.categoria))].sort();
    let categorySelect = document.getElementById("category");
    categorySelect.innerHTML = '<option value="">Todas as Categorias</option>';
    
    categories.forEach(cat => {
        let option = document.createElement("option");
        option.value = cat;
        option.textContent = cat.charAt(0).toUpperCase() + cat.slice(1);
        categorySelect.appendChild(option);
    });
}

// Lidar com erros de carregamento de imagem
function handleImageError(img, sku) {
    // Usar uma imagem de placeholder
    img.src = "https://via.placeholder.com/300x300?text=Produto+Indisponível";
    
    // Registrar erro para depuração
    console.warn(`Erro ao carregar imagem para SKU ${sku}`);
}

// Abrir modal de imagem
function openImageModal(imgSrc, sku, name) {
    // Se a imagem estiver vazia, usar placeholder
    if (!imgSrc || imgSrc === '') {
        document.getElementById("modalImg").src = "https://via.placeholder.com/500x500?text=Imagem+Indisponível";
    } else {
        document.getElementById("modalImg").src = imgSrc;
    }
    
    document.getElementById("modalProductInfo").innerHTML = `
        <strong>${sku}</strong><br>
        ${name}
    `;
    
    openModal('imageModal');
}

// Funções para controle de carrinho
function incrementQuantity(sku) {
    const inputElement = document.getElementById(`qty-${sku}`);
    let value = parseInt(inputElement.value || 0);
    inputElement.value = value + 1;
    
    // Se o produto já estiver no carrinho, atualizar a quantidade
    updateCartItemQuantity(sku, value + 1);
}

function decrementQuantity(sku) {
    const inputElement = document.getElementById(`qty-${sku}`);
    let value = parseInt(inputElement.value || 0);
    if (value > 0) {
        inputElement.value = value - 1;
        
        // Atualizar quantidade no carrinho
        updateCartItemQuantity(sku, value - 1);
        
        // Se a quantidade for zero, remover do carrinho
        if (value - 1 === 0) {
            removeFromCart(sku);
        }
    }
}

function toggleCart(sku, name, category) {
    const inCart = cart.some(item => item.sku === sku);
    
    if (inCart) {
        removeFromCart(sku);
    } else {
        // Obter a quantidade atual
        const quantityInput = document.getElementById(`qty-${sku}`);
        const quantity = parseInt(quantityInput.value || 1);
        
        // Se a quantidade for zero, definir como 1
        if (quantity === 0) {
            quantityInput.value = 1;
            addToCart(sku, name, category, 1);
        } else {
            addToCart(sku, name, category, quantity);
        }
    }
}

function addToCart(sku, name, category, quantity = 1) {
    // Verificar se o produto já está no carrinho
    const existingItemIndex = cart.findIndex(item => item.sku === sku);
    
    if (existingItemIndex >= 0) {
        // Atualizar a quantidade se já existir
        cart[existingItemIndex].quantity = quantity;
    } else {
        // Adicionar novo item ao carrinho
        cart.push({
            sku,
            name,
            category,
            quantity
        });
    }
    
    // Atualizar o botão do produto
    updateCartButton(sku, true);
    
    // Atualizar o contador do carrinho
    updateCartCount();
    
    // Salvar o carrinho no localStorage
    saveCart();
}

function removeFromCart(sku) {
    // Filtrar o carrinho para remover o item
    cart = cart.filter(item => item.sku !== sku);
    
    // Atualizar o botão do produto
    updateCartButton(sku, false);
    
    // Zerar o input de quantidade
    const quantityInput = document.getElementById(`qty-${sku}`);
    if (quantityInput) {
        quantityInput.value = 0;
    }
    
    // Atualizar o contador do carrinho
    updateCartCount();
    
    // Salvar o carrinho no localStorage
    saveCart();
    
    // Atualizar a exibição do carrinho se estiver aberto
    if (document.getElementById('cartModal').style.display === 'flex') {
        renderCartItems();
    }
}

function updateCartItemQuantity(sku, quantity) {
    // Encontrar o item no carrinho
    const itemIndex = cart.findIndex(item => item.sku === sku);
    
    if (quantity <= 0) {
        // Se a quantidade for zero ou negativa, remover do carrinho
        if (itemIndex >= 0) {
            removeFromCart(sku);
        }
    } else {
        if (itemIndex >= 0) {
            // Atualizar a quantidade
            cart[itemIndex].quantity = quantity;
            
            // Salvar o carrinho
            saveCart();
            
            // Atualizar a exibição do carrinho se estiver aberto
            if (document.getElementById('cartModal').style.display === 'flex') {
                renderCartItems();
            }
        } else {
            // Se o item não estiver no carrinho mas tiver quantidade > 0,
            // encontrar o produto na lista e adicionar ao carrinho
            const product = allProducts.find(p => p.sku === sku);
            if (product) {
                addToCart(sku, product.marca, product.categoria, quantity);
            }
        }
    }
}

function updateCartButton(sku, inCart) {
    const cartBtn = document.getElementById(`cart-btn-${sku}`);
    
    if (cartBtn) {
        if (inCart) {
            cartBtn.classList.add('in-cart');
            cartBtn.innerHTML = '<i class="fas fa-check"></i>';
        } else {
            cartBtn.classList.remove('in-cart');
            cartBtn.innerHTML = '<i class="fas fa-cart-plus"></i>';
        }
    }
}

function updateCartCount() {
    // Calcular a quantidade total de itens no carrinho
    const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);
    
    // Atualizar o contador no indicador do carrinho
    document.querySelector('.cart-count').textContent = totalItems;
}

function saveCart() {
    localStorage.setItem('cart', JSON.stringify(cart));
}

function clearCart() {
    // Limpar array do carrinho
    cart = [];
    
    // Atualizar exibição
    renderCartItems();
    
    // Atualizar contador
    updateCartCount();
    
    // Salvar carrinho vazio
    saveCart();
    
    // Redefinir todos os botões e quantidades
    document.querySelectorAll('.add-to-cart').forEach(btn => {
        const sku = btn.id.replace('cart-btn-', '');
        updateCartButton(sku, false);
        
        const quantityInput = document.getElementById(`qty-${sku}`);
        if (quantityInput) {
            quantityInput.value = 0;
        }
    });
}

function openCartModal() {
    renderCartItems();
    openModal('cartModal');
}

function renderCartItems() {
    const cartItemsContainer = document.getElementById('cart-items');
    
    if (cart.length === 0) {
        cartItemsContainer.innerHTML = '<div class="empty-cart-message">Seu carrinho está vazio</div>';
        return;
    }
    
    let html = '';
    
    cart.forEach(item => {
        html += `
            <div class="cart-item" data-sku="${item.sku}">
                <div class="cart-item-info">
                    <div class="cart-item-name">${item.name}</div>
                    <div class="cart-item-sku">Código: ${item.sku}</div>
                </div>
                <div class="cart-item-qty">
                    <button class="qty-btn" onclick="decrementCartItem('${item.sku}')">-</button>
                    <input type="number" class="qty-input" value="${item.quantity}" min="1" max="999" readonly>
                    <button class="qty-btn" onclick="incrementCartItem('${item.sku}')">+</button>
                    <button class="qty-btn" onclick="removeFromCart('${item.sku}')" style="margin-left:5px">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
        `;
    });
    
    cartItemsContainer.innerHTML = html;
}

function incrementCartItem(sku) {
    // Encontrar o item no carrinho
    const item = cart.find(i => i.sku === sku);
    
    if (item) {
        item.quantity += 1;
        
        // Atualizar o input na lista de produtos
        const quantityInput = document.getElementById(`qty-${sku}`);
        if (quantityInput) {
            quantityInput.value = item.quantity;
        }
        
        // Salvar e renderizar
        saveCart();
        renderCartItems();
        updateCartCount();
    }
}

function decrementCartItem(sku) {
    // Encontrar o item no carrinho
    const item = cart.find(i => i.sku === sku);
    
    if (item && item.quantity > 1) {
        item.quantity -= 1;
        
        // Atualizar o input na lista de produtos
        const quantityInput = document.getElementById(`qty-${sku}`);
        if (quantityInput) {
            quantityInput.value = item.quantity;
        }
        
        // Salvar e renderizar
        saveCart();
        renderCartItems();
        updateCartCount();
    } else if (item && item.quantity <= 1) {
        // Se a quantidade for 1, remover do carrinho
        removeFromCart(sku);
    }
}

function sendToWhatsApp() {
    if (cart.length === 0) {
        alert("Seu carrinho está vazio.");
        return;
    }
    
    // Formatação do texto para o WhatsApp
    let message = "Olá! Gostaria de fazer um pedido:\n\n";
    
    cart.forEach(item => {
        message += `cod ${item.sku} ${item.quantity}und ${item.name}\n`;
        message += "-------------\n";
    });
    
    // Codificar a mensagem para URL
    const encodedMessage = encodeURIComponent(message);
    
    // Abrir o WhatsApp com a mensagem preenchida
    window.open(`https://wa.me/?text=${encodedMessage}`, '_blank');
}

// Funções para seleção de produtos (modo vendedor)
function toggleProductSelection(sku, name, category, imgSrc) {
    const isSelected = selectedProducts.some(item => item.sku === sku);
    
    if (isSelected) {
        // Remover da seleção
        selectedProducts = selectedProducts.filter(item => item.sku !== sku);
        
        // Atualizar a UI para refletir a deseleção
        const productElement = document.querySelector(`.product[data-sku="${sku}"]`);
        if (productElement) {
            productElement.classList.remove('selected');
            const selectIcon = productElement.querySelector('.product-select');
            if (selectIcon) {
                selectIcon.innerHTML = '';
            }
        }
    } else {
        // IMPORTANTE: Sempre buscar a URL da imagem diretamente do objeto allProducts (dados do CSV)
        const originalProduct = allProducts.find(p => p.sku === sku);
        if (!originalProduct) {
            console.error(`Produto com SKU ${sku} não encontrado nos dados originais do CSV`);
            return;
        }
        
        // Usar APENAS a URL da imagem do CSV
        const imageUrl = originalProduct.img;
        console.log(`Selecionando produto ${sku} com imagem do CSV: ${imageUrl}`);
        
        // Adicionar à seleção
        selectedProducts.push({
            sku,
            name,
            category,
            imgSrc: imageUrl, // GARANTIR que estamos usando a imagem do CSV
            price: '' // Iniciar com preço vazio
        });
        
        // Atualizar a UI para refletir a seleção
        const productElement = document.querySelector(`.product[data-sku="${sku}"]`);
        if (productElement) {
            productElement.classList.add('selected');
            const selectIcon = productElement.querySelector('.product-select');
            if (selectIcon) {
                selectIcon.innerHTML = '<i class="fas fa-check"></i>';
            }
            
            // Adicionar campo de preço
            const productInfo = productElement.querySelector('.product-info');
            if (productInfo && !productInfo.querySelector('.price-input-group')) {
                const priceInput = document.createElement('div');
                priceInput.className = 'price-input-group';
                priceInput.innerHTML = `
                    <span class="currency-symbol">R$</span>
                    <input type="text" class="product-price-input" 
                           placeholder="Insira o preço" 
                           value=""
                           onchange="updateProductPrice('${sku}', this.value)">
                `;
                productInfo.insertBefore(priceInput, productInfo.querySelector('.product-controls'));
            }
        }
    }
    
    // Salvar a seleção atual
    localStorage.setItem('selectedProducts', JSON.stringify(selectedProducts));
    
    // Atualizar contador
    updateSelectionCount();
}

// Atualizar preço de um produto selecionado
function updateProductPrice(sku, price) {
    const selectedIndex = selectedProducts.findIndex(item => item.sku === sku);
    
    if (selectedIndex >= 0) {
        selectedProducts[selectedIndex].price = price;
        localStorage.setItem('selectedProducts', JSON.stringify(selectedProducts));
    }
}

function toggleCategorySelection(category) {
    // Recuperar produtos nesta categoria do conjunto atual de dados
    const productsInCategory = productData.filter(p => p.categoria === category);
    
    // Verificação de validação de entrada
    if (!productsInCategory.length) {
        console.warn(`Nenhum produto encontrado na categoria: ${category}`);
        return;
    }
    
    // Verificar se todos os produtos da categoria já estão selecionados
    const allSelected = productsInCategory.every(p => 
        selectedProducts.some(item => item.sku === p.sku)
    );
    
    if (allSelected) {
        // Caminho de execução: Desmarcar todos os produtos
        productsInCategory.forEach(p => {
            const isSelected = selectedProducts.some(item => item.sku === p.sku);
            if (isSelected) {
                toggleProductSelection(p.sku, p.marca, p.categoria, p.img);
            }
        });
    } else {
        // Caminho de execução: Selecionar todos os produtos não selecionados
        productsInCategory.forEach(p => {
            const isSelected = selectedProducts.some(item => item.sku === p.sku);
            if (!isSelected) {
                toggleProductSelection(p.sku, p.marca, p.categoria, p.img);
            }
        });
    }
}

function updateSelectionCount() {
    const count = selectedProducts.length;
    document.querySelector('.selection-count').textContent = 
        count === 1 ? '1 produto selecionado' : `${count} produtos selecionados`;
    
    // Refletir o nome da coleção no campo
    const collectionName = document.getElementById('collection-name').value;
    if (collectionName) {
        document.getElementById('pdf-collection-name').value = collectionName;
    }
}

// Abrir modal para salvar coleção
function openSaveCollectionModal() {
    if (selectedProducts.length === 0) {
        showNotification('Selecione pelo menos um produto para criar uma coleção', 'error');
        return;
    }
    
    // Preencher o nome da coleção a partir do campo na interface
    const currentName = document.getElementById('collection-name').value;
    document.getElementById('save-collection-name').value = currentName;
    
    openModal('saveCollectionModal');
}

// Salvar coleção atual
function saveCollection() {
    const name = document.getElementById('save-collection-name').value.trim();
    const description = document.getElementById('collection-description').value.trim();
    const keepSelected = document.getElementById('save-as-default').checked;
    const includePrices = document.getElementById('include-prices').checked;
    
    if (!name) {
        showNotification('Informe um nome para a coleção', 'error');
        return;
    }
    
    if (selectedProducts.length === 0) {
        showNotification('Selecione pelo menos um produto para criar uma coleção', 'error');
        return;
    }
    
    // Verificar se já existe uma coleção com este nome
    const existingIndex = collections.findIndex(c => c.name.toLowerCase() === name.toLowerCase());
    
    // Criar uma cópia dos produtos selecionados
    let selectedProductsCopy = selectedProducts.map(p => ({...p}));
    
    // Remover preços se a opção não estiver marcada
    if (!includePrices) {
        selectedProductsCopy = selectedProductsCopy.map(p => {
            const newP = {...p};
            newP.price = '';
            return newP;
        });
    }
    
    if (existingIndex >= 0) {
        // Atualizar coleção existente
        collections[existingIndex] = {
            ...collections[existingIndex],
            name,
            description,
            products: selectedProductsCopy,
            updatedAt: new Date().toISOString()
        };
        
        showNotification(`Coleção "${name}" atualizada com sucesso!`, 'success');
    } else {
        // Criar nova coleção
        collections.push({
            id: Date.now().toString(),
            name,
            description,
            products: selectedProductsCopy,
            createdAt: new Date().toISOString(),
            updatedAt: new Date().toISOString()
        });
        
        showNotification(`Coleção "${name}" criada com sucesso!`, 'success');
    }
    
    // Salvar no localStorage
    localStorage.setItem('collections', JSON.stringify(collections));
    
    // Atualizar o número de coleções
    updateCollectionCount();
    
    // Atualizar o input de nome da coleção na interface principal
    document.getElementById('collection-name').value = name;
    
    // Limpar a seleção se o usuário desejar
    if (!keepSelected) {
        clearSelection();
    }
    
    // Fechar o modal
    closeModal('saveCollectionModal');
}

// Limpar seleção atual
function clearSelection() {
    selectedProducts = [];
    localStorage.setItem('selectedProducts', JSON.stringify(selectedProducts));
    
    // Atualizar UI
    document.querySelectorAll('.product.selected').forEach(product => {
        product.classList.remove('selected');
        const selectIcon = product.querySelector('.product-select');
        if (selectIcon) {
            selectIcon.innerHTML = '';
        }
        
        // Remover campo de preço
        const priceInput = product.querySelector('.price-input-group');
        if (priceInput) {
            priceInput.remove();
        }
    });
    
    updateSelectionCount();
    document.getElementById('collection-name').value = '';
}

// Abrir modal para gerenciar coleções
function openManageCollectionsModal() {
    const collectionsContainer = document.getElementById('collections-container');
    
    if (collections.length === 0) {
        collectionsContainer.innerHTML = `
            <div class="empty-collections">
                <i class="fas fa-folder-open"></i>
                <p>Você ainda não tem coleções salvas</p>
                <p>Crie sua primeira coleção selecionando produtos e clicando em "Salvar Coleção"</p>
            </div>
        `;
    } else {
        let html = '<ul class="collections-list">';
        
        collections.forEach(collection => {
            const date = new Date(collection.updatedAt).toLocaleDateString();
            const count = collection.products.length;
            
            html += `
                <li class="collection-item" data-id="${collection.id}">
                    <div class="collection-item-info">
                        <div class="collection-item-name">${collection.name}</div>
                        <div class="collection-item-meta">
                            <span>${count} ${count === 1 ? 'produto' : 'produtos'}</span>
                            <span>Atualizado em: ${date}</span>
                        </div>
                    </div>
                    <div class="collection-item-actions">
                        <button class="collection-action-btn view" onclick="viewCollectionProducts('${collection.id}')">
                            <i class="fas fa-eye"></i> Ver produtos
                        </button>
                        <button class="collection-action-btn edit" onclick="loadCollection('${collection.id}')">
                            <i class="fas fa-edit"></i> Editar
                        </button>
                        <button class="collection-action-btn pdf" onclick="openPdfModalForCollection('${collection.id}')">
                            <i class="fas fa-file-pdf"></i> PDF
                        </button>
                        <button class="collection-action-btn delete" onclick="deleteCollection('${collection.id}')">
                            <i class="fas fa-trash"></i> Excluir
                        </button>
                    </div>
                </li>
            `;
        });
        
        html += '</ul>';
        collectionsContainer.innerHTML = html;
    }
    
    openModal('manageCollectionsModal');
}

// Atualizar contador de coleções
function updateCollectionCount() {
    document.querySelector('.collection-count').textContent = collections.length;
}

// Carregar uma coleção existente
function loadCollection(collectionId) {
    const collection = collections.find(c => c.id === collectionId);
    
    if (!collection) {
        showNotification('Coleção não encontrada', 'error');
        return;
    }
    
    // Carregar produtos da coleção
    selectedProducts = JSON.parse(JSON.stringify(collection.products)); // Deep copy
    localStorage.setItem('selectedProducts', JSON.stringify(selectedProducts));
    
    // Atualizar nome da coleção
    document.getElementById('collection-name').value = collection.name;
    
    // Reexibir produtos para atualizar a seleção
    displayProducts();
    
    // Atualizar contador
    updateSelectionCount();
    
    // Fechar o modal
    closeModal('manageCollectionsModal');
    
    // Alternar para modo vendedor se ainda não estiver nele
    if (!inVendorMode) {
        inVendorMode = true;
        localStorage.setItem('vendorMode', true);
        applyCurrentMode();
        displayProducts(); // Reexibir produtos no novo modo
    }
    
    showNotification(`Coleção "${collection.name}" carregada com sucesso!`, 'success');
}

// NOVA IMPLEMENTAÇÃO 1: Excluir coleção sem deixar vestígios
function deleteCollection(collectionId) {
    if (confirm("Tem certeza que deseja excluir esta coleção?")) {
        const collectionIndex = collections.findIndex(c => c.id === collectionId);
        
        if (collectionIndex >= 0) {
            const collectionName = collections[collectionIndex].name;
            const deletedCollection = collections[collectionIndex];
            
            // Verificar se a coleção que está sendo excluída é a que está selecionada atualmente
            let isCurrentCollection = false;
            
            // Comparar a coleção atual com a que está sendo excluída
            // (verificando se os produtos selecionados correspondem aos da coleção)
            if (selectedProducts.length > 0 && 
                document.getElementById('collection-name').value === deletedCollection.name) {
                isCurrentCollection = true;
            }
            
            // Remover a coleção do array
            collections.splice(collectionIndex, 1);
            
            // Salvar no localStorage
            localStorage.setItem('collections', JSON.stringify(collections));
            
            // Se for a coleção atual, limpar a seleção
            if (isCurrentCollection) {
                clearSelection();
                document.getElementById('collection-name').value = '';
            }
            
            // Atualizar o número de coleções
            updateCollectionCount();
            
            // Atualizar a exibição
            openManageCollectionsModal();
            
            showNotification(`Coleção "${collectionName}" excluída com sucesso!`, 'success');
        }
    }
}

// NOVA IMPLEMENTAÇÃO 2: Funções para visualizar apenas os produtos de uma coleção
function viewCollectionProducts(collectionId) {
    // Buscar a coleção
    const collection = collections.find(c => c.id === collectionId);
    
    if (!collection) {
        showNotification('Coleção não encontrada', 'error');
        return;
    }
    
    // Definir o filtro ativo
    activeCollectionFilter = {
        id: collectionId,
        name: collection.name,
        skus: collection.products.map(p => p.sku)
    };
    
    // Fechar o modal de gerenciamento
    closeModal('manageCollectionsModal');
    
    // Mostrar notificação
    showNotification(`Exibindo produtos da coleção "${collection.name}"`, 'success');
    
    // Adicionar banner de filtro ativo
    addCollectionFilterBanner(collection.name);
    
    // Aplicar o filtro e exibir os produtos
    displayProducts();
}

function addCollectionFilterBanner(collectionName) {
    // Remover banner existente se houver
    removeCollectionFilterBanner();
    
    // Criar o banner
    const banner = document.createElement('div');
    banner.id = 'collection-filter-banner';
    banner.style.backgroundColor = 'rgba(230, 126, 34, 0.1)';
    banner.style.border = '1px solid var(--accent-color)';
    banner.style.borderRadius = '5px';
    banner.style.padding = '10px 15px';
    banner.style.marginBottom = '15px';
    banner.style.display = 'flex';
    banner.style.justifyContent = 'space-between';
    banner.style.alignItems = 'center';
    
    banner.innerHTML = `
        <div>
            <i class="fas fa-filter" style="color: var(--accent-color); margin-right: 8px;"></i>
            <span>Exibindo produtos da coleção: <strong>${collectionName}</strong></span>
        </div>
        <button onclick="clearCollectionFilter()" style="background: var(--accent-color); color: white; border: none; border-radius: 4px; padding: 5px 10px; cursor: pointer;">
            <i class="fas fa-times"></i> Remover filtro
        </button>
    `;
    
    // Inserir o banner antes dos filtros
    const filtersElement = document.querySelector('.filters');
    filtersElement.parentNode.insertBefore(banner, filtersElement);
}

function removeCollectionFilterBanner() {
    const banner = document.getElementById('collection-filter-banner');
    if (banner) {
        banner.parentNode.removeChild(banner);
    }
}

function clearCollectionFilter() {
    activeCollectionFilter = null;
    removeCollectionFilterBanner();
    
    // Reexibir todos os produtos
    displayProducts();
    
    showNotification('Filtro de coleção removido', 'success');
}

// Abrir modal de PDF para uma coleção específica
function openPdfModalForCollection(collectionId) {
    const collection = collections.find(c => c.id === collectionId);
    
    if (!collection) {
        showNotification('Coleção não encontrada', 'error');
        return;
    }
    
    // Carregar produtos da coleção
    selectedProducts = JSON.parse(JSON.stringify(collection.products)); // Deep copy
    localStorage.setItem('selectedProducts', JSON.stringify(selectedProducts));
    
    // Atualizar nome da coleção para o PDF
    document.getElementById('pdf-collection-name').value = collection.name;
    
    // Fechar o modal de gerenciamento
    closeModal('manageCollectionsModal');
    
    // Abrir o modal de PDF
    openPdfModal();
}

// Abrir modal para gerar PDF
function openPdfModal() {
    if (selectedProducts.length === 0) {
        showNotification('Selecione pelo menos um produto para gerar o PDF', 'error');
        return;
    }
    
    // Preencher o título do PDF a partir do nome da coleção
    const currentName = document.getElementById('collection-name').value;
    if (currentName && !document.getElementById('pdf-collection-name').value) {
        document.getElementById('pdf-collection-name').value = currentName;
    }
    
    // Reset PDF progress bar
    document.getElementById('pdf-progress-container').style.display = 'none';
    document.getElementById('pdf-progress-fill').style.width = '0%';
    document.getElementById('pdf-progress-text').textContent = 'Carregando imagens: 0%';
    
    // Habilitar o botão de gerar PDF
    document.getElementById('generate-pdf-btn').disabled = false;
    
    openModal('pdfModal');
}

// Função para buscar produto na API da Ameripan
async function fetchProductImageFromAPI(sku) {
    try {
        // URL da API (substitua pela URL correta)
        const apiUrl = `https://www.ameripan.com.br/buscar?q=${sku}`;
        
        // Buscar dados da página
        const response = await fetch(apiUrl, {
            method: 'GET',
            mode: 'cors',
            cache: 'no-cache',
            credentials: 'same-origin',
            redirect: 'follow',
            referrerPolicy: 'no-referrer'
        });
        
        if (!response.ok) {
            throw new Error(`Erro ao buscar: ${response.status}`);
        }
        
        const html = await response.text();
        
        // Analisar HTML para encontrar a imagem do produto
        const parser = new DOMParser();
        const doc = parser.parseFromString(html, 'text/html');
        
        // Procurar pelo SKU na página
        const productItems = doc.querySelectorAll('.listagem-item');
        let imageUrl = null;
        
        for (const item of productItems) {
            const skuElement = item.querySelector('.produto-sku.hide');
            
            if (skuElement && skuElement.textContent.trim() === sku) {
                // Encontrou o produto, obter URL da imagem
                const imageElement = item.querySelector('.imagem-produto img');
                if (imageElement && imageElement.src) {
                    imageUrl = imageElement.src;
                    break;
                }
            }
        }
        
        return imageUrl;
    } catch (error) {
        console.error(`Erro ao buscar imagem para SKU ${sku}:`, error);
        return null;
    }
}

// Função para capturar a imagem diretamente da interface do usuário (backup)
function captureImageFromDOM(sku) {
    try {
        const imgElement = document.querySelector(`.product[data-sku="${sku}"] img`);
        
        if (!imgElement || !imgElement.complete || imgElement.naturalWidth === 0) {
            console.warn(`Elemento de imagem para SKU ${sku} não encontrado ou não carregado no DOM`);
            return null;
        }
        
        const canvas = document.createElement('canvas');
        canvas.width = imgElement.naturalWidth || 300;
        canvas.height = imgElement.naturalHeight || 300;
        
        const ctx = canvas.getContext('2d');
        ctx.drawImage(imgElement, 0, 0, canvas.width, canvas.height);
        
        try {
            const dataURL = canvas.toDataURL('image/jpeg', 0.95);
            console.log(`Imagem para SKU ${sku} capturada do DOM com sucesso`);
            return dataURL;
        } catch (e) {
            console.error(`Erro ao converter canvas para dataURL (SKU ${sku}):`, e);
            return null;
        }
    } catch (error) {
        console.error(`Erro ao capturar imagem do DOM para SKU ${sku}:`, error);
        return null;
    }
}

// Função melhorada para pré-carregar imagens e convertê-las para base64
// Improved image loading function with multiple fallback strategies
async function preloadImageAsBase64(url, sku) {
    return new Promise((resolve, reject) => {
        // If URL is empty or invalid, resolve with null
        if (!url || typeof url !== 'string' || url.trim() === '') {
            console.warn(`Empty or invalid URL for SKU ${sku}`);
            resolve(null);
            return;
        }
        
        // Check global cache using SKU-based key first (most reliable)
        const skuCacheKey = `img_${sku}`;
        if (globalImageCache.has(skuCacheKey)) {
            console.log(`Image found in SKU cache for ${sku}`);
            resolve(globalImageCache.get(skuCacheKey));
            return;
        }
        
        // Also check URL-based cache
        if (globalImageCache.has(url)) {
            console.log(`Image found in URL cache: ${url}`);
            resolve(globalImageCache.get(url));
            return;
        }
        
        console.log(`Attempting to load image for SKU ${sku}: ${url}`);
        
        // Create image element with explicit dimensions
        const img = new Image();
        img.crossOrigin = 'Anonymous'; // For CORS
        
        // Success handler with additional error trapping
        img.onload = function() {
            try {
                // Check if image has dimensions
                if (img.width === 0 || img.height === 0) {
                    console.warn(`Image loaded but has zero dimensions: ${url}`);
                    resolve(null);
                    return;
                }
                
                // Limit image dimensions for canvas (prevent "canvas too large" errors)
                const maxDim = 1500;
                let finalWidth = img.width;
                let finalHeight = img.height;
                
                if (finalWidth > maxDim || finalHeight > maxDim) {
                    const ratio = Math.min(maxDim / finalWidth, maxDim / finalHeight);
                    finalWidth = Math.floor(finalWidth * ratio);
                    finalHeight = Math.floor(finalHeight * ratio);
                    console.log(`Resizing large image for SKU ${sku} to ${finalWidth}x${finalHeight}`);
                }
                
                // Create canvas with appropriate dimensions
                const canvas = document.createElement('canvas');
                canvas.width = finalWidth;
                canvas.height = finalHeight;
                
                // Draw image to canvas with resizing if needed
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0, finalWidth, finalHeight);
                
                // Try higher compression for large images
                let quality = 0.8;
                if (finalWidth * finalHeight > 500000) {
                    quality = 0.6; // Higher compression for very large images
                }
                
                // Convert to base64 with appropriate quality
                let dataURL;
                try {
                    dataURL = canvas.toDataURL('image/jpeg', quality);
                } catch (canvasError) {
                    console.error(`Canvas conversion error for SKU ${sku}:`, canvasError);
                    
                    // Try with smaller dimensions as fallback
                    try {
                        canvas.width = Math.min(500, finalWidth);
                        canvas.height = Math.min(500, finalHeight);
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        dataURL = canvas.toDataURL('image/jpeg', 0.5);
                    } catch (fallbackError) {
                        console.error(`Fallback canvas conversion failed for SKU ${sku}:`, fallbackError);
                        resolve(null);
                        return;
                    }
                }
                
                // Verify dataURL is valid
                if (!dataURL || dataURL === 'data:,' || dataURL.length < 100) {
                    console.warn(`Invalid dataURL generated for SKU ${sku}`);
                    resolve(null);
                    return;
                }
                
                // Add to both caching mechanisms
                globalImageCache.set(skuCacheKey, dataURL);
                globalImageCache.set(url, dataURL);
                
                console.log(`Successfully converted image for SKU ${sku}`);
                
                // Save cache to localStorage (with error handling)
                try {
                    const cacheObject = Object.fromEntries(globalImageCache);
                    localStorage.setItem('imageCache', JSON.stringify(cacheObject));
                } catch (storageError) {
                    console.warn("localStorage error (possibly quota exceeded):", storageError);
                    // Try to save just this image
                    try {
                        const singleCache = {};
                        singleCache[skuCacheKey] = dataURL;
                        localStorage.setItem(`imgCache_${sku}`, JSON.stringify(singleCache));
                    } catch (e) {
                        console.warn("Single image cache failed too");
                    }
                }
                
                resolve(dataURL);
            } catch (err) {
                console.error(`Error converting image for SKU ${sku}:`, err);
                resolve(null);
            }
        };
        
        // Error handler
        img.onerror = function() {
            console.warn(`Failed to load image for SKU ${sku}: ${url}`);
            
            // Try alternate URL format - attempt to correct common issues
            tryAlternateUrl(url, sku).then(alternateDataUrl => {
                if (alternateDataUrl) {
                    console.log(`Successfully loaded alternate URL for SKU ${sku}`);
                    resolve(alternateDataUrl);
                } else {
                    resolve(null);
                }
            });
        };
        
        // Set source and start loading with cache-busting query param
        img.src = url + (url.includes('?') ? '&' : '?') + 'nocache=' + new Date().getTime();
        
        // Increased timeout to 10 seconds for larger images
        setTimeout(() => {
            if (!img.complete) {
                console.warn(`Timeout (10s) loading image for SKU ${sku}: ${url}`);
                img.src = ''; // Cancel the request
                resolve(null);
            }
        }, 10000);
    });
}

// Function to try alternate URL formats when the primary URL fails
async function tryAlternateUrl(originalUrl, sku) {
    // Common image URL patterns and fixes
    const attempts = [
        // Try without cache busting parameters
        url => url.split('?')[0],
        
        // Try with https instead of http
        url => url.replace('http://', 'https://'),
        
        // Try without www if present, or with www if not
        url => url.includes('www.') ? url.replace('www.', '') : url.replace('://', '://www.'),
        
        // Try with .jpg if no extension exists
        url => {
            const baseUrl = url.split('?')[0];
            if (!baseUrl.match(/\.(jpg|jpeg|png|gif)$/i)) {
                return baseUrl + '.jpg';
            }
            return null;
        },
        
        // Try with .png if no extension exists
        url => {
            const baseUrl = url.split('?')[0];
            if (!baseUrl.match(/\.(jpg|jpeg|png|gif)$/i)) {
                return baseUrl + '.png';
            }
            return null;
        }
    ];
    
    // Check if we can find product info in allProducts
    const product = allProducts.find(p => p.sku === sku);
    if (product && product.img && product.img !== originalUrl) {
        // Try the original URL from the product data first
        console.log(`Trying original product URL for SKU ${sku}: ${product.img}`);
        const result = await attemptImageLoad(product.img);
        if (result) return result;
    }
    
    // Try each URL transformation
    for (const transform of attempts) {
        const altUrl = transform(originalUrl);
        
        // Skip null or same URL
        if (!altUrl || altUrl === originalUrl) continue;
        
        console.log(`Trying alternate URL for SKU ${sku}: ${altUrl}`);
        const result = await attemptImageLoad(altUrl);
        if (result) return result;
    }
    
    // All attempts failed
    return null;
}

// Helper function to attempt loading an image
function attemptImageLoad(url) {
    return new Promise(resolve => {
        const img = new Image();
        img.crossOrigin = 'Anonymous';
        
        img.onload = function() {
            try {
                // Only process if image has dimensions
                if (img.width === 0 || img.height === 0) {
                    resolve(null);
                    return;
                }
                
                // Create canvas and convert to base64
                const canvas = document.createElement('canvas');
                const maxDim = 800; // Limit size
                
                let w = img.width;
                let h = img.height;
                if (w > maxDim || h > maxDim) {
                    const ratio = Math.min(maxDim/w, maxDim/h);
                    w = Math.floor(w * ratio);
                    h = Math.floor(h * ratio);
                }
                
                canvas.width = w;
                canvas.height = h;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0, w, h);
                
                const dataURL = canvas.toDataURL('image/jpeg', 0.7);
                resolve(dataURL);
            } catch (err) {
                console.error(`Error in attemptImageLoad for ${url}:`, err);
                resolve(null);
            }
        };
        
        img.onerror = function() {
            resolve(null);
        };
        
        // Add cache-busting
        img.src = url + (url.includes('?') ? '&' : '?') + 'cb=' + Date.now();
        
        // Safety timeout
        setTimeout(() => {
            if (!img.complete) {
                img.src = '';
                resolve(null);
            }
        }, 5000);
    });
}

// Load and recover all available cache when page loads
function loadAllImageCaches() {
    try {
        // Try main cache first
        const mainCache = localStorage.getItem('imageCache');
        if (mainCache) {
            try {
                const cacheData = JSON.parse(mainCache);
                globalImageCache = new Map(Object.entries(cacheData));
                console.log(`Loaded ${globalImageCache.size} images from main cache`);
            } catch (e) {
                console.warn("Failed to parse main image cache:", e);
                globalImageCache = new Map();
            }
        }
        
        // Look for individual cached images
        for (let i = 0; i < localStorage.length; i++) {
            const key = localStorage.key(i);
            if (key && key.startsWith('imgCache_')) {
                try {
                    const sku = key.replace('imgCache_', '');
                    const cacheData = JSON.parse(localStorage.getItem(key));
                    
                    // Add to global cache
                    Object.entries(cacheData).forEach(([cacheKey, dataUrl]) => {
                        globalImageCache.set(cacheKey, dataUrl);
                    });
                    
                    console.log(`Recovered cache for SKU ${sku}`);
                } catch (e) {
                    console.warn(`Failed to load individual cache ${key}:`, e);
                }
            }
        }
    } catch (error) {
        console.error("Error loading image caches:", error);
        globalImageCache = new Map();
    }
}

// Initialize cache on page load
document.addEventListener('DOMContentLoaded', () => {
    // Other initialization code...
    
    // Load all available image caches
    loadAllImageCaches();
});

// Modified preloadAllImages function for more reliable loading
async function preloadAllImages(products) {
    const imageCache = new Map();
    const sessionId = Date.now().toString();
    
    // Reset state
    pdfGenerationState = {
        inProgress: true,
        processedItems: 0,
        totalItems: products.length,
        sessionId,
        imageCache,
        retryCount: {}
    };
    
    // Show progress bar
    const progressContainer = document.getElementById('pdf-progress-container');
    progressContainer.style.display = 'block';
    
    // Clear progress
    document.getElementById('pdf-progress-fill').style.width = '0%';
    document.getElementById('pdf-progress-text').textContent = 'Carregando imagens: 0%';
    
    // Load images in batches to avoid overwhelming the browser
    // Process 3 images at a time with a small delay between batches
    const batchSize = 3;
    
    for (let i = 0; i < products.length; i += batchSize) {
        const batch = products.slice(i, i + batchSize);
        const batchPromises = batch.map(async (product) => {
            try {
                // Get original product data from allProducts
                const originalProduct = allProducts.find(p => p.sku === product.sku);
                
                if (!originalProduct || !originalProduct.img) {
                    console.warn(`No image URL found in CSV for SKU ${product.sku}`);
                    updateProgressBar(i + batch.indexOf(product), products.length);
                    return;
                }
                
                const imageUrl = originalProduct.img;
                console.log(`Processing image for SKU ${product.sku}: ${imageUrl}`);
                
                // Try to load the image
                const dataUrl = await preloadImageAsBase64(imageUrl, product.sku);
                
                if (dataUrl) {
                    // Store in cache
                    imageCache.set(product.sku, dataUrl);
                    product.imgSrc = imageUrl; // Keep consistent URL reference
                    console.log(`Successfully cached image for SKU ${product.sku}`);
                } else {
                    console.warn(`Failed to load image for SKU ${product.sku}`);
                }
                
                updateProgressBar(i + batch.indexOf(product), products.length);
            } catch (error) {
                console.error(`Error processing image for ${product.sku}:`, error);
                updateProgressBar(i + batch.indexOf(product), products.length);
            }
        });
        
        // Wait for the current batch to complete
        await Promise.all(batchPromises);
        
        // Add a small delay between batches to allow UI updates
        if (i + batchSize < products.length) {
            await new Promise(resolve => setTimeout(resolve, 50));
        }
    }
    
    // Mark process as complete
    pdfGenerationState.inProgress = false;
    
    // Final progress update
    document.getElementById('pdf-progress-text').textContent = 
        `${imageCache.size} de ${products.length} imagens carregadas (${Math.round((imageCache.size/products.length)*100)}%)`;
    
    return imageCache;
    
    // Helper to update progress bar
    function updateProgressBar(current, total) {
        const percentage = Math.round(((current + 1) / total) * 100);
        
        const progressFill = document.getElementById('pdf-progress-fill');
        const progressText = document.getElementById('pdf-progress-text');
        
        progressFill.style.width = `${percentage}%`;
        progressText.textContent = `Carregando imagens: ${percentage}%`;
    }
}

// Update the toggleProductSelection function to always store the original CSV image URL
function toggleProductSelection(sku, name, category, imgSrc) {
    const isSelected = selectedProducts.some(item => item.sku === sku);
    
    if (isSelected) {
        // Remove from selection
        selectedProducts = selectedProducts.filter(item => item.sku !== sku);
        
        // Update UI to reflect deselection
        const productElement = document.querySelector(`.product[data-sku="${sku}"]`);
        if (productElement) {
            productElement.classList.remove('selected');
            const selectIcon = productElement.querySelector('.product-select');
            if (selectIcon) {
                selectIcon.innerHTML = '';
            }
        }
    } else {
        // Get the EXACT image URL from the original product data
        const originalProduct = allProducts.find(p => p.sku === sku);
        if (!originalProduct) {
            console.error(`Product with SKU ${sku} not found in original CSV data`);
            return;
        }
        
        // Add to selection with the original URL
        selectedProducts.push({
            sku,
            name,
            category,
            imgSrc: originalProduct.img, // Always use original CSV image URL
            price: '' // Start with empty price
        });
        
        // Update UI to reflect selection
        const productElement = document.querySelector(`.product[data-sku="${sku}"]`);
        if (productElement) {
            productElement.classList.add('selected');
            const selectIcon = productElement.querySelector('.product-select');
            if (selectIcon) {
                selectIcon.innerHTML = '<i class="fas fa-check"></i>';
            }
            
            // Add price field
            const productInfo = productElement.querySelector('.product-info');
            if (productInfo && !productInfo.querySelector('.price-input-group')) {
                const priceInput = document.createElement('div');
                priceInput.className = 'price-input-group';
                priceInput.innerHTML = `
                    <span class="currency-symbol">R$</span>
                    <input type="text" class="product-price-input" 
                           placeholder="Insira o preço" 
                           value=""
                           onchange="updateProductPrice('${sku}', this.value)">
                `;
                productInfo.insertBefore(priceInput, productInfo.querySelector('.product-controls'));
            }
        }
    }
    
    // Save the current selection
    localStorage.setItem('selectedProducts', JSON.stringify(selectedProducts));
    
    // Update counter
    updateSelectionCount();
}


// Função melhorada para tentar múltiplas URLs de imagem
async function tryMultipleImageUrls(sku, baseUrls, retryCount = 0) {
    // Adicionar mais URLs alternativas (inclusive com diferentes extensões)
    const extendedBaseUrls = [
        ...baseUrls,
        'https://www.ameripan.com.br/media/catalog/product/',
        'https://ameripan.com.br/img/produtos/',
        'https://ameripan.vteximg.com.br/arquivos/ids/',
        'https://www.americafoods.com.br/media/catalog/product/',
        'https://www.haraldsabor.com.br/img/produtos/',
        'https://www.sicao.com.br/media/catalog/product/'
    ];
    
    // Tentar diferentes extensões de arquivo
    const extensions = ['.jpg', '.jpeg', '.png', '.webp'];
    
    // Para cada URL base, tentar cada extensão
    for (const baseUrl of extendedBaseUrls) {
        for (const ext of extensions) {
            try {
                // Construir URL completa
                const url = `${baseUrl}${sku}${ext}`;
                
                // Verificar se a URL é válida
                try {
                    const response = await fetch(url, { 
                        method: 'HEAD',
                        mode: 'no-cors', // Tentar contornar limitações de CORS
                        cache: 'force-cache' // Usar cache do navegador quando possível
                    });
                    
                    if (response.ok || response.status === 0) { // Status 0 pode ocorrer com no-cors
                        console.log(`URL de imagem encontrada para SKU ${sku}: ${url}`);
                        return url;
                    }
                } catch (err) {
                    // Continuar tentando outras combinações
                }
            } catch (error) {
                // Ignorar erro e continuar tentando
            }
        }
    }
    
    // Tentar obter da API apenas se outras tentativas falharem
    try {
        const apiImageUrl = await fetchProductImageFromAPI(sku);
        if (apiImageUrl) {
            return apiImageUrl;
        }
    } catch (error) {
        console.warn(`Erro ao buscar imagem da API para SKU ${sku}:`, error);
    }
    
    // Se todas as tentativas falharem, tentar uma busca no Google Images como último recurso
    if (retryCount === 0) {
        try {
            // Construir uma URL de produto típica da ameripan
            const fallbackUrl = `https://www.ameripan.com.br/produto/${sku}`;
            console.log(`Tentando URL de fallback para SKU ${sku}: ${fallbackUrl}`);
            return fallbackUrl;
        } catch (error) {
            console.error(`Erro ao criar URL de fallback para SKU ${sku}:`, error);
        }
    }
    
    console.warn(`Nenhuma URL de imagem encontrada para SKU ${sku} após todas as tentativas`);
    return null;
}

// Função melhorada para pré-carregar todas as imagens
async function preloadAllImages(products) {
    const imageCache = new Map();
    const imageTasks = [];
    const sessionId = Date.now().toString(); // ID único para esta sessão de carregamento
    
    // Configurar estado do processo
    pdfGenerationState = {
        inProgress: true,
        processedItems: 0,
        totalItems: products.length,
        sessionId,
        imageCache,
        retryCount: {}
    };
    
    // Mostrar barra de progresso
    const progressContainer = document.getElementById('pdf-progress-container');
    progressContainer.style.display = 'block';
    
    // Baseado nas bases de URLs alternativas conhecidas
    const baseUrls = [
        'https://www.ameripan.com.br/media/catalog/product/',
        'https://ameripan.com.br/img/produtos/',
        'https://ameripan.vteximg.com.br/arquivos/ids/',
        'https://www.americafoods.com.br/media/catalog/product/'
    ];
    
    // Para cada produto, tente carregar sua imagem
    for (const product of products) {
        const task = (async (prod) => {
            try {
                // Controlar tentativas por SKU
                if (!pdfGenerationState.retryCount[prod.sku]) {
                    pdfGenerationState.retryCount[prod.sku] = 0;
                }
                
                // Aumentar limite de tentativas de 3 para 5
                if (pdfGenerationState.retryCount[prod.sku] >= 5) {
                    console.warn(`Máximo de tentativas atingido para SKU ${prod.sku}`);
                    updateProgressBar();
                    return;
                }
                
                pdfGenerationState.retryCount[prod.sku]++;
                
                // Verificar se já existe no cache global
                const cacheKey = `img_${prod.sku}`;
                if (globalImageCache.has(cacheKey)) {
                    imageCache.set(prod.sku, globalImageCache.get(cacheKey));
                    console.log(`Imagem para SKU ${prod.sku} recuperada do cache global`);
                    updateProgressBar();
                    return;
                }
                
                // ETAPA 1: Tentar capturar a imagem diretamente do DOM
                const domImageData = captureImageFromDOM(prod.sku);
                if (domImageData) {
                    imageCache.set(prod.sku, domImageData);
                    globalImageCache.set(cacheKey, domImageData);
                    updateProgressBar();
                    return;
                }
                
                // ETAPA 2: Se o produto já tem URL de imagem, tentar usá-la
                if (prod.imgSrc && typeof prod.imgSrc === 'string' && prod.imgSrc.trim() !== '') {
                    const dataUrl = await preloadImageAsBase64(prod.imgSrc, prod.sku);
                    if (dataUrl) {
                        imageCache.set(prod.sku, dataUrl);
                        globalImageCache.set(cacheKey, dataUrl);
                        updateProgressBar();
                        return;
                    }
                }
                
                // ETAPA 3: Tentar diferentes URLs possíveis
                const imageUrl = await tryMultipleImageUrls(prod.sku, baseUrls, pdfGenerationState.retryCount[prod.sku]);
                
                if (imageUrl) {
                    // Atualizar a URL da imagem do produto
                    prod.imgSrc = imageUrl;
                    
                    // Pré-carregar e converter para base64
                    const dataUrl = await preloadImageAsBase64(imageUrl, prod.sku);
                    if (dataUrl) {
                        imageCache.set(prod.sku, dataUrl);
                        globalImageCache.set(cacheKey, dataUrl);
                        updateProgressBar();
                        return;
                    }
                }
                
                // ETAPA 4: Último recurso - criar um placeholder com o SKU do produto
                console.warn(`Não foi possível carregar imagem para SKU ${prod.sku}, usando placeholder`);
                const placeholderUrl = `https://via.placeholder.com/300x300?text=${encodeURIComponent(prod.sku)}`;
                const placeholderDataUrl = await preloadImageAsBase64(placeholderUrl, prod.sku);
                
                if (placeholderDataUrl) {
                    imageCache.set(prod.sku, placeholderDataUrl);
                    globalImageCache.set(cacheKey, placeholderDataUrl);
                }
                
                // Atualizar barra de progresso
                updateProgressBar();
            } catch (error) {
                console.error(`Erro ao processar imagem para ${prod.sku}:`, error);
                updateProgressBar();
            }
        })(product);
        
        imageTasks.push(task);
    }
    
    // Função para atualizar a barra de progresso
    function updateProgressBar() {
        pdfGenerationState.processedItems++;
        const percentage = Math.round((pdfGenerationState.processedItems / pdfGenerationState.totalItems) * 100);
        
        // Atualizar visualmente a barra de progresso
        const progressFill = document.getElementById('pdf-progress-fill');
        const progressText = document.getElementById('pdf-progress-text');
        
        progressFill.style.width = `${percentage}%`;
        progressText.textContent = `Carregando imagens: ${percentage}%`;
        
        // Verificar se completou
        if (pdfGenerationState.processedItems >= pdfGenerationState.totalItems) {
            progressText.textContent = `${imageCache.size} de ${pdfGenerationState.totalItems} imagens carregadas (${percentage}%)`;
        }
    }
    
    // Processar todas as imagens em paralelo, com timeout maior (30 segundos)
    const timeoutPromise = new Promise(resolve => setTimeout(() => {
        console.warn("Timeout global de carregamento de imagens atingido (30 segundos)");
        resolve();
    }, 30000)); // 30 segundos no máximo
    
    await Promise.race([
        Promise.all(imageTasks),
        timeoutPromise
    ]);
    
    // Tentar novamente para imagens que falharam (forçando o último recurso)
    const failedSkus = products.filter(p => !imageCache.has(p.sku)).map(p => p.sku);
    
    if (failedSkus.length > 0) {
        console.log(`Tentando novamente para ${failedSkus.length} imagens que falharam...`);
        
        const retryTasks = failedSkus.map(sku => {
            const product = products.find(p => p.sku === sku);
            return (async () => {
                // Forçar placeholder para SKUs que falharam
                const placeholderUrl = `https://via.placeholder.com/300x300?text=${encodeURIComponent(sku)}`;
                const placeholderDataUrl = await preloadImageAsBase64(placeholderUrl, sku);
                
                if (placeholderDataUrl) {
                    imageCache.set(sku, placeholderDataUrl);
                    globalImageCache.set(`img_${sku}`, placeholderDataUrl);
                    console.log(`Placeholder adicionado para SKU ${sku}`);
                }
            })();
        });
        
        await Promise.all(retryTasks);
    }
    
    // Salvar cache global no localStorage
    try {
        const cacheObject = Object.fromEntries(globalImageCache);
        localStorage.setItem('imageCache', JSON.stringify(cacheObject));
    } catch (storageError) {
        console.warn("Não foi possível salvar o cache de imagens:", storageError);
    }
    
    // Marcar processo como concluído
    pdfGenerationState.inProgress = false;
    
    console.log(`Processo de carregamento de imagens concluído. ${imageCache.size} de ${products.length} imagens carregadas.`);
    return imageCache;
}

// Função melhorada para criar placeholder de imagem
function createPlaceholderImage(doc, product, imgX, imgY, imgWidth, imgHeight) {
    // Usar diferentes cores para diferentes categorias
    let fillColor = [240, 240, 240]; // Cinza claro padrão
    const category = (product.category || '').toLowerCase();
    
    if (category.includes('chocolate') || category.includes('acaiteria')) {
        fillColor = [222, 184, 135]; // Marrom claro para chocolates
    } else if (category.includes('confeitaria')) {
        fillColor = [255, 182, 193]; // Rosa claro para confeitaria
    } else if (category.includes('ingrediente')) {
        fillColor = [240, 230, 140]; // Amarelo claro para ingredientes
    } else if (category.includes('embalagem')) {
        fillColor = [176, 224, 230]; // Azul claro para embalagens
    }
    
    // Adicionar retângulo colorido como fundo da imagem
    doc.setFillColor(fillColor[0], fillColor[1], fillColor[2]);
    doc.rect(imgX, imgY, imgWidth, imgHeight, 'F');
    
    // Adicionar borda
    doc.setDrawColor(200, 200, 200);
    doc.rect(imgX, imgY, imgWidth, imgHeight, 'S');
    
    // Destacar o SKU no placeholder para facilitar identificação
    doc.setFontSize(7);
    doc.setTextColor(80, 80, 80);
    doc.setFont('helvetica', 'bold');
    doc.text(product.sku || "SKU", imgX + imgWidth/2, imgY + 7, {align: "center"});
    
    // Criar representação visual do produto baseada na categoria
    doc.setDrawColor(100, 100, 100);
    doc.setLineWidth(0.7);
    
    // Crie ícones diferentes dependendo do tipo de produto
    if (product.name && product.name.toLowerCase().includes('chocolate')) {
        // Desenhar uma barra de chocolate
        doc.setFillColor(82, 44, 26); // Marrom mais escuro
        doc.rect(imgX + 5, imgY + 10, 15, 10, 'F');
        doc.setDrawColor(60, 30, 15);
        doc.line(imgX + 5, imgY + 15, imgX + 20, imgY + 15);
        doc.line(imgX + 12.5, imgY + 10, imgX + 12.5, imgY + 20);
    }
    else if (product.name && product.name.toLowerCase().includes('granulado')) {
        // Desenhar pontos para granulado
        doc.setFillColor(60, 30, 15);
        for (let i = 0; i < 12; i++) {
            const dotX = imgX + 5 + (i % 4) * 5;
            const dotY = imgY + 12 + Math.floor(i / 4) * 5;
            doc.circle(dotX, dotY, 1, 'F');
        }
    }
    else if (product.name && product.name.toLowerCase().includes('cobertura')) {
        // Desenhar uma tigela com cobertura
        doc.setDrawColor(80, 80, 80);
        doc.setFillColor(220, 220, 220);
        // Tigela
        doc.ellipse(imgX + imgWidth/2, imgY + imgHeight/2 + 2, 8, 3, 'F');
        doc.ellipse(imgX + imgWidth/2, imgY + imgHeight/2 + 2, 8, 3, 'S');
        // Cobertura derretida
        doc.setFillColor(100, 50, 30);
        doc.ellipse(imgX + imgWidth/2, imgY + imgHeight/2, 7, 2, 'F');
        // Pauzinho de chocolate
        doc.setFillColor(60, 30, 15);
        doc.rect(imgX + imgWidth/2 - 0.5, imgY + 10, 1, 8, 'F');
    } 
    else {
        // Ícone genérico para outros produtos
        // Desenhar caixa de produto
        doc.setDrawColor(120, 120, 120);
        doc.rect(imgX + 5, imgY + 12, 15, 10, 'S');
        doc.line(imgX + 5, imgY + 16, imgX + 20, imgY + 16);
        doc.setFontSize(6);
        doc.setTextColor(80, 80, 80);
        doc.text("PRODUTO", imgX + imgWidth/2, imgY + imgHeight/2 + 6, {align: "center"});
    }
    
    // Resetar estilos
    doc.setLineWidth(0.1);
    doc.setDrawColor(0, 0, 0);
}

// Função auxiliar para adicionar um produto ao documento PDF
async function addProductToDocument(doc, product, y, margin, contentWidth, options, imageCache) {
    const { includeSku, includeCategory, includePrice, includePriceField, includeImages } = options;
    const productWidth = contentWidth;
    const pageWidth = doc.internal.pageSize.getWidth();
    
    // Definir altura do produto
    let productHeight = 35; // Altura padrão para todos os produtos
    
    // Desenhar caixa do produto
    doc.setFillColor(250, 250, 250);
    doc.setDrawColor(230, 230, 230);
    doc.rect(margin, y, productWidth, productHeight, 'F');
    doc.rect(margin, y, productWidth, productHeight, 'S');
    
    // Adicionar imagem ou placeholder
    if (includeImages) {
        try {
            // Dimensões e posição da imagem
            const imgWidth = 25;
            const imgHeight = 25;
            const imgX = margin + 5;
            const imgY = y + 5;
            
            // Verificar se temos a imagem no cache
            let imageData = null;
            if (imageCache && imageCache.has(product.sku)) {
                imageData = imageCache.get(product.sku);
            }
            
            // Se conseguimos a imagem, adicionar ao PDF
            if (imageData) {
                try {
                    doc.addImage(imageData, 'JPEG', imgX, imgY, imgWidth, imgHeight);
                } catch (addImgError) {
                    console.error('Erro ao adicionar imagem ao PDF:', addImgError);
                    // Criar placeholder colorido em caso de erro
                    createPlaceholderImage(doc, product, imgX, imgY, imgWidth, imgHeight);
                }
            } else {
                // Criar placeholder colorido se não conseguimos a imagem
                createPlaceholderImage(doc, product, imgX, imgY, imgWidth, imgHeight);
            }
            
            // Nome do produto
            doc.setFontSize(11);
            doc.setFont('helvetica', 'bold');
            doc.setTextColor(0, 0, 0);
            const nameText = product.name || 'Produto sem nome';
            doc.text(nameText, margin + 35, y + 10);
            
            // SKU
            let textY = y + 16;
            if (includeSku) {
                doc.setFontSize(9);
                doc.setFont('helvetica', 'normal');
                doc.setTextColor(100, 100, 100);
                doc.text(`Código: ${product.sku}`, margin + 35, textY);
                textY += 5;
            }
            
            // Categoria
            if (includeCategory) {
                doc.setFontSize(9);
                doc.setFont('helvetica', 'normal');
                doc.setTextColor(100, 100, 100);
                const categoryText = product.category || 'Sem categoria';
                doc.text(`Categoria: ${categoryText}`, margin + 35, textY);
                textY += 5;
            }
            
            // Preço
            if (includePrice && product.price) {
                doc.setFontSize(10);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(0, 0, 0);
                doc.text(`Preço: R$ ${product.price}`, margin + 35, textY);
                textY += 5;
            }
            
            // Campo para preço manual
            if (includePriceField && (!includePrice || !product.price)) {
                doc.setFontSize(10);
                doc.setFont('helvetica', 'normal');
                doc.text('Preço: R$ __________________', margin + 35, textY);
            }
        } catch (error) {
            console.error('Erro ao processar produto:', error);
            
            // Em caso de erro, mostrar só o texto
            doc.setFontSize(11);
            doc.setFont('helvetica', 'bold');
            doc.setTextColor(0, 0, 0);
            const nameText = product.name || 'Produto sem nome';
            doc.text(nameText, margin + 10, y + 10);
            
            // Informações em linha
            const infoY = y + 18;
            let infoX = margin + 10;
            
            // SKU
            if (includeSku) {
                doc.setFontSize(9);
                doc.setFont('helvetica', 'normal');
                doc.setTextColor(100, 100, 100);
                doc.text(`Código: ${product.sku}`, infoX, infoY);
                infoX += 45;
            }
            
            // Categoria
            if (includeCategory) {
                doc.setFontSize(9);
                doc.setFont('helvetica', 'normal');
                doc.setTextColor(100, 100, 100);
                const categoryText = product.category || 'Sem categoria';
                doc.text(`Categoria: ${categoryText}`, infoX, infoY);
                infoX += 65;
            }
            
            // Preço
            if (includePrice && product.price) {
                doc.setFontSize(10);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(0, 0, 0);
                doc.text(`Preço: R$ ${product.price}`, infoX, infoY);
            } else if (includePriceField) {
                doc.setFontSize(10);
                doc.setFont('helvetica', 'normal');
                doc.text('Preço: R$ __________________', infoX, infoY);
            }
        }
    } else {
        // Layout simplificado sem imagens
        // Nome do produto
        doc.setFontSize(11);
        doc.setFont('helvetica', 'bold');
        doc.setTextColor(0, 0, 0);
        const nameText = product.name || 'Produto sem nome';
        doc.text(nameText, margin + 5, y + 10);
        
        // Informações em linha
        const infoY = y + 18;
        let infoX = margin + 5;
        
        // SKU
        if (includeSku) {
            doc.setFontSize(9);
            doc.setFont('helvetica', 'normal');
            doc.setTextColor(100, 100, 100);
            doc.text(`Código: ${product.sku}`, infoX, infoY);
            infoX += 45;
        }
        
        // Categoria
        if (includeCategory) {
            doc.setFontSize(9);
            doc.setFont('helvetica', 'normal');
            doc.setTextColor(100, 100, 100);
            const categoryText = product.category || 'Sem categoria';
            doc.text(`Categoria: ${categoryText}`, infoX, infoY);
            infoX += 65;
        }
        
        // Preço
        if (includePrice && product.price) {
            doc.setFontSize(10);
            doc.setFont('helvetica', 'bold');
            doc.setTextColor(0, 0, 0);
            doc.text(`Preço: R$ ${product.price}`, infoX, infoY);
        } else if (includePriceField) {
            doc.setFontSize(10);
            doc.setFont('helvetica', 'normal');
            doc.text('Preço: R$ __________________', infoX, infoY);
        }
    }
    
    return productHeight;
}

// Função para gerar PDF da coleção atual
async function generatePDF() {
    // Verificar se já temos um processo em andamento
    if (pdfGenerationState.inProgress) {
        showNotification('Já existe um processo de geração de PDF em andamento. Aguarde...', 'error');
        return;
    }
    
    // Desabilitar o botão para evitar múltiplos cliques
    document.getElementById('generate-pdf-btn').disabled = true;
    
    // Obter o título do PDF
    const title = document.getElementById('pdf-collection-name').value.trim() || 'Catálogo de Produtos';
    const collectionName = document.getElementById('collection-name').value.trim();
    
    // Se temos um nome da coleção, usá-lo como subtítulo
    const useCollectionName = collectionName && collectionName !== title;
    
    // Obter todas as configurações do PDF
    const includeSku = document.getElementById('include-sku').checked;
    const includeCategory = document.getElementById('include-category').checked;
    const includePrice = document.getElementById('include-price').checked;
    const includePriceField = document.getElementById('include-price-field').checked;
    const groupByCategory = document.getElementById('group-by-category').checked;
    const includeLogo = document.getElementById('include-logo').checked;
    const includeImages = document.getElementById('include-images').checked;
    const includeFooter = document.getElementById('include-footer').checked;
    
    // Mostrar notificação de geração
    showNotification('Carregando imagens e gerando PDF. Aguarde...', 'success');
    
    // Pré-carregar todas as imagens antes de gerar o PDF
    (async () => {
        try {
            // Tentar buscar e pré-carregar imagens para todos os produtos
            const imageCache = await preloadAllImages(selectedProducts);
            console.log(`Imagens pré-carregadas: ${imageCache.size} de ${selectedProducts.length}`);
            
            // Criar uma instância do jsPDF
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({
                orientation: 'portrait',
                unit: 'mm',
                format: 'a4',
                compress: true
            });
            
            // Definir metadados do PDF para evitar bloqueios de segurança
            doc.setProperties({
                title: title,
                subject: useCollectionName ? collectionName : 'Catálogo de Produtos Ameripan',
                author: 'Ameripan',
                keywords: 'catalogo, produtos, ameripan',
                creator: 'Catálogo Ameripan',
                producer: 'Ameripan'
            });
            
            // Definir margens e valores padrão
            const pageWidth = doc.internal.pageSize.getWidth();
            const pageHeight = doc.internal.pageSize.getHeight();
            const margin = 15;
            const contentWidth = pageWidth - (margin * 2);
            let y = margin;
            
            // Adicionar cabeçalho com logo
            if (includeLogo) {
                // Adicionar logo (retângulo com textura/gradiente)
                // Fundo do logo
                doc.setFillColor(240, 240, 240);
                doc.rect(margin, y, 40, 15, 'F');
                
                // Borda logo
                doc.setDrawColor(220, 220, 220);
                doc.rect(margin, y, 40, 15, 'S');
                
                // Texto logo
                doc.setFontSize(12);
                doc.setTextColor(50, 50, 50);
                doc.setFont('helvetica', 'bold');
                doc.text('AMERIPAN', margin + 20, y + 8, { align: 'center' });
                
                // Adicionar título do catálogo
                doc.setFontSize(18);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(0, 0, 0);
                doc.text(title, pageWidth - margin, y + 8, { align: 'right' });
                
                // Se houver um nome de coleção diferente do título, adicionar como subtítulo
                if (useCollectionName) {
                    y += 14;
                    doc.setFontSize(12);
                    doc.setFont('helvetica', 'italic');
                    doc.setTextColor(80, 80, 80);
                    doc.text(`Coleção: ${collectionName}`, pageWidth - margin, y, { align: 'right' });
                    y += 4;
                } else {
                    y += 18;
                }
                
                // Linha separadora
                doc.setDrawColor(200, 200, 200);
                doc.line(margin, y, pageWidth - margin, y);
                y += 10;
            } else {
                // Adicionar apenas o título centralizado
                doc.setFontSize(22);
                doc.setFont('helvetica', 'bold');
                doc.text(title, pageWidth / 2, y + 8, { align: 'center' });
                
                // Se houver um nome de coleção diferente do título, adicionar como subtítulo
                if (useCollectionName) {
                    y += 14;
                    doc.setFontSize(14);
                    doc.setFont('helvetica', 'italic');
                    doc.setTextColor(80, 80, 80);
                    doc.text(`Coleção: ${collectionName}`, pageWidth / 2, y, { align: 'center' });
                    y += 6;
                } else {
                    y += 20;
                }
            }
            
            // Obter data atual
            const today = new Date();
            const dateStr = today.toLocaleDateString('pt-BR');
            doc.setFontSize(10);
            doc.setFont('helvetica', 'italic');
            doc.setTextColor(100, 100, 100);
            doc.text(`Gerado em: ${dateStr}`, pageWidth - margin, y, { align: 'right' });
            y += 8;
            
            // Adicionar informação sobre as imagens e cache
            if (includeImages) {
                const imagesLoaded = imageCache.size;
                const totalProducts = selectedProducts.length;
                
                // Adicionar informação sobre imagens carregadas apenas se não foram todas carregadas
                if (imagesLoaded < totalProducts && imagesLoaded > 0) {
                    doc.setFontSize(8);
                    doc.setFont('helvetica', 'italic');
                    doc.setTextColor(150, 150, 150);
                    doc.text(`* ${imagesLoaded} de ${totalProducts} imagens disponíveis`, margin, y, { align: 'left' });
                    y += 5;
                }
            }
            
            // Se agrupar por categoria
            if (groupByCategory) {
                // Organizar produtos por categoria
                const categoriesMap = {};
                selectedProducts.forEach(product => {
                    const category = product.category || 'Sem categoria';
                    if (!categoriesMap[category]) {
                        categoriesMap[category] = [];
                    }
                    categoriesMap[category].push(product);
                });
                
                // Processar cada categoria
                for (const category in categoriesMap) {
                    // Verificar se é necessário adicionar nova página
                    if (y > pageHeight - 50) {
                        doc.addPage();
                        y = margin;
                    }
                    
                    // Adicionar título da categoria
                    doc.setFontSize(14);
                    doc.setFont('helvetica', 'bold');
                    doc.setTextColor(52, 152, 219);
                    doc.text(category.toUpperCase(), margin, y);
                    
                    y += 2;
                    doc.setDrawColor(52, 152, 219);
                    doc.line(margin, y, margin + 40, y);
                    y += 10;
                    
                    // Adicionar produtos desta categoria
                    for (const product of categoriesMap[category]) {
                        const productHeight = await addProductToDocument(doc, product, y, margin, contentWidth, {
                            includeSku,
                            includeCategory,
                            includePrice,
                            includePriceField,
                            includeImages
                        }, imageCache);
                        
                        y += productHeight + 5; // 5mm de espaço entre produtos
                        
                        // Verificar se é necessário adicionar nova página para o próximo produto
                        if (y > pageHeight - 50) {
                            doc.addPage();
                            y = margin;
                        }
                    }
                    
                    y += 5; // Espaço adicional entre categorias
                }
            } else {
                // Adicionar produtos sem agrupar
                for (const product of selectedProducts) {
                    // Verificar se é necessário adicionar nova página
                    if (y > pageHeight - 50) {
                        doc.addPage();
                        y = margin;
                    }
                    
                    const productHeight = await addProductToDocument(doc, product, y, margin, contentWidth, {
                        includeSku,
                        includeCategory,
                        includePrice,
                        includePriceField,
                        includeImages
                    }, imageCache);
                    
                    y += productHeight + 5; // 5mm de espaço entre produtos
                }
            }
            
            // Adicionar rodapé se solicitado
            if (includeFooter) {
                // Adicionar a todas as páginas
                const totalPages = doc.internal.getNumberOfPages();
                for (let i = 1; i <= totalPages; i++) {
                    doc.setPage(i);
                    
                    const footerY = pageHeight - 10;
                    doc.setFontSize(8);
                    doc.setTextColor(100, 100, 100);
                    doc.setFont('helvetica', 'normal');
                    
                    // Linha separadora do rodapé
                    doc.setDrawColor(200, 200, 200);
                    doc.line(margin, footerY - 5, pageWidth - margin, footerY - 5);
                    
                    // Texto do rodapé
                    doc.text(' www.ameripan.com.br | atendimento@ameripan.com.br | (19) 3406-4070', pageWidth / 2, footerY, { align: 'center' });
                    
                    // Número de página
                    doc.text(`Página ${i} de ${totalPages}`, pageWidth - margin, footerY, { align: 'right' });
                }
            }
            
            // Salvar o PDF com o título como nome do arquivo
            const filename = (useCollectionName ? collectionName : title).replace(/[^a-z0-9]/gi, '_').toLowerCase() + '.pdf';
            
            try {
                // Método usando blob e URL (mais confiável)
                const blob = doc.output('blob');
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = filename;
                document.body.appendChild(link);
                link.click();
                
                // Remover o link após o download
                setTimeout(() => {
                    document.body.removeChild(link);
                    URL.revokeObjectURL(url);
                    
                    // Notificar sucesso
                    showNotification('PDF gerado com sucesso!', 'success');
                    
                    // Mostrar instruções sobre erro de segurança apenas se houve erro no cache
                    if (imageCache.size < selectedProducts.length) {
                        setTimeout(() => {
                            showPdfInstructions();
                        }, 1000);
                    }
                }, 100);
            } catch (blobError) {
                console.error('Erro ao baixar PDF via blob:', blobError);
                
                // Método alternativo
                try {
                    doc.save(filename);
                    showNotification('PDF gerado com sucesso!', 'success');
                } catch (saveError) {
                    console.error('Erro ao salvar PDF:', saveError);
                    showNotification('Erro ao gerar PDF. Tente novamente.', 'error');
                }
            }
            
            // Fechar o modal
            closeModal('pdfModal');
            
        } catch (error) {
            console.error('Erro ao gerar PDF:', error);
            showNotification('Erro ao gerar PDF. Tente novamente.', 'error');
            
            // Reativar o botão
            document.getElementById('generate-pdf-btn').disabled = false;
        }
    })();
}

// Função para mostrar instruções de como lidar com o erro de segurança do PDF
function showPdfInstructions() {
    // Criar modal com instruções
    const modal = document.createElement('div');
    modal.className = 'modal';
    modal.id = 'pdfInstructionsModal';
    modal.style.display = 'flex';
    
    const modalContent = `
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <div class="modal-title">Como abrir o PDF gerado</div>
                <div class="modal-close" onclick="closeModal('pdfInstructionsModal')">&times;</div>
            </div>
            <div class="modal-body">
                <div style="text-align: center; margin-bottom: 15px;">
                    <img src="https://via.placeholder.com/550x150?text=Erro+de+Seguranca+do+Windows" style="max-width: 100%;">
                </div>
                
                <p><strong>Se você encontrar um erro de segurança ao abrir o PDF:</strong></p>
                
                <ol style="margin-left: 20px; line-height: 1.6;">
                    <li>Clique com o botão direito no arquivo PDF baixado</li>
                    <li>Selecione "Propriedades"</li>
                    <li>Na parte inferior da janela de Propriedades, marque a opção "Desbloquear" (ou "Permitir")</li>
                    <li>Clique em "Aplicar" e "OK"</li>
                    <li>Agora tente abrir o arquivo novamente</li>
                </ol>
                
                <p style="margin-top: 15px;">Alternativamente, você pode:</p>
                
                <ul style="margin-left: 20px; line-height: 1.6;">
                    <li>Clicar em "Mais informações" no aviso de segurança e escolher "Executar assim mesmo"</li>
                    <li>Mover o arquivo para outro local do seu computador antes de abri-lo</li>
                    <li>Usar um navegador diferente para gerar o PDF</li>
                </ul>
                
                <p style="margin-top: 15px; font-style: italic;">Este erro ocorre porque o Windows está protegendo seu computador contra arquivos potencialmente não seguros da internet.</p>
            </div>
            <div style="padding: 15px; text-align: right;">
                <button class="modal-btn save" onclick="closeModal('pdfInstructionsModal')">Entendi</button>
            </div>
        </div>
    `;
    
    modal.innerHTML = modalContent;
    document.body.appendChild(modal);
    
    // Animar a abertura do modal
    setTimeout(() => {
        modal.classList.add('active');
    }, 10);
    
    // Fechar modal ao clicar fora
    modal.addEventListener('click', function(e) {
        if (e.target === this) {
            closeModal('pdfInstructionsModal');
        }
    });
}

// Exibir notificação
function showNotification(message, type = 'success') {
    const notifications = document.getElementById('notifications');
    
    const notification = document.createElement('div');
    notification.classList.add('notification');
    notification.classList.add(type);
    
    if (type === 'error') {
        notification.innerHTML = `<i class="fas fa-exclamation-circle"></i> ${message}`;
    } else {
        notification.innerHTML = `<i class="fas fa-check-circle"></i> ${message}`;
    }
    
    notifications.appendChild(notification);
    
    // Mostrar com animação
    setTimeout(() => {
        notification.classList.add('show');
    }, 10);
    
    // Auto-remover após 3 segundos
    setTimeout(() => {
        notification.classList.remove('show');
        setTimeout(() => {
            notifications.removeChild(notification);
        }, 300);
    }, 3000);
}

// Funções para controle de modal
function openModal(modalId) {
    const modal = document.getElementById(modalId);
    modal.style.display = "flex";
    
    // Animar a abertura do modal
    setTimeout(() => {
        modal.classList.add('active');
    }, 10);
    
    // Impedir o scroll da página
    document.body.style.overflow = 'hidden';
}

function closeModal(modalId) {
    const modal = document.getElementById(modalId);
    modal.classList.remove('active');
    
    // Após a animação de fechamento
    setTimeout(() => {
        modal.style.display = "none";
    }, 300);
    
    // Restaurar o scroll da página
    document.body.style.overflow = 'auto';
}

// Configuração do scroll infinito
function setupInfiniteScroll() {
    // Usar Intersection Observer para detectar quando o usuário chega ao final da página
    const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
            if (entry.isIntersecting && !isLoading) {
                loadMoreProducts();
            }
        });
    }, { threshold: 0.1 });
    
    const loader = document.createElement('div');
    loader.id = 'infinite-scroll-trigger';
    loader.style.height = '20px';
    document.getElementById('product-list').after(loader);
    
    observer.observe(loader);
}

function addInfiniteScrollLoader() {
    // Verificar se há mais produtos para carregar
    if (productData.length > visibleProducts) {
        const loader = document.createElement('div');
        loader.className = 'loading-spinner';
        loader.id = 'products-loader';
        loader.innerHTML = '<div class="spinner"></div>';
        document.getElementById('product-list').appendChild(loader);
    }
}

function loadMoreProducts() {
    if (isLoading || productData.length <= visibleProducts) return;
    
    isLoading = true;
    
    // Simular carregamento
    setTimeout(() => {
        visibleProducts += incrementAmount;
        
        // Reexibir produtos com os mesmos filtros
        displayProducts();
        
        isLoading = false;
    }, 500);
}

// Controle do botão "Voltar ao Topo"
window.addEventListener('scroll', function() {
    const backToTopButton = document.getElementById('backToTop');
    if (window.scrollY > 300) {
        backToTopButton.classList.add('visible');
    } else {
        backToTopButton.classList.remove('visible');
    }
});

function scrollToTop() {
    window.scrollTo({
        top: 0,
        behavior: 'smooth'
    });
}

// Configurar eventos de filtros
document.getElementById("search").addEventListener("input", (e) => {
    visibleProducts = 20; // Resetar ao filtrar
    displayProducts(e.target.value);
});

document.getElementById("category").addEventListener("change", (e) => {
    visibleProducts = 20; // Resetar ao filtrar
    displayProducts(null, e.target.value);
});

document.getElementById("sort").addEventListener("change", (e) => {
    visibleProducts = 20; // Resetar ao filtrar
    displayProducts(null, null, e.target.value);
});

document.getElementById("package-size").addEventListener("change", (e) => {
    visibleProducts = 20; // Resetar ao filtrar
    displayProducts(null, null, null, e.target.value);
});

// Fechar os modais ao clicar fora do conteúdo
document.querySelectorAll(".modal").forEach(modal => {
    modal.addEventListener("click", function(e) {
        if (e.target === this) {
            closeModal(this.id);
        }
    });
});

// Fechar modais com a tecla ESC
document.addEventListener("keydown", function(e) {
    if (e.key === "Escape") {
        document.querySelectorAll(".modal").forEach(modal => {
            if (modal.style.display === "flex") {
                closeModal(modal.id);
            }
        });
    }
}); 
					
    </script>
</body>
</html>
