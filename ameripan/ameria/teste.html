<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <meta name="description" content="AmerIA 4.0 - Consultora Inteligente" />
    <title>AmerIA - Consultora Virtual Ameripan</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              'ameripan-blue': '#1E40AF',
              'ameripan-orange': '#F97316',
              'whatsapp': '#25D366'
            },
            fontFamily: { sans: ['Inter', 'system-ui', 'sans-serif'] },
            animation: { 'fadeIn': 'fadeIn 0.3s ease-out' },
            keyframes: { fadeIn: { '0%': { opacity: '0', transform: 'translateY(10px)' }, '100%': { opacity: '1', transform: 'translateY(0)' } } }
          }
        }
      }
    </script>

    <style>
      body { font-family: 'Inter', sans-serif; -webkit-font-smoothing: antialiased; }
      ::-webkit-scrollbar { width: 6px; }
      ::-webkit-scrollbar-track { background: transparent; }
      ::-webkit-scrollbar-thumb { background: #CBD5E1; border-radius: 10px; }
      
      .typing-dot { animation: typing 1.4s infinite ease-in-out both; }
      .typing-dot:nth-child(1) { animation-delay: -0.32s; }
      .typing-dot:nth-child(2) { animation-delay: -0.16s; }
      @keyframes typing { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }
      
      /* Markdown */
      .prose p { margin-bottom: 0.5rem; }
      .prose strong { color: #1e3a8a; font-weight: 700; }
      .prose ul { list-style-type: disc; padding-left: 1.2rem; margin: 0.5rem 0; }
      .prose ol { list-style-type: decimal; padding-left: 1.2rem; margin: 0.5rem 0; }
      .prose a { color: #2563EB; text-decoration: none; font-weight: 500; }
      .prose a:hover { text-decoration: underline; }
      .prose blockquote { border-left: 4px solid #F97316; background: #fff7ed; padding: 0.5rem 1rem; border-radius: 0 8px 8px 0; margin: 0.5rem 0; font-style: italic; }
    </style>

  <script type="importmap">
  {
    "imports": {
      "react": "https://esm.sh/react@18.2.0",
      "react-dom/client": "https://esm.sh/react-dom@18.2.0/client?deps=react@18.2.0",
      "lucide-react": "https://esm.sh/lucide-react@0.263.1?deps=react@18.2.0",
      "react-markdown": "https://esm.sh/react-markdown@8.0.7?deps=react@18.2.0",
      "@google/generative-ai": "https://esm.sh/@google/generative-ai"
    }
  }
  </script>
  </head>
  
  <body class="bg-slate-50 h-screen overflow-hidden">
    <div id="root"></div>

    <script type="text/babel" data-type="module">
      import React, { useState, useEffect, useRef } from 'react';
      import { createRoot } from 'react-dom/client';
      import { 
        Send, Mic, Camera, ShoppingCart, Trash2, Plus, Minus, X, 
        Image as ImageIcon, Loader2, MapPin, Phone, FileText, 
        Volume2, VolumeX, Settings, Save
      } from 'lucide-react';
      import ReactMarkdown from 'react-markdown';
      import { GoogleGenerativeAI } from '@google/generative-ai';

      // --- LISTA DE MODELOS ---
      const AI_MODELS = [
        { id: "gemini-2.0-flash-thinking-exp-01-21", name: "Gemini 2.0 Flash Thinking (PadrÃ£o)" },
        { id: "gemini-2.0-flash-exp", name: "Gemini 2.0 Flash Exp" },
        { id: "gemini-2.0-pro-exp-02-05", name: "Gemini 2.0 Pro Exp" },
        { id: "gemini-1.5-pro", name: "Gemini 1.5 Pro" },
        { id: "gemini-1.5-flash", name: "Gemini 1.5 Flash" },
        { id: "gemini-1.5-flash-8b", name: "Gemini 1.5 Flash 8B" },
        { id: "gemini-1.5-pro-002", name: "Gemini 1.5 Pro 002" },
        { id: "gemini-1.5-flash-002", name: "Gemini 1.5 Flash 002" }
      ];

      const CACHE = { products: [], videos: [], logistics: [], salespeople: [], branches: [], knowledge: "" };
      
      // --- CARREGAMENTO DE DADOS ---
      async function loadData() {
        try {
          const baseUrl = window.location.hostname.includes('github') ? '/ameripan/ameria/' : '/';
          console.log(`ðŸ”„ Base: ${baseUrl}`);

          const [p, v, d, s, b, k] = await Promise.all([
            fetch(`${baseUrl}data/products.json`).then(r => r.json()),
            fetch(`${baseUrl}data/videos.json`).then(r => r.json()),
            fetch(`${baseUrl}data/delivery.json`).then(r => r.json()),
            fetch(`${baseUrl}data/salespeople.json`).then(r => r.json()),
            fetch(`${baseUrl}data/branches.json`).then(r => r.json()),
            fetch(`${baseUrl}data/knowledge.json`).then(r => r.json())
          ]);

          CACHE.products = p; CACHE.videos = v; CACHE.logistics = d;
          CACHE.salespeople = s; CACHE.branches = b; CACHE.knowledge = k.content;
          return true;
        } catch (e) { console.error("âŒ Erro dados:", e); return false; }
      }

      // --- BUSCA INTELIGENTE ---
      const normalize = (str) => str ? str.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "") : "";
      
      function extractWeight(query) {
        const match = query.match(/(\d+)\s*(kg|g|l|ml)/i);
        return match ? { value: parseFloat(match[1]), unit: match[2].toLowerCase() } : null;
      }

      async function searchProducts(query) {
        if (!CACHE.products.length) return [];
        const terms = normalize(query).split(/\s+/).filter(t => t.length > 1);
        const targetWeight = extractWeight(query);

        let results = CACHE.products.map(p => {
          let score = 0;
          const fullText = normalize(`${p.PRODUTO} ${p.SKU} ${p.RAMO}`);
          
          if (p.SKU.toString() === query.trim()) score += 1000;
          let matches = 0;
          terms.forEach(t => { if (fullText.includes(t)) { score += 10; matches++; } });

          if (targetWeight) {
            const pWeight = extractWeight(p.PRODUTO);
            if (pWeight && pWeight.unit === targetWeight.unit && Math.abs(pWeight.value - targetWeight.value) <= 2) {
              score += 15;
            }
          }
          if (matches < terms.length) score *= 0.5;
          return { ...p, score };
        }).filter(r => r.score > 5).sort((a, b) => b.score - a.score);

        if (results.length === 0) {
           const videoMatches = CACHE.videos.filter(v => {
              const vText = normalize(v.nome);
              return terms.every(t => vText.includes(t));
           });
           results = [...results, ...videoMatches.map(v => ({
              SKU: v.codigo, PRODUTO: v.nome + " (VÃ­deo)", RAMO: "CatÃ¡logo VÃ­deo", IMG: "", videoLink: v.link, isVideoItem: true
           }))];
        }
        return results.slice(0, 10);
      }

      // --- UI COMPONENTES ---
      const ProductCard = ({ product, onAdd }) => (
        <div className="bg-white border border-gray-200 rounded-xl p-3 shadow-sm hover:shadow-md transition-all animate-fadeIn flex gap-3">
          <div className="w-16 h-16 flex-shrink-0">
            {product.IMG ? 
              <img src={product.IMG} alt={product.PRODUTO} className="w-full h-full object-cover rounded-md border border-gray-100" /> : 
              <div className="w-full h-full bg-gray-100 rounded-md flex items-center justify-center text-gray-300"><ImageIcon size={24} /></div>
            }
          </div>
          <div className="flex-1 min-w-0 flex flex-col justify-between">
            <div>
              <h4 className="text-sm font-bold text-gray-800 leading-tight line-clamp-2">{product.PRODUTO}</h4>
              <p className="text-[10px] text-gray-500 mt-1 uppercase">{product.RAMO || "Geral"}</p>
            </div>
            <div className="flex items-center justify-between mt-2">
              <span className="text-[10px] font-mono bg-gray-100 text-gray-600 px-1.5 py-0.5 rounded">SKU: {product.SKU}</span>
              {product.videoLink && <a href={product.videoLink} target="_blank" className="text-[10px] text-red-600 font-bold hover:underline ml-2">ðŸŽ¥ VÃ­deo</a>}
              <button onClick={() => onAdd(product)} className="bg-ameripan-blue text-white p-1.5 rounded-lg hover:bg-blue-800 active:scale-95 transition-all flex items-center gap-1 text-xs font-bold px-3">
                <Plus size={14} /> Cotar
              </button>
            </div>
          </div>
        </div>
      );

      function App() {
        const [messages, setMessages] = useState([{ role: 'model', text: "OlÃ¡! Sou a **AmerIA 4.0**. ðŸš€\n\nPosso ver fotos, ouvir e montar sua cotaÃ§Ã£o." }]);
        const [input, setInput] = useState('');
        const [isLoading, setIsLoading] = useState(false);
        const [cart, setCart] = useState([]);
        const [showCart, setShowCart] = useState(false);
        const [showSettings, setShowSettings] = useState(false);
        const [isListening, setIsListening] = useState(false);
        const [audioEnabled, setAudioEnabled] = useState(false);
        const [dataLoaded, setDataLoaded] = useState(false);
        
        // ConfiguraÃ§Ãµes (Persistentes)
        const [apiKey, setApiKey] = useState(() => localStorage.getItem('ameria_api_key') || '');
        const [modelId, setModelId] = useState(() => localStorage.getItem('ameria_model') || 'gemini-2.0-flash-thinking-exp-01-21');

        const messagesEndRef = useRef(null);
        const fileInputRef = useRef(null);

        useEffect(() => { loadData().then(ok => ok && setDataLoaded(true)); }, []);
        useEffect(() => { messagesEndRef.current?.scrollIntoView({ behavior: "smooth" }); }, [messages]);

        // Salvar configs
        const saveSettings = () => {
            localStorage.setItem('ameria_api_key', apiKey);
            localStorage.setItem('ameria_model', modelId);
            setShowSettings(false);
            alert("ConfiguraÃ§Ãµes salvas!");
        };

        // Carrinho
        const addToCart = (p) => setCart(prev => {
          const exists = prev.find(i => i.SKU === p.SKU);
          return exists ? prev.map(i => i.SKU === p.SKU ? { ...i, qtd: i.qtd + 1 } : i) : [...prev, { ...p, qtd: 1 }];
        });
        const removeFromCart = (sku) => setCart(prev => prev.filter(p => p.SKU !== sku));
        const sendQuote = () => {
          if (!cart.length) return;
          const msg = `*COTAÃ‡ÃƒO AMERIA*%0A%0A${cart.map(p => `â€¢ ${p.qtd}x ${p.PRODUTO} (SKU: ${p.SKU})`).join('%0A')}%0A%0A*Total:* ${cart.reduce((a,b)=>a+b.qtd,0)} itens.`;
          window.open(`https://wa.me/5519982213355?text=${msg}`, '_blank');
        };

        // IA
        const callGemini = async (history, img = null) => {
            if (!apiKey) {
                setShowSettings(true);
                return "âš ï¸ **Configure sua API Key** nas configuraÃ§Ãµes (engrenagem no topo) para comeÃ§ar.";
            }
            try {
                const genAI = new GoogleGenerativeAI(apiKey);
                const model = genAI.getGenerativeModel({ model: modelId });
                
                const sysPrompt = `
                # IDENTIDADE: AmerIA, consultora da Ameripan.
                # CONTEXTO TÃ‰CNICO: ${CACHE.knowledge ? "DisponÃ­vel" : "Carregando..."}
                # REGRAS:
                1. Produtos: ![Nome](URL_IMAGEM).
                2. VÃ­deos: [ðŸŽ¥ Ver VÃ­deo](URL_VIDEO).
                3. Contatos: > ðŸ‘¤ **Nome** - Cargo ... [WhatsApp](link).
                4. NUNCA invente preÃ§os.
                `;

                const chatHistory = [
                    { role: "user", parts: [{ text: sysPrompt }] },
                    { role: "model", parts: [{ text: "Ok." }] },
                    ...history.slice(-8).map(h => ({
                        role: h.role === 'system_ui' ? 'user' : h.role, 
                        parts: [{ text: h.text || `CONTEXTO: ${JSON.stringify(h.products)}` }]
                    }))
                ];

                if (img) {
                    const result = await model.generateContent([
                        { text: sysPrompt + "\nAnalise a imagem." },
                        { inlineData: { mimeType: "image/jpeg", data: img.split(',')[1] } }
                    ]);
                    return result.response.text();
                } else {
                    const chat = model.startChat({ history: chatHistory });
                    const res = await chat.sendMessage(history[history.length-1].text);
                    return res.response.text();
                }
            } catch(e) {
                console.error(e);
                if(e.toString().includes("403") || e.toString().includes("API key")) return "ðŸš« **Erro de API Key:** Sua chave foi bloqueada ou Ã© invÃ¡lida. Gere uma nova no Google AI Studio e atualize nas configuraÃ§Ãµes.";
                return "âŒ Erro tÃ©cnico. Tente novamente.";
            }
        };

        const handleSend = async (txt = null, img = null) => {
          const text = txt || input;
          if ((!text.trim() && !img) || isLoading) return;
          
          const userMsg = { role: 'user', text, image: img };
          setMessages(p => [...p, userMsg]);
          setInput(''); setIsLoading(true);

          try {
            let sysMsg = null;
            if (text && text.length > 3) {
               const prods = await searchProducts(text);
               if (prods.length) {
                 sysMsg = { role: 'system_ui', products: prods.slice(0, 5) };
                 setMessages(curr => [...curr, sysMsg]);
               }
            }
            const history = [...messages, userMsg];
            if (sysMsg) history.push(sysMsg);
            const resp = await callGemini(history, img);
            setMessages(curr => [...curr, { role: 'model', text: resp }]);
            if (audioEnabled) {
                 window.speechSynthesis.cancel();
                 const u = new SpeechSynthesisUtterance(resp.replace(/[*_#]/g, ''));
                 u.lang = "pt-BR"; u.rate = 1.2;
                 window.speechSynthesis.speak(u);
            }
          } catch (e) { setMessages(curr => [...curr, { role: 'model', text: "Erro de conexÃ£o." }]); } 
          finally { setIsLoading(false); }
        };

        // Voz
        const toggleVoice = () => {
           if (!('webkitSpeechRecognition' in window)) return alert("Use Chrome para voz.");
           if (isListening) { setIsListening(false); return; }
           const rec = new window.webkitSpeechRecognition();
           rec.lang = 'pt-BR'; rec.start(); setIsListening(true);
           rec.onresult = (e) => { handleSend(e.results[0][0].transcript); setIsListening(false); };
           rec.onend = () => setIsListening(false);
        };

        const handleImg = (e) => {
          const f = e.target.files[0]; if(!f) return;
          const r = new FileReader();
          r.onloadend = () => handleSend("O que Ã© isso?", r.result);
          r.readAsDataURL(f);
        };

        if (!dataLoaded) return <div className="h-screen flex flex-col items-center justify-center bg-ameripan-blue text-white"><Loader2 className="w-12 h-12 animate-spin mb-4"/><h2 className="text-xl font-bold">AmerIA 4.0</h2></div>;

        return (
          <div className="flex flex-col h-screen bg-slate-50 relative">
            {/* HEADER */}
            <header className="bg-gradient-to-r from-blue-800 to-ameripan-blue text-white p-4 shadow-lg z-20 flex justify-between items-center">
              <div className="flex items-center gap-3">
                <div className="w-10 h-10 bg-white/10 backdrop-blur rounded-full flex items-center justify-center text-xl font-bold">A</div>
                <div><h1 className="font-bold text-lg leading-none">AmerIA</h1><span className="text-[10px] opacity-80 bg-green-400/20 px-2 rounded-full">Online</span></div>
              </div>
              <div className="flex gap-2">
                <button onClick={() => setShowSettings(true)} className="p-2 rounded-full hover:bg-white/10"><Settings size={20}/></button>
                <button onClick={() => setAudioEnabled(!audioEnabled)} className={`p-2 rounded-full ${audioEnabled ? 'bg-white/20' : 'opacity-50'}`}>{audioEnabled ? <Volume2 size={20}/> : <VolumeX size={20}/>}</button>
                <button onClick={() => setShowCart(!showCart)} className="relative p-2"><ShoppingCart size={24}/>{cart.length > 0 && <span className="absolute top-0 right-0 bg-ameripan-orange text-white text-[10px] font-bold w-5 h-5 rounded-full flex items-center justify-center">{cart.reduce((a,b)=>a+b.qtd,0)}</span>}</button>
              </div>
            </header>

            {/* CONFIG MODAL */}
            {showSettings && (
                <div className="fixed inset-0 z-50 bg-black/80 backdrop-blur flex items-center justify-center p-4">
                    <div className="bg-white w-full max-w-md rounded-2xl p-6 shadow-2xl">
                        <div className="flex justify-between items-center mb-4">
                            <h3 className="text-xl font-bold text-gray-800 flex items-center gap-2"><Settings className="text-blue-600"/> ConfiguraÃ§Ãµes</h3>
                            <button onClick={() => setShowSettings(false)} className="p-1 hover:bg-gray-100 rounded-full"><X/></button>
                        </div>
                        
                        <div className="space-y-4">
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1">API Key (Google AI Studio)</label>
                                <input 
                                    type="password" 
                                    value={apiKey} 
                                    onChange={(e) => setApiKey(e.target.value)} 
                                    className="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none text-sm"
                                    placeholder="Cole sua chave AIza..."
                                />
                                <p className="text-xs text-gray-500 mt-1">Sua chave fica salva apenas no seu navegador.</p>
                            </div>
                            
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1">Modelo de IA</label>
                                <select 
                                    value={modelId} 
                                    onChange={(e) => setModelId(e.target.value)}
                                    className="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none text-sm bg-white"
                                >
                                    {AI_MODELS.map(m => <option key={m.id} value={m.id}>{m.name}</option>)}
                                </select>
                            </div>
                            
                            <button onClick={saveSettings} className="w-full bg-blue-600 text-white py-3 rounded-xl font-bold hover:bg-blue-700 flex items-center justify-center gap-2 mt-2">
                                <Save size={18}/> Salvar e Fechar
                            </button>
                        </div>
                    </div>
                </div>
            )}

            {/* CHAT */}
            <main className="flex-1 overflow-y-auto p-4 space-y-6 pb-32 scroll-smooth" ref={messagesEndRef}>
              {messages.map((msg, idx) => (
                <div key={idx} className={`flex flex-col ${msg.role === 'user' ? 'items-end' : 'items-start'} animate-fadeIn`}>
                  {msg.text && (
                    <div className={`max-w-[90%] rounded-2xl px-5 py-3 shadow-sm text-sm leading-relaxed ${msg.role === 'user' ? 'bg-ameripan-blue text-white rounded-br-none' : 'bg-white text-gray-800 border border-gray-100 rounded-bl-none'}`}>
                      {msg.image && <img src={msg.image} className="w-full rounded-lg mb-3 max-h-60 object-cover" />}
                      <ReactMarkdown className="prose prose-sm max-w-none" components={{
                          img: ({src, alt}) => <img src={src} alt={alt} className="rounded-lg my-2 border" />,
                          a: ({href, children}) => <a href={href} target="_blank" className="text-blue-600 font-bold hover:underline">{children}</a>
                      }}>{msg.text}</ReactMarkdown>
                    </div>
                  )}
                  {msg.role === 'system_ui' && (
                    <div className="w-full mt-2 pl-2 pr-4 grid gap-2 sm:grid-cols-2">
                        {msg.products.map(p => <ProductCard key={p.SKU} product={p} onAdd={addToCart} />)}
                    </div>
                  )}
                </div>
              ))}
              {isLoading && <div className="flex gap-1 ml-4"><span className="w-2 h-2 bg-gray-400 rounded-full typing-dot"></span><span className="w-2 h-2 bg-gray-400 rounded-full typing-dot"></span><span className="w-2 h-2 bg-gray-400 rounded-full typing-dot"></span></div>}
              <div ref={messagesEndRef} />
            </main>

            {/* CARRINHO */}
            <div className={`fixed inset-0 z-50 ${showCart ? 'pointer-events-auto' : 'pointer-events-none'}`}>
              <div className={`absolute inset-0 bg-black/60 transition-opacity ${showCart ? 'opacity-100' : 'opacity-0'}`} onClick={() => setShowCart(false)} />
              <div className={`absolute right-0 bottom-0 w-full sm:w-96 bg-white h-[90vh] shadow-2xl transition-transform flex flex-col rounded-t-3xl ${showCart ? 'translate-y-0' : 'translate-y-full'}`}>
                <div className="p-5 border-b flex justify-between items-center bg-gray-50 rounded-t-3xl">
                  <h3 className="font-bold text-gray-800 flex gap-2"><ShoppingCart className="text-ameripan-orange"/> CotaÃ§Ã£o</h3>
                  <button onClick={() => setShowCart(false)}><X size={24}/></button>
                </div>
                <div className="flex-1 overflow-y-auto p-4 space-y-3">
                  {cart.length === 0 ? <p className="text-center text-gray-400 mt-20">Carrinho vazio</p> : 
                    cart.map(i => (
                      <div key={i.SKU} className="flex justify-between items-center border p-3 rounded-xl shadow-sm">
                        <div className="flex-1"><p className="font-bold text-sm line-clamp-1">{i.PRODUTO}</p><p className="text-xs text-gray-400">SKU: {i.SKU}</p></div>
                        <div className="flex items-center gap-2 bg-gray-50 rounded-lg border">
                          <button className="p-2 text-red-500" onClick={() => removeFromCart(i.SKU)}><Minus size={14}/></button>
                          <span className="text-sm font-bold w-4 text-center">{i.qtd}</span>
                          <button className="p-2 text-green-600" onClick={() => addToCart(i)}><Plus size={14}/></button>
                        </div>
                      </div>
                    ))
                  }
                </div>
                <div className="p-5 border-t bg-white"><button onClick={sendQuote} disabled={!cart.length} className="w-full bg-whatsapp text-white font-bold py-4 rounded-xl hover:brightness-90 shadow-lg flex justify-center gap-2">Enviar no WhatsApp <Send size={20}/></button></div>
              </div>
            </div>

            {/* INPUT */}
            <footer className="bg-white p-3 border-t z-20">
              <div className="max-w-4xl mx-auto flex items-end gap-2">
                <button onClick={() => fileInputRef.current.click()} className="p-3 text-gray-400 hover:text-ameripan-blue"><Camera size={24}/><input type="file" ref={fileInputRef} className="hidden" accept="image/*" onChange={handleImg}/></button>
                <div className="flex-1 bg-gray-100 rounded-2xl px-4 py-2"><textarea value={input} onChange={(e) => setInput(e.target.value)} onKeyDown={(e) => e.key === 'Enter' && !e.shiftKey && (e.preventDefault(), handleSend())} placeholder="Digite ou fale..." className="w-full bg-transparent border-none focus:ring-0 resize-none max-h-24 py-2 text-sm outline-none" rows={1}/></div>
                <button onClick={input.trim() ? () => handleSend() : toggleVoice} className={`p-3 rounded-full shadow-md text-white transition-all ${isListening ? 'bg-red-500 animate-pulse' : 'bg-ameripan-blue'}`}>{input.trim() ? <Send size={20}/> : <Mic size={20}/>}</button>
              </div>
            </footer>
          </div>
        );
      }
      const root = createRoot(document.getElementById('root'));
      root.render(<App />);
    </script>
  </body>
</html>
