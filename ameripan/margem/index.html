<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Calculadora de Margem e Markup</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #3498db;
            --secondary-color: #2ecc71;
            --danger-color: #e74c3c;
            --bg-color: #f9f9f9;
            --card-bg: #ffffff;
            --text-color: #333333;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 0;
            font-size: 16px;
        }
        
        .produto-card .form-control {
            padding: 8px 10px;
            font-size: 16px;
            height: auto;
        }
        
        .produto-card .input-group-text {
            padding: 8px 10px;
            font-size: 16px;
        }
        
        .produto-card .badge {
            font-size: 14px;
            padding: 4px 8px;
        }
        
        .produto-card label {
            font-weight: 500;
            margin-bottom: 0;
        }
        
        .produto-card .card-header {
            padding: 10px 15px;
            background-color: #3498db;
        }
        
        .produto-card .card-body {
            padding: 12px;
        }
        
        @media (max-width: 768px) {
            .mobile-table-indicator {
                display: none !important;
            }
            body {
                font-size: 14px;
            }
            
            h1 {
                font-size: 1.8rem;
            }
            
            h5 {
                font-size: 1.1rem;
            }
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
        }
        
        .card {
            background-color: var(--card-bg);
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            overflow: hidden;
            transition: transform 0.3s ease;
        }
        
        .card:hover {
            transform: translateY(-5px);
        }
        
        @media (max-width: 768px) {
            .card {
                margin-bottom: 15px;
            }
            
            .card:hover {
                transform: none;
            }
            
            .card-body {
                padding: 0.75rem;
            }
        }
        
        .card-header {
            background-color: var(--primary-color);
            color: white;
            padding: 15px;
            font-weight: bold;
        }
        
        @media (max-width: 768px) {
            .card-header {
                padding: 10px;
            }
        }
        
        .form-control {
            border-radius: 6px;
            border: 1px solid #ddd;
            padding: 10px 15px;
            margin-bottom: 15px;
            transition: all 0.3s ease;
        }
        
        .form-control:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 0.2rem rgba(52, 152, 219, 0.25);
        }
        
        @media (max-width: 768px) {
            .form-control {
                padding: 10px 12px;
                margin-bottom: 10px;
                font-size: 16px; /* Tamanho ideal para evitar zoom automático no iOS */
                height: auto;
            }
            
            .input-group-text {
                padding: 10px 12px;
                font-size: 16px;
            }
            
            .form-control-sm {
                height: auto;
                padding: 10px 12px;
                font-size: 16px;
            }
            
            /* Aumentar área de toque */
            .input-group {
                margin-bottom: 0;
            }
            
            input[type="number"] {
                -moz-appearance: textfield; /* Remove as setas em Firefox */
            }
            
            input[type="number"]::-webkit-inner-spin-button,
            input[type="number"]::-webkit-outer-spin-button {
                -webkit-appearance: none;
                margin: 0;
            }
        }
        
        .btn-primary {
            background-color: var(--primary-color);
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .btn-primary:hover {
            background-color: #2980b9;
            transform: translateY(-2px);
        }
        
        .btn-success {
            background-color: var(--secondary-color);
            border: none;
        }
        
        .btn-success:hover {
            background-color: #27ae60;
        }
        
        .btn-danger {
            background-color: var(--danger-color);
            border: none;
        }
        
        .btn-danger:hover {
            background-color: #c0392b;
        }
        
        @media (max-width: 768px) {
            .btn {
                padding: 8px 16px;
                font-size: 14px;
            }
            
            .btn-sm {
                padding: 4px 8px;
                font-size: 12px;
            }
            
            .actions .btn-sm {
                padding: 2px 5px;
                font-size: 12px;
            }
        }
        
        .table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }
        
        .table th {
            background-color: #f2f2f2;
            padding: 12px;
            text-align: left;
            font-weight: bold;
        }
        
        .table td {
            padding: 12px;
            border-bottom: 1px solid #ddd;
        }
        
        @media (max-width: 768px) {
            .table th, 
            .table td {
                padding: 8px 5px;
                font-size: 0.85rem;
            }
            
            .table-responsive {
                border: 0;
            }
        }
        
        @media (max-width: 640px) {
            /* Estilo para mesas muito pequenas (mobile) */
            .mobile-table-wrapper {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                position: relative;
            }
            
            .mobile-table-indicator {
                display: block;
                text-align: center;
                font-size: 12px;
                color: #777;
                margin-bottom: 5px;
            }
        }
        
        .product-row:hover {
            background-color: #f5f5f5;
        }
        
        .actions {
            display: flex;
            gap: 5px;
        }
        
        @media (max-width: 768px) {
            .actions {
                gap: 2px;
            }
        }
        
        .tooltip-container {
            position: relative;
            display: inline-block;
        }
        
        .tooltip-text {
            visibility: hidden;
            width: 120px;
            background-color: #555;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 5px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -60px;
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .tooltip-container:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }
        
        .badge {
            font-size: 85%;
            font-weight: normal;
            padding: 5px 8px;
            border-radius: 4px;
        }
        
        @media (max-width: 768px) {
            .badge {
                font-size: 75%;
                padding: 3px 5px;
            }
        }
        
        .summary-card {
            background-color: #f8f9fa;
            border-left: 4px solid var(--primary-color);
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 6px;
        }
        
        .summary-title {
            font-weight: bold;
            color: var(--primary-color);
            margin-bottom: 10px;
        }
        
        @media (max-width: 768px) {
            .summary-card {
                padding: 10px;
                margin-bottom: 10px;
            }
            
            .summary-title {
                font-size: 0.85rem;
                margin-bottom: 5px;
            }
            
            .summary-card h4 {
                font-size: 1.1rem;
                margin-bottom: 0;
            }
        }
        
        .text-area {
            min-height: 150px;
            font-family: monospace;
        }
        
        @media (max-width: 768px) {
            .text-area {
                min-height: 120px;
            }
        }
        
        @media (max-width: 576px) {
            /* Ajustes para telas muito pequenas */
            .col-mobile-6 {
                flex: 0 0 50%;
                max-width: 50%;
            }
            
            .col-mobile-12 {
                flex: 0 0 100%;
                max-width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="text-center my-4">Calculadora de Margem e Markup</h1>
        
        <!-- Modo de entrada -->
        <div class="card mb-4">
            <div class="card-header">
                Modo de Entrada
            </div>
            <div class="card-body">
                <div class="btn-group w-100 mb-3" role="group">
                    <button id="btn-modo-manual" class="btn btn-primary active" onclick="mudarModo('manual')">
                        <i class="fas fa-edit me-2"></i>Manual
                    </button>
                    <button id="btn-modo-colar" class="btn btn-outline-primary" onclick="mudarModo('colar')">
                        <i class="fas fa-paste me-2"></i>Colar Dados
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Dados gerais -->
        <div class="card mb-4">
            <div class="card-header">
                Dados Gerais
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4 col-sm-6 col-12 mb-2">
                        <div class="mb-3">
                            <label for="vendedor" class="form-label">Vendedor:</label>
                            <input type="text" class="form-control" id="vendedor" placeholder="Nome do vendedor">
                        </div>
                    </div>
                    <div class="col-md-4 col-sm-6 col-12 mb-2">
                        <div class="mb-3">
                            <label for="codCliente" class="form-label">Código do Cliente:</label>
                            <input type="text" class="form-control" id="codCliente" placeholder="Código do cliente">
                        </div>
                    </div>
                    <div class="col-md-4 col-sm-6 col-12 mb-2">
                        <div class="mb-3">
                            <label for="codPedido" class="form-label">Código do Pedido:</label>
                            <input type="text" class="form-control" id="codPedido" placeholder="Código do pedido">
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Área de colagem -->
        <div id="area-colar" class="card mb-4" style="display: none;">
            <div class="card-header">
                Colar Dados
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label for="dados-colados" class="form-label">Cole os dados do pedido abaixo:</label>
                    <textarea class="form-control text-area" id="dados-colados" rows="8" placeholder="Cole aqui os dados como no exemplo..."></textarea>
                </div>
                <button class="btn btn-primary" onclick="processarDadosColados()">
                    <i class="fas fa-magic me-2"></i>Processar Dados
                </button>
            </div>
        </div>
        
        <!-- Produtos -->
        <div id="area-produtos" class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span>Produtos</span>
                <button class="btn btn-sm btn-success" onclick="adicionarProduto()">
                    <i class="fas fa-plus me-1"></i>Adicionar Produto
                </button>
            </div>
            <div class="card-body">
                <div class="mobile-table-wrapper">
                    <div class="mobile-table-indicator d-md-none">
                        <i class="fas fa-arrows-left-right"></i> Deslize para ver mais
                    </div>
                    
                    <!-- Tabela para telas médias e grandes -->
                    <div class="table-responsive d-none d-md-block">
                        <table class="table" id="tabela-produtos">
                            <thead>
                                <tr>
                                    <th width="15%">Código</th>
                                    <th width="10%">Qtde</th>
                                    <th width="15%">Valor Un.</th>
                                    <th width="15%">Custo Un.</th>
                                    <th width="10%">Total</th>
                                    <th width="10%">Margem</th>
                                    <th width="10%">Markup</th>
                                    <th width="15%">Ações</th>
                                </tr>
                            </thead>
                            <tbody id="lista-produtos-desktop">
                                <!-- Produtos serão adicionados aqui para desktop -->
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Layout alternativo para dispositivos móveis -->
                    <div class="d-md-none" id="lista-produtos-mobile">
                        <!-- Produtos serão adicionados aqui para mobile em formato de cards -->
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Totais -->
        <div class="card mb-4">
            <div class="card-header">
                Totais e Indicadores
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-6 col-md-3 mb-2">
                        <div class="summary-card">
                            <div class="summary-title">Total de Itens</div>
                            <h4 id="total-itens">0</h4>
                        </div>
                    </div>
                    <div class="col-6 col-md-3 mb-2">
                        <div class="summary-card">
                            <div class="summary-title">Total de Venda</div>
                            <h4 id="total-venda">R$ 0,00</h4>
                        </div>
                    </div>
                    <div class="col-6 col-md-3 mb-2">
                        <div class="summary-card">
                            <div class="summary-title">Margem Média</div>
                            <h4 id="margem-media">0,00%</h4>
                        </div>
                    </div>
                    <div class="col-6 col-md-3 mb-2">
                        <div class="summary-card">
                            <div class="summary-title">Markup Médio</div>
                            <h4 id="markup-medio">0,00%</h4>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Botão WhatsApp -->
        <div class="card mb-4">
            <div class="card-header">
                Compartilhar
            </div>
            <div class="card-body">
                <button class="btn btn-success w-100" onclick="compartilharWhatsApp()">
                    <i class="fab fa-whatsapp me-2"></i>Enviar para WhatsApp
                </button>
            </div>
        </div>
        
        <!-- Explicação sobre margem e markup -->
        <div class="card mb-4">
            <div class="card-header">
                Explicação sobre Margem e Markup
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6 col-sm-12 mb-3">
                        <h5>Margem de Lucro</h5>
                        <p>A margem de lucro é a porcentagem de lucro em relação ao valor de venda.</p>
                        <div class="alert alert-info">
                            <strong>Fórmula:</strong> Margem (%) = (Preço de Venda - Custo) ÷ Preço de Venda × 100
                        </div>
                        <h6>Exemplo:</h6>
                        <ul>
                            <li>Preço de Venda: R$ 100,00</li>
                            <li>Custo: R$ 70,00</li>
                            <li>Margem: (100 - 70) ÷ 100 × 100 = 30%</li>
                        </ul>
                        <p>Uma margem de 30% significa que 30% do preço de venda é lucro.</p>
                    </div>
                    <div class="col-md-6 col-sm-12 mb-3">
                        <h5>Markup</h5>
                        <p>O markup é a porcentagem que você adiciona ao custo para obter o preço de venda.</p>
                        <div class="alert alert-info">
                            <strong>Fórmula:</strong> Markup (%) = (Preço de Venda - Custo) ÷ Custo × 100
                        </div>
                        <h6>Exemplo:</h6>
                        <ul>
                            <li>Preço de Venda: R$ 100,00</li>
                            <li>Custo: R$ 70,00</li>
                            <li>Markup: (100 - 70) ÷ 70 × 100 = 42,86%</li>
                        </ul>
                        <p>Um markup de 42,86% significa que você adicionou 42,86% sobre o custo para definir o preço.</p>
                    </div>
                </div>
                <hr>
                <div class="alert alert-warning">
                    <strong>Dica:</strong> Para calcular o preço de venda a partir do custo e do markup desejado, use:<br>
                    Preço de Venda = Custo × (1 + Markup/100)
                </div>
                <div class="alert alert-warning">
                    <strong>Dica:</strong> Para calcular o preço de venda a partir do custo e da margem desejada, use:<br>
                    Preço de Venda = Custo ÷ (1 - Margem/100)
                </div>
                
                <!-- Legenda das cores -->
                <h5 class="mt-4">Legenda das Cores</h5>
                <p>As cores das margens e markup indicam a saúde financeira do produto:</p>
                <div class="row">
                    <div class="col-md-4 col-sm-12 mb-2">
                        <div class="card">
                            <div class="card-body p-2 d-flex align-items-center">
                                <span class="badge bg-danger me-2">12.5%</span>
                                <span><strong>Vermelho</strong>: Abaixo de 15% - Margem crítica, pode não cobrir custos operacionais</span>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4 col-sm-12 mb-2">
                        <div class="card">
                            <div class="card-body p-2 d-flex align-items-center">
                                <span class="badge bg-warning me-2">25.0%</span>
                                <span><strong>Amarelo</strong>: Entre 15% e 30% - Margem aceitável, mas com espaço para melhoria</span>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4 col-sm-12 mb-2">
                        <div class="card">
                            <div class="card-body p-2 d-flex align-items-center">
                                <span class="badge bg-success me-2">35.0%</span>
                                <span><strong>Verde</strong>: Acima de 30% - Margem saudável, bom retorno sobre o investimento</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // Variáveis globais
        let produtos = [];
        let modoAtual = 'manual';
        
        // Inicialização
        document.addEventListener('DOMContentLoaded', function() {
            // Adicionar um produto vazio ao iniciar
            adicionarProduto();
            
            // Configurar evento para dados colados
            document.getElementById('dados-colados').addEventListener('input', function() {
                // Auto-processar após um pequeno delay quando texto é colado
                setTimeout(processarDadosColados, 300);
            });
            
            // Configurar navegação por Enter nos campos gerais
            configNavegacaoPorEnter('vendedor', 'codCliente');
            configNavegacaoPorEnter('codCliente', 'codPedido');
            // O último campo configureamos para ir para o primeiro campo do primeiro produto
            configNavegacaoPorEnter('codPedido', function() {
                // Buscar o primeiro campo de código (se existir)
                const primeiroCodigoInput = document.querySelector('.produto-card input') || 
                                           document.querySelector('#lista-produtos-desktop input');
                if (primeiroCodigoInput) {
                    primeiroCodigoInput.focus();
                }
            });
        });
        
        // Configurar navegação por Enter
        function configNavegacaoPorEnter(campoAtualId, proximoCampoIdOuCallback) {
            const campoAtual = document.getElementById(campoAtualId);
            if (!campoAtual) return;
            
            campoAtual.addEventListener('keydown', function(e) {
                // Verifica se a tecla pressionada foi Enter
                if (e.key === 'Enter') {
                    e.preventDefault(); // Previne o comportamento padrão
                    
                    // Se for uma função, chama a função
                    if (typeof proximoCampoIdOuCallback === 'function') {
                        proximoCampoIdOuCallback();
                    } 
                    // Se for uma string (ID), foca no elemento
                    else {
                        const proximoCampo = document.getElementById(proximoCampoIdOuCallback);
                        if (proximoCampo) {
                            proximoCampo.focus();
                        }
                    }
                }
            });
        }
        
        // Navegação por Enter em campos de produtos
        function configNavegacaoPorEnterEmProduto(inputElement, produto) {
            if (!inputElement) return;
            
            inputElement.addEventListener('keydown', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    
                    // Buscar todos os inputs do produto
                    const produtoContainer = this.closest('.produto-card') || this.closest('tr');
                    if (!produtoContainer) return;
                    
                    const inputs = Array.from(produtoContainer.querySelectorAll('input'));
                    const currentIndex = inputs.indexOf(this);
                    
                    if (currentIndex !== -1 && currentIndex < inputs.length - 1) {
                        // Passar para o próximo campo
                        inputs[currentIndex + 1].focus();
                    } else if (currentIndex === inputs.length - 1) {
                        // Se for o último campo deste produto, verificar se há produtos depois
                        const produtos = document.querySelectorAll('.produto-card, #lista-produtos-desktop tr');
                        const produtoIndex = Array.from(produtos).indexOf(produtoContainer);
                        
                        if (produtoIndex !== -1 && produtoIndex < produtos.length - 1) {
                            // Há um próximo produto, focar no primeiro campo
                            const proximoProduto = produtos[produtoIndex + 1];
                            const proximoInput = proximoProduto.querySelector('input');
                            if (proximoInput) {
                                proximoInput.focus();
                            }
                        } else {
                            // É o último produto, adicionar novo produto e focar nele
                            adicionarProduto();
                            // Aguardar um pouco para o novo produto ser renderizado
                            setTimeout(() => {
                                const novoInput = document.querySelector('.produto-card:last-child input, #lista-produtos-desktop tr:last-child input');
                                if (novoInput) {
                                    novoInput.focus();
                                }
                            }, 50);
                        }
                    }
                }
            });
        }
        
        // Alternar entre modos
        function mudarModo(modo) {
            modoAtual = modo;
            
            // Atualizar botões
            document.getElementById('btn-modo-manual').classList.remove('active');
            document.getElementById('btn-modo-manual').classList.add('btn-outline-primary');
            document.getElementById('btn-modo-colar').classList.remove('active');
            document.getElementById('btn-modo-colar').classList.add('btn-outline-primary');
            
            if (modo === 'manual') {
                document.getElementById('btn-modo-manual').classList.add('active');
                document.getElementById('btn-modo-manual').classList.remove('btn-outline-primary');
                document.getElementById('area-colar').style.display = 'none';
                document.getElementById('area-produtos').style.display = 'block';
            } else {
                document.getElementById('btn-modo-colar').classList.add('active');
                document.getElementById('btn-modo-colar').classList.remove('btn-outline-primary');
                document.getElementById('area-colar').style.display = 'block';
                document.getElementById('area-produtos').style.display = 'none';
            }
        }
        
        // Adicionar um novo produto
        function adicionarProduto() {
            const novoProduto = {
                id: Date.now(),
                codigo: '',
                quantidade: '',
                valor: '',
                custo: ''
            };
            
            produtos.push(novoProduto);
            renderizarProdutos();
            calcularTotais();
        }
        
        // Remover um produto
        function removerProduto(id) {
            produtos = produtos.filter(p => p.id !== id);
            renderizarProdutos();
            calcularTotais();
        }
        
        // Atualizar dados de um produto
        function atualizarProduto(id, campo, valor) {
            const produto = produtos.find(p => p.id === id);
            if (produto) {
                if (campo === 'quantidade' || campo === 'valor' || campo === 'custo') {
                    // Se o campo estiver vazio, armazenar como string vazia em vez de 0
                    produto[campo] = valor === '' ? '' : parseFloat(valor) || 0;
                } else {
                    produto[campo] = valor;
                }
                
                // Calcular valores para este produto específico
                // Tratar campos vazios como zero para cálculos
                const quantidade = produto.quantidade === '' ? 0 : produto.quantidade;
                const valorUnitario = produto.valor === '' ? 0 : produto.valor;
                const custoUnitario = produto.custo === '' ? 0 : produto.custo;
                
                const total = (quantidade * valorUnitario).toFixed(2);
                const margem = valorUnitario > 0 ? ((valorUnitario - custoUnitario) / valorUnitario * 100).toFixed(2) : '0.00';
                const markup = custoUnitario > 0 ? ((valorUnitario - custoUnitario) / custoUnitario * 100).toFixed(2) : '0.00';
                
                // Atualizar apenas os elementos visuais deste produto sem re-renderizar tudo
                atualizarVisualizacaoProduto(id, total, margem, markup);
                
                // Recalcular totais gerais
                calcularTotais();
            }
        }
        
        // Atualizar apenas os elementos visuais de um produto específico
        function atualizarVisualizacaoProduto(id, total, margem, markup) {
            // Atualizar versão desktop
            const produtoDesktop = document.querySelector(`#produto-desktop-${id}`);
            if (produtoDesktop) {
                produtoDesktop.querySelector('.total-value').textContent = `R$ ${total}`;
                
                const margemBadge = produtoDesktop.querySelector('.margem-badge');
                margemBadge.textContent = `${margem}%`;
                margemBadge.className = `badge margem-badge ${getBadgeClass(margem)}`;
                
                const markupBadge = produtoDesktop.querySelector('.markup-badge');
                markupBadge.textContent = `${markup}%`;
                markupBadge.className = `badge markup-badge ${getBadgeClass(markup)}`;
            }
            
            // Atualizar versão mobile
            const produtoMobile = document.querySelector(`#produto-mobile-${id}`);
            if (produtoMobile) {
                produtoMobile.querySelector('.total-value').textContent = `R$ ${total}`;
                
                const margemBadge = produtoMobile.querySelector('.margem-badge');
                margemBadge.textContent = `${margem}%`;
                margemBadge.className = `badge margem-badge ${getBadgeClass(margem)} ms-2`;
                
                const markupBadge = produtoMobile.querySelector('.markup-badge');
                markupBadge.textContent = `${markup}%`;
                markupBadge.className = `badge markup-badge ${getBadgeClass(markup)} ms-2`;
            }
        }
        
        // Renderizar lista de produtos
        function renderizarProdutos() {
            // Renderizar para desktop
            const listaDesktop = document.getElementById('lista-produtos-desktop');
            
            if (listaDesktop) {
                listaDesktop.innerHTML = '';
                
                produtos.forEach(produto => {
                    const total = (produto.quantidade * produto.valor).toFixed(2);
                    const margem = produto.valor > 0 ? ((produto.valor - produto.custo) / produto.valor * 100).toFixed(2) : '0.00';
                    const markup = produto.custo > 0 ? ((produto.valor - produto.custo) / produto.custo * 100).toFixed(2) : '0.00';
                    
                    const tr = document.createElement('tr');
                    tr.className = 'product-row';
                    tr.id = `produto-desktop-${produto.id}`;
                    tr.innerHTML = `
                        <td>
                            <input type="text" class="form-control form-control-sm" value="${produto.codigo}" 
                                oninput="atualizarProduto(${produto.id}, 'codigo', this.value)"
                                onchange="atualizarProduto(${produto.id}, 'codigo', this.value)">
                        </td>
                        <td>
                            <input type="number" min="1" class="form-control form-control-sm" value="${produto.quantidade}" 
                                oninput="atualizarProduto(${produto.id}, 'quantidade', this.value)"
                                onchange="atualizarProduto(${produto.id}, 'quantidade', this.value)">
                        </td>
                        <td>
                            <div class="input-group input-group-sm">
                                <span class="input-group-text">R$</span>
                                <input type="number" step="0.01" min="0" class="form-control form-control-sm" value="${produto.valor}" 
                                    oninput="atualizarProduto(${produto.id}, 'valor', this.value)"
                                    onchange="atualizarProduto(${produto.id}, 'valor', this.value)">
                            </div>
                        </td>
                        <td>
                            <div class="input-group input-group-sm">
                                <span class="input-group-text">R$</span>
                                <input type="number" step="0.01" min="0" class="form-control form-control-sm" value="${produto.custo}" 
                                    oninput="atualizarProduto(${produto.id}, 'custo', this.value)"
                                    onchange="atualizarProduto(${produto.id}, 'custo', this.value)">
                            </div>
                        </td>
                        <td class="text-nowrap total-value">R$ ${total}</td>
                        <td>
                            <span class="badge margem-badge ${getBadgeClass(margem)}">${margem}%</span>
                        </td>
                        <td>
                            <span class="badge markup-badge ${getBadgeClass(markup)}">${markup}%</span>
                        </td>
                        <td>
                            <div class="actions">
                                <button class="btn btn-sm btn-danger" onclick="removerProduto(${produto.id})" aria-label="Remover">
                                    <i class="fas fa-trash"></i>
                                </button>
                                <button class="btn btn-sm btn-primary" onclick="duplicarProduto(${produto.id})" aria-label="Duplicar">
                                    <i class="fas fa-copy"></i>
                                </button>
                            </div>
                        </td>
                    `;
                    
                    // Configurar navegação por Enter nos campos
                    listaDesktop.appendChild(tr);
                    const inputs = tr.querySelectorAll('input');
                    inputs.forEach(input => {
                        configNavegacaoPorEnterEmProduto(input, produto);
                    });
                    listaDesktop.appendChild(tr);
                });
            }
            
            // Renderizar para mobile
            const listaMobile = document.getElementById('lista-produtos-mobile');
            
            if (listaMobile) {
                listaMobile.innerHTML = '';
                
                produtos.forEach(produto => {
                    const total = (produto.quantidade * produto.valor).toFixed(2);
                    const margem = produto.valor > 0 ? ((produto.valor - produto.custo) / produto.valor * 100).toFixed(2) : '0.00';
                    const markup = produto.custo > 0 ? ((produto.valor - produto.custo) / produto.custo * 100).toFixed(2) : '0.00';
                    
                    const card = document.createElement('div');
                    card.className = 'card mb-3 produto-card';
                    card.id = `produto-mobile-${produto.id}`;
                    card.innerHTML = `
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <span>Produto</span>
                            <div class="actions">
                                <button class="btn btn-sm btn-danger me-1" onclick="removerProduto(${produto.id})" aria-label="Remover">
                                    <i class="fas fa-trash"></i>
                                </button>
                                <button class="btn btn-sm btn-primary" onclick="duplicarProduto(${produto.id})" aria-label="Duplicar">
                                    <i class="fas fa-copy"></i>
                                </button>
                            </div>
                        </div>
                        <div class="card-body pb-2">
                            <div class="mb-2 row align-items-center">
                                <label class="col-4 col-form-label">Código:</label>
                                <div class="col-8">
                                    <input type="text" class="form-control" value="${produto.codigo}" 
                                        oninput="atualizarProduto(${produto.id}, 'codigo', this.value)"
                                        onchange="atualizarProduto(${produto.id}, 'codigo', this.value)">
                                </div>
                            </div>
                            <div class="mb-2 row align-items-center">
                                <label class="col-4 col-form-label">Quantidade:</label>
                                <div class="col-8">
                                    <input type="number" min="1" class="form-control" value="${produto.quantidade}" 
                                        oninput="atualizarProduto(${produto.id}, 'quantidade', this.value)"
                                        onchange="atualizarProduto(${produto.id}, 'quantidade', this.value)">
                                </div>
                            </div>
                            <div class="mb-2 row align-items-center">
                                <label class="col-4 col-form-label">Valor Un.:</label>
                                <div class="col-8">
                                    <div class="input-group">
                                        <span class="input-group-text">R$</span>
                                        <input type="number" step="0.01" min="0" class="form-control" value="${produto.valor}" 
                                            oninput="atualizarProduto(${produto.id}, 'valor', this.value)"
                                            onchange="atualizarProduto(${produto.id}, 'valor', this.value)">
                                    </div>
                                </div>
                            </div>
                            <div class="mb-2 row align-items-center">
                                <label class="col-4 col-form-label">Custo Un.:</label>
                                <div class="col-8">
                                    <div class="input-group">
                                        <span class="input-group-text">R$</span>
                                        <input type="number" step="0.01" min="0" class="form-control" value="${produto.custo}" 
                                            oninput="atualizarProduto(${produto.id}, 'custo', this.value)"
                                            onchange="atualizarProduto(${produto.id}, 'custo', this.value)">
                                    </div>
                                </div>
                            </div>
                            <div class="row mb-2">
                                <div class="col-6">
                                    <div class="fw-bold d-inline-block">Total:</div>
                                    <div class="d-inline-block ms-2 total-value">R$ ${total}</div>
                                </div>
                                <div class="col-6">
                                    <div class="fw-bold d-inline-block">Margem:</div>
                                    <span class="badge margem-badge ${getBadgeClass(margem)} ms-2">${margem}%</span>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-12">
                                    <div class="fw-bold d-inline-block">Markup:</div>
                                    <span class="badge markup-badge ${getBadgeClass(markup)} ms-2">${markup}%</span>
                                </div>
                            </div>
                        </div>
                    `;
                    listaMobile.appendChild(card);
                    const inputs = card.querySelectorAll('input');
                    inputs.forEach(input => {
                        configNavegacaoPorEnterEmProduto(input, produto);
                    });
                });
            }
        }
        
        // Duplicar um produto
        function duplicarProduto(id) {
            const produto = produtos.find(p => p.id === id);
            if (produto) {
                const novoProduto = { ...produto, id: Date.now() };
                produtos.push(novoProduto);
                renderizarProdutos();
                calcularTotais();
            }
        }
        
        // Calcular totais e indicadores
        function calcularTotais() {
            // Tratar valores vazios como zero para cálculos
            const totalItens = produtos.reduce((sum, p) => {
                const quantidade = p.quantidade === '' ? 0 : p.quantidade;
                return sum + quantidade;
            }, 0);
            
            const totalVenda = produtos.reduce((sum, p) => {
                const quantidade = p.quantidade === '' ? 0 : p.quantidade;
                const valor = p.valor === '' ? 0 : p.valor;
                return sum + (quantidade * valor);
            }, 0);
            
            const totalCusto = produtos.reduce((sum, p) => {
                const quantidade = p.quantidade === '' ? 0 : p.quantidade;
                const custo = p.custo === '' ? 0 : p.custo;
                return sum + (quantidade * custo);
            }, 0);
            
            let margemMedia = 0;
            let markupMedio = 0;
            
            if (totalVenda > 0) {
                margemMedia = ((totalVenda - totalCusto) / totalVenda * 100);
            }
            
            if (totalCusto > 0) {
                markupMedio = ((totalVenda - totalCusto) / totalCusto * 100);
            }
            
            // Atualizar elementos
            document.getElementById('total-itens').textContent = totalItens;
            document.getElementById('total-venda').textContent = `R$ ${totalVenda.toFixed(2)}`;
            document.getElementById('margem-media').textContent = `${margemMedia.toFixed(2)}%`;
            document.getElementById('markup-medio').textContent = `${markupMedio.toFixed(2)}%`;
        }
        
        // Obter classe para badge baseado no valor
        function getBadgeClass(valor) {
            const num = parseFloat(valor);
            if (num < 15) return 'bg-danger';
            if (num < 30) return 'bg-warning';
            return 'bg-success';
        }
        
        // Processar dados colados
        function processarDadosColados() {
            const dadosColados = document.getElementById('dados-colados').value;
            if (!dadosColados.trim()) return;
            
            // Limpar produtos existentes
            produtos = [];
            
            // Extrair dados gerais - Vendedor
            const vendedorMatch = dadosColados.match(/Vendedor[a]?[\s:]*([^\n\r]*)/i);
            if (vendedorMatch && vendedorMatch[1]) {
                document.getElementById('vendedor').value = vendedorMatch[1].trim();
            }
            
            // Extrair Código do Cliente (mais formatos)
            const clientePatterns = [
                /C[oó]d[igo]*\s*cliente[\s:]*([0-9]+)/i,
                /Cliente[\s:]*([0-9]+)/i,
                /Cliente:([0-9]+)/i,
                /Cliente[\s-]*:[\s-]*([0-9]+)/i
            ];
            
            for (const pattern of clientePatterns) {
                const match = dadosColados.match(pattern);
                if (match && match[1]) {
                    document.getElementById('codCliente').value = match[1].trim();
                    break;
                }
            }
            
            // Extrair Código do Pedido (mais formatos)
            const pedidoPatterns = [
                /C[oó]d[igo]*\s*pedido[\s:]*([0-9]+)/i,
                /Pedido[\s:]*([0-9]+)/i,
                /Pedido:([0-9]+)/i,
                /Pedido[\s-]*:[\s-]*([0-9]+)/i
            ];
            
            for (const pattern of pedidoPatterns) {
                const match = dadosColados.match(pattern);
                if (match && match[1]) {
                    document.getElementById('codPedido').value = match[1].trim();
                    break;
                }
            }
            
            // Extrair produtos linha por linha para evitar duplicação
            const linhas = dadosColados.split('\n');
            const produtosEncontrados = new Set(); // Para evitar duplicação
            
            linhas.forEach(linha => {
                // Verificar diferentes padrões em cada linha individualmente
                let produtoEncontrado = false;
                
                // Padrão 1: Código X quantidade Y preço Z
                const pattern1 = /C[oó]digo\s+(\d+)\s+quantidade\s+(\d+)\s+(?:pre[çc]o|valor)\s+([0-9,.]+)/i;
                let match = linha.match(pattern1);
                if (match && !produtoEncontrado) {
                    const codigo = match[1].trim();
                    const quantidade = parseInt(match[2].trim()) || 1;
                    const valor = parseFloat(match[3].replace(',', '.')) || 0;
                    
                    // Chave única para identificar produto
                    const produtoKey = `${codigo}-${quantidade}-${valor}`;
                    
                    if (!produtosEncontrados.has(produtoKey) && codigo && quantidade && valor) {
                        produtos.push({
                            id: Date.now() + Math.floor(Math.random() * 1000),
                            codigo,
                            quantidade,
                            valor,
                            custo: 0
                        });
                        produtosEncontrados.add(produtoKey);
                        produtoEncontrado = true;
                    }
                }
                
                // Padrão 2: Cód X Y unidades R$ Z
                const pattern2 = /C[oó]d(?:igo)?[\s:]*(\d+)[\s].*?(\d+)\s*(?:unidades?|un).*?[R$\s]*([0-9,.]+)/i;
                match = linha.match(pattern2);
                if (match && !produtoEncontrado) {
                    const codigo = match[1].trim();
                    const quantidade = parseInt(match[2].trim()) || 1;
                    const valor = parseFloat(match[3].replace(',', '.')) || 0;
                    
                    // Chave única para identificar produto
                    const produtoKey = `${codigo}-${quantidade}-${valor}`;
                    
                    if (!produtosEncontrados.has(produtoKey) && codigo && quantidade && valor) {
                        produtos.push({
                            id: Date.now() + Math.floor(Math.random() * 1000),
                            codigo,
                            quantidade,
                            valor,
                            custo: 0
                        });
                        produtosEncontrados.add(produtoKey);
                        produtoEncontrado = true;
                    }
                }
                
                // Padrão 3: prod X quant Y R$ Z
                const pattern3 = /prod(?:uto)?[\s-:]*(\d+)[\s].*?quant[\s-:]*(\d+)[\s].*?[R$\s]*([0-9,.]+)/i;
                match = linha.match(pattern3);
                if (match && !produtoEncontrado) {
                    const codigo = match[1].trim();
                    const quantidade = parseInt(match[2].trim()) || 1;
                    const valor = parseFloat(match[3].replace(',', '.')) || 0;
                    
                    // Chave única para identificar produto
                    const produtoKey = `${codigo}-${quantidade}-${valor}`;
                    
                    if (!produtosEncontrados.has(produtoKey) && codigo && quantidade && valor) {
                        produtos.push({
                            id: Date.now() + Math.floor(Math.random() * 1000),
                            codigo,
                            quantidade,
                            valor,
                            custo: 0
                        });
                        produtosEncontrados.add(produtoKey);
                        produtoEncontrado = true;
                    }
                }
                
                // Se nenhum padrão específico foi encontrado, tente um padrão mais simples
                if (!produtoEncontrado) {
                    // Detectar código, quantidade e valor em uma linha
                    const codigoMatch = linha.match(/\b(\d+)\b/);
                    
                    // Tentar encontrar uma quantidade - com prioridade para padrões com "quantidade"
                    const qtdPriority = linha.match(/quant(?:idade)?[\s:]*(\d+)/i);
                    const qtdSecondary = linha.match(/\b(\d+)\s*(?:unidades?|un|pçs?|qt|quant)/i);
                    const qtdMatch = qtdPriority || qtdSecondary;
                    
                    // Tentar encontrar um valor monetário
                    const valorMatch = linha.match(/[R$\s]*([0-9]+[,.][0-9]+)/);
                    
                    if (codigoMatch && qtdMatch && valorMatch) {
                        const codigo = codigoMatch[1].trim();
                        const quantidade = parseInt(qtdMatch[1].trim()) || 1;
                        const valor = parseFloat(valorMatch[1].replace(',', '.')) || 0;
                        
                        // Chave única para identificar produto
                        const produtoKey = `${codigo}-${quantidade}-${valor}`;
                        
                        if (!produtosEncontrados.has(produtoKey) && codigo && quantidade && valor) {
                            produtos.push({
                                id: Date.now() + Math.floor(Math.random() * 1000),
                                codigo,
                                quantidade,
                                valor,
                                custo: 0
                            });
                            produtosEncontrados.add(produtoKey);
                        }
                    }
                }
            });
            
            // Se encontramos produtos, mudamos para o modo manual e exibimos os produtos
            if (produtos.length > 0) {
                mudarModo('manual');
                renderizarProdutos();
                calcularTotais();
            }
        }
        
        // Compartilhar via WhatsApp
        function compartilharWhatsApp() {
            const vendedor = document.getElementById('vendedor').value;
            const codCliente = document.getElementById('codCliente').value;
            const codPedido = document.getElementById('codPedido').value;
            
            // Construir mensagem (sem incluir custo ou margens)
            let mensagem = `*Pedido #${codPedido || 'N/A'}*\n`;
            mensagem += `Vendedor: ${vendedor || 'N/A'}\n`;
            mensagem += `Cliente: ${codCliente || 'N/A'}\n\n`;
            mensagem += `*Produtos:*\n`;
            
            produtos.forEach((produto, index) => {
                mensagem += `${index + 1}. Cód: ${produto.codigo} - ${produto.quantidade} un. x R$ ${produto.valor.toFixed(2)} = R$ ${(produto.quantidade * produto.valor).toFixed(2)}\n`;
            });
            
            const totalItens = produtos.reduce((sum, p) => sum + p.quantidade, 0);
            const totalVenda = produtos.reduce((sum, p) => sum + (p.quantidade * p.valor), 0);
            
            mensagem += `\n*Total:* ${totalItens} itens - R$ ${totalVenda.toFixed(2)}`;
            
            // Codificar a mensagem para URL
            const mensagemCodificada = encodeURIComponent(mensagem);
            
            // Abrir WhatsApp Web
            window.open(`https://wa.me/?text=${mensagemCodificada}`, '_blank');
        }
    </script>
</body>
</html>
