<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Análise de Cotações - Ameripan</title>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        /* --- CSS BASE --- */
        :root {
            --primary: #1e88e5;      /* Azul Ameripan */
            --secondary: #26a69a;    /* Verde (Sucesso) */
            --warning: #ff9800;     /* Amarelo */
            --danger: #e53935;      /* Vermelho (Perda) */
            --info: #0dcaf0;       
            --dark: #212121;
            --light: #f5f5f5;
            --header-height: 60px;
            --sidebar-width: 240px;
            --sidebar-transition: margin-left 0.3s ease, width 0.3s ease;
        }
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        body {
            background-color: #f0f2f5;
            color: #333;
        }
        header {
            height: var(--header-height);
            background-color: var(--primary);
            color: white;
            display: flex;
            align-items: center;
            padding: 0 20px;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 100;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .sidebar-toggle {
            font-size: 20px;
            margin-right: 15px;
            cursor: pointer;
            padding: 5px;
        }
        header h1 {
            font-size: 1.5rem;
            margin-left: 5px;
        }
        .sidebar {
            position: fixed;
            top: var(--header-height);
            left: 0;
            width: var(--sidebar-width);
            height: calc(100vh - var(--header-height));
            background-color: white;
            box-shadow: 2px 0 5px rgba(0,0,0,0.1);
            padding: 20px 0;
            overflow-y: auto;
            z-index: 99;
            transition: var(--sidebar-transition);
        }
        .sidebar ul {
            list-style-type: none;
        }
        .sidebar li {
            padding: 12px 20px;
            cursor: pointer;
            transition: background-color 0.2s;
            display: flex;
            align-items: center;
            font-size: 14px;
            white-space: nowrap;
            overflow: hidden;
        }
        .sidebar li:hover {
            background-color: rgba(0,0,0,0.05);
        }
        .sidebar li.active {
            background-color: rgba(30, 136, 229, 0.1);
            border-left: 4px solid var(--primary);
            color: var(--primary);
            font-weight: 600;
        }
        .sidebar li i {
            margin-right: 12px;
            width: 20px;
            text-align: center;
            font-size: 1.1em;
        }
        .main-content {
            margin-left: var(--sidebar-width);
            margin-top: var(--header-height);
            padding: 20px;
            min-height: calc(100vh - var(--header-height));
            transition: var(--sidebar-transition);
        }
        
        body.sidebar-collapsed .sidebar {
            width: 0;
            padding: 20px 0;
            overflow: hidden;
        }
        body.sidebar-collapsed .main-content {
            margin-left: 0;
        }
        
        .dashboard-section {
            display: none;
        }
        .dashboard-section.active {
            display: block;
        }

        /* --- Módulo de Filtros --- */
        .filter-container {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
            align-items: flex-end;
        }
        .filter-item {
            display: flex;
            flex-direction: column;
            min-width: 150px;
        }
        .filter-item label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #555;
            font-size: 13px;
        }
        .filter-item select,
        .filter-item input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
            transition: background-color 0.2s;
            font-size: 14px;
        }
        .btn-primary {
            background-color: var(--primary);
            color: white;
        }
        .btn-primary:hover {
            background-color: #1976d2;
        }
        
        /* --- Cards --- */
        .card {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            overflow: hidden;
        }
        .card-header {
            padding: 15px 20px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .card-header h2 {
            font-size: 1.25rem;
            color: #333;
            margin: 0;
        }
        .card-body {
            padding: 20px;
        }
        .card-description {
            margin-bottom: 15px; 
            font-size: 14px; 
            color: #666;
        }

        /* --- KPIs --- */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        .stat-card {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            padding: 20px;
            display: flex;
            flex-direction: column;
        }
        .stat-card-header {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }
        .stat-card-icon {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 12px;
            font-size: 1.2em;
        }
        .stat-card-title {
            color: #777;
            font-size: 14px;
            font-weight: 600;
            margin: 0;
            text-transform: uppercase;
        }
        .stat-card-value {
            font-size: 28px;
            font-weight: 700;
            margin: 0;
            color: var(--dark);
        }
        .bg-blue { background-color: rgba(30, 136, 229, 0.1); color: var(--primary); }
        .bg-green { background-color: rgba(38, 166, 154, 0.1); color: var(--secondary); }
        .bg-orange { background-color: rgba(255, 152, 0, 0.1); color: var(--warning); }
        .bg-red { background-color: rgba(229, 57, 53, 0.1); color: var(--danger); }
        
        .kpi-value.loss { color: var(--danger); }
        .kpi-value.margin-good { color: var(--secondary); }
        .kpi-value.margin-warn { color: var(--warning); }
        .kpi-value.margin-bad { color: var(--danger); }

        /* --- Gráficos e Tabelas --- */
        .chart-container { position: relative; height: 350px; width: 100%; }
        .chart-container-large { position: relative; height: 450px; width: 100%; }
        .table-responsive { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; }
        table th, table td { 
            padding: 12px 15px; 
            text-align: left; 
            border-bottom: 1px solid #eee; 
            font-size: 14px; 
            white-space: nowrap;
        }
        table th { 
            font-weight: 600; 
            color: #555; 
            background-color: #f9f9f9; 
            cursor: pointer;
            position: relative;
        }
        table tr:last-child td { border-bottom: none; }
        table tr:hover { background-color: #f5f5f5; }
        
        table th .sort-icon {
            font-family: "Font Awesome 6 Free";
            font-weight: 900;
            font-size: 0.8em;
            margin-left: 5px;
            color: #aaa;
        }
        table th.sorted-asc .sort-icon::before { content: "\f0de"; color: var(--primary); }
        table th.sorted-desc .sort-icon::before { content: "\f0dd"; color: var(--primary); }
        
        /* Classe para tabelas compactas */
        .table-compact th, .table-compact td {
            font-size: 12px;
            padding: 8px 10px;
        }
        
        .margin-ok { color: var(--secondary); font-weight: 600; }
        .margin-warn { color: var(--warning); font-weight: 600; }
        .margin-danger { color: var(--danger); font-weight: 600; }

        /* --- Loading Overlay --- */
        #loading-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background-color: rgba(255, 255, 255, 0.9);
            z-index: 10000;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-size: 1.2em;
            color: var(--primary);
        }
        .loading-spinner {
            width: 50px; height: 50px;
            border: 5px solid rgba(30, 136, 229, 0.2);
            border-radius: 50%;
            border-top-color: var(--primary);
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        #loading-status { margin-top: 15px; font-weight: 500; }
        
        /* --- Estilos do Assistente de Análise --- */
        #assistente-chat { display: flex; flex-direction: column; gap: 15px; }
        #assistente-input-group { display: flex; gap: 10px; }
        #assistente-input {
            flex-grow: 1; padding: 12px; border: 1px solid #ddd;
            border-radius: 4px; font-size: 15px;
        }
        #assistente-btn { padding: 0 20px; font-size: 15px; }
        #assistente-response {
            background-color: #f8f9fa; border: 1px solid #e0e0e0;
            border-radius: 5px; padding: 20px; min-height: 100px; line-height: 1.6;
        }
        #assistente-response h4 { color: var(--primary); margin-bottom: 10px; }
        #assistente-response .highlight { font-weight: 700; color: var(--dark); }

        /* --- Estilos da Aba "Análise por Produto" --- */
        #produto-selector-card {
            position: relative;
        }
        .product-search-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 15px;
        }
        /* CORREÇÃO DE LAYOUT DO DROPDOWN */
        .product-search-results-container {
            position: absolute;
            z-index: 2000; /* Z-index alto para ficar sobre tudo */
            background-color: #fff;
            border: 1px solid #ccc;
            border-radius: 5px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
            max-height: 250px;
            overflow-y: auto;
        }
        .product-search-results-container div {
            padding: 10px;
            cursor: pointer;
            font-size: 13px;
        }
        .product-search-results-container div:hover { background-color: #f0f2f5; }
        .product-search-results-container div strong { color: var(--primary); }
        
        .hint-icon {
            color: #007bff;
            font-size: 0.9em;
            margin-left: 4px;
        }
        
        #produto-analytics-container {
            display: none; /* Começa escondido */
        }
        
        #produto-subfilter-bar {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            justify-content: flex-end;
            gap: 8px;
            grid-column: 1 / -1; /* Ocupa a linha toda */
            margin-top: 10px;
        }
        .checkbox-group label {
            margin-bottom: 0;
            font-weight: 600;
        }
        
        /* --- Ajustes Responsivos --- */
        @media (max-width: 992px) {
            .sidebar { width: 60px; }
            .sidebar span { display: none; }
            .main-content { margin-left: 60px; }
            .sidebar:hover { width: var(--sidebar-width); }
            .sidebar:hover span { display: inline; }
            body.sidebar-collapsed .sidebar { width: 0; }
            body.sidebar-collapsed .main-content { margin-left: 0; }
            .filter-container { grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); }
            .product-search-grid { grid-template-columns: 1fr; } 
        }
        @media (max-width: 576px) {
            .dashboard-grid { grid-template-columns: 1fr; }
            .filter-container { grid-template-columns: 1fr; }
            header h1 { font-size: 1.2rem; }
            .main-content { margin-left: 60px; }
            body.sidebar-collapsed .main-content { margin-left: 0; }
        }
    </style>
</head>
<body>
    <div id="loading-overlay">
        <div class="loading-spinner"></div>
        <div id="loading-status">Carregando dados...</div>
    </div>

    <header>
        <i class="fas fa-bars sidebar-toggle" id="sidebar-toggle" title="Esconder/Exibir Menu"></i>
        <h1>Análise de Cotações</h1>
    </header>

    <div class="sidebar">
        <ul>
            <li class="active" data-section="resumo">
                <i class="fas fa-chart-pie"></i><span>Resumo Geral</span>
            </li>
            <li data-section="produto_detalhe">
                <i class="fas fa-search-dollar"></i><span>Análise por Produto</span>
            </li>
            <li data-section="vendedores">
                <i class="fas fa-user-tie"></i><span>Análise Vendedores</span>
            </li>
            <li data-section="cidades">
                <i class="fas fa-map-marked-alt"></i><span>Análise Cidades</span>
            </li>
            <li data-section="concorrentes">
                <i class="fas fa-user-secret"></i><span>Análise Concorrentes</span>
            </li>
            <li data-section="produtos">
                <i class="fas fa-boxes"></i><span>Produtos Críticos</span>
            </li>
            <li data-section="risco">
                <i class="fas fa-exclamation-triangle"></i><span>Pontos Críticos</span>
            </li>
            <li data-section="histograma">
                <i class="fas fa-chart-bar"></i><span>Histograma de Perdas</span>
            </li>
            <li data-section="temporal">
                <i class="fas fa-chart-line"></i><span>Análise Temporal</span>
            </li>
            <li data-section="relatorio">
                <i class="fas fa-file-alt"></i><span>Relatório Detalhado</span>
            </li>
            <li data-section="assistente">
                <i class="fas fa-magic"></i><span>Assistente de Análise</span>
            </li>
        </ul>
    </div>

    <div class="main-content">
        <div class="filter-container">
            <div class="filter-item">
                <label for="filter-date-start">Data Início</label>
                <input type="date" id="filter-date-start" onchange="runAnalysis()">
            </div>
            <div class="filter-item">
                <label for="filter-date-end">Data Fim</label>
                <input type="date" id="filter-date-end" onchange="runAnalysis()">
            </div>
            <div class="filter-item">
                <label for="filter-vendedor">Vendedor</label>
                <select id="filter-vendedor" onchange="runAnalysis()"><option value="">-- Todos --</option></select>
            </div>
            <div class="filter-item">
                <label for="filter-cidade">Cidade</label>
                <select id="filter-cidade" onchange="runAnalysis()"><option value="">-- Todos --</option></select>
            </div>
            <div class="filter-item">
                <label for="filter-concorrente">Concorrente</label>
                <select id="filter-concorrente" onchange="runAnalysis()"><option value="">-- Todos --</option></select>
            </div>
            <div class="filter-item">
                <label for="filter-venda-perdida">Venda Perdida?</label>
                <select id="filter-venda-perdida" onchange="runAnalysis()">
                    <option value="">-- Todos --</option>
                    <option value="TRUE">Sim (Perdida)</option>
                    <option value="FALSE">Não (Ganha)</option>
                </select>
            </div>
            <div id="filter-status" style="grid-column: 1 / -1; text-align: center; font-size: 13px; color: #555;"></div>
        </div>

        <div class="dashboard-section active" id="resumo">
            <div class="dashboard-grid">
                <div class="stat-card">
                    <div class="stat-card-header">
                        <div class="stat-card-icon bg-blue"><i class="fas fa-list-ol"></i></div>
                        <div><h3 class="stat-card-title">Cotações Analisadas</h3></div>
                    </div>
                    <p class="stat-card-value" id="kpi-total-cotacoes">0</p>
                </div>
                <div class="stat-card">
                    <div class="stat-card-header">
                        <div class="stat-card-icon bg-red"><i class="fas fa-thumbs-down"></i></div>
                        <div><h3 class="stat-card-title">Taxa de Perda</h3></div>
                    </div>
                    <p class="stat-card-value" id="kpi-taxa-perda">0%</p>
                </div>
                <div class="stat-card">
                    <div class="stat-card-header">
                        <div class="stat-card-icon bg-green"><i class="fas fa-percentage"></i></div>
                        <div><h3 class="stat-card-title">Minha Margem Média</h3></div>
                    </div>
                    <p class="stat-card-value" id="kpi-margem-flex">0%</p>
                </div>
                <div class="stat-card">
                    <div class="stat-card-header">
                        <div class="stat-card-icon bg-orange"><i class="fas fa-user-secret"></i></div>
                        <div><h3 class="stat-card-title">Margem p/ Cobrir (Conc.)</h3></div>
                    </div>
                    <p class="stat-card-value" id="kpi-margem-concorrente">0%</p>
                </div>
            </div>
        </div>

        <div class="dashboard-section" id="produto_detalhe">
            <div class="card" id="produto-selector-card">
                <div class="card-header"><h2>Selecione um Produto para Análise</h2></div>
                <div class="card-body">
                    <div class="product-search-grid">
                        <div class="filter-item">
                            <label for="produto-sku-input">Buscar por Código (SKU)</label>
                            <input type="text" id="produto-sku-input" placeholder="Digite o SKU...">
                        </div>
                        <div class="filter-item">
                            <label for="produto-nome-input">Buscar por Nome (use *)
                                <i class="fas fa-info-circle hint-icon" 
                                   title="Dica: Use '*' como curinga. Ex: 'bisc*briga*'"></i>
                            </label>
                            <input type="text" id="produto-nome-input" placeholder="Digite o nome...">
                        </div>
                    </div>
                    
                    <div class="checkbox-group">
                        <input type="checkbox" id="produto-ignorar-sem-custo" onchange="runProductAnalysis()">
                        <label for="produto-ignorar-sem-custo">Ignorar Itens sem Custo</label>
                    </div>
                </div>
            </div>
            
            <div id="produto-search-results" class="product-search-results-container" style="display: none;"></div>

            <div id="produto-analytics-container">
                <h2 id="produto-titulo-kpi" style="text-align: center; color: var(--primary);"></h2>
                
                <div class="dashboard-grid">
                    <div class="stat-card">
                        <div class="stat-card-header"><div class="stat-card-icon bg-blue"><i class="fas fa-dollar-sign"></i></div>
                        <div><h3 class="stat-card-title">Meu Preço Médio (Flex)</h3></div></div>
                        <p class="stat-card-value" id="kpi-produto-meu-preco">R$ 0,00</p>
                    </div>
                    <div class="stat-card">
                        <div class="stat-card-header"><div class="stat-card-icon bg-orange"><i class="fas fa-dollar-sign"></i></div>
                        <div><h3 class="stat-card-title">Preço Conc. Médio</h3></div></div>
                        <p class="stat-card-value" id="kpi-produto-conc-preco">R$ 0,00</p>
                    </div>
                    <div class="stat-card">
                        <div class="stat-card-header"><div class="stat-card-icon bg-green"><i class="fas fa-percentage"></i></div>
                        <div><h3 class="stat-card-title">Minha Margem Média</h3></div></div>
                        <p class="stat-card-value" id="kpi-produto-minha-margem">0%</p>
                    </div>
                    <div class="stat-card">
                        <div class="stat-card-header"><div class="stat-card-icon bg-red"><i class="fas fa-percentage"></i></div>
                        <div><h3 class="stat-card-title">Margem p/ Cobrir (Conc.)</h3></div></div>
                        <p class="stat-card-value" id="kpi-produto-conc-margem">0%</p>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-body" id="produto-subfilter-bar">
                        <div class="filter-item">
                            <label for="produto-filter-vendedor">Filtrar por Vendedor:</label>
                            <select id="produto-filter-vendedor" onchange="runProductAnalysis()"><option value="">-- Todos --</option></select>
                        </div>
                        <div class="filter-item">
                            <label for="produto-filter-cidade">Filtrar por Cidade:</label>
                            <select id="produto-filter-cidade" onchange="runProductAnalysis()"><option value="">-- Todos --</option></select>
                        </div>
                        <div class="filter-item">
                            <label for="produto-filter-concorrente">Filtrar por Concorrente:</label>
                            <select id="produto-filter-concorrente" onchange="runProductAnalysis()"><option value="">-- Todos --</option></select>
                        </div>
                    </div>
                </div>
                
                <div class="dashboard-grid">
                    <div class="card">
                        <div class="card-header"><h2>Evolução do Preço (Flex vs Conc.)</h2></div>
                        <div class="card-body"><canvas id="chart-produto-temporal"></canvas></div>
                    </div>
                    <div class="card">
                        <div class="card-header"><h2>Top Concorrentes (para este item)</h2></div>
                        <div class="card-body"><canvas id="chart-produto-concorrentes"></canvas></div>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header"><h2>Todas as Gravações (do Produto)</h2></div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table-compact" id="tabela-produto-detalhe">
                                <thead>
                                    <tr>
                                        <th data-key="dataCotacao" data-type="string">Data</th>
                                        <th data-key="vendedor" data-type="string">Vendedor</th>
                                        <th data-key="cidade" data-type="string">Cidade</th>
                                        <th data-key="concorrenteHeader" data-type="string">Concorrente</th>
                                        <th data-key="marcaConcorrente" data-type="string">Marca Conc.</th>
                                        <th data-key="precoFlex" data-type="number">Meu Preço</th>
                                        <th data-key="precoConcorrente" data-type="number">Preço Conc.</th>
                                        <th data-key="minhaMargem" data-type="number">Minha Margem</th>
                                        <th data-key="margemParaCobrir" data-type="number">Margem p/ Cobrir</th>
                                        <th data-key="vendaPerdida" data-type="string">Perdida?</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="dashboard-section" id="vendedores">
            <div class="card" data-help-key="chart-guerra-preco">
                <div class="card-header"><h2>Análise de "Guerra de Preço" (Top Vendedores)</h2></div>
                <div class="card-body">
                    <p class="card-description">Compara sua margem média com a margem necessária para cobrir o concorrente.</p>
                    <div class="chart-container"><canvas id="chart-guerra-preco"></canvas></div>
                </div>
            </div>
        </div>

        <div class="dashboard-section" id="cidades">
            <div class="card" data-help-key="chart-perdas-cidade">
                <div class="card-header"><h2>Top Cidades com Vendas Perdidas</h2></div>
                <div class="card-body">
                    <p class="card-description">Mostra as cidades com maior número absoluto de cotações perdidas.</p>
                    <div class="chart-container"><canvas id="chart-perdas-cidade"></canvas></div>
                </div>
            </div>
        </div>

        <div class="dashboard-section" id="concorrentes">
            <div class="card" data-help-key="chart-concorrente-share">
                <div class="card-header"><h2>Market Share de Vendas Perdidas</h2></div>
                <div class="card-body">
                    <p class="card-description">Percentual de perdas para cada concorrente (com base nos dados filtrados).</p>
                    <div class="chart-container"><canvas id="chart-perda-concorrente"></canvas></div>
                </div>
            </div>
            <div class="card" data-help-key="table-concorrente-agressivo">
                <div class="card-header"><h2>Análise de Agressividade (Tabela Completa)</h2></div>
                <div class="card-body">
                    <p class="card-description">Quão mais barato o concorrente está em média e quais produtos ele mais ataca.</p>
                    <div class="table-responsive">
                        <table id="tabela-concorrentes">
                            <thead>
                                <tr>
                                    <th>Concorrente</th>
                                    <th>Nº de Perdas</th>
                                    <th>Dif. Média (R$)</th>
                                    <th>Produto Mais Atacado</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div class="dashboard-section" id="produtos">
            <div class="card" data-help-key="chart-risco-oportunidade">
                <div class="card-header"><h2>Análise de Oportunidade vs. Risco (Produtos)</h2></div>
                <div class="card-body">
                    <p class="card-description">Posicionamento de cada produto com base na margem e taxa de perda. (Apenas produtos com custo)</p>
                    <div class="chart-container-large"><canvas id="chart-risco-oportunidade"></canvas></div>
                </div>
            </div>
        </div>

        <div class="dashboard-section" id="risco">
            <div class="card" data-help-key="table-risco-concorrentes">
                <div class="card-header"><h2>Top 20 Concorrentes Mais Agressivos</h2></div>
                <div class="card-body">
                    <p class="card-description">Classificado pela "Margem p/ Cobrir" (mais negativa = mais difícil de cobrir).</p>
                    <div class="table-responsive">
                        <table class="table-compact" id="tabela-risco-concorrentes">
                            <thead>
                                <tr>
                                    <th>Concorrente</th>
                                    <th>Cotações (Nº)</th>
                                    <th>Marca Mais Agressiva</th>
                                    <th>Margem p/ Cobrir</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>
            <div class="card" data-help-key="table-risco-produtos">
                <div class="card-header"><h2>Top 30 Produtos Mais Citados (em Vendas Perdidas)</h2></div>
                <div class="card-body">
                    <p class="card-description">Lista os produtos que mais aparecem nas cotações perdidas, com suas respectivas margens.</p>
                    <div class="table-responsive">
                        <table class="table-compact" id="tabela-risco-produtos">
                            <thead>
                                <tr>
                                    <th>Produto</th>
                                    <th>Cotações Perdidas (Nº)</th>
                                    <th>Marca Concorrente + Citada</th>
                                    <th>Margem p/ Cobrir</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div class="dashboard-section" id="histograma">
            <div class="card" data-help-key="chart-histograma">
                <div class="card-header"><h2>Histograma de Diferença de Preço (Vendas Perdidas)</h2></div>
                <div class="card-body">
                    <p class="card-description">Mostra *por quanto* estamos perdendo as vendas (quando somos mais caros).</p>
                    <div class="chart-container-large"><canvas id="chart-histograma-preco"></canvas></div>
                </div>
            </div>
        </div>

        <div class="dashboard-section" id="temporal">
            <div class="card" data-help-key="chart-temporal">
                <div class="card-header"><h2>Evolução de KPIs (Taxa de Perda vs. Margem Média)</h2></div>
                <div class="card-body">
                    <p class="card-description">Acompanhe se suas ações estão melhorando os indicadores ao longo do tempo.</p>
                    <div class="chart-container-large"><canvas id="chart-tendencia-temporal"></canvas></div>
                </div>
            </div>
        </div>

        <div class="dashboard-section" id="relatorio">
            <div class="card" data-help-key="table-relatorio-detalhado">
                <div class="card-header">
                    <h2>Relatório Detalhado de Produtos</h2>
                    <button class="btn btn-primary" id="btn-export">
                        <i class="fas fa-file-excel"></i> Exportar para Excel
                    </button>
                </div>
                <div class="card-body">
                    <div class="card-description">
                        Clique no cabeçalho de uma coluna para ordenar. <span id="table-row-count"></span>
                    </div>
                    <div class="table-responsive">
                        <table id="products-table">
                            <thead>
                                <tr>
                                    <th data-key="dataCotacao" data-type="string">Data<span class="sort-icon"></span></th>
                                    <th data-key="nomeProduto" data-type="string">Produto<span class="sort-icon"></span></th>
                                    <th data-key="vendedor" data-type="string">Vendedor<span class="sort-icon"></span></th>
                                    <th data-key="custo" data-type="number">Custo<span class="sort-icon"></span></th>
                                    <th data-key="precoFlex" data-type="number">Preço Flex<span class="sort-icon"></span></th>
                                    <th data-key="precoConcorrente" data-type="number">Preço Conc.<span class="sort-icon"></span></th>
                                    <th data-key="marcaConcorrente" data-type="string">Marca Conc.<span class="sort-icon"></span></th>
                                    <th data-key="diffPreco" data-type="number">Diferença (R$)<span class="sort-icon"></span></th>
                                    <th data-key="minhaMargem" data-type="number">Minha Margem (%)<span class="sort-icon"></span></th>
                                    <th data-key="margemParaCobrir" data-type="number">Margem p/ Cobrir (%)<span class="sort-icon"></span></th>
                                    <th data-key="vendaPerdida" data-type="string">Venda Perdida?<span class="sort-icon"></span></th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="dashboard-section" id="assistente">
            <div class="card" data-help-key="assistente-ia">
                <div class="card-header"><h2>Assistente de Análise</h2></div>
                <div class="card-body">
                    <p class="card-description">
                        Faça perguntas simples sobre os dados <b>atualmente filtrados</b>.
                        <br>
                        <b>Exemplos:</b> "qual o pior vendedor?", "produto com melhor margem?", "concorrente mais agressivo?", "taxa de perda em Limeira?"
                    </p>
                    <div id="assistente-chat">
                        <div id="assistente-input-group">
                            <input type="text" id="assistente-input" placeholder="Pergunte aqui...">
                            <button class="btn btn-primary" id="assistente-btn">
                                <i class="fas fa-paper-plane"></i> Perguntar
                            </button>
                        </div>
                        <div id="assistente-response">
                            <p>Aguardando sua pergunta...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
    </div> <script>
        // =======================================================================
        // CONFIGURAÇÕES
        // =======================================================================
        
        const PRODUTOS_SHEET_ID = '1cN_1GBR29BN77eRZAkzvikt96i_kX9AZ04cTc6XRM8Q';
        const PRODUTOS_SHEET_NAME = 'produtos';
        const PRODUTOS_RANGE = 'A2:B';
        
        const COTACOES_SHEET_ID = '1IkpsIk9sJbHWyVMPn0T-lX9Aq3EVeCzvkwfEQwj9NS0';
        const COTACOES_SHEET_NAME = 'COTAÇÕES';
        const COTACOES_DATA_RANGE = 'A2:O'; 
        
        const API_KEY = 'AIzaSyChiZPUY-G3oyZN2NGY_vlgRXUzry9Pkeo';
        
        let globalData = [];
        let productList = [];
        let filteredData = [];
        let currentSelectedProduct = null;
        let activeProductData = [];
        let productSortConfig = { key: 'dataCotacao', direction: 'desc' };
        
        let charts = {};
        let sortConfig = { key: 'dataCotacao', direction: 'desc' };
        
        const COLUMN_MAP = {
            0: 'dataEnvio', 1: 'dataCotacao', 2: 'supervisor', 3: 'vendedor',
            4: 'cidade', 5: 'cliente', 6: 'concorrenteHeader', 7: 'codProduto',
            8: 'nomeProduto', 9: 'precoFlex', 10: 'custo', 11: 'precoConcorrente',
            12: 'marcaConcorrente', // Coluna M
            13: 'linkFoto',         // Coluna N
            14: 'vendaPerdida'      // Coluna O
        };
        
        // =======================================================================
        // INICIALIZAÇÃO E NAVEGAÇÃO
        // =======================================================================
        
        document.addEventListener('DOMContentLoaded', () => {
            configurarNavegacao();
            setupTableSorting();
            document.getElementById('btn-export').addEventListener('click', handleExportXLSX);
            document.getElementById('sidebar-toggle').addEventListener('click', toggleSidebar);
            document.getElementById('assistente-btn').addEventListener('click', handleAssistenteQuery);
            document.getElementById('assistente-input').addEventListener('keydown', (e) => {
                if (e.key === 'Enter') handleAssistenteQuery();
            });
            
            setupProductSearch();
            
            loadDataFromSheet();
        });

        function configurarNavegacao() {
            const menuItems = document.querySelectorAll('.sidebar li');
            const sections = document.querySelectorAll('.dashboard-section');
            
            menuItems.forEach(item => {
                item.addEventListener('click', () => {
                    menuItems.forEach(i => i.classList.remove('active'));
                    item.classList.add('active');
                    const sectionId = item.getAttribute('data-section');
                    sections.forEach(section => {
                        section.classList.toggle('active', section.id === sectionId);
                    });
                    renderActiveChart(sectionId);
                });
            });
        }
        
        function toggleSidebar() {
            document.body.classList.toggle('sidebar-collapsed');
            setTimeout(() => {
                Object.values(charts).forEach(chart => {
                    if (chart) chart.resize();
                });
            }, 350);
        }
        
        function renderActiveChart(sectionId) {
            destroyAllCharts();
            setTimeout(() => {
                if (sectionId === 'vendedores') {
                    updateChartGuerraPreco();
                } else if (sectionId === 'cidades') {
                    updateChartPerdasCidade();
                } else if (sectionId === 'concorrentes') {
                    updateDashboardConcorrentes();
                } else if (sectionId === 'produtos') {
                    updateDashboardProdutosCriticos();
                } else if (sectionId === 'risco') {
                    updateDashboardRisco();
                } else if (sectionId === 'histograma') {
                    updateDashboardHistograma();
                } else if (sectionId === 'temporal') {
                    updateDashboardTemporal();
                } else if (sectionId === 'produto_detalhe') {
                    if (currentSelectedProduct) {
                        updateChartProdutoTemporal(activeProductData);
                        updateChartProdutoConcorrentes(activeProductData);
                    }
                }
            }, 10);
        }

        function destroyAllCharts() {
            Object.keys(charts).forEach(chartId => {
                if (charts[chartId]) {
                    charts[chartId].destroy();
                    delete charts[chartId];
                }
            });
        }

        // =======================================================================
        // ETAPA 1: CARREGAMENTO DE DADOS (LEITURA)
        // =======================================================================

        async function loadDataFromSheet() {
            const loadingOverlay = document.getElementById('loading-overlay');
            const loadingStatus = document.getElementById('loading-status');
            
            const urlCotacoes = `https://sheets.googleapis.com/v4/spreadsheets/${COTACOES_SHEET_ID}/values/${COTACOES_SHEET_NAME}!${COTACOES_DATA_RANGE}?key=${API_KEY}&_=${new Date().getTime()}`;
            const urlProdutos = `https://sheets.googleapis.com/v4/spreadsheets/${PRODUTOS_SHEET_ID}/values/${PRODUTOS_SHEET_NAME}!${PRODUTOS_RANGE}?key=${API_KEY}&_=${new Date().getTime()}`;

            try {
                loadingStatus.textContent = 'Buscando dados das Cotações...';
                const [responseCotacoes, responseProdutos] = await Promise.all([
                    fetch(urlCotacoes),
                    fetch(urlProdutos)
                ]);

                if (!responseCotacoes.ok) throw new Error(`Erro ao buscar Cotações. Verifique API Key e permissões da Planilha 2.`);
                if (!responseProdutos.ok) throw new Error(`Erro ao buscar Lista de Produtos. Verifique API Key e permissões da Planilha 1.`);
                
                const dataCotacoes = await responseCotacoes.json();
                const dataProdutos = await responseProdutos.json();
                
                if (!dataCotacoes.values || dataCotacoes.values.length === 0) throw new Error('Planilha de Cotações vazia.');
                if (!dataProdutos.values || dataProdutos.values.length === 0) throw new Error('Planilha de Produtos vazia.');

                loadingStatus.textContent = 'Processando Cotações...';
                globalData = parseSheetData(dataCotacoes.values);
                
                loadingStatus.textContent = 'Processando Lista de Produtos...';
                productList = dataProdutos.values.map(row => ({ sku: String(row[0]).trim(), name: String(row[1]).trim() })).filter(p => p.sku && p.name);
                
                loadingStatus.textContent = 'Montando filtros...';
                populateFilters();
                
                loadingStatus.textContent = 'Análise inicial...';
                runAnalysis();
                
                loadingOverlay.style.display = 'none';
                
            } catch (error) {
                console.error('Erro fatal ao carregar dados:', error);
                loadingStatus.innerHTML = `❌ Erro: ${error.message}<br><br>Verifique se ambas as planilhas estão compartilhadas como "Qualquer pessoa com o link pode VER".`;
                loadingStatus.style.color = 'red';
            }
        }
        
        function parseSheetData(rows) {
            return rows.map(row => {
                let obj = {};
                for (let i = 0; i < row.length; i++) {
                    const key = COLUMN_MAP[i];
                    if (key) {
                        let value = row[i];
                        if (['precoFlex', 'custo', 'precoConcorrente'].includes(key)) {
                            value = parseFloat(String(value).replace(',', '.')) || 0;
                        } else if (key === 'vendaPerdida') {
                            value = String(row[14] || '').toUpperCase().trim();
                            if (value === 'FALSE' || value === 'FALSO' || value === 'N') value = 'FALSE';
                            else value = 'TRUE';
                        }
                        obj[key] = value;
                    }
                }
                obj.custo = obj.custo || 0;
                obj.precoFlex = obj.precoFlex || 0;
                obj.precoConcorrente = obj.precoConcorrente || 0;
                obj.diffPreco = obj.precoFlex - obj.precoConcorrente;
                obj.minhaMargem = (obj.precoFlex > 0 && obj.custo > 0) ? (obj.precoFlex - obj.custo) / obj.precoFlex : 0;
                obj.margemParaCobrir = (obj.precoConcorrente > 0 && obj.custo > 0) ? (obj.precoConcorrente - obj.custo) / obj.precoConcorrente : 0;
                if (obj.dataCotacao) {
                    const parts = obj.dataCotacao.split('-');
                    if (parts.length === 3) obj.anoMes = `${parts[0]}-${parts[1]}`;
                }
                return obj;
            });
        }
        
        function populateFilters() {
            const vendedores = new Set();
            const cidades = new Set();
            const concorrentes = new Set();
            let minDate = '9999-12-31';
            let maxDate = '2000-01-01';
            globalData.forEach(row => {
                if (row.vendedor) vendedores.add(row.vendedor);
                if (row.cidade) cidades.add(row.cidade);
                if (row.concorrenteHeader) concorrentes.add(row.concorrenteHeader);
                if (row.dataCotacao) {
                    if (row.dataCotacao < minDate) minDate = row.dataCotacao;
                    if (row.dataCotacao > maxDate) maxDate = row.dataCotacao;
                }
            });
            populateSelect('filter-vendedor', [...vendedores].sort());
            populateSelect('filter-cidade', [...cidades].sort());
            populateSelect('filter-concorrente', [...concorrentes].sort());
            document.getElementById('filter-date-start').value = minDate;
            document.getElementById('filter-date-end').value = maxDate;
        }

        function populateSelect(elementId, items) {
            const select = document.getElementById(elementId);
            select.options.length = 1; 
            items.forEach(item => {
                const option = document.createElement('option');
                option.value = item;
                option.textContent = item;
                select.appendChild(option);
            });
        }

        // =======================================================================
        // ETAPA 2: FILTRAGEM E ANÁLISE (Global)
        // =======================================================================
        
        function runAnalysis() {
            const statusEl = document.getElementById('filter-status');
            statusEl.textContent = 'Filtrando dados...';
            const filters = {
                dateStart: document.getElementById('filter-date-start').value,
                dateEnd: document.getElementById('filter-date-end').value,
                vendedor: document.getElementById('filter-vendedor').value,
                cidade: document.getElementById('filter-cidade').value,
                concorrente: document.getElementById('filter-concorrente').value,
                vendaPerdida: document.getElementById('filter-venda-perdida').value,
            };
            filteredData = globalData.filter(row => {
                if (filters.dateStart && row.dataCotacao < filters.dateStart) return false;
                if (filters.dateEnd && row.dataCotacao > filters.dateEnd) return false;
                if (filters.vendedor && row.vendedor !== filters.vendedor) return false;
                if (filters.cidade && row.cidade !== filters.cidade) return false;
                if (filters.concorrente && row.concorrenteHeader !== filters.concorrente) return false;
                if (filters.vendaPerdida && row.vendaPerdida !== filters.vendaPerdida) return false;
                return true;
            });
            statusEl.textContent = `${filteredData.length} cotações encontradas.`;
            updateKPIs();
            updateTable(); 
            
            runProductAnalysis(); // Re-executa a análise de produto
            
            const activeSection = document.querySelector('.sidebar li.active').dataset.section;
            renderActiveChart(activeSection);
        }
        
        function updateKPIs() {
            let totalCotacoes = filteredData.length;
            let totalPerdidas = 0;
            let somaMargemFlex = 0;
            let somaMargemConc = 0;
            let countComCusto = 0;
            filteredData.forEach(row => {
                if (row.vendaPerdida === 'TRUE') totalPerdidas++;
                if (row.custo > 0) {
                    somaMargemFlex += row.minhaMargem;
                    somaMargemConc += row.margemParaCobrir;
                    countComCusto++;
                }
            });
            const taxaPerda = totalCotacoes > 0 ? (totalPerdidas / totalCotacoes) : 0;
            const mediaMargemFlex = countComCusto > 0 ? (somaMargemFlex / countComCusto) : 0;
            const mediaMargemConc = countComCusto > 0 ? (somaMargemConc / countComCusto) : 0;
            document.getElementById('kpi-total-cotacoes').textContent = totalCotacoes;
            document.getElementById('kpi-taxa-perda').textContent = `${(taxaPerda * 100).toFixed(1)}%`;
            document.getElementById('kpi-margem-flex').textContent = `${(mediaMargemFlex * 100).toFixed(1)}%`;
            document.getElementById('kpi-margem-concorrente').textContent = `${(mediaMargemConc * 100).toFixed(1)}%`;
            setClassByValue('kpi-taxa-perda', taxaPerda, 0.5, 'loss', 'margin-good');
            setClassByValue('kpi-margem-flex', mediaMargemFlex, 0.2, 'margin-good', 'margin-warn');
            setClassByValue('kpi-margem-concorrente', mediaMargemConc, 0.1, 'margin-warn', 'margin-bad');
        }

        function setClassByValue(elementId, value, threshold, classIfHigh, classIfLow) {
            const el = document.getElementById(elementId);
            el.classList.remove('loss', 'margin-good', 'margin-warn', 'margin-bad');
            if (value >= threshold) el.classList.add(classIfHigh);
            else el.classList.add(classIfLow);
        }
        
        // --- CORREÇÃO: Funções de Formatação Globais ---
        const formatPercent = (val) => {
            const p = (val * 100).toFixed(1);
            let cls = 'margin-ok';
            if (p < 20) cls = 'margin-warn';
            if (p < 0) cls = 'margin-danger';
            return `<span class="${cls}">${p}%</span>`;
        };
        const formatCurrency = (val) => `R$ ${val.toFixed(2)}`;
        const formatDiff = (val) => {
            const cls = val > 0 ? 'margin-danger' : 'margin-ok';
            return `<span class="${cls}">R$ ${val.toFixed(2)}</span>`;
        };
        const formatPerdida = (val) => {
            if (val === 'TRUE') return `<span style="color: var(--danger); font-weight: 600;">Sim</span>`;
            return `<span style="color: var(--secondary);">Não</span>`;
        };

        // =======================================================================
        // ETAPA 3: GRÁFICOS (Chart.js)
        // =======================================================================
        
        function updateChartGuerraPreco() {
            const ctx = document.getElementById('chart-guerra-preco')?.getContext('2d');
            if (!ctx) return;
            const dataByVendedor = {};
            filteredData.forEach(row => {
                if (row.custo > 0) {
                    const vendedor = row.vendedor || 'N/A';
                    if (!dataByVendedor[vendedor]) dataByVendedor[vendedor] = { somaFlex: 0, somaConc: 0, count: 0 };
                    dataByVendedor[vendedor].somaFlex += row.minhaMargem;
                    dataByVendedor[vendedor].somaConc += row.margemParaCobrir;
                    dataByVendedor[vendedor].count++;
                }
            });
            const chartData = Object.keys(dataByVendedor).map(vendedor => ({
                vendedor: vendedor,
                mediaFlex: dataByVendedor[vendedor].somaFlex / dataByVendedor[vendedor].count,
                mediaConc: dataByVendedor[vendedor].somaConc / dataByVendedor[vendedor].count
            })).sort((a, b) => b.mediaFlex - a.mediaFlex).slice(0, 5);
            charts['chart-guerra-preco'] = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: chartData.map(d => d.vendedor),
                    datasets: [
                        { label: 'Minha Margem Média (%)', data: chartData.map(d => d.mediaFlex * 100), backgroundColor: 'rgba(30, 136, 229, 0.7)' },
                        { label: 'Margem p/ Cobrir Conc. (%)', data: chartData.map(d => d.mediaConc * 100), backgroundColor: 'rgba(229, 57, 53, 0.7)' }
                    ]
                },
                options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, ticks: { callback: value => `${value}%` } } }, plugins: { tooltip: { callbacks: { label: c => `${c.dataset.label}: ${c.raw.toFixed(1)}%` } } } }
            });
        }
        
        function updateChartPerdasCidade() {
            const ctx = document.getElementById('chart-perdas-cidade')?.getContext('2d');
            if (!ctx) return;
            const dataByCidade = {};
            filteredData.forEach(row => {
                if (row.vendaPerdida === 'TRUE') {
                    const cidade = row.cidade || 'N/A';
                    if (!dataByCidade[cidade]) dataByCidade[cidade] = 0;
                    dataByCidade[cidade]++;
                }
            });
            const chartData = Object.keys(dataByCidade).map(cidade => ({ cidade: cidade, perdas: dataByCidade[cidade] }))
                .sort((a, b) => b.perdas - a.perdas).slice(0, 5);
            charts['chart-perdas-cidade'] = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: chartData.map(d => d.cidade),
                    datasets: [{ label: 'Vendas Perdidas', data: chartData.map(d => d.perdas), backgroundColor: ['#e53935', '#ff9800', '#1e88e5', '#26a69a', '#6c757d'], hoverOffset: 4 }]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });
        }
        
        function updateDashboardConcorrentes() {
            const ctxPie = document.getElementById('chart-perda-concorrente')?.getContext('2d');
            const tbody = document.getElementById('tabela-concorrentes')?.getElementsByTagName('tbody')[0];
            if (!ctxPie || !tbody) return;
            const dataByConcorrente = {};
            const perdas = filteredData.filter(row => row.vendaPerdida === 'TRUE' && row.concorrenteHeader);
            perdas.forEach(row => {
                const concorrente = row.concorrenteHeader;
                if (!dataByConcorrente[concorrente]) dataByConcorrente[concorrente] = { perdas: 0, somaDiff: 0, countDiff: 0, produtos: {} };
                dataByConcorrente[concorrente].perdas++;
                if (row.diffPreco > 0) {
                    dataByConcorrente[concorrente].somaDiff += row.diffPreco;
                    dataByConcorrente[concorrente].countDiff++;
                }
                const produto = row.nomeProduto || 'N/A';
                dataByConcorrente[concorrente].produtos[produto] = (dataByConcorrente[concorrente].produtos[produto] || 0) + 1;
            });
            const chartData = Object.keys(dataByConcorrente).map(concorrente => {
                const d = dataByConcorrente[concorrente];
                const produtoTopEntry = Object.entries(d.produtos).sort((a,b) => b[1] - a[1])[0];
                return {
                    concorrente: concorrente,
                    perdas: d.perdas,
                    avgDiff: d.countDiff > 0 ? d.somaDiff / d.countDiff : 0,
                    produtoTop: produtoTopEntry ? produtoTopEntry[0] : 'N/A'
                };
            }).sort((a, b) => b.perdas - a.perdas);
            charts['chart-perda-concorrente'] = new Chart(ctxPie, {
                type: 'pie',
                data: {
                    labels: chartData.map(d => d.concorrente),
                    datasets: [{ label: 'Vendas Perdidas', data: chartData.map(d => d.perdas), backgroundColor: ['#e53935', '#ff9800', '#1e88e5', '#26a69a', '#6c757d', '#ab47bc', '#fdd835'], }]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });
            tbody.innerHTML = '';
            chartData.forEach(d => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td><b>${d.concorrente}</b></td>
                    <td>${d.perdas}</td>
                    <td class="margin-danger">R$ ${d.avgDiff.toFixed(2)}</td>
                    <td>${d.produtoTop}</td>
                `;
                tbody.appendChild(tr);
            });
        }
        
        function updateDashboardProdutosCriticos() {
            const ctxScatter = document.getElementById('chart-risco-oportunidade')?.getContext('2d');
            if (!ctxScatter) return;
            const dataByProduto = {};
            filteredData.forEach(row => {
                if (row.custo > 0 && row.nomeProduto) {
                    const produto = row.nomeProduto;
                    if (!dataByProduto[produto]) dataByProduto[produto] = { somaMargem: 0, perdas: 0, total: 0 };
                    dataByProduto[produto].somaMargem += row.minhaMargem;
                    dataByProduto[produto].total++;
                    if (row.vendaPerdida === 'TRUE') dataByProduto[produto].perdas++;
                }
            });
            const scatterData = Object.keys(dataByProduto).map(produto => {
                const d = dataByProduto[produto];
                const avgMargem = (d.somaMargem / d.total) * 100;
                const taxaPerda = (d.perdas / d.total) * 100;
                return { x: avgMargem, y: taxaPerda, label: produto };
            });
            charts['chart-risco-oportunidade'] = new Chart(ctxScatter, {
                type: 'scatter',
                data: {
                    datasets: [{ label: 'Produtos', data: scatterData, backgroundColor: 'rgba(30, 136, 229, 0.7)' }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    scales: {
                        x: { title: { display: true, text: 'Minha Margem Média (%)' }, ticks: { callback: v => `${v.toFixed(0)}%` } },
                        y: { title: { display: true, text: 'Taxa de Perda (%)' }, ticks: { callback: v => `${v.toFixed(0)}%` } }
                    },
                    plugins: { tooltip: { callbacks: { label: (ctx) => `${ctx.raw.label}: (${ctx.raw.x.toFixed(1)}% Margem, ${ctx.raw.y.toFixed(1)}% Perda)` } } }
                }
            });
        }

        function updateDashboardRisco() {
            const tbodyConc = document.getElementById('tabela-risco-concorrentes')?.getElementsByTagName('tbody')[0];
            const tbodyProd = document.getElementById('tabela-risco-produtos')?.getElementsByTagName('tbody')[0];
            if (!tbodyConc || !tbodyProd) return;
            
            const findTopBrand = (marcas) => {
                if (Object.keys(marcas).length === 0) return 'N/A';
                return Object.entries(marcas).sort((a, b) => b[1] - a[1])[0][0];
            };

            const dataComCusto = filteredData.filter(row => row.custo > 0 && row.concorrenteHeader);
            const aggConc = {};
            dataComCusto.forEach(row => {
                const k = row.concorrenteHeader;
                if (!aggConc[k]) aggConc[k] = { key: k, count: 0, sumCobrir: 0, marcas: {} };
                aggConc[k].count++;
                aggConc[k].sumCobrir += row.margemParaCobrir;
                if (row.marcaConcorrente) {
                    aggConc[k].marcas[row.marcaConcorrente] = (aggConc[k].marcas[row.marcaConcorrente] || 0) + 1;
                }
            });
            const listaConc = Object.values(aggConc).map(c => ({
                key: c.key,
                count: c.count,
                avgCobrir: c.sumCobrir / c.count,
                topMarca: findTopBrand(c.marcas)
            })).sort((a,b) => a.avgCobrir - b.avgCobrir);
            
            tbodyConc.innerHTML = '';
            listaConc.slice(0, 20).forEach(d => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td><b>${d.key}</b></td>
                    <td>${d.count}</td>
                    <td>${d.topMarca}</td>
                    <td>${formatPercent(d.avgCobrir)}</td>
                `;
                tbodyConc.appendChild(tr);
            });

            const dataPerdidaComCusto = filteredData.filter(row => row.vendaPerdida === 'TRUE' && row.custo > 0 && row.nomeProduto);
            const aggProd = {};
            dataPerdidaComCusto.forEach(row => {
                const k = row.nomeProduto;
                if (!aggProd[k]) aggProd[k] = { key: k, count: 0, sumCobrir: 0, marcas: {} };
                aggProd[k].count++;
                aggProd[k].sumCobrir += row.margemParaCobrir;
                if (row.marcaConcorrente) {
                    aggProd[k].marcas[row.marcaConcorrente] = (aggProd[k].marcas[row.marcaConcorrente] || 0) + 1;
                }
            });
            const listaProd = Object.values(aggProd).map(p => ({
                key: p.key,
                count: p.count,
                avgCobrir: p.sumCobrir / p.count,
                topMarca: findTopBrand(p.marcas)
            })).sort((a,b) => b.count - a.count);
            
            tbodyProd.innerHTML = '';
            listaProd.slice(0, 30).forEach(d => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td><b>${d.key}</b></td>
                    <td>${d.count}</td>
                    <td>${d.topMarca}</td>
                    <td>${formatPercent(d.avgCobrir)}</td>
                `;
                tbodyProd.appendChild(tr);
            });
        }
        
        function updateDashboardHistograma() {
            const ctxBar = document.getElementById('chart-histograma-preco')?.getContext('2d');
            if (!ctxBar) return;
            const bins = {
                'R$ 0,01-R$ 0,50': 0, 'R$ 0,51-R$ 1,00': 0, 'R$ 1,01-R$ 2,00': 0,
                'R$ 2,01-R$ 5,00': 0, 'Acima de R$ 5,00': 0
            };
            filteredData.forEach(row => {
                if (row.vendaPerdida === 'TRUE' && row.diffPreco > 0) {
                    const diff = row.diffPreco;
                    if (diff <= 0.50) bins['R$ 0,01-R$ 0,50']++;
                    else if (diff <= 1.00) bins['R$ 0,51-R$ 1,00']++;
                    else if (diff <= 2.00) bins['R$ 1,01-R$ 2,00']++;
                    else if (diff <= 5.00) bins['R$ 2,01-R$ 5,00']++;
                    else bins['Acima de R$ 5,00']++;
                }
            });
            charts['chart-histograma-preco'] = new Chart(ctxBar, {
                type: 'bar',
                data: {
                    labels: Object.keys(bins),
                    datasets: [{ label: 'Nº de Vendas Perdidas', data: Object.values(bins), backgroundColor: 'rgba(255, 152, 0, 0.7)' }]
                },
                options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, title: {display: true, text: 'Contagem de Perdas'} } } }
            });
        }

        function updateDashboardTemporal() {
            const ctxLine = document.getElementById('chart-tendencia-temporal')?.getContext('2d');
            if (!ctxLine) return;
            const dataByTime = {};
            filteredData.forEach(row => {
                const mes = row.anoMes;
                if (!mes) return;
                if (!dataByTime[mes]) dataByTime[mes] = { somaMargem: 0, perdas: 0, total: 0, custoCount: 0 };
                dataByTime[mes].total++;
                if (row.vendaPerdida === 'TRUE') dataByTime[mes].perdas++;
                if (row.custo > 0) {
                    dataByTime[mes].somaMargem += row.minhaMargem;
                    dataByTime[mes].custoCount++;
                }
            });
            const labels = Object.keys(dataByTime).sort();
            const taxaPerdaData = labels.map(mes => (dataByTime[mes].perdas / dataByTime[mes].total) * 100);
            const margemMediaData = labels.map(mes => (dataByTime[mes].custoCount > 0 ? (dataByTime[mes].somaMargem / dataByTime[mes].custoCount) * 100 : 0));
            charts['chart-tendencia-temporal'] = new Chart(ctxLine, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        { label: 'Taxa de Perda (%)', data: taxaPerdaData, borderColor: 'rgba(229, 57, 53, 1)', backgroundColor: 'rgba(229, 57, 53, 0.1)', yAxisID: 'yPerda', tension: 0.1 },
                        { label: 'Margem Média (%)', data: margemMediaData, borderColor: 'rgba(30, 136, 229, 1)', backgroundColor: 'rgba(30, 136, 229, 0.1)', yAxisID: 'yMargem', tension: 0.1 }
                    ]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    scales: {
                        yPerda: { type: 'linear', position: 'left', title: { display: true, text: 'Taxa de Perda' }, ticks: { callback: v => `${v.toFixed(0)}%` } },
                        yMargem: { type: 'linear', position: 'right', title: { display: true, text: 'Margem Média' }, grid: { drawOnChartArea: false }, ticks: { callback: v => `${v.toFixed(0)}%` } }
                    },
                    plugins: { tooltip: { mode: 'index', intersect: false } }
                }
            });
        }
        
        // =======================================================================
        // ETAPA 4: TABELA DETALHADA (Relatório)
        // =======================================================================

        function setupTableSorting() {
            document.querySelectorAll('#products-table th').forEach(th => {
                th.addEventListener('click', () => {
                    const key = th.dataset.key;
                    if (!key) return;
                    let direction = 'asc';
                    if (sortConfig.key === key && sortConfig.direction === 'asc') direction = 'desc';
                    sortConfig = { key, direction, type: th.dataset.type };
                    document.querySelectorAll('#products-table th').forEach(t => t.className = '');
                    th.classList.add(direction === 'asc' ? 'sorted-asc' : 'sorted-desc');
                    updateTable();
                });
            });
        }
        
        function updateTable() {
            const tbody = document.getElementById('products-table')?.getElementsByTagName('tbody')[0];
            if (!tbody) return;
            tbody.innerHTML = ''; 
            document.getElementById('table-row-count').textContent = `(${filteredData.length} produtos filtrados)`;
            const sortedData = [...filteredData].sort((a, b) => {
                let valA = a[sortConfig.key];
                let valB = b[sortConfig.key];
                if (sortConfig.type === 'number') return sortConfig.direction === 'asc' ? valA - valB : valB - valA;
                valA = String(valA || '').toLowerCase();
                valB = String(valB || '').toLowerCase();
                if (valA < valB) return sortConfig.direction === 'asc' ? -1 : 1;
                if (valA > valB) return sortConfig.direction === 'asc' ? 1 : -1;
                return 0;
            });
            sortedData.forEach(row => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${row.dataCotacao}</td>
                    <td><b>${row.codProduto}</b> - ${row.nomeProduto}</td>
                    <td>${row.vendedor}</td>
                    <td>${formatCurrency(row.custo)}</td>
                    <td>${formatCurrency(row.precoFlex)}</td>
                    <td>${formatCurrency(row.precoConcorrente)}</td>
                    <td>${row.marcaConcorrente || 'N/A'}</td>
                    <td>${formatDiff(row.diffPreco)}</td>
                    <td>${formatPercent(row.minhaMargem)}</td>
                    <td>${formatPercent(row.margemParaCobrir)}</td>
                    <td>${formatPerdida(row.vendaPerdida)}</td>
                `;
                tbody.appendChild(tr);
            });
        }
        
        // =======================================================================
        // ETAPA 5: EXPORTAÇÃO (XLSX)
        // =======================================================================

        function handleExportXLSX() {
            const btn = document.getElementById('btn-export');
            if (filteredData.length === 0) {
                alert("Não há dados filtrados para exportar.");
                return;
            }
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Gerando...';
            try {
                const dataToExport = filteredData.map(row => ({
                    'Data': row.dataCotacao, 'Vendedor': row.vendedor, 'Cidade': row.cidade, 'Cliente': row.cliente,
                    'Concorrente (Geral)': row.concorrenteHeader, 'Cód. Produto': row.codProduto, 'Nome Produto': row.nomeProduto,
                    'Custo': row.custo, 'Preço Flex': row.precoFlex, 'Preço Concorrente': row.precoConcorrente,
                    'Marca Conc.': row.marcaConcorrente,
                    'Diferença (R$)': row.diffPreco, 'Minha Margem (%)': row.minhaMargem, 'Margem p/ Cobrir (%)': row.margemParaCobrir,
                    'Venda Perdida?': row.vendaPerdida === 'TRUE' ? 'Sim' : 'Não'
                }));
                const ws = XLSX.utils.json_to_sheet(dataToExport);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Cotações Filtradas");
                const dataFim = document.getElementById('filter-date-end').value;
                XLSX.writeFile(wb, `Relatorio_Cotacoes_${dataFim}.xlsx`);
            } catch (error) {
                console.error("Erro ao gerar XLSX:", error);
                alert("Ocorreu um erro ao gerar o arquivo Excel.");
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-file-excel"></i> Exportar para Excel';
            }
        }
        
        // =======================================================================
        // ETAPA 6: ASSISTENTE DE ANÁLISE (IA JavaScript)
        // =======================================================================
        
        function handleAssistenteQuery() {
            const query = document.getElementById('assistente-input').value;
            const responseContainer = document.getElementById('assistente-response');
            if (!query) {
                responseContainer.innerHTML = `<p>Por favor, digite uma pergunta.</p>`;
                return;
            }
            const resposta = parseAssistenteQuery(query);
            responseContainer.innerHTML = resposta;
        }
        function parseAssistenteQuery(query) {
            const q = query.toLowerCase()
                         .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
                         .replace(/[?.,!]/g, '');
            if ((q.includes('pior') || q.includes('mais perdeu')) && q.includes('vendedor')) {
                return assistente_findWorstVendedor();
            }
            if ((q.includes('melhor') || q.includes('mais ganhou')) && q.includes('vendedor')) {
                return assistente_findBestVendedor();
            }
            if ((q.includes('pior') || q.includes('mais perdido')) && q.includes('produto')) {
                return assistente_findWorstProduct();
            }
            if ((q.includes('melhor') || q.includes('mais rentavel') || q.includes('melhor margem')) && q.includes('produto')) {
                return assistente_findBestMarginProduct();
            }
            if ((q.includes('pior') || q.includes('mais agressivo') || q.includes('principal')) && q.includes('concorrente')) {
                return assistente_findMostAggressiveCompetitor();
            }
            if (q.includes('taxa de perda') && !q.includes('cidade') && !q.includes('vendedor')) {
                return assistente_getGlobalLossRate();
            }
            if (q.includes('margem media') || q.includes('minha margem')) {
                return assistente_getGlobalMargin();
            }
            const cityMatch = q.match(/em ([\w\s]+)|de ([\w\s]+)/);
            if (q.includes('taxa de perda') && cityMatch) {
                const cityName = cityMatch[1] || cityMatch[2];
                return assistente_getLossRateForCity(cityName.trim());
            }
            return `<h4>Não entendi.</h4>
                    <p>Tente perguntar algo como:<br>
                    - "qual o pior vendedor?"<br>
                    - "produto com melhor margem?"<br>
                    - "concorrente mais agressivo?"<br>
                    - "taxa de perda em limeira?"</p>`;
        }
        function assistente_findWorstVendedor() {
            const data = analyzeByGroup(filteredData, 'vendedor');
            const worst = data.sort((a,b) => b.taxaPerda - a.taxaPerda)[0];
            if (!worst) return `<p>Não há dados de vendedores para analisar.</p>`;
            return `<h4>Pior Vendedor (Taxa de Perda)</h4>
                    <p>O vendedor com a maior taxa de perda nos filtros atuais é 
                    <span class="highlight">${worst.key}</span>, com 
                    <span class="highlight">${(worst.taxaPerda * 100).toFixed(1)}%</span> de perdas 
                    (${worst.perdas} de ${worst.total} cotações).</p>`;
        }
        function assistente_findBestVendedor() {
            const data = analyzeByGroup(filteredData, 'vendedor');
            const best = data.sort((a,b) => a.taxaPerda - b.taxaPerda)[0];
            if (!best) return `<p>Não há dados de vendedores para analisar.</p>`;
            return `<h4>Melhor Vendedor (Taxa de Ganho)</h4>
                    <p>O vendedor com a menor taxa de perda (maior taxa de ganho) é 
                    <span class="highlight">${best.key}</span>, com 
                    <span class="highlight">${(best.taxaPerda * 100).toFixed(1)}%</span> de perdas 
                    (${best.perdas} de ${best.total} cotações).</p>`;
        }
        function assistente_findWorstProduct() {
            const data = analyzeByGroup(filteredData, 'nomeProduto');
            const worst = data.sort((a,b) => b.taxaPerda - a.taxaPerda)[0];
            if (!worst) return `<p>Não há dados de produtos para analisar.</a`
            return `<h4>Produto Mais Perdido (Taxa de Perda)</h4>
                    <p>O produto com a maior taxa de perda é 
                    <span class="highlight">${worst.key}</span>, com 
                    <span class="highlight">${(worst.taxaPerda * 100).toFixed(1)}%</span> de perdas 
                    (${worst.perdas} de ${worst.total} cotações).</p>`;
        }
        function assistente_findBestMarginProduct() {
            const data = analyzeByGroup(filteredData, 'nomeProduto');
            const best = data.sort((a,b) => b.avgMinhaMargem - a.avgMinhaMargem)[0];
            if (!best) return `<p>Não há dados de produtos para analisar.</a`
            return `<h4>Produto Mais Rentável (Margem Média)</h4>
                    <p>O produto com a maior margem média (com custo) é 
                    <span class="highlight">${best.key}</span>, com 
                    <span class="highlight">${(best.avgMinhaMargem * 100).toFixed(1)}%</span> de margem.</p>`;
        }
        function assistente_findMostAggressiveCompetitor() {
            const data = analyzeByGroup(filteredData.filter(r => r.vendaPerdida === 'TRUE'), 'concorrenteHeader');
            const worst = data.sort((a,b) => b.total - a.total)[0];
            if (!worst || !worst.key) return `<p>Não há dados de concorrentes nas vendas perdidas.</p>`;
            return `<h4>Concorrente Mais Agressivo</h4>
                    <p>O concorrente que mais aparece nas vendas perdidas é 
                    <span class="highlight">${worst.key}</span>, responsável por 
                    <span class="highlight">${worst.total}</span> cotações perdidas nos filtros atuais.</p>`;
        }
        function assistente_getGlobalLossRate() {
            const total = filteredData.length;
            const perdas = filteredData.filter(r => r.vendaPerdida === 'TRUE').length;
            const taxa = total > 0 ? (perdas / total) : 0;
            return `<h4>Taxa de Perda (Filtro Atual)</h4>
                    <p>A taxa de perda para os filtros selecionados é de 
                    <span class="highlight">${(taxa * 100).toFixed(1)}%</span> 
                    (${perdas} de ${total} cotações).</p>`;
        }
        function assistente_getGlobalMargin() {
            let somaMargem = 0;
            let countComCusto = 0;
            filteredData.forEach(row => {
                if (row.custo > 0) {
                    somaMargem += row.minhaMargem;
                    countComCusto++;
                }
            });
            const media = countComCusto > 0 ? (somaMargem / countComCusto) : 0;
            return `<h4>Margem Média (Filtro Atual)</h4>
                    <p>A sua margem de lucro média (para produtos com custo) é de 
                    <span class="highlight">${(media * 100).toFixed(1)}%</span>.</p>`;
        }
        function assistente_getLossRateForCity(cityName) {
            const cityData = filteredData.filter(r => r.cidade.toLowerCase().includes(cityName.toLowerCase()));
            if (cityData.length === 0) {
                return `<p>Não encontrei dados para a cidade "<span class="highlight">${cityName}</span>" nos filtros atuais.</p>`;
            }
            const total = cityData.length;
            const perdas = cityData.filter(r => r.vendaPerdida === 'TRUE').length;
            const taxa = total > 0 ? (perdas / total) : 0;
            return `<h4>Taxa de Perda em ${cityName}</h4>
                    <p>A taxa de perda para <span class="highlight">${cityName}</span> é de 
                    <span class="highlight">${(taxa * 100).toFixed(1)}%</span> 
                    (${perdas} de ${total} cotações).</p>`;
        }

        /**
         * Função utilitária para o assistente, agrupa dados por uma chave.
         */
        function analyzeByGroup(data, key) {
            const groups = {};
            data.forEach(row => {
                const groupName = row[key] || 'N/A';
                if (!groups[groupName]) {
                    groups[groupName] = { total: 0, perdas: 0, somaMinhaMargem: 0, custoCount: 0 };
                }
                groups[groupName].total++;
                if (row.vendaPerdida === 'TRUE') groups[groupName].perdas++;
                if (row.custo > 0) {
                    groups[groupName].somaMinhaMargem += row.minhaMargem;
                    groups[groupName].custoCount++;
                }
            });
            return Object.keys(groups).map(k => {
                const g = groups[k];
                return {
                    key: k,
                    total: g.total,
                    perdas: g.perdas,
                    taxaPerda: g.total > 0 ? g.perdas / g.total : 0,
                    avgMinhaMargem: g.custoCount > 0 ? g.somaMinhaMargem / g.custoCount : 0
                };
            });
        }
        
        // =======================================================================
        // ETAPA 7: LÓGICA DA ABA "ANÁLISE POR PRODUTO"
        // =======================================================================

        function setupProductSearch() {
            const skuInput = document.getElementById('produto-sku-input');
            const nameInput = document.getElementById('produto-nome-input');
            const resultsContainer = document.getElementById('produto-search-results');
            
            skuInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    const sku = skuInput.value.trim();
                    const product = productList.find(p => p.sku === sku);
                    if (product) {
                        skuInput.value = product.sku;
                        nameInput.value = product.name;
                        currentSelectedProduct = product.name;
                        runProductAnalysis();
                    } else {
                        alert("SKU não encontrado na lista de produtos.");
                    }
                }
            });

            nameInput.addEventListener('input', () => {
                const query = nameInput.value.trim().toUpperCase();
                if (query.length < 2) {
                    resultsContainer.style.display = 'none';
                    return;
                }
                const terms = query.split('*').filter(t => t); 
                const results = productList.filter(product => {
                    const productName = product.name.toUpperCase();
                    return terms.every(term => productName.includes(term));
                }).slice(0, 10);

                resultsContainer.innerHTML = '';
                if (results.length === 0) {
                    resultsContainer.style.display = 'none';
                    return;
                }
                
                results.forEach(product => {
                    const item = document.createElement('div');
                    item.innerHTML = `<strong>${product.sku}</strong> - ${product.name}`;
                    item.onclick = () => {
                        skuInput.value = product.sku;
                        nameInput.value = product.name;
                        resultsContainer.style.display = 'none';
                        currentSelectedProduct = product.name;
                        runProductAnalysis();
                    };
                    resultsContainer.appendChild(item);
                });
                
                // --- CORREÇÃO DE POSICIONAMENTO ---
                const rect = nameInput.getBoundingClientRect();
                resultsContainer.style.left = `${rect.left + window.scrollX}px`;
                resultsContainer.style.top = `${rect.bottom + window.scrollY}px`;
                resultsContainer.style.width = `${rect.width}px`;
                // --- FIM DA CORREÇÃO ---

                resultsContainer.style.display = 'block';
            });
            
            document.addEventListener('click', (e) => {
                if (!e.target.closest('#produto-selector-card')) {
                    resultsContainer.style.display = 'none';
                }
            });
            
            setupProductTableSorting();
        }

        function runProductAnalysis() {
            if (!currentSelectedProduct) {
                document.getElementById('produto-analytics-container').style.display = 'none';
                return;
            }
            
            document.getElementById('produto-analytics-container').style.display = 'block';
            document.getElementById('produto-titulo-kpi').textContent = `Análise Detalhada: ${currentSelectedProduct}`;

            let baseProductData = filteredData.filter(row => row.nomeProduto === currentSelectedProduct);
            
            const ignorarSemCusto = document.getElementById('produto-ignorar-sem-custo').checked;
            if (ignorarSemCusto) {
                baseProductData = baseProductData.filter(row => row.custo > 0);
            }
            
            const vendedores = new Set(baseProductData.map(r => r.vendedor).filter(Boolean));
            const cidades = new Set(baseProductData.map(r => r.cidade).filter(Boolean));
            const concorrentes = new Set(baseProductData.map(r => r.concorrenteHeader).filter(Boolean));
            populateSelect('produto-filter-vendedor', [...vendedores].sort());
            populateSelect('produto-filter-cidade', [...cidades].sort());
            populateSelect('produto-filter-concorrente', [...concorrentes].sort());

            const subFilterVendedor = document.getElementById('produto-filter-vendedor').value;
            const subFilterCidade = document.getElementById('produto-filter-cidade').value;
            const subFilterConcorrente = document.getElementById('produto-filter-concorrente').value;
            
            const displayData = baseProductData.filter(row => {
                if (subFilterVendedor && row.vendedor !== subFilterVendedor) return false;
                if (subFilterCidade && row.cidade !== subFilterCidade) return false;
                if (subFilterConcorrente && row.concorrenteHeader !== subFilterConcorrente) return false;
                return true;
            });
            
            activeProductData = displayData;

            updateProductKPIs(displayData);
            
            const activeSection = document.querySelector('.sidebar li.active').dataset.section;
            if (activeSection === 'produto_detalhe') {
                updateChartProdutoTemporal(displayData);
                updateChartProdutoConcorrentes(displayData);
            }
            
            updateTableProdutoDetalhe(displayData);
        }
        
        function updateProductKPIs(data) {
            let sumFlex = 0, sumConc = 0, sumMinhaMargem = 0, sumMargemConc = 0;
            let countComCusto = 0;
            
            data.forEach(row => {
                sumFlex += row.precoFlex;
                sumConc += row.precoConcorrente;
                if (row.custo > 0) {
                    sumMinhaMargem += row.minhaMargem;
                    sumMargemConc += row.margemParaCobrir;
                    countComCusto++;
                }
            });
            
            const countTotal = data.length || 1;
            const countMargem = countComCusto || 1;
            
            const avgFlex = sumFlex / countTotal;
            const avgConc = sumConc / countTotal;
            const avgMinhaMargem = sumMinhaMargem / countMargem;
            const avgMargemConc = sumMargemConc / countMargem;

            document.getElementById('kpi-produto-meu-preco').textContent = formatCurrency(avgFlex);
            document.getElementById('kpi-produto-conc-preco').textContent = formatCurrency(avgConc);
            document.getElementById('kpi-produto-minha-margem').textContent = `${(avgMinhaMargem * 100).toFixed(1)}%`;
            document.getElementById('kpi-produto-conc-margem').textContent = `${(avgMargemConc * 100).toFixed(1)}%`;
            
            setClassByValue('kpi-produto-minha-margem', avgMinhaMargem, 0.2, 'margin-good', 'margin-warn');
            setClassByValue('kpi-produto-conc-margem', avgMargemConc, 0.1, 'margin-warn', 'margin-bad');
        }
        
        function updateChartProdutoTemporal(data) {
            const ctx = document.getElementById('chart-produto-temporal')?.getContext('2d');
            if (!ctx) return;
            
            const dataByDate = {};
            data.forEach(row => {
                const date = row.dataCotacao;
                if (!dataByDate[date]) dataByDate[date] = { sumFlex: 0, countFlex: 0, sumConc: 0, countConc: 0 };
                dataByDate[date].sumFlex += row.precoFlex;
                dataByDate[date].countFlex++;
                dataByDate[date].sumConc += row.precoConcorrente;
                dataByDate[date].countConc++;
            });
            
            const labels = Object.keys(dataByDate).sort();
            const dataFlex = labels.map(date => dataByDate[date].sumFlex / dataByDate[date].countFlex);
            const dataConc = labels.map(date => dataByDate[date].sumConc / dataByDate[date].countConc);

            if (charts['chart-produto-temporal']) charts['chart-produto-temporal'].destroy();
            charts['chart-produto-temporal'] = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        { label: 'Meu Preço (Flex)', data: dataFlex, borderColor: 'rgba(30, 136, 229, 1)', tension: 0.1 },
                        { label: 'Preço Concorrente', data: dataConc, borderColor: 'rgba(229, 57, 53, 1)', tension: 0.1 }
                    ]
                },
                options: { responsive: true, maintainAspectRatio: false, scales: { y: { ticks: { callback: v => formatCurrency(v) } } }, plugins: { tooltip: { mode: 'index' } } }
            });
        }
        
        function updateChartProdutoConcorrentes(data) {
            const ctx = document.getElementById('chart-produto-concorrentes')?.getContext('2d');
            if (!ctx) return;

            const dataByConc = {};
            data.forEach(row => {
                const conc = row.concorrenteHeader || 'N/A';
                if (!dataByConc[conc]) dataByConc[conc] = { sumPreco: 0, count: 0 };
                dataByConc[conc].sumPreco += row.precoConcorrente;
                dataByConc[conc].count++;
            });
            
            const chartData = Object.keys(dataByConc).map(conc => ({
                concorrente: conc,
                avgPreco: dataByConc[conc].sumPreco / dataByConc[conc].count
            })).sort((a,b) => a.avgPreco - b.avgPreco).slice(0, 5);

            if (charts['chart-produto-concorrentes']) charts['chart-produto-concorrentes'].destroy();
            charts['chart-produto-concorrentes'] = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: chartData.map(d => d.concorrente),
                    datasets: [{ label: 'Preço Médio Concorrente', data: chartData.map(d => d.avgPreco), backgroundColor: 'rgba(255, 152, 0, 0.7)' }]
                },
                options: { responsive: true, maintainAspectRatio: false, scales: { y: { ticks: { callback: v => formatCurrency(v) } } }, plugins: { tooltip: { callbacks: { label: c => formatCurrency(c.raw) } } } }
            });
        }

        function setupProductTableSorting() {
            document.querySelectorAll('#tabela-produto-detalhe th').forEach(th => {
                th.addEventListener('click', () => {
                    const key = th.dataset.key;
                    if (!key) return;
                    let direction = 'asc';
                    if (productSortConfig.key === key && productSortConfig.direction === 'asc') {
                        direction = 'desc';
                    }
                    productSortConfig = { key, direction, type: th.dataset.type };
                    document.querySelectorAll('#tabela-produto-detalhe th').forEach(t => t.className = '');
                    th.classList.add(direction === 'asc' ? 'sorted-asc' : 'sorted-desc');
                    updateTableProdutoDetalhe(activeProductData);
                });
            });
        }

        function updateTableProdutoDetalhe(data) {
            const tbody = document.getElementById('tabela-produto-detalhe')?.getElementsByTagName('tbody')[0];
            if (!tbody) return;
            tbody.innerHTML = '';
            const sortedData = [...data].sort((a, b) => {
                let valA = a[productSortConfig.key];
                let valB = b[productSortConfig.key];
                if (productSortConfig.type === 'number') {
                    return productSortConfig.direction === 'asc' ? valA - valB : valB - valA;
                }
                valA = String(valA || '').toLowerCase();
                valB = String(valB || '').toLowerCase();
                if (valA < valB) return productSortConfig.direction === 'asc' ? -1 : 1;
                if (valA > valB) return productSortConfig.direction === 'asc' ? 1 : -1;
                return 0;
            });

            sortedData.forEach(row => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${row.dataCotacao}</td>
                    <td>${row.vendedor || 'N/A'}</td>
                    <td>${row.cidade || 'N/A'}</td>
                    <td>${row.concorrenteHeader || 'N/A'}</td>
                    <td>${row.marcaConcorrente || 'N/A'}</td>
                    <td>${formatCurrency(row.precoFlex)}</td>
                    <td>${formatCurrency(row.precoConcorrente)}</td>
                    <td>${formatPercent(row.minhaMargem)}</td>
                    <td>${formatPercent(row.margemParaCobrir)}</td>
                    <td>${formatPerdida(row.vendaPerdida)}</td>
                `;
                tbody.appendChild(tr);
            });
        }
        
    </script>
</body>
</html>
