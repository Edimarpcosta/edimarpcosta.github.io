<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Avalia√ß√µes Ameripan</title>
  <style>
    :root {
      --bg:#050816;
      --panel:#0c1224;
      --panel2:#0d1020;
      --text:#edf2ff;
      --muted:#a0a8c6;
      --line:rgba(255,255,255,.08);
      --brand:#60a5fa;
      --good:#22c55e;
      --warn:#eab308;
      --bad:#f97373;
      --shadow:0 18px 45px rgba(0,0,0,.65);
      --radius:16px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background:
        radial-gradient(900px 500px at 10% 0%, rgba(96,165,250,.20), transparent 60%),
        radial-gradient(900px 500px at 90% 0%, rgba(45,212,191,.20), transparent 60%),
        var(--bg);
      color:var(--text);
    }
    a{color:inherit;text-decoration:none}
    button,input,select,textarea{font:inherit}
    .app{min-height:100%;display:flex;}

    /* Sidebar */
    .sidebar{
      width:280px;
      background:linear-gradient(180deg,rgba(12,18,36,.98),rgba(7,11,25,.98));
      border-right:1px solid var(--line);
      padding:16px;
      position:sticky;
      top:0;
      height:100vh;
      overflow:auto;
    }
    .brand{
      display:flex;align-items:center;gap:10px;
      padding:8px 8px 14px;
    }
    .logo{
      width:38px;height:38px;border-radius:14px;
      background:radial-gradient(circle at 30% 0%,rgba(250,250,250,.9),rgba(96,165,250,.2));
      border:1px solid rgba(96,165,250,.6);
      display:grid;place-items:center;
      box-shadow:0 0 0 1px rgba(15,23,42,.9), var(--shadow);
      font-weight:900;
      letter-spacing:-0.08em;
    }
    .brand h1{margin:0;font-size:15px;}
    .brand p{margin:2px 0 0;font-size:11px;color:var(--muted);}
    .nav{display:flex;flex-direction:column;gap:6px;margin-top:10px;}
    .nav a{
      display:flex;align-items:center;gap:10px;
      padding:9px 11px;
      border-radius:12px;
      border:1px solid transparent;
      color:var(--text);
      font-size:14px;
      opacity:.92;
    }
    .nav a span.icon{width:20px;text-align:center;}
    .nav a:hover{
      background:rgba(255,255,255,.03);
      border-color:rgba(255,255,255,.08);
    }
    .nav a.active{
      background:rgba(96,165,250,.15);
      border-color:rgba(96,165,250,.6);
    }
    .nav a.disabled{
      opacity:.4;
      cursor:not-allowed;
    }
    .pill{
      margin-left:auto;
      font-size:11px;
      padding:3px 8px;
      border-radius:999px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.02);
      color:var(--muted);
    }
    .side-footer{
      margin-top:18px;
      padding-top:12px;
      border-top:1px solid var(--line);
      font-size:12px;
      color:var(--muted);
    }
    .side-footer .row{display:flex;justify-content:space-between;gap:10px;align-items:center;flex-wrap:wrap;}
    
    /* Buttons with Animation */
    .btn{
      cursor:pointer;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.16);
      background:rgba(15,23,42,.9);
      color:var(--text);
      padding:8px 13px;
      font-size:13px;
      display:inline-flex;
      align-items:center;
      gap:6px;
      transition:.16s ease;
      position: relative;
      overflow: hidden;
    }
    .btn:hover{
      transform:translateY(-1px);
      box-shadow:0 8px 18px rgba(0,0,0,.45);
      background:rgba(15,23,42,.98);
    }
    /* Button Ripple Effect logic handled in CSS/JS interaction, visually defined here */
    .btn::before {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 0;
      height: 0;
      border-radius: 50%;
      background: rgba(255,255,255,.1);
      transform: translate(-50%, -50%);
      transition: width 0.6s, height 0.6s;
    }
    .btn:active::before {
      width: 300px;
      height: 300px;
    }

    .btn.primary{
      background:linear-gradient(135deg,rgba(96,165,250,.85),rgba(59,130,246,.95));
      border-color:rgba(191,219,254,.9);
      color:#0b1120;
      font-weight:600;
    }
    .btn.danger{
      background:rgba(248,113,113,.1);
      border-color:rgba(248,113,113,.6);
      color:#fecaca;
    }
    .btn:disabled{
      opacity:.55;
      cursor:not-allowed;
      transform:none;
      box-shadow:none;
    }

    .main{
      flex:1;
      padding:22px;
      max-width:1200px;
      margin:0 auto;
      width:100%;
    }

    /* Mobile header & drawer */
    .mobile-header{
      display:none;
      position:sticky;
      top:0;
      z-index:30;
      padding:10px 14px;
      background:rgba(5,8,22,.92);
      backdrop-filter:blur(14px);
      border-bottom:1px solid var(--line);
    }
    .mobile-header .bar{
      display:flex;
      justify-content:space-between;
      align-items:center;
      max-width:1200px;
      margin:0 auto;
      gap:10px;
    }
    .drawer-backdrop{
      display:none;
      position:fixed;
      inset:0;
      background:rgba(0,0,0,.45);
      z-index:40;
    }
    .drawer{
      position:fixed;
      top:0;left:0;
      height:100vh;
      width:88vw;
      max-width:320px;
      transform:translateX(-110%);
      transition:.2s ease;
      z-index:50;
      box-shadow:var(--shadow);
    }
    .drawer.open{transform:translateX(0);}
    .drawer-backdrop.open{display:block;}

    /* Layout helpers */
    .grid{display:grid;gap:14px;}
    .grid.kpis{grid-template-columns:repeat(4,minmax(0,1fr));}
    .grid.two{grid-template-columns:repeat(2,minmax(0,1fr));}
    .grid.three{grid-template-columns:repeat(3,minmax(0,1fr));}
    
    /* Card Hover Improvements */
    .card{
      background:linear-gradient(135deg,rgba(15,23,42,.94),rgba(15,23,42,.96));
      border-radius:var(--radius);
      border:1px solid var(--line);
      box-shadow:var(--shadow);
      padding:14px;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    .card:hover {
      transform: translateY(-2px);
      box-shadow: 0 20px 50px rgba(0,0,0,.75);
    }
    
    .card h2{
      margin:0 0 8px;
      font-size:14px;
      font-weight:600;
      color:var(--muted);
      text-transform:uppercase;
      letter-spacing:.06em;
    }
    .card .big{
      font-size:27px;
      font-weight:800;
      letter-spacing:-0.04em;
    }
    .muted{color:var(--muted);}
    .sep{height:1px;background:var(--line);margin:12px 0;}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap;}
    .row.end{justify-content:flex-end;}
    .row.between{justify-content:space-between;}

    .field{display:flex;flex-direction:column;gap:6px;width:100%;}
    .field label{font-size:12px;color:var(--muted);}
    .hint{font-size:12px;color:var(--muted);}
    .input,.select,.textarea{
      width:100%;
      padding:9px 11px;
      border-radius:12px;
      border:1px solid rgba(148,163,184,.45);
      background:rgba(15,23,42,.9);
      color:var(--text);
      outline:none;
      font-size:13px;
    }
    .input:focus,.select:focus,.textarea:focus{
      border-color:rgba(96,165,250,.9);
      box-shadow:0 0 0 1px rgba(96,165,250,.7);
    }
    /* Disabled state improvement */
    .input:disabled, .select:disabled, .textarea:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      background: rgba(15,23,42,.5);
    }
    .textarea{min-height:80px;resize:vertical;}

    .badge{
      font-size:11px;
      padding:4px 10px;
      border-radius:999px;
      border:1px solid var(--line);
      background:rgba(15,23,42,.9);
      color:var(--muted);
      display:inline-flex;
      align-items:center;
      gap:6px;
    }
    .badge.good{
      border-color:rgba(34,197,94,.7);
      background:rgba(34,197,94,.16);
      color:#dcfce7;
    }
    .badge.warn{
      border-color:rgba(234,179,8,.7);
      background:rgba(234,179,8,.18);
      color:#fef9c3;
    }
    .badge.bad{
      border-color:rgba(248,113,113,.7);
      background:rgba(248,113,113,.16);
      color:#fee2e2;
    }

    .table{
      width:100%;
      border-collapse:collapse;
      overflow:hidden;
      border-radius:14px;
      border:1px solid var(--line);
      font-size:13px;
    }
    .table th,.table td{
      padding:8px 10px;
      border-bottom:1px solid var(--line);
      text-align:left;
    }
    .table th{
      font-size:11px;
      text-transform:uppercase;
      letter-spacing:.08em;
      color:var(--muted);
      background:rgba(15,23,42,.94);
    }
    .table tr:hover td{
      background:rgba(15,23,42,.96);
    }
    .table td.nowrap{white-space:nowrap;}

    /* Questions */
    .q-list{display:grid;gap:10px;}
    .q{
      padding:11px 12px;
      border-radius:14px;
      border:1px solid var(--line);
      background:rgba(15,23,42,.9);
    }
    .q .top{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:10px;
    }
    .q .title{font-size:13px;font-weight:600;}
    .q .desc{font-size:12px;color:var(--muted);margin-top:4px;}
    .q .opts{margin-top:8px;display:flex;gap:8px;flex-wrap:wrap;}
    .chip{
      cursor:pointer;
      padding:7px 10px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,.7);
      background:rgba(15,23,42,1);
      font-size:12px;
    }
    .chip.active{
      background:rgba(96,165,250,.18);
      border-color:rgba(96,165,250,.9);
    }

    .page{display:none;}
    .page.active{display:block;}

    /* Spinner for Loading State */
    .spinner {
      width: 16px;
      height: 16px;
      border: 2px solid var(--line);
      border-top-color: var(--brand);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Responsive */
    @media (max-width: 1100px){
      .grid.kpis{grid-template-columns:repeat(2,minmax(0,1fr));}
    }
    @media (max-width: 840px){
      .sidebar{display:none;}
      .mobile-header{display:block;}
      .main{padding:16px;}
      .grid.two,.grid.three,.grid.kpis{grid-template-columns:1fr;}
      .drawer .sidebar{
        display:block;
        width:100%;
        height:100%;
        position:static;
        border-right:none;
      }
      /* Improved Touch Targets for Mobile */
      .btn, .chip, .nav a {
        min-height: 44px;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .input, .select, .textarea {
        font-size: 16px; /* Prevents iOS zoom */
      }
      .table-wrap {
        -webkit-overflow-scrolling: touch;
      }
    }
  
    /* Records table */
    .table-wrap{overflow:auto; border-radius:14px; border:1px solid rgba(148,163,184,.18); background:rgba(2,6,23,.35);}
    table.tbl{width:100%; border-collapse:separate; border-spacing:0; min-width:860px;}
    .tbl thead th{position:sticky; top:0; background:rgba(15,23,42,.92); backdrop-filter:blur(10px);
      text-align:left; padding:10px 12px; font-size:12px; color:#cbd5e1; border-bottom:1px solid rgba(148,163,184,.18);}
    .tbl tbody td{padding:10px 12px; font-size:13px; color:#e5e7eb; border-bottom:1px solid rgba(148,163,184,.08); vertical-align:top;}
    .tbl tbody tr:hover td{background:rgba(148,163,184,.06);}
    .tbl .mutedcell{color:#94a3b8; font-size:12px;}
    .pagination{display:flex; align-items:center; gap:8px;}

    /* Modal */
    .modal-backdrop{position:fixed; inset:0; background:rgba(0,0,0,.55); display:none; align-items:center; justify-content:center; z-index:70; padding:18px;}
    .modal-backdrop.open{display:flex;}
    .modal{width:min(980px, 100%); max-height:85vh; overflow:auto;}
    .modal .header{display:flex; align-items:flex-start; justify-content:space-between; gap:10px;}
    .modal .header h2{margin:0;}
    .modal .close{cursor:pointer; user-select:none; padding:6px 10px; border-radius:10px; border:1px solid rgba(148,163,184,.22); background:rgba(15,23,42,.5);}
    .pill{display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:999px; border:1px solid rgba(148,163,184,.18); background:rgba(15,23,42,.55); color:#e5e7eb; font-size:12px;}

</style>
</head>
<body>

  <div class="mobile-header">
    <div class="bar">
      <button class="btn" id="btnOpenMenu">‚ò∞ Menu</button>
      <span class="badge" id="mobileUserBadge">Offline</span>
    </div>
  </div>

  <div class="drawer-backdrop" id="drawerBackdrop"></div>
  <div class="drawer" id="drawer">
    <aside class="sidebar" id="drawerSidebar"></aside>
  </div>

  <div class="app">
    <aside class="sidebar" id="sidebar"></aside>

    <main class="main">
      <section class="page" id="page-login">
        <div class="card" style="max-width:480px;margin:28px auto;">
          <h2>Entrar</h2>
          <div class="sep"></div>
          <div class="grid" style="gap:12px;">
            <div class="field">
              <label>Usu√°rio</label>
              <input class="input" id="loginUser" autocomplete="username" />
            </div>
            <div class="field">
              <label>Senha</label>
              <input class="input" id="loginPass" type="password" autocomplete="current-password" />
            </div>
            <div class="row end">
              <button class="btn primary" id="btnLogin">Entrar</button>
            </div>
            <div class="hint" id="loginMsg"></div>
          </div>
        </div>
      </section>

      <section class="page" id="page-dashboard">
        <div class="row between" style="align-items:flex-end;">
          <div>
            <div class="muted" style="font-size:13px;">Vis√£o geral</div>
            <div style="font-size:22px;font-weight:800;letter-spacing:-.04em;">Dashboard</div>
          </div>
          <div class="row">
            <span class="badge" id="dashScopeBadge">Escopo</span>
            <button class="btn" id="btnRefreshDash">Atualizar</button>
          </div>
        </div>

        <div class="sep"></div>

        <div class="card">
          <h2>Filtros do dashboard</h2>
          <div class="grid three" style="gap:10px;">
            <div class="field">
              <label>Data in√≠cio</label>
              <input class="input" type="date" id="dashFrom" />
            </div>
            <div class="field">
              <label>Data fim</label>
              <input class="input" type="date" id="dashTo" />
            </div>
            <div class="field">
              <label>Equipe</label>
              <select class="select" id="dashTeam"><option value="TODOS">Todas</option></select>
            </div>
            <div class="field">
              <label>Vendedor</label>
              <select class="select" id="dashVendor"><option value="TODOS">Todos</option></select>
            </div>
            <div class="field">
              <label>&nbsp;</label>
              <button class="btn primary" id="btnApplyDash">Aplicar</button>
            </div>
            <div class="field">
              <label>&nbsp;</label>
              <button class="btn" id="btnResetDash">M√™s atual</button>
            </div>
          </div>
          <div class="hint" id="dashFilterHint">Dica: supervisores veem apenas a pr√≥pria equipe.</div>
        </div>

        <div class="sep"></div>

        <div class="grid kpis">
          <div class="card">
            <h2>Total de avalia√ß√µes</h2>
            <div class="big" id="kpiTotal">‚Äî</div>
            <div class="muted" id="kpiTotHint">Registros filtrados</div>
          </div>
          <div class="card">
            <h2>M√©dia geral</h2>
            <div class="big" id="kpiAvg">‚Äî</div>
            <div class="muted">Escala 0‚Äì10</div>
          </div>
          <div class="card">
            <h2>Vendedores √∫nicos</h2>
            <div class="big" id="kpiVend">‚Äî</div>
            <div class="muted">Na amostra atual</div>
          </div>
          <div class="card">
            <h2>Equipes √∫nicas</h2>
            <div class="big" id="kpiTeams">‚Äî</div>
            <div class="muted">Na amostra atual</div>
          </div>
        </div>

        <div class="sep"></div>

        <div class="grid two">
          <div class="card">
            <h2>Status das avalia√ß√µes</h2>
            <div class="row" style="margin-top:6px;">
              <span class="badge good" id="kpiHigh">ALTO: ‚Äî</span>
              <span class="badge warn" id="kpiMid">M√âDIO: ‚Äî</span>
              <span class="badge bad" id="kpiLow">BAIXO: ‚Äî</span>
            </div>
          </div>
          <div class="card">
            <h2>Top falhas</h2>
            <div id="dashTopFalhas" class="muted" style="font-size:12px;">‚Äî</div>
          </div>
        </div>

        <div class="sep"></div>

        <div class="card">
          <h2>√öltimos registros (timeline)</h2>
          <div id="dashTimeline" class="muted" style="font-size:12px;">Carregando‚Ä¶</div>
        </div>
      </section>

      <section class="page" id="page-evaluation">
        <div class="row between" style="align-items:flex-end;">
          <div>
            <div class="muted" style="font-size:13px;">Registro</div>
            <div style="font-size:22px;font-weight:800;letter-spacing:-.04em;">Nova avalia√ß√£o</div>
          </div>
          <div class="row">
            <span class="badge" id="evalScoreBadge">Nota: ‚Äî</span>
            <span class="badge" id="evalStatusBadge">Status: ‚Äî</span>
          </div>
        </div>

        <div class="sep"></div>

        <div class="grid two">
          <div class="card">
            <h2>Vendedor & equipe</h2>
            <div class="grid" style="gap:10px;">
              <div class="field">
                <label>Vendedor</label>
                <select class="select" id="evalVendor"></select>
                <div class="hint">Lista vem do login (planilha USERS).</div>
              </div>
              <div class="field">
                <label>Equipe</label>
                <input class="input" id="evalTeam" readonly />
                <div class="hint">Preenchido automaticamente pela planilha.</div>
              </div>

              <div class="sep" style="grid-column:1/-1;"></div>

              <div class="field" style="grid-column:1/-1;">
                <label>Problema Extra (N√£o afeta a nota)</label>
                <input
                  class="input"
                  id="extraTitulo"
                  placeholder="T√≠tulo (ex.: Uniforme)"
                />
              </div>

              <div class="field" style="grid-column:1/-1;">
                <label>Detalhe do problema extra</label>
                <textarea
                  class="textarea"
                  id="extraObs"
                  placeholder="Descreva o problema extra em detalhes."
                ></textarea>
              </div>

              <div class="row end" style="grid-column:1/-1;">
                <button class="btn" id="btnLoadHistory">Carregar hist√≥rico</button>
              </div>
              <div class="hint" id="historyMsg" style="grid-column:1/-1;"></div>
            </div>
          </div>

          <div class="card">
            <h2>Hist√≥rico recente</h2>
            <div class="hint">√öltimas 5 avalia√ß√µes do vendedor selecionado.</div>
            <div class="sep"></div>
            <div id="historyList" class="grid" style="gap:8px;"></div>
          </div>
        </div>

        <div class="sep"></div>

        <div class="card">
          <h2>Perguntas (q1‚Ä¶q13)</h2>
          <div class="hint">Clique em 1 / 0.5 / 0 / NA para cada pergunta.</div>
          <div class="sep"></div>
          <div id="questions" class="q-list"></div>
        </div>

        <div class="sep"></div>

        <div class="grid two">
          <div class="card">
            <h2>Feedbacks</h2>
            <div class="grid" style="gap:10px;">
              <div class="field"><label>Rota</label><textarea class="textarea" id="fbRota"></textarea></div>
              <div class="field"><label>Prepara√ß√£o</label><textarea class="textarea" id="fbPrep"></textarea></div>
              <div class="field"><label>P√≥s</label><textarea class="textarea" id="fbPos"></textarea></div>
              <div class="field"><label>Abertura</label><textarea class="textarea" id="fbAber"></textarea></div>
              <div class="field"><label>Campanha</label><textarea class="textarea" id="fbCamp"></textarea></div>
              <div class="field"><label>Gest√£o</label><textarea class="textarea" id="fbGest"></textarea></div>
            </div>
          </div>

          <div class="card">
            <h2>Observa√ß√µes & envio</h2>
            <div class="grid" style="gap:10px;">
              <div class="field">
                <label>Observa√ß√£o geral</label>
                <textarea class="textarea" id="obsGeral"></textarea>
              </div>
              <div class="field">
                <label>Resumo das Falhas (Aparecer√° no pr√≥ximo briefing)</label>
                <textarea
                  class="textarea"
                  id="listaFalhas"
                  placeholder="Ex.: N√£o ofereceu mix ideal, faltou uniforme..."
                ></textarea>
              </div>
              <div class="sep"></div>
              <div class="row end">
                <button class="btn primary" id="btnSubmitEval">Enviar avalia√ß√£o</button>
              </div>
              <div class="hint" id="evalMsg"></div>
            </div>
          </div>
        </div>
      </section>

      

      <section class="page" id="page-records">
        <div class="row between" style="align-items:flex-end;">
          <div>
            <div class="muted" style="font-size:13px;">Consulta</div>
            <div style="font-size:22px;font-weight:800;letter-spacing:-.04em;">Avalia√ß√µes</div>
          </div>
          <div class="row" style="flex-wrap:wrap;">
            <button class="btn" id="btnRecPdf">Exportar PDF</button>
            <button class="btn" id="btnRecXlsx">Exportar XLSX</button>
          </div>
        </div>

        <div class="sep"></div>

        <div class="card">
          <h2>Filtros</h2>
          <div class="grid three" style="gap:10px;">
            <div class="field" style="grid-column:1/-1;">
              <label>Busca</label>
              <input class="input" id="recSearch" placeholder="Buscar por vendedor, supervisor ou equipe‚Ä¶" />
              <div class="hint">Atalho: Ctrl+K. A busca √© aplicada em Vendedor, Supervisor e Equipe.</div>
            </div>
            <div class="field">
              <label>Data in√≠cio</label>
              <input class="input" type="date" id="recFrom" />
            </div>
            <div class="field">
              <label>Data fim</label>
              <input class="input" type="date" id="recTo" />
            </div>
            <div class="field">
              <label>Equipe</label>
              <select class="select" id="recTeam"><option value="TODOS">Todas</option></select>
            </div>
            <div class="field">
              <label>Vendedor</label>
              <select class="select" id="recVendor"><option value="TODOS">Todos</option></select>
            </div>
            <div class="field">
              <label>Registros por p√°gina</label>
              <select class="select" id="recPageSize">
                <option value="10">10</option>
                <option value="25" selected>25</option>
                <option value="50">50</option>
              </select>
            </div>
            <div class="field">
              <label>&nbsp;</label>
              <button class="btn primary" id="btnRecApply">Aplicar</button>
            </div>
          </div>
          <div class="hint" id="recHint">Supervisores enxergam apenas a pr√≥pria equipe.</div>
        </div>

        <div class="sep"></div>

        <div class="card">
          <div class="row between" style="align-items:center;">
            <h2 style="margin:0;">Lista</h2>
            <div class="pagination">
              <button class="btn" id="btnRecPrev">‚óÄ</button>
              <div class="muted" id="recPageInfo">P√°gina ‚Äî</div>
              <button class="btn" id="btnRecNext">‚ñ∂</button>
            </div>
          </div>
          <div class="sep"></div>
          <div id="recTable" class="muted" style="font-size:12px;">Carregando‚Ä¶</div>
        </div>
      </section>

      <section class="page" id="page-analytics">
        <div class="row between" style="align-items:flex-end;">
          <div>
            <div class="muted" style="font-size:13px;">Consultas & insights</div>
            <div style="font-size:22px;font-weight:800;letter-spacing:-.04em;">Relat√≥rios</div>
          </div>
          <div class="row">
            <button class="btn" id="btnLoadFilters">Carregar filtros</button>
          </div>
        </div>

        <div class="sep"></div>

        <div class="card">
          <h2>Filtros</h2>
          <div class="grid three" style="gap:10px;">
            <div class="field">
              <label>Data in√≠cio</label>
              <input class="input" type="date" id="fltFrom" />
            </div>
            <div class="field">
              <label>Data fim</label>
              <input class="input" type="date" id="fltTo" />
            </div>
            <div class="field">
              <label>Equipe</label>
              <select class="select" id="fltTeam">
                <option value="TODOS">Todas</option>
              </select>
            </div>
            <div class="field">
              <label>Vendedor</label>
              <select class="select" id="fltVendor">
                <option value="TODOS">Todos</option>
              </select>
            </div>
            <div class="field">
              <label>&nbsp;</label>
              <button class="btn primary" id="btnApplyAnalytics">Aplicar filtros</button>
            </div>
          </div>
        </div>

        <div class="sep"></div>

        <div class="grid two">
          <div class="card">
            <h2>Resumo filtrado</h2>
            <div id="anaSummary" class="muted" style="font-size:13px;">Sem dados ainda.</div>
          </div>
          <div class="card">
            <h2>Notas por pergunta</h2>
            <div id="anaQuestions" class="muted" style="font-size:12px;">‚Äî</div>
          </div>
        </div>

        <div class="sep"></div>

        <div class="grid two">
          <div class="card">
            <h2>Top falhas</h2>
            <div id="anaTopFalhas" class="muted" style="font-size:12px;">‚Äî</div>
          </div>
          <div class="card">
            <h2>Pontos positivos</h2>
            <div id="anaTopPos" class="muted" style="font-size:12px;">‚Äî</div>
          </div>
        </div>

        <div class="sep"></div>

        <div class="card">
          <h2>Timeline (√∫ltimas avalia√ß√µes)</h2>
          <div id="anaTimeline" class="muted" style="font-size:12px;">‚Äî</div>
        </div>

        <div class="sep"></div>

        <div class="card">
          <h2>An√°lise por vendedor</h2>
          <div class="grid" style="gap:10px;">
            <div class="field">
              <label>Vendedor</label>
              <select class="select" id="vaVendor">
                <option value="">Selecione um vendedor‚Ä¶</option>
              </select>
            </div>
            <div id="vaSummary" class="muted" style="font-size:12px;">Selecione um vendedor para ver o hist√≥rico.</div>
          </div>
        </div>
      </section>

      <section class="page" id="page-settings">
        <div class="row between" style="align-items:flex-end;">
          <div>
            <div class="muted" style="font-size:13px;">Conta</div>
            <div style="font-size:22px;font-weight:800;letter-spacing:-.04em;">Configura√ß√µes</div>
          </div>
        </div>
        <div class="sep"></div>

        <div class="card" style="max-width:640px;">
          <h2>Alterar senha</h2>
          <div class="sep"></div>
          <div class="grid two" style="gap:10px;">
            <div class="field">
              <label>Senha atual</label>
              <input class="input" type="password" id="curPass" />
            </div>
            <div class="field">
              <label>Nova senha</label>
              <input class="input" type="password" id="newPass" />
            </div>
            <div class="field" style="grid-column:1/-1;">
              <label>Confirmar nova senha</label>
              <input class="input" type="password" id="newPass2" />
            </div>
          </div>
          <div class="sep"></div>
          <div class="row end">
            <button class="btn primary" id="btnChangePass">Salvar</button>
          </div>
          <div class="hint" id="setMsg"></div>
        </div>
      </section>

      <section class="page" id="page-locked">
        <div class="card" style="max-width:520px;margin:28px auto;">
          <h2>Acesso restrito</h2>
          <div class="sep"></div>
          <div class="hint">Fa√ßa login para acessar o sistema.</div>
          <div class="sep"></div>
          <button class="btn primary" onclick="Router.go('login')">Ir para login</button>
        </div>
      </section>
    </main>
  </div>

<script>
/* =============================
   CONFIG
============================= */
const CONFIG = {
  API_URL: "https://script.google.com/macros/s/AKfycbxH1FYU3nH_8uuV8IkMebjSy-r5nxeAzkwKGJGGGXycAco5lVIl5JilWYqTYA5rJ9D5/exec",
  STORAGE_KEY: "ameripan_user"
};

/* =============================
   PERGUNTAS (q1..q13)
============================= */
const QUESTIONS = [
  { key: "q1",  title: "1. Leitura de ponto de venda",    desc: "" },
  { key: "q2",  title: "2. Consulta o Estoque",           desc: "" },
  { key: "q3",  title: "3. Identifica oportunidades",     desc: "" },
  { key: "q4",  title: "4. Repassa √∫ltimos itens",        desc: "" },
  { key: "q5",  title: "5. Oferece \"pedido ideal\"",     desc: "" },
  { key: "q6",  title: "6. Oferece Lan√ßamentos",          desc: "" },
  { key: "q7",  title: "7. Apresenta Cat√°logo",           desc: "" },
  { key: "q8",  title: "8. Oportunidade visita t√©cnica",  desc: "" },
  { key: "q9",  title: "9. Foca nas Campanhas",           desc: "" },
  { key: "q10", title: "10. Poder de Negocia√ß√£o",         desc: "" },
  { key: "q11", title: "11. Fecha a Venda",               desc: "" },
  { key: "q12", title: "12. Faz o P√≥s Venda",             desc: "" },
  { key: "q13", title: "13. Apresent√°vel (Uniforme)",     desc: "" }
];

const ANSWER_OPTIONS = [
  { label: "1",   value: 1 },
  { label: "0.5", value: 0.5 },
  { label: "0",   value: 0 },
  { label: "NA",  value: "NA" }
];

/* =============================
   IMPROVEMENTS (Validator, Loading, Offline)
============================= */
const Validator = {
  required(value, fieldName) {
    if (!value || String(value).trim() === '') {
      throw new Error(`${fieldName} √© obrigat√≥rio`);
    }
  },
  
  evaluation(answers) {
    let hasAnswer = false;
    for (const q of QUESTIONS) {
      const val = answers[q.key];
      if (val !== 'NA') hasAnswer = true;
      if (val !== 'NA' && val !== 0 && val !== 0.5 && val !== 1) {
        throw new Error(`Resposta inv√°lida na pergunta: ${q.title}`);
      }
    }
    if (!hasAnswer) {
      throw new Error('Responda pelo menos uma pergunta');
    }
  }
};

const Loading = {
  show(elementId, message = 'Carregando...') {
    const el = document.getElementById(elementId);
    if (!el) return;
    el.setAttribute('data-original', el.innerHTML);
    el.disabled = true;
    el.innerHTML = `
      <div style="display:flex;align-items:center;gap:10px;">
        <div class="spinner"></div>
        <span>${esc(message)}</span>
      </div>
    `;
  },
  
  hide(elementId) {
    const el = document.getElementById(elementId);
    if (!el) return;
    el.disabled = false;
    const original = el.getAttribute('data-original');
    if (original) el.innerHTML = original;
  }
};

const OfflineQueue = {
  KEY: 'ameripan_offline_queue',
  
  add(evaluation) {
    const queue = this.getAll();
    queue.push({ ...evaluation, _offline: true, _timestamp: Date.now() });
    localStorage.setItem(this.KEY, JSON.stringify(queue));
    UI.toast('Salvo offline. Ser√° enviado quando conectar.');
  },
  
  getAll() {
    const data = localStorage.getItem(this.KEY);
    return data ? JSON.parse(data) : [];
  },
  
  async sync() {
    const queue = this.getAll();
    if (!queue.length) return;
    
    UI.toast(`Sincronizando ${queue.length} avalia√ß√µes...`);
    
    // Process one by one to avoid race conditions
    for (const item of queue) {
      try {
        // Remove offline flags before sending
        const payload = { ...item };
        delete payload._offline;
        delete payload._timestamp;
        
        const res = await Api.saveEvaluation(payload);
        if(res.success) {
           this.remove(item._timestamp);
        }
      } catch (err) {
        console.error('Erro ao sincronizar item:', err);
      }
    }
    UI.toast('Sincroniza√ß√£o conclu√≠da.');
  },
  
  remove(timestamp) {
    const queue = this.getAll().filter(i => i._timestamp !== timestamp);
    localStorage.setItem(this.KEY, JSON.stringify(queue));
  }
};


/* =============================
   DOM√çNIO (regras da avalia√ß√£o)
============================= */
const Domain = {
  calculateScore(answers) {
    let sum = 0, valid = 0;
    for (const q of QUESTIONS) {
      const v = answers[q.key];
      if (v === "NA" || v === undefined || v === null) continue;
      valid++;
      sum += Number(v);
    }
    if (!valid) return 0;
    const score = (sum / valid) * 10;
    return Math.round(score * 10) / 10;
  },

  statusFromScore(score) {
    if (score < 6) return "BAIXO";
    if (score < 9.5) return "MEDIO";
    return "ALTO";
  },

  // payload no formato esperado por apiSaveEvaluation em Code.gs
  buildEvaluationPayload({ user, vendor, answers, extraTitulo, extraObs, feedbacks, obsGeral, listaFalhas }) {
    const notaFinal = Domain.calculateScore(answers);
    const statusResultado = Domain.statusFromScore(notaFinal);

    return {
      supervisorLogin: user?.login || "",
      supervisorName:  user?.name || "",
      vendorId:   vendor?.code || "",
      vendorName: vendor?.name || "",
      equipe:     vendor?.team || user?.team || "",

      notaFinal,
      statusResultado,

      // q1..q13
      ...answers,

      // extras
      extraTitulo: extraTitulo || "",
      extraObs: extraObs || "",

      // feedbacks
      fbRota: feedbacks.fbRota || "",
      fbPrep: feedbacks.fbPrep || "",
      fbPos:  feedbacks.fbPos  || "",
      fbAber: feedbacks.fbAber || "",
      fbCamp: feedbacks.fbCamp || "",
      fbGest: feedbacks.fbGest || "",

      // gerais
      obsGeral:   obsGeral   || "",
      listaFalhas: listaFalhas || ""
    };
  }
};

/* =============================
   API (Apps Script)
============================= */
const Api = {
  async request(action, data = {}) {
    const payload = { action, ...data };

    // Network check for immediate failure if offline
    if (!navigator.onLine && action === 'saveEvaluation') {
      throw new Error('OFFLINE');
    }

    const res = await fetch(CONFIG.API_URL, {
      method: "POST",
      headers: { "Content-Type": "text/plain;charset=utf-8" },
      body: JSON.stringify(payload)
    });

    const text = await res.text();
    let json;
    try { json = JSON.parse(text); }
    catch {
      throw new Error("Resposta inv√°lida do servidor: " + text);
    }

    // Code.gs usa { error:true, msg:"..." } em algumas rotas
    if (json && json.error) {
      throw new Error(json.msg || "Erro na API");
    }
    return json;
  },

  login(user, pass) {
    return this.request("login", { user, pass });
  },

  changePassword(user, oldPass, newPass) {
    return this.request("changePassword", { user, oldPass, newPass });
  },

  getHistory(vendorId) {
    return this.request("getHistory", { vendorId });
  },

  saveEvaluation(payloadObj) {
    return this.request("saveEvaluation", { payload: payloadObj });
  },

  getGeneralAnalytics(filters = {}) {
    return this.request("getGeneralAnalytics", { filters });
  },

  getVendorList() {
    return this.request("getVendorList", {});
  },

  getTeamList() {
    return this.request("getTeamList", {});
  },

  getVendorAnalytics(vendorId) {
    return this.request("getVendorAnalytics", { vendorId });
  }  ,

  // Lista paginada (Avalia√ß√µes)
  getEvaluationsPage(params) {
    return this.request("getEvaluationsPage", params);
  },

  // Exporta√ß√£o (PDF/XLSX) retornando base64
  exportReport(params) {
    return this.request("exportReport", params);
  },

  // Compatibilidade com vers√£o React (retorna array em data)
  getAllEvaluations(filters) {
    return this.request("getAllEvaluations", { filters });
  }

};

/* =============================
   ESTADO GLOBAL
============================= */
const State = {
  user: null,
  drawerOpen: false,
  answers: Object.fromEntries(QUESTIONS.map(q => [q.key, "NA"])),
  vendorList: [],
  teamList: [],
  lastAnalytics: null,
  recordsPage: 1,
  recordsTotalPages: 1,
  modalEval: null
};

function loadUser() {
  const raw = localStorage.getItem(CONFIG.STORAGE_KEY);
  if (!raw) return null;
  try { return JSON.parse(raw); } catch { return null; }
}
function saveUser(user) {
  State.user = user;
  localStorage.setItem(CONFIG.STORAGE_KEY, JSON.stringify(user));
}
function clearUser() {
  State.user = null;
  localStorage.removeItem(CONFIG.STORAGE_KEY);
}

/* =============================
   ROUTER
============================= */
const Router = {
  current: "login",
  go(page) {
    location.hash = "#" + page;
  },
  resolve() {
    const page = (location.hash || "#login").replace("#", "") || "login";
    Router.current = page;
    UI.render();
  }
};
window.addEventListener("hashchange", Router.resolve);

/* =============================
   HELPERS
============================= */
const $  = (sel) => document.querySelector(sel);
const $$ = (sel) => Array.from(document.querySelectorAll(sel));

function esc(str) {
  return String(str || "").replace(/[&<>"']/g, c => (
    { "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[c]
  ));
}
function statusBadge(status) {
  if (status === "ALTO") return `<span class="badge good">ALTO</span>`;
  if (status === "MEDIO" || status === "M√âDIO") return `<span class="badge warn">M√âDIO</span>`;
  if (status === "BAIXO") return `<span class="badge bad">BAIXO</span>`;
  return `<span class="badge">${esc(status || "")}</span>`;
}
function formatScore(v) {
  if (v === null || v === undefined || isNaN(v)) return "‚Äî";
  return Number(v).toFixed(1);
}



function toLocalISODate(d) {
  const off = d.getTimezoneOffset();
  const dt = new Date(d.getTime() - off * 60000);
  return dt.toISOString().slice(0, 10);
}

function monthBounds(date = new Date()) {
  const y = date.getFullYear();
  const m = date.getMonth();
  const first = new Date(y, m, 1);
  const last  = new Date(y, m + 1, 0);
  return { from: toLocalISODate(first), to: toLocalISODate(last) };
}

function scopeFilters(filters) {
  const u = State.user;
  const f = { ...(filters || {}) };
  if (u && String(u.role || '').toUpperCase() !== 'GERENTE') {
    f.equipe = u.team || f.equipe;
  }
  // campos opcionais (√∫teis para o GAS aplicar regra de acesso)
  f.requesterRole = u?.role || '';
  f.requesterTeam = u?.team || '';
  return f;
}

function downloadBase64File(base64, filename, mimeType) {
  const bytes = Uint8Array.from(atob(base64), c => c.charCodeAt(0));
  const blob = new Blob([bytes], { type: mimeType || 'application/octet-stream' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = filename || 'arquivo';
  document.body.appendChild(a);
  a.click();
  a.remove();
  setTimeout(() => URL.revokeObjectURL(url), 4000);
}

/* =============================
   SIDEBAR
============================= */
function buildSidebarHTML(active) {
  const u = State.user;
  const logged = !!u;

  const items = [
    { id:"dashboard", label:"Dashboard", icon:"üìä" },
    { id:"evaluation", label:"Nova avalia√ß√£o", icon:"üìù" },
    { id:"records", label:"Avalia√ß√µes", icon:"üóÇÔ∏è" },
    { id:"analytics", label:"Relat√≥rios", icon:"üìà" },
    { id:"settings", label:"Configura√ß√µes", icon:"‚öôÔ∏è" }
  ];

  const onlineStatus = navigator.onLine ? "Online" : "Offline";

  return `
    <div class="brand">
      <div class="logo">A</div>
      <div>
        <h1>Avalia√ß√µes Ameripan</h1>
        <p>Field Manager</p>
      </div>
    </div>

    <div class="nav">
      ${items.map(it => {
        const disabled = !logged && it.id !== "login";
        const cls = [
          active === it.id ? "active" : "",
          disabled ? "disabled" : ""
        ].join(" ").trim();
        return `
          <a href="#${disabled ? "login" : it.id}" class="${cls}">
            <span class="icon">${it.icon}</span>
            <span>${it.label}</span>
          </a>
        `;
      }).join("")}
      ${!logged ? `
        <a href="#login" class="${active === "login" ? "active" : ""}">
          <span class="icon">üîê</span>
          <span>Login</span>
        </a>
      ` : ""}
    </div>

    <div class="side-footer">
      <div class="row">
        <div>
          <div style="font-weight:700;color:var(--text);">
            ${esc(u?.name || u?.login || "N√£o logado")}
          </div>
          <div class="muted">
            Cargo: ${esc(u?.role || "‚Äî")} ¬∑ Equipe: ${esc(u?.team || "‚Äî")}
          </div>
        </div>
        <span class="pill" id="connStatus">${onlineStatus}</span>
      </div>
      <div class="sep"></div>
      <div class="row">
        <button class="btn ${logged ? "danger" : ""}" id="btnLogout">
          ${logged ? "Sair" : "Limpar sess√£o"}
        </button>
      </div>
    </div>
  `;
}

/* =============================
   P√ÅGINAS
============================= */
const Pages = {
  show(id) {
    $$(".page").forEach(p => p.classList.remove("active"));
    const el = $("#page-" + id) || $("#page-locked");
    el.classList.add("active");
  },

  ensureAuth(id) {
    if (State.user) return true;
    if (id === "login") {
      Pages.show("login");
      return false;
    }
    Pages.show("locked");
    return false;
  },

  /* Login */
  bindLogin() {
    $("#btnLogin").onclick = async () => {
      const user = $("#loginUser").value.trim();
      const pass = $("#loginPass").value;
      $("#loginMsg").textContent = "";

      if (!user || !pass) {
        $("#loginMsg").textContent = "Preencha usu√°rio e senha.";
        return;
      }

      try {
        Loading.show("btnLogin", "Entrando...");
        const res = await Api.login(user, pass);
        if (res.error) throw new Error(res.msg || "Erro de login");

        const u = {
          login: user,
          name:  res.name || user,
          role:  res.role || "SUPERVISOR",
          team:  res.team || "",
          vendors: res.vendors || []
        };
        saveUser(u);
        UI.toast("Login realizado.");
        Router.go("dashboard");
      } catch (err) {
        $("#loginMsg").textContent = err.message || String(err);
      } finally {
        Loading.hide("btnLogin");
      }
    };
  },

  /* Dashboard */
  bindDashboard() {
    const apply = () => Pages.loadDashboard();
    const btnRefresh = $("#btnRefreshDash");
    if (btnRefresh) btnRefresh.onclick = apply;
    const btnApply = $("#btnApplyDash");
    if (btnApply) btnApply.onclick = apply;

    const btnReset = $("#btnResetDash");
    if (btnReset) btnReset.onclick = () => {
      const { from, to } = monthBounds();
      const dFrom = $("#dashFrom");
      const dTo   = $("#dashTo");
      if (dFrom) dFrom.value = from;
      if (dTo) dTo.value = to;

      const teamSel = $("#dashTeam");
      if (teamSel && State.user?.role === 'GERENTE') teamSel.value = 'TODOS';
      const venSel  = $("#dashVendor");
      if (venSel) venSel.value = 'TODOS';
      Pages.populateVendorSelects();
      Pages.loadDashboard();
    };
  },

  /* Records */
  bindRecords() {
    const apply = () => Pages.loadRecords(1);
    $("#btnRecApply") && ($("#btnRecApply").onclick = apply);
    $("#recSearch") && $("#recSearch").addEventListener('keydown', (e) => { if (e.key === 'Enter') apply(); });

    $("#btnRecPrev") && ($("#btnRecPrev").onclick = () => Pages.loadRecords((State.recordsPage||1) - 1));
    $("#btnRecNext") && ($("#btnRecNext").onclick = () => Pages.loadRecords((State.recordsPage||1) + 1));

    $("#recPageSize") && $("#recPageSize").addEventListener('change', apply);

    // Exporta√ß√µes
    $("#btnRecPdf") && ($("#btnRecPdf").onclick = () => Pages.exportReport('pdf'));
    $("#btnRecXlsx") && ($("#btnRecXlsx").onclick = () => Pages.exportReport('xlsx'));

    // Modal
    $("#btnModalClose") && ($("#btnModalClose").onclick = () => UI.modalClose());
    $("#modalBackdrop") && $("#modalBackdrop").addEventListener('click', (e) => { if (e.target.id === 'modalBackdrop') UI.modalClose(); });
    $("#btnModalPdf") && ($("#btnModalPdf").onclick = () => Pages.exportReport('pdf', { single: State.modalEval }));
    $("#btnModalXlsx") && ($("#btnModalXlsx").onclick = () => Pages.exportReport('xlsx', { single: State.modalEval }));
  },

  /* Dashboard */
  async loadDashboard() {
    if (!Pages.ensureAuth("dashboard")) return;

    const teamVal = $("#dashTeam")?.value || "TODOS";
    $("#dashScopeBadge").textContent =
      State.user?.role === "GERENTE"
      ? (teamVal && teamVal !== "TODOS" ? `Escopo: ${teamVal}` : "Escopo: geral")
      : `Escopo: ${State.user?.team || "Minha equipe"}`;

    try {
      Loading.show("btnRefreshDash", "...");
      $("#kpiTotal").textContent = "‚Ä¶";
      const dataInicio = $("#dashFrom")?.value || null;
      const dataFim    = $("#dashTo")?.value   || null;
      const vendedor   = $("#dashVendor")?.value || "TODOS";
      const equipeSel  = $("#dashTeam")?.value   || "TODOS";

      const filters = scopeFilters({ dataInicio, dataFim, vendedor, equipe: equipeSel });
      const res = await Api.getGeneralAnalytics(filters);
      State.lastAnalytics = res;

      const total = res.totalAvaliacoes || 0;
      const media = res.mediaGeral || 0;
      const status = res.statusCounts || { BAIXO:0, MEDIO:0, ALTO:0 };

      $("#kpiTotal").textContent = total;
      $("#kpiTotHint").textContent = "Total de avalia√ß√µes na base filtrada.";
      $("#kpiAvg").textContent   = formatScore(media);
      $("#kpiVend").textContent  = res.vendedoresUnicos ?? "‚Äî";
      $("#kpiTeams").textContent = res.equipesUnicas ?? "‚Äî";

      $("#kpiHigh").textContent = `ALTO: ${status.ALTO ?? 0}`;
      $("#kpiMid").textContent  = `M√âDIO: ${status.MEDIO ?? 0}`;
      $("#kpiLow").textContent  = `BAIXO: ${status.BAIXO ?? 0}`;

      // Top falhas
      const topFalhas = res.topFalhas || [];
      if (!topFalhas.length) {
        $("#dashTopFalhas").textContent = "Sem falhas cadastradas ainda.";
      } else {
        $("#dashTopFalhas").innerHTML = "<ul style='margin:4px 0;padding-left:18px;'>" +
          topFalhas.map(f => `<li>${esc(f.label)} ‚Äî ${f.count}</li>`).join("") +
          "</ul>";
      }

      // Timeline
      const tl = res.timeline || [];
      if (!tl.length) {
        $("#dashTimeline").textContent = "Sem avalia√ß√µes suficientes para timeline.";
      } else {
        $("#dashTimeline").innerHTML = "<ul style='margin:0;padding-left:18px;'>" +
          tl.map(item =>
            `<li>${esc(item.date)} ‚Äî ${esc(item.vendedor || "")}: nota ${formatScore(item.nota)}</li>`
          ).join("") +
          "</ul>";
      }
    } catch (err) {
      $("#kpiTotal").textContent = "‚Äî";
      $("#kpiAvg").textContent   = "‚Äî";
      $("#dashTimeline").textContent = "Erro ao carregar dashboard: " + (err.message || err);
    } finally {
      Loading.hide("btnRefreshDash");
    }
  },

  /* Evaluation */
  bindEvaluation() {
    // Render perguntas
    const qRoot = $("#questions");
    qRoot.innerHTML = QUESTIONS.map(q => `
      <div class="q" data-q="${q.key}">
        <div class="top">
          <div>
            <div class="title">${esc(q.title)}</div>
            ${q.desc ? `<div class="desc">${esc(q.desc)}</div>` : ""}
          </div>
          <span class="badge" id="badge-${q.key}">NA</span>
        </div>
        <div class="opts">
          ${ANSWER_OPTIONS.map(opt => `
            <span class="chip" data-q="${q.key}" data-v="${opt.value}">${opt.label}</span>
          `).join("")}
        </div>
      </div>
    `).join("");

    // handler dos chips
    qRoot.addEventListener("click", ev => {
      const chip = ev.target.closest(".chip");
      if (!chip) return;
      const q = chip.dataset.q;
      const vRaw = chip.dataset.v;
      const v = (vRaw === "NA") ? "NA" : Number(vRaw);

      State.answers[q] = v;
      const qDiv = chip.closest(".q");
      qDiv.querySelectorAll(".chip").forEach(c => c.classList.remove("active"));
      chip.classList.add("active");
      $("#badge-" + q).textContent = String(vRaw);
      UI.updateEvalScoreStatus();
    });

    // marcar NA como default
    QUESTIONS.forEach(q => {
      const root = document.querySelector(`.q[data-q="${q.key}"]`);
      const naChip = root.querySelector(`.chip[data-v="NA"]`);
      if (naChip) naChip.classList.add("active");
    });
    UI.updateEvalScoreStatus();

    // hist√≥rico
    $("#btnLoadHistory").onclick = async () => {
      $("#historyMsg").textContent = "";
      $("#historyList").innerHTML = "";
      const vendorCode = $("#evalVendor").value;
      if (!vendorCode) {
        $("#historyMsg").textContent = "Selecione um vendedor.";
        return;
      }
      try {
        Loading.show("btnLoadHistory", "Carregando...");
        const res = await Api.getHistory(vendorCode);
        const hist = res.history || [];
        if (!hist.length) {
          $("#historyList").innerHTML = `<div class="hint">Sem hist√≥rico para este vendedor.</div>`;
          return;
        }
        $("#historyList").innerHTML = hist.map(h => `
          <div class="q">
            <div class="row between">
              <span>${esc(h.data || "")}</span>
              ${statusBadge(h.status || "")}
            </div>
            <div class="muted" style="font-size:12px;margin-top:4px;">
              Nota: <b>${formatScore(h.nota)}</b><br/>
              ${h.falhas ? `Falhas: ${esc(h.falhas)}` : ""}
            </div>
          </div>
        `).join("");
      } catch (err) {
        $("#historyMsg").textContent = err.message || String(err);
      } finally {
        Loading.hide("btnLoadHistory");
      }
    };

    // submit avalia√ß√£o
    $("#btnSubmitEval").onclick = async () => {
      $("#evalMsg").textContent = "";
      const vendorCode = $("#evalVendor").value;
      
      try {
        // Valida√ß√£o Frontend
        Validator.required(vendorCode, 'Vendedor');
        Validator.evaluation(State.answers);

        const vendor = (State.user?.vendors || []).find(v => String(v.code) === String(vendorCode));
        if (!vendor) throw new Error("Vendedor inv√°lido.");

        const payload = Domain.buildEvaluationPayload({
          user: State.user,
          vendor,
          answers: State.answers,
          extraTitulo: $("#extraTitulo").value,
          extraObs: $("#extraObs").value,
          feedbacks: {
            fbRota: $("#fbRota").value,
            fbPrep: $("#fbPrep").value,
            fbPos:  $("#fbPos").value,
            fbAber: $("#fbAber").value,
            fbCamp: $("#fbCamp").value,
            fbGest: $("#fbGest").value
          },
          obsGeral: $("#obsGeral").value,
          listaFalhas: $("#listaFalhas").value
        });

        Loading.show("btnSubmitEval", "Enviando...");
        
        // Tentar enviar ou salvar offline
        if (navigator.onLine) {
           const res = await Api.saveEvaluation(payload);
           if (!res.success) throw new Error(res.msg || "Erro ao salvar avalia√ß√£o.");
           UI.toast("Avalia√ß√£o salva com sucesso.");
        } else {
           throw new Error("OFFLINE");
        }

        // reset respostas
        State.answers = Object.fromEntries(QUESTIONS.map(q => [q.key, "NA"]));
        QUESTIONS.forEach(q => {
          const root = document.querySelector(`.q[data-q="${q.key}"]`);
          root.querySelectorAll(".chip").forEach(c => c.classList.remove("active"));
          const naChip = root.querySelector(`.chip[data-v="NA"]`);
          if (naChip) naChip.classList.add("active");
          $("#badge-" + q.key).textContent = "NA";
        });
        UI.updateEvalScoreStatus();

        ["extraTitulo","extraObs","fbRota","fbPrep","fbPos","fbAber","fbCamp","fbGest","obsGeral","listaFalhas"]
          .forEach(id => { const el = $("#"+id); if (el) el.value = ""; });

      } catch (err) {
        if (err.message === 'OFFLINE') {
           // Fallback Offline
           try {
             const vendorCode = $("#evalVendor").value;
             const vendor = (State.user?.vendors || []).find(v => String(v.code) === String(vendorCode));
             const payload = Domain.buildEvaluationPayload({
               user: State.user,
               vendor,
               answers: State.answers,
               extraTitulo: $("#extraTitulo").value,
               extraObs: $("#extraObs").value,
               feedbacks: { fbRota:$("#fbRota").value, fbPrep:$("#fbPrep").value, fbPos:$("#fbPos").value, fbAber:$("#fbAber").value, fbCamp:$("#fbCamp").value, fbGest:$("#fbGest").value },
               obsGeral: $("#obsGeral").value,
               listaFalhas: $("#listaFalhas").value
             });
             OfflineQueue.add(payload);
             
             // Reset UI (same as success)
             State.answers = Object.fromEntries(QUESTIONS.map(q => [q.key, "NA"]));
             QUESTIONS.forEach(q => {
                const root = document.querySelector(`.q[data-q="${q.key}"]`);
                root.querySelectorAll(".chip").forEach(c => c.classList.remove("active"));
                const naChip = root.querySelector(`.chip[data-v="NA"]`);
                if (naChip) naChip.classList.add("active");
                $("#badge-" + q.key).textContent = "NA";
             });
             UI.updateEvalScoreStatus();
             ["extraTitulo","extraObs","fbRota","fbPrep","fbPos","fbAber","fbCamp","fbGest","obsGeral","listaFalhas"].forEach(id => { const el = $("#"+id); if (el) el.value = ""; });
           } catch(e2) {
             $("#evalMsg").textContent = e2.message;
           }
        } else {
           $("#evalMsg").textContent = err.message || String(err);
        }
      } finally {
        Loading.hide("btnSubmitEval");
      }
    };
  },

  populateVendorSelects() {
    const vendors = State.user?.vendors || [];

    // Eval select (por c√≥digo)
    const evalSel = $("#evalVendor");
    evalSel.innerHTML = `<option value="">Selecione‚Ä¶</option>` +
      vendors.map(v => `<option value="${esc(v.code)}">${esc(v.name)}</option>`).join("");

    // Listas √∫nicas (por nome e por equipe)
    const vendorNames = Array.from(new Set(vendors.map(v => v.name).filter(Boolean)))
      .sort((a,b)=>a.localeCompare(b));
    const teamNames = Array.from(new Set(vendors.map(v => v.team).filter(Boolean)))
      .sort((a,b)=>a.localeCompare(b));

    State.vendorList = vendorNames;
    State.teamList = teamNames;

    // Helpers para preencher selects
    const fillTeam = (sel) => {
      if (!sel) return;
      sel.innerHTML = `<option value="TODOS">Todas</option>` +
        teamNames.map(t => `<option value="${esc(t)}">${esc(t)}</option>`).join("");

      if (State.user?.role !== 'GERENTE') {
        sel.value = State.user?.team || '';
        sel.disabled = true;
      }
    };

    const fillVendorByTeam = (sel, teamValue) => {
      if (!sel) return;
      const scoped = (teamValue && teamValue !== 'TODOS')
        ? vendors.filter(v => v.team === teamValue).map(v => v.name)
        : vendors.map(v => v.name);
      const names = Array.from(new Set(scoped.filter(Boolean))).sort((a,b)=>a.localeCompare(b));
      sel.innerHTML = `<option value="TODOS">Todos</option>` +
        names.map(n => `<option value="${esc(n)}">${esc(n)}</option>`).join("");
    };

    // Analytics filters
    fillTeam($("#fltTeam"));
    fillVendorByTeam($("#fltVendor"), $("#fltTeam")?.value || 'TODOS');

    // Vendor analytics select (nome)
    const vaVendor = $("#vaVendor");
    if (vaVendor) {
      vaVendor.innerHTML = `<option value="">Selecione‚Ä¶</option>` +
        vendorNames.map(n => `<option value="${esc(n)}">${esc(n)}</option>`).join("");
    }

    // Dashboard filters
    fillTeam($("#dashTeam"));
    fillVendorByTeam($("#dashVendor"), $("#dashTeam")?.value || 'TODOS');

    // Records filters
    fillTeam($("#recTeam"));
    fillVendorByTeam($("#recVendor"), $("#recTeam")?.value || 'TODOS');

    // Eventos: quando mudar equipe (para gerente), atualizar vendedores
    const wireTeam = (teamSelId, vendorSelId) => {
      const tSel = $(teamSelId);
      const vSel = $(vendorSelId);
      if (!tSel || !vSel) return;
      tSel.addEventListener('change', () => fillVendorByTeam(vSel, tSel.value));
    };
    if (State.user?.role === 'GERENTE') {
      wireTeam('#fltTeam', '#fltVendor');
      wireTeam('#dashTeam', '#dashVendor');
      wireTeam('#recTeam', '#recVendor');
    }
  },

  bindVendorSelect() {
    $("#evalVendor").addEventListener("change", () => {
      const code = $("#evalVendor").value;
      const vendor = (State.user?.vendors || []).find(v => String(v.code) === String(code));
      $("#evalTeam").value = vendor?.team || State.user?.team || "";
    });
  },

  async loadRecords(page = 1) {
    if (!Pages.ensureAuth('records')) return;

    // Datas padr√£o: m√™s atual
    const { from, to } = monthBounds();
    const recFrom = $("#recFrom");
    const recTo   = $("#recTo");
    if (recFrom && !recFrom.value) recFrom.value = from;
    if (recTo && !recTo.value) recTo.value = to;

    const pageSize = parseInt($("#recPageSize")?.value || '25', 10) || 25;
    const search = $("#recSearch")?.value?.trim() || '';

    const dataInicio = recFrom?.value || null;
    const dataFim    = recTo?.value   || null;
    const vendedor   = $("#recVendor")?.value || 'TODOS';
    const equipeSel  = $("#recTeam")?.value   || 'TODOS';

    const filters = scopeFilters({ dataInicio, dataFim, vendedor, equipe: equipeSel, search });

    // clamp
    if (page < 1) page = 1;
    if (page > (State.recordsTotalPages || 9999)) page = State.recordsTotalPages || 1;

    try {
      State.recordsPage = page;
      $("#recTable").innerHTML = '<div class="hint">Carregando...</div>';
      
      const res = await Api.getEvaluationsPage({
        filters,
        page,
        pageSize,
        sort: 'desc'
      });

      if (res.error) throw new Error(res.msg || 'Erro ao carregar avalia√ß√µes');

      const data = res.data || [];
      const total = res.total || 0;
      const totalPages = res.totalPages || 1;
      State.recordsTotalPages = totalPages;

      $("#recPageInfo").textContent = `P√°gina ${page} / ${totalPages} ¬∑ ${total} registros`;
      $("#btnRecPrev").disabled = page <= 1;
      $("#btnRecNext").disabled = page >= totalPages;

      Pages.renderRecordsTable(data);

    } catch (err) {
      $("#recTable").textContent = 'Erro: ' + (err.message || err);
      $("#recPageInfo").textContent = '‚Äî';
    }
  },

  renderRecordsTable(items) {
    if (!Array.isArray(items) || !items.length) {
      $("#recTable").innerHTML = '<div class="hint">Nenhuma avalia√ß√£o encontrada para o filtro.</div>';
      return;
    }

    const rows = items.map(ev => {
      const date = ev.dataHora ? String(ev.dataHora).replace('T', ' ').slice(0,16) : '';
      const score = formatScore(ev.notaFinal);
      const status = statusBadge(ev.statusResultado);
      return `
        <tr>
          <td class="mutedcell">${esc(date)}</td>
          <td>${esc(ev.vendorName || '')}</td>
          <td class="mutedcell">${esc(ev.equipe || '')}</td>
          <td class="mutedcell">${esc(ev.supervisorName || '')}</td>
          <td><b>${esc(score)}</b></td>
          <td>${status}</td>
          <td><button class="btn" data-open="${esc(ev.uuid)}">Ver</button></td>
        </tr>
      `;
    }).join('');

    $("#recTable").innerHTML = `
      <div class="table-wrap">
        <table class="tbl">
          <thead>
            <tr>
              <th>Data</th>
              <th>Vendedor</th>
              <th>Equipe</th>
              <th>Supervisor</th>
              <th>Nota</th>
              <th>Status</th>
              <th></th>
            </tr>
          </thead>
          <tbody>${rows}</tbody>
        </table>
      </div>
    `;

    // bind open buttons
    $("#recTable").querySelectorAll('button[data-open]').forEach(btn => {
      btn.onclick = () => {
        const id = btn.getAttribute('data-open');
        const ev = items.find(x => String(x.uuid) === String(id));
        if (ev) Pages.openEvaluationModal(ev);
      };
    });
  },

  openEvaluationModal(ev) {
    State.modalEval = ev;
    const dt = ev.dataHora ? String(ev.dataHora).replace('T',' ').slice(0,16) : '';
    $("#modalSubtitle").textContent = `UUID: ${ev.uuid || ''}`;
    $("#modalTitle").textContent = `${ev.vendorName || 'Avalia√ß√£o'} ¬∑ ${dt}`;

    const qLines = QUESTIONS.map(q => {
      const val = ev[q.key];
      const show = (val === 'NA' || val === null || val === undefined) ? 'NA' : String(val);
      return `<li><b>${esc(q.title)}</b>: ${esc(show)}</li>`;
    }).join('');

    const extras = `
      <div class="grid two" style="gap:10px;">
        <div class="card" style="margin:0;">
          <h2 style="margin-top:0;">Cabe√ßalho</h2>
          <div class="sep"></div>
          <div class="muted" style="font-size:12px;">
            <div><span class="pill">Equipe: <b>${esc(ev.equipe||'')}</b></span> <span class="pill">Nota: <b>${esc(formatScore(ev.notaFinal))}</b></span> <span class="pill">${ev.statusResultado ? esc(ev.statusResultado) : ''}</span></div>
            <div style="margin-top:10px;">Supervisor: <b>${esc(ev.supervisorName||'')}</b></div>
            <div>Login: <span class="muted">${esc(ev.supervisorLogin||'')}</span></div>
            <div>Vendedor ID: <span class="muted">${esc(ev.vendorId||'')}</span></div>
          </div>
        </div>
        <div class="card" style="margin:0;">
          <h2 style="margin-top:0;">Problema extra</h2>
          <div class="sep"></div>
          <div class="muted" style="font-size:12px;">
            <div><b>${esc(ev.extraTitulo || '‚Äî')}</b></div>
            <div style="white-space:pre-wrap; margin-top:6px;">${esc(ev.extraObs || '‚Äî')}</div>
          </div>
        </div>
      </div>
    `;

    const feedback = `
      <div class="sep"></div>
      <div class="grid two" style="gap:10px;">
        <div class="card" style="margin:0;">
          <h2 style="margin-top:0;">Respostas</h2>
          <div class="sep"></div>
          <ul style="margin:4px 0; padding-left:18px;">${qLines}</ul>
        </div>
        <div class="card" style="margin:0;">
          <h2 style="margin-top:0;">Falhas & observa√ß√µes</h2>
          <div class="sep"></div>
          <div class="muted" style="font-size:12px; white-space:pre-wrap;">${esc(ev.listaFalhas || '‚Äî')}</div>
          <div class="sep"></div>
          <div class="muted" style="font-size:12px; white-space:pre-wrap;">${esc(ev.obsGeral || '‚Äî')}</div>
        </div>
      </div>
      <div class="sep"></div>
      <div class="card" style="margin:0;">
        <h2 style="margin-top:0;">Feedbacks</h2>
        <div class="sep"></div>
        <div class="grid three" style="gap:10px;">
          <div class="field"><label>Rota</label><div class="muted" style="font-size:12px; white-space:pre-wrap;">${esc(ev.fbRota || '‚Äî')}</div></div>
          <div class="field"><label>Prepara√ß√£o</label><div class="muted" style="font-size:12px; white-space:pre-wrap;">${esc(ev.fbPrep || '‚Äî')}</div></div>
          <div class="field"><label>P√≥s</label><div class="muted" style="font-size:12px; white-space:pre-wrap;">${esc(ev.fbPos || '‚Äî')}</div></div>
          <div class="field"><label>Abertura</label><div class="muted" style="font-size:12px; white-space:pre-wrap;">${esc(ev.fbAber || '‚Äî')}</div></div>
          <div class="field"><label>Campanha</label><div class="muted" style="font-size:12px; white-space:pre-wrap;">${esc(ev.fbCamp || '‚Äî')}</div></div>
          <div class="field"><label>Gest√£o</label><div class="muted" style="font-size:12px; white-space:pre-wrap;">${esc(ev.fbGest || '‚Äî')}</div></div>
        </div>
      </div>
    `;

    $("#modalBody").innerHTML = extras + feedback;
    UI.modalOpen();
  },

  async exportReport(format, opts = {}) {
    if (!Pages.ensureAuth('records')) return;

    const { from, to } = monthBounds();
    const recFrom = $("#recFrom");
    const recTo   = $("#recTo");
    const dataInicio = (recFrom?.value || from) || null;
    const dataFim    = (recTo?.value   || to) || null;
    const vendedor   = $("#recVendor")?.value || 'TODOS';
    const equipeSel  = $("#recTeam")?.value   || 'TODOS';
    const search = $("#recSearch")?.value?.trim() || '';

    const baseFilters = scopeFilters({ dataInicio, dataFim, vendedor, equipe: equipeSel, search });

    // Se for exporta√ß√£o de uma avalia√ß√£o espec√≠fica (modal)
    const single = opts.single || null;

    try {
      UI.toast('Gerando arquivo‚Ä¶');
      const res = await Api.exportReport({
        format,
        filters: baseFilters,
        singleUuid: single?.uuid || null
      });

      if (!res || res.error) throw new Error(res?.msg || 'Erro ao exportar');
      if (!res.base64) throw new Error('Resposta sem arquivo.');

      downloadBase64File(res.base64, res.filename || `relatorio.${format}`, res.mimeType);
      UI.toast('Download iniciado.');

    } catch (err) {
      UI.toast('Falha ao exportar: ' + (err.message || err));
    }
  },

  /* Analytics / Relat√≥rios */
  bindAnalytics() {
    $("#btnLoadFilters").onclick = async () => {
      await Pages.loadListsForAnalytics();
    };
    $("#btnApplyAnalytics").onclick = () => Pages.applyAnalytics();
    $("#vaVendor").addEventListener("change", () => Pages.loadVendorAnalytics());
  },

  async loadListsForAnalytics() {
    if (!Pages.ensureAuth("analytics")) return;
    // As listas v√™m do login (USERS). Mant√©m tudo consistente com a planilha.
    Pages.populateVendorSelects();

    // Datas padr√£o: m√™s atual
    const { from, to } = monthBounds();
    const fltFrom = $("#fltFrom");
    const fltTo   = $("#fltTo");
    if (fltFrom && !fltFrom.value) fltFrom.value = from;
    if (fltTo && !fltTo.value) fltTo.value = to;

    // Se supervisor, travar equipe tamb√©m nos filtros
    if (State.user?.role !== 'GERENTE') {
      const fltTeam = $("#fltTeam");
      if (fltTeam) {
        fltTeam.value = State.user?.team || '';
        fltTeam.disabled = true;
      }
    }

    UI.toast("Filtros carregados.");
  },

  async applyAnalytics() {
    if (!Pages.ensureAuth("analytics")) return;

    const { from, to } = monthBounds();
    const dataInicio = $("#fltFrom").value || from || null;
    const dataFim    = $("#fltTo").value   || to || null;
    const vendedor   = $("#fltVendor").value || "TODOS";
    const equipe     = $("#fltTeam").value   || "TODOS";

    let equipeFinal = equipe;

    // Supervisores sempre enxergam apenas a pr√≥pria equipe
    if (State.user?.role !== "GERENTE") {
      equipeFinal = State.user?.team || equipeFinal;
      const fltTeamEl = $("#fltTeam");
      if (fltTeamEl) { fltTeamEl.value = equipeFinal; fltTeamEl.disabled = true; }
    }

    const filters = scopeFilters({ dataInicio, dataFim, vendedor, equipe: equipeFinal });

    try {
      $("#anaSummary").textContent = "Carregando‚Ä¶";
      const res = await Api.getGeneralAnalytics(filters);
      State.lastAnalytics = res;

      const total = res.totalAvaliacoes || 0;
      const media = res.mediaGeral || 0;
      const status = res.statusCounts || { BAIXO:0, MEDIO:0, ALTO:0 };

      $("#anaSummary").innerHTML = `
        <div style="margin-bottom:6px;">Avalia√ß√µes: <b>${total}</b></div>
        <div>M√©dia geral: <b>${formatScore(media)}</b></div>
        <div style="margin-top:6px;">
          ${statusBadge("ALTO")} ${status.ALTO ?? 0} ¬∑
          ${statusBadge("MEDIO")} ${status.MEDIO ?? 0} ¬∑
          ${statusBadge("BAIXO")} ${status.BAIXO ?? 0}
        </div>
      `;

      // perguntas
      const qa = res.questionAverages || {};
      const lines = QUESTIONS.map(q => {
        const v = qa[q.key];
        if (v === null || v === undefined) return `${q.title}: sem dados`;
        return `${q.title}: m√©dia ${Number(v).toFixed(2)}`;
      });
      $("#anaQuestions").innerHTML = "<ul style='margin:4px 0;padding-left:18px;'>" +
        lines.map(l => `<li>${esc(l)}</li>`).join("") +
        "</ul>";

      // top falhas / positivos
      const tf = res.topFalhas || [];
      const tp = res.topPositivos || [];
      $("#anaTopFalhas").innerHTML =
        tf.length
          ? "<ul style='margin:4px 0;padding-left:18px;'>" +
            tf.map(f => `<li>${esc(f.label)} ‚Äî ${f.count}</li>`).join("") +
            "</ul>"
          : "Sem falhas mapeadas no filtro.";
      $("#anaTopPos").innerHTML =
        tp.length
          ? "<ul style='margin:4px 0;padding-left:18px;'>" +
            tp.map(f => `<li>${esc(f.label)} ‚Äî ${f.count}</li>`).join("") +
            "</ul>"
          : "Sem pontos positivos mapeados no filtro.";

      const tl = res.timeline || [];
      $("#anaTimeline").innerHTML =
        tl.length
          ? "<ul style='margin:4px 0;padding-left:18px;'>" +
            tl.map(it => `<li>${esc(it.date)} ‚Äî ${esc(it.vendedor || "")}: nota ${formatScore(it.nota)}</li>`).join("") +
            "</ul>"
          : "Sem dados para timeline.";

    } catch (err) {
      $("#anaSummary").textContent = "Erro: " + (err.message || err);
    }
  },

  async loadVendorAnalytics() {
    const name = $("#vaVendor").value;
    if (!name) {
      $("#vaSummary").textContent = "Selecione um vendedor.";
      return;
    }
    try {
      $("#vaSummary").textContent = "Carregando‚Ä¶";

      // apiGetVendorAnalytics aceita id ou nome; usamos nome
      const res = await Api.getVendorAnalytics(name);
      if (res.error) {
        $("#vaSummary").textContent = "Erro: " + (res.msg || "n√£o foi poss√≠vel carregar.");
        return;
      }
      if (!res.count) {
        $("#vaSummary").textContent = "Nenhuma avalia√ß√£o encontrada para este vendedor.";
        return;
      }

      const status = res.statusCounts || { BAIXO:0, MEDIO:0, ALTO:0 };
      const qa = res.questionAverages || {};
      const tl = res.timeline || [];
      const qsLines = QUESTIONS.map(q => {
        const v = qa[q.key];
        if (v === null || v === undefined) return `${q.title}: ‚Äî`;
        return `${q.title}: ${Number(v).toFixed(2)}`;
      });

      $("#vaSummary").innerHTML = `
        <div>Qtd avalia√ß√µes: <b>${res.count}</b></div>
        <div>M√©dia do vendedor: <b>${formatScore(res.avgScore)}</b> (min: ${formatScore(res.minScore)}, m√°x: ${formatScore(res.maxScore)})</div>
        <div style="margin-top:6px;">
          ${statusBadge("ALTO")} ${status.ALTO ?? 0} ¬∑
          ${statusBadge("MEDIO")} ${status.MEDIO ?? 0} ¬∑
          ${statusBadge("BAIXO")} ${status.BAIXO ?? 0}
        </div>
        <div class="sep"></div>
        <div><b>Notas por pergunta</b></div>
        <ul style="margin:4px 0;padding-left:18px;">
          ${qsLines.map(l => `<li>${esc(l)}</li>`).join("")}
        </ul>
        <div class="sep"></div>
        <div><b>Timeline</b></div>
        ${
          tl.length
            ? "<ul style='margin:4px 0;padding-left:18px;'>" +
              tl.map(it => `<li>${esc(it.date)} ‚Äî nota ${formatScore(it.nota)}</li>`).join("") +
              "</ul>"
            : "<div class='muted'>Sem dados de timeline.</div>"
        }
      `;
    } catch (err) {
      $("#vaSummary").textContent = "Erro: " + (err.message || err);
    }
  },

  /* Settings */
  bindSettings() {
    $("#btnChangePass").onclick = async () => {
      $("#setMsg").textContent = "";
      const cur = $("#curPass").value;
      const np  = $("#newPass").value;
      const np2 = $("#newPass2").value;

      if (!cur || !np || !np2) {
        $("#setMsg").textContent = "Preencha todos os campos.";
        return;
      }
      if (np !== np2) {
        $("#setMsg").textContent = "Nova senha e confirma√ß√£o n√£o conferem.";
        return;
      }

      try {
        Loading.show("btnChangePass", "Salvando...");
        const userLogin = State.user?.login || "";
        const res = await Api.changePassword(userLogin, cur, np);
        if (!res.success) throw new Error(res.msg || "N√£o foi poss√≠vel alterar a senha.");
        UI.toast("Senha alterada.");
        $("#curPass").value = $("#newPass").value = $("#newPass2").value = "";
      } catch (err) {
        $("#setMsg").textContent = err.message || String(err);
      } finally {
        Loading.hide("btnChangePass");
      }
    };
  }
};

/* =============================
   UI CORE
============================= */
const UI = {
  toastTimer: null,
  toast(msg) {
    let el = $("#toast");
    if (!el) {
      el = document.createElement("div");
      el.id = "toast";
      el.style.position = "fixed";
      el.style.left = "50%";
      el.style.bottom = "20px";
      el.style.transform = "translateX(-50%)";
      el.style.padding = "9px 14px";
      el.style.borderRadius = "999px";
      el.style.border = "1px solid rgba(148,163,184,.75)";
      el.style.background = "rgba(15,23,42,.95)";
      el.style.color = "#e5e7eb";
      el.style.fontSize = "13px";
      el.style.zIndex = "100";
      el.style.opacity = "0";
      el.style.transition = ".18s ease";
      document.body.appendChild(el);
    }
    el.textContent = msg;
    requestAnimationFrame(() => el.style.opacity = "1");
    clearTimeout(UI.toastTimer);
    UI.toastTimer = setTimeout(() => { el.style.opacity = "0"; }, 2400);
  },



  modalOpen() {
    $("#modalBackdrop")?.classList.add('open');
    document.body.style.overflow = 'hidden';
  },
  modalClose() {
    $("#modalBackdrop")?.classList.remove('open');
    document.body.style.overflow = '';
    State.modalEval = null;
  },
  updateEvalScoreStatus() {
    const score = Domain.calculateScore(State.answers);
    const status = Domain.statusFromScore(score);
    $("#evalScoreBadge").textContent = `Nota: ${formatScore(score)}`;
    const badge = $("#evalStatusBadge");
    badge.textContent = `Status: ${status}`;
    badge.classList.remove("good","warn","bad");
    if (status === "ALTO") badge.classList.add("good");
    else if (status === "MEDIO") badge.classList.add("warn");
    else badge.classList.add("bad");
  },

  setDrawer(open) {
    State.drawerOpen = open;
    const drawer = $("#drawer");
    const back   = $("#drawerBackdrop");
    if (open) {
      drawer.classList.add("open");
      back.classList.add("open");
    } else {
      drawer.classList.remove("open");
      back.classList.remove("open");
    }
  },

  render() {
    if (!State.user) State.user = loadUser();

    const page = Router.current || "login";
    const logged = !!State.user;

    // sidebar (desktop + drawer)
    $("#sidebar").innerHTML = buildSidebarHTML(page);
    $("#drawerSidebar").innerHTML = buildSidebarHTML(page);

    // logout
    const attachLogout = (root) => {
      const btn = root.querySelector("#btnLogout");
      if (!btn) return;
      btn.onclick = () => {
        clearUser();
        UI.toast("Sess√£o encerrada.");
        Router.go("login");
        UI.setDrawer(false);
      };
    };
    attachLogout($("#sidebar"));
    attachLogout($("#drawerSidebar"));

    // mobile badge
    $("#mobileUserBadge").textContent = logged
      ? (State.user.name || State.user.login || "Online")
      : "Offline";

    // drawer events
    $("#btnOpenMenu").onclick = () => UI.setDrawer(true);
    $("#drawerBackdrop").onclick = () => UI.setDrawer(false);
    $("#drawerSidebar").querySelectorAll("a[href^='#']").forEach(a => {
      a.onclick = () => UI.setDrawer(false);
    });

    // p√°ginas
    if (!logged && page !== "login") {
      Pages.show("locked");
    } else {
      Pages.show(page);
    }

    // binds (apenas 1 vez)
    UI.bindOnce();

    // se usu√°rio logado, povoar vendor selects
    if (logged) {
      Pages.populateVendorSelects();
    }

    // carregamento de p√°gina espec√≠fico
    if (logged) {
      // garantir datas padr√£o (m√™s atual) em todos os filtros
      const { from, to } = monthBounds();
      ["#dashFrom","#recFrom","#fltFrom"].forEach(id => { const el=$(id); if (el && !el.value) el.value = from; });
      ["#dashTo","#recTo","#fltTo"].forEach(id => { const el=$(id); if (el && !el.value) el.value = to; });

      if (page === "dashboard") {
        Pages.loadDashboard();
      }
      if (page === "records") {
        Pages.loadRecords(State.recordsPage || 1);
      }
      if (page === "analytics") {
        // carrega listas e aplica filtros automaticamente
        Pages.loadListsForAnalytics().then(() => Pages.applyAnalytics());
      }
    }
  },

  _bound: false,
  bindOnce() {
    if (UI._bound) return;
    UI._bound = true;

    Pages.bindLogin();
    Pages.bindDashboard();
    Pages.bindEvaluation();
    Pages.bindVendorSelect();
    Pages.bindRecords();
    Pages.bindAnalytics();
    Pages.bindSettings();

    // Offline / Online listeners
    window.addEventListener('online', () => {
      $("#connStatus") && ($("#connStatus").textContent = "Online");
      UI.toast("Conex√£o restaurada.");
      OfflineQueue.sync();
    });
    window.addEventListener('offline', () => {
      $("#connStatus") && ($("#connStatus").textContent = "Offline");
      UI.toast("Voc√™ est√° offline.");
    });
    
    // Keybindings
    document.addEventListener('keydown', (e) => {
      // Ctrl/Cmd + K: busca r√°pida
      if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
        e.preventDefault();
        const searchInput = $("#recSearch");
        if (searchInput && (Router.current === 'records' || Router.current === 'dashboard')) {
          searchInput.focus();
          if(Router.current !== 'records') Router.go('records');
        }
      }
      
      // Ctrl/Cmd + S: salvar avalia√ß√£o
      if ((e.ctrlKey || e.metaKey) && e.key === 's') {
        e.preventDefault();
        if (Router.current === 'evaluation') {
          $("#btnSubmitEval").click();
        }
      }
      
      // ESC: fechar modal
      if (e.key === 'Escape') {
        if($("#modalBackdrop")?.classList.contains('open')) {
           UI.modalClose();
        }
        UI.setDrawer(false);
      }
    });
  }
};

/* =============================
   BOOT (ap√≥s DOM pronto)
============================= */
window.addEventListener('DOMContentLoaded', () => {
  State.user = loadUser();
  if (!location.hash) {
    location.hash = State.user ? "#dashboard" : "#login";
  }
  Router.resolve();
});

</script>



  <div class="modal-backdrop" id="modalBackdrop" role="dialog" aria-modal="true">
    <div class="card modal">
      <div class="header">
        <div>
          <div class="muted" style="font-size:13px;" id="modalSubtitle">Detalhes</div>
          <h2 id="modalTitle">Avalia√ß√£o</h2>
        </div>
        <div class="row" style="align-items:center;">
          <button class="btn" id="btnModalPdf">PDF</button>
          <button class="btn" id="btnModalXlsx">XLSX</button>
          <span class="close" id="btnModalClose">Fechar ‚úï</span>
        </div>
      </div>
      <div class="sep"></div>
      <div id="modalBody" class="muted" style="font-size:12px;">‚Äî</div>
    </div>
  </div>

</body>
</html>
