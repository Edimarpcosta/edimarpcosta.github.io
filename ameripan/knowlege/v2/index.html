<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Central de Consulta</title>
  <style>
    :root { 
      --bg-primary: #0a0e1a;
      --bg-secondary: #0f1419;
      --card-bg: #141b26;
      --card-border: rgba(99, 179, 237, 0.1);
      --text-primary: #e8edf4;
      --text-secondary: #8b96a5;
      --text-muted: #6b7785;
      --accent: #3b82f6;
      --accent-light: #60a5fa;
      --accent-glow: rgba(59, 130, 246, 0.15);
      --success: #10b981;
      --warning: #f59e0b;
      --danger: #ef4444;
      --border-subtle: rgba(255, 255, 255, 0.06);
      --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.3);
      --shadow-md: 0 8px 24px rgba(0, 0, 0, 0.4);
      --shadow-lg: 0 20px 60px rgba(0, 0, 0, 0.5);
      --radius-sm: 8px;
      --radius-md: 12px;
      --radius-lg: 16px;
      --transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: linear-gradient(135deg, #0a0e1a 0%, #1a1f2e 100%);
      color: var(--text-primary);
      line-height: 1.6;
      min-height: 100vh;
    }

    /* Header */
    header {
      position: sticky;
      top: 0;
      background: rgba(10, 14, 26, 0.98);
      backdrop-filter: blur(20px) saturate(180%);
      border-bottom: 1px solid var(--border-subtle);
      z-index: 100;
      box-shadow: var(--shadow-sm);
    }

    .header-content {
      max-height: calc(100vh - 60px);
      overflow-y: auto;
      overflow-x: hidden;
      scrollbar-width: thin;
      scrollbar-color: var(--accent) transparent;
    }

    .wrap {
      max-width: 1280px;
      margin: 0 auto;
      padding: 20px;
    }

    .header-top {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 16px;
      flex-wrap: wrap;
      margin-bottom: 16px;
    }

    h1 {
      font-size: 24px;
      font-weight: 700;
      letter-spacing: -0.5px;
      background: linear-gradient(135deg, var(--accent-light) 0%, var(--accent) 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      line-height: 1.2;
    }

    .subtitle {
      color: var(--text-secondary);
      font-size: 13px;
      margin-top: 4px;
      line-height: 1.4;
    }

    .header-actions {
      display: flex;
      gap: 12px;
      align-items: center;
    }

    .status-pill {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 16px;
      border-radius: var(--radius-md);
      background: var(--card-bg);
      border: 1px solid var(--card-border);
      font-size: 13px;
      font-weight: 600;
      transition: var(--transition);
    }

    .status-pill.loading::before {
      content: "";
      width: 12px;
      height: 12px;
      border: 2px solid var(--accent);
      border-top-color: transparent;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    .status-pill.ready::before {
      content: "‚úì";
      color: var(--success);
      font-weight: 700;
    }

    .status-pill.error::before {
      content: "‚úï";
      color: var(--danger);
      font-weight: 700;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Tabs */
    .tabs {
      display: flex;
      gap: 6px;
      overflow-x: auto;
      padding-bottom: 4px;
      margin-bottom: 12px;
      scrollbar-width: thin;
      scrollbar-color: var(--accent) transparent;
      -webkit-overflow-scrolling: touch;
    }

    .tabs::-webkit-scrollbar {
      height: 4px;
    }

    .tab {
      position: relative;
      border: none;
      background: transparent;
      color: var(--text-secondary);
      padding: 8px 16px;
      border-radius: var(--radius-md);
      cursor: pointer;
      font-weight: 600;
      font-size: 13px;
      white-space: nowrap;
      transition: var(--transition);
      overflow: hidden;
      flex-shrink: 0;
    }

    .tab::before {
      content: "";
      position: absolute;
      inset: 0;
      background: var(--card-bg);
      opacity: 0;
      transition: var(--transition);
      border-radius: var(--radius-md);
    }

    .tab:hover::before {
      opacity: 1;
    }

    .tab[aria-selected="true"] {
      color: var(--accent-light);
      background: var(--accent-glow);
      border: 1px solid var(--accent);
      box-shadow: 0 0 20px var(--accent-glow);
    }

    /* Controls */
    .controls {
      margin-top: 12px;
      margin-bottom: 12px;
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    input, select {
      border-radius: var(--radius-md);
      border: 1px solid var(--border-subtle);
      background: var(--card-bg);
      color: var(--text-primary);
      padding: 10px 14px;
      font-size: 14px;
      outline: none;
      transition: var(--transition);
      min-width: 180px;
      flex: 1;
    }

    input:focus, select:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 3px var(--accent-glow);
    }

    input::placeholder {
      color: var(--text-muted);
    }

    button {
      border-radius: var(--radius-md);
      border: 1px solid var(--border-subtle);
      background: var(--card-bg);
      color: var(--text-primary);
      padding: 10px 16px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: var(--transition);
      white-space: nowrap;
    }

    button:hover {
      background: rgba(255, 255, 255, 0.05);
      transform: translateY(-1px);
    }

    button:active {
      transform: translateY(0);
    }

    button.primary {
      background: var(--accent);
      border-color: var(--accent);
      color: white;
      box-shadow: 0 4px 12px var(--accent-glow);
    }

    button.primary:hover {
      background: var(--accent-light);
      box-shadow: 0 6px 20px var(--accent-glow);
    }

    button.ghost {
      background: transparent;
      border-color: transparent;
    }

    .hint {
      margin-top: 8px;
      margin-bottom: 8px;
      font-size: 12px;
      color: var(--text-muted);
      display: flex;
      align-items: flex-start;
      gap: 6px;
      line-height: 1.5;
    }

    /* Collapse Button (Mobile) */
    .collapse-btn {
      display: none;
      width: 100%;
      padding: 10px;
      background: var(--card-bg);
      border: 1px solid var(--border-subtle);
      border-radius: var(--radius-md);
      color: var(--text-secondary);
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      margin-top: 8px;
      transition: var(--transition);
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .collapse-btn:hover {
      background: rgba(255, 255, 255, 0.05);
      border-color: var(--accent);
    }

    .collapse-btn::after {
      content: "‚ñº";
      font-size: 10px;
      transition: var(--transition);
    }

    .collapse-btn.expanded::after {
      transform: rotate(180deg);
    }

    .collapsible-content {
      display: block;
    }

    /* Main Content */
    main {
      padding: 20px 0 80px;
      min-height: 50vh;
    }

    .results-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding: 16px;
      background: var(--card-bg);
      border: 1px solid var(--card-border);
      border-radius: var(--radius-md);
    }

    .results-count {
      font-size: 14px;
      color: var(--text-secondary);
    }

    .results-count strong {
      color: var(--accent-light);
      font-size: 18px;
    }

    /* Grid */
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(340px, 1fr));
      gap: 20px;
    }

    .grid.cols-2 {
      grid-template-columns: repeat(auto-fill, minmax(480px, 1fr));
    }

    @media (max-width: 768px) {
      .grid, .grid.cols-2 {
        grid-template-columns: 1fr;
      }
    }

    /* Cards */
    .card {
      background: var(--card-bg);
      border: 1px solid var(--card-border);
      border-radius: var(--radius-lg);
      padding: 20px;
      transition: var(--transition);
      position: relative;
      overflow: hidden;
    }

    .card::before {
      content: "";
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: linear-gradient(90deg, var(--accent) 0%, var(--accent-light) 100%);
      opacity: 0;
      transition: var(--transition);
    }

    .card:hover {
      border-color: var(--accent);
      box-shadow: var(--shadow-md);
      transform: translateY(-2px);
    }

    .card:hover::before {
      opacity: 1;
    }

    .card-image {
      width: 100%;
      height: 180px;
      object-fit: contain;
      background: rgba(255, 255, 255, 0.02);
      border-radius: var(--radius-md);
      border: 1px solid var(--border-subtle);
      margin-bottom: 16px;
    }

    .card-image.placeholder {
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--text-muted);
      font-size: 13px;
    }

    .card h3 {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 12px;
      line-height: 1.4;
    }

    .card-meta {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      margin-bottom: 16px;
    }

    .card-label {
      font-size: 12px;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .card-value {
      font-weight: 700;
      color: var(--text-primary);
    }

    .pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      border-radius: 999px;
      border: 1px solid var(--border-subtle);
      background: rgba(255, 255, 255, 0.03);
      font-size: 12px;
      font-weight: 600;
      color: var(--text-secondary);
      white-space: nowrap;
    }

    .badge {
      background: var(--accent);
      color: white;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 11px;
      font-weight: 700;
    }

    /* Actions */
    .actions {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-top: 16px;
    }

    .btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 10px 16px;
      border-radius: var(--radius-md);
      border: 1px solid var(--border-subtle);
      background: rgba(255, 255, 255, 0.03);
      color: var(--text-primary);
      text-decoration: none;
      font-size: 13px;
      font-weight: 600;
      transition: var(--transition);
    }

    .btn:hover {
      background: var(--accent-glow);
      border-color: var(--accent);
      transform: translateY(-1px);
    }

    .btn-icon::before {
      content: "‚ñ∂";
      font-size: 10px;
    }

    /* Empty State */
    .empty {
      padding: 60px 20px;
      text-align: center;
      border: 2px dashed var(--border-subtle);
      border-radius: var(--radius-lg);
      color: var(--text-muted);
    }

    .empty-icon {
      font-size: 48px;
      margin-bottom: 16px;
      opacity: 0.3;
    }

    /* Loading */
    .loading {
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 60px;
    }

    .spinner {
      width: 40px;
      height: 40px;
      border: 3px solid var(--card-border);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    /* Code/Pre */
    pre {
      background: rgba(0, 0, 0, 0.3);
      border: 1px solid var(--border-subtle);
      border-radius: var(--radius-md);
      padding: 16px;
      overflow-x: auto;
      font-size: 13px;
      line-height: 1.6;
      white-space: pre-wrap;
      word-break: break-word;
    }

    /* Scrollbar */
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }

    ::-webkit-scrollbar-track {
      background: transparent;
    }

    ::-webkit-scrollbar-thumb {
      background: var(--accent);
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: var(--accent-light);
    }

    /* Responsive */
    @media (max-width: 768px) {
      header {
        position: sticky;
        top: 0;
      }

      .header-content {
        max-height: none;
        overflow: visible;
      }

      .collapse-btn {
        display: flex;
      }

      .collapsible-content {
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.3s ease-out;
      }

      .collapsible-content.expanded {
        max-height: 800px;
        overflow-y: auto;
      }

      .wrap {
        padding: 12px;
      }

      h1 {
        font-size: 18px;
      }

      .subtitle {
        font-size: 12px;
      }

      .header-top {
        flex-direction: column;
        align-items: flex-start;
        gap: 12px;
        margin-bottom: 12px;
      }

      .header-actions {
        width: 100%;
        justify-content: space-between;
      }

      .status-pill {
        flex: 1;
        font-size: 12px;
        padding: 6px 12px;
      }

      .tabs {
        gap: 4px;
        margin-bottom: 8px;
      }

      .tab {
        padding: 6px 12px;
        font-size: 12px;
      }

      .controls {
        flex-direction: column;
        gap: 8px;
        margin-top: 8px;
        margin-bottom: 8px;
      }

      input, select, button {
        width: 100%;
        min-width: 100%;
      }

      input, select {
        padding: 10px 12px;
        font-size: 14px;
      }

      button {
        padding: 10px 14px;
        font-size: 13px;
      }

      .hint {
        font-size: 11px;
        margin-top: 6px;
        margin-bottom: 6px;
      }

      main {
        padding: 16px 0 80px;
      }

      .results-header {
        padding: 12px;
        font-size: 13px;
      }

      .results-count strong {
        font-size: 16px;
      }

      .grid {
        gap: 12px;
      }

      .card {
        padding: 14px;
      }

      .card h3 {
        font-size: 14px;
      }

      .card-image {
        height: 140px;
        margin-bottom: 12px;
      }

      .actions {
        gap: 6px;
      }

      .btn {
        padding: 8px 12px;
        font-size: 12px;
      }

      .toast {
        bottom: 16px;
        right: 16px;
        left: 16px;
        font-size: 13px;
        padding: 12px 16px;
      }

      pre {
        font-size: 12px;
        padding: 12px;
      }

      .empty {
        padding: 40px 16px;
      }

      .empty-icon {
        font-size: 36px;
      }
    }

    @media (max-width: 480px) {
      .wrap {
        padding: 10px;
      }

      h1 {
        font-size: 16px;
      }

      .subtitle {
        font-size: 11px;
      }

      .tab {
        padding: 6px 10px;
        font-size: 11px;
      }

      .card {
        padding: 12px;
      }

      .card-image {
        height: 120px;
      }

      .collapsible-content.expanded {
        max-height: 600px;
      }
    }

    /* Animations */
    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .card {
      animation: fadeIn 0.3s ease-out;
    }

    /* Toast Notification */
    .toast {
      position: fixed;
      bottom: 24px;
      right: 24px;
      padding: 16px 24px;
      background: var(--card-bg);
      border: 1px solid var(--success);
      border-radius: var(--radius-md);
      box-shadow: var(--shadow-lg);
      color: var(--text-primary);
      font-weight: 600;
      z-index: 1000;
      animation: slideIn 0.3s ease-out;
    }

    @keyframes slideIn {
      from {
        transform: translateX(400px);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }
  </style>
</head>
<body>
  <header>
    <div class="header-content">
      <div class="wrap">
        <div class="header-top">
          <div>
            <h1>Central de Consulta</h1>
            <div class="subtitle">Sistema integrado de produtos, entregas, vendedores e m√≠dias</div>
          </div>
          <div class="header-actions">
            <div class="status-pill loading" id="statusPill">
              <span id="statusText">Carregando dados...</span>
            </div>
            <button class="ghost" id="reloadBtn" title="Recarregar dados">‚Üª</button>
          </div>
        </div>

        <div class="tabs" role="tablist">
          <button class="tab" role="tab" data-tab="produtos" aria-selected="true">Produtos</button>
          <button class="tab" role="tab" data-tab="entregas">Entregas</button>
          <button class="tab" role="tab" data-tab="vendedores">Vendedores</button>
          <button class="tab" role="tab" data-tab="midia">V√≠deos/Fotos</button>
          <button class="tab" role="tab" data-tab="guia">Guia T√©cnico</button>
        </div>

        <button class="collapse-btn" id="collapseBtn">
          Filtros e Busca
        </button>

        <div class="collapsible-content" id="collapsibleContent">
          <div class="controls" id="controls"></div>
          <div class="hint" id="hint"></div>
        </div>
      </div>
    </div>
  </header>

  <main class="wrap">
    <div id="output"></div>
  </main>

<script>
(() => {
  'use strict';

  // ============ Configuration ============
  const CONFIG = {
    data: {
      products: "data/products.json",
      delivery: "data/delivery.json",
      sales: "data/salespeople.json",
      videos: "data/videos.json",
      branches: "data/branches.json",
      knowledge: "data/knowledge.json",
    },
    limits: {
      products: 60,
      delivery: 80,
      knowledge: 12000,
    },
    debounceDelay: 300,
    searchMinLength: 3,
  };

  // ============ State Management ============
  const state = {
    currentTab: "produtos",
    db: {
      products: [],
      delivery: [],
      sales: [],
      videos: [],
      branches: [],
      knowledge: null,
    },
    indexes: {
      salesById: new Map(),
      videosBySku: new Map(),
      branchNameById: new Map(),
    },
    ui: {},
    debounceTimers: new Map(),
    isLoading: false,
  };

  // ============ DOM References ============
  const dom = {
    output: document.getElementById('output'),
    controls: document.getElementById('controls'),
    hint: document.getElementById('hint'),
    statusPill: document.getElementById('statusPill'),
    statusText: document.getElementById('statusText'),
    reloadBtn: document.getElementById('reloadBtn'),
    collapseBtn: document.getElementById('collapseBtn'),
    collapsibleContent: document.getElementById('collapsibleContent'),
  };

  // ============ Utility Functions ============
  const utils = {
    normalize: (str) => {
      return (str ?? '')
        .toString()
        .normalize('NFD')
        .replace(/[\u0300-\u036f]/g, '')
        .toLowerCase()
        .trim();
    },

    escapeHtml: (str) => {
      return (str ?? '')
        .toString()
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#039;');
    },

    debounce: (key, fn, delay = CONFIG.debounceDelay) => {
      const prev = state.debounceTimers.get(key);
      if (prev) clearTimeout(prev);
      const timer = setTimeout(fn, delay);
      state.debounceTimers.set(key, timer);
    },

    showToast: (message) => {
      const toast = document.createElement('div');
      toast.className = 'toast';
      toast.textContent = message;
      document.body.appendChild(toast);
      setTimeout(() => toast.remove(), 3000);
    },

    copyToClipboard: async (text) => {
      try {
        await navigator.clipboard.writeText(text);
        utils.showToast('‚úì Copiado para a √°rea de transfer√™ncia');
      } catch {
        alert(text);
      }
    },
  };

  // ============ Status Management ============
  const status = {
    set: (message, type = 'ready') => {
      dom.statusPill.className = `status-pill ${type}`;
      dom.statusText.textContent = message;
    },

    loading: () => status.set('Carregando dados...', 'loading'),
    ready: () => status.set('Dados carregados', 'ready'),
    error: (msg) => status.set(msg || 'Erro ao carregar', 'error'),
  };

  // ============ Data Loading ============
  const data = {
    async fetchJson(url) {
      const response = await fetch(url, { cache: 'no-store' });
      if (!response.ok) {
        throw new Error(`Falha ao carregar ${url} (${response.status})`);
      }
      return response.json();
    },

    buildIndexes() {
      // Sales by ID
      state.indexes.salesById = new Map(
        state.db.sales.map(s => [String(s.id), s])
      );

      // Videos by SKU
      state.indexes.videosBySku = new Map();
      for (const video of state.db.videos) {
        const sku = String(video.codigo ?? '').trim();
        if (!sku) continue;
        if (!state.indexes.videosBySku.has(sku)) {
          state.indexes.videosBySku.set(sku, []);
        }
        state.indexes.videosBySku.get(sku).push(video);
      }

      // Branch names by ID
      state.indexes.branchNameById = new Map();
      for (const branch of state.db.branches) {
        const name = (branch.ramos || []).join(', ');
        state.indexes.branchNameById.set(String(branch.id), name);
      }
    },

    async loadAll() {
      if (state.isLoading) return;
      
      try {
        state.isLoading = true;
        status.loading();

        const [products, delivery, sales, videos, branches, knowledge] = await Promise.all([
          this.fetchJson(CONFIG.data.products),
          this.fetchJson(CONFIG.data.delivery),
          this.fetchJson(CONFIG.data.sales),
          this.fetchJson(CONFIG.data.videos),
          this.fetchJson(CONFIG.data.branches),
          this.fetchJson(CONFIG.data.knowledge),
        ]);

        state.db = { products, delivery, sales, videos, branches, knowledge };
        this.buildIndexes();
        
        status.ready();
        ui.mountControls(state.currentTab);
        render.results();
      } catch (error) {
        console.error('Erro ao carregar dados:', error);
        status.error('Erro ao carregar dados');
        
        dom.output.innerHTML = `
          <div class="empty">
            <div class="empty-icon">‚ö†Ô∏è</div>
            <h3 style="margin-bottom: 12px;">N√£o foi poss√≠vel carregar os dados</h3>
            <p style="color: var(--text-muted); margin-bottom: 20px;">
              Verifique se os arquivos JSON existem em <code>/data/</code>
            </p>
            <p style="font-size: 13px; color: var(--danger);">${utils.escapeHtml(error.message)}</p>
          </div>
        `;
      } finally {
        state.isLoading = false;
      }
    },
  };

  // ============ Collapse/Expand Controls (Mobile) ============
  const collapse = {
    init() {
      if (!dom.collapseBtn || !dom.collapsibleContent) return;

      // Expand on desktop, collapse on mobile by default
      const isMobile = window.innerWidth <= 768;
      if (!isMobile) {
        dom.collapsibleContent.classList.add('expanded');
        dom.collapseBtn.classList.add('expanded');
      }

      dom.collapseBtn.addEventListener('click', this.toggle.bind(this));

      // Handle resize
      window.addEventListener('resize', () => {
        const nowMobile = window.innerWidth <= 768;
        if (!nowMobile) {
          dom.collapsibleContent.classList.add('expanded');
          dom.collapseBtn.classList.add('expanded');
        }
      });
    },

    toggle() {
      const isExpanded = dom.collapsibleContent.classList.contains('expanded');
      
      if (isExpanded) {
        dom.collapsibleContent.classList.remove('expanded');
        dom.collapseBtn.classList.remove('expanded');
      } else {
        dom.collapsibleContent.classList.add('expanded');
        dom.collapseBtn.classList.add('expanded');
      }
    },

    collapse() {
      if (window.innerWidth <= 768) {
        dom.collapsibleContent.classList.remove('expanded');
        dom.collapseBtn.classList.remove('expanded');
        
        // Scroll to top of results smoothly
        setTimeout(() => {
          const mainElement = document.querySelector('main');
          if (mainElement) {
            mainElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
          }
        }, 100);
      }
    }
  };
  // ============ Tab Management ============
  const tabs = {
    switch: (tabName) => {
      state.currentTab = tabName;
      
      document.querySelectorAll('.tab').forEach(btn => {
        btn.setAttribute('aria-selected', String(btn.dataset.tab === tabName));
      });

      ui.mountControls(tabName);
      render.results();
      
      // Auto-expand controls when switching tabs on mobile
      if (window.innerWidth <= 768 && dom.collapsibleContent) {
        dom.collapsibleContent.classList.add('expanded');
        dom.collapseBtn.classList.add('expanded');
      }
    },

    init() {
      document.querySelectorAll('.tab').forEach(btn => {
        btn.addEventListener('click', () => this.switch(btn.dataset.tab));
      });
    },
  };

  // ============ UI Components ============
  const ui = {
    createInput(id, placeholder) {
      const input = document.createElement('input');
      input.id = id;
      input.placeholder = placeholder;
      input.autocomplete = 'off';
      return input;
    },

    createSelect(id, options, placeholder) {
      const select = document.createElement('select');
      select.id = id;
      
      const defaultOption = document.createElement('option');
      defaultOption.value = '';
      defaultOption.textContent = placeholder;
      select.appendChild(defaultOption);

      options.filter(v => v).forEach(value => {
        const option = document.createElement('option');
        option.value = value;
        option.textContent = value;
        select.appendChild(option);
      });

      return select;
    },

    createButton(label, className, onClick) {
      const button = document.createElement('button');
      button.textContent = label;
      if (className) button.className = className;
      button.addEventListener('click', onClick);
      return button;
    },

    attachSmartSearch(element, key) {
      element.addEventListener('input', () => {
        const value = (element.value || '').trim();
        utils.debounce(key, () => {
          if (value.length >= CONFIG.searchMinLength || value.length === 0) {
            render.results();
          }
        });
      });

      element.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
          e.preventDefault();
          render.results();
        }
      });
    },

    mountControls(tab) {
      dom.controls.innerHTML = '';
      dom.hint.innerHTML = '';
      state.ui = {};

      const controls = this.getControlsForTab(tab);
      
      if (controls.hint) {
        dom.hint.innerHTML = controls.hint;
      }

      if (controls.elements) {
        controls.elements.forEach(el => dom.controls.appendChild(el));
      }
    },

    getControlsForTab(tab) {
      const configs = {
        produtos: () => {
          const searchInput = this.createInput('q', 'Pesquisar produto (SKU / nome / ramo)...');
          const ramoSelect = this.createSelect('ramo', 
            ['', 'sorveteria', 'confeitaria', 'panificacao', 'embalagens', 'guloseimas'],
            'Filtrar ramo'
          );
          const searchBtn = this.createButton('Buscar', 'primary', () => {
            render.results();
            collapse.collapse();
          });

          this.attachSmartSearch(searchInput, 'prod_q');
          ramoSelect.addEventListener('change', render.results);

          state.ui.q = searchInput;
          state.ui.ramo = ramoSelect;

          return {
            hint: 'Digite SKU, nome ou ramo. Busca autom√°tica a partir de 3 caracteres.',
            elements: [searchInput, ramoSelect, searchBtn],
          };
        },

        entregas: () => {
          const cidadeInput = this.createInput('cidade', 'Pesquisar cidade... (ex.: Campinas)');
          const searchBtn = this.createButton('Buscar', 'primary', () => {
            render.results();
            collapse.collapse();
          });

          this.attachSmartSearch(cidadeInput, 'ent_cidade');
          state.ui.cidade = cidadeInput;

          return {
            hint: 'Digite o nome da cidade. Busca autom√°tica a partir de 3 caracteres.',
            elements: [cidadeInput, searchBtn],
          };
        },

        vendedores: () => {
          const nomeInput = this.createInput('qv', 'Pesquisar vendedor... (nome)');
          const branchSelect = this.createSelect('branch', ['', '1', '2'], 'Filtrar ramo (1/2)');
          const searchBtn = this.createButton('Buscar', 'primary', () => {
            render.results();
            collapse.collapse();
          });

          this.attachSmartSearch(nomeInput, 'vend_qv');
          branchSelect.addEventListener('change', render.results);

          state.ui.qv = nomeInput;
          state.ui.branch = branchSelect;

          return {
            hint: 'Pesquise por nome do vendedor. Busca autom√°tica a partir de 3 caracteres.',
            elements: [nomeInput, branchSelect, searchBtn],
          };
        },

        midia: () => {
          const skuInput = this.createInput('sku', 'SKU / C√≥digo do produto...');
          const searchBtn = this.createButton('Buscar', 'primary', () => {
            render.results();
            collapse.collapse();
          });

          this.attachSmartSearch(skuInput, 'midia_sku');
          state.ui.sku = skuInput;

          return {
            hint: 'Digite o SKU do produto. Busca autom√°tica a partir de 3 caracteres.',
            elements: [skuInput, searchBtn],
          };
        },

        guia: () => {
          const guiaInput = this.createInput('qg', 'Buscar no guia... (ex.: PAC, emulsificante)');
          const searchBtn = this.createButton('Buscar', 'primary', () => {
            render.results();
            collapse.collapse();
          });

          this.attachSmartSearch(guiaInput, 'guia_qg');
          state.ui.qg = guiaInput;

          return {
            hint: 'Busque no conte√∫do t√©cnico. Busca autom√°tica a partir de 3 caracteres.',
            elements: [guiaInput, searchBtn],
          };
        },
      };

      return configs[tab] ? configs[tab]() : { elements: [] };
    },
  };

  // ============ Render Functions ============
  const render = {
    results() {
      const renderers = {
        produtos: this.produtos,
        entregas: this.entregas,
        vendedores: this.vendedores,
        midia: this.midia,
        guia: this.guia,
      };

      const renderer = renderers[state.currentTab];
      if (renderer) renderer.call(this);
    },

    produtos() {
      const query = utils.normalize(state.ui.q?.value);
      const ramo = utils.normalize(state.ui.ramo?.value);

      let items = state.db.products || [];

      if (ramo) {
        items = items.filter(p => utils.normalize(p.RAMO) === ramo);
      }

      if (query) {
        items = items.filter(p => {
          const sku = utils.normalize(p.SKU);
          const nome = utils.normalize(p.PRODUTO);
          const ramoTxt = utils.normalize(p.RAMO);
          return sku.includes(query) || nome.includes(query) || ramoTxt.includes(query);
        });
      }

      items = items.slice(0, CONFIG.limits.products);

      if (!items.length) {
        dom.output.innerHTML = `
          <div class="empty">
            <div class="empty-icon">üîç</div>
            <h3>Nenhum produto encontrado</h3>
            <p style="margin-top: 8px; color: var(--text-muted);">Tente ajustar os filtros de busca</p>
          </div>
        `;
        return;
      }

      dom.output.innerHTML = `
        <div class="results-header">
          <div class="results-count">
            <strong>${items.length}</strong> produto(s) encontrado(s)
            ${items.length === CONFIG.limits.products ? ' (limite m√°ximo)' : ''}
          </div>
        </div>
        <div class="grid">
          ${items.map(p => this.productCard(p)).join('')}
        </div>
      `;
    },

    productCard(product) {
      const sku = utils.escapeHtml(product.SKU);
      const nome = utils.escapeHtml(product.PRODUTO);
      const ramo = utils.escapeHtml(product.RAMO || '');
      const img = (product.IMG || '').trim();

      const videos = state.indexes.videosBySku.get(String(product.SKU).trim()) || [];
      const hasMedia = videos.length > 0;

      return `
        <div class="card">
          ${img 
            ? `<img class="card-image" src="${utils.escapeHtml(img)}" alt="${nome}" loading="lazy" />`
            : `<div class="card-image placeholder">Sem imagem</div>`
          }
          
          <h3>${nome}</h3>
          
          <div class="card-meta">
            <div>
              <div class="card-label">SKU</div>
              <div class="card-value">${sku}</div>
            </div>
            <div class="pill">${ramo || '‚Äî'}</div>
          </div>

          ${hasMedia ? `
            <div style="margin-bottom: 12px;">
              <span class="badge">${videos.length}</span>
              <span style="margin-left: 8px; font-size: 13px; color: var(--text-secondary);">m√≠dia(s) dispon√≠vel(is)</span>
            </div>
          ` : ''}

          <div class="actions">
            <a class="btn ${hasMedia ? 'btn-icon' : ''}" href="#" onclick="window.__openMedia('${sku}'); return false;">
              ${hasMedia ? 'Ver v√≠deos/fotos' : 'Buscar m√≠dia'}
            </a>
            <a class="btn" href="#" onclick="window.__copy('${nome} (SKU ${sku})'); return false;">
              Copiar
            </a>
          </div>

          ${hasMedia && videos.length <= 4 ? `
            <div class="actions" style="margin-top: 8px;">
              ${videos.map(v => `
                <a class="btn btn-icon" href="${utils.escapeHtml(v.link)}" target="_blank" rel="noopener">
                  ${utils.escapeHtml(v.nome || 'Abrir')}
                </a>
              `).join('')}
            </div>
          ` : ''}
        </div>
      `;
    },

    entregas() {
      const query = utils.normalize(state.ui.cidade?.value);
      let items = state.db.delivery || [];

      if (query) {
        items = items.filter(d => utils.normalize(d.cidade).includes(query));
      }

      items = items.slice(0, CONFIG.limits.delivery);

      if (!items.length) {
        dom.output.innerHTML = `
          <div class="empty">
            <div class="empty-icon">üì¶</div>
            <h3>Nenhuma cidade encontrada</h3>
            <p style="margin-top: 8px; color: var(--text-muted);">Digite o nome da cidade para buscar</p>
          </div>
        `;
        return;
      }

      dom.output.innerHTML = `
        <div class="results-header">
          <div class="results-count">
            <strong>${items.length}</strong> cidade(s) encontrada(s)
          </div>
        </div>
        <div class="grid cols-2">
          ${items.map(d => this.deliveryCard(d)).join('')}
        </div>
      `;
    },

    deliveryCard(delivery) {
      const cidade = utils.escapeHtml(delivery.cidade);
      const dias = (delivery.dias_entrega || [])
        .map(d => `<span class="pill">${utils.escapeHtml(d)}</span>`)
        .join(' ');
      const obs = (delivery.observacao || '').trim();

      const vendedores = delivery.vendedores_por_ramo || {};
      const vendBlocks = Object.keys(vendedores)
        .sort()
        .map(branchId => {
          const ids = (vendedores[branchId] || []).map(String);
          const salesLinks = ids
            .map(id => state.indexes.salesById.get(id))
            .filter(Boolean)
            .map(s => `
              <a class="btn" href="${utils.escapeHtml(s.whatsapp_link)}" target="_blank" rel="noopener">
                WhatsApp ${utils.escapeHtml(s.nome)}
              </a>
            `)
            .join('');

          const branchName = state.indexes.branchNameById.get(String(branchId)) || `Ramo ${branchId}`;

          return `
            <div style="margin-top: 16px;">
              <div class="card-label" style="margin-bottom: 8px;">
                Vendedores ‚Ä¢ ${utils.escapeHtml(branchName)}
              </div>
              <div class="actions">
                ${salesLinks || `<span style="color: var(--text-muted);">‚Äî</span>`}
              </div>
            </div>
          `;
        })
        .join('');

      return `
        <div class="card">
          <div class="card-meta">
            <h3 style="margin: 0;">${cidade}</h3>
            <span class="pill">Entrega</span>
          </div>

          <div style="margin-top: 16px;">
            <div class="card-label" style="margin-bottom: 8px;">Dias de entrega</div>
            <div style="display: flex; flex-wrap: wrap; gap: 8px;">
              ${dias || `<span style="color: var(--text-muted);">‚Äî</span>`}
            </div>
          </div>

          ${obs ? `
            <div style="margin-top: 16px; padding: 12px; background: rgba(251, 146, 60, 0.1); border-left: 3px solid var(--warning); border-radius: var(--radius-sm);">
              <div class="card-label" style="margin-bottom: 4px;">Observa√ß√£o</div>
              <div style="font-size: 13px;">${utils.escapeHtml(obs)}</div>
            </div>
          ` : ''}

          ${vendBlocks}
        </div>
      `;
    },

    vendedores() {
      const query = utils.normalize(state.ui.qv?.value);
      const branch = (state.ui.branch?.value || '').trim();

      let items = state.db.sales || [];

      if (branch) {
        items = items.filter(s => String(s.id_ramo) === String(branch));
      }

      if (query) {
        items = items.filter(s => utils.normalize(s.nome).includes(query));
      }

      if (!items.length) {
        dom.output.innerHTML = `
          <div class="empty">
            <div class="empty-icon">üë§</div>
            <h3>Nenhum vendedor encontrado</h3>
            <p style="margin-top: 8px; color: var(--text-muted);">Tente ajustar os filtros de busca</p>
          </div>
        `;
        return;
      }

      dom.output.innerHTML = `
        <div class="results-header">
          <div class="results-count">
            <strong>${items.length}</strong> vendedor(es) encontrado(s)
          </div>
        </div>
        <div class="grid">
          ${items.map(s => this.sellerCard(s)).join('')}
        </div>
      `;
    },

    sellerCard(seller) {
      const nome = utils.escapeHtml(seller.nome);
      const tel = utils.escapeHtml(seller.telefone || '');
      const wa = utils.escapeHtml(seller.whatsapp_link || '#');
      const ramoId = String(seller.id_ramo ?? '');
      const ramoName = state.indexes.branchNameById.get(ramoId) || `Ramo ${ramoId}`;

      return `
        <div class="card">
          <div class="card-meta">
            <h3 style="margin: 0;">${nome}</h3>
            <span class="pill">ID ${utils.escapeHtml(String(seller.id))}</span>
          </div>

          <div style="margin-top: 12px;">
            <div class="card-label">Ramo</div>
            <div style="margin-top: 4px;">${utils.escapeHtml(ramoName)}</div>
          </div>

          <div style="margin-top: 12px;">
            <div class="card-label">Telefone</div>
            <div class="card-value" style="margin-top: 4px;">${tel || '‚Äî'}</div>
          </div>

          <div class="actions">
            <a class="btn" href="${wa}" target="_blank" rel="noopener">
              WhatsApp
            </a>
            ${tel ? `<a class="btn" href="tel:${tel.replace(/\D/g, '')}">Ligar</a>` : ''}
          </div>
        </div>
      `;
    },

    midia() {
      const sku = (state.ui.sku?.value || '').trim();

      if (!sku) {
        dom.output.innerHTML = `
          <div class="empty">
            <div class="empty-icon">üé•</div>
            <h3>Digite um SKU para buscar m√≠dias</h3>
            <p style="margin-top: 8px; color: var(--text-muted);">Exemplo: 1740</p>
          </div>
        `;
        return;
      }

      const videos = state.indexes.videosBySku.get(String(sku).trim()) || [];

      if (!videos.length) {
        dom.output.innerHTML = `
          <div class="empty">
            <div class="empty-icon">üîç</div>
            <h3>Nenhuma m√≠dia encontrada</h3>
            <p style="margin-top: 8px; color: var(--text-muted);">
              SKU <strong>${utils.escapeHtml(sku)}</strong> n√£o possui v√≠deos ou fotos cadastrados
            </p>
          </div>
        `;
        return;
      }

      dom.output.innerHTML = `
        <div class="card">
          <div class="card-meta">
            <h3 style="margin: 0;">M√≠dias do SKU ${utils.escapeHtml(sku)}</h3>
            <span class="badge">${videos.length}</span>
          </div>

          <div class="actions" style="margin-top: 20px;">
            ${videos.map(v => `
              <a class="btn btn-icon" href="${utils.escapeHtml(v.link)}" target="_blank" rel="noopener">
                ${utils.escapeHtml(v.nome || 'Abrir m√≠dia')}
              </a>
            `).join('')}
          </div>
        </div>
      `;
    },

    guia() {
      const content = (state.db.knowledge && state.db.knowledge.content) 
        ? String(state.db.knowledge.content) 
        : '';
      const query = utils.normalize(state.ui.qg?.value);

      if (!content) {
        dom.output.innerHTML = `
          <div class="empty">
            <div class="empty-icon">üìö</div>
            <h3>Guia t√©cnico n√£o dispon√≠vel</h3>
            <p style="margin-top: 8px; color: var(--text-muted);">
              O arquivo knowledge.json n√£o cont√©m conte√∫do
            </p>
          </div>
        `;
        return;
      }

      if (!query) {
        const preview = content.slice(0, CONFIG.limits.knowledge);
        const isTruncated = content.length > CONFIG.limits.knowledge;

        dom.output.innerHTML = `
          <div class="card">
            <div class="card-meta">
              <h3 style="margin: 0;">Guia T√©cnico</h3>
              <span class="pill">Texto completo</span>
            </div>
            <pre style="margin-top: 20px;">${utils.escapeHtml(preview)}${isTruncated ? '\n\n... (conte√∫do truncado para performance)' : ''}</pre>
          </div>
        `;
        return;
      }

      const lines = content.split(/\r?\n/);
      const matches = [];

      for (let i = 0; i < lines.length && matches.length < 80; i++) {
        if (utils.normalize(lines[i]).includes(query)) {
          matches.push({ lineNum: i + 1, content: lines[i] });
        }
      }

      if (!matches.length) {
        dom.output.innerHTML = `
          <div class="empty">
            <div class="empty-icon">üîç</div>
            <h3>Nenhum resultado encontrado</h3>
            <p style="margin-top: 8px; color: var(--text-muted);">
              Nenhuma linha cont√©m "<strong>${utils.escapeHtml(query)}</strong>"
            </p>
          </div>
        `;
        return;
      }

      dom.output.innerHTML = `
        <div class="card">
          <div class="card-meta">
            <h3 style="margin: 0;">Resultados no Guia T√©cnico</h3>
            <span class="badge">${matches.length}</span>
          </div>
          <pre style="margin-top: 20px;">${utils.escapeHtml(
            matches.map(m => `L${m.lineNum}: ${m.content}`).join('\n')
          )}</pre>
        </div>
      `;
    },
  };

  // ============ Global Functions ============
  window.__openMedia = (sku) => {
    tabs.switch('midia');
    if (state.ui.sku) {
      state.ui.sku.value = String(sku);
      render.results();
      state.ui.sku.focus();
    }
  };

  window.__copy = utils.copyToClipboard;

  // ============ Initialization ============
  function init() {
    tabs.init();
    collapse.init();
    dom.reloadBtn.addEventListener('click', () => data.loadAll());
    data.loadAll();
  }

  init();
})();
</script>
</body>
</html>
