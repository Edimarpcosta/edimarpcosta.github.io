<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Central de Consulta</title>
  <style>
    :root { --bg:#0b0f17; --card:#121a27; --muted:#9fb0c7; --text:#e9f1ff; --acc:#5eead4; --acc2:#60a5fa; --danger:#fb7185; }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:linear-gradient(180deg,#070a10, var(--bg));color:var(--text)}
    header{position:sticky;top:0;background:rgba(11,15,23,.85);backdrop-filter:blur(10px);border-bottom:1px solid rgba(255,255,255,.06);z-index:5}
    .wrap{max-width:1100px;margin:0 auto;padding:16px}
    h1{margin:0;font-size:18px;letter-spacing:.2px}
    .sub{color:var(--muted);font-size:12px;margin-top:6px}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    .tabs{display:flex;gap:8px;flex-wrap:wrap;margin-top:12px}
    .tab{border:1px solid rgba(255,255,255,.10);background:rgba(255,255,255,.04);color:var(--text);padding:8px 10px;border-radius:12px;cursor:pointer;font-weight:600;font-size:13px}
    .tab[aria-selected="true"]{border-color:rgba(94,234,212,.35);box-shadow:0 0 0 3px rgba(94,234,212,.10) inset}
    .bar{margin-top:12px;display:flex;gap:10px;flex-wrap:wrap}
    input, select, button{border-radius:12px;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.04);color:var(--text);padding:10px 12px;font-size:14px;outline:none}
    input{min-width:260px;flex:1}
    select{min-width:190px}
    button{cursor:pointer;font-weight:700}
    button.primary{border-color:rgba(96,165,250,.35);box-shadow:0 0 0 3px rgba(96,165,250,.10) inset}
    button.ghost{background:transparent}
    main{padding:18px 0}
    .grid{display:grid;grid-template-columns:repeat(3, minmax(0,1fr));gap:12px}
    @media (max-width: 980px){ .grid{grid-template-columns:repeat(2,minmax(0,1fr));} }
    @media (max-width: 640px){ .grid{grid-template-columns:1fr;} input{min-width:100%} }
    .card{background:rgba(18,26,39,.92);border:1px solid rgba(255,255,255,.08);border-radius:16px;padding:12px;box-shadow:0 8px 24px rgba(0,0,0,.35)}
    .muted{color:var(--muted);font-size:12px}
    .pill{display:inline-flex;gap:6px;align-items:center;padding:6px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.03);font-size:12px;color:var(--muted)}
    .k{color:var(--muted);font-size:12px}
    .v{font-weight:700}
    .img{width:100%;height:160px;object-fit:contain;background:rgba(255,255,255,.03);border-radius:12px;border:1px solid rgba(255,255,255,.06)}
    .card h3{margin:10px 0 6px;font-size:14px;line-height:1.25}
    .actions{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    a.btn{display:inline-flex;gap:8px;align-items:center;text-decoration:none;border-radius:12px;border:1px solid rgba(255,255,255,.12);padding:8px 10px;color:var(--text);background:rgba(255,255,255,.03);font-weight:700;font-size:13px}
    a.btn:hover{border-color:rgba(94,234,212,.35)}
    .empty{padding:16px;border:1px dashed rgba(255,255,255,.18);border-radius:16px;color:var(--muted)}
    .note{margin-top:10px;font-size:12px;color:var(--muted)}
    pre{white-space:pre-wrap;word-break:break-word;background:rgba(255,255,255,.03);border:1px solid rgba(255,255,255,.08);border-radius:16px;padding:12px;overflow:auto}
    .badge{color:#001015;background:var(--acc);border-radius:999px;padding:2px 8px;font-size:11px;font-weight:900}
    .warn{color:var(--danger);font-weight:800}
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <div class="row" style="justify-content:space-between">
        <div>
          <h1>Central de Consulta</h1>
          <div class="sub">Pesquisa rápida: produtos, entregas, vendedores, vídeos/fotos e guia técnico.</div>
        </div>
        <div class="row">
          <span class="pill" id="statusPill">carregando dados…</span>
          <button class="ghost" id="reloadBtn" title="Recarregar JSONs">Recarregar</button>
        </div>
      </div>

      <div class="tabs" role="tablist" aria-label="Seções">
        <button class="tab" role="tab" data-tab="produtos" aria-selected="true">Produtos</button>
        <button class="tab" role="tab" data-tab="entregas" aria-selected="false">Entregas</button>
        <button class="tab" role="tab" data-tab="vendedores" aria-selected="false">Vendedores</button>
        <button class="tab" role="tab" data-tab="midia" aria-selected="false">Vídeos/Fotos</button>
        <button class="tab" role="tab" data-tab="guia" aria-selected="false">Guia Técnico</button>
      </div>

      <div class="bar" id="controls"></div>
      <div class="note" id="hint"></div>
    </div>
  </header>

  <main class="wrap">
    <div id="out"></div>
  </main>

<script>
(() => {
  // -------- Config --------
  const DATA = {
    products:  "data/products.json",
    delivery:  "data/delivery.json",
    sales:     "data/salespeople.json",
    videos:    "data/videos.json",
    branches:  "data/branches.json",
    knowledge: "data/knowledge.json",
  };

  const state = {
    tab: "produtos",
    db: { products:[], delivery:[], sales:[], videos:[], branches:[], knowledge:null },
    idx: { salesById:new Map(), videosBySku:new Map(), branchNameById:new Map() }
  };

  // -------- Helpers --------
  const $ = (sel) => document.querySelector(sel);
  const out = $("#out");
  const controls = $("#controls");
  const hint = $("#hint");
  const statusPill = $("#statusPill");

  const norm = (s) => (s ?? "")
    .toString()
    .normalize("NFD").replace(/[\u0300-\u036f]/g,"")
    .toLowerCase()
    .trim();

  const escapeHtml = (s) => (s ?? "").toString()
    .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
    .replaceAll('"',"&quot;").replaceAll("'","&#039;");

  function setStatus(msg, ok=true){
    statusPill.textContent = msg;
    statusPill.style.background = ok ? "var(--acc)" : "var(--danger)";
    statusPill.style.color = ok ? "#001015" : "#120006";
  }

  async function fetchJson(url){
    const res = await fetch(url, { cache: "no-store" });
    if(!res.ok) throw new Error(`Falha ao carregar ${url} (${res.status})`);
    return res.json();
  }

  function buildIndexes(){
    state.idx.salesById = new Map(state.db.sales.map(v => [String(v.id), v]));
    state.idx.videosBySku = new Map();
    for(const v of state.db.videos){
      const key = String(v.codigo ?? "").trim();
      if(!key) continue;
      if(!state.idx.videosBySku.has(key)) state.idx.videosBySku.set(key, []);
      state.idx.videosBySku.get(key).push(v);
    }
    state.idx.branchNameById = new Map();
    // branches.json é lista de {id, ramos:[...]} -> usaremos id => ramos (texto)
    for(const b of state.db.branches){
      state.idx.branchNameById.set(String(b.id), (b.ramos || []).join(", "));
    }
  }

  async function loadAll(){
    try{
      setStatus("carregando dados…");
      const [products, delivery, sales, videos, branches, knowledge] = await Promise.all([
        fetchJson(DATA.products),
        fetchJson(DATA.delivery),
        fetchJson(DATA.sales),
        fetchJson(DATA.videos),
        fetchJson(DATA.branches),
        fetchJson(DATA.knowledge),
      ]);
      state.db = { products, delivery, sales, videos, branches, knowledge };
      buildIndexes();
      setStatus("dados prontos");
      render();
    } catch(err){
      console.error(err);
      setStatus("erro ao carregar dados", false);
      out.innerHTML = `<div class="empty">
        <div class="warn">Não consegui carregar os arquivos JSON.</div>
        <div class="muted" style="margin-top:8px">
          Verifique se a estrutura está correta e se os arquivos existem em <code>/data/</code>.
          <br/>Detalhe: ${escapeHtml(err.message)}
        </div>
      </div>`;
    }
  }

  // -------- UI: Tabs --------
  document.querySelectorAll(".tab").forEach(btn => {
    btn.addEventListener("click", () => {
      state.tab = btn.dataset.tab;
      document.querySelectorAll(".tab").forEach(b => b.setAttribute("aria-selected", String(b===btn)));
      render();
    });
  });

  $("#reloadBtn").addEventListener("click", loadAll);

  // -------- Render Controls --------
  function renderControls(){
    controls.innerHTML = "";
    hint.textContent = "";

    if(state.tab === "produtos"){
      hint.textContent = "Digite SKU, nome ou ramo (ex.: “algemix”, “morango”, “sorveteria”).";
      controls.append(
        input("q", "Pesquisar produto (SKU / nome / ramo)…"),
        select("ramo", ["", "sorveteria", "confeitaria", "panificacao", "embalagens", "guloseimas"], "Filtrar ramo"),
        button("Buscar", "primary", () => render())
      );
      return;
    }

    if(state.tab === "entregas"){
      hint.textContent = "Digite a cidade para ver dias de entrega e vendedores por ramo.";
      controls.append(
        input("cidade", "Pesquisar cidade… (ex.: Campinas)"),
        button("Buscar", "primary", () => render())
      );
      return;
    }

    if(state.tab === "vendedores"){
      hint.textContent = "Pesquise por nome ou filtre por ramo/segmento (ID 1 ou 2).";
      controls.append(
        input("qv", "Pesquisar vendedor… (nome)"),
        select("branch", ["", "1", "2"], "Filtrar ramo (1/2)"),
        button("Buscar", "primary", () => render())
      );
      return;
    }

    if(state.tab === "midia"){
      hint.textContent = "Digite o SKU (código) para ver vídeos/fotos relacionados.";
      controls.append(
        input("sku", "SKU / Código do produto…"),
        button("Buscar", "primary", () => render())
      );
      return;
    }

    if(state.tab === "guia"){
      hint.textContent = "Conteúdo técnico carregado do knowledge.json (busca simples no texto).";
      controls.append(
        input("qg", "Buscar no guia… (ex.: PAC, emulsificante, balanceamento)"),
        button("Buscar", "primary", () => render())
      );
      return;
    }
  }

  function input(id, placeholder){
    const el = document.createElement("input");
    el.id = id;
    el.placeholder = placeholder;
    el.autocomplete = "off";
    el.addEventListener("keydown", (e) => { if(e.key === "Enter") render(); });
    return el;
  }

  function select(id, options, placeholder){
    const el = document.createElement("select");
    el.id = id;
    const opt0 = document.createElement("option");
    opt0.value = "";
    opt0.textContent = placeholder;
    el.append(opt0);
    for(const v of options){
      if(v==="") continue;
      const o = document.createElement("option");
      o.value = v;
      o.textContent = v;
      el.append(o);
    }
    el.addEventListener("change", () => render());
    return el;
  }

  function button(label, cls, onClick){
    const el = document.createElement("button");
    el.textContent = label;
    if(cls) el.classList.add(cls);
    el.addEventListener("click", onClick);
    return el;
  }

  // -------- Render Results --------
  function render(){
    renderControls();

    if(state.tab === "produtos") return renderProdutos();
    if(state.tab === "entregas") return renderEntregas();
    if(state.tab === "vendedores") return renderVendedores();
    if(state.tab === "midia")     return renderMidia();
    if(state.tab === "guia")      return renderGuia();
  }

  function renderProdutos(){
    const q = norm($("#q")?.value);
    const ramo = norm($("#ramo")?.value);

    let items = state.db.products || [];
    if(ramo) items = items.filter(p => norm(p.RAMO) === ramo);

    if(q){
      items = items.filter(p => {
        const sku = norm(p.SKU);
        const nome = norm(p.PRODUTO);
        const r = norm(p.RAMO);
        return sku.includes(q) || nome.includes(q) || r.includes(q);
      });
    }

    items = items.slice(0, 60); // evita travar no celular

    if(!items.length){
      out.innerHTML = `<div class="empty">Nenhum produto encontrado.</div>`;
      return;
    }

    out.innerHTML = `
      <div class="muted" style="margin-bottom:10px">
        Mostrando <b>${items.length}</b> resultado(s) (limite 60 por performance).
      </div>
      <div class="grid">
        ${items.map(p => productCard(p)).join("")}
      </div>
    `;
  }

  function productCard(p){
    const sku = escapeHtml(p.SKU);
    const nome = escapeHtml(p.PRODUTO);
    const ramo = escapeHtml(p.RAMO || "");
    const img = (p.IMG || "").trim();
    const vids = state.idx.videosBySku.get(String(p.SKU)) || [];
    const hasMedia = vids.length > 0;

    return `
      <div class="card">
        ${img ? `<img class="img" src="${escapeHtml(img)}" alt="${nome}" loading="lazy" />`
              : `<div class="img" style="display:flex;align-items:center;justify-content:center;color:var(--muted)">
                   sem imagem
                 </div>`}
        <h3>${nome}</h3>
        <div class="row" style="justify-content:space-between">
          <div><span class="k">SKU</span> <span class="v">${sku}</span></div>
          <div class="pill">${ramo || "—"}</div>
        </div>

        <div class="actions">
          <a class="btn" href="#" onclick="window.__openMedia('${sku}');return false;">
            ${hasMedia ? "Ver vídeos/fotos" : "Buscar mídia"}
          </a>
          <a class="btn" href="#" onclick="window.__copy('${nome} (SKU ${sku})');return false;">Copiar</a>
        </div>
        ${hasMedia ? `<div class="note"><span class="badge">${vids.length}</span> mídia(s) encontrada(s) para este SKU</div>` : ``}
      </div>
    `;
  }

  function renderEntregas(){
    const q = norm($("#cidade")?.value);
    let rows = state.db.delivery || [];
    if(q) rows = rows.filter(r => norm(r.cidade).includes(q));
    rows = rows.slice(0, 80);

    if(!rows.length){
      out.innerHTML = `<div class="empty">Nenhuma cidade encontrada.</div>`;
      return;
    }

    out.innerHTML = `
      <div class="grid" style="grid-template-columns:repeat(2,minmax(0,1fr))">
        ${rows.map(r => deliveryCard(r)).join("")}
      </div>
    `;
  }

  function deliveryCard(r){
    const cidade = escapeHtml(r.cidade);
    const dias = (r.dias_entrega || []).map(d => `<span class="pill">${escapeHtml(d)}</span>`).join(" ");
    const obs = (r.observacao || "").trim();

    const vend = r.vendedores_por_ramo || {};
    const blocos = Object.keys(vend).sort().map(branchId => {
      const ids = (vend[branchId] || []).map(String);
      const names = ids
        .map(id => state.idx.salesById.get(id))
        .filter(Boolean)
        .map(v => `<a class="btn" href="${escapeHtml(v.whatsapp_link)}" target="_blank" rel="noopener">WhatsApp ${escapeHtml(v.nome)}</a>`)
        .join(" ");

      const label = state.idx.branchNameById.get(String(branchId)) || `Ramo ${branchId}`;
      return `
        <div style="margin-top:10px">
          <div class="muted"><b>Vendedores</b> • ${escapeHtml(label)}</div>
          <div class="actions">${names || `<span class="muted">—</span>`}</div>
        </div>
      `;
    }).join("");

    return `
      <div class="card">
        <div class="row" style="justify-content:space-between">
          <h3 style="margin:0">${cidade}</h3>
          <span class="pill">Entrega</span>
        </div>
        <div class="muted" style="margin-top:8px">Dias:</div>
        <div class="row" style="margin-top:6px">${dias || `<span class="muted">—</span>`}</div>
        ${obs ? `<div class="note"><b>Obs.:</b> ${escapeHtml(obs)}</div>` : ``}
        ${blocos}
      </div>
    `;
  }

  function renderVendedores(){
    const q = norm($("#qv")?.value);
    const branch = ($("#branch")?.value || "").trim();

    let items = state.db.sales || [];
    if(branch) items = items.filter(v => String(v.id_ramo) === String(branch));
    if(q) items = items.filter(v => norm(v.nome).includes(q));

    if(!items.length){
      out.innerHTML = `<div class="empty">Nenhum vendedor encontrado.</div>`;
      return;
    }

    out.innerHTML = `
      <div class="grid">
        ${items.map(v => sellerCard(v)).join("")}
      </div>
    `;
  }

  function sellerCard(v){
    const nome = escapeHtml(v.nome);
    const tel = escapeHtml(v.telefone || "");
    const wa = escapeHtml(v.whatsapp_link || "#");
    const ramoId = escapeHtml(String(v.id_ramo ?? ""));
    const ramoTxt = escapeHtml(state.idx.branchNameById.get(String(v.id_ramo)) || `Ramo ${ramoId}`);

    return `
      <div class="card">
        <h3 style="margin:0 0 6px">${nome}</h3>
        <div class="muted">${ramoTxt}</div>
        <div class="row" style="margin-top:10px;justify-content:space-between">
          <div><span class="k">Telefone</span> <span class="v">${tel || "—"}</span></div>
          <span class="pill">ID ${escapeHtml(String(v.id))}</span>
        </div>
        <div class="actions" style="margin-top:12px">
          <a class="btn" href="${wa}" target="_blank" rel="noopener">Abrir WhatsApp</a>
          ${tel ? `<a class="btn" href="tel:${tel.replace(/\D/g,'')}">Ligar</a>` : ``}
        </div>
      </div>
    `;
  }

  function renderMidia(){
    const sku = ($("#sku")?.value || "").trim();
    if(!sku){
      out.innerHTML = `<div class="empty">Digite um SKU para buscar mídias. Ex.: 1740</div>`;
      return;
    }
    const list = state.idx.videosBySku.get(String(sku)) || [];
    if(!list.length){
      out.innerHTML = `<div class="empty">Nenhuma mídia encontrada para o SKU <b>${escapeHtml(sku)}</b>.</div>`;
      return;
    }
    out.innerHTML = `
      <div class="card">
        <div class="row" style="justify-content:space-between">
          <h3 style="margin:0">Mídias do SKU ${escapeHtml(sku)}</h3>
          <span class="pill">${list.length} item(ns)</span>
        </div>
        <div class="actions" style="margin-top:12px">
          ${list.map(v => `<a class="btn" href="${escapeHtml(v.link)}" target="_blank" rel="noopener">${escapeHtml(v.nome || "Abrir")}</a>`).join("")}
        </div>
      </div>
    `;
  }

  function renderGuia(){
    const raw = (state.db.knowledge && state.db.knowledge.content) ? String(state.db.knowledge.content) : "";
    const q = norm($("#qg")?.value);

    if(!raw){
      out.innerHTML = `<div class="empty">knowledge.json não tem conteúdo em <code>content</code>.</div>`;
      return;
    }

    if(!q){
      out.innerHTML = `
        <div class="card">
          <div class="row" style="justify-content:space-between">
            <h3 style="margin:0">Guia técnico</h3>
            <span class="pill">texto completo</span>
          </div>
          <pre style="margin-top:12px">${escapeHtml(raw.slice(0, 12000))}${raw.length>12000 ? "\n\n… (cortado para performance)" : ""}</pre>
        </div>
      `;
      return;
    }

    const lines = raw.split(/\r?\n/);
    const hits = [];
    for(let i=0;i<lines.length;i++){
      if(norm(lines[i]).includes(q)) hits.push({i, line: lines[i]});
      if(hits.length >= 80) break;
    }

    if(!hits.length){
      out.innerHTML = `<div class="empty">Nenhum resultado no guia para <b>${escapeHtml(q)}</b>.</div>`;
      return;
    }

    out.innerHTML = `
      <div class="card">
        <div class="row" style="justify-content:space-between">
          <h3 style="margin:0">Resultados no guia</h3>
          <span class="pill">${hits.length} linha(s)</span>
        </div>
        <pre style="margin-top:12px">${escapeHtml(hits.map(h => `L${h.i+1}: ${h.line}`).join("\n"))}</pre>
      </div>
    `;
  }

  // -------- Small utilities exposed for inline handlers --------
  window.__openMedia = (sku) => {
    state.tab = "midia";
    document.querySelectorAll(".tab").forEach(b => b.setAttribute("aria-selected", String(b.dataset.tab==="midia")));
    render();
    const el = $("#sku");
    if(el){ el.value = sku; render(); }
  };

  window.__copy = async (text) => {
    try{
      await navigator.clipboard.writeText(text);
      setStatus("copiado ✅");
      setTimeout(() => setStatus("dados prontos"), 1200);
    } catch {
      alert(text);
    }
  };

  // boot
  loadAll();
})();
</script>
</body>
</html>
