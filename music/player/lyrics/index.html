<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Church Player - Apresenta√ß√£o Profissional</title>
    <link rel="icon" href="data:,">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jsmediatags/3.9.5/jsmediatags.min.js"></script>
    <script src="https://unpkg.com/browser-id3-writer@4.4.0/dist/browser-id3-writer.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/lamejs@1.2.1/lame.min.js"></script>
    
    <style>
        /* ==========================================================================
           CSS COMPLETO E ORIGINAL - SEM CORTES
           ========================================================================== */
        :root {
            --primary: #6366f1;
            --bg: #0a0a0f;
            --surface: #1a1a24;
            --hl: #ffeaa7;
            --text: #e5e7eb;
            --success: #00b894;
            --error: #d63031;
            --font-size-base: 1.4em;
            --font-size-active: 1.8em;
            --color-inactive: #555;
            --color-active: #ffeaa7;
            --bg-type: solid;
            --bg-value: #0a0a0f;
            --bg-opacity: 1;
            --bg-blur: 0px;
            --line-spacing: 1.2;
            --text-align: center;
            --font-weight-active: 800;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--bg);
            color: var(--text);
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        body.presentation-mode { cursor: none; }
        body.presentation-mode header,
        body.presentation-mode footer,
        body.presentation-mode .controls { display: none !important; }

        body::before {
            content: ''; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            z-index: -2; background: var(--bg-value); filter: blur(var(--bg-blur));
        }

        body::after {
            content: ''; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            z-index: -1; background: rgba(0, 0, 0, var(--bg-opacity));
        }

        body[data-bg-type="gradient"]::before {
            background: linear-gradient(135deg, var(--bg-value), var(--bg-value-2, #1a1a24));
        }

        body[data-bg-type="image"]::before {
            background-image: var(--bg-value); background-size: cover; background-position: center;
        }

        header {
            background: var(--surface); padding: 12px 20px; display: flex; align-items: center;
            gap: 15px; border-bottom: 1px solid #333; z-index: 10; transition: all 0.3s ease;
        }
        
        .btn-file {
            position: relative; overflow: hidden; background: var(--primary); color: white;
            padding: 8px 16px; border-radius: 6px; font-weight: bold; cursor: pointer;
            display: flex; align-items: center; gap: 6px; white-space: nowrap; transition: 0.2s; border: none;
        }
        .btn-file:hover { filter: brightness(1.1); transform: translateY(-1px); }
        .btn-file input { position: absolute; opacity: 0; width: 100%; height: 100%; cursor: pointer; top: 0; left: 0; }

        .track-info { flex: 1; display: flex; flex-direction: column; overflow: hidden; white-space: nowrap; }
        .track-title { font-size: 1.1em; font-weight: bold; color: white; text-overflow: ellipsis; overflow: hidden; }
        .track-artist { font-size: 0.9em; color: #aaa; text-overflow: ellipsis; overflow: hidden; }

        .controls { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
        
        .btn {
            background: #333; border: 1px solid #444; color: #ddd; padding: 8px 12px;
            border-radius: 6px; cursor: pointer; font-size: 0.9em; white-space: nowrap; transition: all 0.2s ease;
        }
        .btn:hover { background: #444; transform: translateY(-1px); }
        .btn:active { transform: translateY(0); }

        .btn-presentation { background: #8b5cf6; color: white; font-weight: bold; }
        .btn-presentation:hover { background: #7c3aed; }

        .dropdown { position: relative; display: inline-block; }
        .btn-action { background: var(--success); color: white; border: none; font-weight: bold; }
        .btn-action:hover { background: #00a383; }
        
        .dropdown-content {
            display: none; position: absolute; right: 0; top: 100%; background-color: #2d3436;
            min-width: 220px; box-shadow: 0 8px 16px rgba(0,0,0,0.5); z-index: 100;
            border-radius: 6px; overflow: hidden; margin-top: 5px;
        }
        .dropdown-content button {
            color: white; padding: 12px 16px; text-decoration: none; display: block; width: 100%;
            text-align: left; background: none; border: none; cursor: pointer;
            border-bottom: 1px solid #444; transition: background 0.2s;
        }
        .dropdown-content button:hover { background-color: #333; }
        .dropdown:hover .dropdown-content { display: block; }
        .tag-info { font-size: 0.75em; color: #aaa; margin-left: 5px; }

        main {
            flex: 1; overflow-y: auto; text-align: var(--text-align); position: relative;
            scroll-behavior: smooth; display: flex; flex-direction: column;
        }

        .church-name {
            position: fixed; width: 100%; padding: 20px; font-size: 1.5em; font-weight: bold;
            z-index: 5; text-align: center; opacity: 0.8; transition: opacity 0.3s;
        }
        .church-name.top { top: 0; }
        .church-name.bottom { bottom: 0; }
        .church-name.hidden { display: none; }

        .lyrics-box { padding: 50vh 20px; max-width: 1200px; margin: 0 auto; width: 100%; }
        
        .l-line {
            padding: 10px; font-size: var(--font-size-base); color: var(--color-inactive);
            transition: all 0.3s ease; border-radius: 6px; cursor: pointer; margin: 4px 0; line-height: var(--line-spacing);
        }
        .l-line:hover { background: rgba(255,255,255,0.05); }
        .l-line.active {
            color: var(--color-active); font-size: var(--font-size-active); font-weight: var(--font-weight-active);
            transform: scale(1.05); text-shadow: 0 0 15px rgba(255, 234, 167, 0.3);
        }
        .plain-text { white-space: pre-wrap; font-size: 1.2em; line-height: 1.6; color: #ccc; padding-top: 50px; }

        .modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); z-index: 100; justify-content: center; align-items: center; backdrop-filter: blur(5px);
        }
        .modal.active { display: flex; }
        
        .modal-box {
            background: var(--surface); width: 90%; max-width: 700px; max-height: 85vh;
            border-radius: 10px; display: flex; flex-direction: column;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5); border: 1px solid #333; animation: modalSlideIn 0.3s ease;
        }

        @keyframes modalSlideIn { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }

        .modal-header { padding: 20px; border-bottom: 1px solid #333; display: flex; justify-content: space-between; align-items: center; }
        .modal-header h2 { font-size: 1.3em; color: white; }
        .modal-close {
            background: #d63031; color: white; border: none; width: 32px; height: 32px;
            border-radius: 50%; cursor: pointer; font-size: 1.2em; display: flex; align-items: center;
            justify-content: center; transition: all 0.2s;
        }
        .modal-close:hover { background: #c0392b; transform: rotate(90deg); }

        .modal-tabs { display: flex; border-bottom: 1px solid #333; background: #16161c; }
        .modal-tab {
            flex: 1; padding: 12px; background: none; border: none; color: #888; cursor: pointer;
            font-size: 0.9em; transition: all 0.2s; border-bottom: 2px solid transparent;
        }
        .modal-tab:hover { color: #aaa; background: rgba(255,255,255,0.05); }
        .modal-tab.active { color: var(--primary); border-bottom-color: var(--primary); }

        .modal-content { flex: 1; overflow-y: auto; padding: 20px; }
        .tab-panel { display: none; }
        .tab-panel.active { display: block; }

        .setting-group { margin-bottom: 25px; }
        .setting-label { display: block; margin-bottom: 8px; color: #aaa; font-size: 0.9em; font-weight: 600; }
        .setting-input {
            width: 100%; background: #222; border: 1px solid #444; color: white;
            padding: 10px; border-radius: 6px; font-size: 0.95em;
        }
        .setting-input:focus { outline: none; border-color: var(--primary); }

        .slider-container { display: flex; align-items: center; gap: 10px; }
        .slider { flex: 1; height: 6px; border-radius: 3px; background: #333; outline: none; -webkit-appearance: none; }
        .slider::-webkit-slider-thumb {
            -webkit-appearance: none; appearance: none; width: 18px; height: 18px;
            border-radius: 50%; background: var(--primary); cursor: pointer; transition: all 0.2s;
        }
        .slider::-webkit-slider-thumb:hover { transform: scale(1.2); }
        .slider-value { min-width: 50px; text-align: right; color: white; font-weight: bold; }

        .color-picker-group { display: flex; gap: 10px; align-items: center; }
        .color-picker { width: 60px; height: 40px; border: 2px solid #444; border-radius: 6px; cursor: pointer; }

        .radio-group { display: flex; gap: 15px; flex-wrap: wrap; }
        .radio-option { display: flex; align-items: center; gap: 6px; cursor: pointer; }
        .radio-option input[type="radio"] { cursor: pointer; }

        .theme-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 15px; }
        .theme-card {
            background: #222; border: 2px solid #333; border-radius: 8px; padding: 15px;
            cursor: pointer; transition: all 0.2s; text-align: center;
        }
        .theme-card:hover { border-color: var(--primary); transform: translateY(-2px); }
        .theme-card.active { border-color: var(--success); background: #2a2a2a; }
        .theme-preview { width: 100%; height: 60px; border-radius: 6px; margin-bottom: 10px; }
        .theme-name { font-weight: bold; color: white; }

        .inp-search { flex: 1; background: #222; border: 1px solid #444; color: white; padding: 10px; border-radius: 4px; }
        .results-area { flex: 1; overflow-y: auto; padding: 10px; }
        .res-item { display: flex; justify-content: space-between; align-items: center; padding: 12px; border-bottom: 1px solid #333; transition: 0.2s; cursor: pointer; }
        .res-item:hover { background: #2a2a2a; }
        .res-info b { display: block; color: white; margin-bottom: 4px; }
        
        .tag { padding: 2px 6px; border-radius: 4px; font-size: 0.75em; font-weight: bold; margin-left: 8px; vertical-align: middle; }
        .tag-sync { background: #00b894; color: white; }
        .tag-txt { background: #fdcb6e; color: #333; }

        footer { padding: 15px; background: var(--surface); border-top: 1px solid #333; transition: all 0.3s ease; }
        audio { width: 100%; outline: none; }
        
        #loading {
            display: none; position: fixed; top: 100px; left: 50%; transform: translateX(-50%);
            background: var(--primary); color: white; padding: 15px 30px; border-radius: 30px;
            font-weight: bold; box-shadow: 0 5px 15px rgba(0,0,0,0.3); z-index: 50; text-align: center;
        }
        .progress-bar { width: 100%; height: 4px; background: rgba(255,255,255,0.3); margin-top: 8px; border-radius: 2px; }
        .progress-fill { height: 100%; background: white; width: 0%; transition: width 0.1s; border-radius: 2px; }

        @media (max-width: 1024px) { .lyrics-box { width: 85%; } }
        @media (max-width: 768px) {
            header { flex-wrap: wrap; padding: 10px; }
            .controls { width: 100%; justify-content: space-between; }
            .btn { padding: 6px 10px; font-size: 0.85em; }
            .lyrics-box { width: 95%; padding: 40vh 15px; }
            .l-line { font-size: calc(var(--font-size-base) * 0.9); }
            .l-line.active { font-size: calc(var(--font-size-active) * 0.9); }
            .modal-box { width: 95%; max-height: 90vh; }
            .modal-tabs { overflow-x: auto; }
            .modal-tab { font-size: 0.8em; padding: 10px 8px; }
            .theme-grid { grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); }
        }
        @media (max-width: 480px) {
            .track-info { display: none; }
            .btn-file span { display: none; }
            .btn-file::after { content: 'üìÇ'; }
        }
    </style>
</head>
<body data-bg-type="solid">

<div id="loading">
    <span id="loadingText">Carregando...</span>
    <div class="progress-bar" id="progressBar" style="display:none"><div class="progress-fill" id="progressFill"></div></div>
</div>

<div class="church-name hidden" id="churchName">Nome da Igreja</div>

<header id="mainHeader">
    <button class="btn-file">
        <span>üìÇ Abrir Arquivo</span>
        <input type="file" id="fileInput" accept="audio/*">
    </button>

    <div class="track-info">
        <div class="track-title" id="lblTitle">Church Player</div>
        <div class="track-artist" id="lblArtist">Arraste √Åudio (+ LRC) aqui</div>
    </div>

    <div class="controls">
        <button class="btn btn-presentation" id="btnPresentation" onclick="app.togglePresentationMode()">üñ•Ô∏è Apresenta√ß√£o</button>
        <button class="btn" id="btnSettings" onclick="app.openSettings()">‚öôÔ∏è Configura√ß√µes</button>
        <button class="btn" id="btnToggleType" onclick="app.toggleView()" style="display:none">Ver Texto</button>
        <button class="btn" onclick="app.openSearch()">üîç Manual / Colar</button>
        
        <div class="dropdown" id="dropdownSave" style="display:none">
            <button class="btn btn-action">üíæ Salvar...</button>
            <div class="dropdown-content">
                <button onclick="app.downloadLrc()">üìÑ Salvar .LRC</button>
                <button id="btnEmbed" onclick="app.embedInFile()">üéµ Embutir no √Åudio <span id="embedTag" class="tag-info"></span></button>
            </div>
        </div>
    </div>
</header>

<main id="mainArea">
    <div class="lyrics-box" id="lyricsContainer">
        <div style="margin-top:20vh; color:#444">
            Suporta MP3 e FLAC (Convers√£o Auto).<br>
            Carregue um arquivo para come√ßar.
        </div>
    </div>
</main>

<footer id="mainFooter">
    <audio id="audioPlayer" controls preload="metadata"></audio>
</footer>

<div class="modal" id="searchModal">
    <div class="modal-box">
        <div class="modal-header">
            <h2>Busca Manual / Colar Letra</h2>
            <button class="modal-close" onclick="app.closeModal('searchModal')">√ó</button>
        </div>
        <div style="padding: 15px; display: flex; gap: 10px; border-bottom: 1px solid #333;">
            <input type="text" class="inp-search" id="inpTrack" placeholder="M√∫sica">
            <input type="text" class="inp-search" id="inpArtist" placeholder="Artista">
            <button class="btn btn-action" onclick="app.doManualSearch()">Buscar</button>
        </div>
        <div class="results-area" id="resultsList" style="max-height: 200px;">
            <div style="text-align:center; padding:20px; color:#555">Digite e busque para ver as op√ß√µes.</div>
        </div>
        <div style="padding: 15px; background: #16161c; border-top: 1px solid #333;">
            <label class="setting-label">Ou Cole a Letra (Sincronizada ou Texto):</label>
            <textarea id="pastedLyricsText" style="width:100%; height:120px; background:#222; color:#fff; border:1px solid #444; border-radius:4px; padding:10px; font-family:monospace;" placeholder="Ex: [00:12.50] Primeira linha..."></textarea>
            <button class="btn btn-action" style="width:100%; margin-top:10px;" onclick="app.applyPastedLyrics()">Aplicar Letra Colada</button>
        </div>
    </div>
</div>

<div class="modal" id="settingsModal">
    <div class="modal-box">
        <div class="modal-header">
            <h2>Configura√ß√µes</h2>
            <button class="modal-close" onclick="app.closeModal('settingsModal')">√ó</button>
        </div>
        
        <div class="modal-tabs">
            <button class="modal-tab active" onclick="app.switchTab('appearance')">üé® Apar√™ncia</button>
            <button class="modal-tab" onclick="app.switchTab('background')">üñºÔ∏è Fundo</button>
            <button class="modal-tab" onclick="app.switchTab('church')">‚õ™ Igreja</button>
            <button class="modal-tab" onclick="app.switchTab('themes')">üíæ Temas</button>
        </div>

        <div class="modal-content">
            <div class="tab-panel active" id="tab-appearance">
                <div class="setting-group">
                    <label class="setting-label">Tamanho da Fonte Base</label>
                    <div class="slider-container">
                        <input type="range" class="slider" id="fontSize" min="1.0" max="3.0" step="0.1" value="1.4">
                        <span class="slider-value" id="fontSizeValue">1.4x</span>
                    </div>
                </div>
                <div class="setting-group">
                    <label class="setting-label">Tamanho da Linha Ativa</label>
                    <div class="slider-container">
                        <input type="range" class="slider" id="fontSizeActive" min="1.2" max="2.5" step="0.1" value="1.8">
                        <span class="slider-value" id="fontSizeActiveValue">1.8x</span>
                    </div>
                </div>
                <div class="setting-group">
                    <label class="setting-label">Cor do Texto Inativo</label>
                    <div class="color-picker-group">
                        <input type="color" class="color-picker" id="colorInactive" value="#555555">
                        <input type="text" class="setting-input" id="colorInactiveText" value="#555555" style="flex: 1;">
                    </div>
                </div>
                <div class="setting-group">
                    <label class="setting-label">Cor do Texto Ativo</label>
                    <div class="color-picker-group">
                        <input type="color" class="color-picker" id="colorActive" value="#ffeaa7">
                        <input type="text" class="setting-input" id="colorActiveText" value="#ffeaa7" style="flex: 1;">
                    </div>
                </div>
                <div class="setting-group">
                    <label class="setting-label">Peso da Fonte Ativa</label>
                    <div class="radio-group">
                        <label class="radio-option"><input type="radio" name="fontWeight" value="400"> Normal</label>
                        <label class="radio-option"><input type="radio" name="fontWeight" value="700"> Bold</label>
                        <label class="radio-option"><input type="radio" name="fontWeight" value="800" checked> Extra Bold</label>
                    </div>
                </div>
                <div class="setting-group">
                    <label class="setting-label">Espa√ßamento entre Linhas</label>
                    <div class="slider-container">
                        <input type="range" class="slider" id="lineSpacing" min="1.0" max="2.0" step="0.1" value="1.2">
                        <span class="slider-value" id="lineSpacingValue">1.2</span>
                    </div>
                </div>
                <div class="setting-group">
                    <label class="setting-label">Alinhamento do Texto</label>
                    <div class="radio-group">
                        <label class="radio-option"><input type="radio" name="textAlign" value="left"> Esquerda</label>
                        <label class="radio-option"><input type="radio" name="textAlign" value="center" checked> Centro</label>
                        <label class="radio-option"><input type="radio" name="textAlign" value="right"> Direita</label>
                    </div>
                </div>
            </div>

            <div class="tab-panel" id="tab-background">
                <div class="setting-group">
                    <label class="setting-label">Tipo de Fundo</label>
                    <div class="radio-group">
                        <label class="radio-option"><input type="radio" name="bgType" value="solid" checked> Cor S√≥lida</label>
                        <label class="radio-option"><input type="radio" name="bgType" value="gradient"> Gradiente</label>
                        <label class="radio-option"><input type="radio" name="bgType" value="image"> Imagem</label>
                    </div>
                </div>
                <div class="setting-group" id="bgSolidGroup">
                    <label class="setting-label">Cor do Fundo</label>
                    <div class="color-picker-group">
                        <input type="color" class="color-picker" id="bgColor" value="#0a0a0f">
                        <input type="text" class="setting-input" id="bgColorText" value="#0a0a0f" style="flex: 1;">
                    </div>
                </div>
                <div class="setting-group" id="bgGradientGroup" style="display:none;">
                    <label class="setting-label">Cor 1 do Gradiente</label>
                    <div class="color-picker-group">
                        <input type="color" class="color-picker" id="bgGradient1" value="#0a0a0f">
                        <input type="text" class="setting-input" id="bgGradient1Text" value="#0a0a0f" style="flex: 1;">
                    </div>
                    <label class="setting-label" style="margin-top: 15px;">Cor 2 do Gradiente</label>
                    <div class="color-picker-group">
                        <input type="color" class="color-picker" id="bgGradient2" value="#1a1a24">
                        <input type="text" class="setting-input" id="bgGradient2Text" value="#1a1a24" style="flex: 1;">
                    </div>
                </div>
                <div class="setting-group" id="bgImageGroup" style="display:none;">
                    <label class="setting-label">URL da Imagem</label>
                    <input type="text" class="setting-input" id="bgImageUrl" placeholder="https://exemplo.com/imagem.jpg">
                </div>
                <div class="setting-group">
                    <label class="setting-label">Opacidade do Overlay (Escurecimento)</label>
                    <div class="slider-container">
                        <input type="range" class="slider" id="bgOpacity" min="0" max="1" step="0.05" value="0.3">
                        <span class="slider-value" id="bgOpacityValue">30%</span>
                    </div>
                </div>
                <div class="setting-group">
                    <label class="setting-label">Desfoque do Fundo</label>
                    <div class="slider-container">
                        <input type="range" class="slider" id="bgBlur" min="0" max="20" step="1" value="0">
                        <span class="slider-value" id="bgBlurValue">0px</span>
                    </div>
                </div>
            </div>

            <div class="tab-panel" id="tab-church">
                <div class="setting-group">
                    <label class="setting-label">Nome da Igreja/Organiza√ß√£o</label>
                    <input type="text" class="setting-input" id="churchNameInp" placeholder="Digite o nome da igreja">
                </div>
                <div class="setting-group">
                    <label class="setting-label">Posi√ß√£o do Nome</label>
                    <div class="radio-group">
                        <label class="radio-option"><input type="radio" name="churchPosition" value="top" checked> Topo</label>
                        <label class="radio-option"><input type="radio" name="churchPosition" value="bottom"> Rodap√©</label>
                        <label class="radio-option"><input type="radio" name="churchPosition" value="hidden"> Desativado</label>
                    </div>
                </div>
                <div class="setting-group">
                    <label class="setting-label">Tamanho do Nome</label>
                    <div class="slider-container">
                        <input type="range" class="slider" id="churchNameSize" min="1.0" max="3.0" step="0.1" value="1.5">
                        <span class="slider-value" id="churchNameSizeValue">1.5em</span>
                    </div>
                </div>
                <div class="setting-group">
                    <label class="setting-label">Cor do Nome</label>
                    <div class="color-picker-group">
                        <input type="color" class="color-picker" id="churchNameColor" value="#ffffff">
                        <input type="text" class="setting-input" id="churchNameColorText" value="#ffffff" style="flex: 1;">
                    </div>
                </div>
                <div class="setting-group">
                    <label class="setting-label">Opacidade do Nome</label>
                    <div class="slider-container">
                        <input type="range" class="slider" id="churchNameOpacity" min="0" max="1" step="0.05" value="0.8">
                        <span class="slider-value" id="churchNameOpacityValue">80%</span>
                    </div>
                </div>
            </div>

            <div class="tab-panel" id="tab-themes">
                <div class="setting-group">
                    <label class="setting-label">Temas Pr√©-definidos</label>
                    <div class="theme-grid" id="themesGrid"></div>
                </div>
                <div class="setting-group" style="margin-top: 30px;">
                    <button class="btn btn-action" style="width: 100%; padding: 12px;" onclick="app.saveCustomTheme()">üíæ Salvar Configura√ß√£o Atual como Tema</button>
                </div>
                <div class="setting-group">
                    <button class="btn" style="width: 100%; padding: 12px;" onclick="app.exportConfig()">üì• Exportar Configura√ß√£o (JSON)</button>
                </div>
                <div class="setting-group">
                    <label class="setting-label">Importar Configura√ß√£o</label>
                    <input type="file" class="setting-input" id="importConfig" accept=".json" onchange="app.importConfig(event)">
                </div>
                <div class="setting-group">
                    <button class="btn" style="width: 100%; padding: 12px; background: #d63031;" onclick="app.resetToDefault()">üîÑ Restaurar Padr√£o</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
/**
 * M√ìDULO 1: Parser de Legendas (LrcParser)
 */
class LrcParser {
    static parse(lrcString) {
        if (!lrcString) return { synced: null, plain: "" };
        const cleanString = lrcString.replace(/\[[a-zA-Z]+:.+\]/g, "").trim();
        const lines = cleanString.split('\n');
        const synced = [];
        const unsynced = [];
        const timeRegex = /\[(\d{2}):(\d{2}(?:\.\d{2,3})?)\]/;

        lines.forEach(line => {
            const match = line.match(timeRegex);
            if (match) {
                const rawTime = match[0];
                const text = line.replace(rawTime, "").trim();
                const startTime = parseInt(match[1]) * 60 + parseFloat(match[2]);
                synced.push({ text, startTime });
            } else {
                const text = line.trim();
                if (text) unsynced.push(text);
            }
        });

        return {
            synced: synced.length > 0 ? synced : null,
            plain: unsynced.length > 0 ? unsynced.join('\n') : cleanString
        };
    }
}

/**
 * M√ìDULO 2: Cliente API (LrcClient)
 */
class LrcClient {
    constructor() {
        this.baseUrl = "https://lrclib.net/api";
    }

    async findBestMatch(meta) {
        try {
            const exact = await this.doRequest('/get', meta);
            if (exact && exact.syncedLyrics && !exact.instrumental) return exact;
        } catch (e) { }

        const searchMeta = { ...meta, album: null };
        try {
            const results = await this.doRequest('/search', searchMeta);
            if (!results || results.length === 0) throw new Error("Nada encontrado");
            const sorted = results.sort((a, b) => {
                if (a.instrumental && !b.instrumental) return 1;
                if (!a.instrumental && b.instrumental) return -1;
                const aHasSync = !!a.syncedLyrics;
                const bHasSync = !!b.syncedLyrics;
                if (aHasSync && !bHasSync) return -1;
                if (!aHasSync && bHasSync) return 1;
                return Math.abs(a.duration - meta.duration) - Math.abs(b.duration - meta.duration);
            });
            return sorted[0]; 
        } catch (error) {
            throw error;
        }
    }

    async searchRaw(query) {
        return await this.doRequest('/search', { 
            track_name: query.track, 
            artist_name: query.artist 
        });
    }

    async doRequest(endpoint, params) {
        const url = new URL(this.baseUrl + endpoint);
        if (params.track || params.track_name) url.searchParams.append("track_name", params.track || params.track_name);
        if (params.artist || params.artist_name) url.searchParams.append("artist_name", params.artist || params.artist_name);
        if (params.album || params.album_name) url.searchParams.append("album_name", params.album || params.album_name);
        if (params.duration && params.duration > 0) url.searchParams.append("duration", params.duration);

        const response = await fetch(url);
        if (!response.ok) throw new Error(`Erro API: ${response.status}`);
        return await response.json();
    }
}

/**
 * M√ìDULO 3: Conversor de √Åudio (AudioConverter)
 */
class AudioConverter {
    static async convertToMp3(file, onProgress) {
        if (typeof lamejs === 'undefined') throw new Error("Biblioteca 'lamejs' n√£o carregada.");
        const arrayBuffer = await file.arrayBuffer();
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        const audioBuffer = await audioCtx.decodeAudioData(arrayBuffer);
        const channels = audioBuffer.numberOfChannels;
        const sampleRate = audioBuffer.sampleRate;
        const mp3encoder = new lamejs.Mp3Encoder(channels, sampleRate, 128);
        const mp3Data = [];
        const left = audioBuffer.getChannelData(0);
        const right = channels > 1 ? audioBuffer.getChannelData(1) : null;
        const sampleBlockSize = 1152;
        
        for (let i = 0; i < left.length; i += sampleBlockSize) {
            const leftChunk = left.subarray(i, i + sampleBlockSize);
            const leftInt16 = this.floatToInt16(leftChunk);
            let mp3buf;
            if (channels === 1) {
                mp3buf = mp3encoder.encodeBuffer(leftInt16);
            } else {
                const rightChunk = right.subarray(i, i + sampleBlockSize);
                const rightInt16 = this.floatToInt16(rightChunk);
                mp3buf = mp3encoder.encodeBuffer(leftInt16, rightInt16);
            }
            if (mp3buf.length > 0) mp3Data.push(mp3buf);
            if (onProgress && i % (sampleBlockSize * 50) === 0) {
                const percent = Math.round((i / left.length) * 100);
                onProgress(percent);
                await new Promise(r => setTimeout(r, 0));
            }
        }
        const endBuf = mp3encoder.flush();
        if (endBuf.length > 0) mp3Data.push(endBuf);
        return new Blob(mp3Data, { type: 'audio/mpeg' });
    }

    static floatToInt16(float32Array) {
        const int16Array = new Int16Array(float32Array.length);
        for (let i = 0; i < float32Array.length; i++) {
            let s = Math.max(-1, Math.min(1, float32Array[i]));
            int16Array[i] = s < 0 ? s * 0x8000 : s * 0x7FFF;
        }
        return int16Array;
    }
}

/**
 * M√ìDULO 4: Gravador de Tags (AudioTagger)
 */
class AudioTagger {
    static async embedMp3(originalFileBlob, meta, lyricsData) {
        if (typeof ID3Writer === 'undefined' && typeof window.ID3Writer === 'undefined') {
            throw new Error("Biblioteca ID3Writer n√£o carregada.");
        }
        const WriterClass = window.ID3Writer || ID3Writer;
        const arrayBuffer = await originalFileBlob.arrayBuffer();
        const writer = new WriterClass(arrayBuffer);

        if (meta.track) writer.setFrame('TIT2', meta.track);
        if (meta.artist) writer.setFrame('TPE1', [meta.artist]); 
        if (meta.album) writer.setFrame('TALB', meta.album);

        if (lyricsData.synced && lyricsData.synced.length > 0) {
            const syltData = lyricsData.synced.map(line => [line.text, Math.round(line.startTime * 1000)]);
            writer.setFrame('SYLT', { type: 1, text: syltData, timestampFormat: 2, language: 'por', description: 'Sync Lyrics' });
        }
        if (lyricsData.plain) {
            writer.setFrame('USLT', { description: '', lyrics: lyricsData.plain, language: 'por' });
        }
        writer.addTag();
        return writer.getBlob();
    }
}
</script>

<script>
const CONFIG_KEY = 'churchPlayerConfig_Ultimate';

const DEFAULT_CONFIG = {
    theme: 'classic-dark',
    fontSize: 1.4, fontSizeActive: 1.8,
    colorInactive: '#555555', colorActive: '#ffeaa7',
    fontWeightActive: 800, lineSpacing: 1.2, textAlign: 'center',
    bgType: 'solid', bgColor: '#0a0a0f', bgGradient1: '#0a0a0f', bgGradient2: '#1a1a24',
    bgImageUrl: '', bgOpacity: 0.3, bgBlur: 0,
    churchName: 'ADBUS Piracicaba', churchPosition: 'top', churchNameSize: 1.5,
    churchNameColor: '#ffffff', churchNameOpacity: 0.8,
    presentationMode: false
};

const PRESET_THEMES = {
    'classic-dark': { name: 'Cl√°ssico Escuro', config: { bgType: 'solid', bgColor: '#0a0a0f', colorInactive: '#555555', colorActive: '#ffeaa7', fontSize: 1.4, fontSizeActive: 1.8 }},
    'divine-light': { name: 'Luz Divina', config: { bgType: 'solid', bgColor: '#f9fafb', colorInactive: '#666666', colorActive: '#4f46e5', fontSize: 1.4, fontSizeActive: 1.8 }},
    'elegant-blue': { name: 'Elegante Azul', config: { bgType: 'gradient', bgGradient1: '#1e3a8a', bgGradient2: '#3b82f6', colorInactive: '#93c5fd', colorActive: '#ffffff', fontSize: 1.4, fontSizeActive: 1.8 }},
    'worship-modern': { name: 'Worship Moderno', config: { bgType: 'solid', bgColor: '#1a1a24', colorInactive: '#888888', colorActive: '#fbbf24', fontSize: 1.5, fontSizeActive: 2.0, bgOpacity: 0.6 }},
    'minimalist': { name: 'Minimalista', config: { bgType: 'solid', bgColor: '#000000', colorInactive: '#666666', colorActive: '#ffffff', fontSize: 1.3, fontSizeActive: 1.7 }}
};

const app = {
    client: new LrcClient(),
    config: { ...DEFAULT_CONFIG },
    state: {
        meta: { track: "", artist: "", album: "", duration: 0 },
        lyrics: null, currentMode: 'synced',
        fileName: "", fileType: "", originalFile: null,
        presentationMode: false, cursorTimeout: null, projectorWindow: null
    },
    ui: {
        audio: document.getElementById('audioPlayer'),
        container: document.getElementById('lyricsContainer'),
        loading: document.getElementById('loading'),
        loadingText: document.getElementById('loadingText'),
        progressBar: document.getElementById('progressBar'),
        progressFill: document.getElementById('progressFill'),
        churchName: document.getElementById('churchName')
    },

    init() {
        this.loadConfig();
        this.applyConfig();
        this.initEventListeners();
        this.renderThemes();
        this.setupKeyboardShortcuts();
        this.setupDragAndDrop(); // NOVO: Drag & Drop H√≠brido
        
        window.addEventListener('beforeunload', () => {
            if (this.state.projectorWindow) this.state.projectorWindow.close();
        });
    },

    initEventListeners() {
        document.getElementById('fileInput').addEventListener('change', e => this.loadFile(e.target.files[0]));
        this.ui.audio.addEventListener('timeupdate', () => this.syncLoop());
        this.ui.audio.onloadedmetadata = () => { this.state.meta.duration = this.ui.audio.duration; };

        // Helper para Inputs
        const bindInput = (id, prop, isFloat = false) => {
            const el = document.getElementById(id); if(!el) return;
            el.addEventListener('input', e => {
                this.config[prop] = isFloat ? parseFloat(e.target.value) : e.target.value;
                const v = document.getElementById(id+'Value');
                if(v) v.textContent = isFloat ? e.target.value + (id.includes('Size')?'x':'') : e.target.value;
                if(id.includes('Opacity')) v.textContent = Math.round(e.target.value * 100) + '%';
                if(id.includes('Size') && !id.startsWith('font')) v.textContent = e.target.value + 'em';
                this.applyConfig();
            });
        };

        bindInput('fontSize', 'fontSize', true); bindInput('fontSizeActive', 'fontSizeActive', true);
        bindInput('lineSpacing', 'lineSpacing', true); bindInput('bgOpacity', 'bgOpacity', true);
        bindInput('bgBlur', 'bgBlur', false); bindInput('churchNameSize', 'churchNameSize', true);
        bindInput('churchNameOpacity', 'churchNameOpacity', true);

        // Helper para Cores
        const bindColor = (id) => {
            const pk = document.getElementById(id), tx = document.getElementById(id+'Text');
            if(!pk || !tx) return;
            pk.addEventListener('input', e => { this.config[id] = e.target.value; tx.value = e.target.value; this.applyConfig(); });
            tx.addEventListener('input', e => { this.config[id] = e.target.value; pk.value = e.target.value; this.applyConfig(); });
        };

        bindColor('colorInactive'); bindColor('colorActive'); bindColor('bgColor');
        bindColor('bgGradient1'); bindColor('bgGradient2'); bindColor('churchNameColor');

        document.querySelectorAll('input[name="fontWeight"]').forEach(r => r.addEventListener('change', e => { this.config.fontWeightActive = parseInt(e.target.value); this.applyConfig(); }));
        document.querySelectorAll('input[name="textAlign"]').forEach(r => r.addEventListener('change', e => { this.config.textAlign = e.target.value; this.applyConfig(); }));
        document.querySelectorAll('input[name="bgType"]').forEach(r => r.addEventListener('change', e => { this.config.bgType = e.target.value; this.updateBackgroundInputs(); this.applyConfig(); }));
        document.querySelectorAll('input[name="churchPosition"]').forEach(r => r.addEventListener('change', e => { this.config.churchPosition = e.target.value; this.applyConfig(); }));
        
        document.getElementById('bgImageUrl').addEventListener('input', e => { this.config.bgImageUrl = e.target.value; this.applyConfig(); });
        document.getElementById('churchNameInp').addEventListener('input', e => { this.config.churchName = e.target.value; this.applyConfig(); });
        document.addEventListener('mousemove', () => this.handleMouseMove());
    },

    setupDragAndDrop() {
        document.body.addEventListener('dragover', e => { e.preventDefault(); e.dataTransfer.dropEffect = 'copy'; });
        document.body.addEventListener('drop', async e => {
            e.preventDefault();
            const files = Array.from(e.dataTransfer.files);
            const audio = files.find(f => f.type.startsWith('audio/') || f.name.match(/\.(mp3|flac|wav|ogg)$/i));
            const lrc = files.find(f => f.name.toLowerCase().endsWith('.lrc'));

            if (audio) this.loadFile(audio, lrc); // Carrega √°udio e letra (se houver)
            else if (lrc && this.state.originalFile) {
                // Se s√≥ soltar o LRC com m√∫sica tocando, carrega a letra
                const text = await lrc.text();
                this.loadLyrics({ syncedLyrics: text });
            }
        });
    },

    setupKeyboardShortcuts() {
        document.addEventListener('keydown', e => {
            if (e.key === 'F11' || (e.key.toLowerCase() === 'p' && !e.target.matches('input, textarea'))) { e.preventDefault(); this.togglePresentationMode(); }
            else if (e.key === ' ' && !e.target.matches('input, textarea')) { e.preventDefault(); this.ui.audio.paused ? this.ui.audio.play() : this.ui.audio.pause(); }
            else if (e.key === 'ArrowLeft' && !e.target.matches('input, textarea')) this.ui.audio.currentTime = Math.max(0, this.ui.audio.currentTime - 5);
            else if (e.key === 'ArrowRight' && !e.target.matches('input, textarea')) this.ui.audio.currentTime = Math.min(this.ui.audio.duration, this.ui.audio.currentTime + 5);
        });
    },

    handleMouseMove() {
        if (this.state.projectorWindow && !this.state.projectorWindow.closed) {
            this.state.projectorWindow.document.body.style.cursor = 'default';
            clearTimeout(this.state.cursorTimeout);
            this.state.cursorTimeout = setTimeout(() => {
                if (this.state.projectorWindow && !this.state.projectorWindow.closed) this.state.projectorWindow.document.body.style.cursor = 'none';
            }, 3000);
        }
    },

    togglePresentationMode() {
        if (this.state.projectorWindow && !this.state.projectorWindow.closed) {
            this.state.projectorWindow.focus();
            return;
        }

        this.state.projectorWindow = window.open('', 'ChurchPlayerProjector', 'width=1280,height=720');
        
        if (!this.state.projectorWindow) {
            alert("Bloqueador de pop-ups ativo! Permita pop-ups para usar o projetor.");
            return;
        }

        // Clona os estilos para a nova janela
        const styles = Array.from(document.styleSheets).map(sheet => {
            try { return Array.from(sheet.cssRules).map(rule => rule.cssText).join(''); } catch(e) { return ''; }
        }).join('');

        this.state.projectorWindow.document.write(`
            <!DOCTYPE html>
            <html>
            <head>
                <title>PROJETOR - ${this.config.churchName || 'Church Player'}</title>
                <style>
                    ${styles}
                    body { overflow: hidden; margin: 0; padding: 0; height: 100vh; cursor: none; }
                    .controls, header, footer, .modal { display: none !important; }
                    main { 
                        height: 100vh; width: 100vw; overflow-y: auto; display: block; 
                        scroll-behavior: smooth; -ms-overflow-style: none; scrollbar-width: none; 
                    }
                    main::-webkit-scrollbar { display: none; }
                    .lyrics-box { padding: 50vh 20px; margin: 0 auto; width: 100%; box-sizing: border-box; }
                </style>
            </head>
            <body>
                <div class="church-name" id="p-churchName"></div>
                <main id="p-main"><div class="lyrics-box" id="p-lyricsContainer"></div></main>
            </body>
            </html>
        `);

        this.state.projectorWindow.document.close();
        this.applyConfig();
        if (this.state.lyrics) {
            this.state.currentMode === 'synced' ? this.renderSynced() : this.renderPlain();
        }
    },

    loadConfig() {
        try { const saved = localStorage.getItem(CONFIG_KEY); if (saved) this.config = { ...DEFAULT_CONFIG, ...JSON.parse(saved) }; } catch (e) { console.error(e); }
    },

    saveConfig() {
        try { localStorage.setItem(CONFIG_KEY, JSON.stringify(this.config)); } catch (e) { console.error(e); }
    },

    applyConfig() {
        const root = document.documentElement;
        root.style.setProperty('--font-size-base', this.config.fontSize + 'em');
        root.style.setProperty('--font-size-active', this.config.fontSizeActive + 'em');
        root.style.setProperty('--color-inactive', this.config.colorInactive);
        root.style.setProperty('--color-active', this.config.colorActive);
        root.style.setProperty('--font-weight-active', this.config.fontWeightActive);
        root.style.setProperty('--line-spacing', this.config.lineSpacing);
        root.style.setProperty('--text-align', this.config.textAlign);
        root.style.setProperty('--bg-opacity', this.config.bgOpacity);
        root.style.setProperty('--bg-blur', this.config.bgBlur + 'px');

        document.body.setAttribute('data-bg-type', this.config.bgType);
        const bgVal = this.config.bgType === 'solid' ? this.config.bgColor : 
                      this.config.bgType === 'gradient' ? this.config.bgGradient1 : 
                      `url(${this.config.bgImageUrl})`;
        root.style.setProperty('--bg-value', bgVal);
        if (this.config.bgType === 'gradient') root.style.setProperty('--bg-value-2', this.config.bgGradient2);

        this.ui.churchName.textContent = this.config.churchName;
        this.ui.churchName.className = 'church-name ' + this.config.churchPosition;
        this.ui.churchName.style.fontSize = this.config.churchNameSize + 'em';
        this.ui.churchName.style.color = this.config.churchNameColor;
        this.ui.churchName.style.opacity = this.config.churchNameOpacity;

        // Sincroniza Janela Projetor
        if (this.state.projectorWindow && !this.state.projectorWindow.closed) {
            const pDoc = this.state.projectorWindow.document;
            pDoc.documentElement.style.cssText = root.style.cssText;
            pDoc.body.setAttribute('data-bg-type', this.config.bgType);
            const pChurch = pDoc.getElementById('p-churchName');
            if (pChurch) {
                pChurch.textContent = this.config.churchName;
                pChurch.className = 'church-name ' + this.config.churchPosition;
                pChurch.style.fontSize = this.config.churchNameSize + 'em';
                pChurch.style.color = this.config.churchNameColor;
                pChurch.style.opacity = this.config.churchNameOpacity;
            }
        }
        this.syncUIWithConfig();
        this.saveConfig();
    },

    syncUIWithConfig() {
        const setVal = (id, val) => { const el = document.getElementById(id); if(el) el.value = val; };
        const setTxt = (id, txt) => { const el = document.getElementById(id); if(el) el.textContent = txt; };

        setVal('fontSize', this.config.fontSize); setTxt('fontSizeValue', this.config.fontSize + 'x');
        setVal('fontSizeActive', this.config.fontSizeActive); setTxt('fontSizeActiveValue', this.config.fontSizeActive + 'x');
        setVal('colorInactive', this.config.colorInactive); setVal('colorInactiveText', this.config.colorInactive);
        setVal('colorActive', this.config.colorActive); setVal('colorActiveText', this.config.colorActive);
        
        const fw = document.querySelector(`input[name="fontWeight"][value="${this.config.fontWeightActive}"]`); if(fw) fw.checked = true;
        setVal('lineSpacing', this.config.lineSpacing); setTxt('lineSpacingValue', this.config.lineSpacing);
        const ta = document.querySelector(`input[name="textAlign"][value="${this.config.textAlign}"]`); if(ta) ta.checked = true;
        const bt = document.querySelector(`input[name="bgType"][value="${this.config.bgType}"]`); if(bt) bt.checked = true;
        
        this.updateBackgroundInputs();
        setVal('bgColor', this.config.bgColor); setVal('bgColorText', this.config.bgColor);
        setVal('bgGradient1', this.config.bgGradient1); setVal('bgGradient1Text', this.config.bgGradient1);
        setVal('bgGradient2', this.config.bgGradient2); setVal('bgGradient2Text', this.config.bgGradient2);
        setVal('bgImageUrl', this.config.bgImageUrl);
        setVal('bgOpacity', this.config.bgOpacity); setTxt('bgOpacityValue', Math.round(this.config.bgOpacity*100) + '%');
        setVal('bgBlur', this.config.bgBlur); setTxt('bgBlurValue', this.config.bgBlur + 'px');
        setVal('churchName', this.config.churchName);
        const cp = document.querySelector(`input[name="churchPosition"][value="${this.config.churchPosition}"]`); if(cp) cp.checked = true;
        setVal('churchNameSize', this.config.churchNameSize); setTxt('churchNameSizeValue', this.config.churchNameSize + 'em');
        setVal('churchNameColor', this.config.churchNameColor); setVal('churchNameColorText', this.config.churchNameColor);
        setVal('churchNameOpacity', this.config.churchNameOpacity); setTxt('churchNameOpacityValue', Math.round(this.config.churchNameOpacity*100) + '%');
    },

    updateBackgroundInputs() {
        document.getElementById('bgSolidGroup').style.display = this.config.bgType === 'solid' ? 'block' : 'none';
        document.getElementById('bgGradientGroup').style.display = this.config.bgType === 'gradient' ? 'block' : 'none';
        document.getElementById('bgImageGroup').style.display = this.config.bgType === 'image' ? 'block' : 'none';
    },

    renderThemes() {
        const grid = document.getElementById('themesGrid'); grid.innerHTML = '';
        Object.entries(PRESET_THEMES).forEach(([key, theme]) => {
            const card = document.createElement('div'); card.className = 'theme-card';
            if (this.config.theme === key) card.classList.add('active');
            const preview = document.createElement('div'); preview.className = 'theme-preview';
            preview.style.background = theme.config.bgType === 'gradient' 
                ? `linear-gradient(135deg, ${theme.config.bgGradient1 || theme.config.bgColor}, ${theme.config.bgGradient2 || theme.config.bgColor})`
                : theme.config.bgColor;
            card.innerHTML = `<div class="theme-preview" style="background:${preview.style.background}"></div><div class="theme-name">${theme.name}</div>`;
            card.onclick = () => this.applyTheme(key);
            grid.appendChild(card);
        });
    },

    applyTheme(themeKey) {
        const theme = PRESET_THEMES[themeKey];
        if (!theme) return;
        this.config = { ...this.config, ...theme.config, theme: themeKey };
        this.applyConfig();
        this.renderThemes();
    },

    saveCustomTheme() {
        const name = prompt('Nome do tema:'); if (!name) return;
        const key = 'custom-' + Date.now();
        PRESET_THEMES[key] = { name: name, config: { ...this.config } };
        this.renderThemes(); alert('Salvo!');
    },

    exportConfig() {
        const a = document.createElement('a');
        a.href = URL.createObjectURL(new Blob([JSON.stringify(this.config, null, 2)], { type: 'application/json' }));
        a.download = 'church-player-config.json'; a.click();
    },

    importConfig(event) {
        const file = event.target.files[0]; if (!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                this.config = { ...DEFAULT_CONFIG, ...JSON.parse(e.target.result) };
                this.applyConfig(); alert('Importado!');
            } catch (err) { alert('Erro.'); }
        };
        reader.readAsText(file);
    },

    resetToDefault() {
        if (!confirm('Restaurar padr√£o?')) return;
        this.config = { ...DEFAULT_CONFIG };
        this.applyConfig();
        this.renderThemes();
    },

    openSettings() { document.getElementById('settingsModal').classList.add('active'); },
    closeModal(modalId) { document.getElementById(modalId).classList.remove('active'); },

    switchTab(tabName) {
        document.querySelectorAll('.modal-tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
        event.target.classList.add('active');
        document.getElementById('tab-' + tabName).classList.add('active');
    },

    setLoading(msg, progress = -1) {
        if (msg) {
            this.ui.loadingText.innerText = msg;
            this.ui.loading.style.display = 'block';
            this.ui.progressBar.style.display = progress >= 0 ? 'block' : 'none';
            if (progress >= 0) this.ui.progressFill.style.width = progress + '%';
        } else { this.ui.loading.style.display = 'none'; }
    },

    // L√ìGICA PRINCIPAL DE CARREGAMENTO
    loadFile(file, companionLrc = null) {
        if (!file) return;
        this.reset();
        this.state.originalFile = file;
        this.state.fileName = file.name.replace(/\.[^/.]+$/, "");
        const name = file.name.toLowerCase();
        this.state.fileType = (name.endsWith('.mp3')) ? 'mp3' : (name.endsWith('.flac') ? 'flac' : 'other');
        this.ui.audio.src = URL.createObjectURL(file);
        
        this.setLoading("Lendo Tags...");
        jsmediatags.read(file, {
            onSuccess: async (tag) => {
                const t = tag.tags;
                this.state.meta = { track: t.title || this.state.fileName, artist: t.artist || "", album: t.album || "", duration: 0 };
                this.updateHeader();
                
                // 1. Arquivo LRC solto
                if (companionLrc) { 
                    this.loadLyrics({ syncedLyrics: await companionLrc.text() }); 
                    this.setLoading(null); return; 
                }
                
                // 2. Tag Embutida (USLT/Lyrics)
                if (t.lyrics) {
                    const txt = typeof t.lyrics === 'string' ? t.lyrics : t.lyrics.lyrics;
                    if (txt) { this.loadLyrics({ syncedLyrics: txt }); this.setLoading(null); return; }
                }
                
                // 3. API
                t.title ? this.autoFetch() : this.promptManualSearch();
            },
            onError: () => this.promptManualSearch()
        });
    },

    updateHeader() {
        document.getElementById('lblTitle').innerText = this.state.meta.track;
        document.getElementById('lblArtist').innerText = this.state.meta.artist;
    },

    promptManualSearch() {
        this.setLoading(null);
        this.state.meta.track = this.state.fileName.replace(/^\d+\s*[-_]?\s*/, '').replace(/[-_]/g, ' ').trim();
        this.state.meta.artist = "";
        this.updateHeader();
        this.openSearch();
    },

    async autoFetch() {
        this.setLoading("Buscando Letra...");
        try {
            const result = await this.client.findBestMatch(this.state.meta);
            this.loadLyrics(result);
            this.setLoading(null);
        } catch (e) {
            this.setLoading(null);
            this.promptManualSearch();
        }
    },

    loadLyrics(data) {
        const parsedSynced = LrcParser.parse(data.syncedLyrics);
        const plainText = data.plainLyrics || parsedSynced.plain;
        this.state.lyrics = { synced: parsedSynced.synced, plain: plainText };

        if (this.state.lyrics.synced) {
            this.state.currentMode = 'synced';
            this.renderSynced();
        } else {
            this.state.currentMode = 'plain';
            this.renderPlain();
        }

        document.getElementById('dropdownSave').style.display = 'inline-block';
        const btnEmbed = document.getElementById('btnEmbed');
        if (this.state.fileType === 'mp3') {
            btnEmbed.innerText = "üéµ Embutir no MP3 (R√°pido)"; btnEmbed.disabled = false;
        } else if (this.state.fileType === 'flac') {
            btnEmbed.innerText = "üéµ Converter p/ MP3 + Embed"; btnEmbed.disabled = false;
        } else {
            btnEmbed.innerText = "üéµ Embutir Indispon√≠vel"; btnEmbed.disabled = true;
        }
        document.getElementById('btnToggleType').style.display = (this.state.lyrics.synced && this.state.lyrics.plain) ? 'inline-block' : 'none';
    },

    renderSynced() {
        const renderTo = (container, doc) => {
            if (!container) return;
            container.innerHTML = '';
            this.state.lyrics.synced.forEach(line => {
                const div = doc.createElement('div');
                div.className = 'l-line';
                div.innerText = line.text;
                div.onclick = () => { this.ui.audio.currentTime = line.startTime; this.ui.audio.play(); };
                container.appendChild(div);
            });
        };
        renderTo(this.ui.container, document);
        if (this.state.projectorWindow && !this.state.projectorWindow.closed) {
            const pDoc = this.state.projectorWindow.document;
            renderTo(pDoc.getElementById('p-lyricsContainer'), pDoc);
        }
    },

    renderPlain() {
        const html = `<div class="plain-text">${this.state.lyrics.plain || "Sem texto."}</div>`;
        this.ui.container.innerHTML = html;
        if (this.state.projectorWindow && !this.state.projectorWindow.closed) {
            const pBox = this.state.projectorWindow.document.getElementById('p-lyricsContainer');
            if (pBox) pBox.innerHTML = html;
        }
    },

    toggleView() {
        this.state.currentMode = this.state.currentMode === 'synced' ? 'plain' : 'synced';
        this.state.currentMode === 'synced' ? this.renderSynced() : this.renderPlain();
    },

    syncLoop() {
        if (this.state.currentMode !== 'synced' || !this.state.lyrics.synced) return;
        const time = this.ui.audio.currentTime;
        const lines = this.state.lyrics.synced;
        let activeIdx = -1;
        for (let i = 0; i < lines.length; i++) {
            if (lines[i].startTime <= time) activeIdx = i; else break;
        }

        const syncUI = (container) => {
            if (!container || activeIdx === -1) return;
            const currentEl = container.querySelector('.l-line.active');
            const nextEl = container.children[activeIdx];
            if (currentEl !== nextEl) {
                if (currentEl) currentEl.classList.remove('active');
                if (nextEl) {
                    nextEl.classList.add('active');
                    nextEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            }
        };

        syncUI(this.ui.container);
        if (this.state.projectorWindow && !this.state.projectorWindow.closed) {
            syncUI(this.state.projectorWindow.document.getElementById('p-lyricsContainer'));
        }
    },

    openSearch() {
        document.getElementById('searchModal').classList.add('active');
        document.getElementById('inpTrack').value = this.state.meta.track;
        document.getElementById('inpArtist').value = this.state.meta.artist;
    },

    async doManualSearch() {
        const list = document.getElementById('resultsList');
        list.innerHTML = '<div style="padding:20px; text-align:center">Buscando...</div>';
        try {
            const results = await this.client.searchRaw({ track: document.getElementById('inpTrack').value, artist: document.getElementById('inpArtist').value });
            list.innerHTML = '';
            results.forEach(item => {
                const div = document.createElement('div');
                div.className = 'res-item';
                div.innerHTML = `<b>${item.trackName}</b><span>${item.artistName}</span>`;
                div.onclick = () => { this.loadLyrics(item); this.closeModal('searchModal'); };
                list.appendChild(div);
            });
        } catch (e) { list.innerHTML = '<div style="padding:20px; text-align:center">Nada encontrado.</div>'; }
    },

    applyPastedLyrics() {
        const text = document.getElementById('pastedLyricsText').value.trim();
        if (!text) return alert("Cole a letra primeiro.");
        this.loadLyrics({ syncedLyrics: text });
        this.closeModal('searchModal');
    },

    async downloadLrc() {
        if (!this.state.lyrics) return;
        const content = this.state.lyrics.synced
            ? this.state.lyrics.synced.map(l => `[${Math.floor(l.startTime/60).toString().padStart(2,'0')}:${(l.startTime%60).toFixed(2).padStart(5,'0')}] ${l.text}`).join('\n')
            : this.state.lyrics.plain;
        this.saveFile(content, this.state.fileName + ".lrc", 'text/plain');
    },

    async embedInFile() {
        if (this.state.fileType !== 'mp3' && this.state.fileType !== 'flac') return alert("Formato n√£o suportado.");
        let targetBlob = this.state.originalFile;
        try {
            if (this.state.fileType === 'flac') {
                targetBlob = await AudioConverter.convertToMp3(this.state.originalFile, (pct) => this.setLoading(`Convertendo: ${pct}%`, pct));
            }
            const taggedBlob = await AudioTagger.embedMp3(targetBlob, this.state.meta, this.state.lyrics);
            this.setLoading(null);
            this.saveFile(taggedBlob, this.state.fileName + "_tagged.mp3", 'audio/mpeg');
        } catch (e) { this.setLoading(null); alert("Erro ao processar: " + e.message); }
    },

    async saveFile(content, filename, mimeType) {
        const blob = content instanceof Blob ? content : new Blob([content], { type: mimeType });
        const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = filename; a.click();
    },

    reset() {
        this.state.lyrics = null;
        this.state.meta = { track: "", artist: "", album: "", duration: 0 };
        this.ui.container.innerHTML = '';
        if (this.state.projectorWindow && !this.state.projectorWindow.closed) {
            this.state.projectorWindow.document.getElementById('p-lyricsContainer').innerHTML = '';
        }
        document.getElementById('dropdownSave').style.display = 'none';
        this.setLoading(null);
    }
};

app.init();
</script>
</body>
</html>